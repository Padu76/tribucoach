<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Tua Dashboard Lifestyle - Andrea Padoan Coach</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #fff7ed 50%, #f0fdf4 100%);
            min-height: 100vh;
            color: #1e293b;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .user-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .user-level {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Welcome Section */
        .welcome-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            text-align: center;
        }

        .welcome-title {
            font-size: 2rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 1rem;
        }

        .welcome-text {
            font-size: 1.1rem;
            color: #64748b;
            margin-bottom: 2rem;
        }

        .coach-card {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            max-width: 500px;
            margin: 0 auto;
        }

        .coach-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .coach-info h3 {
            margin: 0;
            color: #1e293b;
            font-size: 1.2rem;
        }

        .coach-info p {
            margin: 0;
            color: #ea580c;
            font-size: 0.9rem;
        }

        /* Clear Instructions */
        .instructions-section {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .instructions-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .instructions-text {
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .instructions-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .step-card {
            background: rgba(255,255,255,0.1);
            padding: 1.5rem;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .step-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .step-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .step-description {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Progress Section */
        .progress-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .progress-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
        }

        .progress-badge {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .week-progress {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .week-item {
            background: #f8fafc;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .week-item.current {
            background: linear-gradient(135deg, #ea580c 0%, #fb923c 100%);
            color: white;
            transform: scale(1.05);
        }

        .week-item.completed {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: white;
        }

        .week-number {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .week-title {
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Current Week Focus */
        .current-week-focus {
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            color: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .current-week-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .current-week-description {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .current-week-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* Profile Analysis Section */
        .profile-analysis {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .analysis-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .analysis-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .analysis-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .analysis-subtitle {
            font-size: 1rem;
            color: #64748b;
        }

        .analysis-content {
            line-height: 1.8;
            font-size: 1.1rem;
            color: #334155;
            margin-bottom: 2rem;
        }

        .analysis-content p {
            margin-bottom: 1.5rem;
        }

        .analysis-content .highlight {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #ea580c;
            margin: 1.5rem 0;
        }

        .analysis-content .warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #f59e0b;
            margin: 1.5rem 0;
        }

        .analysis-content .success {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #16a34a;
            margin: 1.5rem 0;
        }

        .analysis-cta {
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            margin-top: 2rem;
        }

        .analysis-cta h3 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
        }

        .analysis-cta p {
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            opacity: 0.9;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 1rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .stat-bar {
            width: 100%;
            height: 8px;
            background: rgba(30,41,59,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .stat-fill {
            height: 100%;
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            transition: width 0.3s ease;
        }

        .stat-improvement {
            font-size: 0.9rem;
            color: #ea580c;
            margin-top: 0.5rem;
            font-weight: 600;
        }

        /* Improvement CTA Section */
        .improvement-cta {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: white;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .improvement-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .improvement-text {
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        /* Chat Section */
        .chat-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .chat-status {
            background: #dcfce7;
            color: #16a34a;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }

        .message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 12px;
            max-width: 80%;
            animation: fadeIn 0.3s ease-in;
        }

        .message.user {
            background: #f1f5f9;
            margin-left: auto;
            text-align: right;
        }

        .message.coach {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            margin-right: auto;
        }

        .message-time {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 0.5rem;
        }

        .chat-input {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .chat-input input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .chat-input input:focus {
            outline: none;
            border-color: #ea580c;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .btn-secondary {
            background: white;
            color: #1e293b;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            border-color: #ea580c;
            color: #ea580c;
        }

        .btn-success {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            color: white;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }
            
            .week-progress {
                grid-template-columns: 1fr;
            }
            
            .current-week-actions {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">🎯 LifestyleFitnessCoach</div>
            <div class="user-info">
                <div class="user-avatar">👤</div>
                <div>
                    <div class="user-name" id="userName">Il tuo nome</div>
                    <div class="user-level">Lifestyle Explorer</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Welcome Section -->
        <section class="welcome-section fade-in">
            <h1 class="welcome-title">Benvenuto nel Tuo Percorso di Trasformazione! 🚀</h1>
            <p class="welcome-text">
                Hai completato il test iniziale e ora sei pronto per iniziare il tuo viaggio verso una vita più sana e equilibrata.
            </p>
            <div class="coach-card">
                <div class="coach-avatar">👨‍💼</div>
                <div class="coach-info">
                    <h3>Andrea Padoan</h3>
                    <p>Il tuo Lifestyle Coach digitale</p>
                </div>
            </div>
        </section>

        <!-- Clear Instructions -->
        <section class="instructions-section fade-in">
            <h2 class="instructions-title">🎯 Come Funziona il Tuo Percorso</h2>
            <p class="instructions-text">
                Il tuo percorso di trasformazione dura 7 settimane. Ogni settimana riceverai materiali personalizzati 
                e potrai chattare con me per supporto continuo. Tutto è automatico e personalizzato per te!
            </p>
            <div class="instructions-steps">
                <div class="step-card">
                    <div class="step-number">1</div>
                    <div class="step-title">Ricevi Materiali</div>
                    <div class="step-description">Ogni settimana ricevi guide, test e esercizi personalizzati</div>
                </div>
                <div class="step-card">
                    <div class="step-number">2</div>
                    <div class="step-title">Chatta con Andrea</div>
                    <div class="step-description">Scrivi quando hai domande o bisogno di supporto</div>
                </div>
                <div class="step-card">
                    <div class="step-number">3</div>
                    <div class="step-title">Completa Attività</div>
                    <div class="step-description">Segui i compiti settimanali per avanzare nel percorso</div>
                </div>
            </div>
        </section>

        <!-- Progress Section -->
        <section class="progress-section fade-in">
            <div class="progress-header">
                <h2 class="progress-title">Il Tuo Progresso - 7 Settimane</h2>
                <div class="progress-badge" id="progressBadge">Settimana 1</div>
            </div>
            
            <div class="week-progress" id="weekProgress">
                <div class="week-item current">
                    <div class="week-number">Settimana 1</div>
                    <div class="week-title">Benvenuto</div>
                </div>
                <div class="week-item">
                    <div class="week-number">Settimana 2</div>
                    <div class="week-title">Consapevolezza</div>
                </div>
                <div class="week-item">
                    <div class="week-number">Settimana 3</div>
                    <div class="week-title">Obiettivi</div>
                </div>
                <div class="week-item">
                    <div class="week-number">Settimana 4</div>
                    <div class="week-title">Azioni</div>
                </div>
                <div class="week-item">
                    <div class="week-number">Settimana 5</div>
                    <div class="week-title">Abitudini</div>
                </div>
                <div class="week-item">
                    <div class="week-number">Settimana 6</div>
                    <div class="week-title">Potenzialità</div>
                </div>
                <div class="week-item">
                    <div class="week-number">Settimana 7</div>
                    <div class="week-title">Mantenimento</div>
                </div>
            </div>
        </section>

        <!-- Current Week Focus -->
        <section class="current-week-focus fade-in" id="currentWeekFocus">
            <h3 class="current-week-title">📚 Settimana 1: Benvenuto nel tuo percorso!</h3>
            <p class="current-week-description">
                Questa settimana ci conosceremo meglio e analizzeremo la tua situazione attuale. 
                Ho preparato materiali specifici per il tuo profilo e sono qui per rispondere a qualsiasi domanda.
            </p>
            <div class="current-week-actions">
                <button class="btn btn-primary" onclick="openChat()">
                    💬 Inizia a Chattare con Andrea
                </button>
                <button class="btn btn-success" onclick="completeWeek()">
                    ✅ Completa Settimana 1
                </button>
            </div>
        </section>

        <!-- Profile Analysis Section -->
        <section class="profile-analysis fade-in">
            <div class="analysis-header">
                <div class="analysis-icon">📊</div>
                <div>
                    <h2 class="analysis-title">Analisi Dettagliata del Tuo Profilo</h2>
                    <p class="analysis-subtitle">La tua situazione attuale e come posso aiutarti</p>
                </div>
            </div>
            
            <div class="analysis-content" id="profileAnalysis">
                <p>Caricamento della tua analisi personalizzata...</p>
            </div>
        </section>

        <!-- Stats Grid with Improvement CTA -->
        <section class="stats-grid fade-in">
            <div class="stat-card">
                <div class="stat-value" id="wellbeingScore">4</div>
                <div class="stat-label">Benessere Emotivo</div>
                <div class="stat-bar">
                    <div class="stat-fill" id="wellbeingFill" style="width: 80%"></div>
                </div>
                <div class="stat-improvement">Puoi migliorare!</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="healthScore">3</div>
                <div class="stat-label">Salute Fisica</div>
                <div class="stat-bar">
                    <div class="stat-fill" id="healthFill" style="width: 60%"></div>
                </div>
                <div class="stat-improvement">Puoi migliorare!</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="socialScore">4</div>
                <div class="stat-label">Relazioni Sociali</div>
                <div class="stat-bar">
                    <div class="stat-fill" id="socialFill" style="width: 80%"></div>
                </div>
                <div class="stat-improvement">Puoi migliorare!</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="professionalScore">3</div>
                <div class="stat-label">Vita Professionale</div>
                <div class="stat-bar">
                    <div class="stat-fill" id="professionalFill" style="width: 60%"></div>
                </div>
                <div class="stat-improvement">Puoi migliorare!</div>
            </div>
        </section>

        <!-- Improvement CTA Section -->
        <section class="improvement-cta fade-in">
            <h2 class="improvement-title">🎯 Questi Sono i Tuoi Punteggi Attuali</h2>
            <p class="improvement-text">
                Hai appena visto i tuoi punteggi nelle 4 aree principali del benessere. 
                <strong>La buona notizia?</strong> Ogni punteggio può essere migliorato significativamente! 
                Il mio percorso di 7 settimane è progettato per far crescere tutti questi numeri e, 
                soprattutto, per farti sentire meglio ogni giorno.
            </p>
            <button class="btn btn-primary" onclick="startImprovementJourney()" style="font-size: 1.2rem; padding: 1rem 2rem;">
                🚀 Inizia Subito il Tuo Miglioramento
            </button>
        </section>

        <!-- Chat Section -->
        <section class="chat-section fade-in" id="chatSection" style="display: none;">
            <div class="chat-header">
                <div class="coach-avatar">👨‍💼</div>
                <div>
                    <h3>Chat con Andrea</h3>
                    <p>Il tuo coach digitale è qui per aiutarti</p>
                </div>
                <div class="chat-status">Online</div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="message coach">
                    <p>Ciao! Benvenuto nel tuo percorso di trasformazione! 🎉</p>
                    <div class="message-time">Proprio ora</div>
                </div>
                <div class="message coach">
                    <p>Ho analizzato il tuo profilo e ho preparato un percorso personalizzato per te. Sono qui per supportarti in ogni passo. Come ti senti all'idea di iniziare questo viaggio?</p>
                    <div class="message-time">Proprio ora</div>
                </div>
            </div>
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Scrivi un messaggio ad Andrea...">
                <button class="btn btn-primary" onclick="sendMessage()">Invia</button>
            </div>
        </section>
    </main>

    <!-- Firebase SDK + Claude AI System -->
    <script type="module">
        // Import Firebase functions
        import { db } from './firebase.js';
        import { collection, addDoc, doc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
        
        // Import Lifestyle Coaching System
        import { LifestyleCoachingSystem, generatePersonalizedContent } from './lifestyle-coaching-system.js';
        
        // Import Claude AI System
        import { AutomaticCoachingSystem, ClaudeConversationManager } from './claude-ai-coaching-system.js';
        
        // Make functions available globally
        window.firebaseDB = db;
        window.firebaseCollection = collection;
        window.firebaseAddDoc = addDoc;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseDoc = doc;
        window.firebaseServerTimestamp = serverTimestamp;
        window.LifestyleCoachingSystem = LifestyleCoachingSystem;
        window.generatePersonalizedContent = generatePersonalizedContent;
        window.AutomaticCoachingSystem = AutomaticCoachingSystem;
        window.ClaudeConversationManager = ClaudeConversationManager;
    </script>
    
    <script>
        // User data with automatic coaching system
        let userData = {
            name: "Utente",
            currentWeek: 1,
            completedWeeks: [],
            scores: {
                wellbeing: 4,
                health: 3,
                social: 4,
                professional: 3
            },
            chatHistory: [],
            automaticCoaching: null,
            quadrant: null,
            consciousnessLevel: null,
            readinessLevel: 3,
            challenges: [],
            motivationDrivers: []
        };

        // Initialize dashboard
        async function initDashboard() {
            console.log('🚀 Inizializzazione dashboard...');
            
            // Load user data
            await loadUserData();
            
            // Initialize coaching system
            await initializeAutomaticCoaching();
            
            // Update UI
            updateDashboard();
            
            // FORCE generate profile analysis
            generateProfileAnalysis();
            
            // Add welcome fade-in effect
            setTimeout(() => {
                document.querySelectorAll('.fade-in').forEach(el => {
                    el.style.opacity = '1';
                    el.style.transform = 'translateY(0)';
                });
            }, 100);
        }

        async function loadUserData() {
            try {
                console.log('📊 Caricamento dati utente...');
                const savedData = localStorage.getItem('lifestyleQuizResults');
                if (savedData) {
                    const profileData = JSON.parse(savedData);
                    console.log('✅ Dati trovati:', profileData);
                    
                    // Update userData with profile data
                    userData.name = profileData.name || 'Utente';
                    userData.scores = profileData.scores || userData.scores;
                    userData.quadrant = profileData.quadrant;
                    userData.consciousnessLevel = profileData.consciousnessLevel;
                    userData.readinessLevel = profileData.readinessLevel;
                    userData.challenges = profileData.challenges || [];
                    userData.motivationDrivers = profileData.motivationDrivers || [];
                    
                    console.log('✅ Dati utente caricati:', userData);
                } else {
                    console.log('⚠️ Nessun dato trovato, uso dati di default');
                }
            } catch (error) {
                console.error('❌ Errore caricamento dati:', error);
            }
        }

        async function initializeAutomaticCoaching() {
            try {
                if (typeof window.AutomaticCoachingSystem === 'function') {
                    userData.automaticCoaching = new window.AutomaticCoachingSystem();
                    
                    const userId = localStorage.getItem('lifestyleUserId') || 'user_' + Date.now();
                    localStorage.setItem('lifestyleUserId', userId);
                    
                    await userData.automaticCoaching.initializeUser(userId, {
                        quadrant: userData.quadrant,
                        consciousnessLevel: userData.consciousnessLevel,
                        motivationDrivers: userData.motivationDrivers || [],
                        challenges: userData.challenges || [],
                        readinessLevel: userData.readinessLevel || 3,
                        scores: userData.scores,
                        name: userData.name
                    });
                    
                    console.log('🤖 Sistema automatico Claude AI inizializzato');
                }
            } catch (error) {
                console.error('❌ Errore inizializzazione coaching:', error);
            }
        }

        function updateDashboard() {
            // Update user name
            document.getElementById('userName').textContent = userData.name;
            
            // Update scores
            updateScoresDisplay();
            
            // Update progress
            updateProgressDisplay();
            
            // Update current week focus
            updateCurrentWeekFocus();
        }

        function updateScoresDisplay() {
            const scores = userData.scores;
            
            Object.entries(scores).forEach(([key, value]) => {
                const scoreElement = document.getElementById(key + 'Score');
                const fillElement = document.getElementById(key + 'Fill');
                
                if (scoreElement) {
                    scoreElement.textContent = value;
                }
                
                if (fillElement) {
                    fillElement.style.width = (value / 5) * 100 + '%';
                }
            });
        }

        function updateProgressDisplay() {
            const progressBadge = document.getElementById('progressBadge');
            if (progressBadge) {
                progressBadge.textContent = `Settimana ${userData.currentWeek}`;
            }
            
            // Update week progress visual
            const weekItems = document.querySelectorAll('.week-item');
            weekItems.forEach((item, index) => {
                const weekNumber = index + 1;
                item.classList.remove('current', 'completed');
                
                if (weekNumber === userData.currentWeek) {
                    item.classList.add('current');
                } else if (userData.completedWeeks.includes(weekNumber)) {
                    item.classList.add('completed');
                }
            });
        }

        function updateCurrentWeekFocus() {
            const weekContent = getWeekContent(userData.currentWeek);
            const focusElement = document.getElementById('currentWeekFocus');
            
            if (focusElement && weekContent) {
                focusElement.innerHTML = `
                    <h3 class="current-week-title">${weekContent.title}</h3>
                    <p class="current-week-description">${weekContent.description}</p>
                    <div class="current-week-actions">
                        <button class="btn btn-primary" onclick="openChat()">
                            💬 Chatta con Andrea
                        </button>
                        <button class="btn btn-success" onclick="completeWeek()">
                            ✅ Completa Settimana ${userData.currentWeek}
                        </button>
                        <button class="btn btn-secondary" onclick="window.location.href='lifestyle-quiz.html'">
                            🔄 Rifai il Test
                        </button>
                    </div>
                `;
            }
        }

        function getWeekContent(weekNumber) {
            const weekContents = {
                1: {
                    title: "📚 Settimana 1: Benvenuto nel tuo percorso!",
                    description: "Questa settimana ci conosceremo meglio e analizzeremo la tua situazione attuale. Ho preparato materiali specifici per il tuo profilo e sono qui per rispondere a qualsiasi domanda."
                },
                2: {
                    title: "🧠 Settimana 2: Consapevolezza di sé",
                    description: "Esploriamo insieme le tue motivazioni profonde e scopriamo cosa ti spinge veramente verso il cambiamento. Ti guiderò attraverso esercizi di auto-riflessione."
                },
                3: {
                    title: "🎯 Settimana 3: Obiettivi SMART",
                    description: "Trasformiamo i tuoi desideri in obiettivi concreti e raggiungibili. Definiremo insieme una strategia chiara per il tuo successo."
                },
                4: {
                    title: "📋 Settimana 4: Piano di azione",
                    description: "Creiamo il tuo piano di azione personalizzato. Ogni obiettivo diventerà una serie di passi concreti da seguire."
                },
                5: {
                    title: "🔄 Settimana 5: Trasformazione abitudini",
                    description: "Costruiamo insieme le abitudini che ti porteranno al successo. Focus su routine sostenibili e cambiamenti duraturi."
                },
                6: {
                    title: "⭐ Settimana 6: Scopri le tue potenzialità",
                    description: "Identifichiamo e valorizziamo i tuoi punti di forza. Celebriamo i progressi e pianifichiamo la crescita futura."
                },
                7: {
                    title: "🏆 Settimana 7: Consolidamento",
                    description: "Consolidiamo i risultati e pianifichiamo il mantenimento a lungo termine. Celebriamo il tuo percorso di trasformazione!"
                }
            };
            
            return weekContents[weekNumber];
        }

        function generateProfileAnalysis() {
            console.log('🔍 Generazione analisi profilo...');
            
            const scores = userData.scores;
            const totalScore = Object.values(scores).reduce((sum, score) => sum + score, 0);
            const averageScore = totalScore / Object.keys(scores).length;
            
            const analysisElement = document.getElementById('profileAnalysis');
            if (!analysisElement) {
                console.error('❌ Elemento profileAnalysis non trovato');
                return;
            }

            // Identify strengths and weaknesses
            const strengths = [];
            const weaknesses = [];
            
            Object.entries(scores).forEach(([area, score]) => {
                const areaNames = {
                    wellbeing: 'Benessere Emotivo',
                    health: 'Salute Fisica',
                    social: 'Relazioni Sociali',
                    professional: 'Vita Professionale'
                };
                
                if (score >= 4) {
                    strengths.push(areaNames[area]);
                } else if (score <= 2) {
                    weaknesses.push(areaNames[area]);
                }
            });

            // Generate 20-25 line personalized analysis
            let analysis = `
                <p><strong>Ciao ${userData.name || 'Amico/a'},</strong> ho analizzato attentamente i risultati del tuo test e voglio condividere con te alcune riflessioni importanti sulla tua situazione attuale. Quello che ho davanti è il quadro di una persona che ha il coraggio di guardarsi dentro e decidere di migliorare.</p>
                
                <div class="highlight">
                    <p><strong>La tua situazione in sintesi:</strong> Il tuo punteggio medio è ${averageScore.toFixed(1)}/5, che indica ${averageScore >= 4 ? 'una buona base di partenza con margini di miglioramento interessanti' : averageScore >= 3 ? 'una situazione equilibrata ma con potenziale di crescita significativo' : 'diverse aree che richiedono attenzione e supporto, ma con grandi opportunità di trasformazione'}.</p>
                </div>
                
                <p>Dopo 12 anni come manager stressato e la mia trasformazione personale, riconosco perfettamente i segnali che emergono dal tuo profilo. <strong>La buona notizia è che sei già sulla strada giusta</strong> - il fatto che tu abbia completato questo test dimostra una consapevolezza e una volontà di migliorare che non tutti possiedono. Hai fatto il primo passo più difficile: ammettere che vuoi cambiare.</p>
                
                <p><strong>La mia storia ti suonerà familiare:</strong> Per anni ho vissuto in "modalità pilota automatico", correndo da una scadenza all'altra, sempre stressato, sempre stanco. La sveglia suonava e già sapevo che sarebbe stata un'altra giornata identica. Poi ho capito che non era la vita che volevo vivere.</p>
            `;

            // Add strengths analysis
            if (strengths.length > 0) {
                analysis += `
                    <div class="success">
                        <p><strong>I tuoi punti di forza:</strong> Eccelli in ${strengths.join(' e ')}. Questo è fantastico e rappresenta una base solida su cui costruire. ${strengths.includes('Benessere Emotivo') ? 'La tua stabilità emotiva ti darà la forza per affrontare i cambiamenti.' : ''} ${strengths.includes('Relazioni Sociali') ? 'Le tue relazioni positive sono un supporto prezioso per il tuo percorso.' : ''} ${strengths.includes('Salute Fisica') ? 'La tua forma fisica è un asset importante che ti darà energia per tutti gli altri cambiamenti.' : ''}</p>
                    </div>
                `;
            }

            // Add weaknesses analysis
            if (weaknesses.length > 0) {
                analysis += `
                    <div class="warning">
                        <p><strong>Le aree che richiedono attenzione:</strong> ${weaknesses.join(' e ')} mostrano punteggi più bassi. Non ti preoccupare - ho aiutato centinaia di persone in situazioni simili. ${weaknesses.includes('Salute Fisica') ? 'La forma fisica è spesso il primo domino che fa cadere tutti gli altri positivamente.' : ''} ${weaknesses.includes('Vita Professionale') ? 'Lo stress lavorativo è qualcosa che conosco bene - insieme troveremo strategie per gestirlo.' : ''} ${weaknesses.includes('Benessere Emotivo') ? 'Il benessere emotivo è la base di tutto - lavoreremo su questo per darti stabilità.' : ''}</p>
                    </div>
                `;
            }

            // Add personalized insights based on quadrant
            const quadrant = userData.quadrant?.split(':')[0];
            switch(quadrant) {
                case 'Q1':
                    analysis += `
                        <p>Dal tuo profilo emerge che sei una persona <strong>competente e determinata</strong>. Hai le capacità per raggiungere i tuoi obiettivi, ma forse ti manca una strategia strutturata o stai cercando di fare tutto da solo. Il mio approccio sarà quello di un consulente esperto che ti affianca senza giudicare. Non hai bisogno di qualcuno che ti dica cosa fare - hai bisogno di qualcuno che ti aiuti a organizzare quello che già sai.</p>
                    `;
                    break;
                case 'Q2':
                    analysis += `
                        <p>Vedo che hai <strong>forza emotiva e resilienza</strong>, ma potresti aver bisogno di supporto nelle competenze tecniche o nelle strategie pratiche. Perfetto - questo è esattamente il tipo di supporto che posso offrirti, guidandoti passo dopo passo. La tua stabilità emotiva è un grande vantaggio che ti permetterà di apprendere velocemente.</p>
                    `;
                    break;
                case 'Q3':
                    analysis += `
                        <p>Il tuo profilo mostra <strong>competenze tecniche solide</strong> ma potrebbero mancare la motivazione o la spinta emotiva per il cambiamento. Riconosco questo pattern - spesso le persone capaci si bloccano mentalmente. Insieme lavoreremo sul mindset e la motivazione. Hai tutto quello che serve, devi solo "accenderti".</p>
                    `;
                    break;
                case 'Q4':
                    analysis += `
                        <p>Sento che stai attraversando un momento di <strong>ricerca e crescita</strong>. Hai bisogno di supporto sia pratico che emotivo, e questo è perfettamente normale. Sarò il tuo guide paziente e comprensivo in ogni passo del percorso. Non ti giudicherò mai - ti sosterrò sempre.</p>
                    `;
                    break;
                default:
                    analysis += `
                        <p>Dal tuo profilo vedo una persona <strong>in cerca di miglioramento</strong>. Hai la motivazione e la determinazione per cambiare, e questo è già un grande punto di partenza. Insieme troveremo la strada migliore per te.</p>
                    `;
            }

            analysis += `
                <p><strong>Perché questo percorso può davvero aiutarti:</strong> Non è il solito corso teorico dove ti dicono "mangia sano e fai sport". È un sistema testato da me personalmente e da centinaia di persone che ho seguito. Ogni settimana riceverai materiali specifici per la tua situazione e avrai accesso diretto a me per domande e supporto. Non sei un numero - sei una persona unica con la sua storia.</p>
                
                <p>Il percorso è strutturato in <strong>7 settimane progressive</strong> che ti porteranno dalla consapevolezza attuale alla trasformazione concreta. Non ti chiederò di stravolgere la tua vita dall'oggi al domani - insieme procederemo con piccoli passi sostenibili che portano a grandi risultati. Ogni settimana costruiremo su quella precedente.</p>
                
                <p><strong>Cosa rende questo percorso diverso:</strong> Io ci sono passato. So cosa significa essere stressato, demotivato, con la sensazione di essere in una gabbia. E so anche cosa significa uscirne. Non sono solo un coach - sono qualcuno che ha vissuto la tua stessa trasformazione. Quando mi scrivi, dall'altra parte c'è qualcuno che capisce davvero.</p>
                
                <p><strong>Il metodo che uso:</strong> Non ti darò una lista di cose da fare. Ti guiderò attraverso un processo di scoperta dove tu stesso/a troverai le risposte. Ti fornirò strumenti pratici, testati e adattati alla tua personalità. Non esiste un approccio uguale per tutti - esiste l'approccio giusto per te.</p>
            `;

            // Add specific challenges if available
            if (userData.challenges && userData.challenges.length > 0) {
                const challengeMessages = {
                    'procrastination': 'la procrastinazione che ti blocca',
                    'low_energy': 'la mancanza di energia che ti frena',
                    'anxiety': 'l\'ansia che ti limita',
                    'low_self_esteem': 'la bassa autostima che ti sabota',
                    'bad_habits': 'le cattive abitudini che ti ostacolano',
                    'lack_focus': 'la mancanza di concentrazione che ti disperde',
                    'time_management': 'la gestione del tempo che ti sfugge',
                    'work_life_balance': 'l\'equilibrio vita-lavoro che non trovi'
                };
                
                const userChallenges = userData.challenges.map(c => challengeMessages[c] || c).join(', ');
                analysis += `
                    <p><strong>Le tue sfide specifiche:</strong> Ho notato che stai affrontando ${userChallenges}. Sono sfide che conosco bene e per le quali ho strategie specifiche e testate. Non sei solo in questo - migliaia di persone prima di te hanno superato gli stessi ostacoli.</p>
                `;
            }

            analysis += `
                <p><strong>Cosa succederà nelle prossime settimane:</strong> Inizieremo dolcemente con un'analisi profonda di dove sei ora. Poi, settimana dopo settimana, costruiremo insieme il tuo nuovo stile di vita. Non sarà sempre facile, ma sarà sempre sostenibile. E io sarò sempre qui.</p>
                
                <p><strong>La mia promessa:</strong> Non ti abbandonerò mai. Se hai una domanda, se hai un momento di difficoltà, se hai bisogno di chiarimenti - io ci sono. Il mio obiettivo non è venderti un corso, ma aiutarti a diventare la versione migliore di te stesso/a.</p>
                
                <div class="analysis-cta">
                    <h3>🚀 Sei Pronto per la Trasformazione?</h3>
                    <p>Questo è il momento perfetto per iniziare. Hai già fatto il passo più difficile: prendere consapevolezza. Ora lascia che ti guidi verso la versione migliore di te stesso.</p>
                    <button class="btn btn-primary" onclick="startJourney()" style="font-size: 1.1rem; padding: 1rem 2rem;">
                        ✨ Inizia il Tuo Percorso di Trasformazione
                    </button>
                </div>
            `;

            analysisElement.innerHTML = analysis;
            console.log('✅ Analisi profilo generata');
        }

        function startJourney() {
            // Scroll to current week focus
            const currentWeekElement = document.getElementById('currentWeekFocus');
            if (currentWeekElement) {
                currentWeekElement.scrollIntoView({ behavior: 'smooth' });
                
                // Add emphasis animation
                currentWeekElement.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    currentWeekElement.style.transform = 'scale(1)';
                }, 300);
            }
            
            // Show welcome message
            showSuccessMessage('🎉 Perfetto! Benvenuto nel tuo percorso di trasformazione. Scorri in basso per vedere la tua prima settimana!');
        }

        function startImprovementJourney() {
            // Scroll to current week focus
            const currentWeekElement = document.getElementById('currentWeekFocus');
            if (currentWeekElement) {
                currentWeekElement.scrollIntoView({ behavior: 'smooth' });
                
                // Add emphasis animation
                currentWeekElement.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    currentWeekElement.style.transform = 'scale(1)';
                }, 300);
            }
            
            // Show motivational message
            showSuccessMessage('🚀 Fantastico! Iniziamo subito a migliorare tutti i tuoi punteggi. Il tuo percorso di trasformazione ti aspetta!');
        }

        function openChat() {
            const chatSection = document.getElementById('chatSection');
            if (chatSection) {
                chatSection.style.display = 'block';
                chatSection.scrollIntoView({ behavior: 'smooth' });
                
                // Focus on input
                const messageInput = document.getElementById('messageInput');
                if (messageInput) {
                    messageInput.focus();
                }
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML += `
                <div class="message user">
                    <p>${message}</p>
                    <div class="message-time">Proprio ora</div>
                </div>
            `;
            
            // Clear input
            input.value = '';
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            try {
                // Send to Claude AI
                if (userData.automaticCoaching) {
                    const userId = localStorage.getItem('lifestyleUserId');
                    const response = await userData.automaticCoaching.handleUserMessage(userId, message);
                    
                    if (response.success) {
                        // Add Andrea's response
                        setTimeout(() => {
                            messagesContainer.innerHTML += `
                                <div class="message coach">
                                    <p>${response.response}</p>
                                    <div class="message-time">Proprio ora</div>
                                </div>
                            `;
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }, 1000);
                    } else {
                        throw new Error('Response failed');
                    }
                } else {
                    throw new Error('Coaching system not available');
                }
            } catch (error) {
                console.error('❌ Errore invio messaggio:', error);
                
                // Fallback response
                setTimeout(() => {
                    const responses = getPersonalizedFallbackResponse(message);
                    messagesContainer.innerHTML += `
                        <div class="message coach">
                            <p>${responses}</p>
                            <div class="message-time">Proprio ora</div>
                        </div>
                    `;
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 1000);
            }
        }

        function getPersonalizedFallbackResponse(message) {
            const responses = [
                "Grazie per la tua domanda! Ti capisco perfettamente. Quando ero manager, anch'io mi facevo domande simili. Andiamo per gradi: cosa ti preoccupa di più in questo momento?",
                "Ottima riflessione! Vedo che stai davvero pensando al tuo percorso. La consapevolezza è il primo passo verso il cambiamento. Come ti senti rispetto a quello che stiamo costruendo insieme?",
                "Perfetto! Mi piace il tuo approccio. Ho vissuto una trasformazione simile sulla mia pelle e so che la chiave è la costanza, non la perfezione. Cosa ne pensi se ci focalizziamo su una cosa alla volta?",
                "Ti capisco benissimo! La tua situazione mi ricorda molto la mia di qualche anno fa. Il bello è che ora hai tutti gli strumenti per cambiare. Dimmi, cosa ti motiva di più in questo momento?"
            ];
            
            // Simple keyword-based personalization
            if (message.toLowerCase().includes('stress') || message.toLowerCase().includes('ansia')) {
                return "Ti capisco perfettamente! Anch'io ho vissuto periodi di forte stress quando ero manager. Ho imparato che la chiave è iniziare con piccoli passi. Cosa ne pensi se iniziamo con 5 minuti di respirazione profonda al giorno?";
            }
            
            if (message.toLowerCase().includes('motivazione') || message.toLowerCase().includes('energia')) {
                return "La motivazione è come un muscolo: va allenata! Quando ho iniziato il mio percorso, ho scoperto che la motivazione nasce dall'azione, non il contrario. Qual è una piccola azione che potresti fare oggi?";
            }
            
            if (message.toLowerCase().includes('obiettivi') || message.toLowerCase().includes('goal')) {
                return "Gli obiettivi sono fondamentali! La mia esperienza mi ha insegnato che gli obiettivi migliori sono quelli SMART: Specifici, Misurabili, Raggiungibili, Rilevanti e Temporizzati. Vuoi che li definiamo insieme?";
            }
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        async function completeWeek() {
            if (userData.currentWeek < 7) {
                userData.completedWeeks.push(userData.currentWeek);
                userData.currentWeek++;
                
                updateProgressDisplay();
                updateCurrentWeekFocus();
                
                // Show success message
                showSuccessMessage(`🎉 Complimenti! Hai completato la settimana ${userData.currentWeek - 1}! Benvenuto nella settimana ${userData.currentWeek}!`);
                
                // Save progress
                await saveProgress();
            } else {
                showSuccessMessage('🏆 Congratulazioni! Hai completato tutto il percorso di coaching! Sei stato fantastico!');
            }
        }

        function showSuccessMessage(message) {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%); color: white; padding: 1rem 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; max-width: 400px; animation: slideIn 0.3s ease-out;">
                    ${message}
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        async function saveProgress() {
            try {
                localStorage.setItem('lifestyleProgress', JSON.stringify({
                    currentWeek: userData.currentWeek,
                    completedWeeks: userData.completedWeeks,
                    lastUpdate: new Date().toISOString()
                }));
                
                console.log('✅ Progresso salvato');
            } catch (error) {
                console.error('❌ Errore salvataggio progresso:', error);
            }
        }

        // Handle Enter key in chat
        document.addEventListener('DOMContentLoaded', function() {
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>