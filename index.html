<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TribuCoach - Il tuo Personal Trainer Digitale</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .chat-container {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
        }

        .chat-header {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .chat-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .coach-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            background: linear-gradient(135deg, #FF8E53, #FF6B35);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            position: relative;
            z-index: 1;
        }

        .chat-header h1 {
            font-size: 28px;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .chat-header p {
            font-size: 16px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 16px;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #FF6B35, #F7931E);
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            position: relative;
            line-height: 1.6;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border-bottom-left-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-bottom-right-radius: 5px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            border-color: #FF6B35;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .send-button {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF6B35, #F7931E);
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-button:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: none;
            padding: 15px 20px;
            background: white;
            border-radius: 20px;
            border-bottom-left-radius: 5px;
            margin-left: 50px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .typing-dots {
            display: flex;
            gap: 5px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #FF6B35;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.5;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            
            .chat-container {
                height: 100vh;
                border-radius: 0;
                max-width: 100%;
                width: 100%;
            }

            .message-content {
                max-width: 85%;
            }

            .chat-header h1 {
                font-size: 24px;
            }

            .coach-avatar {
                width: 60px;
                height: 60px;
                font-size: 28px;
            }
        }

        /* Scrollbar styling */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #FF6B35;
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #e55a2b;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="coach-avatar">üèãÔ∏è</div>
            <h1>Andrea Padoan</h1>
            <p>Personal Trainer ‚Ä¢ Il tuo allenatore digitale</p>
        </div>

        <div class="chat-messages" id="chatMessages">
            <!-- I messaggi verranno aggiunti qui dinamicamente -->
        </div>

        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <input type="text" id="chatInput" class="chat-input" placeholder="Scrivi ad Andrea Padoan..." maxlength="500">
                <button id="sendButton" class="send-button">
                    <span>‚Üí</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts con fallback -->
    <script>
        // Fallback Firebase se CDN non funziona
        window.firebaseConfig = {
            apiKey: "AIzaSyDGpAHia_wEtNyhbP8POaOsUjkLmTJh7vE",
            authDomain: "jungpt-399117.firebaseapp.com",
            projectId: "jungpt-399117",
            storageBucket: "jungpt-399117.appspot.com",
            messagingSenderId: "21936707731",
            appId: "1:21936707731:web:6c26b7a56d8ab9baeaaff8"
        };
    </script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js" 
            onerror="console.warn('Firebase app failed to load')"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"
            onerror="console.warn('Firebase firestore failed to load')"></script>

    <script>
        // üß† ADVANCED KNOWLEDGE BASE INTEGRATA
        class AdvancedKnowledgeBase {
            constructor() {
                this.nutritionResponses = {
                    keywords: ['alimentazione', 'dieta', 'cibo', 'mangiare', 'piano alimentare', 'cosa mangiare', 'nutrizione', 'ricette', 'menu'],
                    response: `ü•ó PIANO ALIMENTARE PERSONALIZZATO

üåÖ COLAZIONE (350 kcal):
- Avena (50g) + latte vegetale (200ml)
- Banana (1 media) + noci (15g)
- Caff√®/t√® senza zucchero
üí™ Proteine: 15g | Carboidrati: 60g | Grassi: 12g

üåû SPUNTINO MATTINA (200 kcal):
- Yogurt greco (125g) + mirtilli (80g)
- Mandorle (10g)
üí™ Proteine: 15g | Carboidrati: 20g | Grassi: 8g

üçΩÔ∏è PRANZO (550 kcal):
- Petto pollo (120g) alla griglia
- Riso integrale (60g crudo)
- Verdure miste saltate (200g)
- Olio EVO (1 cucchiaio)
üí™ Proteine: 30g | Carboidrati: 45g | Grassi: 14g

ü•ó SPUNTINO POMERIGGIO (300 kcal):
- Frullato: whey protein (25g) + banana
- Latte di mandorla (200ml)
üí™ Proteine: 25g | Carboidrati: 25g | Grassi: 3g

üåô CENA (500 kcal):
- Salmone (100g) al forno
- Patate dolci (150g)
- Insalata mista + avocado (50g)
üí™ Proteine: 25g | Carboidrati: 30g | Grassi: 18g

üíß IDRATAZIONE: 2.5-3L acqua/giorno
üïê TIMING: Pasti ogni 3-4 ore
‚öñÔ∏è TOTALE GIORNO: ~1900 kcal

üéØ Vuoi personalizzarlo? Dimmi:
- Peso attuale e obiettivo
- Livello attivit√† fisica  
- Preferenze/intolleranze alimentari`
                };

                this.workoutResponses = {
                    keywords: ['allenamento', 'workout', 'esercizi', 'training', 'palestra', 'fitness'],
                    response: `üèãÔ∏è WORKOUT FUNZIONALE 45 MIN

üî• WARM-UP (8min):
- Jumping jacks: 45 sec
- Arm circles: 30 sec
- Leg swings: 20 per gamba
- Hip circles: 15 per direzione
- Dynamic stretching: 3 min

üí™ STRENGTH CIRCUIT (25min):
ROUND 1 - LOWER BODY (8min):
- Squat: 50 sec ON / 10 sec REST
- Lunges alternate: 50 sec ON / 10 sec REST
- Glute bridges: 50 sec ON / 10 sec REST
- Wall sit: 50 sec ON / 30 sec REST
Ripeti 2 volte

ROUND 2 - UPPER BODY (8min):
- Push-ups (modify on knees): 50 sec ON / 10 sec REST
- Pike push-ups: 50 sec ON / 10 sec REST
- Tricep dips: 50 sec ON / 10 sec REST
- Plank hold: 50 sec ON / 30 sec REST
Ripeti 2 volte

ROUND 3 - FULL BODY (9min):
- Burpees: 40 sec ON / 20 sec REST
- Mountain climbers: 40 sec ON / 20 sec REST
- Russian twists: 40 sec ON / 20 sec REST
- High knees: 40 sec ON / 20 sec REST
Ripeti 2 volte

üßò COOL-DOWN (12min):
- Stretching completo tutti gruppi muscolari
- Respirazione profonda 4-7-8
- Rilassamento progressivo

üéØ PROGRESSIONE:
Settimana 1-2: 70% intensit√†
Settimana 3-4: 85% intensit√†
Settimana 5+: 100% intensit√† + variazioni

üí° Come ti senti? Troppo facile o impegnativo?`
                };

                console.log('üß† Advanced Knowledge Base caricata con successo');
            }

            getAdvancedKnowledgeResponse(message) {
                const lowerMessage = message.toLowerCase();
                
                // PRIORIT√Ä ASSOLUTA NUTRIZIONE
                for (const keyword of this.nutritionResponses.keywords) {
                    if (lowerMessage.includes(keyword)) {
                        return {
                            content: this.nutritionResponses.response,
                            confidence: 'high',
                            type: 'nutrition'
                        };
                    }
                }

                // WORKOUT solo se NON √® nutrizione
                for (const keyword of this.workoutResponses.keywords) {
                    if (lowerMessage.includes(keyword)) {
                        return {
                            content: this.workoutResponses.response,
                            confidence: 'high',
                            type: 'workout'
                        };
                    }
                }

                return null;
            }
        }

        // üéØ GLOBAL VARIABLES
        let currentSessionId = null;
        let conversationId = null;
        let userPhone = null;
        let userName = null;
        let conversation = [];
        let knowledgeBase = null;
        let db = null;
        let firebaseInitialized = false;
        let askedForName = false;

        // üî• FIREBASE INITIALIZATION MIGLIORATO
        async function initializeFirebase() {
            try {
                // Aspetta che Firebase si carichi (max 15 secondi)
                let attempts = 0;
                const maxAttempts = 75; // 15 secondi
                
                while (attempts < maxAttempts) {
                    if (typeof firebase !== 'undefined' && firebase.apps) {
                        break;
                    }
                    await new Promise(resolve => setTimeout(resolve, 200));
                    attempts++;
                }
                
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase not available after 15 seconds');
                }

                // Verifica se gi√† inizializzato
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(window.firebaseConfig);
                }
                
                db = firebase.firestore();
                firebaseInitialized = true;
                console.log('‚úÖ Firebase inizializzato correttamente');
                return true;
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Firebase non disponibile, modalit√† offline:', error.message);
                firebaseInitialized = false;
                
                // Mostra notifica discreta all'utente
                setTimeout(() => {
                    const chatMessages = document.getElementById('chatMessages');
                    const notice = document.createElement('div');
                    notice.style.cssText = `
                        background: #fff3cd; 
                        color: #856404; 
                        padding: 10px; 
                        margin: 10px 0; 
                        border-radius: 8px; 
                        font-size: 14px; 
                        text-align: center;
                        border: 1px solid #ffeaa7;
                    `;
                    notice.innerHTML = 'üì± Modalit√† offline attiva - Le conversazioni verranno salvate localmente';
                    chatMessages.appendChild(notice);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 2000);
                
                return false;
            }
        }

        // üì± SESSION MANAGEMENT CON RECOVERY
        function getSessionId() {
            // 1. Prova localStorage (persistente)
            let sessionId = localStorage.getItem('tribucoach_sessionId');
            const timestamp = localStorage.getItem('tribucoach_sessionTimestamp');
            
            const now = Date.now();
            const maxAge = 24 * 60 * 60 * 1000; // 24 ore
            
            if (sessionId && timestamp && (now - parseInt(timestamp)) < maxAge) {
                console.log('üì± Session recuperata:', sessionId);
                
                // Recupera dati utente
                const savedPhone = localStorage.getItem('tribucoach_userPhone');
                const savedName = localStorage.getItem('tribucoach_userName');
                const savedConvId = localStorage.getItem('tribucoach_conversationId');
                
                if (savedPhone) {
                    userPhone = savedPhone;
                    console.log('üìû Telefono recuperato:', userPhone);
                }
                if (savedName) {
                    userName = savedName;
                    console.log('üë§ Nome recuperato:', userName);
                }
                if (savedConvId) {
                    conversationId = savedConvId;
                    console.log('üí¨ ConversationId recuperato:', conversationId);
                }
                
                return sessionId;
            }
            
            // 2. Crea nuova sessione
            sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            localStorage.setItem('tribucoach_sessionId', sessionId);
            sessionStorage.setItem('tribucoach_sessionId', sessionId);
            localStorage.setItem('tribucoach_sessionTimestamp', now.toString());
            
            console.log('üÜï Nuova sessione:', sessionId);
            return sessionId;
        }

        // üë§ ESTRAZIONE NOME E TELEFONO MIGLIORATA
        function extractUserInfo(message) {
            let extractedName = null;
            let extractedPhone = null;
            
            // Pattern per nome pi√π precisi
            const namePatterns = [
                /(?:sono|mi chiamo|nome √®|nome:)\s*([A-Za-z√Ä-√ø\s]{2,25})/i,
                /(?:il mio nome √®|chiamami)\s*([A-Za-z√Ä-√ø\s]{2,25})/i,
                /^ciao,?\s+([A-Za-z√Ä-√ø]{2,15})$/i,
                /^([A-Za-z√Ä-√ø]{2,15})$/,
                /^([A-Za-z√Ä-√ø]{2,15}\s+[A-Za-z√Ä-√ø]{2,15})$/
            ];
            
            // Pattern per telefono
            const phonePatterns = [
                /(?:telefono|cellulare|numero|cell)?\s*[:√®]?\s*([+]?[0-9\s\-().]{8,15})/i,
                /([+]?39\s?[0-9]{2,4}\s?[0-9]{6,8})/g,
                /([+]?[0-9]{9,15})/g
            ];
            
            // Estrai nome
            for (const pattern of namePatterns) {
                const match = message.match(pattern);
                if (match && match[1]) {
                    const name = match[1].trim();
                    // Valida nome
                    if (name.length >= 2 && !/\d/.test(name) && 
                        !/(ciao|sono|nome|chiamami|salve)/i.test(name)) {
                        extractedName = name;
                        break;
                    }
                }
            }
            
            // Estrai telefono
            for (const pattern of phonePatterns) {
                const match = message.match(pattern);
                if (match && match[1]) {
                    const phone = match[1].replace(/[\s\-().]/g, '');
                    if (phone.length >= 9 && phone.length <= 15 && /^[+]?[0-9]+$/.test(phone)) {
                        extractedPhone = phone;
                        break;
                    }
                }
            }
            
            return { name: extractedName, phone: extractedPhone };
        }

        // üíæ SALVA DATI UTENTE
        function saveUserData(name, phone) {
            if (name && name !== userName) {
                userName = name;
                localStorage.setItem('tribucoach_userName', name);
                sessionStorage.setItem('tribucoach_userName', name);
                console.log('üë§ Nome salvato:', name);
            }
            
            if (phone && phone !== userPhone) {
                userPhone = phone;
                localStorage.setItem('tribucoach_userPhone', phone);
                sessionStorage.setItem('tribucoach_userPhone', phone);
                console.log('üìû Telefono salvato:', phone);
                
                // Unifica sessioni se Firebase disponibile
                if (firebaseInitialized) {
                    setTimeout(() => unifySessions(phone), 1000);
                }
            }
        }

        // üîó UNIFICA SESSIONI STESSO TELEFONO
        async function unifySessions(phone) {
            if (!firebaseInitialized || !db || !phone) return;
            
            try {
                console.log('üîç Cerco conversazioni esistenti per:', phone);
                
                const querySnapshot = await db.collection('chatbase_conversations')
                    .where('customerPhone', '==', phone)
                    .orderBy('timestamp', 'desc')
                    .limit(1)
                    .get();
                
                if (!querySnapshot.empty) {
                    const existingDoc = querySnapshot.docs[0];
                    const existingData = existingDoc.data();
                    
                    console.log('üìö Conversazione esistente trovata:', existingData.conversationId);
                    
                    // Usa conversationId esistente
                    conversationId = existingData.conversationId;
                    localStorage.setItem('tribucoach_conversationId', conversationId);
                    
                    // Recupera conversazione se recente (< 24h)
                    if (existingData.fullConversation && Array.isArray(existingData.fullConversation)) {
                        const lastTime = existingData.timestamp?.toDate?.() || new Date(existingData.timestamp);
                        const hoursAgo = (Date.now() - lastTime.getTime()) / (1000 * 60 * 60);
                        
                        if (hoursAgo < 24) {
                            console.log('üîÑ Recupero conversazione di', hoursAgo.toFixed(1), 'ore fa');
                            
                            conversation = existingData.fullConversation;
                            
                            // Ripopola chat UI
                            const chatMessages = document.getElementById('chatMessages');
                            chatMessages.innerHTML = '';
                            
                            conversation.forEach(msg => {
                                addMessage(msg.content, msg.role === 'user' ? 'user' : 'assistant', false);
                            });
                            
                            // Scroll to bottom
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                            
                            console.log('‚úÖ Conversazione recuperata:', conversation.length, 'messaggi');
                            return;
                        }
                    }
                    
                    console.log('üîó Sessioni unificate per telefono:', phone);
                }
            } catch (error) {
                console.error('‚ùå Errore unificazione sessioni:', error);
            }
        }

        // üé¨ CHAT INITIALIZATION
        async function initChat() {
            currentSessionId = getSessionId();
            
            if (!conversationId) {
                conversationId = 'conv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('tribucoach_conversationId', conversationId);
            }
            
            console.log('üöÄ Chat inizializzata:', {
                sessionId: currentSessionId,
                conversationId: conversationId,
                userName: userName,
                userPhone: userPhone
            });

            // Messaggio di benvenuto solo se conversazione vuota
            if (conversation.length === 0) {
                setTimeout(() => {
                    let welcomeMessage;
                    
                    if (userName) {
                        welcomeMessage = `üèãÔ∏è Ciao ${userName}! Bentornato! 

Sono sempre qui per aiutarti con:
üèÉ Allenamenti personalizzati üí™ 
ü•ó Consigli alimentari üçé 
üìû Info sui servizi üí¨ 
üéØ Motivazione üî• 

Su cosa vuoi lavorare oggi?`;
                    } else {
                        welcomeMessage = `üèãÔ∏è Ciao! Sono Andrea Padoan in versione digitale! ü§ñ 

Prima di iniziare, **come ti chiami?** Mi piace personalizzare i nostri allenamenti! üòä

Poi potr√≤ aiutarti con:
üèÉ Allenamenti su misura per te üí™ 
ü•ó Consigli alimentari personalizzati üçé 
üìû Informazioni sui miei servizi üí¨ 
üéØ Motivazione quando ne hai bisogno üî•`;
                        askedForName = true;
                    }

                    addMessage(welcomeMessage, 'assistant');
                }, 1000);
            }
        }

        // üîó EVENT LISTENERS
        function setupEventListeners() {
            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');

            sendButton.addEventListener('click', sendMessage);
            
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            chatInput.addEventListener('input', function() {
                sendButton.disabled = this.value.trim() === '';
            });
        }

        // üì® SEND MESSAGE
        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (message === '') return;

            // Estrai info utente
            const userInfo = extractUserInfo(message);
            if (userInfo.name || userInfo.phone) {
                saveUserData(userInfo.name, userInfo.phone);
            }

            addMessage(message, 'user');
            chatInput.value = '';
            
            showTypingIndicator();
            
            try {
                // Se ha appena dato il nome, ringrazia
                if (userInfo.name && !userName) {
                    const thankMessage = `Piacere di conoscerti, ${userInfo.name}! üòä

Ora dimmi, cosa posso fare per te oggi?
‚Ä¢ Creare un allenamento personalizzato
‚Ä¢ Consigli alimentari
‚Ä¢ Info sui miei servizi
‚Ä¢ Motivazione

Cosa ti interessa di pi√π?`;
                    
                    hideTypingIndicator();
                    addMessage(thankMessage, 'assistant');
                } else {
                    const response = await generateResponse(message);
                    hideTypingIndicator();
                    addMessage(response, 'assistant');
                }
                
                // Salva conversazione
                if (firebaseInitialized) {
                    await saveConversation();
                }
                
            } catch (error) {
                hideTypingIndicator();
                console.error('‚ùå Errore generazione risposta:', error);
                addMessage('Mi dispiace, c\'√® stato un errore. Riprova tra un momento.', 'assistant');
            }
        }

        // üß† RESPONSE GENERATION
        async function generateResponse(message) {
            try {
                // Usa Advanced Knowledge Base
                if (knowledgeBase) {
                    const advancedResponse = knowledgeBase.getAdvancedKnowledgeResponse(message);
                    if (advancedResponse && advancedResponse.confidence === 'high') {
                        return advancedResponse.content;
                    }
                }
                
                return getBasicResponse(message);
                
            } catch (error) {
                console.error('‚ùå Errore Knowledge Base:', error);
                return getBasicResponse(message);
            }
        }

        // üí¨ ADD MESSAGE TO CHAT
        function addMessage(content, sender, saveToConversation = true) {
            const chatMessages = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'user' ? (userName ? userName.charAt(0).toUpperCase() : 'üë§') : 'üèãÔ∏è';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = formatMessage(content);
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            if (saveToConversation) {
                conversation.push({
                    role: sender === 'user' ? 'user' : 'assistant',
                    content: content,
                    timestamp: new Date().toISOString()
                });
            }
        }

        // üé® FORMAT MESSAGE
        function formatMessage(content) {
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>')
                .replace(/(üèãÔ∏è|üí™|üèÉ|ü•ó|üéØ|üî•|üí¨|üìû|ü§ñ|üë§|üçé|üí°|üòä)/g, '<span style="font-size: 1.2em;">$1</span>');
        }

        // ‚å®Ô∏è TYPING INDICATOR
        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'block';
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        // üíæ SAVE CONVERSATION
        async function saveConversation() {
            if (!firebaseInitialized || !db) {
                console.log('üíæ Firebase non disponibile, salvo solo localmente');
                return;
            }
            
            try {
                const conversationData = {
                    conversationId: conversationId,
                    sessionId: currentSessionId,
                    customerName: userName || null,
                    customerPhone: userPhone || null,
                    customerEmail: null,
                    fullConversation: conversation,
                    fullconversation: JSON.stringify(conversation),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    lastMessage: conversation[conversation.length - 1]?.content || '',
                    messageCount: conversation.length
                };

                await db.collection('chatbase_conversations').doc(conversationId).set(conversationData, { merge: true });
                console.log('üíæ Conversazione salvata');
                
            } catch (error) {
                console.error('‚ùå Errore salvataggio:', error);
            }
        }

        // üß† BASIC RESPONSE
        function getBasicResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('prezzo') || lowerMessage.includes('costo') || 
                lowerMessage.includes('quanto') || lowerMessage.includes('tariff')) {
                return `üí∞ SERVIZI PERSONAL TRAINING

üèãÔ∏è PERSONAL TRAINING 1:1:
- Sessione singola: ‚Ç¨60
- Pacchetto 4 sessioni: ‚Ç¨220 (risparmio ‚Ç¨20)
- Pacchetto 8 sessioni: ‚Ç¨420 (risparmio ‚Ç¨60)

üë• SMALL GROUP (2-3 persone):
- Sessione singola: ‚Ç¨40/persona
- Pacchetto 4 sessioni: ‚Ç¨140/persona

üè† ONLINE COACHING:
- Programma mensile: ‚Ç¨89
- Programma trimestrale: ‚Ç¨240
- Include: piano allenamento + alimentazione + supporto WhatsApp

üéØ COSA INCLUDE:
‚úÖ Valutazione fitness completa
‚úÖ Programma personalizzato
‚úÖ Correzione tecnica esercizi
‚úÖ Piano nutrizionale base
‚úÖ Supporto motivazionale

üìû Vuoi prenotare? Dammi il tuo numero!`;
            }
            
            if (lowerMessage.includes('motivazione') || lowerMessage.includes('demotivato')) {
                return `üî• MOTIVAZIONE POWER-UP!

üí™ RICORDA PERCH√â HAI INIZIATO:
- La versione migliore di te ti sta aspettando
- Ogni piccolo passo conta
- Non stai solo cambiando il corpo, stai cambiando la vita

üéØ MINDSET VINCENTE:
- "Non cerco scuse, cerco risultati"
- "La costanza batte il talento"
- "Ogni giorno √® una nuova opportunit√†"

‚ö° AZIONE IMMEDIATA:
1. Fai 10 squat ADESSO
2. Bevi un bicchiere d'acqua
3. Pianifica il prossimo allenamento

üèÜ "Il dolore √® temporaneo, ma rinunciare dura per sempre!"

üí¨ Parlami delle tue difficolt√†! üí™`;
            }

            if (lowerMessage.includes('ciao') || lowerMessage.includes('salve')) {
                const greeting = userName ? `Ciao ${userName}! üëã` : 'Ciao! üëã';
                return `${greeting} Sono Andrea Padoan!

Posso aiutarti con:
üèãÔ∏è Allenamenti personalizzati
ü•ó Piani alimentari
üí∞ Info sui servizi
üî• Motivazione e supporto

Cosa ti serve oggi? üí™`;
            }
            
            // Risposta generica
            const name = userName ? ` ${userName}` : '';
            return `Ciao${name}! üëã Sono Andrea Padoan, il tuo personal trainer digitale!

Come posso aiutarti oggi?
üèãÔ∏è Allenamenti personalizzati
ü•ó Piani alimentari
üí∞ Info sui servizi
üî• Motivazione e supporto

Cosa ti interessa di pi√π? üí™`;
        }

        // üöÄ MAIN INITIALIZATION CON SEQUENZA CORRETTA
        window.addEventListener('load', async function() {
            console.log('üöÄ Inizializzazione sistema...');
            
            // 1. Prima carica Knowledge Base (sempre disponibile)
            knowledgeBase = new AdvancedKnowledgeBase();
            
            // 2. Poi prova Firebase (con retry)
            await initializeFirebase();
            
            // 3. Infine inizializza chat
            await initChat();
            setupEventListeners();
            
            console.log('‚úÖ Sistema completamente inizializzato');
        });
    </script>
</body>
</html>