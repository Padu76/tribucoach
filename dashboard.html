<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TribuCoach Dashboard - Chatbase + Firebase</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #2a2a2a 100%);
            color: #fff;
            min-height: 100vh;
            line-height: 1.4;
        }

        .status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .status.loading {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
        }

        .status.connected {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .status.error {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .header {
            background: linear-gradient(135deg, rgba(255,102,0,0.15), rgba(255,102,0,0.05));
            padding: 25px;
            border-bottom: 3px solid #ff6600;
            margin-top: 50px;
        }

        .header h1 {
            color: #ff6600;
            font-size: 2.2rem;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .header p {
            color: #ccc;
            font-size: 1.1rem;
        }

        .dashboard {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }

        .metric-card {
            background: linear-gradient(135deg, #2a2a2a 0%, #333333 100%);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border: 1px solid #404040;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6600, #ff9933);
        }

        .metric-card h3 {
            color: #ff9933;
            font-size: 1.1rem;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .metric-card p {
            font-size: 2.5rem;
            font-weight: 800;
            color: #fff;
        }

        .section {
            background: linear-gradient(135deg, #2a2a2a 0%, #333333 100%);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            margin-bottom: 35px;
            border: 1px solid #404040;
        }

        .section h2 {
            color: #ff6600;
            font-size: 1.9rem;
            margin-bottom: 25px;
            border-bottom: 2px solid #444;
            padding-bottom: 15px;
            font-weight: 700;
        }

        .chats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }

        .chat-card {
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            border: 1px solid #444;
            border-radius: 12px;
            padding: 25px;
            border-left: 5px solid #2196F3;
            transition: all 0.3s ease;
        }

        .chat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(33, 150, 243, 0.2);
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .chat-client {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2196F3;
        }

        .chat-topic {
            background: rgba(33, 150, 243, 0.2);
            color: #64B5F6;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .chat-preview {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #ccc;
            font-style: italic;
            border-left: 3px solid #2196F3;
        }

        .chat-meta {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            font-size: 0.85rem;
            color: #aaa;
        }

        .btn {
            background: linear-gradient(135deg, #ff6600, #ff8533);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s ease;
            margin: 5px;
        }

        .btn:hover {
            background: linear-gradient(135deg, #ff8533, #ffaa66);
            transform: translateY(-1px);
        }

        .btn.primary {
            background: linear-gradient(135deg, #2196F3, #1976D2);
        }

        .btn.primary:hover {
            background: linear-gradient(135deg, #1976D2, #1565C0);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #ff9933;
        }

        .error {
            background: #4a1a1a;
            border: 1px solid #f44336;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            color: #ffcdd2;
        }

        @media (max-width: 768px) {
            .dashboard { padding: 20px 15px; }
            .chats-grid { grid-template-columns: 1fr; }
            .metrics-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="status loading" id="status">
        üîÑ Connessione in corso...
    </div>

    <header class="header">
        <h1>üìà TribuCoach Dashboard</h1>
        <p>Conversazioni Chatbase + Quiz Firebase</p>
    </header>

    <div class="dashboard">
        <!-- METRICHE -->
        <div class="metrics-grid">
            <div class="metric-card">
                <h3>üí¨ Conversazioni Totali</h3>
                <p id="totalConversations">0</p>
            </div>
            <div class="metric-card">
                <h3>üìä Quiz Completati</h3>
                <p id="totalQuiz">0</p>
            </div>
            <div class="metric-card">
                <h3>üî• Oggi</h3>
                <p id="todayChats">0</p>
            </div>
            <div class="metric-card">
                <h3>‚≠ê Score Medio</h3>
                <p id="avgScore">0%</p>
            </div>
        </div>

        <!-- CONVERSAZIONI CHATBASE -->
        <div class="section">
            <h2>üí¨ Conversazioni Chatbase da Firebase</h2>
            <div class="chat-actions" style="margin-bottom: 20px;">
                <button class="btn primary" onclick="loadChatbaseConversations()">üîÑ Carica Conversazioni</button>
                <button class="btn" onclick="loadFirebaseQuiz()">üìä Carica Quiz</button>
                <button class="btn" onclick="useMockConversations()">üß™ Usa Dati Mock</button>
            </div>
            <div id="conversationsContainer" class="chats-grid">
                <div class="loading">
                    <div class="icon">üîÑ</div>
                    <p>Clicca "Carica Conversazioni" per vedere le chat reali da Firebase</p>
                </div>
            </div>
        </div>

        <!-- QUIZ FIREBASE -->
        <div class="section">
            <h2>üìä Quiz Firebase</h2>
            <div id="quizContainer" class="chats-grid">
                <div class="loading">
                    <div class="icon">üìä</div>
                    <p>Clicca "Carica Quiz" per vedere i risultati</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configurazioni reali
        const CHATBASE_CONFIG = {
            secretKey: '0uk17rpq8vkvbw1nvnhvupwm0zc8iwjo',
            chatbotId: 'EjoHCEogMfkkrVzIK6V07',
            apiBase: 'https://www.chatbase.co/api/v1'
        };

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDSsQEPii_Eb99cWGs7eqozgTtIqbtO2rs",
            authDomain: "tribucoach-a2254.firebaseapp.com",
            projectId: "tribucoach-a2254",
            storageBucket: "tribucoach-a2254.firebasestorage.app",
            messagingSenderId: "425200296836",
            appId: "1:425200296836:web:7835188f40f4348567ab48"
        };

        // Inizializza Firebase
        firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.firestore();

        // Variabili globali
        let conversationsData = [];
        let quizData = [];

        // === FIREBASE CONVERSATIONS ===
        async function loadChatbaseConversations() {
            updateStatus('loading', 'üîÑ Caricando conversazioni da Firebase...');
            
            try {
                console.log('üí¨ Recupero conversazioni da Firebase...');
                
                const querySnapshot = await db.collection('conversations').orderBy('lastMessageAt', 'desc').limit(50).get();
                
                conversationsData = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Estrai info dal primo messaggio utente
                    const userMessages = data.messages?.filter(msg => msg.role === 'user') || [];
                    const firstUserMessage = userMessages[0]?.message || 'Nessun messaggio';
                    const lastUserMessage = userMessages[userMessages.length - 1]?.message || firstUserMessage;
                    
                    conversationsData.push({
                        id: doc.id,
                        clientName: extractNameFromText(firstUserMessage) || 'Cliente Anonimo',
                        phone: extractPhoneFromText(firstUserMessage) || extractPhoneFromText(lastUserMessage) || 'N/A',
                        topic: extractTopicFromText(firstUserMessage + ' ' + lastUserMessage) || 'Generale',
                        lastMessage: lastUserMessage,
                        timestamp: data.lastMessageAt?.toDate() || data.dateCreated?.toDate() || new Date(),
                        messagesCount: data.messages?.length || 0,
                        source: 'Firebase',
                        chatbaseId: data.chatbaseId
                    });
                });

                console.log(`üí¨ Caricate ${conversationsData.length} conversazioni da Firebase`);
                renderConversations();
                updateMetrics();
                updateStatus('connected', `‚úÖ ${conversationsData.length} conversazioni caricate da Firebase`);
                
            } catch (error) {
                console.error('‚ùå Errore Firebase conversations:', error);
                updateStatus('error', `‚ùå Errore Firebase: ${error.message}`);
                showChatbaseError(error.message);
            }
        }

        // === FIREBASE QUIZ ===
        async function loadFirebaseQuiz() {
            updateStatus('loading', 'üìä Caricando quiz da Firebase...');
            
            try {
                console.log('üìä Recupero quiz da Firebase...');
                
                const querySnapshot = await db.collection('quiz_results').orderBy('timestamp', 'desc').limit(20).get();
                
                quizData = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    quizData.push({
                        id: doc.id,
                        name: data.name || data.userName || 'Nome non disponibile',
                        email: data.email || data.userEmail || 'Non disponibile',
                        phone: data.whatsapp || data.phone || 'Non disponibile',
                        score: data.score || calculateScore(data),
                        profile: data.fitnessPersonality || data.profile || 'Non specificato',
                        timestamp: data.timestamp?.toDate() || new Date()
                    });
                });

                renderQuiz();
                updateMetrics();
                updateStatus('connected', `‚úÖ ${quizData.length} quiz caricati da Firebase`);
                
            } catch (error) {
                console.error('‚ùå Errore Firebase:', error);
                updateStatus('error', `‚ùå Errore Firebase: ${error.message}`);
                showFirebaseError(error.message);
            }
        }

        // === MOCK DATA ===
        function useMockConversations() {
            updateStatus('loading', 'üß™ Caricando conversazioni mock...');
            
            conversationsData = [
                {
                    id: 'mock-1',
                    clientName: 'Marco Rossi',
                    phone: '+39 333 1234567',
                    topic: 'Allenamento',
                    lastMessage: 'Ciao, sono Marco e vorrei un allenamento specifico per i glutei. Vado in palestra da 2 anni.',
                    timestamp: new Date(),
                    messagesCount: 8,
                    source: 'Mock'
                },
                {
                    id: 'mock-2',
                    clientName: 'Laura Bianchi', 
                    phone: '+39 333 7654321',
                    topic: 'Dieta',
                    lastMessage: 'Salve, mi chiamo Laura. Ho bisogno di una dieta per perdere 5kg prima dell\'estate.',
                    timestamp: new Date(Date.now() - 2*60*60*1000),
                    messagesCount: 12,
                    source: 'Mock'
                },
                {
                    id: 'mock-3',
                    clientName: 'Giuseppe Verde',
                    phone: 'N/A',
                    topic: 'Consulenza',
                    lastMessage: 'Buongiorno, vorrei prenotare una consulenza per un piano alimentare personalizzato.',
                    timestamp: new Date(Date.now() - 24*60*60*1000),
                    messagesCount: 5,
                    source: 'Mock'
                }
            ];
            
            renderConversations();
            updateMetrics();
            updateStatus('connected', '‚úÖ 3 conversazioni mock caricate per test');
        }

        // === RENDERING ===
        function renderConversations() {
            const container = document.getElementById('conversationsContainer');
            
            if (conversationsData.length === 0) {
                showEmptyConversations();
                return;
            }

            const html = conversationsData.map(conv => `
                <div class="chat-card">
                    <div class="chat-header">
                        <div class="chat-client">${conv.clientName}</div>
                        <div class="chat-topic">${conv.topic}</div>
                    </div>
                    
                    <div class="chat-preview">"${conv.lastMessage}"</div>
                    
                    <div class="chat-meta">
                        <span>üì± ${conv.phone}</span>
                        <span>üí¨ ${conv.messagesCount} msg</span>
                        <span>üìÖ ${conv.timestamp.toLocaleDateString('it-IT')}</span>
                    </div>
                    
                    <div class="chat-actions">
                        ${conv.phone !== 'N/A' ? 
                            `<button class="btn" onclick="openWhatsApp('${conv.phone}')">üì± WhatsApp</button>` : ''
                        }
                        <button class="btn primary" onclick="viewConversation('${conv.id}')">üëÅÔ∏è Dettagli</button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function renderQuiz() {
            const container = document.getElementById('quizContainer');
            
            if (quizData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìä</div>
                        <p>Nessun quiz trovato</p>
                    </div>
                `;
                return;
            }

            const html = quizData.map(quiz => {
                const scoreClass = quiz.score > 80 ? 'high' : quiz.score >= 60 ? 'medium' : 'low';
                return `
                    <div class="chat-card">
                        <div class="chat-header">
                            <div class="chat-client">${quiz.name}</div>
                            <div class="chat-topic score-${scoreClass}">${quiz.score}%</div>
                        </div>
                        
                        <div class="chat-preview">
                            <strong>üìß Email:</strong> ${quiz.email}<br>
                            <strong>üì± Phone:</strong> ${quiz.phone}<br>
                            <strong>üë§ Profile:</strong> ${quiz.profile}
                        </div>
                        
                        <div class="chat-meta">
                            <span>üìÖ ${quiz.timestamp.toLocaleDateString('it-IT')}</span>
                            <span>‚≠ê Score: ${quiz.score}%</span>
                        </div>
                        
                        <div class="chat-actions">
                            ${quiz.phone !== 'Non disponibile' ? 
                                `<button class="btn" onclick="openWhatsApp('${quiz.phone}')">üì± WhatsApp</button>` : ''
                            }
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // === ERROR HANDLERS ===
        function showEmptyConversations() {
            document.getElementById('conversationsContainer').innerHTML = `
                <div class="empty-state">
                    <div class="icon">üí¨</div>
                    <p>Nessuna conversazione trovata</p>
                    <small>Le conversazioni appariranno qui quando gli utenti interagiranno con il chatbot</small>
                </div>
            `;
        }

        function showChatbaseError(errorMessage) {
            document.getElementById('conversationsContainer').innerHTML = `
                <div class="error">
                    <h3>‚ùå Errore API Chatbase</h3>
                    <p><strong>Errore:</strong> ${errorMessage}</p>
                    <p><strong>ChatbotId:</strong> ${CHATBASE_CONFIG.chatbotId}</p>
                    <div style="margin-top: 15px;">
                        <button class="btn" onclick="loadChatbaseConversations()">üîÑ Riprova</button>
                        <button class="btn primary" onclick="useMockConversations()">üß™ Usa Dati Mock</button>
                    </div>
                </div>
            `;
        }

        function showFirebaseError(errorMessage) {
            document.getElementById('quizContainer').innerHTML = `
                <div class="error">
                    <h3>‚ùå Errore Firebase</h3>
                    <p>${errorMessage}</p>
                    <button class="btn" onclick="loadFirebaseQuiz()">üîÑ Riprova</button>
                </div>
            `;
        }

        // === UTILITY FUNCTIONS AGGIORNATE ===
        function extractNameFromText(text) {
            if (!text) return null;
            const patterns = [
                /(?:mi chiamo|sono|il mio nome √®)\s+([a-zA-Z\s]{2,20})/i,
                /^([a-zA-Z]{2,15})\s*[,.]?\s*(?:qui|ciao|salve)/i,
                /ciao\s+([a-zA-Z]{2,15})/i
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    let name = match[1].trim();
                    name = name.replace(/\b(qui|ciao|salve|sono|io)\b/gi, '').trim();
                    if (name.length >= 2) return name;
                }
            }
            return null;
        }

        function extractPhoneFromText(text) {
            if (!text) return null;
            const patterns = [
                /([+]?39[\s\-]?[0-9]{3}[\s\-]?[0-9]{3}[\s\-]?[0-9]{4})/,
                /([0-9]{3}[\s\-]?[0-9]{3}[\s\-]?[0-9]{4})/,
                /([+][0-9]{1,3}[\s\-]?[0-9]{3,4}[\s\-]?[0-9]{3,4}[\s\-]?[0-9]{3,4})/
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    let phone = match[1].replace(/[\s\-\.]/g, '');
                    if (phone.length >= 8 && phone.length <= 15) {
                        return phone.startsWith('+') ? phone : '+39' + phone.replace(/^39/, '');
                    }
                }
            }
            return null;
        }

        function extractTopicFromText(text) {
            if (!text) return 'Generale';
            
            const lowerText = text.toLowerCase();
            const topics = {
                'Allenamento': ['allenamento', 'esercizi', 'workout', 'palestra', 'training', 'glutei', 'braccia', 'gambe', 'addominali'],
                'Dieta': ['dieta', 'alimentazione', 'cibo', 'nutrizione', 'mangiare', 'calorie', 'proteine', 'carboidrati'],
                'Obiettivi': ['obiettivo', 'perdere peso', 'dimagrire', 'massa', 'tonificare', 'forma', 'risultati'],
                'Consulenza': ['consulenza', 'personal', 'appuntamento', 'coach', 'prenotare', 'incontro'],
                'Salute': ['dolore', 'male', 'infortunio', 'problema', 'medico', 'fisioterapia']
            };
            
            for (const [topic, keywords] of Object.entries(topics)) {
                if (keywords.some(keyword => lowerText.includes(keyword))) {
                    return topic;
                }
            }
            
            return 'Generale';
        }

        function calculateScore(data) {
            let score = 50;
            if (data.email && data.email.length > 5) score += 15;
            if (data.name && data.name.length > 2) score += 10;
            if (data.whatsapp || data.phone) score += 20;
            if (data.goals && data.goals.length > 0) score += 5;
            return Math.min(score, 100);
        }

        function updateMetrics() {
            document.getElementById('totalConversations').textContent = conversationsData.length;
            document.getElementById('totalQuiz').textContent = quizData.length;
            
            // Conversazioni di oggi
            const today = new Date().toDateString();
            const todayConversations = conversationsData.filter(conv => 
                conv.timestamp.toDateString() === today
            ).length;
            document.getElementById('todayChats').textContent = todayConversations;
            
            // Score medio quiz
            if (quizData.length > 0) {
                const avgScore = Math.round(
                    quizData.reduce((sum, quiz) => sum + quiz.score, 0) / quizData.length
                );
                document.getElementById('avgScore').textContent = avgScore + '%';
            }
        }

        function updateStatus(type, message) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.textContent = message;
        }

        // === ACTIONS ===
        function openWhatsApp(phone) {
            if (!phone || phone === 'N/A' || phone === 'Non disponibile') {
                alert('Numero non disponibile');
                return;
            }
            const cleanPhone = phone.replace(/[^\d+]/g, '');
            window.open(`https://wa.me/${cleanPhone}`, '_blank');
        }

        function viewConversation(conversationId) {
            const conv = conversationsData.find(c => c.id === conversationId);
            if (conv) {
                alert(`Conversazione ${conversationId}\nCliente: ${conv.clientName}\nTopic: ${conv.topic}`);
            }
        }

        // === DEBUG CHATBASE ===
        async function debugChatbase() {
            updateStatus('loading', 'üîç Debug Chatbase in corso...');
            console.log('üîç Debug completo Chatbase...');
            
            try {
                // Test 1: Verifica se il chatbot esiste
                console.log('üîç Test 1: Verifica esistenza chatbot');
                const chatbotUrl = `${CHATBASE_CONFIG.apiBase}/chatbots`;
                const chatbotResponse = await fetch(chatbotUrl, {
                    headers: {
                        'Authorization': `Bearer ${CHATBASE_CONFIG.secretKey}`,
                        'Accept': 'application/json'
                    }
                });
                
                console.log('üìä Status chatbots:', chatbotResponse.status);
                if (chatbotResponse.ok) {
                    const chatbots = await chatbotResponse.json();
                    console.log('üìä I tuoi chatbots:', chatbots);
                    
                    // Verifica se il nostro chatbot √® nella lista
                    if (chatbots.data) {
                        const ourBot = chatbots.data.find(bot => bot.id === CHATBASE_CONFIG.chatbotId);
                        if (ourBot) {
                            console.log('‚úÖ Chatbot trovato:', ourBot);
                        } else {
                            console.log('‚ùå Chatbot NON trovato nella lista');
                            console.log('üìä Chatbots disponibili:', chatbots.data.map(bot => ({id: bot.id, name: bot.name})));
                        }
                    }
                } else {
                    console.log('‚ùå Errore nel recuperare chatbots:', await chatbotResponse.text());
                }
                
                // Test 2: Prova endpoint conversazioni senza parametri
                console.log('üîç Test 2: Conversazioni senza parametri');
                const convUrl1 = `${CHATBASE_CONFIG.apiBase}/get-conversations`;
                const convResponse1 = await fetch(convUrl1, {
                    headers: {
                        'Authorization': `Bearer ${CHATBASE_CONFIG.secretKey}`,
                        'Accept': 'application/json'
                    }
                });
                
                console.log('üìä Status conv senza params:', convResponse1.status);
                const convText1 = await convResponse1.text();
                console.log('üìä Response conv senza params:', convText1);
                
                // Test 3: Prova con parametri diversi
                console.log('üîç Test 3: Conversazioni con page=1&size=5');
                const convUrl2 = `${CHATBASE_CONFIG.apiBase}/get-conversations?page=1&size=5`;
                const convResponse2 = await fetch(convUrl2, {
                    headers: {
                        'Authorization': `Bearer ${CHATBASE_CONFIG.secretKey}`,
                        'Accept': 'application/json'
                    }
                });
                
                console.log('üìä Status conv con page/size:', convResponse2.status);
                const convText2 = await convResponse2.text();
                console.log('üìä Response conv con page/size:', convText2);
                
                // Test 4: Prova a inviare un messaggio di test per creare una conversazione
                console.log('üîç Test 4: Invio messaggio di test');
                const messageUrl = `${CHATBASE_CONFIG.apiBase}/chat`;
                const messagePayload = {
                    chatbotId: CHATBASE_CONFIG.chatbotId,
                    messages: [
                        { role: "user", content: "Test messaggio per dashboard" }
                    ],
                    conversationId: "dashboard-test-" + Date.now()
                };
                
                const messageResponse = await fetch(messageUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${CHATBASE_CONFIG.secretKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(messagePayload)
                });
                
                console.log('üìä Status test message:', messageResponse.status);
                const messageText = await messageResponse.text();
                console.log('üìä Response test message:', messageText);
                
                if (messageResponse.ok) {
                    console.log('‚úÖ Messaggio di test inviato! Ora prova a ricaricare le conversazioni.');
                    alert('‚úÖ Messaggio di test inviato!\nOra riprova a caricare le conversazioni.');
                }
                
                updateStatus('connected', '‚úÖ Debug completato - Controlla console per dettagli');
                
            } catch (error) {
                console.error('‚ùå Errore durante debug:', error);
                updateStatus('error', `‚ùå Errore debug: ${error.message}`);
            }
        }

        // === INIZIALIZZAZIONE ===
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('connected', '‚úÖ Dashboard pronta - Clicca i pulsanti per caricare i dati');
            console.log('üöÄ TribuCoach Dashboard inizializzata');
            console.log('üîß Configurazioni:', { 
                chatbaseConfigured: !!CHATBASE_CONFIG.secretKey,
                firebaseConfigured: !!FIREBASE_CONFIG.projectId 
            });
        });
    </script>
</body>
</html>