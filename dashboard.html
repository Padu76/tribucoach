<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TribuCoach Dashboard - Business Intelligence</title>

  <!-- Firebase SDK v9 modular -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getFirestore, collection, getDocs, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDSsQEPii_Eb99cWGs7eqozgTtIqbtO2rs",
      authDomain: "tribucoach-a2254.firebaseapp.com",
      projectId: "tribucoach-a2254",
      storageBucket: "tribucoach-a2254.firebasestorage.app",
      messagingSenderId: "425200296836",
      appId: "1:425200296836:web:7835188f40f4348567ab48"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let leadsData = [];
    let chatsData = [];

    async function loadQuizResults() {
      try {
        console.log('📊 Caricamento quiz results...');
        const q = query(collection(db, 'quiz_results'), orderBy('timestamp', 'desc'), limit(50));
        const querySnapshot = await getDocs(q);

        leadsData = [];
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          leadsData.push({
            id: doc.id,
            name: data.name || data.userName || 'Nome non disponibile',
            email: data.email || data.userEmail || 'Non disponibile',
            phone: data.whatsapp || data.userWhatsApp || data.phone || 'Non disponibile',
            age: data.age || data.userAge || 'N/A',
            gender: data.gender || data.userGender || 'N/A',
            score: data.score || data.fitnessScore || calculateScore(data),
            profile: data.fitnessPersonality || data.profile || 'Non specificato',
            goals: extractArray(data.goals || data.fitnessGoals),
            obstacles: extractArray(data.obstacles || data.challenges),
            budget: data.budget || 'Non specificato',
            timestamp: data.timestamp?.toDate() || new Date(),
            source: 'Firebase'
          });
        });
        console.log(`📊 Caricati ${leadsData.length} lead da Firebase`);
        return leadsData;
      } catch (error) {
        console.error('❌ Errore caricamento quiz:', error);
        return [];
      }
    }
    async function loadConversations() {
      try {
        console.log('💬 Caricamento conversazioni...');
        const collections = ['chatbase_conversations', 'conversations', 'chatbot_conversations', 'chats'];

        for (const collectionName of collections) {
          try {
            const q = query(collection(db, collectionName), limit(30));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.size > 0) {
              chatsData = [];
              querySnapshot.forEach((doc) => {
                const data = doc.data();
                chatsData.push({
                  id: doc.id,
                  clientName: data.customerName || extractNameFromMessages(data.messages) || 'Cliente Anonimo',
                  phone: data.phone || data.customerPhone || extractPhoneFromMessages(data.messages) || 'N/A',
                  email: data.customerEmail || 'N/A',
                  topic: data.topic || 'Conversazione generale',
                  lastMessage: getLastMessage(data.messages),
                  timestamp: data.timestamp?.toDate() || data.lastActivity?.toDate() || data.lastMessageAt?.toDate() || new Date(),
                  source: collectionName === 'chatbase_conversations' ? 'Chatbase' : 'Firebase'
                });
              });
              console.log(`💬 Caricate ${chatsData.length} conversazioni da ${collectionName}`);
              break;
            }
          } catch (e) {
            console.log(`Collection ${collectionName} non trovata`);
          }
        }

        return chatsData;
      } catch (error) {
        console.error('❌ Errore caricamento conversazioni:', error);
        return [];
      }
    }

    function calculateScore(data) {
      let score = 50;
      if (data.email && data.email.length > 5) score += 15;
      if (data.name && data.name.length > 2) score += 10;
      if (data.whatsapp || data.phone) score += 20;
      if (data.goals && data.goals.length > 0) score += 5;
      return Math.min(score, 100);
    }

    function extractArray(value) {
      if (Array.isArray(value)) return value;
      if (typeof value === 'string') return value.split(',').map(v => v.trim());
      return ['Non specificato'];
    }

    function extractNameFromMessages(messages) {
      if (!messages) return null;
      for (const msg of messages) {
        if (msg.role === 'user' && msg.content) {
          const match = msg.content.match(/(?:mi chiamo|sono)\s+([a-zA-Z\s]{2,20})/i);
          if (match) return match[1].trim();
        }
      }
      return null;
    }

    function extractPhoneFromMessages(messages) {
      if (!messages) return null;
      for (const msg of messages) {
        if (msg.role === 'user' && msg.content) {
          const match = msg.content.match(/([0-9]{3}\s?[0-9]{3}\s?[0-9]{4})/);
          if (match) return '+39 ' + match[1].replace(/\s/g, '');
        }
      }
      return null;
    }

    function getLastMessage(messages) {
      if (messages && messages.length > 0) {
        const lastMsg = messages[messages.length - 1];
        return lastMsg.content || lastMsg.message || 'Nessun contenuto';
      }
      return 'Nessun messaggio';
    }

    async function loadAllData() {
      try {
        updateStatus('loading', '📊 Caricamento dati da Firebase...');
        await Promise.all([
          loadQuizResults(),
          loadConversations()
        ]);
        updateMetrics();
        renderLeads();
        renderChats();
        updateCharts();
        updateInsights();
        updateStatus('connected', '✅ Dati caricati da Firebase');
        console.log('✅ Tutti i dati caricati con successo');
      } catch (error) {
        console.error('❌ Errore caricamento dati:', error);
        updateStatus('error', '❌ Errore caricamento dati');
      }
    }
    function updateStatus(type, message) {
      const statusEl = document.getElementById('connectionStatus');
      statusEl.className = `connection-status ${type}`;
      statusEl.textContent = message;
    }

    function updateMetrics() {
      const totalLeads = leadsData.length;
      const avgScore = totalLeads > 0 ? 
          Math.round(leadsData.reduce((sum, lead) => sum + (lead.score || 0), 0) / totalLeads) : 0;
      const totalChats = chatsData.length;
      const premiumLeads = leadsData.filter(lead => (lead.score || 0) > 80).length;

      document.getElementById('totalLeads').textContent = totalLeads;
      document.getElementById('avgScore').textContent = avgScore + '%';
      document.getElementById('totalChats').textContent = totalChats;
      document.getElementById('premiumLeads').textContent = premiumLeads;
    }

    function renderLeads() {
      const container = document.getElementById('leadsContainer');

      if (leadsData.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="icon">📭</div>
            <p>Nessun lead trovato</p>
            <small>I lead appariranno qui quando completati i quiz</small>
          </div>
        `;
        return;
      }

      const html = leadsData.slice(0, 8).map(lead => {
        const scoreClass = lead.score > 80 ? 'score-high' : lead.score >= 60 ? 'score-medium' : 'score-low';

        return `
          <div class="lead-card">
            <div class="lead-header">
              <div>
                <div class="lead-name">${lead.name}</div>
                <div class="lead-profile">${lead.profile}</div>
              </div>
              <div class="lead-score ${scoreClass}">${lead.score}%</div>
            </div>
            <div class="lead-details">
              <div class="detail-row">
                <span class="label">📧 Email:</span>
                <span class="value">${lead.email}</span>
              </div>
              <div class="detail-row">
                <span class="label">📱 Phone:</span>
                <span class="value">${lead.phone}</span>
              </div>
              <div class="detail-row">
                <span class="label">🎯 Goals:</span>
                <span class="value">${lead.goals.join(', ')}</span>
              </div>
              <div class="detail-row">
                <span class="label">📅 Data:</span>
                <span class="value">${lead.timestamp.toLocaleDateString('it-IT')}</span>
              </div>
            </div>
            <div class="lead-actions">
              ${lead.phone !== 'Non disponibile' && lead.phone !== 'N/A' ? 
                `<button class="btn whatsapp" onclick="openWhatsApp('${lead.phone}')">📱 WhatsApp</button>` : ''}
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    function renderChats() {
      const container = document.getElementById('chatsContainer');

      if (chatsData.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="icon">💬</div>
            <p>Nessuna conversazione trovata</p>
            <small>Le conversazioni appariranno qui</small>
          </div>
        `;
        return;
      }

      const html = chatsData.slice(0, 6).map(chat => {
        const preview = chat.lastMessage.length > 60 ? 
          chat.lastMessage.substring(0, 60) + '...' : 
          chat.lastMessage;

        return `
          <div class="chat-card">
            <div class="chat-header">
              <div class="chat-client">${chat.clientName}</div>
              <div class="chat-topic">${chat.topic}</div>
              <div class="chat-source">🔗 ${chat.source}</div>
            </div>
            <div class="chat-preview">"${preview}"</div>
            <div class="chat-meta">
              <span>📱 ${chat.phone}</span>
              <span>📅 ${chat.timestamp.toLocaleDateString('it-IT')}</span>
            </div>
            <div class="chat-actions">
              ${chat.phone !== 'N/A' ? 
                `<button class="btn whatsapp" onclick="openWhatsApp('${chat.phone}')">📱 WhatsApp</button>` : ''}
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = html;
    }

    window.openWhatsApp = function(phone) {
      if (!phone || phone === 'N/A') {
        alert('Numero non disponibile');
        return;
      }
      const cleanPhone = phone.replace(/[^\d+]/g, '');
      window.open(`https://wa.me/${cleanPhone}`, '_blank');
    };

    window.refreshData = async function() {
      await loadAllData();
    };

    async function init() {
      console.log('🚀 Inizializzazione TribuCoach Dashboard...');
      updateStatus('loading', '🔄 Connessione a Firebase...');
      try {
        await loadAllData();
        setInterval(() => {
          document.getElementById('currentTime').textContent = 
            new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
        }, 60000);
      } catch (error) {
        console.error('❌ Errore inizializzazione:', error);
        updateStatus('error', '❌ Errore connessione Firebase');
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>

  <style>
    /* ... [mantieni qui il tuo CSS attuale senza modifiche] ... */
  </style>
</head>
<body>
  <div class="connection-status loading" id="connectionStatus">
    🔄 Connessione a Firebase in corso...
  </div>

  <!-- Il resto dell'HTML delle metriche, sezioni leads, chats, analytics ecc. rimane invariato come nel tuo file -->
  <!-- Incluso tutto il layout e i container con gli ID: leadsContainer, chatsContainer, ecc. -->
</body>
</html>
