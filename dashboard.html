<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TribuCoach Business Intelligence Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #2a2a2a 100%);
            color: #fff;
            min-height: 100vh;
            line-height: 1.4;
        }

        .connection-status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 0.8rem;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .connection-status.loading {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
        }

        .connection-status.error {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .header {
            background: linear-gradient(135deg, rgba(255,102,0,0.15), rgba(255,102,0,0.05));
            padding: 25px;
            border-bottom: 3px solid #ff6600;
            backdrop-filter: blur(20px);
            margin-top: 40px;
        }

        .header h1 {
            color: #ff6600;
            font-size: 2.2rem;
            margin-bottom: 8px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(255,102,0,0.3);
        }

        .header p {
            color: #ccc;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard {
            padding: 30px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .filters-bar {
            background: linear-gradient(135deg, #2a2a2a 0%, #333333 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid #404040;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-group label {
            color: #ff9933;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .filter-select, .filter-input {
            background: #1a1a1a;
            border: 1px solid #ff6600;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #ff9933;
            box-shadow: 0 0 5px rgba(255, 102, 0, 0.3);
        }

        .btn {
            background: linear-gradient(135deg, #ff6600, #ff8533);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s ease;
            margin: 2px;
        }

        .btn:hover {
            background: linear-gradient(135deg, #ff8533, #ffaa66);
            transform: translateY(-1px);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #2196F3, #1976D2);
        }

        .btn.secondary:hover {
            background: linear-gradient(135deg, #1976D2, #1565C0);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }

        .metric-card {
            background: linear-gradient(135deg, #2a2a2a 0%, #333333 100%);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border: 1px solid #404040;
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6600, #ff9933);
        }

        .metric-card:hover {
            transform: translateY(-3px);
        }

        .metric-card h3 {
            color: #ff9933;
            font-size: 1.1rem;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .metric-card p {
            font-size: 2.8rem;
            font-weight: 800;
            color: #fff;
        }

        .metric-trend {
            font-size: 0.8rem;
            margin-top: 10px;
            opacity: 0.8;
        }

        .trend-up { color: #4CAF50; }
        .trend-down { color: #f44336; }

        .section {
            background: linear-gradient(135deg, #2a2a2a 0%, #333333 100%);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            margin-bottom: 35px;
            border: 1px solid #404040;
            position: relative;
            overflow: hidden;
        }

        .section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ff6600, #ff9933, #ff6600);
        }

        .section h2 {
            color: #ff6600;
            font-size: 1.9rem;
            margin-bottom: 25px;
            border-bottom: 2px solid #444;
            padding-bottom: 15px;
            font-weight: 700;
        }

        .section-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }

        .item-card {
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            border: 1px solid #444;
            border-radius: 12px;
            padding: 25px;
            border-left: 5px solid #ff6600;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 102, 0, 0.2);
        }

        .item-card.chat {
            border-left-color: #2196F3;
        }

        .item-card.chat:hover {
            box-shadow: 0 10px 30px rgba(33, 150, 243, 0.2);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .item-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ff6600;
            margin-bottom: 5px;
        }

        .item-card.chat .item-name {
            color: #2196F3;
        }

        .item-profile, .item-topic {
            background: rgba(255, 102, 0, 0.2);
            color: #ff9933;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .item-card.chat .item-topic {
            background: rgba(33, 150, 243, 0.2);
            color: #64B5F6;
        }

        .item-score {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1rem;
        }

        .score-high { background: #4CAF50; color: white; }
        .score-medium { background: #ff9800; color: white; }
        .score-low { background: #f44336; color: white; }

        .item-details {
            margin: 15px 0;
        }

        .detail-row {
            display: flex;
            margin: 8px 0;
            align-items: center;
        }

        .detail-row .label {
            color: #ff9933;
            font-weight: 600;
            min-width: 80px;
            font-size: 0.9rem;
        }

        .detail-row .value {
            color: #eee;
            font-size: 0.9rem;
            margin-left: 10px;
            flex: 1;
        }

        .item-preview {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #ccc;
            font-style: italic;
            border-left: 3px solid #ff6600;
        }

        .item-card.chat .item-preview {
            border-left-color: #2196F3;
        }

        .item-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn.whatsapp {
            background: linear-gradient(135deg, #25D366, #20b055);
        }

        .btn.whatsapp:hover {
            background: linear-gradient(135deg, #20b055, #1ea049);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #2a2a2a 0%, #333333 100%);
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #404040;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #ff6600;
        }

        .modal h3 {
            color: #ff6600;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .message-thread {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
        }

        .message.user {
            background: #1976D2;
            color: white;
            margin-left: 20px;
        }

        .message.assistant {
            background: #424242;
            color: #eee;
            margin-right: 20px;
        }

        .message-role {
            font-weight: bold;
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .insights-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .insight-card {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #ff6600;
        }

        .insight-card h4 {
            color: #ff9933;
            margin-bottom: 10px;
        }

        .chart-container {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        @media (max-width: 768px) {
            .dashboard { padding: 20px 15px; }
            .items-grid { grid-template-columns: 1fr; }
            .metrics-grid { grid-template-columns: 1fr; }
            .filters-bar { flex-direction: column; align-items: stretch; }
            .section-controls { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <div class="connection-status loading" id="connectionStatus">
        üîÑ Connessione a Firebase in corso...
    </div>

    <header class="header">
        <h1>üìà TribuCoach Business Intelligence</h1>
        <p>Dashboard completa per monitoraggio lead, conversioni e performance business in tempo reale</p>
    </header>

    <div class="dashboard">
        <!-- FILTRI GLOBALI -->
        <div class="filters-bar">
            <div class="filter-group">
                <label for="timeFilter">üìÖ Periodo:</label>
                <select id="timeFilter" class="filter-select" onchange="applyFilters()">
                    <option value="all">Tutti</option>
                    <option value="today">Oggi</option>
                    <option value="week">Questa settimana</option>
                    <option value="month">Questo mese</option>
                    <option value="custom">Personalizzato</option>
                </select>
            </div>
            
            <div class="filter-group" id="customDateRange" style="display: none;">
                <input type="date" id="startDate" class="filter-input">
                <span style="color: #ccc;">-</span>
                <input type="date" id="endDate" class="filter-input">
            </div>
            
            <div class="filter-group">
                <label for="typeFilter">üìä Tipo:</label>
                <select id="typeFilter" class="filter-select" onchange="applyFilters()">
                    <option value="all">Tutti</option>
                    <option value="quiz">Solo Quiz</option>
                    <option value="conversations">Solo Chat</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="topicFilter">üè∑Ô∏è Argomento:</label>
                <select id="topicFilter" class="filter-select" onchange="applyFilters()">
                    <option value="all">Tutti</option>
                    <option value="Allenamento">Allenamento</option>
                    <option value="Dieta">Dieta</option>
                    <option value="Obiettivi">Obiettivi</option>
                    <option value="Consulenza">Consulenza</option>
                </select>
            </div>
            
            <button class="btn" onclick="resetFilters()">üîÑ Reset</button>
            <button class="btn secondary" onclick="exportData()">üìä Export Excel</button>
        </div>

        <!-- METRICHE PRINCIPALI -->
        <div class="metrics-grid">
            <div class="metric-card">
                <h3>üéØ Lead Totali</h3>
                <p id="totalLeads">0</p>
                <div class="metric-trend" id="leadsTrend"></div>
            </div>
            <div class="metric-card">
                <h3>üí¨ Conversazioni</h3>
                <p id="totalConversations">0</p>
                <div class="metric-trend" id="conversationsTrend"></div>
            </div>
            <div class="metric-card">
                <h3>‚≠ê Score Medio</h3>
                <p id="avgScore">0%</p>
                <div class="metric-trend" id="scoreTrend"></div>
            </div>
            <div class="metric-card">
                <h3>üî• Lead Premium</h3>
                <p id="premiumLeads">0</p>
                <div class="metric-trend" id="premiumTrend"></div>
            </div>
        </div>

        <!-- CONVERSAZIONI -->
        <div class="section">
            <div class="section-controls">
                <h2>üí¨ Conversazioni Chatbase</h2>
                <div>
                    <button class="btn" onclick="loadAllData()">üîÑ Aggiorna</button>
                    <button class="btn secondary" onclick="showInsights('conversations')">üìä Insights</button>
                </div>
            </div>
            <div class="items-grid" id="conversationsContainer">
                <div class="empty-state">
                    <div class="icon">üí¨</div>
                    <p>Caricamento conversazioni...</p>
                </div>
            </div>
        </div>

        <!-- QUIZ LEADS -->
        <div class="section">
            <div class="section-controls">
                <h2>ü•á Lead da Quiz</h2>
                <div>
                    <button class="btn" onclick="loadAllData()">üîÑ Aggiorna</button>
                    <button class="btn secondary" onclick="showInsights('quiz')">üìä Insights</button>
                </div>
            </div>
            <div class="items-grid" id="quizContainer">
                <div class="empty-state">
                    <div class="icon">üìä</div>
                    <p>Caricamento quiz...</p>
                </div>
            </div>
        </div>

        <!-- INSIGHTS E REPORTISTICA -->
        <div class="section">
            <h2>üí° Insights & Analytics</h2>
            <div class="insights-container" id="insightsContainer">
                <div class="insight-card">
                    <h4>üìä Caricamento insights...</h4>
                    <p>Analisi in corso...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DETTAGLI -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modalContent">
                <!-- Contenuto dinamico -->
            </div>
        </div>
    </div>

    <script>
        // Configurazione Firebase
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDSsQEPii_Eb99cWGs7eqozgTtIqbtO2rs",
            authDomain: "tribucoach-a2254.firebaseapp.com",
            projectId: "tribucoach-a2254",
            storageBucket: "tribucoach-a2254.firebasestorage.app",
            messagingSenderId: "425200296836",
            appId: "1:425200296836:web:7835188f40f4348567ab48"
        };

        // Inizializza Firebase
        firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.firestore();

        // Variabili globali
        let allConversations = [];
        let allQuizResults = [];
        let filteredConversations = [];
        let filteredQuizResults = [];
        let currentFilters = {
            time: 'all',
            type: 'all',
            topic: 'all',
            startDate: null,
            endDate: null
        };

        // === CARICAMENTO DATI ===
        async function loadAllData() {
            updateStatus('loading', 'üìä Caricamento dati da Firebase...');
            
            try {
                await Promise.all([
                    loadConversations(),
                    loadQuizResults()
                ]);
                
                applyFilters();
                updateMetrics();
                generateInsights();
                updateStatus('connected', '‚úÖ Dati caricati e aggiornati');
                
            } catch (error) {
                console.error('‚ùå Errore caricamento:', error);
                updateStatus('error', '‚ùå Errore nel caricamento dati');
            }
        }

        async function loadConversations() {
            try {
                console.log('üí¨ Caricando conversazioni...');
                const querySnapshot = await db.collection('conversations').orderBy('lastMessageAt', 'desc').get();
                
                allConversations = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const userMessages = data.messages?.filter(msg => msg.role === 'user') || [];
                    const firstUserMessage = userMessages[0]?.message || '';
                    const lastUserMessage = userMessages[userMessages.length - 1]?.message || firstUserMessage;
                    
                    allConversations.push({
                        id: doc.id,
                        clientName: extractNameFromText(firstUserMessage) || 'Cliente Anonimo',
                        phone: extractPhoneFromText(firstUserMessage + ' ' + lastUserMessage) || 'N/A',
                        topic: extractTopicFromText(firstUserMessage + ' ' + lastUserMessage),
                        lastMessage: lastUserMessage || 'Nessun messaggio',
                        timestamp: data.lastMessageAt?.toDate() || data.dateCreated?.toDate() || new Date(),
                        messagesCount: data.messages?.length || 0,
                        messages: data.messages || [],
                        source: 'Firebase',
                        chatbaseId: data.chatbaseId
                    });
                });
                
                console.log(`üí¨ Caricate ${allConversations.length} conversazioni`);
            } catch (error) {
                console.error('‚ùå Errore caricamento conversazioni:', error);
            }
        }

        async function loadQuizResults() {
            try {
                console.log('üìä Caricando quiz...');
                const querySnapshot = await db.collection('quiz_results').orderBy('timestamp', 'desc').get();
                
                allQuizResults = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    allQuizResults.push({
                        id: doc.id,
                        name: data.name || data.userName || 'Nome non disponibile',
                        email: data.email || data.userEmail || 'Non disponibile',
                        phone: data.whatsapp || data.phone || 'N/A',
                        score: data.score || calculateScore(data),
                        profile: data.fitnessPersonality || data.profile || 'Non specificato',
                        goals: data.goals || data.fitnessGoals || [],
                        obstacles: data.obstacles || data.challenges || [],
                        timestamp: data.timestamp?.toDate() || new Date(),
                        rawData: data
                    });
                });
                
                console.log(`üìä Caricati ${allQuizResults.length} quiz`);
            } catch (error) {
                console.error('‚ùå Errore caricamento quiz:', error);
            }
        }

        // === FILTRI ===
        function applyFilters() {
            const timeFilter = document.getElementById('timeFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const topicFilter = document.getElementById('topicFilter').value;
            
            currentFilters.time = timeFilter;
            currentFilters.type = typeFilter;
            currentFilters.topic = topicFilter;
            
            // Gestione date personalizzate
            if (timeFilter === 'custom') {
                document.getElementById('customDateRange').style.display = 'flex';
                currentFilters.startDate = document.getElementById('startDate').value;
                currentFilters.endDate = document.getElementById('endDate').value;
            } else {
                document.getElementById('customDateRange').style.display = 'none';
            }
            
            // Applica filtri temporali
            const now = new Date();
            let startDate = null;
            
            switch(timeFilter) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'custom':
                    if (currentFilters.startDate) {
                        startDate = new Date(currentFilters.startDate);
                    }
                    break;
            }
            
            // Filtra conversazioni
            filteredConversations = allConversations.filter(conv => {
                if (typeFilter !== 'all' && typeFilter !== 'conversations') return false;
                if (topicFilter !== 'all' && conv.topic !== topicFilter) return false;
                if (startDate && conv.timestamp < startDate) return false;
                if (currentFilters.endDate && conv.timestamp > new Date(currentFilters.endDate)) return false;
                return true;
            });
            
            // Filtra quiz
            filteredQuizResults = allQuizResults.filter(quiz => {
                if (typeFilter !== 'all' && typeFilter !== 'quiz') return false;
                if (startDate && quiz.timestamp < startDate) return false;
                if (currentFilters.endDate && quiz.timestamp > new Date(currentFilters.endDate)) return false;
                return true;
            });
            
            renderConversations();
            renderQuizResults();
            updateMetrics();
        }

        function resetFilters() {
            document.getElementById('timeFilter').value = 'all';
            document.getElementById('typeFilter').value = 'all';
            document.getElementById('topicFilter').value = 'all';
            document.getElementById('customDateRange').style.display = 'none';
            applyFilters();
        }

        // === RENDERING ===
        function renderConversations() {
            const container = document.getElementById('conversationsContainer');
            
            if (filteredConversations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üí¨</div>
                        <p>Nessuna conversazione trovata con i filtri applicati</p>
                    </div>
                `;
                return;
            }

            const html = filteredConversations.map(conv => `
                <div class="item-card chat" onclick="showConversationDetails('${conv.id}')">
                    <div class="item-header">
                        <div>
                            <div class="item-name">${conv.clientName}</div>
                            <div class="item-topic">${conv.topic}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.8rem; color: #aaa;">${formatDateTime(conv.timestamp)}</div>
                            <div style="font-size: 0.8rem; color: #64B5F6;">${conv.messagesCount} messaggi</div>
                        </div>
                    </div>
                    
                    <div class="item-preview">"${conv.lastMessage.substring(0, 150)}${conv.lastMessage.length > 150 ? '...' : ''}"</div>
                    
                    <div class="item-details">
                        <div class="detail-row">
                            <span class="label">üì± Phone:</span>
                            <span class="value">${conv.phone}</span>
                        </div>
                        <div class="detail-row">
                            <span class="label">üÜî ID:</span>
                            <span class="value">${conv.chatbaseId || conv.id}</span>
                        </div>
                    </div>
                    
                    <div class="item-actions">
                        ${conv.phone !== 'N/A' ? 
                            `<button class="btn whatsapp" onclick="event.stopPropagation(); openWhatsApp('${conv.phone}')">üì± WhatsApp</button>` : ''
                        }
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function renderQuizResults() {
            const container = document.getElementById('quizContainer');
            
            if (filteredQuizResults.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìä</div>
                        <p>Nessun quiz trovato con i filtri applicati</p>
                    </div>
                `;
                return;
            }

            const html = filteredQuizResults.map(quiz => {
                const scoreClass = quiz.score > 80 ? 'score-high' : quiz.score >= 60 ? 'score-medium' : 'score-low';
                return `
                    <div class="item-card" onclick="showQuizDetails('${quiz.id}')">
                        <div class="item-header">
                            <div>
                                <div class="item-name">${quiz.name}</div>
                                <div class="item-profile">${quiz.profile}</div>
                            </div>
                            <div class="item-score ${scoreClass}">${quiz.score}%</div>
                        </div>
                        
                        <div class="item-details">
                            <div class="detail-row">
                                <span class="label">üìß Email:</span>
                                <span class="value">${quiz.email}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">üì± Phone:</span>
                                <span class="value">${quiz.phone}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">üéØ Obiettivi:</span>
                                <span class="value">${Array.isArray(quiz.goals) ? quiz.goals.slice(0,2).join(', ') : 'Non specificati'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">üìÖ Data:</span>
                                <span class="value">${formatDateTime(quiz.timestamp)}</span>
                            </div>
                        </div>
                        
                        <div class="item-actions">
                            ${quiz.phone !== 'N/A' && quiz.phone !== 'Non disponibile' ? 
                                `<button class="btn whatsapp" onclick="event.stopPropagation(); openWhatsApp('${quiz.phone}')">üì± WhatsApp</button>` : ''
                            }
                            <button class="btn secondary" onclick="event.stopPropagation(); showQuizDetails('${quiz.id}')">üëÅÔ∏è Dettagli</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // === METRICHE ===
        function updateMetrics() {
            const totalLeads = filteredQuizResults.length;
            const totalConversations = filteredConversations.length;
            const avgScore = totalLeads > 0 ? 
                Math.round(filteredQuizResults.reduce((sum, quiz) => sum + quiz.score, 0) / totalLeads) : 0;
            const premiumLeads = filteredQuizResults.filter(quiz => quiz.score > 80).length;

            document.getElementById('totalLeads').textContent = totalLeads;
            document.getElementById('totalConversations').textContent = totalConversations;
            document.getElementById('avgScore').textContent = avgScore + '%';
            document.getElementById('premiumLeads').textContent = premiumLeads;

            // Calcola trends (confronto con periodo precedente)
            updateTrends();
        }

        function updateTrends() {
            // Logica per calcolare trends
            const now = new Date();
            let previousPeriodStart, currentPeriodStart;
            
            switch(currentFilters.time) {
                case 'today':
                    currentPeriodStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    previousPeriodStart = new Date(currentPeriodStart.getTime() - 24*60*60*1000);
                    break;
                case 'week':
                    currentPeriodStart = new Date(now.getTime() - 7*24*60*60*1000);
                    previousPeriodStart = new Date(currentPeriodStart.getTime() - 7*24*60*60*1000);
                    break;
                case 'month':
                    currentPeriodStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    previousPeriodStart = new Date(now.getFullYear(), now.getMonth()-1, 1);
                    break;
                default:
                    return; // Non mostrare trend per "tutti"
            }
            
            const previousQuiz = allQuizResults.filter(quiz => 
                quiz.timestamp >= previousPeriodStart && quiz.timestamp < currentPeriodStart
            );
            const previousConv = allConversations.filter(conv => 
                conv.timestamp >= previousPeriodStart && conv.timestamp < currentPeriodStart
            );
            
            const currentQuiz = filteredQuizResults.length;
            const currentConv = filteredConversations.length;
            
            updateTrendDisplay('leadsTrend', currentQuiz, previousQuiz.length);
            updateTrendDisplay('conversationsTrend', currentConv, previousConv.length);
        }

        function updateTrendDisplay(elementId, current, previous) {
            const element = document.getElementById(elementId);
            if (previous === 0) {
                element.innerHTML = '';
                return;
            }
            
            const change = ((current - previous) / previous * 100).toFixed(1);
            const isPositive = change >= 0;
            const arrow = isPositive ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è';
            const className = isPositive ? 'trend-up' : 'trend-down';
            
            element.innerHTML = `<span class="${className}">${arrow} ${Math.abs(change)}%</span>`;
        }

        // === DETTAGLI MODALI ===
        function showConversationDetails(conversationId) {
            const conversation = allConversations.find(c => c.id === conversationId);
            if (!conversation) return;
            
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <h3>üí¨ Dettagli Conversazione</h3>
                
                <div class="item-details" style="margin-bottom: 20px;">
                    <div class="detail-row">
                        <span class="label">üë§ Cliente:</span>
                        <span class="value">${conversation.clientName}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">üì± Telefono:</span>
                        <span class="value">${conversation.phone}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">üè∑Ô∏è Argomento:</span>
                        <span class="value">${conversation.topic}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">üìÖ Data:</span>
                        <span class="value">${formatDateTime(conversation.timestamp)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">üí¨ Messaggi:</span>
                        <span class="value">${conversation.messagesCount}</span>
                    </div>
                </div>
                
                <h4 style="color: #ff9933; margin-bottom: 15px;">üìã Thread Conversazione</h4>
                <div class="message-thread">
                    ${conversation.messages.map(msg => `
                        <div class="message ${msg.role}">
                            <div class="message-role">${msg.role === 'user' ? 'üë§ Utente' : 'ü§ñ Assistant'}</div>
                            <div>${msg.message || msg.content || 'Messaggio vuoto'}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="item-actions" style="margin-top: 20px;">
                    ${conversation.phone !== 'N/A' ? 
                        `<button class="btn whatsapp" onclick="openWhatsApp('${conversation.phone}')">üì± Contatta WhatsApp</button>` : ''
                    }
                    <button class="btn secondary" onclick="copyConversation('${conversationId}')">üìã Copia Testo</button>
                </div>
            `;
            
            document.getElementById('detailModal').style.display = 'block';
        }

        function showQuizDetails(quizId) {
            const quiz = allQuizResults.find(q => q.id === quizId);
            if (!quiz) return;
            
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <h3>üìä Dettagli Quiz Lead</h3>
                
                <div class="item-details" style="margin-bottom: 20px;">
                    <div class="detail-row">
                        <span class="label">üë§ Nome:</span>
                        <span class="value">${quiz.name}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">üìß Email:</span>
                        <span class="value">${quiz.email}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">üì± Telefono:</span>
                        <span class="value">${quiz.phone}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">‚≠ê Lead Score:</span>
                        <span class="value">${quiz.score}%</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">üë§ Profilo:</span>
                        <span class="value">${quiz.profile}</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">üìÖ Data:</span>
                        <span class="value">${formatDateTime(quiz.timestamp)}</span>
                    </div>
                </div>
                
                <h4 style="color: #ff9933; margin-bottom: 15px;">üéØ Obiettivi</h4>
                <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    ${Array.isArray(quiz.goals) && quiz.goals.length > 0 ? 
                        quiz.goals.map(goal => `<div>‚Ä¢ ${goal}</div>`).join('') : 
                        'Obiettivi non specificati'
                    }
                </div>
                
                <h4 style="color: #ff9933; margin-bottom: 15px;">‚ö†Ô∏è Ostacoli</h4>
                <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    ${Array.isArray(quiz.obstacles) && quiz.obstacles.length > 0 ? 
                        quiz.obstacles.map(obstacle => `<div>‚Ä¢ ${obstacle}</div>`).join('') : 
                        'Ostacoli non specificati'
                    }
                </div>
                
                <h4 style="color: #ff9933; margin-bottom: 15px;">üìã Dati Completi</h4>
                <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.8rem; max-height: 200px; overflow-y: auto;">
                    ${JSON.stringify(quiz.rawData, null, 2)}
                </div>
                
                <div class="item-actions" style="margin-top: 20px;">
                    ${quiz.phone !== 'N/A' && quiz.phone !== 'Non disponibile' ? 
                        `<button class="btn whatsapp" onclick="openWhatsApp('${quiz.phone}')">üì± Contatta WhatsApp</button>` : ''
                    }
                    <button class="btn secondary" onclick="copyQuizData('${quizId}')">üìã Copia Dati</button>
                </div>
            `;
            
            document.getElementById('detailModal').style.display = 'block';
        }

        // === INSIGHTS ===
        function generateInsights() {
            const container = document.getElementById('insightsContainer');
            
            // Analisi topic pi√π popolari
            const topicCounts = {};
            filteredConversations.forEach(conv => {
                topicCounts[conv.topic] = (topicCounts[conv.topic] || 0) + 1;
            });
            
            // Analisi profili quiz
            const profileCounts = {};
            filteredQuizResults.forEach(quiz => {
                profileCounts[quiz.profile] = (profileCounts[quiz.profile] || 0) + 1;
            });
            
            // Lead scoring distribution
            const scoreRanges = {
                'Alto (80-100%)': filteredQuizResults.filter(q => q.score >= 80).length,
                'Medio (60-79%)': filteredQuizResults.filter(q => q.score >= 60 && q.score < 80).length,
                'Basso (<60%)': filteredQuizResults.filter(q => q.score < 60).length
            };
            
            // Analisi temporale
            const now = new Date();
            const last7Days = filteredConversations.filter(conv => 
                conv.timestamp > new Date(now.getTime() - 7*24*60*60*1000)
            ).length;
            
            const conversionRate = filteredQuizResults.length > 0 && filteredConversations.length > 0 ?
                ((filteredQuizResults.filter(q => q.score >= 70).length / filteredQuizResults.length) * 100).toFixed(1) :
                0;
            
            container.innerHTML = `
                <div class="insight-card">
                    <h4>üî• Topic Pi√π Richiesti</h4>
                    ${Object.entries(topicCounts).sort((a,b) => b[1] - a[1]).slice(0,3).map(([topic, count]) => 
                        `<div>${topic}: <strong>${count} conversazioni</strong></div>`
                    ).join('')}
                </div>
                
                <div class="insight-card">
                    <h4>üë• Profili Lead</h4>
                    ${Object.entries(profileCounts).sort((a,b) => b[1] - a[1]).slice(0,3).map(([profile, count]) => 
                        `<div>${profile}: <strong>${count} lead</strong></div>`
                    ).join('')}
                </div>
                
                <div class="insight-card">
                    <h4>‚≠ê Distribuzione Score</h4>
                    ${Object.entries(scoreRanges).map(([range, count]) => 
                        `<div>${range}: <strong>${count} lead</strong></div>`
                    ).join('')}
                </div>
                
                <div class="insight-card">
                    <h4>üìà Performance</h4>
                    <div>Conversazioni ultimi 7gg: <strong>${last7Days}</strong></div>
                    <div>Conversion Rate: <strong>${conversionRate}%</strong></div>
                    <div>Lead con contatto: <strong>${filteredQuizResults.filter(q => q.phone !== 'N/A').length}</strong></div>
                </div>
                
                <div class="insight-card">
                    <h4>üéØ Raccomandazioni</h4>
                    ${generateRecommendations()}
                </div>
            `;
        }

        function generateRecommendations() {
            const recommendations = [];
            const highScoreLeads = filteredQuizResults.filter(q => q.score >= 80);
            const noContactLeads = filteredQuizResults.filter(q => q.phone === 'N/A' || q.phone === 'Non disponibile');
            const recentConversations = filteredConversations.filter(c => 
                c.timestamp > new Date(Date.now() - 24*60*60*1000)
            );
            
            if (highScoreLeads.length > 0) {
                recommendations.push(`üî• ${highScoreLeads.length} lead premium da contattare urgentemente`);
            }
            
            if (noContactLeads.length > 5) {
                recommendations.push(`üìû ${noContactLeads.length} lead senza contatto - migliorare acquisizione telefono`);
            }
            
            if (recentConversations.length > 0) {
                recommendations.push(`‚ö° ${recentConversations.length} nuove conversazioni richiedono follow-up`);
            }
            
            if (recommendations.length === 0) {
                recommendations.push('‚úÖ Tutto sotto controllo! Continue cos√¨');
            }
            
            return recommendations.map(rec => `<div>‚Ä¢ ${rec}</div>`).join('');
        }

        // === UTILITY FUNCTIONS ===
        function extractNameFromText(text) {
            if (!text) return null;
            const patterns = [
                /(?:mi chiamo|sono|il mio nome √®)\s+([a-zA-Z\s]{2,20})/i,
                /^([a-zA-Z]{2,15})\s*[,.]?\s*(?:qui|ciao|salve)/i,
                /ciao\s+([a-zA-Z]{2,15})/i
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    let name = match[1].trim();
                    name = name.replace(/\b(qui|ciao|salve|sono|io)\b/gi, '').trim();
                    if (name.length >= 2) return name;
                }
            }
            return null;
        }

        function extractPhoneFromText(text) {
            if (!text) return null;
            const patterns = [
                /([+]?39[\s\-]?[0-9]{3}[\s\-]?[0-9]{3}[\s\-]?[0-9]{4})/,
                /([0-9]{3}[\s\-]?[0-9]{3}[\s\-]?[0-9]{4})/,
                /([+][0-9]{1,3}[\s\-]?[0-9]{3,4}[\s\-]?[0-9]{3,4}[\s\-]?[0-9]{3,4})/
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    let phone = match[1].replace(/[\s\-\.]/g, '');
                    if (phone.length >= 8 && phone.length <= 15) {
                        return phone.startsWith('+') ? phone : '+39' + phone.replace(/^39/, '');
                    }
                }
            }
            return null;
        }

        function extractTopicFromText(text) {
            if (!text) return 'Generale';
            
            const lowerText = text.toLowerCase();
            const topics = {
                'Allenamento': ['allenamento', 'esercizi', 'workout', 'palestra', 'training', 'glutei', 'braccia', 'gambe', 'addominali', 'fitness'],
                'Dieta': ['dieta', 'alimentazione', 'cibo', 'nutrizione', 'mangiare', 'calorie', 'proteine', 'carboidrati'],
                'Obiettivi': ['obiettivo', 'perdere peso', 'dimagrire', 'massa', 'tonificare', 'forma', 'risultati'],
                'Consulenza': ['consulenza', 'personal', 'appuntamento', 'coach', 'prenotare', 'incontro'],
                'Salute': ['dolore', 'male', 'infortunio', 'problema', 'medico', 'fisioterapia']
            };
            
            for (const [topic, keywords] of Object.entries(topics)) {
                if (keywords.some(keyword => lowerText.includes(keyword))) {
                    return topic;
                }
            }
            
            return 'Generale';
        }

        function calculateScore(data) {
            let score = 50;
            if (data.email && data.email.length > 5) score += 15;
            if (data.name && data.name.length > 2) score += 10;
            if (data.whatsapp || data.phone) score += 20;
            if (data.goals && data.goals.length > 0) score += 5;
            return Math.min(score, 100);
        }

        function formatDateTime(date) {
            if (!date) return 'N/A';
            return date.toLocaleString('it-IT', {
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function updateStatus(type, message) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `connection-status ${type}`;
            statusEl.textContent = message;
        }

        // === ACTIONS ===
        function openWhatsApp(phone) {
            if (!phone || phone === 'N/A' || phone === 'Non disponibile') {
                alert('Numero non disponibile');
                return;
            }
            const cleanPhone = phone.replace(/[^\d+]/g, '');
            window.open(`https://wa.me/${cleanPhone}`, '_blank');
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        function copyConversation(conversationId) {
            const conversation = allConversations.find(c => c.id === conversationId);
            if (!conversation) return;
            
            const text = conversation.messages.map(msg => 
                `${msg.role === 'user' ? 'UTENTE' : 'ASSISTANT'}: ${msg.message || msg.content}`
            ).join('\n\n');
            
            navigator.clipboard.writeText(text).then(() => {
                alert('Conversazione copiata negli appunti!');
            });
        }

        function copyQuizData(quizId) {
            const quiz = allQuizResults.find(q => q.id === quizId);
            if (!quiz) return;
            
            const text = `
LEAD QUIZ - ${quiz.name}
Email: ${quiz.email}
Telefono: ${quiz.phone}
Score: ${quiz.score}%
Profilo: ${quiz.profile}
Data: ${formatDateTime(quiz.timestamp)}

OBIETTIVI:
${Array.isArray(quiz.goals) ? quiz.goals.map(g => `‚Ä¢ ${g}`).join('\n') : 'Non specificati'}

OSTACOLI:
${Array.isArray(quiz.obstacles) ? quiz.obstacles.map(o => `‚Ä¢ ${o}`).join('\n') : 'Non specificati'}
            `;
            
            navigator.clipboard.writeText(text).then(() => {
                alert('Dati quiz copiati negli appunti!');
            });
        }

        function exportData() {
            const csvData = [];
            
            // Header
            csvData.push('Tipo,Nome,Email,Telefono,Score,Profilo/Topic,Data,Dettagli');
            
            // Quiz data
            filteredQuizResults.forEach(quiz => {
                csvData.push(`Quiz,"${quiz.name}","${quiz.email}","${quiz.phone}",${quiz.score}%,"${quiz.profile}","${formatDateTime(quiz.timestamp)}","${Array.isArray(quiz.goals) ? quiz.goals.join('; ') : ''}"`);
            });
            
            // Conversation data
            filteredConversations.forEach(conv => {
                csvData.push(`Conversazione,"${conv.clientName}","N/A","${conv.phone}","N/A","${conv.topic}","${formatDateTime(conv.timestamp)}","${conv.lastMessage.substring(0,100)}"`);
            });
            
            const csvContent = csvData.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `tribucoach_export_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function showInsights(type) {
            // Mostra insights specifici per tipo
            generateInsights();
            document.querySelector('#insightsContainer').scrollIntoView({ behavior: 'smooth' });
        }

        // === INIZIALIZZAZIONE ===
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('loading', 'üöÄ Inizializzazione dashboard...');
            loadAllData();
            
            // Setup filtro data personalizzato
            document.getElementById('timeFilter').addEventListener('change', function() {
                if (this.value === 'custom') {
                    document.getElementById('customDateRange').style.display = 'flex';
                } else {
                    document.getElementById('customDateRange').style.display = 'none';
                }
            });
            
            // Setup date inputs
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('endDate').value = today;
            
            console.log('üöÄ TribuCoach Business Intelligence Dashboard inizializzata');
        });

        // Close modal on click outside
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>
                    