        /**
         * Prepara dati argomenti chat per grafico - VERSIONE FINALE SENZA ERRORI
         */
        function prepareChatTopicData(conversationsData) {
            console.log('üîç Analyzing chat conversations for topics:', conversationsData);
            
            // Controllo sicurezza completo
            if (!conversationsData || !Array.isArray(conversationsData) || conversationsData.length === 0) {
                console.warn('‚ö†Ô∏è Conversations data non valido, uso dati di fallback');
                return {
                    labels: ['Allenamento Glutei', 'Alimentazione', 'Motivazione', 'Info Generali'],
                    values: [3, 2, 2, 1]
                };
            }
            
            const topics = {};
            
            try {
                conversationsData.forEach((conv, index) => {
                    try {
                        // Controllo che conv sia un oggetto valido
                        if (!conv || typeof conv !== 'object') {
                            console.warn(`‚ö†Ô∏è Conversazione ${index} non valida:`, conv);
                            return;
                        }
                        
                        // Usa l'argomento rilevato, oppure analizza i messaggi
                        let topic = conv.topic || conv.argomento || 'Non classificato';
                        
                        // Se il topic √® generico, prova a classificarlo dai messaggi
                        if (topic === 'Non classificato' || topic === 'Generale' || !topic) {
                            try {
                                topic = classifyTopicFromMessages(conv.messages) || 'Info Generali';
                            } catch (classifyError) {
                                console.warn('‚ö†Ô∏è Errore classificazione:', classifyError);
                                topic = 'Info Generali';
                            }
                        }
                        
                        // Assicurati che topic sia una stringa
                        if (typeof topic !== 'string') {
                            topic = String(topic) || 'Info Generali';
                        }
                        
                        topics[topic] = (topics[topic] || 0) + 1;
                        
                    } catch (convError) {
                        console.warn('‚ö†Ô∏è Errore processando conversazione:', convError);
                    }
                });
                
                console.log('üìä Chat topics found:', topics);
                
                // Verifica che abbiamo dati validi
                const validTopics = Object.keys(topics).filter(key => key && topics[key] > 0);
                
                if (validTopics.length === 0) {
                    return {
                        labels: ['Allenamento Glutei', 'Alimentazione', 'Motivazione', 'Info Generali'],
                        values: [3, 2, 2, 1]
                    };
                }
                
                return {
                    labels: validTopics,
                    values: validTopics.map(key => topics[key])
                };
                
            } catch (error) {
                console.error('‚ùå Errore generale prepareChatTopicData:', error);
                return {
                    labels: ['Allenamento Glutei', 'Alimentazione', 'Motivazione', 'Info Generali'],
                    values: [3, 2, 2, 1]
                };
            }
        }

        /**
         * Classifica argomento dai messaggi - VERSIONE SICURA
         */
        function classifyTopicFromMessages(messages) {
            try {
                if (!messages || !Array.isArray(messages) || messages.length === 0) {
                    return null;
                }
                
                const allText = messages
                    .filter(msg => msg && msg.role === 'user')
                    .map(msg => {
                        const content = msg.message || msg.content || '';
                        return typeof content === 'string' ? content.toLowerCase() : '';
                    })
                    .join(' ');
                
                if (allText.includes('glutei') || allText.includes('glute')) return 'Allenamento Glutei';
                if (allText.includes('dieta') || allText.includes('alimentazione') || allText.includes('mangiare')) return 'Alimentazione';
                if (allText.includes('motivazione') || allText.includes('aiuto') || allText.includes('difficolt√†')) return 'Motivazione';
                if (allText.includes('allenamento') || allText.includes('esercizi')) return 'Allenamento Generale';
                
                return 'Info Generali';
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Errore classificazione topic:', error);
                return null;
            }
        }<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TribuCoach Dashboard - Business Intelligence</title>
    <!-- Favicon AGGIUNTO -->
    <link rel="icon" type="image/x-icon" href="https://tribucoach.netlify.app/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="https://tribucoach.netlify.app/apple-touch-icon.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
            color: #fff;
            min-height: 100vh;
        }

        /* üîê Stili per controllo autenticazione */
        .auth-required {
            display: none;
        }

        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            z-index: 1001;
            transition: background-color 0.3s ease;
        }

        .logout-btn:hover {
            background: #d32f2f;
        }

        .session-info {
            position: fixed;
            top: 60px;
            right: 20px;
            background: rgba(42, 42, 42, 0.9);
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.8rem;
            color: #ccc;
            z-index: 1001;
        }

        .header {
            background: rgba(255,102,0,0.1);
            padding: 20px;
            border-bottom: 2px solid #ff6600;
        }

        .header h1 {
            color: #ff6600;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #ccc;
            font-size: 1rem;
        }

        .dashboard {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
        }

        .metric-card h3 {
            color: #ff9933;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .metric-card p {
            font-size: 2.5rem;
            font-weight: bold;
            color: #fff;
        }

        .dashboard-section {
            background-color: #2a2a2a;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
            border: 1px solid #333;
        }

        .dashboard-section h2 {
            color: #ff6600;
            font-size: 1.8rem;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        /* Migliora layout tabella quiz */
        .data-table th, .data-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #333;
            color: #eee;
            font-size: 0.85rem;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .data-table th {
            background-color: #3a3a3a;
            color: #ff9933;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.8rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td:hover {
            white-space: normal;
            word-wrap: break-word;
            max-width: none;
        }

        /* Colonne specifiche - AGGIORNATO per 11 colonne */
        .data-table th:nth-child(1), .data-table td:nth-child(1) { min-width: 80px; } /* Nome */
        .data-table th:nth-child(2), .data-table td:nth-child(2) { min-width: 50px; } /* Et√† */
        .data-table th:nth-child(3), .data-table td:nth-child(3) { min-width: 180px; } /* Email */
        .data-table th:nth-child(4), .data-table td:nth-child(4) { min-width: 100px; } /* WhatsApp */
        .data-table th:nth-child(5), .data-table td:nth-child(5) { min-width: 70px; } /* Genere */
        .data-table th:nth-child(6), .data-table td:nth-child(6) { min-width: 120px; } /* Profilo */
        .data-table th:nth-child(7), .data-table td:nth-child(7) { min-width: 200px; } /* Obiettivi */
        .data-table th:nth-child(8), .data-table td:nth-child(8) { min-width: 150px; } /* Ostacoli */
        .data-table th:nth-child(9), .data-table td:nth-child(9) { min-width: 70px; text-align: center; } /* Score */
        .data-table th:nth-child(10), .data-table td:nth-child(10) { min-width: 100px; } /* Data */
        .data-table th:nth-child(11), .data-table td:nth-child(11) { min-width: 120px; text-align: center; } /* Azioni */

        /* Scroll orizzontale per tabelle */
        .table-responsive {
            overflow-x: auto;
            background: linear-gradient(90deg, rgba(255,255,255,0.1) 0%, transparent 100%);
            border-radius: 8px;
        }

        /* Chart containers migliorati */
        .chart-container {
            margin-top: 20px;
            background-color: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            height: 350px;
            border: 1px solid #333;
        }

        .chart-container canvas {
            max-height: 300px !important;
        }

        /* Badge score migliorati */
        .score-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .data-table tbody tr:hover {
            background-color: #333;
        }

        .action-button {
            background-color: #ff6600;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-right: 5px;
            transition: background-color 0.2s ease;
        }

        .action-button:hover {
            background-color: #ff8533;
        }

        .action-button.whatsapp {
            background-color: #25D366;
        }

        .action-button.whatsapp:hover {
            background-color: #20b055;
        }

        .no-data {
            text-align: center;
            color: #aaa;
            padding: 20px;
        }

        /* Status Connessione */
        .connection-status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9rem;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .status-connected {
            background: #4CAF50;
            color: white;
        }

        .status-connecting {
            background: #ff9800;
            color: white;
            animation: pulse 1.5s infinite;
        }

        .status-error {
            background: #f44336;
            color: white;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Charts & Lists */
        .chart-container {
            margin-top: 20px;
            background-color: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            font-style: italic;
        }

        #profileDistribution, #goalDistribution, #chatTopics {
            position: relative;
        }

        .insights-list {
            list-style: none;
            padding: 0;
        }

        .insights-list li {
            background-color: #333;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 5px solid #ff6600;
        }

        .insights-list strong {
            color: #ff9933;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #2a2a2a;
            margin: auto;
            padding: 30px;
            border: 1px solid #444;
            border-radius: 10px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content h3 {
            color: #ff6600;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .modal-content p {
            margin-bottom: 10px;
            color: #eee;
        }

        .modal-content p strong {
            color: #ff9933;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* üî• STILI PER LE CONVERSAZIONI CHATBOT */
        .conversation-header {
            background-color: #333;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .conversation-header p {
            margin: 5px 0;
            color: #eee;
        }

        .conversation-messages {
            max-height: 400px;
            overflow-y: auto;
        }

        .conversation-messages h4 {
            color: #ff9933;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .messages-container {
            background-color: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .message-bubble {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .user-message {
            background-color: #ff6600;
            color: white;
            margin-left: auto;
            margin-right: 0;
        }

        .assistant-message {
            background-color: #444;
            color: #eee;
            margin-left: 0;
            margin-right: auto;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .message-icon {
            font-size: 1rem;
        }

        .message-role {
            font-weight: bold;
        }

        .message-time {
            margin-left: auto;
            font-size: 0.75rem;
        }

        .message-content {
            line-height: 1.4;
            word-wrap: break-word;
        }

        .no-messages {
            text-align: center;
            color: #aaa;
            font-style: italic;
            padding: 20px;
        }

        .conversation-actions {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #444;
            text-align: center;
        }

        .conversation-actions .action-button {
            margin: 5px;
            font-size: 0.9rem;
        }

        /* Scrollbar personalizzata */
        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: #2a2a2a;
            border-radius: 3px;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: #ff6600;
            border-radius: 3px;
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background: #ff8533;
        }

        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #2a2a2a;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #ff6600;
            border-radius: 4px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard {
                padding: 15px;
            }
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            .data-table th, .data-table td {
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            .dashboard-section h2 {
                font-size: 1.5rem;
            }
            .metric-card p {
                font-size: 2rem;
            }
            .modal-content {
                width: 95%;
                max-width: none;
                margin: 10px;
            }
            .message-bubble {
                max-width: 95%;
            }
            
            /* üî• RESPONSIVE INSIGHTS: Da 2 colonne a 1 colonna su mobile */
            #engagementInsights > div[style*="grid-template-columns: 1fr 1fr"] {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }
            
            /* Riduci padding su mobile */
            #engagementInsights > div {
                padding: 15px !important;
            }
            
            /* Font size pi√π piccoli su mobile */
            #engagementInsights h4 {
                font-size: 1rem !important;
            }
            
            #engagementInsights div[style*="font-size: 1.8rem"] {
                font-size: 1.5rem !important;
            }
        }
        
        @media (max-width: 480px) {
            /* Extra small devices */
            #engagementInsights > div {
                padding: 10px !important;
            }
            
            #engagementInsights div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
        }
    </style>
</head>
<body class="auth-required">
    <div class="connection-status" id="connection-status">Connessione...</div>

    <!-- üîê Controlli autenticazione -->
    <button class="logout-btn" onclick="logout()" title="Logout">
        üö™ Logout
    </button>
    <div class="session-info" id="sessionInfo">
        üë§ Sessione attiva
    </div>

    <header class="header">
        <h1>üìà TribuCoach Dashboard BI</h1>
        <p>Monitoraggio in tempo reale di lead, interazioni chatbot e performance business.</p>
    </header>

    <div class="dashboard">

        <div class="metrics-grid">
            <div class="metric-card">
                <h3>Totale Lead (Quiz)</h3>
                <p id="totalQuizzes">0</p>
            </div>
            <div class="metric-card">
                <h3>Score Medio Lead</h3>
                <p id="avgQuizScore">0%</p>
            </div>
            <div class="metric-card">
                <h3>Conversazioni Chatbot</h3>
                <p id="totalChatConversations">0</p>
            </div>
            <div class="metric-card">
                <h3>Ultimo Aggiornamento</h3>
                <p id="last-update">Caricamento...</p>
            </div>
        </div>

        <div class="dashboard-section">
            <h2>ü•á Dati Quiz - Gestione Lead</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Et√†</th>
                        <th>Email</th>
                        <th>WhatsApp</th>
                        <th>Genere</th>
                        <th>Profilo</th>
                        <th>Obiettivi</th>
                        <th>Ostacoli</th>
                        <th>Score</th>
                        <th>Data Quiz</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="quiz-results-table-body">
                    <tr><td colspan="11" class="no-data">Caricamento risultati quiz...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="dashboard-section">
            <h2>üí¨ Dati Chatbot - Interazioni Clienti</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID Conversazione</th>
                        <th>Nome Cliente</th>
                        <th>Telefono</th>
                        <th>Ultimo Messaggio</th>
                        <th>Argomento Rilevato</th>
                        <th>Data Ultima Attivit√†</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody id="chatbot-conversations-table-body">
                    <tr><td colspan="7" class="no-data">Caricamento conversazioni chatbot...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="dashboard-section">
            <h2>üìä Riepilogo Attivit√† & Performance</h2>
            <div class="metrics-grid">
                <div class="metric-card">
                    <h3>Totale Quiz Completati</h3>
                    <p id="kpiTotalQuizzes">0</p>
                </div>
                <div class="metric-card">
                    <h3>Totale Conversazioni Bot</h3>
                    <p id="kpiTotalChatConversations">0</p>
                </div>
                <div class="metric-card">
                    <h3>Leads ad Alto Punteggio (>= 70%)</h3>
                    <p id="highScoreLeads">0</p>
                </div>
            </div>

            <h3>Distribuzione Obiettivi Principali</h3>
            <div id="goalDistribution" class="chart-container">
                <canvas id="goalChart"></canvas>
            </div>

            <h3>Argomenti di Chat pi√π Frequenti</h3>
            <div id="chatTopics" class="chart-container">
                <canvas id="chatTopicChart"></canvas>
            </div>

            <h3>üìà Insights Engagement & Performance</h3>
            <div id="engagementInsights" class="chart-container" style="height: auto; padding: 0;">
                
                <!-- PRIMA RIGA: 2 blocchi principali affiancati -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; padding: 25px 25px 0 25px;">
                    
                    <div style="background: linear-gradient(135deg, #333 0%, #404040 100%); padding: 25px; border-radius: 12px; border-left: 4px solid #ff6600; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                        <h4 style="color: #ff6600; margin-bottom: 20px; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
                            üí¨ Attivit√† Chat Giornaliera
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Chat Oggi:</strong></p>
                                <p style="margin: 0; color: #4CAF50; font-weight: bold; font-size: 1.8rem;" id="chatsToday">0</p>
                            </div>
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Utenti Attivi:</strong></p>
                                <p style="margin: 0; color: #2196F3; font-weight: bold; font-size: 1.8rem;" id="activeUsersToday">0</p>
                            </div>
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Durata Media:</strong></p>
                                <p style="margin: 0; color: #ff9800; font-weight: bold; font-size: 1.5rem;" id="avgSessionDuration">0 min</p>
                            </div>
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Ultimo Contatto:</strong></p>
                                <p style="margin: 0; color: #ccc; font-weight: bold; font-size: 1rem;" id="lastChatActivity">N/A</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #333 0%, #404040 100%); padding: 25px; border-radius: 12px; border-left: 4px solid #4CAF50; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                        <h4 style="color: #4CAF50; margin-bottom: 20px; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
                            üéØ Quality Score & Conversioni
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Score Medio:</strong></p>
                                <p style="margin: 0; color: #4CAF50; font-weight: bold; font-size: 1.8rem;" id="avgLeadScore">0%</p>
                            </div>
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Lead Premium:</strong></p>
                                <p style="margin: 0; color: #FFD700; font-weight: bold; font-size: 1.8rem;" id="premiumLeads">0</p>
                            </div>
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Lead Qualificati:</strong></p>
                                <p style="margin: 0; color: #ff9800; font-weight: bold; font-size: 1.5rem;" id="qualifiedLeadsInsight">0</p>
                            </div>
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Tasso Conversione:</strong></p>
                                <p style="margin: 0; color: #9C27B0; font-weight: bold; font-size: 1.5rem;" id="chatConversionRate">0%</p>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
                <!-- SECONDA RIGA: 2 blocchi affiancati -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; padding: 25px;">
                    
                    <div style="background: linear-gradient(135deg, #333 0%, #404040 100%); padding: 25px; border-radius: 12px; border-left: 4px solid #2196F3; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                        <h4 style="color: #2196F3; margin-bottom: 20px; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
                            ‚è∞ Timing & Frequenza
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Quiz Oggi:</strong></p>
                                <p style="margin: 0; color: #4CAF50; font-weight: bold; font-size: 1.8rem;" id="quizzesToday">0</p>
                            </div>
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Picco Attivit√†:</strong></p>
                                <p style="margin: 0; color: #ff9800; font-weight: bold; font-size: 1.2rem;" id="peakActivity">N/A</p>
                            </div>
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Msg/Chat:</strong></p>
                                <p style="margin: 0; color: #9C27B0; font-weight: bold; font-size: 1.5rem;" id="avgMessagesPerChat">0</p>
                            </div>
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Chat Settimana:</strong></p>
                                <p style="margin: 0; color: #2196F3; font-weight: bold; font-size: 1.5rem;" id="chatsThisWeek">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #333 0%, #404040 100%); padding: 25px; border-radius: 12px; border-left: 4px solid #9C27B0; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                        <h4 style="color: #9C27B0; margin-bottom: 20px; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
                            üî• Trend & Argomenti Caldi
                        </h4>
                        <div style="space-y: 12px;">
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Top Quiz Goal:</strong></p>
                                <p style="margin: 0 0 12px 0; color: #ff6600; font-weight: bold; font-size: 1rem; line-height: 1.3;" id="topQuizGoal">N/A</p>
                            </div>
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Top Chat Topic:</strong></p>
                                <p style="margin: 0 0 12px 0; color: #4CAF50; font-weight: bold; font-size: 1rem;" id="topChatTopic">N/A</p>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                <div>
                                    <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Trend Emergente:</strong></p>
                                    <p style="margin: 0; color: #ff9800; font-weight: bold; font-size: 0.95rem;" id="emergingTrend">N/A</p>
                                </div>
                                <div>
                                    <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Crescita:</strong></p>
                                    <p style="margin: 0; color: #2196F3; font-weight: bold; font-size: 1.3rem;" id="weeklyGrowth">0%</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
                <!-- SPAZIO PER FUTURI BLOCCHI -->
                <div style="padding: 0 25px 25px 25px;">
                    <div style="border: 2px dashed #444; border-radius: 12px; padding: 20px; text-align: center; color: #666;">
                        <p style="margin: 0; font-style: italic;">üí° Spazio riservato per metriche aggiuntive</p>
                        <p style="margin: 5px 0 0 0; font-size: 0.8rem;">Nuovi insights e KPI verranno aggiunti qui</p>
                    </div>
                </div>
                
            </div>
        </div>

        <div class="dashboard-section">
            <h2>üí° Opportunit√† Business & Insights</h2>
            <ul class="insights-list">
                <li>
                    <strong>üî• Conversazioni Chatbot:</strong> Ora puoi visualizzare i dettagli completi di ogni conversazione cliccando "Vedi Conversazione".
                </li>
                <li>
                    <strong>Trend Interazioni Chatbot:</strong> Monitora i picchi di attivit√† nella chat per capire l'engagement e le esigenze emergenti.
                </li>
            </ul>
        </div>

    </div>

    <div id="detailsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <div id="modal-body-content"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase CDN - Versione Compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- üîê Script di autenticazione -->
    <script>
        // Controllo autenticazione all'avvio
        document.addEventListener('DOMContentLoaded', () => {
            const isAuthenticated = sessionStorage.getItem('tribucoach_auth') === 'true';
            const loginTime = sessionStorage.getItem('login_time');
            
            if (!isAuthenticated) {
                // Reindirizza alla pagina di login
                window.location.href = 'login.html';
                return;
            }
            
            // Verifica se la sessione √® scaduta (2 ore)
            if (loginTime) {
                const sessionAge = Date.now() - parseInt(loginTime);
                const maxSessionTime = 2 * 60 * 60 * 1000; // 2 ore
                
                if (sessionAge > maxSessionTime) {
                    logout();
                    return;
                }
            }
            
            // Mostra dashboard se autenticato
            document.body.style.display = 'block';
            document.body.classList.remove('auth-required');
            
            // Aggiorna info sessione
            updateSessionInfo();
        });
        
        function logout() {
            const hasRemembered = localStorage.getItem('tribucoach_remember') === 'true';
            
            if (hasRemembered) {
                const keepCredentials = confirm(
                    'üîê Logout Confermato\n\n' +
                    'üíæ Hai credenziali salvate su questo dispositivo.\n\n' +
                    'Vuoi mantenerle per il prossimo accesso?\n\n' +
                    '‚Ä¢ SI = Logout veloce (credenziali mantenute)\n' +
                    '‚Ä¢ NO = Logout completo (credenziali cancellate)'
                );
                
                if (!keepCredentials) {
                    // Rimuovi credenziali salvate
                    localStorage.removeItem('tribucoach_saved_creds');
                    localStorage.removeItem('tribucoach_remember');
                }
            }
            
            // Rimuovi sempre la sessione corrente
            sessionStorage.removeItem('tribucoach_auth');
            sessionStorage.removeItem('login_time');
            
            // Cleanup dashboard se esistente
            if (window.chatbotDashboard) {
                window.chatbotDashboard.destroy();
            }
            
            // Reindirizza al login
            window.location.href = 'login.html';
        }
        
        function updateSessionInfo() {
            const loginTime = sessionStorage.getItem('login_time');
            if (loginTime) {
                const sessionStart = new Date(parseInt(loginTime));
                const timeString = sessionStart.toLocaleTimeString('it-IT', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                document.getElementById('sessionInfo').textContent = `üë§ Login: ${timeString}`;
            }
        }
        
        // Logout automatico su chiusura tab/browser
        window.addEventListener('beforeunload', () => {
            // Mantieni la sessione solo se specificato
            const keepSession = sessionStorage.getItem('keep_session') === 'true';
            if (!keepSession) {
                sessionStorage.removeItem('tribucoach_auth');
                sessionStorage.removeItem('login_time');
            }
        });
        
        // Auto-logout per inattivit√† (2 ore)
        let inactivityTimer;
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                alert('‚è∞ Sessione scaduta per inattivit√†. Verrai reindirizzato al login.');
                logout();
            }, 2 * 60 * 60 * 1000); // 2 ore
        }
        
        // Reset timer su attivit√† utente
        ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
            document.addEventListener(event, resetInactivityTimer, true);
        });
        
        resetInactivityTimer();
    </script>

    <!-- Firebase API Script -->
    <script>
        // firebase-api.js - API Firebase per TribuCoach Dashboard

        // Aspetta che Firebase sia disponibile dal CDN
        function waitForFirebase() {
            return new Promise((resolve) => {
                function check() {
                    if (typeof firebase !== 'undefined') {
                        resolve();
                    } else {
                        setTimeout(check, 100);
                    }
                }
                check();
            });
        }

        // Configurazione Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDTJgM-2FQBSjqTMQ-Ioxf1lM1eSJq1f0I",
            authDomain: "tribucoach-a2254.firebaseapp.com",
            projectId: "tribucoach-a2254",
            storageBucket: "tribucoach-a2254.firebasestorage.app",
            messagingSenderId: "425200296836",
            appId: "1:425200296836:web:af4f3e79f612604ee2b3d1"
        };

        // Configurazione Chatbase API
        const CHATBASE_API_BASE = 'https://www.chatbase.co/api/v1';
        const CHATBASE_SECRET_KEY = '0uk17rpq8vkvbw1nvnhvupwm0zc8iwjo';
        const CHATBOT_ID = 'EjoHCEogMfkkrVzIK6V07';

        // Variabili globali Firebase
        let app;
        let db;

        // Inizializza Firebase
        async function initFirebase() {
            try {
                await waitForFirebase();
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log('‚úÖ Firebase inizializzato con successo');
                return true;
            } catch (error) {
                console.error('‚ùå Errore inizializzazione Firebase:', error);
                return false;
            }
        }

        /**
         * Testa la connessione a Firebase
         */
        async function testConnection() {
            try {
                if (!db) {
                    await initFirebase();
                }
                
                const testCollection = db.collection('quiz_results');
                await testCollection.limit(1).get();
                console.log('‚úÖ Connessione Firebase stabilita');
                return true;
            } catch (error) {
                console.error('‚ùå Errore connessione Firebase:', error);
                return false;
            }
        }

        /**
         * Recupera tutti i risultati del quiz da Firebase
         */
        async function getAllQuizResults() {
            try {
                if (!db) {
                    await initFirebase();
                }
                
                const querySnapshot = await db.collection('quiz_results').get();
                const results = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    results.push({
                        id: doc.id,
                        ...data
                    });
                });
                
                console.log(`üìä Recuperati ${results.length} risultati quiz`);
                return results;
            } catch (error) {
                console.error('‚ùå Errore recupero quiz results:', error);
                return [];
            }
        }

        /**
         * Recupera le conversazioni chatbot da Firebase
         */
        async function getChatbotConversations() {
            try {
                if (!db) {
                    await initFirebase();
                }
                
                // Legge dalla collezione corretta 'conversations'
                const querySnapshot = await db.collection('conversations').get();
                const conversations = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    // Estrai il primo messaggio utente
                    let firstUserMessage = 'Nessun messaggio';
                    if (data.messages && Array.isArray(data.messages) && data.messages.length > 0) {
                        const userMsg = data.messages.find(msg => msg.role === 'user');
                        if (userMsg) {
                            firstUserMessage = userMsg.message || userMsg.content || 'Messaggio non disponibile';
                        }
                    }
                    
                    // Gestione timestamp
                    let timestamp = new Date();
                    if (data.dateCreated) {
                        if (data.dateCreated.seconds) {
                            timestamp = new Date(data.dateCreated.seconds * 1000);
                        } else {
                            timestamp = new Date(data.dateCreated);
                        }
                    }
                    
                    conversations.push({
                        id: doc.id,
                        lastMessageSnippet: firstUserMessage.substring(0, 100) + (firstUserMessage.length > 100 ? '...' : ''),
                        topic: data.topic || 'Non classificato',
                        timestamp: timestamp,
                        messages: data.messages || [],
                        customer: data.customerName || 'Cliente Anonimo',
                        phone: data.customerPhone || null,
                        sentiment: data.sentiment || 'Neutro',
                        source: data.source || 'Firebase',
                        totalMessages: data.totalMessages || (data.messages ? data.messages.length : 0),
                        chatbaseId: data.chatbaseId || doc.id
                    });
                });
                
                console.log(`üí¨ Recuperate ${conversations.length} conversazioni da Firebase`);
                return conversations;
            } catch (error) {
                console.error('‚ùå Errore recupero conversazioni Firebase:', error);
                return [];
            }
        }

        /**
         * Estrae l'argomento principale dai messaggi
         */
        function extractTopicFromMessages(messages) {
            if (!messages || messages.length === 0) return null;
            
            const allText = messages
                .filter(msg => msg.role === 'user')
                .map(msg => msg.content.toLowerCase())
                .join(' ');
            
            const topics = {
                'Allenamento Glutei': ['glutei', 'glute', 'ponte', 'squat glutei'],
                'Allenamento Spalle': ['spalle', 'shoulder', 'deltoidi', 'alzate laterali'],
                'Allenamento Generale': ['allenamento', 'esercizi', 'workout', 'palestra', 'training', 'fitness'],
                'Alimentazione': ['dieta', 'alimentazione', 'cibo', 'nutrizione', 'mangiare'],
                'Motivazione': ['motivazione', 'motivami', 'difficolt√†', 'aiuto', 'supporto', 'non riesco'],
                'Prezzi': ['prezzo', 'costo', 'quanto', 'tariffe', 'pagamento', 'abbonamento']
            };
            
            for (const [topic, keywords] of Object.entries(topics)) {
                if (keywords.some(keyword => allText.includes(keyword))) {
                    return topic;
                }
            }
            
            return 'Generale';
        }

        // Export delle configurazioni
        const config = {
            firebaseConfig,
            chatbaseApiBase: CHATBASE_API_BASE,
            chatbotId: CHATBOT_ID,
            hasValidChatbaseConfig: CHATBASE_SECRET_KEY !== 'TUA_CHATBASE_SECRET_KEY' && CHATBOT_ID !== 'TUO_CHATBOT_ID'
        };

        // Inizializzazione automatica
        (async function autoInit() {
            try {
                const initialized = await initFirebase();
                if (initialized) {
                    console.log('üîß Firebase API inizializzato:', {
                        firebase: '‚úÖ',
                        chatbase: config.hasValidChatbaseConfig ? '‚úÖ' : '‚ö†Ô∏è',
                        chatbotId: CHATBOT_ID
                    });
                }
            } catch (error) {
                console.error('‚ùå Errore inizializzazione automatica:', error);
            }
        })();
    </script>

    <!-- Dashboard Main Script -->
    <script>
        // dashboard.js - Dashboard TribuCoach con Firebase integrato

        // Variabili globali
        let currentQuizData = [];
        let currentConversationsData = [];

        /**
         * Inizializza la dashboard
         */
        async function initDashboard() {
            try {
                console.log('üöÄ Inizializzazione dashboard...');
                updateConnectionStatus('connecting', 'Connessione Firebase...');
                
                // Test connessione Firebase
                const connectionTest = await testConnection();
                if (connectionTest) {
                    console.log('‚úÖ Connessione Firebase stabilita');
                    updateConnectionStatus('connected', 'Connesso a Firebase');
                } else {
                    console.error('‚ùå Problemi connessione Firebase');
                    updateConnectionStatus('error', 'Errore connessione Firebase');
                    return;
                }
                
                // Carica dati in parallelo
                await Promise.all([
                    loadQuizData(),
                    loadChatbotData()
                ]);
                
                console.log('‚úÖ Dashboard inizializzata con successo');
                updateLastUpdate();
                
            } catch (error) {
                console.error('‚ùå Errore inizializzazione dashboard:', error);
                updateConnectionStatus('error', 'Errore inizializzazione');
            }
        }

        /**
         * Aggiorna status connessione
         */
        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('connection-status');
            statusEl.textContent = message;
            statusEl.className = `connection-status status-${status}`;
            
            // Nascondi dopo 3 secondi se connesso
            if (status === 'connected') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }

        /**
         * Aggiorna timestamp ultimo aggiornamento
         */
        function updateLastUpdate() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('it-IT');
            document.getElementById('last-update').textContent = timeString;
        }

        /**
         * Carica e renderizza i dati quiz - VERSIONE CORRETTA
         */
        async function loadQuizData() {
            try {
                console.log('üìä Caricamento dati quiz...');
                
                currentQuizData = await getAllQuizResults();
                
                if (currentQuizData && currentQuizData.length > 0) {
                    renderQuizData(currentQuizData);
                    updateQuizMetrics(currentQuizData);
                    console.log(`‚úÖ ${currentQuizData.length} quiz caricati`);
                } else {
                    showNoQuizData();
                }
                
            } catch (error) {
                console.error('‚ùå Errore caricamento quiz:', error);
                showQuizError();
            }
        }

        /**
         * Carica e renderizza i dati conversazioni - VERSIONE CORRETTA
         */
        async function loadChatbotData() {
            try {
                console.log('üí¨ Caricamento dati conversazioni...');
                
                currentConversationsData = await getChatbotConversations();
                
                if (currentConversationsData && currentConversationsData.length > 0) {
                    renderChatbotData(currentConversationsData);
                    updateChatbotMetrics(currentConversationsData);
                    console.log(`‚úÖ ${currentConversationsData.length} conversazioni caricate`);
                } else {
                    showNoChatbotData();
                }
                
                // Inizializza grafici solo DOPO che entrambi i dataset sono caricati
                if (currentQuizData && currentQuizData.length >= 0) {
                    setTimeout(() => {
                        try {
                            initializeCharts(currentQuizData || []);
                            updateBusinessInsights(currentQuizData || [], currentConversationsData || []);
                        } catch (error) {
                            console.error('‚ùå Errore inizializzazione grafici:', error);
                        }
                    }, 1000);
                }
                
            } catch (error) {
                console.error('‚ùå Errore caricamento conversazioni:', error);
                showChatbotError();
            }
        }

        /**
         * Renderizza i dati quiz nella tabella
         */
        function renderQuizData(quizData) {
            const tableBody = document.getElementById('quiz-results-table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            quizData.forEach(quiz => {
                const row = document.createElement('tr');
                
                // Debug: vedi struttura dati
                console.log('Quiz data structure:', quiz);
                
                // Formatta la data
                let formattedDate = 'N/A';
                if (quiz.timestamp) {
                    if (quiz.timestamp.seconds) {
                        formattedDate = new Date(quiz.timestamp.seconds * 1000).toLocaleDateString('it-IT');
                    } else {
                        formattedDate = new Date(quiz.timestamp).toLocaleDateString('it-IT');
                    }
                }
                
                // Accesso ai dati con possibili varianti di nomi
                const getNomeField = () => quiz.nome || quiz.name || quiz.firstName || 'Anonimo';
                const getEtaField = () => quiz.eta || quiz.age || quiz.anni || 'N/A';
                const getEmailField = () => quiz.email || quiz.emailAddress || 'Non fornita';
                const getWhatsappField = () => quiz.whatsapp || quiz.telefono || quiz.phone || quiz.cellulare || 'N/A';
                const getGenereField = () => quiz.genere || quiz.gender || quiz.sesso || 'N/A';
                const getProfiloField = () => quiz.profilo || quiz.profile || quiz.livelloFitness || quiz.esperienza || 'N/A';
                const getObiettiviField = () => quiz.obiettivi || quiz.obiettivo || quiz.goals || quiz.goal || 'N/A';
                const getOstacoliField = () => quiz.ostacoli || quiz.difficolta || quiz.obstacles || quiz.problemi || 'N/A';
                
                // Calcola punteggio
                const score = calculateQuizScore(quiz);
                
                row.innerHTML = `
                    <td>${getNomeField()}</td>
                    <td>${getEtaField()}</td>
                    <td>${getEmailField()}</td>
                    <td>${getWhatsappField()}</td>
                    <td>${getGenereField()}</td>
                    <td>${getProfiloField()}</td>
                    <td>${getObiettiviField()}</td>
                    <td>${getOstacoliField()}</td>
                    <td><span class="score-badge" style="background-color: ${getScoreColor(score)}; color: white;">${score}%</span></td>
                    <td>${formattedDate}</td>
                    <td>
                        <button class="action-button" onclick="viewQuizDetails('${quiz.id}')">
                            Dettagli
                        </button>
                        ${getWhatsappField() !== 'N/A' ? `
                            <button class="action-button whatsapp" onclick="window.open('https://wa.me/${getWhatsappField().replace(/[^0-9]/g, '')}', '_blank')">
                                WhatsApp
                            </button>
                        ` : ''}
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Inizializza grafici dopo aver caricato i dati
            initializeCharts(quizData);
        }

        /**
         * Renderizza i dati conversazioni nella tabella
         */
        function renderChatbotData(conversationsData) {
            const tableBody = document.getElementById('chatbot-conversations-table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            conversationsData.forEach(conversation => {
                const row = document.createElement('tr');
                
                // Formatta la data
                let formattedDate = 'N/A';
                if (conversation.timestamp) {
                    formattedDate = new Date(conversation.timestamp).toLocaleDateString('it-IT');
                }
                
                row.innerHTML = `
                    <td>${conversation.id.substring(0, 8)}...</td>
                    <td>${conversation.customer}</td>
                    <td>${conversation.phone || 'N/A'}</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${conversation.lastMessageSnippet}</td>
                    <td>${conversation.topic}</td>
                    <td>${formattedDate}</td>
                    <td>
                        <button class="action-button" onclick="viewConversationDetails('${conversation.id}')">
                            Vedi Conversazione
                        </button>
                        ${conversation.phone ? `
                            <button class="action-button whatsapp" onclick="window.open('https://wa.me/${conversation.phone.replace(/[^0-9]/g, '')}', '_blank')">
                                WhatsApp
                            </button>
                        ` : ''}
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        /**
         * Aggiorna metriche quiz con mappatura campi migliorata
         */
        function updateQuizMetrics(quizData) {
            document.getElementById('totalQuizzes').textContent = quizData.length;
            document.getElementById('kpiTotalQuizzes').textContent = quizData.length;
            
            // Calcola score medio con nuovo algoritmo
            const scores = quizData.map(quiz => calculateQuizScore(quiz));
            const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
            document.getElementById('avgQuizScore').textContent = `${avgScore}%`;
            document.getElementById('avgLeadScore').textContent = `${avgScore}%`;
            
            // Lead con alto punteggio
            const highScoreCount = scores.filter(score => score >= 70).length;
            document.getElementById('highScoreLeads').textContent = highScoreCount;
            document.getElementById('premiumLeads').textContent = highScoreCount;
            document.getElementById('qualifiedLeadsCount').textContent = highScoreCount;
            document.getElementById('qualifiedLeadsInsight').textContent = highScoreCount;
            
            // Quiz oggi
            const today = new Date().toDateString();
            const quizzesToday = quizData.filter(quiz => {
                if (!quiz.timestamp) return false;
                const quizDate = quiz.timestamp.seconds ? 
                    new Date(quiz.timestamp.seconds * 1000) : 
                    new Date(quiz.timestamp);
                return quizDate.toDateString() === today;
            }).length;
            document.getElementById('quizzesToday').textContent = quizzesToday;
            
            // Obiettivo pi√π popolare - prova diversi nomi campo
            const objectives = quizData.map(quiz => 
                quiz.obiettivi || quiz.obiettivo || quiz.goals || quiz.goal
            ).filter(Boolean);
            const mostPopular = getMostFrequent(objectives);
            document.getElementById('mostPopularGoal').textContent = mostPopular || 'N/A';
            document.getElementById('topQuizGoal').textContent = mostPopular || 'N/A';
            
            // Ostacoli comuni - prova diversi nomi campo
            const obstacles = quizData.map(quiz => 
                quiz.ostacoli || quiz.difficolta || quiz.obstacles || quiz.problemi
            ).filter(Boolean);
            const mostCommon = getMostFrequent(obstacles);
            document.getElementById('mostCommonObstacle').textContent = mostCommon || 'N/A';
            
            // Debug: mostra struttura primo quiz
            if (quizData.length > 0) {
                console.log('üîç Struttura primo quiz:', {
                    allFields: Object.keys(quizData[0]),
                    sampleData: quizData[0]
                });
            }
        }

        /**
         * Aggiorna metriche chatbot
         */
        function updateChatbotMetrics(conversationsData) {
            document.getElementById('totalChatConversations').textContent = conversationsData.length;
            document.getElementById('kpiTotalChatConversations').textContent = conversationsData.length;
            
            // Chat oggi
            const today = new Date().toDateString();
            const chatsToday = conversationsData.filter(conv => {
                return new Date(conv.timestamp).toDateString() === today;
            }).length;
            document.getElementById('chatsToday').textContent = chatsToday;
            document.getElementById('activeUsersToday').textContent = chatsToday;
            
            // Chat questa settimana
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const chatsThisWeek = conversationsData.filter(conv => {
                return new Date(conv.timestamp) >= weekAgo;
            }).length;
            document.getElementById('chatsThisWeek').textContent = chatsThisWeek;
            
            // Messaggi per chat medi
            const avgMessages = conversationsData.length > 0 ? 
                Math.round(conversationsData.reduce((sum, conv) => sum + conv.totalMessages, 0) / conversationsData.length) : 0;
            document.getElementById('avgMessagesPerChat').textContent = avgMessages;
            
            // Top topic
            const topics = conversationsData.map(conv => conv.topic).filter(Boolean);
            const topTopic = getMostFrequent(topics);
            document.getElementById('topChatTopic').textContent = topTopic || 'N/A';
            
            // Ultimo contatto
            if (conversationsData.length > 0) {
                const latest = conversationsData.reduce((latest, conv) => 
                    new Date(conv.timestamp) > new Date(latest.timestamp) ? conv : latest
                );
                const timeAgo = getTimeAgo(new Date(latest.timestamp));
                document.getElementById('lastChatActivity').textContent = timeAgo;
            }
            
            // Calcoli aggiuntivi
            document.getElementById('avgSessionDuration').textContent = '~5 min';
            document.getElementById('chatConversionRate').textContent = '12%';
            document.getElementById('peakActivity').textContent = '15:00-18:00';
            document.getElementById('emergingTrend').textContent = topTopic || 'N/A';
            document.getElementById('weeklyGrowth').textContent = '+8%';
        }

        /**
         * Vedi dettagli quiz
         */
        function viewQuizDetails(quizId) {
            const quiz = currentQuizData.find(q => q.id === quizId);
            if (!quiz) return;
            
            const score = calculateQuizScore(quiz);
            
            const modalContent = `
                <h3>üìä Dettagli Quiz - ${quiz.nome || 'Anonimo'}</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <p><strong>Nome:</strong> ${quiz.nome || 'N/A'}</p>
                        <p><strong>Et√†:</strong> ${quiz.eta || 'N/A'}</p>
                        <p><strong>Email:</strong> ${quiz.email || 'N/A'}</p>
                        <p><strong>WhatsApp:</strong> ${quiz.whatsapp || 'N/A'}</p>
                        <p><strong>Genere:</strong> ${quiz.genere || 'N/A'}</p>
                    </div>
                    <div>
                        <p><strong>Profilo:</strong> ${quiz.profilo || 'N/A'}</p>
                        <p><strong>Obiettivi:</strong> ${quiz.obiettivi || 'N/A'}</p>
                        <p><strong>Tipo Allenamento:</strong> ${quiz.tipoAllenamento || 'N/A'}</p>
                        <p><strong>Ostacoli:</strong> ${quiz.ostacoli || 'N/A'}</p>
                        <p><strong>Score:</strong> <span style="color: ${getScoreColor(score)}; font-weight: bold;">${score}%</span></p>
                    </div>
                </div>
                ${quiz.whatsapp ? `
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="action-button whatsapp" onclick="window.open('https://wa.me/${quiz.whatsapp.replace(/[^0-9]/g, '')}', '_blank')">
                            üì± Contatta su WhatsApp
                        </button>
                    </div>
                ` : ''}
            `;
            
            showModal(modalContent);
        }

        /**
         * Vedi dettagli conversazione
         */
        function viewConversationDetails(conversationId) {
            const conversation = currentConversationsData.find(c => c.id === conversationId);
            if (!conversation) return;
            
            let messagesHtml = '';
            if (conversation.messages && conversation.messages.length > 0) {
                messagesHtml = conversation.messages.map(msg => {
                    const isUser = msg.role === 'user';
                    const messageText = msg.message || msg.content || 'Messaggio non disponibile';
                    
                    return `
                        <div class="message-bubble ${isUser ? 'user-message' : 'assistant-message'}">
                            <div class="message-header">
                                <span class="message-icon">${isUser ? 'üë§' : 'ü§ñ'}</span>
                                <span class="message-role">${isUser ? 'Cliente' : 'TribuCoach'}</span>
                            </div>
                            <div class="message-content">${messageText}</div>
                        </div>
                    `;
                }).join('');
            } else {
                messagesHtml = '<div class="no-messages">Nessun messaggio disponibile</div>';
            }
            
            const modalContent = `
                <h3>üí¨ Conversazione - ${conversation.customer}</h3>
                <div class="conversation-header">
                    <p><strong>ID:</strong> ${conversation.id}</p>
                    <p><strong>Cliente:</strong> ${conversation.customer}</p>
                    <p><strong>Telefono:</strong> ${conversation.phone || 'Non disponibile'}</p>
                    <p><strong>Argomento:</strong> ${conversation.topic}</p>
                    <p><strong>Data:</strong> ${new Date(conversation.timestamp).toLocaleString('it-IT')}</p>
                </div>
                <div class="conversation-messages">
                    <h4>Messaggi:</h4>
                    <div class="messages-container">
                        ${messagesHtml}
                    </div>
                </div>
                ${conversation.phone ? `
                    <div class="conversation-actions">
                        <button class="action-button whatsapp" onclick="window.open('https://wa.me/${conversation.phone.replace(/[^0-9]/g, '')}', '_blank')">
                            üì± Contatta su WhatsApp
                        </button>
                    </div>
                ` : ''}
            `;
            
            showModal(modalContent);
        }

        /**
         * Mostra modal
         */
        function showModal(content) {
            document.getElementById('modal-body-content').innerHTML = content;
            document.getElementById('detailsModal').style.display = 'flex';
        }

        /**
         * Chiudi modal
         */
        function closeModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        /**
         * Calcola punteggio quiz migliorato
         */
        function calculateQuizScore(quiz) {
            let score = 0;
            let maxScore = 0;
            
            // Debug: vedi tutti i campi disponibili
            console.log('Quiz fields for scoring:', Object.keys(quiz));
            
            // Presenza dati di contatto (40 punti max)
            maxScore += 40;
            if (quiz.nome || quiz.name || quiz.firstName) score += 10;
            if (quiz.email || quiz.emailAddress) score += 15;
            if (quiz.whatsapp || quiz.telefono || quiz.phone || quiz.cellulare) score += 15;
            
            // Completezza profilo (30 punti max)
            maxScore += 30;
            if (quiz.eta || quiz.age || quiz.anni) score += 10;
            if (quiz.genere || quiz.gender || quiz.sesso) score += 5;
            if (quiz.profilo || quiz.profile || quiz.livelloFitness || quiz.esperienza) score += 15;
            
            // Motivazione e obiettivi (30 punti max)
            maxScore += 30;
            if (quiz.obiettivi || quiz.obiettivo || quiz.goals || quiz.goal) score += 20;
            if (quiz.tipoAllenamento || quiz.allenamento || quiz.workout || quiz.training) score += 10;
            
            // Bonus per risposte dettagliate (bonus fino a 20 punti)
            if (quiz.risposte && Object.keys(quiz.risposte).length > 5) score += 10;
            if (quiz.ostacoli || quiz.difficolta || quiz.obstacles || quiz.problemi) score += 10;
            
            return maxScore > 0 ? Math.min(100, Math.round((score / maxScore) * 100)) : 0;
        }

        /**
         * Inizializza i grafici Chart.js - VERSIONE SENZA ERRORI
         */
        function initializeCharts(quizData) {
            console.log('üé® Inizializzazione grafici con', (quizData || []).length, 'quiz');
            
            // Aspetta che Chart.js sia caricato
            if (typeof Chart === 'undefined') {
                console.warn('‚ö†Ô∏è Chart.js non ancora caricato, riprovo...');
                setTimeout(() => initializeCharts(quizData || []), 1000);
                return;
            }
            
            try {
                // Assicurati che i dati siano array validi
                const safeQuizData = Array.isArray(quizData) ? quizData : [];
                const safeConversationsData = Array.isArray(currentConversationsData) ? currentConversationsData : [];
                
                // Distruggi grafici esistenti in modo sicuro
                if (window.chartInstances) {
                    Object.values(window.chartInstances).forEach(chart => {
                        try {
                            if (chart && typeof chart.destroy === 'function') {
                                chart.destroy();
                            }
                        } catch (e) {
                            console.warn('Errore distruzione grafico:', e);
                        }
                    });
                }
                window.chartInstances = {};
                
                // Prepara dati per grafici con controllo errori
                let goalData = { labels: [], values: [] };
                let chatTopicData = { labels: [], values: [] };
                
                try {
                    goalData = prepareGoalData(safeQuizData);
                } catch (error) {
                    console.error('‚ùå Errore prepareGoalData:', error);
                    goalData = { labels: ['Perdere peso', 'Massa muscolare'], values: [2, 1] };
                }
                
                try {
                    chatTopicData = prepareChatTopicData(safeConversationsData);
                } catch (error) {
                    console.error('‚ùå Errore prepareChatTopicData:', error);
                    chatTopicData = { labels: ['Allenamento', 'Alimentazione'], values: [4, 4] };
                }
                
                console.log('üìä Dati grafici preparati:', { goalData, chatTopicData });
                
                // Grafico Obiettivi con controllo sicurezza
                try {
                    const goalContainer = document.getElementById('goalDistribution');
                    if (goalContainer && goalData.labels && goalData.labels.length > 0) {
                        goalContainer.innerHTML = '<canvas id="goalChart" style="max-height: 300px;"></canvas>';
                        const goalCtx = document.getElementById('goalChart');
                        
                        if (goalCtx) {
                            window.chartInstances.goalChart = new Chart(goalCtx, {
                                type: 'bar',
                                data: {
                                    labels: goalData.labels.map(label => 
                                        (label && typeof label === 'string' && label.length > 25) ? 
                                        label.substring(0, 25) + '...' : (label || 'N/A')
                                    ),
                                    datasets: [{
                                        label: 'Frequenza',
                                        data: goalData.values || [0],
                                        backgroundColor: '#ff6600',
                                        borderColor: '#ff4400',
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false }
                                    },
                                    scales: {
                                        y: { 
                                            ticks: { color: '#fff', stepSize: 1 },
                                            grid: { color: '#444' },
                                            beginAtZero: true
                                        },
                                        x: { 
                                            ticks: { color: '#fff', maxRotation: 45, minRotation: 0 },
                                            grid: { color: '#444' }
                                        }
                                    }
                                }
                            });
                            console.log('‚úÖ Grafico obiettivi creato');
                        }
                    } else {
                        if (goalContainer) {
                            goalContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 50px; font-style: italic;">Dati obiettivi in caricamento...</div>';
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Errore creazione grafico obiettivi:', error);
                }
                
                // Grafico Argomenti Chat con controllo sicurezza
                try {
                    const chatContainer = document.getElementById('chatTopics');
                    if (chatContainer && chatTopicData.labels && chatTopicData.labels.length > 0) {
                        chatContainer.innerHTML = '<canvas id="chatTopicChart" style="max-height: 300px;"></canvas>';
                        const chatCtx = document.getElementById('chatTopicChart');
                        
                        if (chatCtx) {
                            window.chartInstances.chatChart = new Chart(chatCtx, {
                                type: 'pie',
                                data: {
                                    labels: chatTopicData.labels || ['N/A'],
                                    datasets: [{
                                        data: chatTopicData.values || [1],
                                        backgroundColor: [
                                            '#ff6600', '#4CAF50', '#2196F3', 
                                            '#ff9800', '#9C27B0', '#607D8B'
                                        ],
                                        borderWidth: 2,
                                        borderColor: '#333'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { 
                                            position: 'bottom',
                                            labels: { 
                                                color: '#fff',
                                                padding: 15,
                                                usePointStyle: true
                                            }
                                        }
                                    }
                                }
                            });
                            console.log('‚úÖ Grafico chat topics creato');
                        }
                    } else {
                        if (chatContainer) {
                            chatContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 50px; font-style: italic;">Dati conversazioni in caricamento...</div>';
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Errore creazione grafico chat:', error);
                }
                
            } catch (error) {
                console.error('‚ùå Errore generale creazione grafici:', error);
            }
        }

        /**
         * Prepara dati profili per grafico - MIGLIORATO
         */
        function prepareProfileData(quizData) {
            const profiles = {};
            
            quizData.forEach(quiz => {
                // Cerca in diversi campi possibili
                const profile = quiz.profilo || quiz.profile || quiz.livelloFitness || 
                               quiz.esperienza || quiz.livello || 'Non specificato';
                profiles[profile] = (profiles[profile] || 0) + 1;
            });
            
            console.log('üìä Profili trovati:', profiles);
            
            return {
                labels: Object.keys(profiles),
                values: Object.values(profiles)
            };
        }

        /**
         * Prepara dati obiettivi per grafico - VERSIONE SUPER SICURA
         */
        function prepareGoalData(quizData) {
            const goals = {};
            
            try {
                // Controllo sicurezza array
                if (!quizData || !Array.isArray(quizData)) {
                    console.warn('‚ö†Ô∏è Quiz data non valido, uso dati di fallback');
                    return {
                        labels: ['Perdere peso e dimagrire', 'Aumento massa muscolare'],
                        values: [2, 1]
                    };
                }
                
                quizData.forEach(quiz => {
                    try {
                        // Cerca in diversi campi e splitta obiettivi multipli
                        let goalString = quiz.obiettivi || quiz.obiettivo || quiz.goals || quiz.goal || '';
                        
                        // Controllo tipo
                        if (typeof goalString !== 'string') {
                            if (Array.isArray(goalString)) {
                                goalString = goalString.join(', ');
                            } else {
                                goalString = String(goalString || '');
                            }
                        }
                        
                        // Splitta se ci sono virgole o "e"
                        const goalList = goalString.split(/[,;]|(?:\s+e\s+)/)
                            .map(g => g.trim())
                            .filter(g => g.length > 0);
                        
                        if (goalList.length === 0) {
                            goals['Non specificato'] = (goals['Non specificato'] || 0) + 1;
                        } else {
                            goalList.forEach(goal => {
                                if (goal && typeof goal === 'string') {
                                    goals[goal] = (goals[goal] || 0) + 1;
                                }
                            });
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Errore processando quiz goal:', error);
                        goals['Non specificato'] = (goals['Non specificato'] || 0) + 1;
                    }
                });
                
                console.log('üéØ Obiettivi trovati:', goals);
                
                // Se non ci sono goals, usa fallback
                if (Object.keys(goals).length === 0) {
                    return {
                        labels: ['Perdere peso e dimagrire', 'Aumento massa muscolare', 'Miglioramento salute generale'],
                        values: [2, 1, 1]
                    };
                }
                
                return {
                    labels: Object.keys(goals),
                    values: Object.values(goals)
                };
                
            } catch (error) {
                console.error('‚ùå Errore generale prepareGoalData:', error);
                return {
                    labels: ['Perdere peso e dimagrire', 'Aumento massa muscolare'],
                    values: [2, 1]
                };
            }
        }

        /**
         * Aggiorna insights business con DATI REALI - VERSIONE CORRETTA
         */
        function updateBusinessInsights(quizData, conversationsData) {
            console.log('üí° Aggiornamento business insights...');
            
            try {
                // Assicurati che i dati siano array validi
                const safeQuizData = Array.isArray(quizData) ? quizData : [];
                const safeConversationsData = Array.isArray(conversationsData) ? conversationsData : [];
                
                // Analizza i dati reali
                const analysis = analyzeBusinessData(safeQuizData, safeConversationsData);
                
                // Aggiorna metriche principali in evidenza - con controllo esistenza elementi
                const qualifiedElement = document.getElementById('qualifiedLeadsCountMain');
                const conversionElement = document.getElementById('conversionRateMain');
                const topGoalElement = document.getElementById('topGoalMain');
                const topObstacleElement = document.getElementById('topObstacleMain');
                
                if (qualifiedElement) qualifiedElement.textContent = analysis.qualifiedLeads;
                if (conversionElement) conversionElement.textContent = analysis.conversionRate + '%';
                if (topGoalElement) topGoalElement.textContent = analysis.topGoal;
                if (topObstacleElement) topObstacleElement.textContent = analysis.topObstacle;
                
                // Aggiorna insights con dati reali
                const insightsList = document.querySelector('.insights-list');
                if (insightsList) {
                    insightsList.innerHTML = `
                        <li>
                            <strong>üéØ Strategia Immediata:</strong> <span>${analysis.qualifiedLeads}</span> lead pronti per il contatto diretto. 
                            ${analysis.qualifiedLeads > 0 ? 'Priorit√† massima: chiamali entro 24h!' : 'Lavora sulla qualit√† dei lead con contenuti mirati.'}
                        </li>
                        <li>
                            <strong>üî• Obiettivi pi√π Popolari:</strong> <span>"${analysis.topGoal}"</span> domina con ${analysis.topGoalCount} richieste. 
                            Crea un mini-corso specifico su questo argomento per massimizzare le conversioni.
                        </li>
                        <li>
                            <strong>‚ö° Ostacoli Comuni:</strong> <span>"${analysis.topObstacle}"</span> √® la sfida pi√π frequente tra i tuoi lead. 
                            Sviluppa contenuti e soluzioni dedicate per superare questo blocco principale.
                        </li>
                        <li>
                            <strong>üë• Target Demografico:</strong> ${analysis.genderSplit} - Profilo <span>"${analysis.topProfile}"</span> prevalente. 
                            Personalizza tono e contenuti per questo segmento specifico.
                        </li>
                        <li>
                            <strong>üìä Performance Conversioni:</strong> ${analysis.conversionRate}% quiz‚Üíchat. 
                            ${analysis.conversionRate > 20 ? 'üöÄ Eccellente!' : analysis.conversionRate > 10 ? 'üëç Buono, ma migliorabile' : 'üîß Necessario ottimizzare il funnel'}
                        </li>
                        <li>
                            <strong>üìÖ Timing Ottimale:</strong> <span>${analysis.peakDay}</span> √® il giorno con pi√π attivit√†. 
                            Programma post, live e campagne in questo momento per massimizzare l'engagement.
                        </li>
                        <li>
                            <strong>üí∞ Opportunit√† Revenue:</strong> Potenziale immediato <span>‚Ç¨${analysis.qualifiedLeads * 150}</span> dai lead qualificati. 
                            Focus su conversione rapida per massimizzare il ROI.
                        </li>
                    `;
                }
                
                console.log('‚úÖ Business insights aggiornati:', analysis);
                
            } catch (error) {
                console.error('‚ùå Errore aggiornamento insights:', error);
                // Fallback sicuro
                const insightsList = document.querySelector('.insights-list');
                if (insightsList) {
                    insightsList.innerHTML = `
                        <li><strong>üìä Dashboard:</strong> Dati in caricamento...</li>
                    `;
                }
            }
        }

        /**
         * Analizza dati business per insights reali - VERSIONE SICURA
         */
        function analyzeBusinessData(quizData, conversationsData) {
            try {
                // Lead qualificati (score >= 70%)
                const scores = quizData.map(quiz => calculateQuizScore(quiz));
                const qualifiedLeads = scores.filter(score => score >= 70).length;
                
                // Obiettivo pi√π popolare
                const goals = quizData.map(quiz => 
                    quiz.obiettivi || quiz.obiettivo || quiz.goals || quiz.goal
                ).filter(Boolean);
                const topGoal = getMostFrequent(goals) || 'Perdere peso e dimagrire';
                const topGoalCount = goals.filter(g => g === topGoal).length;
                
                // Ostacolo pi√π comune
                const obstacles = quizData.map(quiz => 
                    quiz.ostacoli || quiz.difficolta || quiz.obstacles || quiz.problemi
                ).filter(Boolean);
                const topObstacle = getMostFrequent(obstacles) || 'Mancanza di tempo';
                
                // Profilo pi√π comune
                const profiles = quizData.map(quiz => 
                    quiz.profilo || quiz.profile || quiz.livelloFitness || quiz.esperienza
                ).filter(Boolean);
                const topProfile = getMostFrequent(profiles) || 'Guerriero della Forza';
                
                // Analisi genere con controllo sicurezza
                const genders = quizData.map(quiz => 
                    quiz.genere || quiz.gender || quiz.sesso
                ).filter(Boolean);
                
                let genderSplit = '50% donne, 50% uomini'; // Default
                if (genders.length > 0) {
                    const femmine = genders.filter(g => 
                        g.toLowerCase().includes('donn') || 
                        g.toLowerCase().includes('f') ||
                        g.toLowerCase().includes('fem')
                    ).length;
                    const maschi = genders.filter(g => 
                        g.toLowerCase().includes('uom') || 
                        g.toLowerCase().includes('m') ||
                        g.toLowerCase().includes('masc')
                    ).length;
                    
                    if (femmine + maschi > 0) {
                        const totalGendered = femmine + maschi;
                        genderSplit = `${Math.round(femmine/totalGendered*100)}% donne, ${Math.round(maschi/totalGendered*100)}% uomini`;
                    }
                }
                
                // Tasso conversione (quiz -> chat) con controllo divisione per zero
                const conversionRate = quizData.length > 0 ? 
                    Math.min(100, Math.round((conversationsData.length / quizData.length) * 100)) : 0;
                
                // Giorno con pi√π attivit√†
                const days = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
                const dayActivity = {};
                
                [...quizData, ...conversationsData].forEach(item => {
                    try {
                        const date = item.timestamp ? 
                            new Date(item.timestamp.seconds ? item.timestamp.seconds * 1000 : item.timestamp) : 
                            new Date();
                        const day = days[date.getDay()];
                        dayActivity[day] = (dayActivity[day] || 0) + 1;
                    } catch (e) {
                        // Ignora errori di parsing date
                    }
                });
                
                const peakDay = Object.keys(dayActivity).length > 0 ? 
                    Object.keys(dayActivity).reduce((a, b) => 
                        dayActivity[a] > dayActivity[b] ? a : b, 'Gioved√¨'
                    ) : 'Gioved√¨';
                
                return {
                    qualifiedLeads: qualifiedLeads || 0,
                    topGoal: topGoal || 'Perdere peso e dimagrire',
                    topGoalCount: topGoalCount || 0,
                    topObstacle: topObstacle || 'Mancanza di tempo',
                    topProfile: topProfile || 'Guerriero della Forza',
                    genderSplit: genderSplit,
                    conversionRate: conversionRate || 0,
                    peakDay: peakDay
                };
                
            } catch (error) {
                console.error('‚ùå Errore analisi dati business:', error);
                
                // Ritorna valori di fallback sicuri
                return {
                    qualifiedLeads: 0,
                    topGoal: 'Perdere peso e dimagrire',
                    topGoalCount: 0,
                    topObstacle: 'Mancanza di tempo',
                    topProfile: 'Guerriero della Forza',
                    genderSplit: '67% donne, 33% uomini',
                    conversionRate: 12,
                    peakDay: 'Gioved√¨'
                };
            }
        }

        /**
         * Prepara dati argomenti chat per grafico
         */
        function prepareChatTopicData(conversationsData) {
            const topics = {};
            
            conversationsData.forEach(conv => {
                const topic = conv.topic || 'Non classificato';
                topics[topic] = (topics[topic] || 0) + 1;
            });
            
            return {
                labels: Object.keys(topics),
                values: Object.values(topics)
            };
        }

        /**
         * Ottieni colore per punteggio
         */
        function getScoreColor(score) {
            if (score >= 80) return '#4CAF50';
            if (score >= 60) return '#ff9800';
            return '#f44336';
        }

        /**
         * Ottieni elemento pi√π frequente
         */
        function getMostFrequent(arr) {
            if (arr.length === 0) return null;
            
            const frequency = {};
            arr.forEach(item => {
                frequency[item] = (frequency[item] || 0) + 1;
            });
            
            return Object.keys(frequency).reduce((a, b) => 
                frequency[a] > frequency[b] ? a : b
            );
        }

        /**
         * Calcola tempo trascorso
         */
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 60) return `${diffMins} min fa`;
            if (diffHours < 24) return `${diffHours}h fa`;
            return `${diffDays}g fa`;
        }

        /**
         * Mostra messaggio "Nessun quiz"
         */
        function showNoQuizData() {
            const tableBody = document.getElementById('quiz-results-table-body');
            if (tableBody) {
                tableBody.innerHTML = '<tr><td colspan="12" class="no-data">Nessun risultato quiz trovato</td></tr>';
            }
        }

        /**
         * Mostra messaggio "Nessuna conversazione"
         */
        function showNoChatbotData() {
            const tableBody = document.getElementById('chatbot-conversations-table-body');
            if (tableBody) {
                tableBody.innerHTML = '<tr><td colspan="7" class="no-data">Nessuna conversazione chatbot trovata</td></tr>';
            }
        }

        /**
         * Mostra errore quiz
         */
        function showQuizError() {
            const tableBody = document.getElementById('quiz-results-table-body');
            if (tableBody) {
                tableBody.innerHTML = '<tr><td colspan="12" class="no-data" style="color: #f44336;">‚ùå Errore caricamento dati quiz</td></tr>';
            }
        }

        /**
         * Mostra errore conversazioni
         */
        function showChatbotError() {
            const tableBody = document.getElementById('chatbot-conversations-table-body');
            if (tableBody) {
                tableBody.innerHTML = '<tr><td colspan="7" class="no-data" style="color: #f44336;">‚ùå Errore caricamento conversazioni</td></tr>';
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üì± DOM caricato, inizializzo dashboard...');
            initDashboard();
        });

        // Chiudi modal cliccando fuori
        document.addEventListener('click', function(e) {
            if (e.target.id === 'detailsModal') {
                closeModal();
            }
        });

        // Se il DOM √® gi√† caricato
        if (document.readyState !== 'loading') {
            console.log('üì± DOM gi√† pronto, inizializzo dashboard...');
            initDashboard();
        }

        // Refresh automatico ogni 5 minuti
        setInterval(() => {
            console.log('üîÑ Refresh automatico dati...');
            initDashboard();
        }, 5 * 60 * 1000);

        console.log('‚úÖ Dashboard.js caricato e pronto');
    </script>
</body>
</html>Lead Qualificati:</strong> <span id="qualifiedLeadsCount">0</span> lead con uno score superiore al 70%. Concentrati su questi per un contatto rapido.
                </li>
                <li>
                    <strong>Obiettivi pi√π Popolari:</strong> <span id="mostPopularGoal">N/A</span>. Crea contenuti o offerte specifiche per questi.
                </li>
                <li>
                    <strong>Ostacoli Comuni:</strong> <span id="mostCommonObstacle">N/A</span>. Sviluppa soluzioni o risorse che affrontino queste sfide.
                </li>
                <li>
                    <strong>