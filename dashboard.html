<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TribuCoach Dashboard - Business Intelligence</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
            color: #fff;
            min-height: 100vh;
            margin-top: 50px;
        }

        .connection-status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9rem;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .status-connected {
            background: #4CAF50;
            color: white;
            animation: slideDown 0.5s ease;
        }

        .status-connecting {
            background: #ff9800;
            color: white;
            animation: pulse 1.5s infinite;
        }

        .status-error {
            background: #f44336;
            color: white;
            animation: shake 0.5s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .header {
            background: rgba(255,102,0,0.1);
            padding: 20px;
            border-bottom: 2px solid #ff6600;
        }

        .header h1 {
            color: #ff6600;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #ccc;
            font-size: 1rem;
        }

        .dashboard {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background-color: #1c1c1c;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border-left: 5px solid #ff6600;
        }

        .metric-card h3 {
            color: #ff9933;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .metric-card .value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ff6600;
            margin-bottom: 5px;
        }

        .metric-card .trend {
            font-size: 0.9rem;
            color: #bbb;
            display: flex;
            align-items: center;
        }

        .metric-card .trend.positive {
            color: #4CAF50;
        }

        .metric-card .trend.negative {
            color: #F44336;
        }

        .metric-card .trend .icon {
            margin-right: 5px;
        }

        .dashboard-section {
            background-color: #1c1c1c;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
        }

        .dashboard-section h2 {
            color: #ff6600;
            font-size: 1.8rem;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        .lead-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
        }

        .lead-tab {
            background: none;
            border: none;
            color: #ccc;
            padding: 15px 25px;
            cursor: pointer;
            font-size: 1rem;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .lead-tab.active {
            color: #ff6600;
            border-bottom-color: #ff6600;
        }

        .lead-tab:hover {
            color: #ff9933;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #333;
            color: #eee;
        }

        .data-table th {
            background-color: #2a2a2a;
            color: #ff9933;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .data-table tbody tr:hover {
            background-color: #2a2a2a;
        }

        .no-data {
            text-align: center;
            font-style: italic;
            color: #888;
            padding: 20px;
        }

        .lead-score {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            min-width: 60px;
            text-align: center;
        }

        .lead-score.low {
            background-color: rgba(244, 67, 54, 0.2);
            color: #F44336;
        }

        .lead-score.medium {
            background-color: rgba(255, 152, 0, 0.2);
            color: #FF9800;
        }

        .lead-score.high {
            background-color: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }

        .action-btn {
            background-color: #ff6600;
            color: #fff;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s ease;
            margin-right: 5px;
        }

        .action-btn:hover {
            background-color: #e65c00;
        }

        .refresh-section {
            text-align: right;
            margin-bottom: 20px;
            color: #ccc;
            font-size: 0.9rem;
        }

        .refresh-btn {
            background: none;
            border: none;
            color: #ff6600;
            font-size: 1.5rem;
            cursor: pointer;
            margin-left: 10px;
            transition: transform 0.2s ease;
        }

        .refresh-btn:hover {
            transform: rotate(30deg);
        }

        .chat-analytics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .analytics-card {
            background: rgba(255,102,0,0.05);
            border: 1px solid rgba(255,102,0,0.2);
            border-radius: 10px;
            padding: 20px;
        }

        .analytics-card h4 {
            color: #ff6600;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .analytics-list {
            list-style: none;
        }

        .analytics-list li {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
        }

        .conversation-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-completed {
            background: #4CAF50;
            color: white;
        }

        .status-ongoing {
            background: #ff9800;
            color: white;
        }

        .status-abandoned {
            background: #f44336;
            color: white;
        }

        .opportunity-card {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4CAF50;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }

        .opportunity-card h4 {
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .opportunity-card .priority {
            background: #4CAF50;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        .opportunity-card .priority.high {
            background: #f44336;
        }

        .opportunity-card .priority.medium {
            background: #ff9800;
        }

        .real-time-indicator {
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .setup-instructions {
            background: rgba(255,102,0,0.1);
            border: 1px solid #ff6600;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .setup-instructions h3 {
            color: #ff6600;
            margin-bottom: 15px;
        }

        .setup-instructions pre {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .dashboard {
                padding: 15px;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .data-table th, .data-table td {
                padding: 8px 10px;
                font-size: 0.8rem;
            }

            .lead-tabs {
                flex-direction: column;
            }

            .chat-analytics {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status status-connecting" id="connection-status">
        üîÑ Inizializzazione Dashboard...
    </div>

    <div class="header">
        <h1>Dashboard Analitica TribuCoach</h1>
        <p>Monitora i tuoi lead quiz, conversazioni chatbot e metriche chiave in tempo reale.</p>
    </div>

    <div class="dashboard">
        <div class="refresh-section">
            <span class="real-time-indicator"></span>Configurazione Richiesta
            Ultimo aggiornamento: <span id="last-update">Mai</span>
            <button class="refresh-btn" onclick="refreshData()">üîÑ</button>
            <button class="action-btn" onclick="exportLeadsToCSV()">üìä Export CSV</button>
        </div>

        <!-- Istruzioni Setup Firebase -->
        <div class="setup-instructions">
            <h3>üîß Configurazione Firebase Richiesta</h3>
            <p>Per vedere i dati reali, devi configurare Firebase. Le collections da usare sono:</p>
            <ul style="margin: 10px 0; padding-left: 20px;">
                <li><strong>quiz_results</strong> - Per i lead da quiz fitness</li>
                <li><strong>user_sessions</strong> o <strong>chatbot_conversations</strong> - Per le chat del bot</li>
                <li><strong>analytics_events</strong> - Per eventi e tracking</li>
            </ul>
            <p>Problema rilevato: Firebase SDK non si carica (possibile blocco di rete/AdBlocker)</p>
        </div>

        <!-- Metriche Principali -->
        <div class="metrics-grid">
            <div class="metric-card">
                <h3>Quiz Lead</h3>
                <div class="value" id="total-quiz-leads">0</div>
                <div class="trend positive" id="quiz-leads-trend">
                    <span class="icon">üéØ</span><span class="percentage">0%</span> Configurare Firebase
                </div>
            </div>
            <div class="metric-card">
                <h3>Chat Lead</h3>
                <div class="value" id="total-chat-leads">0</div>
                <div class="trend positive" id="chat-leads-trend">
                    <span class="icon">üí¨</span><span class="percentage">0%</span> Configurare Firebase
                </div>
            </div>
            <div class="metric-card">
                <h3>Lead Totali</h3>
                <div class="value" id="total-leads">0</div>
                <div class="trend positive" id="leads-trend">
                    <span class="icon">üìà</span><span class="percentage">0%</span> Configurare Firebase
                </div>
            </div>
            <div class="metric-card">
                <h3>Conversioni Quiz</h3>
                <div class="value" id="quiz-conversion">-</div>
                <div class="trend positive" id="quiz-conversion-trend">
                    <span class="icon">üéØ</span><span class="percentage">0%</span> Score medio
                </div>
            </div>
            <div class="metric-card">
                <h3>Durata Media Chat</h3>
                <div class="value" id="avg-chat-duration">-</div>
                <div class="trend positive" id="chat-duration-trend">
                    <span class="icon">‚è±Ô∏è</span><span class="percentage">0</span> messaggi medi
                </div>
            </div>
            <div class="metric-card">
                <h3>Lead Oggi</h3>
                <div class="value" id="daily-leads">0</div>
                <div class="trend positive" id="daily-leads-trend">
                    <span class="icon">üìÖ</span><span class="percentage">0</span> nelle ultime 24h
                </div>
            </div>
        </div>

        <!-- Gestione Lead con Tabs -->
        <div class="dashboard-section">
            <h2>üìä Gestione Lead Completa</h2>
            
            <div class="lead-tabs">
                <button class="lead-tab active" onclick="switchTab('quiz')">üéØ Quiz Lead</button>
                <button class="lead-tab" onclick="switchTab('chat')">üí¨ Chat Lead</button>
                <button class="lead-tab" onclick="switchTab('analytics')">üìà Analytics Chat</button>
            </div>

            <!-- Tab Quiz Lead -->
            <div id="quiz-tab" class="tab-content active">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>WhatsApp/Email</th>
                            <th>Et√†</th>
                            <th>Profilo</th>
                            <th>Score</th>
                            <th>Obiettivi</th>
                            <th>Ostacoli</th>
                            <th>Data</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="quiz-leads-table">
                        <tr><td colspan="9" class="no-data">‚öôÔ∏è Configurare Firebase per vedere i lead quiz reali</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Tab Chat Lead -->
            <div id="chat-tab" class="tab-content">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>WhatsApp</th>
                            <th>Et√†</th>
                            <th>Esigenze</th>
                            <th>Interessi</th>
                            <th>Messaggi</th>
                            <th>Stato</th>
                            <th>Data</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="chat-leads-table">
                        <tr><td colspan="9" class="no-data">‚öôÔ∏è Configurare Firebase per vedere le chat reali</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Tab Analytics Chat -->
            <div id="analytics-tab" class="tab-content">
                <div class="chat-analytics">
                    <div class="analytics-card">
                        <h4>üî• Domande Pi√π Frequenti</h4>
                        <ul class="analytics-list" id="frequent-questions">
                            <li>Configurare Firebase per dati reali</li>
                        </ul>
                    </div>
                    
                    <div class="analytics-card">
                        <h4>üéØ Esigenze Principali</h4>
                        <ul class="analytics-list" id="main-needs">
                            <li>Configurare Firebase per dati reali</li>
                        </ul>
                    </div>
                    
                    <div class="analytics-card">
                        <h4>üë• Demografia Et√†</h4>
                        <ul class="analytics-list" id="age-demographics">
                            <li>Configurare Firebase per dati reali</li>
                        </ul>
                    </div>
                    
                    <div class="analytics-card">
                        <h4>üí™ Interessi Fitness</h4>
                        <ul class="analytics-list" id="fitness-interests">
                            <li>Configurare Firebase per dati reali</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Opportunit√† Business -->
        <div class="dashboard-section">
            <h2>üíº Opportunit√† Business</h2>
            <div id="business-opportunities">
                <div class="no-data">‚öôÔ∏è Configurare Firebase per vedere le opportunit√† business</div>
            </div>
        </div>
    </div>

    <!-- Istruzioni per Firebase -->
    <div class="setup-instructions" style="margin: 20px; padding: 20px; background: rgba(255,102,0,0.1); border: 1px solid #ff6600; border-radius: 10px;">
        <h3 style="color: #ff6600; margin-bottom: 15px;">üîß Configurazione Firebase Manuale</h3>
        <p><strong>Problema:</strong> Firebase SDK non si carica in questo ambiente.</p>
        <p><strong>Soluzione:</strong> Scarica la dashboard e carica su tuo server/hosting con Firebase configurato.</p>
        
        <details style="margin-top: 15px;">
            <summary style="cursor: pointer; color: #ff6600; font-weight: bold;">üìã Codice Firebase da Aggiungere</summary>
            <pre style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 0.9rem; margin-top: 10px;">
// Aggiungi prima del tag &lt;/body&gt;
&lt;script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"&gt;&lt;/script&gt;
&lt;script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"&gt;&lt;/script&gt;

&lt;script&gt;
// La tua configurazione Firebase
const firebaseConfig = {
    apiKey: "AIzaSyDSsQEPii_Eb99cWGs7eqozgTtIqbtO2rs",
    authDomain: "tribucoach-a2254.firebaseapp.com",
    projectId: "tribucoach-a2254",
    storageBucket: "tribucoach-a2254.firebasestorage.app",
    messagingSenderId: "425200296836",
    appId: "1:425200296836:web:7835188f40f4348567ab48"
};

// Inizializza Firebase
firebase.initializeApp(firebaseConfig);
window.db = firebase.firestore();

// Abilita caricamento dati reali
window.FIREBASE_ENABLED = true;
&lt;/script&gt;
            </pre>
        </details>
    </div>

    <script>
        // === DASHBOARD IBRIDA (Funziona con/senza Firebase) ===
        let dashboardData = {
            quizResults: [],
            chatConversations: [],
            users: [],
            events: [],
            metrics: {}
        };

        // Flag per Firebase
        const FIREBASE_ENABLED = window.FIREBASE_ENABLED || false;
        const db = window.db || null;

        // === DATI MOCK PER DEMO ===
        const MOCK_QUIZ_DATA = [
            {
                id: 'demo_1',
                name: 'Andrea Padoan',
                email: 'andrea.padoan@gmail.com',
                whatsapp: '+393401234567',
                age: '48',
                gender: 'Uomo',
                score: 70,
                goals: ['Perdere peso e dimagrire'],
                activity_level: 'Leggermente attivo (1-2 allenamenti leggeri)',
                diet: 'Scarsa (molti cibi processati, poca frutta/verdura)',
                breakfast_habit: 'Qualche volta',
                eating_out: '1-2 volte',
                comparison: 'S√¨, spesso',
                morning_energy: 'Spesso',
                active_breaks: 'Una volta al giorno',
                devices_before_sleep: 'Qualche volta',
                timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000)
            },
            {
                id: 'demo_2',
                name: 'Marco Rossi',
                email: 'marco.rossi@email.com',
                whatsapp: '+393331234567',
                age: '35',
                gender: 'Uomo',
                score: 85,
                goals: ['Aumentare massa muscolare', 'Migliorare forza'],
                activity_level: 'Molto attivo (5+ allenamenti intensi)',
                diet: 'Buona (equilibrata, frutta e verdura quotidiane)',
                breakfast_habit: 'Sempre',
                eating_out: 'Raramente',
                comparison: 'No, mai',
                morning_energy: 'Sempre',
                active_breaks: 'Pi√π volte al giorno',
                devices_before_sleep: 'Raramente',
                timestamp: new Date(Date.now() - 5 * 60 * 60 * 1000)
            },
            {
                id: 'demo_3',
                name: 'Sofia Verdi',
                email: 'sofia.verdi@email.com',
                whatsapp: '+393339876543',
                age: '29',
                gender: 'Donna',
                score: 65,
                goals: ['Tonificare', 'Migliorare benessere generale'],
                activity_level: 'Moderatamente attivo (3-4 allenamenti medi)',
                diet: 'Media (abbastanza equilibrata, qualche sgarro)',
                breakfast_habit: 'Spesso',
                eating_out: '3-4 volte',
                comparison: 'Qualche volta',
                morning_energy: 'Qualche volta',
                active_breaks: 'Qualche volta',
                devices_before_sleep: 'Spesso',
                timestamp: new Date(Date.now() - 1 * 60 * 60 * 1000)
            }
        ];

        // === CARICAMENTO DATI ===
        async function loadQuizResults() {
            if (FIREBASE_ENABLED && db) {
                try {
                    console.log('üìä Caricamento dati reali da Firebase...');
                    const snapshot = await db.collection('quiz_results').orderBy('lead_score', 'desc').limit(50).get();
                    
                    const results = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            name: data.name || 'Anonimo',
                            email: data.email || 'N/A',
                            whatsapp: data.whatsapp || data.phone || 'N/A',
                            age: data.age || 'N/A',
                            gender: data.gender || 'N/A',
                            score: data.lead_score || 0,
                            goals: Array.isArray(data.goals) ? data.goals : (data.goals ? [data.goals] : ['N/A']),
                            activity_level: data.activity_level || 'N/A',
                            diet: data.diet || 'N/A',
                            breakfast_habit: data.breakfast_habit || 'N/A',
                            eating_out: data.eating_out || 'N/A',
                            comparison: data.comparison || 'N/A',
                            morning_energy: data.morning_energy || 'N/A',
                            active_breaks: data.active_breaks || 'N/A',
                            devices_before_sleep: data.devices_before_sleep || 'N/A',
                            timestamp: data.created_at || new Date()
                        };
                    });
                    
                    console.log(`‚úÖ Quiz results Firebase: ${results.length}`);
                    return results;
                } catch (error) {
                    console.error('‚ùå Errore Firebase quiz:', error);
                    return MOCK_QUIZ_DATA;
                }
            } else {
                console.log('üìä Usando dati mock per demo');
                return MOCK_QUIZ_DATA;
            }
        }

        async function loadUserSessions() {
            if (FIREBASE_ENABLED && db) {
                try {
                    const snapshot = await db.collection('user_sessions').orderBy('created_at', 'desc').limit(20).get();
                    return snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        timestamp: doc.data().created_at?.toDate() || new Date()
                    }));
                } catch (error) {
                    console.error('‚ùå Errore Firebase sessions:', error);
                    return [];
                }
            } else {
                return [
                    {
                        id: 'session_1',
                        session_type: 'dashboard',
                        user_id: 'demo_user',
                        device_info: { language: 'it-IT', screen: '1920x1080' },
                        timestamp: new Date()
                    }
                ];
            }
        }

        // === INIZIALIZZAZIONE ===
        async function initializeFirebase() {
            console.log('üîó Inizializzazione Dashboard TribuCoach...');
            
            if (FIREBASE_ENABLED && db) {
                updateConnectionStatus(true, 'Firebase Connesso - Dati Reali');
                console.log('‚úÖ Firebase disponibile');
            } else {
                updateConnectionStatus(false, 'Demo Mode - Dati Mock (Configurare Firebase per dati reali)');
                console.log('üìä Modalit√† demo con dati mock');
            }
            
            try {
                const [quizResults, userSessions] = await Promise.all([
                    loadQuizResults(),
                    loadUserSessions()
                ]);
                
                dashboardData.quizResults = quizResults;
                dashboardData.chatConversations = userSessions;
                
                updateDashboard();
                
                if (FIREBASE_ENABLED) {
                    updateConnectionStatus(true, `Firebase OK - ${quizResults.length} Quiz, ${userSessions.length} Sessions`);
                } else {
                    updateConnectionStatus(false, `Demo Mode - ${quizResults.length} Quiz Mock`);
                }
                
            } catch (error) {
                console.error('‚ùå Errore caricamento dati:', error);
                updateConnectionStatus(false, 'Errore caricamento - Modalit√† Demo');
            }
        }

        // === GESTIONE TABS ===
        function switchTab(tabName) {
            document.querySelectorAll('.lead-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            console.log(`üìã Switched to ${tabName} tab`);
        }

        // === AGGIORNAMENTO DASHBOARD ===
        function updateDashboard() {
            updateMetrics();
            updateQuizLeadsTable();
            updateSessionsTable();
            updateAnalytics();
            updateLastUpdateTime();
        }

        function updateMetrics() {
            const quizLeads = dashboardData.quizResults.length;
            const sessions = dashboardData.chatConversations.length;
            const totalLeads = quizLeads;
            
            // Calcola metriche dai dati reali
            const avgScore = quizLeads > 0 ? 
                (dashboardData.quizResults.reduce((sum, quiz) => sum + (quiz.score || 0), 0) / quizLeads).toFixed(1) : 0;
            
            const highScoreLeads = dashboardData.quizResults.filter(quiz => quiz.score >= 70).length;
            
            // Lead oggi
            const today = new Date().toDateString();
            const todayLeads = dashboardData.quizResults.filter(quiz => 
                new Date(quiz.timestamp).toDateString() === today
            ).length;
            
            updateElement('total-quiz-leads', quizLeads);
            updateElement('total-chat-leads', sessions);
            updateElement('total-leads', totalLeads);
            updateElement('quiz-conversion', `${avgScore}%`);
            updateElement('avg-chat-duration', `${highScoreLeads} alti`);
            updateElement('daily-leads', todayLeads);
            
            console.log(`üìä Metriche aggiornate: ${quizLeads} quiz, ${sessions} sessions`);
        }

        function updateQuizLeadsTable() {
            const tbody = document.getElementById('quiz-leads-table');
            if (!tbody) return;
            
            if (dashboardData.quizResults.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="no-data">Nessun quiz completato trovato</td></tr>';
                return;
            }
            
            const rows = dashboardData.quizResults.map(quiz => {
                const score = quiz.score || 0;
                const scoreClass = score >= 70 ? 'high' : score >= 40 ? 'medium' : 'low';
                const icon = getGenderIcon(quiz.gender);
                
                const goals = Array.isArray(quiz.goals) ? quiz.goals.join(', ') : quiz.goals;
                
                return `
                    <tr>
                        <td>${quiz.name}</td>
                        <td>${quiz.email}</td>
                        <td>${quiz.age}</td>
                        <td>${icon} ${quiz.gender}</td>
                        <td><span class="lead-score ${scoreClass}">${score}</span></td>
                        <td title="${goals}">${goals.length > 30 ? goals.substring(0, 30) + '...' : goals}</td>
                        <td>${quiz.diet}</td>
                        <td>${formatDateTime(quiz.timestamp)}</td>
                        <td>
                            <button class="action-btn" onclick="contactLeadEmail('${quiz.email}', '${quiz.name}')">Email</button>
                            <button class="action-btn" onclick="viewQuizDetails('${quiz.id}')" style="background: #4CAF50;">Dettagli</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rows;
        }

        function updateSessionsTable() {
            const tbody = document.getElementById('chat-leads-table');
            if (!tbody) return;
            
            if (dashboardData.chatConversations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="no-data">Nessuna sessione trovata</td></tr>';
                return;
            }
            
            const rows = dashboardData.chatConversations.map(session => {
                const deviceInfo = session.device_info || {};
                
                return `
                    <tr>
                        <td>${session.user_id}</td>
                        <td>-</td>
                        <td>-</td>
                        <td>${session.session_type}</td>
                        <td>${deviceInfo.language || 'N/A'}</td>
                        <td>1</td>
                        <td><span class="conversation-status status-completed">completata</span></td>
                        <td>${formatDateTime(session.timestamp)}</td>
                        <td>
                            <button class="action-btn" onclick="viewSessionDetails('${session.id}')" style="background: #4CAF50;">Dettagli</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rows;
        }

        function updateAnalytics() {
            // Analytics basate sui dati reali
            const quizData = dashboardData.quizResults;
            
            // Analisi obiettivi
            const goalCounts = {};
            quizData.forEach(quiz => {
                if (quiz.goals && Array.isArray(quiz.goals)) {
                    quiz.goals.forEach(goal => {
                        goalCounts[goal] = (goalCounts[goal] || 0) + 1;
                    });
                }
            });
            
            const topGoals = Object.entries(goalCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            document.getElementById('frequent-questions').innerHTML = 
                topGoals.length > 0 ? 
                topGoals.map(([goal, count]) => `<li><span>${goal}</span><strong>${count}</strong></li>`).join('') :
                '<li>Nessun obiettivo registrato</li>';
            
            // Analisi et√†
            const ageGroups = {
                '18-30': 0,
                '31-45': 0,
                '46-60': 0,
                '60+': 0
            };
            
            quizData.forEach(quiz => {
                const age = parseInt(quiz.age);
                if (age >= 18 && age <= 30) ageGroups['18-30']++;
                else if (age >= 31 && age <= 45) ageGroups['31-45']++;
                else if (age >= 46 && age <= 60) ageGroups['46-60']++;
                else if (age > 60) ageGroups['60+']++;
            });
            
            document.getElementById('age-demographics').innerHTML = 
                Object.entries(ageGroups)
                    .filter(([,count]) => count > 0)
                    .map(([range, count]) => `<li><span>${range} anni</span><strong>${count}</strong></li>`)
                    .join('') || '<li>Nessun dato et√†</li>';
            
            // Analisi livello attivit√†
            const activityCounts = {};
            quizData.forEach(quiz => {
                if (quiz.activity_level) {
                    activityCounts[quiz.activity_level] = (activityCounts[quiz.activity_level] || 0) + 1;
                }
            });
            
            document.getElementById('main-needs').innerHTML = 
                Object.entries(activityCounts)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 3)
                    .map(([activity, count]) => `<li><span>${activity}</span><strong>${count}</strong></li>`)
                    .join('') || '<li>Nessun dato attivit√†</li>';
            
            // Analisi abitudini alimentari
            const dietCounts = {};
            quizData.forEach(quiz => {
                if (quiz.diet) {
                    dietCounts[quiz.diet] = (dietCounts[quiz.diet] || 0) + 1;
                }
            });
            
            document.getElementById('fitness-interests').innerHTML = 
                Object.entries(dietCounts)
                    .sort(([,a], [,b]) => b - a)
                    .map(([diet, count]) => `<li><span>${diet}</span><strong>${count}</strong></li>`)
                    .join('') || '<li>Nessun dato dieta</li>';
        }

        // === UTILITY FUNCTIONS ===
        function updateElement(id, content) {
            const element = document.getElementById(id);
            if (element) {
                element.innerHTML = content;
            }
        }

        function updateLastUpdateTime() {
            const now = new Date().toLocaleTimeString('it-IT');
            updateElement('last-update', now);
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return 'N/A';
            try {
                const date = timestamp instanceof Date ? timestamp : new Date(timestamp);
                return date.toLocaleString('it-IT');
            } catch (error) {
                return 'Data non valida';
            }
        }

        function getGenderIcon(gender) {
            switch(gender) {
                case 'Uomo': return 'üë®';
                case 'Donna': return 'üë©';
                default: return 'üë§';
            }
        }

        function updateConnectionStatus(isConnected, customMessage = null) {
            const statusElement = document.getElementById('connection-status');
            if (statusElement) {
                if (isConnected) {
                    statusElement.className = 'connection-status status-connected';
                    statusElement.innerHTML = customMessage || '‚úÖ Firebase Connesso';
                } else if (customMessage) {
                    statusElement.className = 'connection-status status-connecting';
                    statusElement.innerHTML = `üîÑ ${customMessage}`;
                } else {
                    statusElement.className = 'connection-status status-error';
                    statusElement.innerHTML = '‚ùå Errore connessione';
                }
            }
        }

        // === AZIONI LEAD ===
        function contactLeadEmail(email, name) {
            const subject = encodeURIComponent('TribuCoach - Risultati Quiz Fitness');
            const body = encodeURIComponent(`Ciao ${name},\n\nGrazie per aver completato il nostro quiz fitness!\n\nI tuoi risultati mostrano un grande potenziale. Vorresti una consulenza gratuita per parlare dei tuoi obiettivi?\n\nA presto!\nTeam TribuCoach`);
            window.open(`mailto:${email}?subject=${subject}&body=${body}`);
        }

        function viewQuizDetails(quizId) {
            const quiz = dashboardData.quizResults.find(q => q.id === quizId);
            if (!quiz) {
                alert('Quiz non trovato');
                return;
            }
            
            const details = `üéØ PROFILO COMPLETO: ${quiz.name}
üìß Email: ${quiz.email}
üéÇ Et√†: ${quiz.age} anni (${quiz.gender})
üìä Lead Score: ${quiz.score}/100

üéØ OBIETTIVI:
${Array.isArray(quiz.goals) ? quiz.goals.map(g => `‚Ä¢ ${g}`).join('\n') : quiz.goals}

üí™ LIVELLO ATTIVIT√Ä: ${quiz.activity_level}
üçé ALIMENTAZIONE: ${quiz.diet}
ü•ê COLAZIONE: ${quiz.breakfast_habit}
üçΩÔ∏è MANGIARE FUORI: ${quiz.eating_out}
‚öñÔ∏è CONFRONTI: ${quiz.comparison}
üåÖ ENERGIA MATTUTINA: ${quiz.morning_energy}
üö∂ PAUSE ATTIVE: ${quiz.active_breaks}
üì± DISPOSITIVI PRIMA DI DORMIRE: ${quiz.devices_before_sleep}

üìÖ DATA QUIZ: ${formatDateTime(quiz.timestamp)}`;
            
            showModal('Dettagli Quiz Lead', details, quiz.email);
        }

        function viewSessionDetails(sessionId) {
            const session = dashboardData.chatConversations.find(s => s.id === sessionId);
            if (!session) {
                alert('Sessione non trovata');
                return;
            }
            
            const deviceInfo = session.device_info || {};
            const details = `üíª SESSIONE UTENTE: ${session.user_id}
üìÖ Data: ${formatDateTime(session.timestamp)}
üîó Tipo: ${session.session_type}
üåê Referrer: ${session.referrer || 'Diretto'}

üì± DISPOSITIVO:
‚Ä¢ Lingua: ${deviceInfo.language || 'N/A'}
‚Ä¢ Schermo: ${deviceInfo.screen || 'N/A'}
‚Ä¢ Timezone: ${deviceInfo.timezone || 'N/A'}

üîç ID Sessione: ${session.id}`;
            
            showModal('Dettagli Sessione', details);
        }

        function showModal(title, content, email = null) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                background: rgba(0,0,0,0.9) !important;
                z-index: 99999 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                padding: 20px !important;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 25px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #ff6b35; padding-bottom: 15px;">
                        <h2 style="margin: 0; color: #ff6b35; font-size: 22px;">${title}</h2>
                        <button onclick="this.closest('div').remove(); document.body.style.overflow = 'auto';" style="background: #ff6b35; color: white; border: none; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; font-size: 18px; font-weight: bold;">√ó</button>
                    </div>
                    <pre style="white-space: pre-wrap; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui; font-size: 14px; line-height: 1.6; color: #333; margin: 0;">${content}</pre>
                    <div style="margin-top: 25px; text-align: center; display: flex; gap: 15px; justify-content: center;">
                        <button onclick="this.closest('div').remove(); document.body.style.overflow = 'auto';" style="background: #6c757d; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: 500;">Chiudi</button>
                        ${email ? `<button onclick="contactLeadEmail('${email}', 'Cliente')" style="background: #007bff; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: 500;">üìß Invia Email</button>` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
        }

        // === EXPORT CSV ===
        function exportLeadsToCSV() {
            if (dashboardData.quizResults.length === 0) {
                alert('Nessun dato da esportare');
                return;
            }
            
            const headers = [
                'Nome',
                'Email',
                'Et√†',
                'Genere',
                'Lead Score',
                'Obiettivi',
                'Livello Attivit√†',
                'Alimentazione',
                'Colazione',
                'Mangiare Fuori',
                'Energia Mattutina',
                'Data Quiz'
            ];
            
            const rows = dashboardData.quizResults.map(quiz => [
                quiz.name || '',
                quiz.email || '',
                quiz.age || '',
                quiz.gender || '',
                quiz.score || '',
                Array.isArray(quiz.goals) ? quiz.goals.join('; ') : (quiz.goals || ''),
                quiz.activity_level || '',
                quiz.diet || '',
                quiz.breakfast_habit || '',
                quiz.eating_out || '',
                quiz.morning_energy || '',
                formatDateTime(quiz.timestamp)
            ]);
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `tribucoach-quiz-leads-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`‚úÖ CSV esportato con successo!\n${dashboardData.quizResults.length} lead salvati nel file.`);
        }

        // === REFRESH DATA ===
        function refreshData() {
            if (db) {
                initializeFirebase();
            } else {
                console.log('üîÑ Firebase non disponibile');
                updateLastUpdateTime();
            }
        }

        // === INIZIALIZZAZIONE ===
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inizializzazione Dashboard TribuCoach...');
            
            setTimeout(() => {
                initializeFirebase();
            }, 1000);
            
            setInterval(() => {
                updateLastUpdateTime();
            }, 30000);
            
            console.log('‚úÖ Dashboard inizializzata');
        });

        // Rendi le funzioni globali
        window.switchTab = switchTab;
        window.exportLeadsToCSV = exportLeadsToCSV;
        window.refreshData = refreshData;

    </script>
</body>
</html>