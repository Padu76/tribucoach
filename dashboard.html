<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TribuCoach Dashboard - Chatbase + Firebase</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #2a2a2a 100%);
            color: #fff;
            min-height: 100vh;
            line-height: 1.4;
        }

        .status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .status.loading {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
        }

        .status.connected {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .status.error {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .header {
            background: linear-gradient(135deg, rgba(255,102,0,0.15), rgba(255,102,0,0.05));
            padding: 25px;
            border-bottom: 3px solid #ff6600;
            margin-top: 50px;
        }

        .header h1 {
            color: #ff6600;
            font-size: 2.2rem;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .header p {
            color: #ccc;
            font-size: 1.1rem;
        }

        .dashboard {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }

        .metric-card {
            background: linear-gradient(135deg, #2a2a2a 0%, #333333 100%);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border: 1px solid #404040;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6600, #ff9933);
        }

        .metric-card h3 {
            color: #ff9933;
            font-size: 1.1rem;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .metric-card p {
            font-size: 2.5rem;
            font-weight: 800;
            color: #fff;
        }

        .section {
            background: linear-gradient(135deg, #2a2a2a 0%, #333333 100%);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            margin-bottom: 35px;
            border: 1px solid #404040;
        }

        .section h2 {
            color: #ff6600;
            font-size: 1.9rem;
            margin-bottom: 25px;
            border-bottom: 2px solid #444;
            padding-bottom: 15px;
            font-weight: 700;
        }

        .chats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }

        .chat-card {
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            border: 1px solid #444;
            border-radius: 12px;
            padding: 25px;
            border-left: 5px solid #2196F3;
            transition: all 0.3s ease;
        }

        .chat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(33, 150, 243, 0.2);
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .chat-client {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2196F3;
        }

        .chat-topic {
            background: rgba(33, 150, 243, 0.2);
            color: #64B5F6;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .chat-preview {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #ccc;
            font-style: italic;
            border-left: 3px solid #2196F3;
        }

        .chat-meta {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            font-size: 0.85rem;
            color: #aaa;
        }

        .btn {
            background: linear-gradient(135deg, #ff6600, #ff8533);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s ease;
            margin: 5px;
        }

        .btn:hover {
            background: linear-gradient(135deg, #ff8533, #ffaa66);
            transform: translateY(-1px);
        }

        .btn.primary {
            background: linear-gradient(135deg, #2196F3, #1976D2);
        }

        .btn.primary:hover {
            background: linear-gradient(135deg, #1976D2, #1565C0);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #ff9933;
        }

        .error {
            background: #4a1a1a;
            border: 1px solid #f44336;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            color: #ffcdd2;
        }

        @media (max-width: 768px) {
            .dashboard { padding: 20px 15px; }
            .chats-grid { grid-template-columns: 1fr; }
            .metrics-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="status loading" id="status">
        üîÑ Connessione in corso...
    </div>

    <header class="header">
        <h1>üìà TribuCoach Dashboard</h1>
        <p>Conversazioni Chatbase + Quiz Firebase</p>
    </header>

    <div class="dashboard">
        <!-- METRICHE -->
        <div class="metrics-grid">
            <div class="metric-card">
                <h3>üí¨ Conversazioni Totali</h3>
                <p id="totalConversations">0</p>
            </div>
            <div class="metric-card">
                <h3>üìä Quiz Completati</h3>
                <p id="totalQuiz">0</p>
            </div>
            <div class="metric-card">
                <h3>üî• Oggi</h3>
                <p id="todayChats">0</p>
            </div>
            <div class="metric-card">
                <h3>‚≠ê Score Medio</h3>
                <p id="avgScore">0%</p>
            </div>
        </div>

        <!-- CONVERSAZIONI CHATBASE -->
        <div class="section">
            <h2>üí¨ Conversazioni Chatbase Reali</h2>
            <div class="chat-actions" style="margin-bottom: 20px;">
                <button class="btn primary" onclick="loadChatbaseConversations()">üîÑ Carica Conversazioni</button>
                <button class="btn" onclick="loadFirebaseQuiz()">üìä Carica Quiz</button>
            </div>
            <div id="conversationsContainer" class="chats-grid">
                <div class="loading">
                    <div class="icon">üîÑ</div>
                    <p>Clicca "Carica Conversazioni" per iniziare</p>
                </div>
            </div>
        </div>

        <!-- QUIZ FIREBASE -->
        <div class="section">
            <h2>üìä Quiz Firebase</h2>
            <div id="quizContainer" class="chats-grid">
                <div class="loading">
                    <div class="icon">üìä</div>
                    <p>Clicca "Carica Quiz" per vedere i risultati</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configurazioni reali
        const CHATBASE_CONFIG = {
            secretKey: '0uk17rpq8vkvbw1nvnhvupwm0zc8iwjo',
            chatbotId: 'EjoHCEogMfkkrVzIK6V07',
            apiBase: 'https://www.chatbase.co/api/v1'
        };

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDSsQEPii_Eb99cWGs7eqozgTtIqbtO2rs",
            authDomain: "tribucoach-a2254.firebaseapp.com",
            projectId: "tribucoach-a2254",
            storageBucket: "tribucoach-a2254.firebasestorage.app",
            messagingSenderId: "425200296836",
            appId: "1:425200296836:web:7835188f40f4348567ab48"
        };

        // Inizializza Firebase
        firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.firestore();

        // Variabili globali
        let conversationsData = [];
        let quizData = [];

        // === CHATBASE API ===
        async function loadChatbaseConversations() {
            updateStatus('loading', 'üîÑ Caricando conversazioni da Chatbase...');
            
            try {
                console.log('üîç Chiamata API Chatbase...');
                
                const response = await fetch(`${CHATBASE_CONFIG.apiBase}/get-conversations?chatbotId=${CHATBASE_CONFIG.chatbotId}&size=50`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${CHATBASE_CONFIG.secretKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('‚úÖ Risposta Chatbase:', data);

                if (data.success && data.data) {
                    conversationsData = data.data.map(conv => ({
                        id: conv.id,
                        clientName: extractNameFromMessages(conv.messages) || 'Cliente Anonimo',
                        phone: extractPhoneFromMessages(conv.messages) || 'N/A',
                        topic: extractTopicFromMessages(conv.messages) || 'Generale',
                        lastMessage: getLastUserMessage(conv.messages),
                        timestamp: new Date(conv.updated_at || conv.created_at),
                        messagesCount: conv.messages?.length || 0,
                        source: 'Chatbase'
                    }));

                    renderConversations();
                    updateMetrics();
                    updateStatus('connected', '‚úÖ Conversazioni Chatbase caricate');
                } else {
                    throw new Error('Nessun dato nelle conversazioni');
                }

            } catch (error) {
                console.error('‚ùå Errore Chatbase:', error);
                updateStatus('error', `‚ùå Errore: ${error.message}`);
                
                // Mostra errore dettagliato
                document.getElementById('conversationsContainer').innerHTML = `
                    <div class="error">
                        <h3>‚ùå Errore API Chatbase</h3>
                        <p><strong>Errore:</strong> ${error.message}</p>
                        <p><strong>Endpoint:</strong> ${CHATBASE_CONFIG.apiBase}/get-conversations</p>
                        <p><strong>ChatbotId:</strong> ${CHATBASE_CONFIG.chatbotId}</p>
                        <button class="btn" onclick="loadChatbaseConversations()">üîÑ Riprova</button>
                    </div>
                `;
            }
        }

        // === FIREBASE QUIZ ===
        async function loadFirebaseQuiz() {
            updateStatus('loading', 'üìä Caricando quiz da Firebase...');
            
            try {
                console.log('üìä Recupero quiz da Firebase...');
                
                const querySnapshot = await db.collection('quiz_results').orderBy('timestamp', 'desc').limit(20).get();
                
                quizData = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    quizData.push({
                        id: doc.id,
                        name: data.name || data.userName || 'Nome non disponibile',
                        email: data.email || data.userEmail || 'Non disponibile',
                        phone: data.whatsapp || data.phone || 'Non disponibile',
                        score: data.score || calculateScore(data),
                        profile: data.fitnessPersonality || data.profile || 'Non specificato',
                        timestamp: data.timestamp?.toDate() || new Date()
                    });
                });

                renderQuiz();
                updateMetrics();
                updateStatus('connected', '‚úÖ Quiz Firebase caricati');
                
            } catch (error) {
                console.error('‚ùå Errore Firebase:', error);
                updateStatus('error', `‚ùå Errore Firebase: ${error.message}`);
                
                document.getElementById('quizContainer').innerHTML = `
                    <div class="error">
                        <h3>‚ùå Errore Firebase</h3>
                        <p>${error.message}</p>
                        <button class="btn" onclick="loadFirebaseQuiz()">üîÑ Riprova</button>
                    </div>
                `;
            }
        }

        // === RENDERING ===
        function renderConversations() {
            const container = document.getElementById('conversationsContainer');
            
            if (conversationsData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üí¨</div>
                        <p>Nessuna conversazione trovata</p>
                    </div>
                `;
                return;
            }

            const html = conversationsData.map(conv => `
                <div class="chat-card">
                    <div class="chat-header">
                        <div class="chat-client">${conv.clientName}</div>
                        <div class="chat-topic">${conv.topic}</div>
                    </div>
                    
                    <div class="chat-preview">"${conv.lastMessage}"</div>
                    
                    <div class="chat-meta">
                        <span>üì± ${conv.phone}</span>
                        <span>üí¨ ${conv.messagesCount} msg</span>
                        <span>üìÖ ${conv.timestamp.toLocaleDateString('it-IT')}</span>
                    </div>
                    
                    <div class="chat-actions">
                        ${conv.phone !== 'N/A' ? 
                            `<button class="btn" onclick="openWhatsApp('${conv.phone}')">üì± WhatsApp</button>` : ''
                        }
                        <button class="btn primary" onclick="viewConversation('${conv.id}')">üëÅÔ∏è Dettagli</button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function renderQuiz() {
            const container = document.getElementById('quizContainer');
            
            if (quizData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìä</div>
                        <p>Nessun quiz trovato</p>
                    </div>
                `;
                return;
            }

            const html = quizData.map(quiz => {
                const scoreClass = quiz.score > 80 ? 'high' : quiz.score >= 60 ? 'medium' : 'low';
                return `
                    <div class="chat-card">
                        <div class="chat-header">
                            <div class="chat-client">${quiz.name}</div>
                            <div class="chat-topic score-${scoreClass}">${quiz.score}%</div>
                        </div>
                        
                        <div class="chat-preview">
                            <strong>üìß Email:</strong> ${quiz.email}<br>
                            <strong>üì± Phone:</strong> ${quiz.phone}<br>
                            <strong>üë§ Profile:</strong> ${quiz.profile}
                        </div>
                        
                        <div class="chat-meta">
                            <span>üìÖ ${quiz.timestamp.toLocaleDateString('it-IT')}</span>
                            <span>‚≠ê Score: ${quiz.score}%</span>
                        </div>
                        
                        <div class="chat-actions">
                            ${quiz.phone !== 'Non disponibile' ? 
                                `<button class="btn" onclick="openWhatsApp('${quiz.phone}')">üì± WhatsApp</button>` : ''
                            }
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // === UTILITY FUNCTIONS ===
        function extractNameFromMessages(messages) {
            if (!messages) return null;
            for (const msg of messages) {
                if (msg.role === 'user' && msg.content) {
                    const match = msg.content.match(/(?:mi chiamo|sono|il mio nome √®)\s+([a-zA-Z\s]{2,20})/i);
                    if (match) return match[1].trim();
                }
            }
            return null;
        }

        function extractPhoneFromMessages(messages) {
            if (!messages) return null;
            for (const msg of messages) {
                if (msg.role === 'user' && msg.content) {
                    const match = msg.content.match(/([0-9]{3}\s?[0-9]{3}\s?[0-9]{4})/);
                    if (match) return '+39 ' + match[1].replace(/\s/g, '');
                }
            }
            return null;
        }

        function extractTopicFromMessages(messages) {
            if (!messages) return 'Generale';
            
            const allText = messages
                .filter(msg => msg.role === 'user')
                .map(msg => msg.content?.toLowerCase() || '')
                .join(' ');
            
            const topics = {
                'Allenamento': ['allenamento', 'esercizi', 'workout', 'palestra', 'training'],
                'Dieta': ['dieta', 'alimentazione', 'cibo', 'nutrizione', 'mangiare'],
                'Obiettivi': ['obiettivo', 'perdere peso', 'dimagrire', 'massa'],
                'Consulenza': ['consulenza', 'personal', 'appuntamento', 'coach']
            };
            
            for (const [topic, keywords] of Object.entries(topics)) {
                if (keywords.some(keyword => allText.includes(keyword))) {
                    return topic;
                }
            }
            
            return 'Generale';
        }

        function getLastUserMessage(messages) {
            if (!messages) return 'Nessun messaggio';
            
            const userMessages = messages.filter(msg => msg.role === 'user');
            if (userMessages.length === 0) return 'Nessun messaggio utente';
            
            const lastMsg = userMessages[userMessages.length - 1];
            const content = lastMsg.content || 'Messaggio vuoto';
            return content.length > 100 ? content.substring(0, 100) + '...' : content;
        }

        function calculateScore(data) {
            let score = 50;
            if (data.email && data.email.length > 5) score += 15;
            if (data.name && data.name.length > 2) score += 10;
            if (data.whatsapp || data.phone) score += 20;
            if (data.goals && data.goals.length > 0) score += 5;
            return Math.min(score, 100);
        }

        function updateMetrics() {
            document.getElementById('totalConversations').textContent = conversationsData.length;
            document.getElementById('totalQuiz').textContent = quizData.length;
            
            // Conversazioni di oggi
            const today = new Date().toDateString();
            const todayConversations = conversationsData.filter(conv => 
                conv.timestamp.toDateString() === today
            ).length;
            document.getElementById('todayChats').textContent = todayConversations;
            
            // Score medio quiz
            if (quizData.length > 0) {
                const avgScore = Math.round(
                    quizData.reduce((sum, quiz) => sum + quiz.score, 0) / quizData.length
                );
                document.getElementById('avgScore').textContent = avgScore + '%';
            }
        }

        function updateStatus(type, message) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.textContent = message;
        }

        // === ACTIONS ===
        window.openWhatsApp = function(phone) {
            if (!phone || phone === 'N/A' || phone === 'Non disponibile') {
                alert('Numero non disponibile');
                return;
            }
            const cleanPhone = phone.replace(/[^\d+]/g, '');
            window.open(`https://wa.me/${cleanPhone}`, '_blank');
        };

        window.viewConversation = function(conversationId) {
            const conv = conversationsData.find(c => c.id === conversationId);
            if (conv) {
                alert(`Conversazione ${conversationId}\nCliente: ${conv.clientName}\nTopic: ${conv.topic}`);
            }
        };

        // === INIZIALIZZAZIONE ===
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('connected', '‚úÖ Dashboard pronta - Clicca i pulsanti per caricare i dati');
            console.log('üöÄ TribuCoach Dashboard inizializzata');
            console.log('üîß Configurazioni:', { 
                chatbaseConfigured: !!CHATBASE_CONFIG.secretKey,
                firebaseConfigured: !!FIREBASE_CONFIG.projectId 
            });
        });
    </script>
</body>
</html>