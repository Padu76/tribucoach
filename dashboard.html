<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TribuCoach Dashboard - Business Intelligence</title>
  <style>
    * {margin:0; padding:0; box-sizing:border-box;}
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
      color: #fff; min-height: 100vh; margin-top: 50px;
    }
    .connection-status {
      position: fixed; top:0; left:0; right:0; padding:10px;
      text-align:center; font-weight:bold; font-size:0.9rem;
      z-index:1000; transition:all 0.3s ease;
    }
    .status-connected {background:#4CAF50; color:white; animation:slideDown 0.5s ease;}
    .status-connecting {background:#ff9800; color:white; animation:pulse 1.5s infinite;}
    .status-error {background:#f44336; color:white; animation:shake 0.5s ease;}
    @keyframes slideDown {from{transform:translateY(-100%);} to{transform:translateY(0);}}
    @keyframes pulse {0%,100%{opacity:1;}50%{opacity:0.7;}}
    @keyframes shake {0%,100%{transform:translateX(0);}25%{transform:translateX(-5px);}75%{transform:translateX(5px);}}
    .header {
      background: rgba(255,102,0,0.1); padding:20px; border-bottom:2px solid #ff6600;
    }
    .header h1 {color:#ff6600; font-size:2rem; margin-bottom:10px;}
    .header p {color:#ccc; font-size:1rem;}
    .dashboard {padding:30px; max-width:1400px; margin:0 auto;}
    .metrics-grid {
      display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap:20px; margin-bottom:30px;
    }
    .metric-card {
      background-color:#1c1c1c; padding:25px; border-radius:10px;
      box-shadow:0 4px 15px rgba(0,0,0,0.3); border-left:5px solid #ff6600;
    }
    .metric-card h3 {color:#ff9933; font-size:1.2rem; margin-bottom:10px;}
</style>

    <!-- Metriche Principali -->
    <div class="metrics-grid">
      <div class="metric-card">
        <h3>Lead Totali</h3>
        <div class="value" id="total-leads">-</div>
        <div class="trend positive" id="leads-trend">
          <span class="icon">üìà</span><span class="percentage">0%</span> vs. Settimana scorsa
        </div>
      </div>
      <div class="metric-card">
        <h3>Quiz Completati</h3>
        <div class="value" id="total-quizzes">-</div>
        <div class="trend positive" id="quizzes-trend">
          <span class="icon">üìä</span><span class="percentage">0%</span> vs. Settimana scorsa
        </div>
      </div>
      <div class="metric-card">
        <h3>Conversazioni Chatbot</h3>
        <div class="value" id="total-conversations">-</div>
        <div class="trend positive" id="conversations-trend">
          <span class="icon">üí¨</span><span class="percentage">0%</span> vs. Settimana scorsa
        </div>
      </div>
      <div class="metric-card">
        <h3>Utenti Attivi Oggi</h3>
        <div class="value" id="daily-active-users">-</div>
        <div class="trend positive" id="active-users-trend">
          <span class="icon">üë•</span><span class="percentage">0%</span> vs. Ieri
        </div>
      </div>
      <div class="metric-card">
        <h3>Tasso di Conversione</h3>
        <div class="value" id="conversion-rate">-</div>
        <div class="trend positive" id="conversion-trend">
          <span class="icon">üéØ</span><span class="percentage">0%</span> vs. Settimana scorsa
        </div>
      </div>
      <div class="metric-card">
        <h3>Durata Media Chat</h3>
        <div class="value" id="avg-conversation-duration">-</div>
        <div class="trend positive" id="duration-trend">
          <span class="icon">‚è±Ô∏è</span><span class="percentage">0%</span> vs. Settimana scorsa
        </div>
      </div>
    </div>

    <!-- BLOCCO 1: Dati Quiz -->
    <div class="dashboard-section">
      <h2>üéØ Dati Quiz</h2>
      <table class="data-table leads-table">
        <thead>
          <tr>
            <th>Nome</th>
            <th>WhatsApp/Email</th>
            <th>Et√†</th>
            <th>Citt√†</th>
            <th>Genere</th>
            <th>Profilo</th>
            <th>Score</th>
            <th>Obiettivi</th>
            <th>Tipo Allenamento</th>
            <th>Livello</th>
            <th>Ostacoli</th>
            <th>Data</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody id="leads-table-body">
          <tr><td colspan="13" class="no-data">Caricamento lead...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- BLOCCO 2: Dati Chatbot -->
    <div class="dashboard-section">
      <h2>üí¨ Dati Chatbot</h2>
      <table class="data-table chatbot-table">
        <thead>
          <tr>
            <th>Conversazioni Totali</th>
            <th>Conversazioni Attive</th>
            <th>Durata Media</th>
            <th>Interessi</th>
            <th>Esigenze</th>
            <th>Genere Deducibile</th>
            <th>Domande Frequenti</th>
            <th>Sentiment</th>
          </tr>
        </thead>
        <tbody id="chatbot-table-body">
          <tr><td colspan="8" class="no-data">Caricamento dati chatbot...</td></tr>
        </tbody>
      </table>
    </div>
    <!-- BLOCCO 3: Riepilogo Attivit√† -->
    <div class="dashboard-section">
      <h2>üìä Riepilogo Attivit√†</h2>
      <table class="data-table summary-table">
        <thead>
          <tr>
            <th>Utenti Attivi (Giornalieri/Settimanali)</th>
            <th>Quiz Completati</th>
            <th>Numero Chat Totali</th>
            <th>Distribuzione Geografica</th>
            <th>Conversione Quiz‚ÜíChat</th>
            <th>Orari Maggiore Attivit√†</th>
            <th>Dispositivi Usati</th>
          </tr>
        </thead>
        <tbody id="summary-table-body">
          <tr><td colspan="7" class="no-data">Caricamento riepilogo attivit√†...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- BLOCCO 4: Opportunit√† Business -->
    <div class="dashboard-section">
      <h2>üíº Opportunit√† Business</h2>
      <div id="business-opportunities"></div>
    </div>
  </div> <!-- fine .dashboard -->

  <!-- SCRIPT -->
  <script>
    let firebaseAPI = null;

    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üöÄ Dashboard avviata: caricamento dati da Firebase...');
      updateConnectionStatus(false, 'Connessione Firebase...');
      try {
        const firebaseModule = await import('./firebase-api.js');
        firebaseAPI = firebaseModule;
        const [quizResults, conversations, users] = await Promise.all([
          firebaseAPI.getAllQuizResults(),
          firebaseAPI.getChatbotConversations(),
          firebaseAPI.getUsers()
        ]);
        updateDashboard(quizResults, conversations, users);
        updateConnectionStatus(true, '‚úÖ Firebase connesso - Dati aggiornati');
      } catch (error) {
        console.error('‚ùå Errore Firebase:', error);
        updateConnectionStatus(false, 'Errore connessione Firebase');
      }
    });

    function updateDashboard(quizResults, conversations, users) {
      // aggiorna metriche principali
      document.getElementById('total-leads').innerText = quizResults.length;
      document.getElementById('total-quizzes').innerText = quizResults.length;
      document.getElementById('total-conversations').innerText = conversations.length;
      document.getElementById('daily-active-users').innerText = users.length;
      // aggiorna tabella leads
      const tbody = document.getElementById('leads-table-body');
      tbody.innerHTML = quizResults.length === 0 ? '<tr><td colspan="13" class="no-data">Nessun dato quiz</td></tr>' :
        quizResults.map(q => `<tr>
          <td>${q.name || '-'}</td>
          <td>${q.whatsapp || q.email || '-'}</td>
          <td>${q.age || '-'}</td>
          <td>${q.city || '-'}</td>
          <td>${q.gender || '-'}</td>
          <td>${q.profile || '-'}</td>
          <td>${q.score || '-'}</td>
          <td>${Array.isArray(q.goals) ? q.goals.join(', ') : (q.goals || '-')}</td>
          <td>${q.training_style || '-'}</td>
          <td>${q.activity_level || '-'}</td>
          <td>${Array.isArray(q.obstacles) ? q.obstacles.join(', ') : (q.obstacles || '-')}</td>
          <td>${formatDateTime(q.timestamp)}</td>
          <td><button class="action-btn" onclick="contactLeadWhatsApp('${q.whatsapp}','${q.name}','${q.profile}')">WhatsApp</button></td>
        </tr>`).join('');
      // aggiorna tabella chatbot
      const cbody = document.getElementById('chatbot-table-body');
      cbody.innerHTML = conversations.length === 0 ? '<tr><td colspan="8" class="no-data">Nessuna conversazione chatbot</td></tr>' :
        conversations.map(c => `<tr>
          <td>${c.total || '-'}</td>
          <td>${c.active || '-'}</td>
          <td>${c.avgDuration || '-'}</td>
          <td>${c.interests || '-'}</td>
          <td>${c.needs || '-'}</td>
          <td>${c.gender || '-'}</td>
          <td>${c.faq || '-'}</td>
          <td>${c.sentiment || '-'}</td>
        </tr>`).join('');
      updateElement('last-update', new Date().toLocaleTimeString('it-IT'));
    }

    function updateElement(id, text) {
      const el = document.getElementById(id);
      if (el) el.innerText = text;
    }

    function updateConnectionStatus(connected, msg) {
      const el = document.getElementById('connection-status');
      el.className = connected ? 'connection-status status-connected' : 'connection-status status-error';
      el.innerHTML = connected ? '‚úÖ ' + msg : '‚ùå ' + msg;
    }

    function formatDateTime(ts) {
      if (!ts) return '-';
      const d = new Date(ts);
      return d.toLocaleString('it-IT');
    }

    window.refreshData = async () => {
      if (!firebaseAPI) return;
      updateConnectionStatus(false, 'Aggiornamento dati...');
      const [quizResults, conversations, users] = await Promise.all([
        firebaseAPI.getAllQuizResults(),
        firebaseAPI.getChatbotConversations(),
        firebaseAPI.getUsers()
      ]);
      updateDashboard(quizResults, conversations, users);
      updateConnectionStatus(true, 'Dati aggiornati');
    };

    window.exportLeadsToCSV = function() {
      const rows = [['Nome','WhatsApp','Et√†','Citt√†','Genere','Profilo','Score','Obiettivi','Tipo Allenamento','Livello','Ostacoli','Data']];
      const leads = document.querySelectorAll('#leads-table-body tr');
      leads.forEach(row => {
        const cols = row.querySelectorAll('td');
        rows.push(Array.from(cols).slice(0,12).map(c => `"${c.textContent.trim()}"`));
      });
      const csv = rows.map(e => e.join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `tribucoach-leads-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(link); link.click(); document.body.removeChild(link);
    };

    window.contactLeadWhatsApp = function(whatsapp, name, profile) {
      if (!whatsapp) return alert('Numero WhatsApp non disponibile');
      const clean = whatsapp.replace(/[^\d\+]/g, '');
      const msg = encodeURIComponent(`Ciao ${name}! üëã\n\nHo visto che hai completato il quiz. Il tuo profilo "${profile}" mostra un grande potenziale! üí™\n\nVorresti una consulenza gratuita?\n\nA presto! üöÄ`);
      window.open(`https://wa.me/${clean}?text=${msg}`);
    };
  </script>
</body>
</html>
