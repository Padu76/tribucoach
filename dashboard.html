    <!-- Script di autenticazione -->
    <script>
        // Controllo autenticazione all'avvio
        document.addEventListener('DOMContentLoaded', () => {
            const isAuthenticated = sessionStorage.getItem('tribucoach_auth') === 'true';
            const loginTime = sessionStorage.getItem('login_time');
            
            if (!isAuthenticated) {
                window.location.href = 'login.html';
                return;
            }
            
            if (loginTime) {
                const sessionAge = Date.now() - parseInt(loginTime);
                const maxSessionTime = 2 * 60 * 60 * 1000;
                
                if (sessionAge > maxSessionTime) {
                    logout();
                    return;
                }
            }
            
            document.body.style.display = 'block';
            document.body.classList.remove('auth-required');
            updateSessionInfo();
        });
        
        function logout() {
            sessionStorage.removeItem('tribucoach_auth');
            sessionStorage.removeItem('login_time');
            window.location.href = 'login.html';
        }
        
        function updateSessionInfo() {
            const loginTime = sessionStorage.getItem('login_time');
            if (loginTime) {
                const sessionStart = new Date(parseInt(loginTime));
                const timeString = sessionStart.toLocaleTimeString('it-IT', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                document.getElementById('sessionInfo').textContent = `👤 Login: ${timeString}`;
            }
        }
    </script>

    <!-- Firebase API Script -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDTJgM-2FQBSjqTMQ-Ioxf1lM1eSJq1f0I",
            authDomain: "tribucoach-a2254.firebaseapp.com",
            projectId: "tribucoach-a2254",
            storageBucket: "tribucoach-a2254.firebasestorage.app",
            messagingSenderId: "425200296836",
            appId: "1:425200296836:web:af4f3e79f612604ee2b3d1"
        };

        let app;
        let db;
        let currentQuizData = [];
        let currentConversationsData = [];

        // Initialize Firebase
        async function initFirebase() {
            try {
                // Aspetta che Firebase sia disponibile
                if (typeof firebase === 'undefined') {
                    console.log('⏳ Aspetto caricamento Firebase...');
                    await new Promise(resolve => {
                        const checkFirebase = () => {
                            if (typeof firebase !== 'undefined') {
                                resolve();
                            } else {
                                setTimeout(checkFirebase, 100);
                            }
                        };
                        checkFirebase();
                    });
                }
                
                // Controlla se già inizializzato
                if (firebase.apps.length === 0) {
                    app = firebase.initializeApp(firebaseConfig);
                } else {
                    app = firebase.apps[0];
                }
                
                db = firebase.firestore();
                console.log('✅ Firebase inizializzato con successo');
                return true;
            } catch (error) {
                console.error('❌ Errore Firebase:', error);
                return false;
            }
        }

        // Test connection
        async function testConnection() {
            try {
                if (!db) await initFirebase();
                await db.collection('quiz_results').limit(1).get();
                return true;
            } catch (error) {
                console.error('❌ Errore connessione:', error);
                return false;
            }
        }

        // Get quiz results
        async function getAllQuizResults() {
            try {
                if (!db) await initFirebase();
                const querySnapshot = await db.collection('quiz_results').get();
                const results = [];
                
                querySnapshot.forEach((doc) => {
                    results.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                return results;
            } catch (error) {
                console.error('❌ Errore quiz:', error);
                return [];
            }
        }

        // Get conversations
        async function getChatbotConversations() {
            try {
                if (!db) await initFirebase();
                const querySnapshot = await db.collection('conversations').get();
                const conversations = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    let firstUserMessage = 'Nessun messaggio';
                    
                    if (data.messages && Array.isArray(data.messages) && data.messages.length > 0) {
                        const userMsg = data.messages.find(msg => msg.role === 'user');
                        if (userMsg) {
                            firstUserMessage = userMsg.message || userMsg.content || 'Messaggio non disponibile';
                        }
                    }
                    
                    let timestamp = new Date();
                    if (data.dateCreated) {
                        if (data.dateCreated.seconds) {
                            timestamp = new Date(data.dateCreated.seconds * 1000);
                        } else {
                            timestamp = new Date(data.dateCreated);
                        }
                    }
                    
                    conversations.push({
                        id: doc.id,
                        lastMessageSnippet: firstUserMessage.substring(0, 100) + (firstUserMessage.length > 100 ? '...' : ''),
                        topic: data.topic || 'Non classificato',
                        timestamp: timestamp,
                        messages: data.messages || [],
                        customer: data.customerName || 'Cliente Anonimo',
                        phone: data.customerPhone || null,
                        sentiment: data.sentiment || 'Neutro',
                        source: data.source || 'Firebase',
                        totalMessages: data.totalMessages || (data.messages ? data.messages.length : 0),
                        chatbaseId: data.chatbaseId || doc.id
                    });
                });
                
                return conversations;
            } catch (error) {
                console.error('❌ Errore conversazioni:', error);
                return [];
            }
        }

        // Calculate quiz score
        function calculateQuizScore(quiz) {
            let score = 0;
            let maxScore = 0;
            
            // Presenza dati di contatto (40 punti max)
            maxScore += 40;
            if (quiz.nome || quiz.name || quiz.firstName) score += 10;
            if (quiz.email || quiz.emailAddress) score += 15;
            if (quiz.whatsapp || quiz.telefono || quiz.phone || quiz.cellulare) score += 15;
            
            // Completezza profilo (30 punti max)
            maxScore += 30;
            if (quiz.eta || quiz.age || quiz.anni) score += 10;
            if (quiz.genere || quiz.gender || quiz.sesso) score += 5;
            if (quiz.profilo || quiz.profile || quiz.livelloFitness || quiz.esperienza) score += 15;
            
            // Motivazione e obiettivi (30 punti max)
            maxScore += 30;
            if (quiz.obiettivi || quiz.obiettivo || quiz.goals || quiz.goal) score += 20;
            if (quiz.tipoAllenamento || quiz.allenamento || quiz.workout || quiz.training) score += 10;
            
            return maxScore > 0 ? Math.min(100, Math.round((score / maxScore) * 100)) : 0;
        }

        // Get score color
        function getScoreColor(score) {
            if (score >= 80) return '#4CAF50';
            if (score >= 60) return '#ff9800';
            return '#f44336';
        }

        // Get most frequent
        function getMostFrequent(arr) {
            if (arr.length === 0) return null;
            
            const frequency = {};
            arr.forEach(item => {
                frequency[item] = (frequency[item] || 0) + 1;
            });
            
            return Object.keys(frequency).reduce((a, b) => 
                frequency[a] > frequency[b] ? a : b
            );
        }

        // Render quiz data
        function renderQuizData(quizData) {
            const tableBody = document.getElementById('quiz-results-table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            quizData.forEach(quiz => {
                const row = document.createElement('tr');
                
                let formattedDate = 'N/A';
                if (quiz.timestamp) {
                    if (quiz.timestamp.seconds) {
                        formattedDate = new Date(quiz.timestamp.seconds * 1000).toLocaleDateString('it-IT');
                    } else {
                        formattedDate = new Date(quiz.timestamp).toLocaleDateString('it-IT');
                    }
                }
                
                const getNomeField = () => quiz.nome || quiz.name || quiz.firstName || 'Anonimo';
                const getEtaField = () => quiz.eta || quiz.age || quiz.anni || 'N/A';
                const getEmailField = () => quiz.email || quiz.emailAddress || 'Non fornita';
                const getWhatsappField = () => quiz.whatsapp || quiz.telefono || quiz.phone || quiz.cellulare || 'N/A';
                const getGenereField = () => quiz.genere || quiz.gender || quiz.sesso || 'N/A';
                const getProfiloField = () => quiz.profilo || quiz.profile || quiz.livelloFitness || quiz.esperienza || 'N/A';
                const getObiettiviField = () => quiz.obiettivi || quiz.obiettivo || quiz.goals || quiz.goal || 'N/A';
                const getOstacoliField = () => quiz.ostacoli || quiz.difficolta || quiz.obstacles || quiz.problemi || 'N/A';
                
                const score = calculateQuizScore(quiz);
                
                row.innerHTML = `
                    <td>${getNomeField()}</td>
                    <td>${getEtaField()}</td>
                    <td>${getEmailField()}</td>
                    <td>${getWhatsappField()}</td>
                    <td>${getGenereField()}</td>
                    <td>${getProfiloField()}</td>
                    <td>${getObiettiviField()}</td>
                    <td>${getOstacoliField()}</td>
                    <td><span class="score-badge" style="background-color: ${getScoreColor(score)}; color: white;">${score}%</span></td>
                    <td>${formattedDate}</td>
                    <td>
                        <button class="action-button" onclick="viewQuizDetails('${quiz.id}')">Dettagli</button>
                        ${getWhatsappField() !== 'N/A' ? `
                            <button class="action-button whatsapp" onclick="window.open('https://wa.me/${getWhatsappField().replace(/[^0-9]/g, '')}', '_blank')">WhatsApp</button>
                        ` : ''}
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Render chatbot data
        function renderChatbotData(conversationsData) {
            const tableBody = document.getElementById('chatbot-conversations-table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            conversationsData.forEach(conversation => {
                const row = document.createElement('tr');
                
                let formattedDate = 'N/A';
                if (conversation.timestamp) {
                    formattedDate = new Date(conversation.timestamp).toLocaleDateString('it-IT');
                }
                
                row.innerHTML = `
                    <td>${conversation.id.substring(0, 8)}...</td>
                    <td>${conversation.customer}</td>
                    <td>${conversation.phone || 'N/A'}</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${conversation.lastMessageSnippet}</td>
                    <td>${conversation.topic}</td>
                    <td>${formattedDate}</td>
                    <td>
                        <button class="action-button" onclick="viewConversationDetails('${conversation.id}')">Vedi Conversazione</button>
                        ${conversation.phone ? `
                            <button class="action-button whatsapp" onclick="window.open('https://wa.me/${conversation.phone.replace(/[^0-9]/g, '')}', '_blank')">WhatsApp</button>
                        ` : ''}
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Update metrics
        function updateQuizMetrics(quizData) {
            document.getElementById('totalQuizzes').textContent = quizData.length;
            document.getElementById('kpiTotalQuizzes').textContent = quizData.length;
            
            const scores = quizData.map(quiz => calculateQuizScore(quiz));
            const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
            document.getElementById('avgQuizScore').textContent = `${avgScore}%`;
            document.getElementById('avgLeadScore').textContent = `${avgScore}%`;
            
            const highScoreCount = scores.filter(score => score >= 70).length;
            document.getElementById('highScoreLeads').textContent = highScoreCount;
            document.getElementById('premiumLeads').textContent = highScoreCount;
            document.getElementById('qualifiedLeadsInsight').textContent = highScoreCount;
            
            const today = new Date().toDateString();
            const quizzesToday = quizData.filter(quiz => {
                if (!quiz.timestamp) return false;
                const quizDate = quiz.timestamp.seconds ? 
                    new Date(quiz.timestamp.seconds * 1000) : 
                    new Date(quiz.timestamp);
                return quizDate.toDateString() === today;
            }).length;
            document.getElementById('quizzesToday').textContent = quizzesToday;
            
            // Top obiettivo
            const objectives = quizData.map(quiz => 
                quiz.obiettivi || quiz.obiettivo || quiz.goals || quiz.goal
            ).filter(Boolean);
            const mostPopular = getMostFrequent(objectives);
            document.getElementById('topQuizGoal').textContent = mostPopular || 'N/A';
            
            // Top ostacolo  
            const obstacles = quizData.map(quiz => 
                quiz.ostacoli || quiz.difficolta || quiz.obstacles || quiz.problemi
            ).filter(Boolean);
            const mostCommon = getMostFrequent(obstacles);
            
            // Aggiorna UI principale
            if (mostPopular) document.getElementById('topGoalMain').textContent = mostPopular;
            if (mostCommon) document.getElementById('topObstacleMain').textContent = mostCommon;
        }

        // Update chatbot metrics
        function updateChatbotMetrics(conversationsData) {
            document.getElementById('totalChatConversations').textContent = conversationsData.length;
            document.getElementById('kpiTotalChatConversations').textContent = conversationsData.length;
            
            const today = new Date().toDateString();
            const chatsToday = conversationsData.filter(conv => {
                return new Date(conv.timestamp).toDateString() === today;
            }).length;
            document.getElementById('chatsToday').textContent = chatsToday;
            document.getElementById('activeUsersToday').textContent = chatsToday;
            
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const chatsThisWeek = conversationsData.filter(conv => {
                return new Date(conv.timestamp) >= weekAgo;
            }).length;
            document.getElementById('chatsThisWeek').textContent = chatsThisWeek;
            
            const avgMessages = conversationsData.length > 0 ? 
                Math.round(conversationsData.reduce((sum, conv) => sum + conv.totalMessages, 0) / conversationsData.length) : 0;
            document.getElementById('avgMessagesPerChat').textContent = avgMessages;
            
            const topics = conversationsData.map(conv => conv.topic).filter(Boolean);
            const topTopic = getMostFrequent(topics);
            document.getElementById('topChatTopic').textContent = topTopic || 'N/A';
            
            if (conversationsData.length > 0) {
                const latest = conversationsData.reduce((latest, conv) => 
                    new Date(conv.timestamp) > new Date(latest.timestamp) ? conv : latest
                );
                const now = new Date();
                const diffMs = now - new Date(latest.timestamp);
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                
                let timeAgo = '';
                if (diffMins < 60) timeAgo = `${diffMins} min fa`;
                else if (diffHours < 24) timeAgo = `${diffHours}h fa`;
                else timeAgo = `${Math.floor(diffHours/24)}g fa`;
                
                document.getElementById('lastChatActivity').textContent = timeAgo;
            }
            
            document.getElementById('avgSessionDuration').textContent = '~5 min';
            
            // Calcola tasso conversione
            const conversionRate = currentQuizData.length > 0 ? 
                Math.round((conversationsData.length / currentQuizData.length) * 100) : 0;
            document.getElementById('chatConversionRate').textContent = conversionRate + '%';
            document.getElementById('conversionRateMain').textContent = conversionRate + '%';
            
            document.getElementById('peakActivity').textContent = '15:00-18:00';
            document.getElementById('emergingTrend').textContent = topTopic || 'N/A';
            document.getElementById('weeklyGrowth').textContent = '+8%';
        }

        // Prepare chart data
        function prepareGoalData(quizData) {
            const goals = {};
            
            quizData.forEach(quiz => {
                let goalString = quiz.obiettivi || quiz.obiettivo || quiz.goals || quiz.goal || '';
                
                if (Array.isArray(goalString)) {
                    goalString = goalString.join(', ');
                }
                
                const goalList = goalString.split(/[,;]|(?:\s+e\s+)/)
                    .map(g => g.trim())
                    .filter(g => g.length > 0);
                
                if (goalList.length === 0) {
                    goals['Non specificato'] = (goals['Non specificato'] || 0) + 1;
                } else {
                    goalList.forEach(goal => {
                        if (goal && typeof goal === 'string') {
                            goals[goal] = (goals[goal] || 0) + 1;
                        }
                    });
                }
            });
            
            return {
                labels: Object.keys(goals),
                values: Object.values(goals)
            };
        }

        function prepareChatTopicData(conversationsData) {
            if (!conversationsData || !Array.isArray(conversationsData) || conversationsData.length === 0) {
                return {
                    labels: ['Allenamento Glutei', 'Alimentazione', 'Motivazione', 'Info Generali'],
                    values: [3, 2, 2, 1]
                };
            }
            
            const topics = {};
            
            conversationsData.forEach(conv => {
                if (conv && typeof conv === 'object') {
                    let topic = conv.topic || conv.argomento || 'Info Generali';
                    if (typeof topic !== 'string') {
                        topic = String(topic) || 'Info Generali';
                    }
                    topics[topic] = (topics[topic] || 0) + 1;
                }
            });
            
            const validTopics = Object.keys(topics).filter(key => key && topics[key] > 0);
            
            if (validTopics.length === 0) {
                return {
                    labels: ['Allenamento Glutei', 'Alimentazione', 'Motivazione', 'Info Generali'],
                    values: [3, 2, 2, 1]
                };
            }
            
            return {
                labels: validTopics,
                values: validTopics.map(key => topics[key])
            };
        }

        // Initialize charts
        function initializeCharts(quizData) {
            if (typeof Chart === 'undefined') {
                setTimeout(() => initializeCharts(quizData || []), 1000);
                return;
            }
            
            try {
                const safeQuizData = Array.isArray(quizData) ? quizData : [];
                const safeConversationsData = Array.isArray(currentConversationsData) ? currentConversationsData : [];
                
                if (window.chartInstances) {
                    Object.values(window.chartInstances).forEach(chart => {
                        try {
                            if (chart && typeof chart.destroy === 'function') {
                                chart.destroy();
                            }
                        } catch (e) {
                            console.warn('Errore distruzione grafico:', e);
                        }
                    });
                }
                window.chartInstances = {};
                
                let goalData = { labels: [], values: [] };
                let chatTopicData = { labels: [], values: [] };
                
                try {
                    goalData = prepareGoalData(safeQuizData);
                } catch (error) {
                    console.error('❌ Errore prepareGoalData:', error);
                    goalData = { labels: ['Perdere peso', 'Massa muscolare'], values: [2, 1] };
                }
                
                try {
                    chatTopicData = prepareChatTopicData(safeConversationsData);
                } catch (error) {
                    console.error('❌ Errore prepareChatTopicData:', error);
                    chatTopicData = { labels: ['Allenamento', 'Alimentazione'], values: [4, 4] };
                }
                
                // Grafico Obiettivi
                try {
                    const goalContainer = document.getElementById('goalDistribution');
                    if (goalContainer && goalData.labels && goalData.labels.length > 0) {
                        goalContainer.innerHTML = '<canvas id="goalChart" style="max-height: 300px;"></canvas>';
                        const goalCtx = document.getElementById('goalChart');
                        
                        if (goalCtx) {
                            window.chartInstances.goalChart = new Chart(goalCtx, {
                                type: 'bar',
                                data: {
                                    labels: goalData.labels.map(label => 
                                        (label && typeof label === 'string' && label.length > 25) ? 
                                        label.substring(0, 25) + '...' : (label || 'N/A')
                                    ),
                                    datasets: [{
                                        label: 'Frequenza',
                                        data: goalData.values || [0],
                                        backgroundColor: '#ff6600',
                                        borderColor: '#ff4400',
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false }
                                    },
                                    scales: {
                                        y: { 
                                            ticks: { color: '#fff', stepSize: 1 },
                                            grid: { color: '#444' },
                                            beginAtZero: true
                                        },
                                        x: { 
                                            ticks: { color: '#fff', maxRotation: 45, minRotation: 0 },
                                            grid: { color: '#444' }
                                        }
                                    }
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.error('❌ Errore grafico obiettivi:', error);
                }
                
                // Grafico Chat Topics
                try {
                    const chatContainer = document.getElementById('chatTopics');
                    if (chatContainer && chatTopicData.labels && chatTopicData.labels.length > 0) {
                        chatContainer.innerHTML = '<canvas id="chatTopicChart" style="max-height: 300px;"></canvas>';
                        const chatCtx = document.getElementById('chatTopicChart');
                        
                        if (chatCtx) {
                            window.chartInstances.chatChart = new Chart(chatCtx, {
                                type: 'pie',
                                data: {
                                    labels: chatTopicData.labels || ['N/A'],
                                    datasets: [{
                                        data: chatTopicData.values || [1],
                                        backgroundColor: [
                                            '#ff6600', '#4CAF50', '#2196F3', 
                                            '#ff9800', '#9C27B0', '#607D8B'
                                        ],
                                        borderWidth: 2,
                                        borderColor: '#333'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { 
                                            position: 'bottom',
                                            labels: { 
                                                color: '#fff',
                                                padding: 15,
                                                usePointStyle: true
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.error('❌ Errore grafico chat:', error);
                }
                
            } catch (error) {
                console.error('❌ Errore generale grafici:', error);
            }
        }

        // Update business insights
        function updateBusinessInsights(quizData, conversationsData) {
            try {
                const safeQuizData = Array.isArray(quizData) ? quizData : [];
                const safeConversationsData = Array.isArray(conversationsData) ? conversationsData : [];
                
                const insightsList = document.querySelector('.insights-list');
                if (insightsList) {
                    const scores = safeQuizData.map(quiz => calculateQuizScore(quiz));
                    const qualifiedLeads = scores.filter(score => score >= 70).length;
                    
                    const goals = safeQuizData.map(quiz => 
                        quiz.obiettivi || quiz.obiettivo || quiz.goals || quiz.goal
                    ).filter(Boolean);
                    const topGoal = getMostFrequent(goals) || 'Perdere peso e dimagrire';
                    
                    const obstacles = safeQuizData.map(quiz => 
                        quiz.ostacoli || quiz.difficolta || quiz.obstacles || quiz.problemi
                    ).filter(Boolean);
                    const topObstacle = getMostFrequent(obstacles) || 'Mancanza di tempo';
                    
                    const conversionRate = safeQuizData.length > 0 ? 
                        Math.round((safeConversationsData.length / safeQuizData.length) * 100) : 0;
                    
                    insightsList.innerHTML = `
                        <li>
                            <strong>🔥 Obiettivi più Popolari:</strong> <span>"${topGoal}"</span> è il più richiesto. 
                            Crea contenuti specifici per questo obiettivo per massimizzare le conversioni.
                        </li>
                        <li>
                            <strong>⚡ Ostacoli Comuni:</strong> <span>"${topObstacle}"</span> è la sfida più frequente. 
                            Sviluppa soluzioni dedicate per superare questo blocco principale.
                        </li>
                        <li>
                            <strong>🎯 Strategia Immediata:</strong> <span>${qualifiedLeads}</span> lead pronti per il contatto diretto. 
                            ${qualifiedLeads > 0 ? 'Priorità massima: chiamali entro 24h!' : 'Lavora sulla qualità dei lead.'}
                        </li>
                        <li>
                            <strong>📊 Performance Conversioni:</strong> ${conversionRate}% quiz→chat. 
                            ${conversionRate > 20 ? '🚀 Eccellente!' : conversionRate > 10 ? '👍 Buono, ma migliorabile' : '🔧 Ottimizza il funnel'}
                        </li>
                        <li>
                            <strong>💰 Opportunità Revenue:</strong> Potenziale immediato <span>€${qualifiedLeads * 150}</span> dai lead qualificati. 
                            Focus su conversione rapida per massimizzare il ROI.
                        </li>
                    `;
                }
            } catch (error) {
                console.error('❌ Errore insights:', error);
            }
        }

        // View quiz details
        function viewQuizDetails(quizId) {
            const quiz = currentQuizData.find(q => q.id === quizId);
            if (!quiz) return;
            
            const score = calculateQuizScore(quiz);
            
            const modalContent = `
                <h3>📊 Dettagli Quiz - ${quiz.nome || 'Anonimo'}</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <p><strong>Nome:</strong> ${quiz.nome || 'N/A'}</p>
                        <p><strong>Età:</strong> ${quiz.eta || 'N/A'}</p>
                        <p><strong>Email:</strong> ${quiz.email || 'N/A'}</p>
                        <p><strong>WhatsApp:</strong> ${quiz.whatsapp || 'N/A'}</p>
                        <p><strong>Genere:</strong> ${quiz.genere || 'N/A'}</p>
                    </div>
                    <div>
                        <p><strong>Profilo:</strong> ${quiz.profilo || 'N/A'}</p>
                        <p><strong>Obiettivi:</strong> ${quiz.obiettivi || 'N/A'}</p>
                        <p><strong>Ostacoli:</strong> ${quiz.ostacoli || 'N/A'}</p>
                        <p><strong>Score:</strong> <span style="color: ${getScoreColor(score)}; font-weight: bold;">${score}%</span></p>
                    </div>
                </div>
                ${quiz.whatsapp ? `
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="action-button whatsapp" onclick="window.open('https://wa.me/${quiz.whatsapp.replace(/[^0-9]/g, '')}', '_blank')">
                            📱 Contatta su WhatsApp
                        </button>
                    </div>
                ` : ''}
            `;
            
            showModal(modalContent);
        }

        // View conversation details
        function viewConversationDetails(conversationId) {
            const conversation = currentConversationsData.find(c => c.id === conversationId);
            if (!conversation) return;
            
            let messagesHtml = '';
            if (conversation.messages && conversation.messages.length > 0) {
                messagesHtml = conversation.messages.map(msg => {
                    const isUser = msg.role === 'user';
                    const messageText = msg.message || msg.content || 'Messaggio non disponibile';
                    
                    return `
                        <div style="margin: 10px 0; display: flex; ${isUser ? 'justify-content: flex-end' : 'justify-content: flex-start'};">
                            <div style="
                                max-width: 70%; padding: 12px 16px; border-radius: 18px;
                                background: ${isUser ? '#ff6600' : '#444'};
                                color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            ">
                                <div style="font-size: 12px; font-weight: bold; margin-bottom: 4px;">
                                    ${isUser ? '👤 Cliente' : '🤖 TribuCoach'}
                                </div>
                                <div style="font-size: 14px; line-height: 1.4;">
                                    ${messageText}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                messagesHtml = '<div style="text-align: center; color: #aaa; font-style: italic; padding: 20px;">Nessun messaggio disponibile</div>';
            }
            
            const modalContent = `
                <h3>💬 Conversazione - ${conversation.customer}</h3>
                <div style="background: #333; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <p><strong>ID:</strong> ${conversation.id}</p>
                    <p><strong>Cliente:</strong> ${conversation.customer}</p>
                    <p><strong>Telefono:</strong> ${conversation.phone || 'Non disponibile'}</p>
                    <p><strong>Argomento:</strong> ${conversation.topic}</p>
                    <p><strong>Data:</strong> ${new Date(conversation.timestamp).toLocaleString('it-IT')}</p>
                </div>
                <div style="max-height: 400px; overflow-y: auto; background: #1a1a1a; border-radius: 8px; padding: 15px;">
                    ${messagesHtml}
                </div>
                ${conversation.phone ? `
                    <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #444;">
                        <button class="action-button whatsapp" onclick="window.open('https://wa.me/${conversation.phone.replace(/[^0-9]/g, '')}', '_blank')">
                            📱 Contatta su WhatsApp
                        </button>
                    </div>
                ` : ''}
            `;
            
            showModal(modalContent);
        }

        // Show modal
        function showModal(content) {
            document.getElementById('modal-body-content').innerHTML = content;
            document.getElementById('detailsModal').style.display = 'flex';
        }

        // Close modal
        function closeModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        // Update connection status
        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('connection-status');
            statusEl.textContent = message;
            statusEl.className = `connection-status status-${status}`;
            
            if (status === 'connected') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }

        // Update last update time
        function updateLastUpdate() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('it-IT');
            document.getElementById('last-update').textContent = timeString;
        }

        // Load quiz data
        async function loadQuizData() {
            try {
                currentQuizData = await getAllQuizResults();
                
                if (currentQuizData && currentQuizData.length > 0) {
                    renderQuizData(currentQuizData);
                    updateQuizMetrics(currentQuizData);
                    console.log(`✅ ${currentQuizData.length} quiz caricati`);
                } else {
                    document.getElementById('quiz-results-table-body').innerHTML = '<tr><td colspan="11" class="no-data">Nessun risultato quiz trovato</td></tr>';
                }
                
            } catch (error) {
                console.error('❌ Errore caricamento quiz:', error);
                document.getElementById('quiz-results-table-body').innerHTML = '<tr><td colspan="11" class="no-data" style="color: #f44336;">❌ Errore caricamento dati quiz</td></tr>';
            }
        }

        // Load chatbot data
        async function loadChatbotData() {
            try {
                currentConversationsData = await getChatbotConversations();
                
                if (currentConversationsData && currentConversationsData.length > 0) {
                    renderChatbotData(currentConversationsData);
                    updateChatbotMetrics(currentConversationsData);
                    console.log(`✅ ${currentConversationsData.length} conversazioni caricate`);
                } else {
                    document.getElementById('chatbot-conversations-table-body').innerHTML = '<tr><td colspan="7" class="no-data">Nessuna conversazione chatbot trovata</td></tr>';
                }
                
                // Initialize charts after both datasets are loaded
                if (currentQuizData && currentQuizData.length >= 0) {
                    setTimeout(() => {
                        try {
                            initializeCharts(currentQuizData || []);
                            updateBusinessInsights(currentQuizData || [], currentConversationsData || []);
                        } catch (error) {
                            console.error('❌ Errore inizializzazione grafici:', error);
                        }
                    }, 1000);
                }
                
            } catch (error) {
                console.error('❌ Errore caricamento conversazioni:', error);
                document.getElementById('chatbot-conversations-table-body').innerHTML = '<tr><td colspan="7" class="no-data" style="color: #f44336;">❌ Errore caricamento conversazioni</td></tr>';
            }
        }

        // Initialize dashboard
        async function initDashboard() {
            try {
                console.log('🚀 Inizializzazione dashboard...');
                updateConnectionStatus('connecting', 'Connessione Firebase...');
                
                // Prima inizializza Firebase
                const firebaseInit = await initFirebase();
                if (!firebaseInit) {
                    updateConnectionStatus('error', 'Errore inizializzazione Firebase');
                    return;
                }
                
                // Poi testa la connessione
                const connectionTest = await testConnection();
                if (connectionTest) {
                    console.log('✅ Connessione Firebase stabilita');
                    updateConnectionStatus('connected', 'Connesso a Firebase');
                } else {
                    console.error('❌ Problemi connessione Firebase');
                    updateConnectionStatus('error', 'Errore connessione Firebase');
                    return;
                }
                
                await Promise.all([
                    loadQuizData(),
                    loadChatbotData()
                ]);
                
                console.log('✅ Dashboard inizializzata con successo');
                updateLastUpdate();
                
            } catch (error) {
                console.error('❌ Errore inizializzazione dashboard:', error);
                updateConnectionStatus('error', 'Errore inizializzazione');
            }
        }

        // Close modal on outside click
        document.addEventListener('click', function(e) {
            if (e.target.id === 'detailsModal') {
                closeModal();
            }
        });

        // Initialize on DOM ready - CON DELAY
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📱 DOM caricato, aspetto Firebase...');
            
            // Aspetta un po' per assicurarsi che Firebase sia caricato
            setTimeout(() => {
                console.log('🚀 Avvio inizializzazione dashboard...');
                initDashboard();
            }, 500);
        });

        // Fallback se DOM già pronto
        if (document.readyState !== 'loading') {
            console.log('📱 DOM già pronto, aspetto Firebase...');
            setTimeout(() => {
                console.log('🚀 Avvio inizializzazione dashboard...');
                initDashboard();
            }, 500);
        }

        // Auto refresh every 5 minutes
        setInterval(() => {
            console.log('🔄 Refresh automatico dati...');
            initDashboard();
        }, 5 * 60 * 1000);

        console.log('✅ Dashboard.js caricato e pronto');
    </script>
</body>
</html><!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TribuCoach Dashboard - Business Intelligence</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="https://tribucoach.netlify.app/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="https://tribucoach.netlify.app/apple-touch-icon.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
            color: #fff;
            min-height: 100vh;
        }

        /* 🔐 Stili per controllo autenticazione */
        .auth-required {
            display: none;
        }

        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            z-index: 1001;
            transition: background-color 0.3s ease;
        }

        .logout-btn:hover {
            background: #d32f2f;
        }

        .session-info {
            position: fixed;
            top: 60px;
            right: 20px;
            background: rgba(42, 42, 42, 0.9);
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.8rem;
            color: #ccc;
            z-index: 1001;
        }

        .header {
            background: rgba(255,102,0,0.1);
            padding: 20px;
            border-bottom: 2px solid #ff6600;
        }

        .header h1 {
            color: #ff6600;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #ccc;
            font-size: 1rem;
        }

        .dashboard {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background-color: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
        }

        .metric-card h3 {
            color: #ff9933;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .metric-card p {
            font-size: 2.5rem;
            font-weight: bold;
            color: #fff;
        }

        .dashboard-section {
            background-color: #2a2a2a;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
            border: 1px solid #333;
        }

        .dashboard-section h2 {
            color: #ff6600;
            font-size: 1.8rem;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        /* Migliora layout tabella quiz */
        .data-table th, .data-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #333;
            color: #eee;
            font-size: 0.85rem;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .data-table th {
            background-color: #3a3a3a;
            color: #ff9933;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.8rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td:hover {
            white-space: normal;
            word-wrap: break-word;
            max-width: none;
        }

        .data-table tbody tr:hover {
            background-color: #333;
        }

        .action-button {
            background-color: #ff6600;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-right: 5px;
            transition: background-color 0.2s ease;
        }

        .action-button:hover {
            background-color: #ff8533;
        }

        .action-button.whatsapp {
            background-color: #25D366;
        }

        .action-button.whatsapp:hover {
            background-color: #20b055;
        }

        .no-data {
            text-align: center;
            color: #aaa;
            padding: 20px;
        }

        /* Status Connessione */
        .connection-status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9rem;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .status-connected {
            background: #4CAF50;
            color: white;
        }

        .status-connecting {
            background: #ff9800;
            color: white;
            animation: pulse 1.5s infinite;
        }

        .status-error {
            background: #f44336;
            color: white;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Charts & Lists */
        .chart-container {
            margin-top: 20px;
            background-color: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            height: 350px;
            border: 1px solid #333;
        }

        .chart-container canvas {
            max-height: 300px !important;
        }

        .insights-list {
            list-style: none;
            padding: 0;
        }

        .insights-list li {
            background-color: #333;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 5px solid #ff6600;
        }

        .insights-list strong {
            color: #ff9933;
        }

        /* Badge score migliorati */
        .score-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* Colonne specifiche - 11 colonne */
        .data-table th:nth-child(1), .data-table td:nth-child(1) { min-width: 80px; } /* Nome */
        .data-table th:nth-child(2), .data-table td:nth-child(2) { min-width: 50px; } /* Età */
        .data-table th:nth-child(3), .data-table td:nth-child(3) { min-width: 180px; } /* Email */
        .data-table th:nth-child(4), .data-table td:nth-child(4) { min-width: 100px; } /* WhatsApp */
        .data-table th:nth-child(5), .data-table td:nth-child(5) { min-width: 70px; } /* Genere */
        .data-table th:nth-child(6), .data-table td:nth-child(6) { min-width: 120px; } /* Profilo */
        .data-table th:nth-child(7), .data-table td:nth-child(7) { min-width: 200px; } /* Obiettivi */
        .data-table th:nth-child(8), .data-table td:nth-child(8) { min-width: 150px; } /* Ostacoli */
        .data-table th:nth-child(9), .data-table td:nth-child(9) { min-width: 70px; text-align: center; } /* Score */
        .data-table th:nth-child(10), .data-table td:nth-child(10) { min-width: 100px; } /* Data */
        .data-table th:nth-child(11), .data-table td:nth-child(11) { min-width: 120px; text-align: center; } /* Azioni */

        /* Scroll orizzontale per tabelle */
        .table-responsive {
            overflow-x: auto;
            background: linear-gradient(90deg, rgba(255,255,255,0.1) 0%, transparent 100%);
            border-radius: 8px;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #2a2a2a;
            margin: auto;
            padding: 30px;
            border: 1px solid #444;
            border-radius: 10px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            position: relative;
            animation: fadeIn 0.3s ease-out;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover {
            color: #fff;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard {
                padding: 15px;
            }
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            .data-table th, .data-table td {
                padding: 8px 10px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body class="auth-required">
    <div class="connection-status" id="connection-status">Connessione...</div>

    <!-- Controlli autenticazione -->
    <button class="logout-btn" onclick="logout()" title="Logout">🚪 Logout</button>
    <div class="session-info" id="sessionInfo">👤 Sessione attiva</div>

    <header class="header">
        <h1>📈 TribuCoach Dashboard BI</h1>
        <p>Monitoraggio in tempo reale di lead, interazioni chatbot e performance business.</p>
    </header>

    <div class="dashboard">
        <div class="metrics-grid">
            <div class="metric-card">
                <h3>Totale Lead (Quiz)</h3>
                <p id="totalQuizzes">0</p>
            </div>
            <div class="metric-card">
                <h3>Score Medio Lead</h3>
                <p id="avgQuizScore">0%</p>
            </div>
            <div class="metric-card">
                <h3>Conversazioni Chatbot</h3>
                <p id="totalChatConversations">0</p>
            </div>
            <div class="metric-card">
                <h3>Ultimo Aggiornamento</h3>
                <p id="last-update">Caricamento...</p>
            </div>
        </div>

        <div class="dashboard-section">
            <h2>🥇 Dati Quiz - Gestione Lead</h2>
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Età</th>
                            <th>Email</th>
                            <th>WhatsApp</th>
                            <th>Genere</th>
                            <th>Profilo</th>
                            <th>Obiettivi</th>
                            <th>Ostacoli</th>
                            <th>Score</th>
                            <th>Data Quiz</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="quiz-results-table-body">
                        <tr><td colspan="11" class="no-data">Caricamento risultati quiz...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="dashboard-section">
            <h2>💬 Dati Chatbot - Interazioni Clienti</h2>
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID Conversazione</th>
                            <th>Nome Cliente</th>
                            <th>Telefono</th>
                            <th>Ultimo Messaggio</th>
                            <th>Argomento Rilevato</th>
                            <th>Data Ultima Attività</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="chatbot-conversations-table-body">
                        <tr><td colspan="7" class="no-data">Caricamento conversazioni chatbot...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="dashboard-section">
            <h2>📊 Riepilogo Attività & Performance</h2>
            <div class="metrics-grid">
                <div class="metric-card">
                    <h3>Totale Quiz Completati</h3>
                    <p id="kpiTotalQuizzes">0</p>
                </div>
                <div class="metric-card">
                    <h3>Totale Conversazioni Bot</h3>
                    <p id="kpiTotalChatConversations">0</p>
                </div>
                <div class="metric-card">
                    <h3>Leads ad Alto Punteggio (>= 70%)</h3>
                    <p id="highScoreLeads">0</p>
                </div>
            </div>

            <h3>Distribuzione Obiettivi Principali</h3>
            <div id="goalDistribution" class="chart-container">
                <canvas id="goalChart"></canvas>
            </div>

            <h3>Argomenti di Chat più Frequenti</h3>
            <div id="chatTopics" class="chart-container">
                <canvas id="chatTopicChart"></canvas>
            </div>

            <h3>📈 Insights Engagement & Performance</h3>
            <div id="engagementInsights" class="chart-container" style="height: auto; padding: 0;">
                
                <!-- PRIMA RIGA: 2 blocchi principali affiancati -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; padding: 25px 25px 0 25px;">
                    
                    <div style="background: linear-gradient(135deg, #333 0%, #404040 100%); padding: 25px; border-radius: 12px; border-left: 4px solid #ff6600; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                        <h4 style="color: #ff6600; margin-bottom: 20px; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
                            💬 Attività Chat Giornaliera
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Chat Oggi:</strong></p>
                                <p style="margin: 0; color: #4CAF50; font-weight: bold; font-size: 1.8rem;" id="chatsToday">0</p>
                            </div>
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Utenti Attivi:</strong></p>
                                <p style="margin: 0; color: #2196F3; font-weight: bold; font-size: 1.8rem;" id="activeUsersToday">0</p>
                            </div>
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Durata Media:</strong></p>
                                <p style="margin: 0; color: #ff9800; font-weight: bold; font-size: 1.5rem;" id="avgSessionDuration">0 min</p>
                            </div>
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Ultimo Contatto:</strong></p>
                                <p style="margin: 0; color: #ccc; font-weight: bold; font-size: 1rem;" id="lastChatActivity">N/A</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #333 0%, #404040 100%); padding: 25px; border-radius: 12px; border-left: 4px solid #4CAF50; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                        <h4 style="color: #4CAF50; margin-bottom: 20px; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
                            🎯 Quality Score & Conversioni
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Score Medio:</strong></p>
                                <p style="margin: 0; color: #4CAF50; font-weight: bold; font-size: 1.8rem;" id="avgLeadScore">0%</p>
                            </div>
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Lead Premium:</strong></p>
                                <p style="margin: 0; color: #FFD700; font-weight: bold; font-size: 1.8rem;" id="premiumLeads">0</p>
                            </div>
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Lead Qualificati:</strong></p>
                                <p style="margin: 0; color: #ff9800; font-weight: bold; font-size: 1.5rem;" id="qualifiedLeadsInsight">0</p>
                            </div>
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Tasso Conversione:</strong></p>
                                <p style="margin: 0; color: #9C27B0; font-weight: bold; font-size: 1.5rem;" id="chatConversionRate">0%</p>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
                <!-- SECONDA RIGA: 2 blocchi affiancati -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; padding: 25px;">
                    
                    <div style="background: linear-gradient(135deg, #333 0%, #404040 100%); padding: 25px; border-radius: 12px; border-left: 4px solid #2196F3; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                        <h4 style="color: #2196F3; margin-bottom: 20px; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
                            ⏰ Timing & Frequenza
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Quiz Oggi:</strong></p>
                                <p style="margin: 0; color: #4CAF50; font-weight: bold; font-size: 1.8rem;" id="quizzesToday">0</p>
                            </div>
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Picco Attività:</strong></p>
                                <p style="margin: 0; color: #ff9800; font-weight: bold; font-size: 1.2rem;" id="peakActivity">N/A</p>
                            </div>
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Msg/Chat:</strong></p>
                                <p style="margin: 0; color: #9C27B0; font-weight: bold; font-size: 1.5rem;" id="avgMessagesPerChat">0</p>
                            </div>
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Chat Settimana:</strong></p>
                                <p style="margin: 0; color: #2196F3; font-weight: bold; font-size: 1.5rem;" id="chatsThisWeek">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #333 0%, #404040 100%); padding: 25px; border-radius: 12px; border-left: 4px solid #9C27B0; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                        <h4 style="color: #9C27B0; margin-bottom: 20px; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
                            🔥 Trend & Argomenti Caldi
                        </h4>
                        <div style="space-y: 12px;">
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Top Quiz Goal:</strong></p>
                                <p style="margin: 0 0 12px 0; color: #ff6600; font-weight: bold; font-size: 1rem; line-height: 1.3;" id="topQuizGoal">N/A</p>
                            </div>
                            <div>
                                <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Top Chat Topic:</strong></p>
                                <p style="margin: 0 0 12px 0; color: #4CAF50; font-weight: bold; font-size: 1rem;" id="topChatTopic">N/A</p>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                <div>
                                    <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Trend Emergente:</strong></p>
                                    <p style="margin: 0; color: #ff9800; font-weight: bold; font-size: 0.95rem;" id="emergingTrend">N/A</p>
                                </div>
                                <div>
                                    <p style="margin: 8px 0; color: #ccc; font-size: 0.9rem;"><strong>Crescita:</strong></p>
                                    <p style="margin: 0; color: #2196F3; font-weight: bold; font-size: 1.3rem;" id="weeklyGrowth">0%</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
                <!-- SPAZIO PER FUTURI BLOCCHI -->
                <div style="padding: 0 25px 25px 25px;">
                    <div style="border: 2px dashed #444; border-radius: 12px; padding: 20px; text-align: center; color: #666;">
                        <p style="margin: 0; font-style: italic;">💡 Spazio riservato per metriche aggiuntive</p>
                        <p style="margin: 5px 0 0 0; font-size: 0.8rem;">Nuovi insights e KPI verranno aggiunti qui</p>
                    </div>
                </div>
                
            </div>
        </div>

        <div class="dashboard-section">
            <h2>💡 Opportunità Business & Insights</h2>
            
            <!-- Metriche Business in evidenza -->
            <div style="background: linear-gradient(135deg, #ff6600 0%, #ff8533 100%); padding: 25px; border-radius: 15px; margin-bottom: 30px; text-align: center; box-shadow: 0 8px 25px rgba(255,102,0,0.3);">
                <h3 style="color: white; margin-bottom: 20px; font-size: 1.8rem;">🎯 Business Intelligence Dashboard</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <div style="font-size: 1.8rem; font-weight: bold; color: white; line-height: 1.2;" id="topGoalMain">Perdere peso</div>
                        <div style="color: rgba(255,255,255,0.9); font-size: 1rem; margin-top: 5px;">🔥 Obiettivo Top</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <div style="font-size: 1.8rem; font-weight: bold; color: white; line-height: 1.2;" id="topObstacleMain">Mancanza di tempo</div>
                        <div style="color: rgba(255,255,255,0.9); font-size: 1rem; margin-top: 5px;">⚡ Ostacolo Principale</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <div style="font-size: 2.5rem; font-weight: bold; color: white;" id="conversionRateMain">0%</div>
                        <div style="color: rgba(255,255,255,0.9); font-size: 1rem; margin-top: 5px;">📈 Tasso Conversione</div>
                    </div>
                </div>
            </div>

            <!-- Business Insights dinamici -->
            <ul class="insights-list" style="margin-top: 0;">
                <li><strong>📊 Dashboard:</strong> Dati in caricamento...</li>
            </ul>
        </div>

    </div>

    <div id="detailsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <div id="modal-body-content"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Script di autenticazione