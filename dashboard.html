<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TribuCoach Dashboard - Business Intelligence</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: sans-serif; background: #f5f5f5; margin: 0; color: #333; }
    .metrics-grid { display: flex; flex-wrap: wrap; gap: 1rem; margin: 1rem; }
    .metric-card { background: white; border-radius: 8px; padding: 1rem; flex: 1; min-width: 200px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .metric-card h3 { margin-top: 0; font-size: 1.2rem; }
    section { background: white; margin: 1rem; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .lead-card, .chat-card { background: #fff; margin-bottom: 1rem; border-radius: 8px; padding: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .lead-header, .chat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .lead-name, .chat-client { font-weight: bold; }
    .lead-score { font-weight: bold; }
    .lead-details, .chat-preview, .chat-meta { font-size: 0.9rem; }
    .lead-actions, .chat-actions { margin-top: 0.5rem; }
    .btn.whatsapp { background: #25D366; color: white; padding: 0.5rem 1rem; border: none; border-radius: 5px; cursor: pointer; text-decoration: none; }
    .connection-status { text-align: center; padding: 0.5rem; font-weight: bold; }
    .connection-status.loading { background: orange; color: white; }
    .connection-status.connected { background: green; color: white; }
    .connection-status.error { background: red; color: white; }
  </style>
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
  import { getFirestore, collection, getDocs, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyDSsQEPii_Eb99cWGs7eqozgTtIqbtO2rs",
    authDomain: "tribucoach-a2254.firebaseapp.com",
    projectId: "tribucoach-a2254",
    storageBucket: "tribucoach-a2254.firebasestorage.app",
    messagingSenderId: "425200296836",
    appId: "1:425200296836:web:7835188f40f4348567ab48"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let leadsData = [];
  let chatsData = [];

  function updateStatus(type, message) {
    const statusEl = document.getElementById('connectionStatus');
    statusEl.className = `connection-status ${type}`;
    statusEl.textContent = message;
  }

  async function loadQuizResults() {
    try {
      console.log('📊 Caricamento quiz results...');
      const q = query(collection(db, 'quiz_results'), orderBy('timestamp', 'desc'), limit(50));
      const querySnapshot = await getDocs(q);

      leadsData = [];
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        leadsData.push({
          id: doc.id,
          name: data.name || 'Nome non disponibile',
          email: data.email || 'Non disponibile',
          phone: data.whatsapp || data.phone || 'Non disponibile',
          age: data.age || 'N/A',
          gender: data.gender || 'N/A',
          score: data.score || calculateScore(data),
          profile: data.fitnessPersonality || data.profile || 'Non specificato',
          goals: extractArray(data.goals || data.fitnessGoals),
          timestamp: data.timestamp?.toDate() || new Date(),
          source: 'Firebase'
        });
      });
      console.log(`📊 Caricati ${leadsData.length} lead da Firebase`);
    } catch (error) {
      console.error('❌ Errore caricamento quiz:', error);
    }
  }

  async function loadConversations() {
    try {
      console.log('💬 Caricamento conversazioni...');
      const collections = ['chatbase_conversations', 'conversations', 'chatbot_conversations', 'chats'];

      for (const collectionName of collections) {
        try {
          const q = query(collection(db, collectionName), limit(30));
          const querySnapshot = await getDocs(q);

          if (querySnapshot.size > 0) {
            chatsData = [];
            querySnapshot.forEach((doc) => {
              const data = doc.data();
              chatsData.push({
                id: doc.id,
                clientName: data.customerName || extractNameFromMessages(data.messages) || 'Cliente Anonimo',
                phone: data.phone || extractPhoneFromMessages(data.messages) || 'N/A',
                topic: data.topic || 'Conversazione generale',
                lastMessage: getLastMessage(data.messages),
                timestamp: data.timestamp?.toDate() || new Date(),
                source: collectionName === 'chatbase_conversations' ? 'Chatbase' : 'Firebase'
              });
            });
            console.log(`💬 Caricate ${chatsData.length} conversazioni da ${collectionName}`);
            break;
          }
        } catch (e) {
          console.log(`Collection ${collectionName} non trovata`);
        }
      }
    } catch (error) {
      console.error('❌ Errore caricamento conversazioni:', error);
    }
  }

  function calculateScore(data) {
    let score = 50;
    if (data.email && data.email.length > 5) score += 15;
    if (data.name && data.name.length > 2) score += 10;
    if (data.whatsapp || data.phone) score += 20;
    if (data.goals && data.goals.length > 0) score += 5;
    return Math.min(score, 100);
  }

  function extractArray(value) {
    if (Array.isArray(value)) return value;
    if (typeof value === 'string') return value.split(',').map(v => v.trim());
    return ['Non specificato'];
  }

  function extractNameFromMessages(messages) {
    if (!messages) return null;
    for (const msg of messages) {
      if (msg.role === 'user' && msg.content) {
        const match = msg.content.match(/(?:mi chiamo|sono)\s+([a-zA-Z\s]{2,20})/i);
        if (match) return match[1].trim();
      }
    }
    return null;
  }

  function extractPhoneFromMessages(messages) {
    if (!messages) return null;
    for (const msg of messages) {
      if (msg.role === 'user' && msg.content) {
        const match = msg.content.match(/([0-9]{3}\s?[0-9]{3}\s?[0-9]{4})/);
        if (match) return '+39 ' + match[1].replace(/\s/g, '');
      }
    }
    return null;
  }

  function getLastMessage(messages) {
    if (messages && messages.length > 0) {
      const lastMsg = messages[messages.length - 1];
      return lastMsg.content || lastMsg.message || 'Nessun contenuto';
    }
    return 'Nessun messaggio';
  }
  function updateMetrics() {
    const totalLeads = leadsData.length;
    const avgScore = totalLeads > 0 ? Math.round(leadsData.reduce((sum, l) => sum + (l.score || 0), 0) / totalLeads) : 0;
    const totalChats = chatsData.length;
    const premiumLeads = leadsData.filter(l => (l.score || 0) > 80).length;

    document.getElementById('totalLeads').textContent = totalLeads;
    document.getElementById('avgScore').textContent = avgScore + '%';
    document.getElementById('totalChats').textContent = totalChats;
    document.getElementById('premiumLeads').textContent = premiumLeads;
  }

  function renderLeads() {
    const container = document.getElementById('leadsContainer');
    if (leadsData.length === 0) {
      container.innerHTML = `<div class="empty-state"><div class="icon">📭</div><p>Nessun lead trovato</p></div>`;
      return;
    }
    container.innerHTML = leadsData.slice(0, 8).map(l => `
      <div class="lead-card">
        <div class="lead-header"><div><div class="lead-name">${l.name}</div><div class="lead-profile">${l.profile}</div></div><div class="lead-score">${l.score}%</div></div>
        <div class="lead-details">
          <div><span class="label">📧 Email:</span> ${l.email}</div>
          <div><span class="label">📱 Phone:</span> ${l.phone}</div>
          <div><span class="label">🎯 Goals:</span> ${l.goals.join(', ')}</div>
          <div><span class="label">📅 Data:</span> ${l.timestamp.toLocaleDateString('it-IT')}</div>
        </div>
        <div class="lead-actions">${l.phone !== 'Non disponibile' && l.phone !== 'N/A' ? `<button class="btn whatsapp" onclick="openWhatsApp('${l.phone}')">📱 WhatsApp</button>` : ''}</div>
      </div>`).join('');
  }

  function renderChats() {
    const container = document.getElementById('chatsContainer');
    if (chatsData.length === 0) {
      container.innerHTML = `<div class="empty-state"><div class="icon">💬</div><p>Nessuna conversazione trovata</p></div>`;
      return;
    }
    container.innerHTML = chatsData.slice(0, 6).map(c => `
      <div class="chat-card">
        <div class="chat-header"><div class="chat-client">${c.clientName}</div><div class="chat-topic">${c.topic}</div><div class="chat-source">🔗 ${c.source}</div></div>
        <div class="chat-preview">"${c.lastMessage.substring(0, 60)}..."</div>
        <div class="chat-meta"><span>📱 ${c.phone}</span><span>📅 ${c.timestamp.toLocaleDateString('it-IT')}</span></div>
        <div class="chat-actions">${c.phone !== 'N/A' ? `<button class="btn whatsapp" onclick="openWhatsApp('${c.phone}')">📱 WhatsApp</button>` : ''}</div>
      </div>`).join('');
  }

  function updateCharts() {
    const ctx = document.getElementById('chartLeads').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Lead', 'Conversazioni'],
        datasets: [{
          label: 'Totali',
          data: [leadsData.length, chatsData.length],
          backgroundColor: ['#4CAF50', '#2196F3']
        }]
      },
      options: { responsive: true }
    });
  }

  window.openWhatsApp = phone => {
    if (!phone || phone === 'N/A') return alert('Numero non disponibile');
    window.open(`https://wa.me/${phone.replace(/[^\d+]/g, '')}`, '_blank');
  };

  async function loadAllData() {
    try {
      updateStatus('loading', '📊 Caricamento dati da Firebase...');
      await Promise.all([loadQuizResults(), loadConversations()]);
      updateMetrics();
      renderLeads();
      renderChats();
      updateCharts();
      updateStatus('connected', '✅ Dati caricati da Firebase');
      console.log('✅ Tutti i dati caricati con successo');
    } catch (error) {
      console.error('❌ Errore caricamento dati:', error);
      updateStatus('error', '❌ Errore caricamento dati');
    }
  }

  async function init() {
    console.log('🚀 Inizializzazione TribuCoach Dashboard...');
    updateStatus('loading', '🔄 Connessione a Firebase...');
    await loadAllData();
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();
</script>
</head>
<body>
  <div class="connection-status loading" id="connectionStatus">🔄 Connessione a Firebase in corso...</div>

  <div class="metrics-grid">
    <div class="metric-card"><h3>🎯 Totale Lead Generati</h3><p id="totalLeads">0</p></div>
    <div class="metric-card"><h3>⭐ Score Medio Lead</h3><p id="avgScore">0%</p></div>
    <div class="metric-card"><h3>💬 Conversazioni Attive</h3><p id="totalChats">0</p></div>
    <div class="metric-card"><h3>🔥 Lead Premium (&gt;80%)</h3><p id="premiumLeads">0</p></div>
  </div>

  <section><h2>📈 Analytics Lead & Chat</h2><canvas id="chartLeads" height="100"></canvas></section>

  <section><h2>📋 Lead Recenti</h2><div id="leadsContainer"></div></section>

  <section><h2>💬 Conversazioni Chatbot</h2><div id="chatsContainer"></div></section>
</body></html>



