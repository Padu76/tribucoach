<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - LifestyleFitnessCoach</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: #f8fafc;
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* HEADER */
        .dashboard-header {
            background: linear-gradient(135deg, #ea580c 0%, #f97316 100%);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(234, 88, 12, 0.3);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 2rem;
            font-weight: bold;
            color: white;
            margin-bottom: 0.5rem;
        }

        .header-subtitle {
            color: rgba(255,255,255,0.9);
            font-size: 1rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .admin-badge {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .refresh-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* KPI CARDS */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #475569;
            transition: all 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .kpi-title {
            font-size: 0.9rem;
            color: #94a3b8;
            text-transform: uppercase;
            font-weight: 600;
        }

        .kpi-icon {
            font-size: 1.5rem;
            opacity: 0.8;
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ea580c;
            margin-bottom: 0.5rem;
        }

        .kpi-change {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .kpi-change.positive {
            color: #22c55e;
        }

        .kpi-change.negative {
            color: #ef4444;
        }

        /* FILTERS */
        .filters-section {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #475569;
        }

        .filters-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #ea580c;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.9rem;
            color: #94a3b8;
            font-weight: 500;
        }

        .filter-select, .filter-input {
            background: #0f172a;
            border: 1px solid #475569;
            color: #f8fafc;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #ea580c;
        }

        /* USERS TABLE */
        .users-section {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #475569;
        }

        .users-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .users-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #ea580c;
        }

        .users-count {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .export-btn {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            background: #0f172a;
            border-radius: 8px;
            overflow: hidden;
        }

        .users-table th {
            background: #1e293b;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #ea580c;
            font-size: 0.9rem;
            border-bottom: 1px solid #475569;
        }

        .users-table td {
            padding: 1rem;
            border-bottom: 1px solid #334155;
            font-size: 0.9rem;
        }

        .users-table tbody tr:hover {
            background: #1e293b;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ea580c, #f97316);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            color: #f8fafc;
        }

        .user-email {
            color: #94a3b8;
            font-size: 0.8rem;
        }

        .role-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .role-admin {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .role-beta {
            background: rgba(168, 85, 247, 0.2);
            color: #c4b5fd;
        }

        .role-user {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }

        .progress-bar {
            width: 100px;
            height: 8px;
            background: #334155;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ea580c, #f97316);
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-top: 0.25rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-active {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        .status-partial {
            background: rgba(251, 191, 36, 0.2);
            color: #fde047;
        }

        .status-inactive {
            background: rgba(107, 114, 128, 0.2);
            color: #d1d5db;
        }

        .last-activity {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .action-btn {
            background: #334155;
            border: 1px solid #475569;
            color: #f8fafc;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: #475569;
            border-color: #ea580c;
        }

        /* USER DETAIL MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-radius: 16px;
            padding: 2rem;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #475569;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #475569;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #ea580c;
        }

        .close-btn {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #475569;
            color: #f8fafc;
        }

        .user-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .detail-section {
            background: #0f172a;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #334155;
        }

        .detail-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ea580c;
            margin-bottom: 1rem;
        }

        .week-progress {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .week-item {
            text-align: center;
            padding: 0.75rem 0.5rem;
            border-radius: 6px;
            border: 1px solid #334155;
            font-size: 0.8rem;
        }

        .week-item.completed {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
            color: #86efac;
        }

        .week-item.partial {
            background: rgba(251, 191, 36, 0.2);
            border-color: #fbbf24;
            color: #fde047;
        }

        .week-item.not-started {
            background: rgba(107, 114, 128, 0.2);
            border-color: #6b7280;
            color: #d1d5db;
        }

        .notes-section {
            grid-column: 1 / -1;
        }

        .notes-textarea {
            width: 100%;
            min-height: 100px;
            background: #0f172a;
            border: 1px solid #475569;
            color: #f8fafc;
            padding: 1rem;
            border-radius: 6px;
            resize: vertical;
            font-family: inherit;
        }

        .save-notes-btn {
            background: linear-gradient(135deg, #ea580c 0%, #f97316 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 1rem;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 0 1rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .users-table {
                font-size: 0.8rem;
            }

            .users-table th,
            .users-table td {
                padding: 0.75rem 0.5rem;
            }

            .user-detail-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                padding: 1.5rem;
            }
        }

        /* LOADING STATES */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .skeleton {
            background: linear-gradient(90deg, #334155 25%, #475569 50%, #334155 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .no-data {
            text-align: center;
            padding: 3rem;
            color: #94a3b8;
        }

        .no-data-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- HEADER -->
        <div class="dashboard-header">
            <div class="header-content">
                <div>
                    <h1 class="header-title">üëë Admin Dashboard</h1>
                    <p class="header-subtitle">Monitoring e gestione completa degli utenti - Andrea Padoan Coach</p>
                </div>
                <div class="header-actions">
                    <div class="admin-badge">üéØ Coach Admin</div>
                    <button class="refresh-btn" onclick="refreshDashboard()">üîÑ Aggiorna</button>
                </div>
            </div>
        </div>

        <!-- KPI CARDS -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-header">
                    <span class="kpi-title">Utenti Totali</span>
                    <span class="kpi-icon">üë•</span>
                </div>
                <div class="kpi-value" id="totalUsers">0</div>
                <div class="kpi-change positive">
                    <span>‚ÜóÔ∏è</span>
                    <span id="usersChange">+0% questa settimana</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-header">
                    <span class="kpi-title">Utenti Attivi</span>
                    <span class="kpi-icon">‚ö°</span>
                </div>
                <div class="kpi-value" id="activeUsers">0</div>
                <div class="kpi-change positive">
                    <span>üìà</span>
                    <span id="activeChange">Ultimi 7 giorni</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-header">
                    <span class="kpi-title">Conversione Quiz</span>
                    <span class="kpi-icon">üéØ</span>
                </div>
                <div class="kpi-value" id="conversionRate">0%</div>
                <div class="kpi-change positive">
                    <span>üìä</span>
                    <span>Quiz ‚Üí Registrazione</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-header">
                    <span class="kpi-title">Completamento</span>
                    <span class="kpi-icon">‚úÖ</span>
                </div>
                <div class="kpi-value" id="completionRate">0%</div>
                <div class="kpi-change positive">
                    <span>üèÜ</span>
                    <span>Media Week 1-7</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-header">
                    <span class="kpi-title">Revenue Potenziale</span>
                    <span class="kpi-icon">üí∞</span>
                </div>
                <div class="kpi-value" id="potentialRevenue">‚Ç¨0</div>
                <div class="kpi-change positive">
                    <span>üíé</span>
                    <span>Freemium model</span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-header">
                    <span class="kpi-title">Sessioni Oggi</span>
                    <span class="kpi-icon">üìÖ</span>
                </div>
                <div class="kpi-value" id="todaySessions">0</div>
                <div class="kpi-change positive">
                    <span>üî•</span>
                    <span>Attivit√† oggi</span>
                </div>
            </div>
        </div>

        <!-- FILTERS -->
        <div class="filters-section">
            <h3 class="filters-title">üîç Filtri e Ricerca</h3>
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">Ruolo</label>
                    <select class="filter-select" id="roleFilter" onchange="applyFilters()">
                        <option value="">Tutti i ruoli</option>
                        <option value="admin">Admin</option>
                        <option value="beta">Beta Tester</option>
                        <option value="user">Utenti</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Stato Progresso</label>
                    <select class="filter-select" id="progressFilter" onchange="applyFilters()">
                        <option value="">Tutti gli stati</option>
                        <option value="not-started">Non iniziato</option>
                        <option value="in-progress">In corso</option>
                        <option value="completed">Completato</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Ultima Attivit√†</label>
                    <select class="filter-select" id="activityFilter" onchange="applyFilters()">
                        <option value="">Tutte le date</option>
                        <option value="today">Oggi</option>
                        <option value="week">Questa settimana</option>
                        <option value="month">Questo mese</option>
                        <option value="inactive">Inattivi 30+ giorni</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Cerca per Nome/Email</label>
                    <input type="text" class="filter-input" id="searchFilter" placeholder="Cerca utente..." oninput="applyFilters()">
                </div>
            </div>
        </div>

        <!-- USERS TABLE -->
        <div class="users-section">
            <div class="users-header">
                <div>
                    <h3 class="users-title">üë• Gestione Utenti</h3>
                    <p class="users-count">Mostrando <span id="visibleUsers">0</span> di <span id="totalUsersCount">0</span> utenti</p>
                </div>
                <button class="export-btn" onclick="exportUsers()">üìä Esporta CSV</button>
            </div>

            <div style="overflow-x: auto;">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Utente</th>
                            <th>Ruolo</th>
                            <th>Progresso</th>
                            <th>Stato Sessioni</th>
                            <th>Ultima Attivit√†</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <div id="noUsersMessage" class="no-data" style="display: none;">
                <div class="no-data-icon">üë•</div>
                <h3>Nessun utente trovato</h3>
                <p>Modifica i filtri o attendi nuove registrazioni</p>
            </div>
        </div>
    </div>

    <!-- USER DETAIL MODAL -->
    <div class="modal-overlay" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalUserName">Dettaglio Utente</h2>
                <button class="close-btn" onclick="closeUserModal()">&times;</button>
            </div>

            <div class="user-detail-grid">
                <div class="detail-section">
                    <h4 class="detail-title">üìä Informazioni Generali</h4>
                    <div id="userGeneralInfo">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="detail-section">
                    <h4 class="detail-title">üìà Statistiche Attivit√†</h4>
                    <div id="userStats">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="detail-section">
                    <h4 class="detail-title">üéØ Progresso Settimane</h4>
                    <div class="week-progress" id="weekProgress">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="detail-section">
                    <h4 class="detail-title">üìù Quiz e Profilo</h4>
                    <div id="userProfile">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="detail-section notes-section">
                    <h4 class="detail-title">üìù Note Coaching</h4>
                    <textarea class="notes-textarea" id="userNotes" placeholder="Aggiungi note private su questo utente..."></textarea>
                    <button class="save-notes-btn" onclick="saveUserNotes()">üíæ Salva Note</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // MOCK DATA - In produzione questi dati arriverebbero da Firebase
        let usersData = [
            {
                id: 'user_001',
                name: 'Marco Rossi',
                email: 'marco.rossi@gmail.com',
                role: 'user',
                registrationDate: '2025-01-15',
                lastActivity: '2025-01-31',
                profileType: 'Guerriero Determinato',
                leadScore: 85,
                weekProgress: {
                    1: { status: 'completed', duration: 45, completedAt: '2025-01-16' },
                    2: { status: 'partial', duration: 20, completedAt: null },
                    3: { status: 'not-started', duration: 0, completedAt: null },
                    4: { status: 'not-started', duration: 0, completedAt: null },
                    5: { status: 'not-started', duration: 0, completedAt: null },
                    6: { status: 'not-started', duration: 0, completedAt: null },
                    7: { status: 'not-started', duration: 0, completedAt: null }
                },
                totalTimeSpent: 65,
                quizCompleted: true,
                notes: ''
            },
            {
                id: 'user_002',
                name: 'Laura Bianchi',
                email: 'laura.bianchi@yahoo.it',
                role: 'user',
                registrationDate: '2025-01-20',
                lastActivity: '2025-01-30',
                profileType: 'Esploratore Motivato',
                leadScore: 92,
                weekProgress: {
                    1: { status: 'completed', duration: 38, completedAt: '2025-01-21' },
                    2: { status: 'completed', duration: 42, completedAt: '2025-01-25' },
                    3: { status: 'completed', duration: 35, completedAt: '2025-01-28' },
                    4: { status: 'partial', duration: 15, completedAt: null },
                    5: { status: 'not-started', duration: 0, completedAt: null },
                    6: { status: 'not-started', duration: 0, completedAt: null },
                    7: { status: 'not-started', duration: 0, completedAt: null }
                },
                totalTimeSpent: 130,
                quizCompleted: true,
                notes: 'Utente molto motivato, fa domande pertinenti'
            },
            {
                id: 'admin_001',
                name: 'Andrea Padoan',
                email: 'admin@tribucoach.com',
                role: 'admin',
                registrationDate: '2025-01-01',
                lastActivity: '2025-01-31',
                profileType: 'Coach Admin',
                leadScore: 100,
                weekProgress: {
                    1: { status: 'completed', duration: 60, completedAt: '2025-01-01' },
                    2: { status: 'completed', duration: 55, completedAt: '2025-01-01' },
                    3: { status: 'completed', duration: 50, completedAt: '2025-01-01' },
                    4: { status: 'completed', duration: 48, completedAt: '2025-01-01' },
                    5: { status: 'completed', duration: 52, completedAt: '2025-01-01' },
                    6: { status: 'completed', duration: 49, completedAt: '2025-01-01' },
                    7: { status: 'completed', duration: 58, completedAt: '2025-01-01' }
                },
                totalTimeSpent: 372,
                quizCompleted: true,
                notes: 'Account amministratore - Accesso completo'
            },
            {
                id: 'beta_001',
                name: 'Beta Tester',
                email: 'beta@tribucoach.com',
                role: 'beta',
                registrationDate: '2025-01-10',
                lastActivity: '2025-01-31',
                profileType: 'Atleta in Crescita',
                leadScore: 88,
                weekProgress: {
                    1: { status: 'completed', duration: 42, completedAt: '2025-01-11' },
                    2: { status: 'completed', duration: 39, completedAt: '2025-01-15' },
                    3: { status: 'partial', duration: 25, completedAt: null },
                    4: { status: 'not-started', duration: 0, completedAt: null },
                    5: { status: 'not-started', duration: 0, completedAt: null },
                    6: { status: 'not-started', duration: 0, completedAt: null },
                    7: { status: 'not-started', duration: 0, completedAt: null }
                },
                totalTimeSpent: 106,
                quizCompleted: true,
                notes: 'Beta tester attivo, fornisce feedback utili'
            },
            {
                id: 'user_003',
                name: 'Giuseppe Verdi',
                email: 'g.verdi@libero.it',
                role: 'user',
                registrationDate: '2025-01-25',
                lastActivity: '2025-01-26',
                profileType: 'Guerriero Determinato',
                leadScore: 75,
                weekProgress: {
                    1: { status: 'partial', duration: 18, completedAt: null },
                    2: { status: 'not-started', duration: 0, completedAt: null },
                    3: { status: 'not-started', duration: 0, completedAt: null },
                    4: { status: 'not-started', duration: 0, completedAt: null },
                    5: { status: 'not-started', duration: 0, completedAt: null },
                    6: { status: 'not-started', duration: 0, completedAt: null },
                    7: { status: 'not-started', duration: 0, completedAt: null }
                },
                totalTimeSpent: 18,
                quizCompleted: true,
                notes: ''
            }
        ];

        let filteredUsers = [...usersData];
        let currentUser = null;

        // INITIALIZE DASHBOARD
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ Admin Dashboard caricata');
            loadDashboardData();
            calculateKPIs();
            renderUsersTable();
        });

        // LOAD DASHBOARD DATA
        function loadDashboardData() {
            // In produzione, qui caricheresti i dati da Firebase
            console.log('üìä Caricamento dati dashboard...');
            
            // Simula caricamento asincrono
            setTimeout(() => {
                console.log('‚úÖ Dati caricati:', usersData.length, 'utenti');
            }, 500);
        }

        // CALCULATE KPIs
        function calculateKPIs() {
            const totalUsers = usersData.length;
            const activeUsers = usersData.filter(user => {
                const daysSinceActivity = daysBetween(new Date(user.lastActivity), new Date());
                return daysSinceActivity <= 7;
            }).length;

            const completedWeek1 = usersData.filter(user => 
                user.weekProgress[1]?.status === 'completed'
            ).length;
            
            const conversionRate = totalUsers > 0 ? Math.round((completedWeek1 / totalUsers) * 100) : 0;

            // Calculate average completion rate across all weeks
            let totalCompletions = 0;
            let totalPossibleCompletions = 0;
            
            usersData.forEach(user => {
                for (let week = 1; week <= 7; week++) {
                    totalPossibleCompletions++;
                    if (user.weekProgress[week]?.status === 'completed') {
                        totalCompletions++;
                    }
                }
            });

            const completionRate = totalPossibleCompletions > 0 ? 
                Math.round((totalCompletions / totalPossibleCompletions) * 100) : 0;

            // Calculate potential revenue (‚Ç¨50 per week 2-7 completion)
            let potentialRevenue = 0;
            usersData.forEach(user => {
                if (user.role === 'user') { // Only regular users pay
                    for (let week = 2; week <= 7; week++) {
                        if (user.weekProgress[week]?.status === 'completed') {
                            potentialRevenue += 50;
                        }
                    }
                }
            });

            // Today's sessions
            const today = new Date().toISOString().split('T')[0];
            const todaySessions = usersData.filter(user => 
                user.lastActivity === today
            ).length;

            // Update KPI display
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('conversionRate').textContent = conversionRate + '%';
            document.getElementById('completionRate').textContent = completionRate + '%';
            document.getElementById('potentialRevenue').textContent = '‚Ç¨' + potentialRevenue;
            document.getElementById('todaySessions').textContent = todaySessions;

            // Update change indicators
            document.getElementById('usersChange').textContent = `+${Math.round(totalUsers * 0.15)} questa settimana`;
            document.getElementById('activeChange').textContent = `${activeUsers}/${totalUsers} attivi`;
        }

        // RENDER USERS TABLE
        function renderUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            const noUsersMessage = document.getElementById('noUsersMessage');
            
            if (filteredUsers.length === 0) {
                tbody.innerHTML = '';
                noUsersMessage.style.display = 'block';
                document.querySelector('.users-table').style.display = 'none';
                return;
            }

            noUsersMessage.style.display = 'none';
            document.querySelector('.users-table').style.display = 'table';

            tbody.innerHTML = filteredUsers.map(user => {
                const completedWeeks = Object.values(user.weekProgress).filter(w => w.status === 'completed').length;
                const progressPercentage = Math.round((completedWeeks / 7) * 100);
                
                const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
                
                const lastActivityFormatted = formatDate(user.lastActivity);
                const daysSinceActivity = daysBetween(new Date(user.lastActivity), new Date());
                
                let activityStatus = 'active';
                if (daysSinceActivity > 30) activityStatus = 'inactive';
                else if (daysSinceActivity > 7) activityStatus = 'partial';

                // Calculate session status
                let sessionStatus = 'not-started';
                const hasCompleted = Object.values(user.weekProgress).some(w => w.status === 'completed');
                const hasPartial = Object.values(user.weekProgress).some(w => w.status === 'partial');
                
                if (hasCompleted) sessionStatus = 'completed';
                else if (hasPartial) sessionStatus = 'partial';

                return `
                    <tr onclick="openUserModal('${user.id}')">
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">${initials}</div>
                                <div class="user-details">
                                    <div class="user-name">${user.name}</div>
                                    <div class="user-email">${user.email}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="role-badge role-${user.role}">${user.role}</span>
                        </td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                            </div>
                            <div class="progress-text">${completedWeeks}/7 settimane</div>
                        </td>
                        <td>
                            <span class="status-badge status-${sessionStatus}">
                                ${sessionStatus === 'completed' ? '‚úÖ Completa' : 
                                  sessionStatus === 'partial' ? '‚è≥ Parziale' : '‚≠ï Non iniziata'}
                            </span>
                        </td>
                        <td>
                            <div class="last-activity">${lastActivityFormatted}</div>
                            <div class="status-badge status-${activityStatus}" style="font-size: 0.7rem; margin-top: 0.25rem;">
                                ${daysSinceActivity === 0 ? 'Oggi' : 
                                  daysSinceActivity === 1 ? 'Ieri' : 
                                  daysSinceActivity + ' giorni fa'}
                            </div>
                        </td>
                        <td>
                            <button class="action-btn" onclick="event.stopPropagation(); openUserModal('${user.id}')">
                                üëÅÔ∏è Dettagli
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Update counters
            document.getElementById('visibleUsers').textContent = filteredUsers.length;
            document.getElementById('totalUsersCount').textContent = usersData.length;
        }

        // APPLY FILTERS
        function applyFilters() {
            const roleFilter = document.getElementById('roleFilter').value;
            const progressFilter = document.getElementById('progressFilter').value;
            const activityFilter = document.getElementById('activityFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            filteredUsers = usersData.filter(user => {
                // Role filter
                if (roleFilter && user.role !== roleFilter) return false;

                // Progress filter
                if (progressFilter) {
                    const completedWeeks = Object.values(user.weekProgress).filter(w => w.status === 'completed').length;
                    const hasPartial = Object.values(user.weekProgress).some(w => w.status === 'partial');
                    
                    if (progressFilter === 'not-started' && (completedWeeks > 0 || hasPartial)) return false;
                    if (progressFilter === 'in-progress' && (completedWeeks === 0 || completedWeeks === 7)) return false;
                    if (progressFilter === 'completed' && completedWeeks < 7) return false;
                }

                // Activity filter
                if (activityFilter) {
                    const daysSinceActivity = daysBetween(new Date(user.lastActivity), new Date());
                    
                    if (activityFilter === 'today' && daysSinceActivity !== 0) return false;
                    if (activityFilter === 'week' && daysSinceActivity > 7) return false;
                    if (activityFilter === 'month' && daysSinceActivity > 30) return false;
                    if (activityFilter === 'inactive' && daysSinceActivity <= 30) return false;
                }

                // Search filter
                if (searchFilter && 
                    !user.name.toLowerCase().includes(searchFilter) && 
                    !user.email.toLowerCase().includes(searchFilter)) {
                    return false;
                }

                return true;
            });

            renderUsersTable();
        }

        // OPEN USER MODAL
        function openUserModal(userId) {
            currentUser = usersData.find(user => user.id === userId);
            if (!currentUser) return;

            document.getElementById('modalUserName').textContent = currentUser.name;
            
            // General info
            const generalInfo = document.getElementById('userGeneralInfo');
            generalInfo.innerHTML = `
                <p><strong>Email:</strong> ${currentUser.email}</p>
                <p><strong>Ruolo:</strong> <span class="role-badge role-${currentUser.role}">${currentUser.role}</span></p>
                <p><strong>Registrazione:</strong> ${formatDate(currentUser.registrationDate)}</p>
                <p><strong>Profilo:</strong> ${currentUser.profileType}</p>
                <p><strong>Lead Score:</strong> ${currentUser.leadScore}%</p>
                <p><strong>Quiz Completato:</strong> ${currentUser.quizCompleted ? '‚úÖ S√¨' : '‚ùå No'}</p>
            `;

            // Stats
            const completedWeeks = Object.values(currentUser.weekProgress).filter(w => w.status === 'completed').length;
            const partialWeeks = Object.values(currentUser.weekProgress).filter(w => w.status === 'partial').length;
            const totalTime = Math.round(currentUser.totalTimeSpent);

            const userStats = document.getElementById('userStats');
            userStats.innerHTML = `
                <p><strong>Settimane Completate:</strong> ${completedWeeks}/7</p>
                <p><strong>Settimane Parziali:</strong> ${partialWeeks}</p>
                <p><strong>Tempo Totale:</strong> ${totalTime} minuti</p>
                <p><strong>Tempo Medio/Settimana:</strong> ${Math.round(totalTime/Math.max(completedWeeks + partialWeeks, 1))} min</p>
                <p><strong>Ultima Attivit√†:</strong> ${formatDate(currentUser.lastActivity)}</p>
                <p><strong>Giorni di Inattivit√†:</strong> ${daysBetween(new Date(currentUser.lastActivity), new Date())}</p>
            `;

            // Week progress
            const weekProgress = document.getElementById('weekProgress');
            weekProgress.innerHTML = '';
            
            for (let week = 1; week <= 7; week++) {
                const weekData = currentUser.weekProgress[week];
                const weekItem = document.createElement('div');
                weekItem.className = `week-item ${weekData.status}`;
                weekItem.innerHTML = `
                    <div><strong>W${week}</strong></div>
                    <div style="font-size: 0.7rem; margin-top: 0.25rem;">
                        ${weekData.status === 'completed' ? '‚úÖ' : 
                          weekData.status === 'partial' ? '‚è≥' : '‚≠ï'}
                    </div>
                    ${weekData.duration > 0 ? `<div style="font-size: 0.6rem;">${weekData.duration}min</div>` : ''}
                `;
                weekProgress.appendChild(weekItem);
            }

            // Profile info
            const userProfile = document.getElementById('userProfile');
            userProfile.innerHTML = `
                <p><strong>Tipo Profilo:</strong> ${currentUser.profileType}</p>
                <p><strong>Lead Score:</strong> ${currentUser.leadScore}% 
                    ${currentUser.leadScore >= 90 ? 'üî• Alta qualit√†' : 
                      currentUser.leadScore >= 70 ? '‚ö° Buona qualit√†' : 'üìà Da sviluppare'}
                </p>
                <p><strong>Potenziale Revenue:</strong> ‚Ç¨${calculateUserRevenue(currentUser)}</p>
            `;

            // Load notes
            document.getElementById('userNotes').value = currentUser.notes || '';

            // Show modal
            document.getElementById('userModal').classList.add('active');
        }

        // CLOSE USER MODAL
        function closeUserModal() {
            document.getElementById('userModal').classList.remove('active');
            currentUser = null;
        }

        // SAVE USER NOTES
        function saveUserNotes() {
            if (!currentUser) return;

            const notes = document.getElementById('userNotes').value;
            currentUser.notes = notes;

            // In produzione, salveresti su Firebase
            console.log('üíæ Note salvate per', currentUser.name);
            
            // Show success feedback
            const btn = document.querySelector('.save-notes-btn');
            const originalText = btn.textContent;
            btn.textContent = '‚úÖ Salvato!';
            btn.style.background = 'linear-gradient(135deg, #16a34a 0%, #22c55e 100%)';
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = 'linear-gradient(135deg, #ea580c 0%, #f97316 100%)';
            }, 2000);
        }

        // EXPORT USERS
        function exportUsers() {
            const csvContent = generateCSV(filteredUsers);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `utenti_coaching_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            console.log('üìä Export CSV completato');
        }

        // GENERATE CSV
        function generateCSV(users) {
            const headers = [
                'Nome', 'Email', 'Ruolo', 'Registrazione', 'Ultima Attivit√†',
                'Profilo', 'Lead Score', 'Settimane Completate', 'Tempo Totale (min)',
                'W1', 'W2', 'W3', 'W4', 'W5', 'W6', 'W7', 'Revenue', 'Note'
            ];

            const rows = users.map(user => {
                const completedWeeks = Object.values(user.weekProgress).filter(w => w.status === 'completed').length;
                const weekStatuses = [];
                for (let i = 1; i <= 7; i++) {
                    weekStatuses.push(user.weekProgress[i]?.status || 'not-started');
                }
                
                return [
                    user.name,
                    user.email,
                    user.role,
                    user.registrationDate,
                    user.lastActivity,
                    user.profileType,
                    user.leadScore,
                    completedWeeks,
                    user.totalTimeSpent,
                    ...weekStatuses,
                    calculateUserRevenue(user),
                    user.notes || ''
                ];
            });

            return [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');
        }

        // REFRESH DASHBOARD
        function refreshDashboard() {
            console.log('üîÑ Aggiornamento dashboard...');
            
            const btn = document.querySelector('.refresh-btn');
            btn.textContent = 'üîÑ Aggiornando...';
            btn.disabled = true;
            
            // Simulate data refresh
            setTimeout(() => {
                calculateKPIs();
                renderUsersTable();
                btn.textContent = 'üîÑ Aggiorna';
                btn.disabled = false;
                console.log('‚úÖ Dashboard aggiornata');
            }, 1000);
        }

        // UTILITY FUNCTIONS
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function daysBetween(date1, date2) {
            const oneDay = 24 * 60 * 60 * 1000;
            return Math.round(Math.abs((date1 - date2) / oneDay));
        }

        function calculateUserRevenue(user) {
            if (user.role !== 'user') return 0; // Admin and beta don't pay
            
            let revenue = 0;
            for (let week = 2; week <= 7; week++) {
                if (user.weekProgress[week]?.status === 'completed') {
                    revenue += 50;
                }
            }
            return revenue;
        }

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeUserModal();
            }
        });

        // Close modal on backdrop click
        document.getElementById('userModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeUserModal();
            }
        });

        console.log('üéØ Admin Dashboard completamente caricata');
    </script>
</body>
</html>