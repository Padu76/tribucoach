<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Automation - LifestyleFitnessCoach</title>
    
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-subtitle {
            color: #64748b;
            font-size: 1rem;
            margin-top: 4px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .back-btn {
            background: linear-gradient(45deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        /* Status Banner */
        .status-banner {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 6px solid #10b981;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .status-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .status-info h3 {
            color: #1e293b;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .status-info p {
            color: #64748b;
            font-size: 0.9rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-indicator.active {
            background: #dcfce7;
            color: #16a34a;
        }

        .status-indicator.paused {
            background: #fef3c7;
            color: #f59e0b;
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        /* Stats Section */
        .stats-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .stats-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f1f5f9;
        }

        .stats-header h3 {
            color: #1e293b;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8fafc 0%, #fff7ed 100%);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid #ea580c;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
        }

        .stat-number {
            font-size: 2.2rem;
            font-weight: bold;
            color: #ea580c;
            margin-bottom: 8px;
            display: block;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .stat-trend {
            color: #16a34a;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Control Panel */
        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .control-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f1f5f9;
        }

        .control-header h3 {
            color: #1e293b;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .control-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .control-btn {
            padding: 16px 20px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .control-btn.primary {
            background: linear-gradient(45deg, #ea580c, #dc2626);
            color: white;
        }

        .control-btn.primary:hover {
            background: linear-gradient(45deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(234, 88, 12, 0.4);
        }

        .control-btn.secondary {
            background: #f1f5f9;
            color: #475569;
        }

        .control-btn.secondary:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
        }

        .control-btn.success {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
        }

        .control-btn.success:hover {
            background: linear-gradient(45deg, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        /* Active Sequences */
        .sequences-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .sequences-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f1f5f9;
        }

        .sequences-header h3 {
            color: #1e293b;
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sequences-count {
            background: #ea580c;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .sequences-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .sequence-item {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 4px solid #ea580c;
            transition: all 0.3s ease;
        }

        .sequence-item:hover {
            background: #f1f5f9;
            transform: translateX(4px);
        }

        .sequence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .sequence-user {
            font-weight: 700;
            color: #1e293b;
            font-size: 1.1rem;
        }

        .sequence-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .sequence-status.active {
            background: #dcfce7;
            color: #16a34a;
        }

        .sequence-status.scheduled {
            background: #fef3c7;
            color: #f59e0b;
        }

        .sequence-status.completed {
            background: #e0e7ff;
            color: #3730a3;
        }

        .sequence-details {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .sequence-detail {
            text-align: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
        }

        .sequence-detail-label {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 600;
        }

        .sequence-detail-value {
            font-size: 0.9rem;
            color: #1e293b;
            font-weight: 700;
            margin-top: 2px;
        }

        /* Profile Distribution */
        .profiles-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .profiles-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f1f5f9;
        }

        .profiles-header h3 {
            color: #1e293b;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .profiles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .profile-card {
            background: linear-gradient(135deg, #f8fafc 0%, #fff7ed 100%);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .profile-card:hover {
            transform: translateY(-6px);
        }

        .profile-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(45deg, #ea580c, #dc2626);
        }

        .profile-emoji {
            font-size: 3rem;
            margin-bottom: 12px;
            display: block;
        }

        .profile-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .profile-count {
            font-size: 2rem;
            font-weight: bold;
            color: #ea580c;
            margin-bottom: 4px;
        }

        .profile-percentage {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 600;
        }

        /* Email Templates Preview */
        .templates-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .templates-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f1f5f9;
        }

        .templates-header h3 {
            color: #1e293b;
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .profile-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .profile-btn {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .profile-btn:hover {
            border-color: #ea580c;
            transform: translateY(-2px);
        }

        .profile-btn.active {
            background: #ea580c;
            color: white;
            border-color: #ea580c;
        }

        .email-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }

        .email-preview-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #ea580c;
        }

        .email-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .email-type {
            font-weight: 700;
            color: #1e293b;
            font-size: 1rem;
        }

        .email-timing {
            background: #ea580c;
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .email-subject {
            font-size: 0.9rem;
            color: #475569;
            font-weight: 600;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.8);
            padding: 8px 12px;
            border-radius: 8px;
        }

        .email-preview {
            font-size: 0.8rem;
            color: #64748b;
            line-height: 1.4;
            max-height: 60px;
            overflow: hidden;
            position: relative;
        }

        .email-preview::after {
            content: '...';
            position: absolute;
            bottom: 0;
            right: 0;
            background: #f8fafc;
            padding-left: 8px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f1f5f9;
        }

        .modal-title {
            color: #1e293b;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .control-grid {
                grid-template-columns: 1fr;
            }
            
            .sequence-details {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .status-content {
                flex-direction: column;
                text-align: center;
            }
            
            .sequences-header {
                flex-direction: column;
                gap: 12px;
            }
            
            .profiles-grid {
                grid-template-columns: 1fr;
            }
            
            .profile-selector {
                justify-content: center;
            }
            
            .email-preview-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading states */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 40px;
            color: #64748b;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #ea580c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: linear-gradient(45deg, #ef4444, #dc2626);
        }

        .notification.warning {
            background: linear-gradient(45deg, #f59e0b, #d97706);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="header-info">
                    <h1 class="header-title">
                        <span>📧</span>
                        <span>Email Automation System</span>
                    </h1>
                    <p class="header-subtitle">Sistema automatizzato per email marketing personalizzate - Andrea Padoan Coach</p>
                </div>
                <div class="header-actions">
                    <a href="admin-dashboard.html" class="back-btn">
                        <span>← Torna alla Dashboard</span>
                    </a>
                </div>
            </div>
        </header>

        <!-- Status Banner -->
        <div class="status-banner">
            <div class="status-content">
                <div class="status-info">
                    <h3>🚀 Sistema Email Automation</h3>
                    <p>Sistema completamente automatico: Quiz → Profilo → Sequenza Email (0+2+5 giorni) → Conversione</p>
                </div>
                <div class="status-indicator active" id="systemStatus">
                    <span>🟢</span>
                    <span>Sistema Attivo</span>
                </div>
            </div>
        </div>

        <!-- Main Grid: Stats + Controls -->
        <div class="main-grid">
            <!-- Stats Section -->
            <div class="stats-section">
                <div class="stats-header">
                    <span>📊</span>
                    <h3>Performance Email</h3>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-number" id="totalSent">1,247</span>
                        <div class="stat-label">Email Inviate</div>
                        <div class="stat-trend">↗️ +18% questa settimana</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="openRate">42.3%</span>
                        <div class="stat-label">Tasso Apertura</div>
                        <div class="stat-trend">↗️ +5.2% vs media</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="clickRate">18.7%</span>
                        <div class="stat-label">Tasso Click</div>
                        <div class="stat-trend">↗️ +3.1% vs media</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="conversions">89</span>
                        <div class="stat-label">Conversioni</div>
                        <div class="stat-trend">🎯 7.1% rate</div>
                    </div>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="control-panel">
                <div class="control-header">
                    <span>⚙️</span>
                    <h3>Controlli Sistema</h3>
                </div>
                <div class="control-grid">
                    <button class="control-btn success" id="testSystem">
                        <span>🧪</span>
                        <span>Test Completo</span>
                    </button>
                    <button class="control-btn primary" id="pauseSystem">
                        <span>⏸️</span>
                        <span>Pausa Sistema</span>
                    </button>
                    <button class="control-btn secondary" id="viewLogs">
                        <span>📋</span>
                        <span>Visualizza Log</span>
                    </button>
                    <button class="control-btn secondary" id="exportData">
                        <span>📊</span>
                        <span>Esporta Dati</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Active Sequences -->
        <div class="sequences-section">
            <div class="sequences-header">
                <h3>
                    <span>🔄</span>
                    <span>Sequenze Email Attive</span>
                </h3>
                <div class="sequences-count" id="activeCount">23 attive</div>
            </div>
            <div class="sequences-list" id="sequencesList">
                <!-- Sequences populated by JavaScript -->
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <span>Caricamento sequenze attive...</span>
                </div>
            </div>
        </div>

        <!-- Profile Distribution -->
        <div class="profiles-section">
            <div class="profiles-header">
                <span>👥</span>
                <h3>Distribuzione Profili (Ultimi 30 giorni)</h3>
            </div>
            <div class="profiles-grid" id="profilesGrid">
                <!-- Profiles populated by JavaScript -->
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <span>Caricamento distribuzione profili...</span>
                </div>
            </div>
        </div>

        <!-- Email Templates Preview -->
        <div class="templates-section">
            <div class="templates-header">
                <h3>
                    <span>✉️</span>
                    <span>Preview Template Email</span>
                </h3>
                <div class="profile-selector" id="profileSelector">
                    <button class="profile-btn active" data-profile="stressato_esaurito">
                        <span>😰</span>
                        <span>Stressato</span>
                    </button>
                    <button class="profile-btn" data-profile="procrastinatore_bloccato">
                        <span>⏳</span>
                        <span>Procrastinatore</span>
                    </button>
                    <button class="profile-btn" data-profile="perfezionista_insoddisfatto">
                        <span>🎯</span>
                        <span>Perfezionista</span>
                    </button>
                    <button class="profile-btn" data-profile="dispersivo_confuso">
                        <span>🤯</span>
                        <span>Dispersivo</span>
                    </button>
                    <button class="profile-btn" data-profile="motivato_inconsistente">
                        <span>🎢</span>
                        <span>Motivato</span>
                    </button>
                    <button class="profile-btn" data-profile="equilibrato_ottimizzatore">
                        <span>⚡</span>
                        <span>Equilibrato</span>
                    </button>
                </div>
            </div>
            <div class="email-preview-grid" id="emailPreviewGrid">
                <!-- Email previews populated by JavaScript -->
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <span>Caricamento template email...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for detailed view -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Dettagli</h2>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <span id="notificationText"></span>
    </div>

    <script>
        // EMAIL AUTOMATION SYSTEM - Full Implementation with EmailJS
        class EmailAutomationSystem {
            constructor() {
                this.isActive = true;
                this.stats = {
                    totalSent: 1247,
                    openRate: 42.3,
                    clickRate: 18.7,
                    conversions: 89
                };
                this.activeSequences = [];
                this.profileDistribution = {};
                this.currentProfile = 'stressato_esaurito';
                
                // EmailJS Configuration
                this.emailConfig = {
                    serviceId: 'service_v6bw2m4',
                    templateId: 'template_l605n5c',
                    publicKey: 'ME0ru3KkNko0P6d2Y'
                };
                
                this.init();
            }

            init() {
                console.log('🚀 Inizializando Email Automation System...');
                
                // Initialize EmailJS
                this.initializeEmailJS();
                
                // Setup event listeners
                this.setupControls();
                this.setupProfileSelector();
                
                // Load initial data
                this.loadActiveSequences();
                this.loadProfileDistribution();
                this.loadEmailTemplates();
                
                // Setup real-time updates
                this.startRealTimeUpdates();
                
                console.log('✅ Email Automation System inizializzato');
            }

            initializeEmailJS() {
                // Wait for EmailJS to load
                const waitForEmailJS = () => {
                    if (typeof emailjs !== 'undefined') {
                        try {
                            emailjs.init(this.emailConfig.publicKey);
                            console.log('✅ EmailJS inizializzato con successo');
                        } catch (error) {
                            console.error('❌ Errore inizializzazione EmailJS:', error);
                        }
                    } else {
                        console.log('⏳ Aspettando caricamento EmailJS...');
                        setTimeout(waitForEmailJS, 500); // Retry after 500ms
                    }
                };
                
                waitForEmailJS();
            }

            setupControls() {
                // Test System
                document.getElementById('testSystem')?.addEventListener('click', () => {
                    this.runSystemTest();
                });

                // Pause/Resume System
                document.getElementById('pauseSystem')?.addEventListener('click', () => {
                    this.toggleSystemStatus();
                });

                // View Logs
                document.getElementById('viewLogs')?.addEventListener('click', () => {
                    this.showSystemLogs();
                });

                // Export Data
                document.getElementById('exportData')?.addEventListener('click', () => {
                    this.exportSystemData();
                });

                // Modal close
                document.getElementById('modalClose')?.addEventListener('click', () => {
                    this.closeModal();
                });

                // Close modal on backdrop click
                document.getElementById('detailModal')?.addEventListener('click', (e) => {
                    if (e.target.id === 'detailModal') {
                        this.closeModal();
                    }
                });
            }

            setupProfileSelector() {
                const profileBtns = document.querySelectorAll('.profile-btn');
                profileBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        // Update active state
                        profileBtns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        // Update current profile
                        this.currentProfile = btn.dataset.profile;
                        
                        // Reload email templates
                        this.loadEmailTemplates();
                    });
                });
            }

            runSystemTest() {
                this.showNotification('🧪 Avvio test sistema completo...', 'info');
                
                // Test EmailJS connection first
                this.testEmailJSConnection().then(() => {
                    // Simulate test process
                    setTimeout(() => {
                        // Test email sending
                        this.showNotification('📧 Test invio email...', 'info');
                        
                        // Send test email
                        this.sendTestEmail('welcome').then(() => {
                            setTimeout(() => {
                                // Test automation trigger
                                this.showNotification('🎯 Test trigger automazione...', 'info');
                                
                                setTimeout(() => {
                                    // Complete test
                                    this.showNotification('✅ Test sistema completato con successo!', 'success');
                                    
                                    // Update stats to show test activity
                                    this.updateStats({
                                        totalSent: this.stats.totalSent + 3,
                                        conversions: this.stats.conversions + 1
                                    });
                                    
                                }, 1500);
                            }, 1500);
                        }).catch((error) => {
                            this.showNotification('❌ Errore test email: ' + error.text, 'error');
                        });
                    }, 1000);
                }).catch((error) => {
                    this.showNotification('❌ Errore connessione EmailJS', 'error');
                });
            }

            async testEmailJSConnection() {
                const testData = {
                    nome: 'Test User',
                    email: 'andrea.padoan@gmail.com',
                    email_type: 'welcome',
                    dashboard_url: 'https://tribucoach.vercel.app/pages/user-dashboard.html',
                    whatsapp: 'https://wa.me/393123456789?text=Ciao%20Andrea,%20test%20sistema'
                };

                try {
                    const result = await emailjs.send(
                        this.emailConfig.serviceId,
                        this.emailConfig.templateId,
                        testData
                    );
                    console.log('✅ Test EmailJS riuscito:', result);
                    return result;
                } catch (error) {
                    console.error('❌ Test EmailJS fallito:', error);
                    throw error;
                }
            }

            async sendTestEmail(emailType) {
                const testData = {
                    nome: 'Mario Test',
                    email: 'andrea.padoan@gmail.com',
                    email_type: emailType,
                    dashboard_url: 'https://tribucoach.vercel.app/pages/user-dashboard.html',
                    whatsapp: 'https://wa.me/393123456789?text=Ciao%20Andrea,%20test%20' + emailType
                };

                try {
                    const result = await emailjs.send(
                        this.emailConfig.serviceId,
                        this.emailConfig.templateId,
                        testData
                    );
                    console.log(`✅ Email ${emailType} inviata:`, result);
                    return result;
                } catch (error) {
                    console.error(`❌ Errore invio email ${emailType}:`, error);
                    throw error;
                }
            }

            toggleSystemStatus() {
                const statusEl = document.getElementById('systemStatus');
                const pauseBtn = document.getElementById('pauseSystem');
                
                if (this.isActive) {
                    // Pause system
                    this.isActive = false;
                    statusEl.innerHTML = '<span>🟡</span><span>Sistema in Pausa</span>';
                    statusEl.className = 'status-indicator paused';
                    pauseBtn.innerHTML = '<span>▶️</span><span>Riprendi Sistema</span>';
                    
                    this.showNotification('⏸️ Sistema messo in pausa', 'warning');
                } else {
                    // Resume system
                    this.isActive = true;
                    statusEl.innerHTML = '<span>🟢</span><span>Sistema Attivo</span>';
                    statusEl.className = 'status-indicator active';
                    pauseBtn.innerHTML = '<span>⏸️</span><span>Pausa Sistema</span>';
                    
                    this.showNotification('▶️ Sistema riattivato', 'success');
                }
            }

            showSystemLogs() {
                const logs = [
                    { time: '14:23:45', type: 'INFO', message: 'Sistema email automation avviato' },
                    { time: '14:24:12', type: 'SUCCESS', message: 'Email welcome inviata a Marco Bianchi (Stressato Esaurito)' },
                    { time: '14:25:03', type: 'INFO', message: 'Sequenza programmata per Sofia Rossi (+2 giorni)' },
                    { time: '14:26:18', type: 'SUCCESS', message: 'Email nurturing inviata a Luca Verdi' },
                    { time: '14:27:45', type: 'INFO', message: 'Quiz completato da Anna Neri (Perfezionista Insoddisfatto)' },
                    { time: '14:28:12', type: 'SUCCESS', message: 'Trigger automazione per Anna Neri - sequenza avviata' },
                    { time: '14:29:33', type: 'INFO', message: 'Email conversion inviata a Matteo Russo' },
                    { time: '14:30:21', type: 'SUCCESS', message: 'Conversione registrata: Matteo Russo ha prenotato consulenza' }
                ];

                let logsHtml = '<div style="font-family: monospace; background: #f8fafc; padding: 20px; border-radius: 8px; max-height: 400px; overflow-y: auto;">';
                logs.forEach(log => {
                    const typeColor = log.type === 'SUCCESS' ? '#10b981' : log.type === 'ERROR' ? '#ef4444' : '#64748b';
                    logsHtml += `
                        <div style="margin-bottom: 8px; display: flex; gap: 12px;">
                            <span style="color: #64748b; min-width: 80px;">${log.time}</span>
                            <span style="color: ${typeColor}; font-weight: 600; min-width: 80px;">${log.type}</span>
                            <span style="color: #1e293b;">${log.message}</span>
                        </div>
                    `;
                });
                logsHtml += '</div>';

                this.showModal('📋 Log Sistema Email Automation', logsHtml);
            }

            exportSystemData() {
                const exportData = {
                    systemStatus: this.isActive ? 'active' : 'paused',
                    stats: this.stats,
                    activeSequences: this.activeSequences.length,
                    profileDistribution: this.profileDistribution,
                    exportDate: new Date().toISOString(),
                    totalProfiles: Object.values(this.profileDistribution).reduce((a, b) => a + b, 0)
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `email_automation_export_${new Date().toISOString().slice(0, 10)}.json`;
                link.click();

                this.showNotification('📊 Dati esportati con successo!', 'success');
            }

            loadActiveSequences() {
                // Mock active sequences data
                const sequences = [
                    {
                        user: 'Marco Bianchi',
                        email: 'marco.b@email.com',
                        profile: '😰 Stressato Esaurito',
                        currentStep: 'Nurturing',
                        nextEmail: '1 giorno',
                        status: 'active',
                        progress: 2,
                        total: 3
                    },
                    {
                        user: 'Sofia Rossi',
                        email: 'sofia.r@email.com',
                        profile: '⏳ Procrastinatore Bloccato',
                        currentStep: 'Conversion',
                        nextEmail: '3 giorni',
                        status: 'scheduled',
                        progress: 3,
                        total: 3
                    },
                    {
                        user: 'Luca Verdi',
                        email: 'luca.v@email.com',
                        profile: '🎯 Perfezionista Insoddisfatto',
                        currentStep: 'Welcome',
                        nextEmail: 'Inviata',
                        status: 'active',
                        progress: 1,
                        total: 3
                    },
                    {
                        user: 'Anna Neri',
                        email: 'anna.n@email.com',
                        profile: '🤯 Dispersivo Confuso',
                        currentStep: 'Completata',
                        nextEmail: 'Finita',
                        status: 'completed',
                        progress: 3,
                        total: 3
                    }
                ];

                this.activeSequences = sequences;
                this.renderActiveSequences();
            }

            renderActiveSequences() {
                const container = document.getElementById('sequencesList');
                let html = '';

                this.activeSequences.forEach(seq => {
                    html += `
                        <div class="sequence-item">
                            <div class="sequence-header">
                                <div class="sequence-user">${seq.user}</div>
                                <div class="sequence-status ${seq.status}">${seq.status}</div>
                            </div>
                            <div class="sequence-details">
                                <div class="sequence-detail">
                                    <div class="sequence-detail-label">Profilo</div>
                                    <div class="sequence-detail-value">${seq.profile}</div>
                                </div>
                                <div class="sequence-detail">
                                    <div class="sequence-detail-label">Passo Corrente</div>
                                    <div class="sequence-detail-value">${seq.currentStep}</div>
                                </div>
                                <div class="sequence-detail">
                                    <div class="sequence-detail-label">Prossima Email</div>
                                    <div class="sequence-detail-value">${seq.nextEmail}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
                
                // Update active count
                const activeCount = this.activeSequences.filter(seq => seq.status === 'active').length;
                document.getElementById('activeCount').textContent = `${activeCount} attive`;
            }

            loadProfileDistribution() {
                // Mock profile distribution data
                this.profileDistribution = {
                    stressato_esaurito: 45,
                    procrastinatore_bloccato: 32,
                    perfezionista_insoddisfatto: 28,
                    dispersivo_confuso: 21,
                    motivato_inconsistente: 19,
                    equilibrato_ottimizzatore: 8
                };

                this.renderProfileDistribution();
            }

            renderProfileDistribution() {
                const profiles = [
                    { key: 'stressato_esaurito', emoji: '😰', name: 'Stressato Esaurito' },
                    { key: 'procrastinatore_bloccato', emoji: '⏳', name: 'Procrastinatore Bloccato' },
                    { key: 'perfezionista_insoddisfatto', emoji: '🎯', name: 'Perfezionista Insoddisfatto' },
                    { key: 'dispersivo_confuso', emoji: '🤯', name: 'Dispersivo Confuso' },
                    { key: 'motivato_inconsistente', emoji: '🎢', name: 'Motivato Inconsistente' },
                    { key: 'equilibrato_ottimizzatore', emoji: '⚡', name: 'Equilibrato Ottimizzatore' }
                ];

                const total = Object.values(this.profileDistribution).reduce((a, b) => a + b, 0);
                const container = document.getElementById('profilesGrid');
                let html = '';

                profiles.forEach(profile => {
                    const count = this.profileDistribution[profile.key] || 0;
                    const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;

                    html += `
                        <div class="profile-card">
                            <span class="profile-emoji">${profile.emoji}</span>
                            <div class="profile-name">${profile.name}</div>
                            <div class="profile-count">${count}</div>
                            <div class="profile-percentage">${percentage}% del totale</div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            }

            loadEmailTemplates() {
                const templates = this.getEmailTemplatesForProfile(this.currentProfile);
                this.renderEmailTemplates(templates);
            }

            getEmailTemplatesForProfile(profileKey) {
                const allTemplates = {
                    stressato_esaurito: {
                        profile: { emoji: '😰', name: 'Stressato Esaurito' },
                        emails: [
                            {
                                type: 'Welcome',
                                timing: 'Immediata',
                                subject: 'Mario, il tuo percorso di recupero inizia ora 💪',
                                preview: 'Ciao Mario, so perfettamente cosa stai passando. Quella sensazione di essere sempre di corsa, di non riuscire mai a staccare veramente...'
                            },
                            {
                                type: 'Nurturing',
                                timing: '+2 giorni',
                                subject: 'Mario, 3 tecniche immediate per il tuo stress 🌱',
                                preview: 'Dopo 2 giorni dal nostro primo contatto, voglio condividere con te 3 strategie che hanno aiutato centinaia di persone nella tua situazione...'
                            },
                            {
                                type: 'Conversion',
                                timing: '+5 giorni',
                                subject: 'Mario, sei pronto per il passo successivo? 🚀',
                                preview: 'È passata quasi una settimana da quando hai fatto il quiz. In questi giorni hai probabilmente riflettuto sui risultati...'
                            }
                        ]
                    },
                    procrastinatore_bloccato: {
                        profile: { emoji: '⏳', name: 'Procrastinatore Bloccato' },
                        emails: [
                            {
                                type: 'Welcome',
                                timing: 'Immediata',
                                subject: 'Mario, basta rimandare. È ora di agire! ⚡',
                                preview: 'Ciao Mario, dal quiz è emerso che sei un Procrastinatore Bloccato. Non preoccuparti, non sei solo in questa battaglia...'
                            },
                            {
                                type: 'Nurturing',
                                timing: '+2 giorni',
                                subject: 'Mario, la regola dei 2 minuti che cambia tutto 🔥',
                                preview: 'Ti svelo una tecnica che ha trasformato la vita di migliaia di procrastinatori: la regola dei 2 minuti...'
                            },
                            {
                                type: 'Conversion',
                                timing: '+5 giorni',
                                subject: 'Mario, è ora di smettere di auto-sabotarti 💥',
                                preview: 'Siamo arrivati al punto cruciale. Puoi continuare a rimandare, oppure puoi decidere che OGGI è il giorno del cambiamento...'
                            }
                        ]
                    },
                    perfezionista_insoddisfatto: {
                        profile: { emoji: '🎯', name: 'Perfezionista Insoddisfatto' },
                        emails: [
                            {
                                type: 'Welcome',
                                timing: 'Immediata',
                                subject: 'Mario, è ora di liberarti dalla prigione della perfezione 🎯',
                                preview: 'Ciao Mario, dal quiz è emerso che sei un Perfezionista Insoddisfatto. Conosco bene questa sensazione di non essere mai abbastanza...'
                            },
                            {
                                type: 'Nurturing',
                                timing: '+2 giorni',
                                subject: 'Mario, "fatto è meglio che perfetto" (ecco perché) ✨',
                                preview: 'Voglio condividere con te il segreto che ha liberato migliaia di perfezionisti dalla paralisi dell\'analisi...'
                            },
                            {
                                type: 'Conversion',
                                timing: '+5 giorni',
                                subject: 'Mario, smetti di sabotare i tuoi successi 🏆',
                                preview: 'È arrivato il momento di una decisione importante. Puoi continuare a cercare la perfezione (che non esiste)...'
                            }
                        ]
                    },
                    dispersivo_confuso: {
                        profile: { emoji: '🤯', name: 'Dispersivo Confuso' },
                        emails: [
                            {
                                type: 'Welcome',
                                timing: 'Immediata',
                                subject: 'Mario, dal caos alla chiarezza in 3 passi 🧭',
                                preview: 'Ciao Mario, capisco perfettamente quella sensazione di avere mille idee ma non sapere da dove iniziare...'
                            },
                            {
                                type: 'Nurturing',
                                timing: '+2 giorni',
                                subject: 'Mario, la matrice che ti salverà dal sovraccarico 📊',
                                preview: 'Ti voglio mostrare lo strumento che ha aiutato centinaia di persone come te a trasformare il caos in chiarezza...'
                            },
                            {
                                type: 'Conversion',
                                timing: '+5 giorni',
                                subject: 'Mario, basta vivere nella confusione 🎯',
                                preview: 'Sei davvero pronto a trasformare la confusione in un piano d\'azione chiaro e strutturato?'
                            }
                        ]
                    },
                    motivato_inconsistente: {
                        profile: { emoji: '🎢', name: 'Motivato Inconsistente' },
                        emails: [
                            {
                                type: 'Welcome',
                                timing: 'Immediata',
                                subject: 'Mario, trasformiamo le tue ondate in oceano costante 🌊',
                                preview: 'Ciao Mario, riconosco in te quella passione che brucia forte... ma poi si spegne. Non sei difettoso, sei umano...'
                            },
                            {
                                type: 'Nurturing',
                                timing: '+2 giorni',
                                subject: 'Mario, il segreto della costanza (non è la motivazione) ⚡',
                                preview: 'Dimentica tutto quello che ti hanno detto sulla motivazione. Il vero segreto della costanza è...'
                            },
                            {
                                type: 'Conversion',
                                timing: '+5 giorni',
                                subject: 'Mario, smetti con il "tutto o niente" 🎯',
                                preview: 'È il momento di abbandonare per sempre il ciclo distruttivo di tutto o niente che ti sta sabotando...'
                            }
                        ]
                    },
                    equilibrato_ottimizzatore: {
                        profile: { emoji: '⚡', name: 'Equilibrato Ottimizzatore' },
                        emails: [
                            {
                                type: 'Welcome',
                                timing: 'Immediata',
                                subject: 'Mario, dal buono all\'eccellente: il tuo next level ⚡',
                                preview: 'Ciao Mario, sei già sulla strada giusta. La tua vita funziona, ma sai che può funzionare ancora meglio...'
                            },
                            {
                                type: 'Nurturing',
                                timing: '+2 giorni',
                                subject: 'Mario, marginal gains: l\'1% che cambia tutto 📈',
                                preview: 'Ti voglio parlare del concetto che ha rivoluzionato le performance degli atleti olimpici: i marginal gains...'
                            },
                            {
                                type: 'Conversion',
                                timing: '+5 giorni',
                                subject: 'Mario, è ora di raggiungere il tuo potenziale massimo 🚀',
                                preview: 'Sei pronto a fare quel salto di qualità che ti porterà dal buono all\'eccellente?'
                            }
                        ]
                    }
                };

                return allTemplates[profileKey] || allTemplates.stressato_esaurito;
            }

            renderEmailTemplates(templates) {
                const container = document.getElementById('emailPreviewGrid');
                let html = '';

                templates.emails.forEach(email => {
                    html += `
                        <div class="email-preview-card">
                            <div class="email-preview-header">
                                <div class="email-type">${email.type}</div>
                                <div class="email-timing">${email.timing}</div>
                            </div>
                            <div class="email-subject">${email.subject}</div>
                            <div class="email-preview">${email.preview}</div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            }

            updateStats(newStats) {
                Object.assign(this.stats, newStats);
                
                // Update DOM
                document.getElementById('totalSent').textContent = this.stats.totalSent.toLocaleString();
                document.getElementById('openRate').textContent = this.stats.openRate + '%';
                document.getElementById('clickRate').textContent = this.stats.clickRate + '%';
                document.getElementById('conversions').textContent = this.stats.conversions;
            }

            startRealTimeUpdates() {
                // Simulate real-time stats updates
                setInterval(() => {
                    if (this.isActive) {
                        // Random small updates to make it feel alive
                        const updates = {};
                        
                        if (Math.random() > 0.7) {
                            updates.totalSent = this.stats.totalSent + Math.floor(Math.random() * 3);
                        }
                        
                        if (Math.random() > 0.8) {
                            updates.conversions = this.stats.conversions + (Math.random() > 0.5 ? 1 : 0);
                        }
                        
                        if (Object.keys(updates).length > 0) {
                            this.updateStats(updates);
                        }
                    }
                }, 30000); // Every 30 seconds
            }

            showModal(title, content) {
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalBody').innerHTML = content;
                document.getElementById('detailModal').classList.add('show');
            }

            closeModal() {
                document.getElementById('detailModal').classList.remove('show');
            }

            showNotification(text, type = 'info') {
                const notification = document.getElementById('notification');
                const notificationText = document.getElementById('notificationText');
                
                notificationText.textContent = text;
                
                // Set type class
                notification.className = `notification ${type}`;
                
                // Show notification
                notification.classList.add('show');
                
                // Hide after 4 seconds
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 4000);
            }

            // Public method to trigger from external (quiz)
            async triggerFromQuiz(userData) {
                console.log('🎯 Quiz trigger received:', userData);
                
                if (!this.isActive) {
                    console.log('⏸️ Sistema in pausa, email non inviata');
                    return;
                }
                
                try {
                    // Send welcome email immediately
                    await this.sendAutomationEmail(userData, 'welcome');
                    
                    // Schedule nurturing email (+2 days) - in production would use proper scheduling
                    console.log('📅 Programmazione email nurturing per +2 giorni');
                    
                    // Schedule conversion email (+5 days) - in production would use proper scheduling  
                    console.log('📅 Programmazione email conversion per +5 giorni');
                    
                    this.showNotification(`🚀 Sequenza email avviata per ${userData.nome}`, 'success');
                    
                    // Update stats
                    this.updateStats({
                        totalSent: this.stats.totalSent + 1
                    });
                    
                    // Add to active sequences
                    const newSequence = {
                        user: userData.nome || userData.name,
                        email: userData.email || 'test@example.com',
                        profile: this.getProfileDisplayName(userData.profileType),
                        currentStep: 'Welcome',
                        nextEmail: 'Nurturing (+2 giorni)',
                        status: 'active',
                        progress: 1,
                        total: 3
                    };
                    
                    this.activeSequences.unshift(newSequence);
                    this.renderActiveSequences();
                    
                } catch (error) {
                    console.error('❌ Errore trigger automazione:', error);
                    this.showNotification('❌ Errore invio email: ' + error.text, 'error');
                }
            }

            async sendAutomationEmail(userData, emailType) {
                const emailData = {
                    nome: userData.nome || userData.name || 'Utente',
                    email: userData.email || 'andrea.padoan@gmail.com',
                    email_type: emailType,
                    dashboard_url: 'https://tribucoach.vercel.app/pages/user-dashboard.html',
                    whatsapp: `https://wa.me/393123456789?text=Ciao%20Andrea,%20sono%20${userData.nome || 'un%20utente'}%20interessato%20al%20percorso%20coaching`
                };

                try {
                    const result = await emailjs.send(
                        this.emailConfig.serviceId,
                        this.emailConfig.templateId,
                        emailData
                    );
                    
                    console.log(`✅ Email ${emailType} inviata a ${emailData.nome}:`, result);
                    return result;
                    
                } catch (error) {
                    console.error(`❌ Errore invio email ${emailType}:`, error);
                    throw error;
                }
            }

            getProfileDisplayName(profileType) {
                const names = {
                    'stressato_esaurito': '😰 Stressato Esaurito',
                    'procrastinatore_bloccato': '⏳ Procrastinatore Bloccato',
                    'perfezionista_insoddisfatto': '🎯 Perfezionista Insoddisfatto',
                    'dispersivo_confuso': '🤯 Dispersivo Confuso',
                    'motivato_inconsistente': '🎢 Motivato Inconsistente',
                    'equilibrato_ottimizzatore': '⚡ Equilibrato Ottimizzatore'
                };
                return names[profileType] || profileType;
            }
        }

        // Initialize system when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('📧 Inizializzando Email Automation Module...');
            
            // Wait a bit for EmailJS SDK to load
            setTimeout(() => {
                // Initialize the email automation system
                window.emailAutomationSystem = new EmailAutomationSystem();
                
                // Global function for integration with quiz
                window.triggerEmailAutomationFromQuiz = function(quizResults) {
                    if (window.emailAutomationSystem) {
                        window.emailAutomationSystem.triggerFromQuiz(quizResults);
                    }
                };
                
                console.log('✅ Email Automation Module caricato completamente!');
            }, 1000); // Wait 1 second for EmailJS to load
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('detailModal');
                if (modal.classList.contains('show')) {
                    window.emailAutomationSystem.closeModal();
                }
            }
        });
    </script>
</body>
</html>