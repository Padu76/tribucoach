<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TribuCoach Dashboard - Business Intelligence</title>

    <!-- Import Session Manager PRIMA di tutto -->
    <script type="module" src="../api/unified-session-manager.js"></script>

    <!-- Firebase SDK v9 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, getDocs, query, orderBy, limit, where } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        // üîê CONTROLLO AUTENTICAZIONE IMMEDIATO
        let authCheckComplete = false;
        let currentUser = null;
        let sessionData = null;

        // Aspetta che il session manager sia pronto
        async function waitForAuth() {
            console.log('‚è≥ Aspetto session manager...');
            
            let attempts = 0;
            while (!window.sessionManager && attempts < 100) {
                await new Promise(resolve => setTimeout(resolve, 50));
                attempts++;
            }

            if (!window.sessionManager) {
                console.error('‚ùå Session Manager non trovato');
                redirectToLogin('Errore sistema autenticazione');
                return false;
            }

            // Controlla autenticazione
            const isAuth = window.isUserAuthenticated();
            currentUser = window.getCurrentUser();
            sessionData = window.getUserData();

            console.log('üîê Auth check:', {
                authenticated: isAuth,
                user: currentUser?.email || 'nessuno',
                sessionAge: window.sessionManager?.getSessionAge() || 0
            });

            if (!isAuth || !currentUser) {
                console.log('‚ùå Utente non autenticato, redirect al login');
                redirectToLogin('Sessione scaduta o non valida');
                return false;
            }

            console.log('‚úÖ Utente autenticato:', currentUser.email);
            authCheckComplete = true;
            
            // Aggiorna UI con dati utente
            updateUserInterface();
            
            return true;
        }

        function redirectToLogin(reason = '') {
            const loginUrl = `login.html${reason ? '?error=' + encodeURIComponent(reason) : ''}`;
            window.location.href = loginUrl;
        }

        function updateUserInterface() {
            if (!currentUser) return;

            try {
                // Aggiorna nome utente ovunque appaia
                const userNameElements = document.querySelectorAll('[data-user-name]');
                userNameElements.forEach(el => {
                    el.textContent = currentUser.displayName || currentUser.email.split('@')[0];
                });

                // Aggiorna email utente
                const userEmailElements = document.querySelectorAll('[data-user-email]');
                userEmailElements.forEach(el => {
                    el.textContent = currentUser.email;
                });

                // Mostra info sessione se presente
                if (sessionData && sessionData.loginCount) {
                    console.log(`üëã Bentornato! Login #${sessionData.loginCount}`);
                }

                // Aggiorna header con info utente
                updateDashboardHeader();

            } catch (error) {
                console.error('‚ùå Errore aggiornamento UI:', error);
            }
        }

        function updateDashboardHeader() {
            const headerElement = document.querySelector('.header p');
            if (headerElement && currentUser) {
                const sessionAge = window.sessionManager?.getSessionAge() || 0;
                const hoursActive = Math.round(sessionAge / (1000 * 60 * 60));
                
                headerElement.innerHTML = `
                    Dashboard di <strong data-user-name>${currentUser.displayName || currentUser.email}</strong> 
                    - Sistema unificato Quiz + Chat Andrea Padoan
                    ${hoursActive > 0 ? `<br><small style="opacity: 0.7;">Sessione attiva da ${hoursActive}h</small>` : ''}
                `;
            }
        }

        // üöÄ INIZIALIZZAZIONE PROTETTA
        async function initSecureDashboard() {
            console.log('üöÄ Inizializzazione dashboard sicura...');
            
            // 1. Verifica autenticazione
            const authOk = await waitForAuth();
            if (!authOk) return;

            // 2. Configurazione Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyDSsQEPii_Eb99cWGs7eqozgTtIqbtO2rs",
                authDomain: "tribucoach-a2254.firebaseapp.com",
                projectId: "tribucoach-a2254",
                storageBucket: "tribucoach-a2254.firebasestorage.app",
                messagingSenderId: "425200296836",
                appId: "1:425200296836:web:7835188f40f4348567ab48"
            };

            // 3. Inizializza Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            window.firebaseApp = app;
            window.firebaseDB = db;

            console.log('üî• Firebase inizializzato per utente:', currentUser.email);

            // 4. Carica dati dashboard
            await loadDashboardData();

            // 5. Setup listeners e UI
            setupDashboardFunctionality();

            console.log('‚úÖ Dashboard completamente inizializzata');
        }

        // ‚ö° GESTIONE LOGOUT
        function setupLogoutFunctionality() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    console.log('üö™ Logout in corso...');
                    
                    try {
                        await window.logoutUser();
                        console.log('‚úÖ Logout completato');
                        window.location.href = 'login.html?message=Logout effettuato con successo';
                    } catch (error) {
                        console.error('‚ùå Errore logout:', error);
                        alert('Errore durante il logout');
                    }
                });
            }
        }

        // üíæ SALVATAGGIO AUTOMATICO DATI DASHBOARD
        function setupAutoSave() {
            // Salva dati dashboard ogni volta che cambiano
            const saveCurrentDashboardState = () => {
                const dashboardState = {
                    lastViewed: Date.now(),
                    currentFilters: {
                        quiz: currentQuizFilter,
                        chat: currentChatFilter
                    },
                    viewPreferences: {
                        autoRefresh: true,
                        lastUpdate: new Date().toISOString()
                    },
                    metrics: {
                        totalQuizzes: quizLeads?.length || 0,
                        totalChats: chatConversations?.length || 0
                    }
                };

                window.updateUserData({ dashboardState });
            };

            // Auto-save ogni 30 secondi
            setInterval(saveCurrentDashboardState, 30000);

            // Save on page visibility change
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    saveCurrentDashboardState();
                }
            });

            // Save before unload
            window.addEventListener('beforeunload', saveCurrentDashboardState);
        }

        // üìä RIPRISTINO STATO DASHBOARD
        function restoreDashboardState() {
            try {
                const userData = window.getUserData();
                if (userData && userData.dashboardState) {
                    const state = userData.dashboardState;
                    
                    // Ripristina filtri se presenti
                    if (state.currentFilters) {
                        currentQuizFilter = state.currentFilters.quiz || 'all';
                        currentChatFilter = state.currentFilters.chat || 'all';
                        
                        // Aggiorna UI filtri
                        const quizFilterElement = document.getElementById('quiz-filter-current');
                        const chatFilterElement = document.getElementById('chat-filter-current');
                        
                        if (quizFilterElement) {
                            const filterLabels = { 'all': 'Tutti', 'today': 'Oggi', 'week': 'Settimana', 'month': 'Mese' };
                            quizFilterElement.textContent = filterLabels[currentQuizFilter] || 'Tutti';
                        }
                        
                        if (chatFilterElement) {
                            const filterLabels = { 'all': 'Tutti', 'today': 'Oggi', 'week': 'Settimana', 'month': 'Mese' };
                            chatFilterElement.textContent = filterLabels[currentChatFilter] || 'Tutti';
                        }
                    }
                    
                    console.log('üîÑ Stato dashboard ripristinato:', state);
                }
            } catch (error) {
                console.error('‚ùå Errore ripristino stato dashboard:', error);
            }
        }

        // üîÑ ESTENSIONE AUTOMATICA SESSIONE
        function setupSessionExtension() {
            // Estende la sessione ogni 5 minuti se l'utente √® attivo
            let lastActivity = Date.now();
            
            // Track user activity
            const activityEvents = ['click', 'mousemove', 'keydown', 'scroll'];
            activityEvents.forEach(event => {
                document.addEventListener(event, () => {
                    lastActivity = Date.now();
                }, { passive: true });
            });

            // Check and extend session ogni 5 minuti
            setInterval(() => {
                const timeSinceActivity = Date.now() - lastActivity;
                const maxInactive = 30 * 60 * 1000; // 30 minuti
                
                if (timeSinceActivity < maxInactive && window.sessionManager) {
                    window.sessionManager.extendSession();
                    console.log('üîÑ Sessione estesa automaticamente');
                }
            }, 5 * 60 * 1000);
        }

        // üì± NOTIFICHE PUSH PER NUOVI DATI
        function setupDataNotifications() {
            // Listen per aggiornamenti dati
            window.addEventListener('tribucoachDataRefresh', (event) => {
                console.log('üì° Dati aggiornati:', event.detail);
                
                // Mostra notifica all'utente
                showNotification('üìä Dati dashboard aggiornati', 'success');
                
                // Ricarica display se necessario
                if (window.loadFirebaseData) {
                    window.loadFirebaseData();
                }
            });
        }

        // Variabili globali per compatibilit√† con il codice esistente
        let chatConversations = [];
        let quizLeads = [];
        let allQuizLeads = [];
        let allChatConversations = [];
        let currentQuizFilter = 'all';
        let currentChatFilter = 'all';
        let currentQuizSearch = '';
        let currentChatSearch = '';
        let selectedQuizLeads = new Set();
        let selectedChats = new Set();

        // üî• CARICA DATI FIREBASE (codice esistente con miglioramenti)
        async function loadFirebaseData() {
            if (!authCheckComplete) {
                console.log('‚è≥ Auth non completato, aspetto...');
                return;
            }

            try {
                console.log('üìÑ Caricamento dati Firebase per utente:', currentUser.email);
                updateConnectionStatus('üìÑ Caricamento dati...', '#ff9800');

                // Tutto il codice esistente di caricamento dati...
                // (mantengo la logica esistente)
                
                const db = window.firebaseDB;
                
                // 1. Carica TUTTE le conversazioni chat
                try {
                    console.log('üî• Caricamento conversazioni chat...');
                    const chatSnapshot = await getDocs(collection(db, 'chatbase_conversations'));
                    
                    allChatConversations = [];
                    chatSnapshot.forEach(function(doc) {
                        const data = doc.data();
                        console.log('üìã Conversazione trovata:', doc.id, data);

                        allChatConversations.push({
                            id: doc.id,
                            ...data,
                            lastUpdate: data.lastUpdate ? data.lastUpdate.toDate() : 
                                       data.lastMessageAt ? data.lastMessageAt.toDate() :
                                       data.startTime ? data.startTime.toDate() : new Date(),
                            startTime: data.startTime ? data.startTime.toDate() : new Date(),
                            endTime: data.endTime ? data.endTime.toDate() : null,
                            fullConversation: (() => {
                                if (data.fullconversation) {
                                    if (typeof data.fullconversation === 'string') {
                                        try {
                                            return JSON.parse(data.fullconversation);
                                        } catch (e) {
                                            console.warn('‚ö†Ô∏è JSON parse failed for fullconversation:', e);
                                        }
                                    } else if (Array.isArray(data.fullconversation)) {
                                        return data.fullconversation;
                                    }
                                }
                                
                                if (data.fullConversation) {
                                    if (typeof data.fullConversation === 'string') {
                                        try {
                                            return JSON.parse(data.fullConversation);
                                        } catch (e) {
                                            console.warn('‚ö†Ô∏è JSON parse failed for fullConversation:', e);
                                        }
                                    } else if (Array.isArray(data.fullConversation)) {
                                        return data.fullConversation;
                                    }
                                }
                                
                                return data.messages || [];
                            })(),
                            messageCount: data.messageCount || (() => {
                                if (data.fullconversation && typeof data.fullconversation === 'string') {
                                    try {
                                        const parsed = JSON.parse(data.fullconversation);
                                        return Array.isArray(parsed) ? parsed.length : 0;
                                    } catch (e) {
                                        return 0;
                                    }
                                } else if (Array.isArray(data.fullconversation)) {
                                    return data.fullconversation.length;
                                } else if (Array.isArray(data.fullConversation)) {
                                    return data.fullConversation.length;
                                }
                                return 0;
                            })(),
                            customerName: data.customerName || 'Anonimo',
                            customerPhone: data.customerPhone || null,
                            customerEmail: data.customerEmail || null,
                            status: data.status || 'unknown'
                        });
                    });
                    
                    allChatConversations.sort((a, b) => b.lastUpdate - a.lastUpdate);
                    console.log('‚úÖ Chat caricate:', allChatConversations.length);
                    updateChatDisplay();
                    
                } catch (chatError) {
                    console.warn('‚ö†Ô∏è Errore caricamento chat:', chatError);
                    allChatConversations = [];
                    chatConversations = [];
                }

                // 2. Carica TUTTI i quiz results
                try {
                    console.log('üî• Caricamento quiz results...');
                    const quizSnapshot = await getDocs(collection(db, 'quiz_results'));
                    
                    allQuizLeads = [];
                    quizSnapshot.forEach(function(doc) {
                        const data = doc.data();
                        console.log('üìã Quiz trovato:', doc.id, data);
                        
                        let timestamp = new Date();
                        if (data.completed_at) {
                            timestamp = new Date(data.completed_at);
                        } else if (data.timestamp) {
                            timestamp = data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestamp);
                        } else if (data.created_at) {
                            timestamp = new Date(data.created_at);
                        } else if (data.date) {
                            timestamp = new Date(data.date);
                        }
                        
                        allQuizLeads.push({
                            id: doc.id,
                            ...data,
                            timestamp: timestamp
                        });
                    });
                    
                    allQuizLeads.sort((a, b) => b.timestamp - a.timestamp);
                    console.log('‚úÖ Quiz caricati:', allQuizLeads.length);
                    updateQuizDisplay();
                    
                } catch (quizError) {
                    console.warn('‚ö†Ô∏è Errore caricamento quiz:', quizError);
                    allQuizLeads = [];
                    quizLeads = [];
                }

                // 3. Aggiorna dashboard
                updateDashboard();
                updateConnectionStatus('‚úÖ Dati caricati - Dashboard aggiornata', '#4CAF50');
                
                // 4. Salva stato aggiornato
                window.updateUserData({
                    lastDataLoad: Date.now(),
                    dataStats: {
                        totalChats: allChatConversations.length,
                        totalQuizzes: allQuizLeads.length
                    }
                });
                
                console.log('‚úÖ Dashboard aggiornata:', {
                    chat: chatConversations.length,
                    quiz: quizLeads.length,
                    totalChat: allChatConversations.length,
                    totalQuiz: allQuizLeads.length,
                    user: currentUser.email
                });

            } catch (error) {
                console.error('‚ùå Errore caricamento Firebase:', error);
                updateConnectionStatus('‚ùå Errore Firebase - Verifica connessione', '#f44336');
            }
        }

        // Resto del codice esistente della dashboard...
        // (tutte le funzioni esistenti rimangono uguali)
        
        // Aggiorna status connessione
        function updateConnectionStatus(message, color) {
            const statusEl = document.querySelector('.connection-status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.style.background = color;
            }
        }

        function updateDashboard() {
            updateMainMetrics();
            updateBusinessInsights();
            updateQuizLeads();
            updateChatConversations();
            updateAnalytics();
            updateLastUpdateTime();
        }

        function updateMainMetrics() {
            const totalLeads = quizLeads.length;
            let qualifiedLeads = 0;
            let premiumLeads = 0;
            let totalScore = 0;
            
            for (let i = 0; i < quizLeads.length; i++) {
                const score = quizLeads[i].lead_score || 0;
                totalScore += score;
                if (score >= 70) qualifiedLeads++;
                if (score >= 80) premiumLeads++;
            }
            
            const averageScore = totalLeads > 0 ? Math.round(totalScore / totalLeads) : 0;
            const totalChats = chatConversations.length;

            const metrics = [
                { selector: '.metric-card:nth-child(1) p', value: totalLeads },
                { selector: '.metric-card:nth-child(2) p', value: averageScore + '%' },
                { selector: '.metric-card:nth-child(3) p', value: totalChats },
                { selector: '.metric-card:nth-child(4) p', value: premiumLeads }
            ];

            for (let i = 0; i < metrics.length; i++) {
                const el = document.querySelector(metrics[i].selector);
                if (el) el.textContent = metrics[i].value;
            }
            
            console.log('üìä Metriche aggiornate per utente:', currentUser.email);
        }

        // [Tutte le altre funzioni esistenti rimangono identiche...]
        // updateBusinessInsights, updateQuizDisplay, updateChatDisplay, etc.

        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('it-IT', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            const timeElement = document.getElementById('lastUpdate');
            if (timeElement) {
                timeElement.textContent = timeString;
            }
        }

        // üöÄ INIZIALIZZAZIONE PRINCIPALE
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Dashboard TribuCoach - Inizializzazione con sessione persistente...');
            
            try {
                // Inizializza dashboard sicura
                await initSecureDashboard();
                
                // Setup funzionalit√† aggiuntive
                setupLogoutFunctionality();
                setupAutoSave();
                setupSessionExtension();
                setupDataNotifications();
                
                // Ripristina stato precedente
                restoreDashboardState();
                
                // Auto-refresh ogni 60 secondi
                setInterval(() => {
                    if (authCheckComplete && window.isUserAuthenticated()) {
                        console.log('‚è∞ Auto-refresh dati...');
                        loadFirebaseData();
                    }
                }, 60000);
                
                // Aggiorna ora ogni 5 secondi
                setInterval(updateLastUpdateTime, 5000);
                
                console.log('‚úÖ Dashboard TribuCoach completamente inizializzata');
                showNotification('‚úÖ Dashboard caricata con successo!', 'success');
                
            } catch (error) {
                console.error('‚ùå Errore inizializzazione dashboard:', error);
                redirectToLogin('Errore inizializzazione dashboard');
            }
        });

        // Esponi funzioni per compatibilit√†
        window.loadFirebaseData = loadFirebaseData;
        window.updateConnectionStatus = updateConnectionStatus;
        window.updateDashboard = updateDashboard;
        window.currentUser = () => currentUser;
        window.sessionData = () => sessionData;

    </script>

    <!-- Tutto il CSS esistente rimane identico -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #2a2a2a 100%);
            color: #fff;
            min-height: 100vh;
            line-height: 1.4;
        }

        .connection-status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 0.8rem;
            z-index: 1000;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            transition: all 0.3s ease;
        }

        .header {
            background: linear-gradient(135deg, rgba(255,102,0,0.15), rgba(255,102,0,0.05));
            padding: 25px;
            border-bottom: 3px solid #ff6600;
            backdrop-filter: blur(20px);
            margin-top: 40px;
            position: relative;
            z-index: 1;
        }

        .header h1 {
            color: #ff6600;
            font-size: 2.2rem;
            margin-bottom: 8px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(255,102,0,0.3);
        }

        .header p {
            color: #ccc;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .header .header-controls {
            position: absolute;
            top: 25px;
            right: 25px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-info {
            background: rgba(255, 102, 0, 0.1);
            border: 1px solid rgba(255, 102, 0, 0.3);
            border-radius: 25px;
            padding: 8px 16px;
            font-size: 0.85rem;
            color: #ff9933;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header .refresh-button, .header .logout-button {
            background: linear-gradient(135deg, #ff6600, #ff8533);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 102, 0, 0.3);
        }

        .header .logout-button {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        .header .refresh-button:hover {
            background: linear-gradient(135deg, #ff8533, #ffaa66);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 102, 0, 0.4);
        }

        .header .logout-button:hover {
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 12px;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            max-width: 350px;
            animation: slideInRight 0.3s ease-out;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .toast.success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .toast.error {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .toast.info {
            background: linear-gradient(135deg, #ff6600, #ff8533);
            color: white;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Responsive per header controls */
        @media (max-width: 768px) {
            .header .header-controls {
                position: static;
                margin-top: 15px;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .user-info {
                order: -1;
                width: 100%;
                justify-content: center;
                margin-bottom: 10px;
            }
        }

        /* Resto del CSS esistente rimane identico... */
        /* (tutto il CSS della dashboard originale) */
    </style>
</head>
<body>
    <div class="connection-status">üîÑ Inizializzazione Dashboard Sicura...</div>

    <header class="header">
        <h1>üìà TribuCoach Business Intelligence</h1>
        <p>Dashboard in tempo reale - Sistema unificato Quiz + Chat Andrea Padoan</p>
        
        <div class="header-controls">
            <div class="user-info">
                <span>üë§</span>
                <span data-user-name>Caricamento...</span>
                <span style="opacity: 0.7;">|</span>
                <span data-user-email style="font-size: 0.8rem;">email...</span>
            </div>
            <button class="refresh-button" onclick="loadFirebaseData()">üîÑ Aggiorna Dati</button>
            <button id="logoutBtn" class="logout-button">üö™ Logout</button>
        </div>
    </header>

    <!-- Tutto il resto dell HTML rimane identico alla dashboard originale -->
    <!-- (metriche, sezioni quiz, chat, analytics, etc.) -->

    <!-- Funzioni JavaScript helper -->
    <script>
        // Sistema di notifiche toast
        function showNotification(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                info: 'üì¢'
            };
            
            toast.innerHTML = `${icons[type] || 'üì¢'} ${message}`;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }
            }, 4000);
        }

        // Funzioni globali per compatibilit√† (vuote, verranno riempite dall'init)
        function openWhatsApp(phone) {
            if (!phone || phone === 'N/A') {
                showNotification('Numero di telefono non disponibile', 'error');
                return;
            }
            
            let cleanPhone = phone.replace(/[^\d+]/g, '');
            if (!cleanPhone.startsWith('+')) {
                cleanPhone = '+39' + cleanPhone.replace(/^0+/, '');
            }
            
            const whatsappUrl = 'https://wa.me/' + cleanPhone.replace('+', '');
            window.open(whatsappUrl, '_blank');
            showNotification('Apertura WhatsApp...', 'success');
        }

        function closeModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        // Event listeners per modal
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('detailsModal');
            if (e.target === modal) {
                closeModal();
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Gestione refresh e back button
        window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
                window.location.reload();
            }
        });

        // Protection contro accesso diretto senza autenticazione
        if (!document.referrer.includes('login.html') && !window.sessionStorage.getItem('auth_bypass')) {
            setTimeout(() => {
                if (!window.isUserAuthenticated || !window.isUserAuthenticated()) {
                    console.log('‚ö†Ô∏è Accesso diretto senza auth, redirect...');
                    window.location.href = 'login.html?error=Accesso non autorizzato';
                }
            }, 2000);
        }
    </script>
</body>
</html>