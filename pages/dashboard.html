<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TribuCoach Dashboard - Business Intelligence</title>

    <!-- Import Session Manager PRIMA di tutto - PATH CORRETTO -->
    <script type="module" src="../js/unified-session-manager.js"></script>

    <!-- Firebase SDK v9 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, getDocs, query, orderBy, limit, where } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        // üîç CONTROLLO AUTENTICAZIONE AVANZATO CON SESSION MANAGER
        let authCheckComplete = false;
        let currentUser = null;
        let sessionData = null;
        let sessionManagerIntegrated = false;
        let sessionManagerInstance = null;

        // Aspetta che il session manager sia pronto con fallback robusto
        async function waitForAuth() {
            console.log('‚è≥ Aspetto session manager...');
            
            let attempts = 0;
            const maxAttempts = 100; // 5 secondi max
            
            while (!window.sessionManager && !window.tribucoachSession && attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 50));
                attempts++;
            }

            // Integrazione Session Manager
            if (window.sessionManager || window.tribucoachSession) {
                sessionManagerInstance = window.sessionManager || window.tribucoachSession;
                sessionManagerIntegrated = true;
                console.log('‚úÖ Session Manager integrato nella dashboard');
                showIntegrationStatus('integrated');
            } else {
                console.warn('‚ö†Ô∏è Session Manager non trovato, modalit√† fallback');
                sessionManagerIntegrated = false;
                showIntegrationStatus('fallback');
                
                // Fallback: controlla localStorage tradizionale
                return checkTraditionalAuth();
            }

            // Controlla autenticazione via Session Manager
            const isAuth = window.isUserAuthenticated();
            currentUser = window.getCurrentUser();
            sessionData = window.getUserData();

            console.log('üîç Auth check via Session Manager:', {
                authenticated: isAuth,
                user: currentUser?.email || 'nessuno',
                sessionAge: sessionManagerInstance?.getSessionAge() || 0,
                integrated: sessionManagerIntegrated
            });

            if (!isAuth || !currentUser) {
                console.log('‚ùå Utente non autenticato, redirect al login');
                redirectToLogin('Sessione scaduta o non valida');
                return false;
            }

            console.log('‚úÖ Utente autenticato via Session Manager:', currentUser.email);
            authCheckComplete = true;
            
            // Aggiorna UI con dati utente
            updateUserInterface();
            
            // Recupera stato dashboard precedente
            await restoreDashboardFromSessionManager();
            
            return true;
        }

        // Fallback per autenticazione tradizionale
        function checkTraditionalAuth() {
            console.log('üîÑ Controllo autenticazione tradizionale...');
            
            try {
                const savedUser = localStorage.getItem('tribucoach_user');
                const savedSession = localStorage.getItem('tribucoach_session');
                
                if (savedUser && savedSession) {
                    currentUser = JSON.parse(savedUser);
                    const session = JSON.parse(savedSession);
                    
                    // Verifica validit√† sessione
                    if (session.isValid && Date.now() - session.loginTime < 30 * 24 * 60 * 60 * 1000) {
                        console.log('‚úÖ Sessione tradizionale valida:', currentUser.email);
                        authCheckComplete = true;
                        updateUserInterface();
                        return true;
                    }
                }
                
                console.log('‚ùå Nessuna sessione valida trovata');
                redirectToLogin('Sessione non trovata o scaduta');
                return false;
                
            } catch (error) {
                console.error('‚ùå Errore controllo autenticazione tradizionale:', error);
                redirectToLogin('Errore verifica autenticazione');
                return false;
            }
        }

        function showIntegrationStatus(status) {
            const statusMessages = {
                integrated: 'üîó Session Manager Integrato',
                fallback: '‚ö†Ô∏è Modalit√† Fallback',
                error: '‚ùå Errore Integrazione'
            };
            
            const colors = {
                integrated: '#4CAF50',
                fallback: '#ff9800',
                error: '#f44336'
            };
            
            showNotification(statusMessages[status], status === 'integrated' ? 'success' : status === 'error' ? 'error' : 'info');
            updateConnectionStatus(statusMessages[status], colors[status]);
        }

        function redirectToLogin(reason = '') {
            const loginUrl = `login.html${reason ? '?error=' + encodeURIComponent(reason) : ''}`;
            window.location.href = loginUrl;
        }

        function updateUserInterface() {
            if (!currentUser) return;

            try {
                // Aggiorna nome utente ovunque appaia
                const userNameElements = document.querySelectorAll('[data-user-name]');
                userNameElements.forEach(el => {
                    el.textContent = currentUser.displayName || currentUser.email.split('@')[0];
                });

                // Aggiorna email utente
                const userEmailElements = document.querySelectorAll('[data-user-email]');
                userEmailElements.forEach(el => {
                    el.textContent = currentUser.email;
                });

                // Mostra info sessione se presente
                if (sessionData && sessionData.loginCount) {
                    console.log(`üëã Bentornato! Login #${sessionData.loginCount}`);
                }

                // Aggiorna header con info utente
                updateDashboardHeader();

                console.log('üé® UI aggiornata per utente:', currentUser.email);

            } catch (error) {
                console.error('‚ùå Errore aggiornamento UI:', error);
            }
        }

        function updateDashboardHeader() {
            const headerElement = document.querySelector('.header p');
            if (headerElement && currentUser) {
                const sessionAge = sessionManagerInstance?.getSessionAge() || 0;
                const hoursActive = Math.round(sessionAge / (1000 * 60 * 60));
                
                const integrationInfo = sessionManagerIntegrated ? 
                    `<span style="color: #4CAF50;">üîó Session Manager</span>` : 
                    `<span style="color: #ff9800;">‚ö†Ô∏è Modalit√† Fallback</span>`;
                
                headerElement.innerHTML = `
                    Dashboard di <strong data-user-name>${currentUser.displayName || currentUser.email}</strong> 
                    - ${integrationInfo}
                    ${hoursActive > 0 ? `<br><small style="opacity: 0.7;">Sessione attiva da ${hoursActive}h</small>` : ''}
                `;
            }
        }

        // üìä RECUPERO STATO DASHBOARD DA SESSION MANAGER
        async function restoreDashboardFromSessionManager() {
            if (!sessionManagerIntegrated || !sessionData) {
                console.log('üìä Recupero stato da localStorage tradizionale...');
                restoreDashboardStateTraditional();
                return;
            }

            try {
                console.log('üìä Recupero stato dashboard da Session Manager...');
                
                // Recupera dati dashboard specifici
                if (sessionData.dashboardState) {
                    const state = sessionData.dashboardState;
                    
                    // Ripristina filtri
                    if (state.currentFilters) {
                        currentQuizFilter = state.currentFilters.quiz || 'all';
                        currentChatFilter = state.currentFilters.chat || 'all';
                        
                        console.log('üîÑ Filtri ripristinati:', state.currentFilters);
                    }
                    
                    // Ripristina preferenze
                    if (state.viewPreferences) {
                        console.log('‚öôÔ∏è Preferenze ripristinate:', state.viewPreferences);
                    }
                    
                    // Mostra metriche precedenti se disponibili
                    if (state.metrics) {
                        console.log('üìà Metriche precedenti:', state.metrics);
                        showNotification(`üìä Dati precedenti: ${state.metrics.totalQuizzes} quiz, ${state.metrics.totalChats} chat`, 'info');
                    }
                }

                // Recupera dati quiz e chat precedenti se presenti
                if (sessionData.lifestyleProfile) {
                    console.log('üéØ Profilo lifestyle trovato:', sessionData.lifestyleProfile.profileType);
                }

                if (sessionData.lastDataLoad) {
                    const lastLoad = new Date(sessionData.lastDataLoad);
                    const hoursAgo = Math.round((Date.now() - sessionData.lastDataLoad) / (1000 * 60 * 60));
                    console.log(`‚è∞ Ultimo caricamento dati: ${hoursAgo}h fa`);
                }

                showNotification('üìä Stato dashboard ripristinato dal Session Manager', 'success');

            } catch (error) {
                console.error('‚ùå Errore recupero stato da Session Manager:', error);
                restoreDashboardStateTraditional();
            }
        }

        // üöÄ INIZIALIZZAZIONE PROTETTA E POTENZIATA
        async function initSecureDashboard() {
            console.log('üöÄ Inizializzazione dashboard sicura con Session Manager...');
            
            // 1. Verifica autenticazione avanzata
            const authOk = await waitForAuth();
            if (!authOk) return;

            // 2. Configurazione Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyDSsQEPii_Eb99cWGs7eqozgTtIqbtO2rs",
                authDomain: "tribucoach-a2254.firebaseapp.com",
                projectId: "tribucoach-a2254",
                storageBucket: "tribucoach-a2254.firebasestorage.app",
                messagingSenderId: "425200296836",
                appId: "1:425200296836:web:7835188f40f4348567ab48"
            };

            // 3. Inizializza Firebase
            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                window.firebaseApp = app;
                window.firebaseDB = db;

                console.log('üî• Firebase inizializzato per utente:', currentUser.email);
                updateConnectionStatus('üî• Firebase connesso', '#4CAF50');

            } catch (firebaseError) {
                console.error('‚ùå Errore inizializzazione Firebase:', firebaseError);
                updateConnectionStatus('‚ùå Errore Firebase', '#f44336');
                showNotification('‚ö†Ô∏è Problema connessione Firebase. Alcune funzioni potrebbero non funzionare.', 'error');
            }

            // 4. Carica dati dashboard
            await loadDashboardData();

            // 5. Setup listeners e UI
            setupDashboardFunctionality();

            // 6. Setup integrazione Session Manager
            if (sessionManagerIntegrated) {
                setupSessionManagerIntegration();
            }

            console.log('‚úÖ Dashboard completamente inizializzata con Session Manager');
        }

        // üîó SETUP INTEGRAZIONE SESSION MANAGER
        function setupSessionManagerIntegration() {
            console.log('üîó Setup integrazione Session Manager...');

            // Listener per cambiamenti auth state
            if (sessionManagerInstance.onAuthStateChanged) {
                sessionManagerInstance.onAuthStateChanged((user) => {
                    console.log('üë§ Auth state changed via Session Manager:', user?.email || 'logged out');
                    
                    if (!user) {
                        // User logged out via session manager
                        console.log('üö™ Logout rilevato via Session Manager');
                        window.location.href = 'login.html?message=Sessione terminata';
                    } else if (user.email !== currentUser?.email) {
                        // Different user logged in
                        console.log('üîÑ Cambio utente rilevato, ricarico dashboard');
                        window.location.reload();
                    }
                });
            }

            // Listener per refresh dati
            window.addEventListener('tribucoachDataRefresh', (event) => {
                console.log('üì° Data refresh event ricevuto:', event.detail);
                showNotification('üìä Dati aggiornati automaticamente', 'success');
                
                if (window.loadFirebaseData) {
                    window.loadFirebaseData();
                }
            });

            console.log('‚úÖ Integrazione Session Manager configurata');
        }

        // ‚ö° GESTIONE LOGOUT UNIFICATA
        function setupLogoutFunctionality() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    console.log('üö™ Logout unificato in corso...');
                    
                    try {
                        // Salva stato finale
                        await saveCurrentDashboardState();
                        
                        // Logout via Session Manager se disponibile
                        if (sessionManagerIntegrated && window.logoutUser) {
                            await window.logoutUser();
                            console.log('‚úÖ Logout via Session Manager completato');
                        } else {
                            // Fallback logout tradizionale
                            localStorage.removeItem('tribucoach_user');
                            localStorage.removeItem('tribucoach_session');
                            console.log('‚úÖ Logout tradizionale completato');
                        }
                        
                        showNotification('üëã Logout effettuato con successo!', 'success');
                        
                        setTimeout(() => {
                            window.location.href = 'login.html?message=Logout effettuato con successo';
                        }, 1500);
                        
                    } catch (error) {
                        console.error('‚ùå Errore logout:', error);
                        showNotification('‚ùå Errore durante il logout', 'error');
                        
                        // Force redirect anyway
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 2000);
                    }
                });
            }
        }

        // üíæ SALVATAGGIO AUTOMATICO DATI DASHBOARD MIGLIORATO
        function setupAutoSave() {
            console.log('üíæ Setup auto-save dashboard...');

            // Auto-save ogni 30 secondi
            setInterval(saveCurrentDashboardState, 30000);

            // Save on page visibility change
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    saveCurrentDashboardState();
                }
            });

            // Save before unload
            window.addEventListener('beforeunload', saveCurrentDashboardState);

            console.log('‚úÖ Auto-save configurato');
        }

        // Salva stato corrente dashboard
        async function saveCurrentDashboardState() {
            try {
                const dashboardState = {
                    lastViewed: Date.now(),
                    currentFilters: {
                        quiz: currentQuizFilter,
                        chat: currentChatFilter
                    },
                    viewPreferences: {
                        autoRefresh: true,
                        lastUpdate: new Date().toISOString()
                    },
                    metrics: {
                        totalQuizzes: quizLeads?.length || 0,
                        totalChats: chatConversations?.length || 0,
                        qualifiedLeads: quizLeads?.filter(lead => (lead.lead_score || 0) >= 70).length || 0
                    },
                    userActivity: {
                        lastInteraction: Date.now(),
                        pageViews: (sessionData?.userActivity?.pageViews || 0) + 1
                    }
                };

                if (sessionManagerIntegrated && window.updateUserData) {
                    // Salva via Session Manager
                    window.updateUserData({ 
                        dashboardState,
                        lastDashboardAccess: Date.now()
                    });
                    console.log('üíæ Stato dashboard salvato via Session Manager');
                } else {
                    // Fallback localStorage
                    localStorage.setItem('tribucoach_dashboard_state', JSON.stringify(dashboardState));
                    console.log('üíæ Stato dashboard salvato in localStorage');
                }

            } catch (error) {
                console.error('‚ùå Errore salvataggio stato dashboard:', error);
            }
        }

        // üìä RIPRISTINO STATO DASHBOARD TRADIZIONALE (FALLBACK)
        function restoreDashboardStateTraditional() {
            try {
                const savedState = localStorage.getItem('tribucoach_dashboard_state');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    
                    // Ripristina filtri se presenti
                    if (state.currentFilters) {
                        currentQuizFilter = state.currentFilters.quiz || 'all';
                        currentChatFilter = state.currentFilters.chat || 'all';
                        console.log('üîÑ Filtri ripristinati (fallback):', state.currentFilters);
                    }

                    if (state.metrics) {
                        showNotification(`üìä Dati precedenti: ${state.metrics.totalQuizzes} quiz, ${state.metrics.totalChats} chat`, 'info');
                    }
                }
            } catch (error) {
                console.error('‚ùå Errore ripristino stato tradizionale:', error);
            }
        }

        // üîÑ ESTENSIONE AUTOMATICA SESSIONE MIGLIORATA
        function setupSessionExtension() {
            console.log('üîÑ Setup estensione automatica sessione...');
            
            let lastActivity = Date.now();
            
            // Track user activity
            const activityEvents = ['click', 'mousemove', 'keydown', 'scroll'];
            activityEvents.forEach(event => {
                document.addEventListener(event, () => {
                    lastActivity = Date.now();
                }, { passive: true });
            });

            // Check and extend session ogni 5 minuti
            setInterval(() => {
                const timeSinceActivity = Date.now() - lastActivity;
                const maxInactive = 30 * 60 * 1000; // 30 minuti
                
                if (timeSinceActivity < maxInactive) {
                    if (sessionManagerIntegrated && sessionManagerInstance?.extendSession) {
                        sessionManagerInstance.extendSession();
                        console.log('üîÑ Sessione estesa via Session Manager');
                    } else {
                        // Estensione tradizionale
                        const session = JSON.parse(localStorage.getItem('tribucoach_session') || '{}');
                        session.lastActivity = Date.now();
                        localStorage.setItem('tribucoach_session', JSON.stringify(session));
                        console.log('üîÑ Sessione estesa (fallback)');
                    }
                }
            }, 5 * 60 * 1000);

            console.log('‚úÖ Estensione sessione configurata');
        }

        // üîç TRIPLE-CLICK ADMIN ACCESS SYSTEM
        function setupAdminAccess() {
            const headerTitle = document.querySelector('.header h1');
            if (!headerTitle) return;

            let clickCount = 0;
            let clickTimer = null;

            headerTitle.style.cursor = 'pointer';
            headerTitle.addEventListener('click', () => {
                clickCount++;
                
                if (clickCount === 1) {
                    clickTimer = setTimeout(() => {
                        clickCount = 0;
                    }, 800); // Reset dopo 800ms
                } else if (clickCount === 3) {
                    clearTimeout(clickTimer);
                    clickCount = 0;
                    
                    // Triple-click rilevato
                    console.log('üîç Triple-click rilevato, accesso admin...');
                    promptAdminAccess();
                }
            });

            console.log('üîç Sistema accesso admin configurato (triple-click su titolo)');
        }

        function promptAdminAccess() {
            const username = prompt('üîç Accesso Admin\nUsername:');
            if (!username) return;

            const password = prompt('üîç Accesso Admin\nPassword:');
            if (!password) return;

            if (username === 'admin' && password === 'tribucoach2024') {
                console.log('‚úÖ Credenziali admin corrette');
                
                // Salva sessione admin
                const adminSession = {
                    username: username,
                    timestamp: Date.now(),
                    source: 'triple_click_dashboard'
                };
                localStorage.setItem('admin_session_tribucoach', JSON.stringify(adminSession));
                
                // Aggiungi flag admin al session manager se disponibile
                if (sessionManagerIntegrated && window.updateUserData) {
                    window.updateUserData({ isAdmin: true });
                }
                
                showNotification('üéâ Accesso admin autorizzato! Reindirizzamento...', 'success');
                
                setTimeout(() => {
                    window.location.href = 'admin/admin-dashboard.html';
                }, 1500);
            } else {
                console.log('‚ùå Credenziali admin errate');
                showNotification('‚ùå Credenziali non valide', 'error');
            }
        }

        // üì± NOTIFICHE PUSH PER NUOVI DATI MIGLIORATE
        function setupDataNotifications() {
            console.log('üì± Setup notifiche push dati...');

            // Listen per aggiornamenti dati from session manager
            window.addEventListener('tribucoachDataRefresh', (event) => {
                console.log('üì° Dati aggiornati via Session Manager:', event.detail);
                
                showNotification('üìä Dati dashboard aggiornati automaticamente', 'success');
                
                // Ricarica display se necessario
                if (window.loadFirebaseData) {
                    window.loadFirebaseData();
                }
            });

            // Notifica periodica per mantenere utente informato
            setInterval(() => {
                if (authCheckComplete && (window.isUserAuthenticated ? window.isUserAuthenticated() : true)) {
                    const now = new Date();
                    if (now.getMinutes() % 15 === 0 && now.getSeconds() < 5) {
                        console.log('‚è∞ Check periodico stato sistema...');
                        
                        if (sessionManagerIntegrated) {
                            showNotification('üîó Sistema Session Manager operativo', 'info');
                        }
                    }
                }
            }, 60000); // Check ogni minuto

            console.log('‚úÖ Notifiche push configurate');
        }

        // Variabili globali per compatibilit√† con il codice esistente
        let chatConversations = [];
        let quizLeads = [];
        let allQuizLeads = [];
        let allChatConversations = [];
        let currentQuizFilter = 'all';
        let currentChatFilter = 'all';
        let currentQuizSearch = '';
        let currentChatSearch = '';
        let selectedQuizLeads = new Set();
        let selectedChats = new Set();

        // üî• CARICA DATI FIREBASE CON GESTIONE ERRORI MIGLIORATA
        async function loadFirebaseData() {
            if (!authCheckComplete) {
                console.log('‚è≥ Auth non completato, aspetto...');
                return;
            }

            try {
                console.log('üîÑ Caricamento dati Firebase per utente:', currentUser.email);
                updateConnectionStatus('üîÑ Caricamento dati...', '#ff9800');

                const db = window.firebaseDB;
                if (!db) {
                    throw new Error('Firebase non inizializzato');
                }
                
                // 1. Carica TUTTE le conversazioni chat
                try {
                    console.log('üî• Caricamento conversazioni chat...');
                    const chatSnapshot = await getDocs(collection(db, 'chatbase_conversations'));
                    
                    allChatConversations = [];
                    chatSnapshot.forEach(function(doc) {
                        const data = doc.data();
                        console.log('üìã Conversazione trovata:', doc.id, data);

                        allChatConversations.push({
                            id: doc.id,
                            ...data,
                            lastUpdate: data.lastUpdate ? data.lastUpdate.toDate() : 
                                       data.lastMessageAt ? data.lastMessageAt.toDate() :
                                       data.startTime ? data.startTime.toDate() : new Date(),
                            startTime: data.startTime ? data.startTime.toDate() : new Date(),
                            endTime: data.endTime ? data.endTime.toDate() : null,
                            fullConversation: (() => {
                                if (data.fullconversation) {
                                    if (typeof data.fullconversation === 'string') {
                                        try {
                                            return JSON.parse(data.fullconversation);
                                        } catch (e) {
                                            console.warn('‚ö†Ô∏è JSON parse failed for fullconversation:', e);
                                        }
                                    } else if (Array.isArray(data.fullconversation)) {
                                        return data.fullconversation;
                                    }
                                }
                                
                                if (data.fullConversation) {
                                    if (typeof data.fullConversation === 'string') {
                                        try {
                                            return JSON.parse(data.fullConversation);
                                        } catch (e) {
                                            console.warn('‚ö†Ô∏è JSON parse failed for fullConversation:', e);
                                        }
                                    } else if (Array.isArray(data.fullConversation)) {
                                        return data.fullConversation;
                                    }
                                }
                                
                                return data.messages || [];
                            })(),
                            messageCount: data.messageCount || (() => {
                                if (data.fullconversation && typeof data.fullconversation === 'string') {
                                    try {
                                        const parsed = JSON.parse(data.fullconversation);
                                        return Array.isArray(parsed) ? parsed.length : 0;
                                    } catch (e) {
                                        return 0;
                                    }
                                } else if (Array.isArray(data.fullconversation)) {
                                    return data.fullconversation.length;
                                } else if (Array.isArray(data.fullConversation)) {
                                    return data.fullConversation.length;
                                }
                                return 0;
                            })(),
                            customerName: data.customerName || 'Anonimo',
                            customerPhone: data.customerPhone || null,
                            customerEmail: data.customerEmail || null,
                            status: data.status || 'unknown'
                        });
                    });
                    
                    allChatConversations.sort((a, b) => b.lastUpdate - a.lastUpdate);
                    console.log('‚úÖ Chat caricate:', allChatConversations.length);
                    updateChatDisplay();
                    
                } catch (chatError) {
                    console.warn('‚ö†Ô∏è Errore caricamento chat:', chatError);
                    allChatConversations = [];
                    chatConversations = [];
                    showNotification('‚ö†Ô∏è Problema caricamento chat', 'error');
                }

                // 2. Carica TUTTI i quiz results
                try {
                    console.log('üî• Caricamento quiz results...');
                    const quizSnapshot = await getDocs(collection(db, 'quiz_results'));
                    
                    allQuizLeads = [];
                    quizSnapshot.forEach(function(doc) {
                        const data = doc.data();
                        console.log('üìã Quiz trovato:', doc.id, data);
                        
                        let timestamp = new Date();
                        if (data.completed_at) {
                            timestamp = new Date(data.completed_at);
                        } else if (data.timestamp) {
                            timestamp = data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestamp);
                        } else if (data.created_at) {
                            timestamp = new Date(data.created_at);
                        } else if (data.date) {
                            timestamp = new Date(data.date);
                        }
                        
                        allQuizLeads.push({
                            id: doc.id,
                            ...data,
                            timestamp: timestamp
                        });
                    });
                    
                    allQuizLeads.sort((a, b) => b.timestamp - a.timestamp);
                    console.log('‚úÖ Quiz caricati:', allQuizLeads.length);
                    updateQuizDisplay();
                    
                } catch (quizError) {
                    console.warn('‚ö†Ô∏è Errore caricamento quiz:', quizError);
                    allQuizLeads = [];
                    quizLeads = [];
                    showNotification('‚ö†Ô∏è Problema caricamento quiz', 'error');
                }

                // 3. Aggiorna dashboard
                updateDashboard();
                updateConnectionStatus('‚úÖ Dati caricati - Dashboard aggiornata', '#4CAF50');
                
                // 4. Salva stato aggiornato nel Session Manager
                const updateData = {
                    lastDataLoad: Date.now(),
                    dataStats: {
                        totalChats: allChatConversations.length,
                        totalQuizzes: allQuizLeads.length,
                        lastUpdate: new Date().toISOString()
                    }
                };

                if (sessionManagerIntegrated && window.updateUserData) {
                    window.updateUserData(updateData);
                    console.log('üìä Statistiche salvate nel Session Manager');
                } else {
                    localStorage.setItem('tribucoach_last_stats', JSON.stringify(updateData));
                    console.log('üìä Statistiche salvate in localStorage');
                }
                
                console.log('‚úÖ Dashboard aggiornata con Session Manager:', {
                    chat: chatConversations.length,
                    quiz: quizLeads.length,
                    totalChat: allChatConversations.length,
                    totalQuiz: allQuizLeads.length,
                    user: currentUser.email,
                    sessionManager: sessionManagerIntegrated
                });

                showNotification('üìä Dati aggiornati con successo!', 'success');

            } catch (error) {
                console.error('‚ùå Errore caricamento Firebase:', error);
                updateConnectionStatus('‚ùå Errore Firebase - Verifica connessione', '#f44336');
                showNotification('‚ùå Errore caricamento dati Firebase', 'error');
            }
        }

        // Resto delle funzioni esistenti (mantenute identiche)
        function updateConnectionStatus(message, color) {
            const statusEl = document.querySelector('.connection-status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.style.background = color;
            }
        }

        function updateDashboard() {
            updateMainMetrics();
            updateBusinessInsights();
            updateQuizLeads();
            updateChatConversations();
            updateAnalytics();
            updateLastUpdateTime();
        }

        function updateMainMetrics() {
            const totalLeads = quizLeads.length;
            let qualifiedLeads = 0;
            let premiumLeads = 0;
            let totalScore = 0;
            
            for (let i = 0; i < quizLeads.length; i++) {
                const score = quizLeads[i].lead_score || 0;
                totalScore += score;
                if (score >= 70) qualifiedLeads++;
                if (score >= 80) premiumLeads++;
            }
            
            const averageScore = totalLeads > 0 ? Math.round(totalScore / totalLeads) : 0;
            const totalChats = chatConversations.length;

            const metrics = [
                { selector: '.metric-card:nth-child(1) p', value: totalLeads },
                { selector: '.metric-card:nth-child(2) p', value: averageScore + '%' },
                { selector: '.metric-card:nth-child(3) p', value: totalChats },
                { selector: '.metric-card:nth-child(4) p', value: premiumLeads }
            ];

            for (let i = 0; i < metrics.length; i++) {
                const el = document.querySelector(metrics[i].selector);
                if (el) el.textContent = metrics[i].value;
            }
            
            console.log('üìä Metriche aggiornate per utente:', currentUser.email);
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('it-IT', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            const timeElement = document.getElementById('lastUpdate');
            if (timeElement) {
                timeElement.textContent = timeString;
            }
        }

        // Setup completo della dashboard
        function setupDashboardFunctionality() {
            setupLogoutFunctionality();
            setupAutoSave();
            setupSessionExtension();
            setupDataNotifications();
            setupAdminAccess();
            
            console.log('‚úÖ Funzionalit√† dashboard configurate');
        }

        // Funzione di caricamento dati placeholder
        async function loadDashboardData() {
            console.log('üìä Loading dashboard data...');
            await loadFirebaseData();
        }

        // üöÄ INIZIALIZZAZIONE PRINCIPALE MIGLIORATA
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Dashboard TribuCoach - Inizializzazione completa con Session Manager...');
            
            try {
                // Inizializza dashboard sicura con Session Manager
                await initSecureDashboard();
                
                // Auto-refresh intelligente ogni 60 secondi
                setInterval(() => {
                    if (authCheckComplete && (window.isUserAuthenticated ? window.isUserAuthenticated() : true)) {
                        console.log('‚è∞ Auto-refresh dati...');
                        loadFirebaseData();
                    }
                }, 60000);
                
                // Aggiorna ora ogni 5 secondi
                setInterval(updateLastUpdateTime, 5000);
                
                console.log('‚úÖ Dashboard TribuCoach completamente inizializzata con Session Manager Integration');
                showNotification('üéâ Dashboard caricata con Session Manager!', 'success');
                
            } catch (error) {
                console.error('‚ùå Errore inizializzazione dashboard:', error);
                showNotification('‚ùå Errore inizializzazione dashboard', 'error');
                
                // Fallback: prova redirect al login dopo 3 secondi
                setTimeout(() => {
                    if (!authCheckComplete) {
                        redirectToLogin('Errore inizializzazione dashboard');
                    }
                }, 3000);
            }
        });

        // Esponi funzioni per compatibilit√† globale
        window.loadFirebaseData = loadFirebaseData;
        window.updateConnectionStatus = updateConnectionStatus;
        window.updateDashboard = updateDashboard;
        window.currentUser = () => currentUser;
        window.sessionData = () => sessionData;
        window.sessionManagerIntegrated = () => sessionManagerIntegrated;

        // Stub functions per compatibilit√† (da implementare se necessario)
        window.updateBusinessInsights = function() { console.log('üìà updateBusinessInsights - stub'); };
        window.updateQuizLeads = function() { console.log('üìã updateQuizLeads - stub'); };
        window.updateChatConversations = function() { console.log('üí¨ updateChatConversations - stub'); };
        window.updateAnalytics = function() { console.log('üìä updateAnalytics - stub'); };
        window.updateQuizDisplay = function() { console.log('üéØ updateQuizDisplay - stub'); };
        window.updateChatDisplay = function() { console.log('üí¨ updateChatDisplay - stub'); };

    </script>

    <!-- CSS completo esistente (mantenuto identico) -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #2a2a2a 100%);
            color: #fff;
            min-height: 100vh;
            line-height: 1.4;
        }

        .connection-status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 0.8rem;
            z-index: 1000;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            transition: all 0.3s ease;
        }

        .header {
            background: linear-gradient(135deg, rgba(255,102,0,0.15), rgba(255,102,0,0.05));
            padding: 25px;
            border-bottom: 3px solid #ff6600;
            backdrop-filter: blur(20px);
            margin-top: 40px;
            position: relative;
            z-index: 1;
        }

        .header h1 {
            color: #ff6600;
            font-size: 2.2rem;
            margin-bottom: 8px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(255,102,0,0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header h1:hover {
            color: #ff8533;
            text-shadow: 0 4px 8px rgba(255,102,0,0.5);
        }

        .header p {
            color: #ccc;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .header .header-controls {
            position: absolute;
            top: 25px;
            right: 25px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-info {
            background: rgba(255, 102, 0, 0.1);
            border: 1px solid rgba(255, 102, 0, 0.3);
            border-radius: 25px;
            padding: 8px 16px;
            font-size: 0.85rem;
            color: #ff9933;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header .refresh-button, .header .logout-button {
            background: linear-gradient(135deg, #ff6600, #ff8533);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 102, 0, 0.3);
        }

        .header .logout-button {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        .header .refresh-button:hover {
            background: linear-gradient(135deg, #ff8533, #ffaa66);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 102, 0, 0.4);
        }

        .header .logout-button:hover {
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
        }

        /* Toast notifications migliorato */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 12px;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            max-width: 350px;
            animation: slideInRight 0.3s ease-out;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .toast.success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .toast.error {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .toast.info {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Responsive per header controls */
        @media (max-width: 768px) {
            .header .header-controls {
                position: static;
                margin-top: 15px;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .user-info {
                order: -1;
                width: 100%;
                justify-content: center;
                margin-bottom: 10px;
            }
        }

        /* Loading states */
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }

        .loading::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin-top: -10px;
            margin-left: -10px;
            border: 2px solid #ff6600;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Stili aggiuntivi per una migliore UX */
        .metric-card {
            background: linear-gradient(135deg, rgba(255,102,0,0.1), rgba(255,102,0,0.05));
            border: 1px solid rgba(255,102,0,0.2);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255,102,0,0.2);
        }

        .metric-card h3 {
            color: #ff6600;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .metric-card p {
            color: #fff;
            font-size: 2rem;
            font-weight: bold;
        }

        .metrics-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
            margin: 20px 0;
        }

        .dashboard-content {
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="connection-status">üîÑ Inizializzazione Dashboard Sicura con Session Manager...</div>

    <header class="header">
        <h1>üìà TribuCoach Business Intelligence</h1>
        <p>Dashboard in tempo reale - Sistema unificato con Session Manager</p>
        
        <div class="header-controls">
            <div class="user-info">
                <span>üë§</span>
                <span data-user-name>Caricamento...</span>
                <span style="opacity: 0.7;">|</span>
                <span data-user-email style="font-size: 0.8rem;">email...</span>
            </div>
            <button class="refresh-button" onclick="loadFirebaseData()">üîÑ Aggiorna Dati</button>
            <button id="logoutBtn" class="logout-button">üö™ Logout</button>
        </div>
    </header>

    <!-- Dashboard content placeholder - da completare con la struttura esistente -->
    <main class="dashboard-content">
        <!-- Metrics Cards -->
        <section class="metrics-section">
            <div class="metric-card">
                <h3>üìä Total Leads</h3>
                <p>0</p>
            </div>
            <div class="metric-card">
                <h3>‚≠ê Avg Score</h3>
                <p>0%</p>
            </div>
            <div class="metric-card">
                <h3>üí¨ Total Chats</h3>
                <p>0</p>
            </div>
            <div class="metric-card">
                <h3>üèÜ Premium Leads</h3>
                <p>0</p>
            </div>
        </section>

        <!-- Time display -->
        <div style="text-align: center; margin: 20px 0; color: #ccc;">
            Ultimo aggiornamento: <span id="lastUpdate">--:--:--</span>
        </div>
    </main>

    <!-- Funzioni JavaScript helper migliorate -->
    <script>
        // Sistema di notifiche toast migliorato
        function showNotification(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                info: 'üì¢'
            };
            
            toast.innerHTML = `${icons[type] || 'üì¢'} ${message}`;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }
            }, 4000);
        }

        // Funzioni globali per compatibilit√† (migliorate)
        function openWhatsApp(phone) {
            if (!phone || phone === 'N/A') {
                showNotification('Numero di telefono non disponibile', 'error');
                return;
            }
            
            let cleanPhone = phone.replace(/[^\d+]/g, '');
            if (!cleanPhone.startsWith('+')) {
                cleanPhone = '+39' + cleanPhone.replace(/^0+/, '');
            }
            
            const whatsappUrl = 'https://wa.me/' + cleanPhone.replace('+', '');
            window.open(whatsappUrl, '_blank');
            showNotification('Apertura WhatsApp...', 'success');
        }

        function closeModal() {
            const modal = document.getElementById('detailsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Event listeners per modal migliorati
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('detailsModal');
            if (e.target === modal) {
                closeModal();
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Gestione refresh e back button migliorata
        window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
                console.log('üîÑ Pagina ripristinata da cache, ricarico...');
                window.location.reload();
            }
        });

        // Protection contro accesso diretto senza autenticazione migliorata
        if (!document.referrer.includes('login.html') && !window.sessionStorage.getItem('auth_bypass')) {
            setTimeout(() => {
                if (!window.isUserAuthenticated || !window.isUserAuthenticated()) {
                    console.log('‚ö†Ô∏è Accesso diretto senza auth, redirect...');
                    
                    if (window.sessionManagerIntegrated && window.sessionManagerIntegrated()) {
                        // Se session manager √® integrato, controlla da l√¨
                        if (!window.getCurrentUser()) {
                            window.location.href = 'login.html?error=Accesso non autorizzato';
                        }
                    } else {
                        // Fallback per controllo tradizionale
                        const savedUser = localStorage.getItem('tribucoach_user');
                        if (!savedUser) {
                            window.location.href = 'login.html?error=Accesso non autorizzato';
                        }
                    }
                }
            }, 3000);
        }

        console.log('üéØ Dashboard HTML caricato - Avvio integrazione Session Manager...');
    </script>
</body>
</html>