<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settimana 4 - Piano di Azione | Andrea Padoan Coach</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #fff7ed 50%, #f0fdf4 100%);
            min-height: 100vh;
            color: #1e293b;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .session-info {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .timer-display {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-bar {
            background: rgba(255,255,255,0.2);
            width: 200px;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            background: #f59e0b;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .back-button {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            color: white;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Welcome Section */
        .welcome-section {
            background: white;
            border-radius: 16px;
            padding: 3rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            text-align: center;
        }

        .welcome-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 1rem;
        }

        .welcome-subtitle {
            font-size: 1.3rem;
            color: #ea580c;
            margin-bottom: 2rem;
        }

        .welcome-description {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #475569;
            margin-bottom: 2rem;
        }

        .coach-intro {
            background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%);
            border-radius: 12px;
            padding: 2rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            max-width: 600px;
            margin: 0 auto 2rem;
        }

        .coach-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
        }

        .coach-message {
            flex: 1;
            text-align: left;
        }

        .coach-message h3 {
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .coach-message p {
            color: #f59e0b;
            font-size: 1rem;
            line-height: 1.5;
        }

        /* Action Framework */
        .action-framework {
            background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .framework-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .framework-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
        }

        .framework-quadrant {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .quadrant-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 1rem;
            text-align: center;
        }

        .quadrant-description {
            font-size: 0.9rem;
            color: #64748b;
            line-height: 1.4;
            text-align: center;
        }

        .quadrant-icon {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        /* Session Container */
        .session-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .session-panel {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f1f5f9;
        }

        .panel-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .panel-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .panel-subtitle {
            font-size: 1rem;
            color: #64748b;
        }

        /* Chat Panel */
        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 1rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
        }

        .message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 12px;
            max-width: 85%;
            animation: messageSlide 0.3s ease-out;
        }

        .message.coach {
            background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%);
            margin-right: auto;
        }

        .message.user {
            background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%);
            margin-left: auto;
            text-align: right;
        }

        .message-content {
            font-size: 1rem;
            line-height: 1.5;
            margin-bottom: 0.5rem;
        }

        .message-time {
            font-size: 0.8rem;
            color: #64748b;
        }

        .chat-input {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .chat-input input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .chat-input input:focus {
            outline: none;
            border-color: #f59e0b;
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: #f59e0b;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Form Panel */
        .form-section {
            margin-bottom: 2rem;
        }

        .form-section h3 {
            color: #1e293b;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #f59e0b;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-progress {
            background: #f1f5f9;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .form-progress-text {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .form-progress-bar {
            background: #e2e8f0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .form-progress-fill {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .btn-secondary {
            background: white;
            color: #1e293b;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            border-color: #f59e0b;
            color: #f59e0b;
        }

        .btn-success {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
        }

        /* Completion Section */
        .completion-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-top: 2rem;
            display: none;
        }

        .completion-section.active {
            display: block;
        }

        .completion-title {
            font-size: 2rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 1rem;
            text-align: center;
        }

        .completion-message {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #475569;
            margin-bottom: 2rem;
            text-align: center;
        }

        .homework-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .homework-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #f59e0b;
            margin-bottom: 1rem;
        }

        .homework-list {
            list-style: none;
            padding: 0;
        }

        .homework-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(245, 158, 11, 0.2);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .homework-list li:last-child {
            border-bottom: none;
        }

        .completion-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* Animations */
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .session-container {
                grid-template-columns: 1fr;
            }
            
            .framework-grid {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .welcome-section {
                padding: 2rem;
            }
            
            .coach-intro {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">📋 Settimana 4 - Piano di Azione</div>
            <div class="session-info">
                <div class="timer-display">
                    ⏱️ <span id="sessionTimer">40:00</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="sessionProgress"></div>
                </div>
                <a href="module-hub.html" class="back-button">← Torna ai Moduli</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Welcome Section -->
        <section class="welcome-section fade-in">
            <h1 class="welcome-title">Benvenuto nella Settimana 4! 📋</h1>
            <p class="welcome-subtitle">Piano di Azione - Dalla Teoria alla Pratica</p>
            <p class="welcome-description">
                È il momento di passare all'azione! Dopo aver definito i tuoi obiettivi SMART, ora creeremo un piano di azione 
                dettagliato e concreto. Identificheremo le risorse necessarie, i potenziali ostacoli e le strategie per superarli. 
                Questa settimana trasformeremo i tuoi obiettivi in un piano esecutivo step-by-step.
            </p>
            
            <div class="coach-intro">
                <div class="coach-avatar">📋</div>
                <div class="coach-message">
                    <h3>Dall'Idea all'Azione</h3>
                    <p>Un obiettivo senza un piano è solo un desiderio. Oggi costruiremo insieme la tua roadmap personalizzata 
                    per trasformare i tuoi sogni in realtà concrete. Ogni passo sarà chiaro e actionable!</p>
                </div>
            </div>
        </section>

        <!-- Action Framework -->
        <section class="action-framework fade-in">
            <h2 class="framework-title">🎯 Framework dell'Azione</h2>
            <div class="framework-grid">
                <div class="framework-quadrant">
                    <div class="quadrant-icon">🚀</div>
                    <h3 class="quadrant-title">INIZIARE A FARE</h3>
                    <p class="quadrant-description">
                        Nuove azioni e comportamenti che devi iniziare per raggiungere i tuoi obiettivi
                    </p>
                </div>
                <div class="framework-quadrant">
                    <div class="quadrant-icon">📦</div>
                    <h3 class="quadrant-title">RISORSE</h3>
                    <p class="quadrant-description">
                        Tutto ciò di cui hai bisogno: tempo, denaro, competenze, strumenti, supporto
                    </p>
                </div>
                <div class="framework-quadrant">
                    <div class="quadrant-icon">✅</div>
                    <h3 class="quadrant-title">CONTINUARE A FARE</h3>
                    <p class="quadrant-description">
                        Comportamenti positivi che già metti in pratica e che devi mantenere
                    </p>
                </div>
                <div class="framework-quadrant">
                    <div class="quadrant-icon">🛑</div>
                    <h3 class="quadrant-title">SMETTERE DI FARE</h3>
                    <p class="quadrant-description">
                        Abitudini disfunzionali che ti ostacolano e che devi eliminare
                    </p>
                </div>
            </div>
        </section>

        <!-- Session Container -->
        <div class="session-container">
            <!-- Chat Panel -->
            <div class="session-panel">
                <div class="panel-header">
                    <div class="panel-icon">💬</div>
                    <div>
                        <h2 class="panel-title">Coaching Piano d'Azione</h2>
                        <p class="panel-subtitle">Costruiamo insieme la tua strategia</p>
                    </div>
                </div>
                
                <div class="chat-status">
                    <div class="status-dot"></div>
                    <span>Andrea ti guida nella creazione del piano d'azione</span>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="message coach">
                        <div class="message-content">
                            Eccoci alla settimana più operativa! Ora che hai obiettivi chiari, dobbiamo creare un piano d'azione concreto. 
                            Iniziamo dalle basi: quali sono le prime 3 azioni che devi assolutamente iniziare a fare per avvicinarti ai tuoi obiettivi? 
                            Pensa a cose specifiche e actionable! 💪
                        </div>
                        <div class="message-time">Proprio ora</div>
                    </div>
                </div>
                
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="Condividi le tue prime azioni concrete...">
                    <button class="btn btn-primary" onclick="sendMessage()">Invia</button>
                </div>
            </div>

            <!-- Form Panel -->
            <div class="session-panel">
                <div class="panel-header">
                    <div class="panel-icon">📋</div>
                    <div>
                        <h2 class="panel-title">Pianificazione Strategica</h2>
                        <p class="panel-subtitle">Crea il tuo piano d'azione dettagliato</p>
                    </div>
                </div>
                
                <div class="form-progress">
                    <div class="form-progress-text">Progresso pianificazione: <span id="formProgressText">0%</span></div>
                    <div class="form-progress-bar">
                        <div class="form-progress-fill" id="formProgressFill" style="width: 0%"></div>
                    </div>
                </div>
                
                <form id="actionPlanForm">
                    <!-- Sezione 1: Analisi Situazione -->
                    <div class="form-section" id="section1">
                        <h3>🔍 Analisi Situazione Attuale</h3>
                        <div class="form-group">
                            <label for="currentSituation">Descrivi la tua situazione attuale rispetto ai tuoi obiettivi:</label>
                            <textarea id="currentSituation" placeholder="Dove ti trovi ora? Cosa hai già fatto? Cosa manca?" onchange="updateProgress()"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="pastSuccesses">Riprendi le più importanti esperienze di successo della tua vita:</label>
                            <textarea id="pastSuccesses" placeholder="Elenca i tuoi successi passati e le capacità che li hanno favoriti..." onchange="updateProgress()"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="currentCapabilities">Quali capacità puoi mettere in campo oggi?</label>
                            <textarea id="currentCapabilities" placeholder="Competenze, risorse, esperienze che hai già..." onchange="updateProgress()"></textarea>
                        </div>
                    </div>

                    <!-- Sezione 2: Risorse e Alleati -->
                    <div class="form-section" id="section2" style="display: none;">
                        <h3>📦 Risorse e Alleati</h3>
                        <div class="form-group">
                            <label for="resources">Quali risorse hai a disposizione?</label>
                            <textarea id="resources" placeholder="Tempo, denaro, strumenti, competenze, persone..." onchange="updateProgress()"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="allies">Chi potrebbero essere i tuoi migliori alleati?</label>
                            <textarea id="allies" placeholder="Persone che possono supportarti nel raggiungere i tuoi obiettivi..." onchange="updateProgress()"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="supportNeeded">Come ti potrebbero aiutare?</label>
                            <textarea id="supportNeeded" placeholder="Che tipo di supporto ti serve da ciascuno di loro?" onchange="updateProgress()"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="askHelp">Come puoi chiedere il loro aiuto?</label>
                            <textarea id="askHelp" placeholder="Strategia per coinvolgere i tuoi alleati..." onchange="updateProgress()"></textarea>
                        </div>
                    </div>

                    <!-- Sezione 3: Piano d'Azione -->
                    <div class="form-section" id="section3" style="display: none;">
                        <h3>🚀 Piano d'Azione</h3>
                        <div class="form-group">
                            <label for="startDoing">Cosa devi iniziare a fare?</label>
                            <textarea id="startDoing" placeholder="Nuove azioni e comportamenti da iniziare..." onchange="updateProgress()"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="continueDoing">Cosa devi continuare a fare?</label>
                            <textarea id="continueDoing" placeholder="Comportamenti positivi che già metti in pratica..." onchange="updateProgress()"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="stopDoing">Cosa devi smettere di fare?</label>
                            <textarea id="stopDoing" placeholder="Abitudini disfunzionali che ti ostacolano..." onchange="updateProgress()"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="priorities">Organizza le azioni dando un numero di priorità:</label>
                            <textarea id="priorities" placeholder="1. Azione più importante... 2. Seconda priorità..." onchange="updateProgress()"></textarea>
                        </div>
                    </div>

                    <!-- Sezione 4: Implementazione -->
                    <div class="form-section" id="section4" style="display: none;">
                        <h3>⚡ Implementazione</h3>
                        <div class="form-group">
                            <label for="nextAction">Qual è la prima azione che farai immediatamente?</label>
                            <textarea id="nextAction" placeholder="La prima cosa che farai appena finisci questa sessione..." onchange="updateProgress()"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="weeklyActions">Cosa farai questa settimana?</label>
                            <textarea id="weeklyActions" placeholder="Azioni concrete per i prossimi 7 giorni..." onchange="updateProgress()"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="monthlyActions">Cosa farai nel prossimo mese?</label>
                            <textarea id="monthlyActions" placeholder="Obiettivi e azioni per i prossimi 30 giorni..." onchange="updateProgress()"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="obstacles">Quali ostacoli potresti incontrare e come superarli?</label>
                            <textarea id="obstacles" placeholder="Identifica ostacoli e strategie per superarli..." onchange="updateProgress()"></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <button type="button" class="btn btn-secondary" id="prevBtn" onclick="prevSection()" style="display: none;">← Precedente</button>
                        <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextSection()">Continua →</button>
                        <button type="button" class="btn btn-success" id="completeBtn" onclick="completeSession()" style="display: none;">✅ Completa Sessione</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Completion Section -->
        <section class="completion-section" id="completionSection">
            <h2 class="completion-title">🎉 Settimana 4 Completata!</h2>
            <p class="completion-message">
                Eccellente! Hai creato un piano d'azione dettagliato e concreto. Ora hai una roadmap chiara per trasformare 
                i tuoi obiettivi in realtà. Questa settimana è cruciale: inizia subito a mettere in pratica le prime azioni 
                che hai definito. L'azione è la chiave del successo!
            </p>
            
            <div class="homework-section">
                <h3 class="homework-title">📚 I Tuoi Compiti per Questa Settimana</h3>
                <ul class="homework-list">
                    <li>✅ Esegui la prima azione che hai definito OGGI</li>
                    <li>✅ Contatta e coinvolgi i tuoi alleati</li>
                    <li>✅ Organizza le risorse necessarie</li>
                    <li>✅ Elimina una cattiva abitudine che ti ostacola</li>
                    <li>✅ Monitora quotidianamente i tuoi progressi</li>
                </ul>
                <p style="margin-top: 1rem; font-style: italic; color: #64748b;">
                    💡 La settimana 5 si sbloccherà automaticamente tra 7 giorni. 
                    Usa questo tempo per iniziare concretamente a implementare il tuo piano!
                </p>
            </div>
            
            <div class="completion-actions">
                <button class="btn btn-success" onclick="downloadHomework()">📄 Scarica Compiti PDF</button>
                <a href="module-hub.html" class="btn btn-secondary">← Torna ai Moduli</a>
                <button class="btn btn-primary" onclick="scheduleNextSession()">📅 Programma Settimana 5</button>
            </div>
        </section>
    </main>

    <script>
        // Session variables
        let currentSection = 1;
        let totalSections = 4;
        let sessionStartTime = Date.now();
        let sessionDuration = 40 * 60 * 1000; // 40 minutes in milliseconds
        let timerInterval;
        let chatResponses = [];
        let formData = {};

        // Initialize session
        document.addEventListener('DOMContentLoaded', function() {
            startSessionTimer();
            loadUserData();
            initializeCoaching();
        });

        function startSessionTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - sessionStartTime;
                const remaining = Math.max(0, sessionDuration - elapsed);
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                
                document.getElementById('sessionTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const progress = (elapsed / sessionDuration) * 100;
                document.getElementById('sessionProgress').style.width = `${Math.min(progress, 100)}%`;
                
                if (remaining === 0) {
                    clearInterval(timerInterval);
                    showTimeUpMessage();
                }
            }, 1000);
        }

        function loadUserData() {
            try {
                const savedData = localStorage.getItem('lifestyleQuizResults');
                if (savedData) {
                    const userData = JSON.parse(savedData);
                    console.log('User data loaded:', userData);
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        function initializeCoaching() {
            if (typeof window.claude !== 'undefined' && window.claude.complete) {
                console.log('Claude AI coaching system available');
            } else {
                console.log('Using fallback coaching responses');
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessage(message, 'user');
            input.value = '';
            
            try {
                const response = await getCoachingResponse(message);
                setTimeout(() => {
                    addMessage(response, 'coach');
                }, 1000);
            } catch (error) {
                console.error('Error getting coaching response:', error);
                setTimeout(() => {
                    addMessage("Scusa, ho avuto un problema. Riprova!", 'coach');
                }, 1000);
            }
        }

        function addMessage(content, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const now = new Date();
            const time = now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-content">${content}</div>
                <div class="message-time">${time}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            chatResponses.push({ sender, content, time });
        }

        async function getCoachingResponse(userMessage) {
            if (typeof window.claude !== 'undefined' && window.claude.complete) {
                try {
                    const prompt = `
                    Sei Andrea Padoan, un life coach esperto che sta conducendo la quarta sessione "Piano di Azione".
                    
                    Contesto: È la settimana 4 di un percorso di 7 settimane. L'obiettivo è aiutare l'utente a creare 
                    un piano d'azione concreto e dettagliato per raggiungere i suoi obiettivi SMART.
                    
                    Utente dice: "${userMessage}"
                    
                    Rispondi come Andrea con:
                    - Focus sulla creazione di azioni concrete e specifiche
                    - Domande che aiutano a identificare risorse e alleati
                    - Guida verso la definizione di priorità e timeline
                    - Supporto per identificare e superare gli ostacoli
                    - Massimo 2-3 frasi
                    
                    Rispondi SOLO con la risposta di Andrea, senza prefissi.
                    `;
                    
                    const response = await window.claude.complete(prompt);
                    return response.trim();
                } catch (error) {
                    console.error('Claude AI error:', error);
                }
            }
            
            return getPersonalizedFallbackResponse(userMessage);
        }

        function getPersonalizedFallbackResponse(message) {
            const responses = [
                "Perfetto! Ora rendiamo queste azioni ancora più concrete. Quando esattamente le metterai in pratica?",
                "Ottimo piano! Vedo che hai le idee chiare. Quali risorse ti servono per iniziare subito?",
                "Interessante approccio! Ora identifichiamo chi potrebbe supportarti in queste azioni. Chi sono i tuoi alleati?",
                "Fantastico! Sento che sei pronto all'azione. Qual è la prima cosa che farai appena finisci questa sessione?",
                "Eccellente! Ora dobbiamo prevedere gli ostacoli. Cosa potrebbe fermarti e come lo supererai?"
            ];
            
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('azione') || lowerMessage.includes('fare') || lowerMessage.includes('iniziare')) {
                return "Perfetto! Azioni concrete sono la chiave del successo. Ora dimmi: quando esattamente inizierai? E cosa ti serve per partire subito?";
            }
            
            if (lowerMessage.includes('ostacolo') || lowerMessage.includes('difficoltà') || lowerMessage.includes('problema')) {
                return "Bene che pensi agli ostacoli in anticipo! Nella mia esperienza, chi prevede i problemi li supera più facilmente. Quali strategie hai per affrontarli?";
            }
            
            if (lowerMessage.includes('risorsa') || lowerMessage.includes('soldi') || lowerMessage.includes('tempo')) {
                return "Le risorse sono fondamentali! Ho imparato che spesso abbiamo più risorse di quelle che pensiamo. Quali hai già e quali potresti procurarti?";
            }
            
            if (lowerMessage.includes('aiuto') || lowerMessage.includes('supporto') || lowerMessage.includes('alleati')) {
                return "Gli alleati sono oro puro! Nessuno ce la fa da solo. Chi nella tua vita potrebbe essere interessato a supportarti in questo percorso?";
            }
            
            if (lowerMessage.includes('priorità') || lowerMessage.includes('importante') || lowerMessage.includes('primo')) {
                return "Le priorità sono tutto! Quando ho iniziato a focalizzarmi su ciò che conta davvero, i risultati sono arrivati. Qual è la tua azione numero 1?";
            }
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function updateProgress() {
            const sections = document.querySelectorAll('.form-section');
            const currentSectionEl = sections[currentSection - 1];
            const inputs = currentSectionEl.querySelectorAll('input, textarea, select');
            
            let filled = 0;
            inputs.forEach(input => {
                if (input.value.trim()) filled++;
            });
            
            const sectionProgress = (filled / inputs.length) * 100;
            const totalProgress = ((currentSection - 1) * 100 + sectionProgress) / totalSections;
            
            document.getElementById('formProgressText').textContent = `${Math.round(totalProgress)}%`;
            document.getElementById('formProgressFill').style.width = `${totalProgress}%`;
        }

        function nextSection() {
            if (currentSection < totalSections) {
                document.getElementById(`section${currentSection}`).style.display = 'none';
                currentSection++;
                document.getElementById(`section${currentSection}`).style.display = 'block';
                
                document.getElementById('prevBtn').style.display = 'inline-flex';
                
                if (currentSection === totalSections) {
                    document.getElementById('nextBtn').style.display = 'none';
                    document.getElementById('completeBtn').style.display = 'inline-flex';
                }
                
                updateProgress();
            }
        }

        function prevSection() {
            if (currentSection > 1) {
                document.getElementById(`section${currentSection}`).style.display = 'none';
                currentSection--;
                document.getElementById(`section${currentSection}`).style.display = 'block';
                
                if (currentSection === 1) {
                    document.getElementById('prevBtn').style.display = 'none';
                }
                
                document.getElementById('nextBtn').style.display = 'inline-flex';
                document.getElementById('completeBtn').style.display = 'none';
                
                updateProgress();
            }
        }

        function completeSession() {
            // Collect all form data
            const formElements = document.querySelectorAll('#actionPlanForm input, #actionPlanForm textarea, #actionPlanForm select');
            formElements.forEach(element => {
                formData[element.id] = element.value;
            });
            
            // Save session data
            const sessionData = {
                formData,
                chatResponses,
                completedAt: new Date().toISOString(),
                sessionDuration: Date.now() - sessionStartTime
            };
            
            localStorage.setItem('week4SessionData', JSON.stringify(sessionData));
            
            // Update user progress
            updateUserProgress();
            
            // Show completion section
            document.querySelector('.session-container').style.display = 'none';
            document.getElementById('completionSection').classList.add('active');
            
            // Stop timer
            clearInterval(timerInterval);
            
            // Scroll to completion
            document.getElementById('completionSection').scrollIntoView({ behavior: 'smooth' });
        }

        function updateUserProgress() {
            try {
                const progress = JSON.parse(localStorage.getItem('lifestyleProgress') || '{}');
                progress.completedWeeks = progress.completedWeeks || [];
                
                if (!progress.completedWeeks.includes(4)) {
                    progress.completedWeeks.push(4);
                    progress.currentWeek = 5;
                    progress.lastUpdate = new Date().toISOString();
                    
                    localStorage.setItem('lifestyleProgress', JSON.stringify(progress));
                }
            } catch (error) {
                console.error('Error updating progress:', error);
            }
        }

        function downloadHomework() {
            const homeworkContent = `
                COMPITI SETTIMANA 4 - PIANO DI AZIONE
                
                Andrea Padoan - Lifestyle Coach
                
                Ciao! Ecco i tuoi compiti per mettere in pratica il tuo piano d'azione:
                
                1. PRIMA AZIONE IMMEDIATA (OGGI)
                   - Esegui la prima azione che hai definito OGGI
                   - Non rimandare: l'azione genera altra azione
                   - Segna sul calendario quando l'hai completata
                
                2. COINVOLGIMENTO ALLEATI (entro 3 giorni)
                   - Contatta i tuoi alleati identificati
                   - Condividi i tuoi obiettivi e chiedi supporto
                   - Organizza incontri o call per definire come aiutarti
                
                3. ORGANIZZAZIONE RISORSE (questa settimana)
                   - Fai un inventario delle risorse che hai
                   - Identifica quelle che ti mancano
                   - Crea un piano per procurarti ciò che serve
                
                4. ELIMINAZIONE OSTACOLI (processo continuo)
                   - Elimina una cattiva abitudine che ti ostacola
                   - Sostituiscila con un comportamento positivo
                   - Monitora i tuoi progressi quotidianamente
                
                5. MONITORAGGIO PROGRESSI (ogni giorno)
                   - Tieni un diario delle azioni completate
                   - Nota cosa funziona e cosa no
                   - Aggiusta il piano se necessario
                
                RICORDA: La settimana 5 si attiverà automaticamente tra 7 giorni.
                Usa questo tempo per implementare concretamente il tuo piano!
                
                All'azione!
                Andrea 📋
            `;
            
            const blob = new Blob([homeworkContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Compiti_Settimana_4_Piano_Azione_Andrea_Padoan.txt';
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage('📄 Compiti scaricati! È ora di passare all\'azione.', 'success');
        }

        function scheduleNextSession() {
            const nextWeekDate = new Date();
            nextWeekDate.setDate(nextWeekDate.getDate() + 7);
            
            const message = `📅 La tua prossima sessione (Settimana 5 - Trasformazione Abitudini) sarà disponibile il ${nextWeekDate.toLocaleDateString('it-IT')}. Continua a lavorare sul tuo piano!`;
            
            showMessage(message, 'info');
        }

        function showTimeUpMessage() {
            showMessage('⏰ Tempo scaduto! Puoi comunque completare la creazione del piano.', 'warning');
        }

        function showMessage(message, type = 'info') {
            const colors = {
                success: '#16a34a',
                warning: '#f59e0b',
                info: '#3b82f6',
                error: '#ef4444'
            };
            
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: ${colors[type]}; color: white; padding: 1rem 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; max-width: 400px;">
                    ${message}
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Handle Enter key in chat
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>