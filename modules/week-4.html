<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settimana 4 - Piano di Azione | Andrea Padoan Coach</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #fff7ed 50%, #f0fdf4 100%);
            min-height: 100vh;
            color: #1e293b;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .session-info {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .timer-display {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-bar {
            background: rgba(255,255,255,0.2);
            width: 200px;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            background: #22c55e;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .back-button {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            color: white;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Phase Indicator */
        .phase-indicator {
            background: white;
            border-radius: 12px;
            padding: 1rem 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .phase-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            min-width: 280px;
        }

        .phase-step.active {
            background: linear-gradient(135deg, #ea580c 0%, #fb923c 100%);
            color: white;
        }

        .phase-step.completed {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: white;
        }

        .phase-step.inactive {
            background: #f1f5f9;
            color: #94a3b8;
        }

        .phase-arrow {
            font-size: 1.5rem;
            color: #64748b;
        }

        /* Welcome Section */
        .welcome-section {
            background: white;
            border-radius: 16px;
            padding: 3rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            text-align: center;
        }

        .welcome-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 1rem;
        }

        .welcome-subtitle {
            font-size: 1.3rem;
            color: #ea580c;
            margin-bottom: 2rem;
        }

        .journey-recap {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: left;
        }

        .recap-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #16a34a;
            margin-bottom: 1rem;
            text-align: center;
        }

        .smart-goal-preview {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: left;
        }

        .preview-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ea580c;
            margin-bottom: 1rem;
            text-align: center;
        }

        .action-explanation {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: left;
        }

        .action-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #3b82f6;
            margin-bottom: 1rem;
            text-align: center;
        }

        .process-steps {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .process-step {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #ea580c;
        }

        .step-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ea580c;
            margin-bottom: 0.5rem;
        }

        .step-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .step-description {
            font-size: 0.9rem;
            color: #64748b;
            line-height: 1.5;
        }

        .step-duration {
            font-size: 0.8rem;
            color: #ea580c;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        /* Phase 1 - Sistema di Azione */
        .phase1-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: none;
        }

        .phase1-section.active {
            display: block;
        }

        .phase-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f1f5f9;
        }

        .phase-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .phase-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .phase-subtitle {
            font-size: 1rem;
            color: #64748b;
        }

        .workshop-progress {
            background: #f1f5f9;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .workshop-progress-text {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .workshop-progress-bar {
            background: #e2e8f0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .workshop-progress-fill {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .system-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 12px;
            border-left: 4px solid #ea580c;
        }

        .system-section h3 {
            color: #1e293b;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .system-intro {
            background: #fff7ed;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-style: italic;
            color: #ea580c;
        }

        .habit-framework {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .habit-component {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            text-align: center;
            transition: all 0.3s ease;
        }

        .habit-component:hover {
            border-color: #ea580c;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(234, 88, 12, 0.2);
        }

        .habit-component-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .habit-component-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1rem;
        }

        .habit-component-description {
            color: #64748b;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .exercise-group {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .exercise-title {
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1e293b;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #ea580c;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .timeline-builder {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            margin: 2rem 0;
            border: 2px solid #e2e8f0;
        }

        .timeline-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .timeline-weeks {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .week-card {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }

        .week-card.completed {
            background: #f0fdf4;
            border-color: #16a34a;
        }

        .week-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .week-number {
            font-weight: bold;
            color: #ea580c;
        }

        .week-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 0.9rem;
            min-height: 80px;
        }

        .obstacle-matrix {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin: 2rem 0;
        }

        .obstacle-section {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }

        .obstacle-section.obstacles {
            border-left-color: #ef4444;
        }

        .obstacle-section.solutions {
            border-left-color: #16a34a;
        }

        .obstacle-list {
            list-style: none;
            padding: 0;
        }

        .obstacle-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: #f8fafc;
            border-radius: 4px;
        }

        .add-obstacle-btn {
            background: #f1f5f9;
            border: 2px dashed #94a3b8;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            color: #64748b;
            transition: all 0.3s ease;
        }

        .add-obstacle-btn:hover {
            border-color: #ea580c;
            color: #ea580c;
        }

        /* Phase 2 - Coaching Avanzato */
        .phase2-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: none;
        }

        .phase2-section.active {
            display: block;
        }

        .coaching-context {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .coaching-context h3 {
            color: #16a34a;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .coaching-context p {
            color: #15803d;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .insights-summary {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #16a34a;
        }

        .insights-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .insights-list {
            list-style: none;
            padding: 0;
        }

        .insights-list li {
            padding: 0.25rem 0;
            color: #64748b;
            font-size: 0.9rem;
        }

        .action-plan-preview {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .plan-preview-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ea580c;
            margin-bottom: 1rem;
            text-align: center;
        }

        .plan-elements {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .plan-element {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .element-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .element-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .element-value {
            color: #ea580c;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .chat-container {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 12px;
            max-width: 85%;
            animation: messageSlide 0.3s ease-out;
        }

        .message.coach {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            margin-right: auto;
        }

        .message.user {
            background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%);
            margin-left: auto;
            text-align: right;
        }

        .message-content {
            font-size: 1rem;
            line-height: 1.5;
            margin-bottom: 0.5rem;
        }

        .message-time {
            font-size: 0.8rem;
            color: #64748b;
        }

        .chat-input {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .chat-input input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .chat-input input:focus {
            outline: none;
            border-color: #ea580c;
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #16a34a;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .btn-secondary {
            background: white;
            color: #1e293b;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            border-color: #ea580c;
            color: #ea580c;
        }

        .btn-success {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
        }

        .btn-disabled {
            background: #94a3b8;
            color: white;
            cursor: not-allowed;
        }

        /* Navigation Buttons */
        .form-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        /* Time Warning */
        .time-warning {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }

        .time-warning.active {
            display: block;
        }

        /* Completion Section */
        .completion-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-top: 2rem;
            display: none;
        }

        .completion-section.active {
            display: block;
        }

        .completion-title {
            font-size: 2rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 1rem;
            text-align: center;
        }

        .completion-message {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #475569;
            margin-bottom: 2rem;
            text-align: center;
        }

        .final-plan-section {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .final-plan-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #16a34a;
            margin-bottom: 1rem;
        }

        .plan-summary {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .habit-loop-visual {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .loop-step {
            background: white;
            padding: 1rem;
            border-radius: 50%;
            border: 3px solid #ea580c;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 600;
            color: #ea580c;
        }

        .loop-arrow {
            font-size: 1.5rem;
            color: #ea580c;
        }

        .completion-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* Animations */
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }
            
            .process-steps {
                grid-template-columns: 1fr;
            }
            
            .phase-indicator {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .phase-step {
                min-width: auto;
                width: 100%;
                justify-content: center;
            }
            
            .phase-arrow {
                transform: rotate(90deg);
            }
            
            .habit-framework {
                grid-template-columns: 1fr;
            }
            
            .timeline-weeks {
                grid-template-columns: 1fr;
            }
            
            .obstacle-matrix {
                grid-template-columns: 1fr;
            }
            
            .plan-elements {
                grid-template-columns: 1fr;
            }
            
            .habit-loop-visual {
                flex-direction: column;
            }
            
            .loop-arrow {
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">üöÄ Settimana 4 - Piano di Azione</div>
            <div class="session-info">
                <div class="timer-display">
                    ‚è±Ô∏è <span id="sessionTimer">40:00</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="sessionProgress"></div>
                </div>
                <a href="module-hub.html" class="back-button">‚Üê Torna ai Moduli</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Phase Indicator -->
        <div class="phase-indicator">
            <div class="phase-step active" id="phaseStep1">
                <span>üéØ</span>
                <span>Fase 1: Sistema di Azione Efficace</span>
            </div>
            <div class="phase-arrow">‚Üí</div>
            <div class="phase-step inactive" id="phaseStep2">
                <span>üß†</span>
                <span>Fase 2: Coaching Strategico Avanzato</span>
            </div>
        </div>

        <!-- Welcome Section -->
        <section class="welcome-section fade-in" id="welcomeSection">
            <h1 class="welcome-title">Benvenuto nella Settimana 4! üöÄ</h1>
            <p class="welcome-subtitle">Piano di Azione - Da obiettivo SMART a sistema che funziona</p>
            
            <div class="journey-recap">
                <h3 class="recap-title">üåü Il Tuo Incredibile Percorso</h3>
                <div id="journeyRecap">
                    <p><strong>Settimana 1:</strong> Hai mappato la tua vita e identificato i tuoi sogni autentici</p>
                    <p><strong>Settimana 2:</strong> Hai scoperto i tuoi valori profondi e cosa ti motiva veramente</p>
                    <p><strong>Settimana 3:</strong> Hai trasformato un sogno in un obiettivo SMART concreto</p>
                    <p style="margin-top: 1rem; font-style: italic; color: #16a34a;">
                        Oggi creiamo il sistema che render√† inevitabile il tuo successo! üéØ
                    </p>
                </div>
            </div>
            
            <div class="smart-goal-preview">
                <h3 class="preview-title">üéØ Il Tuo Obiettivo SMART</h3>
                <div id="smartGoalPreview">
                    <p style="font-style: italic; color: #ea580c;">Caricamento del tuo obiettivo SMART dalla Settimana 3...</p>
                </div>
            </div>
            
            <div class="action-explanation">
                <h3 class="action-title">üöÄ Dalla Teoria alla Pratica</h3>
                <p style="margin-bottom: 1.5rem;">
                    Un obiettivo senza un sistema √® solo un sogno. Oggi costruiamo il <strong>sistema di azione</strong> 
                    che trasformer√† il tuo obiettivo SMART in una serie di abitudini naturali e sostenibili.
                </p>
                <div class="process-steps">
                    <div class="process-step">
                        <div class="step-number">1</div>
                        <div class="step-title">Sistema di Azione Efficace</div>
                        <div class="step-description">
                            Framework delle abitudini, timeline personalizzata, gestione ostacoli e 
                            sistemi di misurazione per rendere il successo inevitabile.
                        </div>
                        <div class="step-duration">‚è±Ô∏è 15-18 minuti</div>
                    </div>
                    <div class="process-step">
                        <div class="step-number">2</div>
                        <div class="step-title">Coaching Strategico Avanzato</div>
                        <div class="step-description">
                            Ottimizzazione del piano, strategie per superare resistenze e creazione 
                            del tuo sistema personalizzato di accountability.
                        </div>
                        <div class="step-duration">‚è±Ô∏è 22-25 minuti</div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="startPhase1()">
                üéØ Inizia a Costruire il Tuo Sistema di Successo
            </button>
        </section>

        <!-- Phase 1: Sistema di Azione -->
        <section class="phase1-section" id="phase1Section">
            <div class="phase-header">
                <div class="phase-icon">üéØ</div>
                <div>
                    <h2 class="phase-title">Fase 1: Sistema di Azione Efficace</h2>
                    <p class="phase-subtitle">Costruisci il framework che render√† inevitabile il tuo successo</p>
                </div>
            </div>
            
            <div class="workshop-progress">
                <div class="workshop-progress-text">Progresso sistema: <span id="systemProgress">0%</span></div>
                <div class="workshop-progress-bar">
                    <div class="workshop-progress-fill" id="systemProgressFill" style="width: 0%"></div>
                </div>
            </div>

            <!-- Framework delle Abitudini -->
            <div class="system-section" id="habitFramework">
                <h3>üîÑ Framework delle Abitudini - Il Ciclo del Successo</h3>
                <div class="system-intro">
                    Le ricerche mostrano che il 95% dei nostri comportamenti sono automatici. 
                    Creiamo il ciclo di abitudini che render√† il tuo obiettivo SMART parte della tua identit√†.
                </div>
                
                <div class="habit-framework">
                    <div class="habit-component">
                        <div class="habit-component-icon">üéØ</div>
                        <div class="habit-component-title">TRIGGER (Innesco)</div>
                        <div class="habit-component-description">
                            Il segnale che scatena automaticamente il comportamento. 
                            Deve essere specifico, ovvio e collegato a qualcosa che gi√† fai.
                        </div>
                    </div>
                    
                    <div class="habit-component">
                        <div class="habit-component-icon">‚ö°</div>
                        <div class="habit-component-title">ROUTINE (Azione)</div>
                        <div class="habit-component-description">
                            L'azione concreta che ti porta verso l'obiettivo. 
                            Deve essere semplice, misurabile e collegata al risultato finale.
                        </div>
                    </div>
                    
                    <div class="habit-component">
                        <div class="habit-component-icon">üèÜ</div>
                        <div class="habit-component-title">REWARD (Ricompensa)</div>
                        <div class="habit-component-description">
                            Il beneficio immediato che rinforza l'abitudine. 
                            Pu√≤ essere intrinseco (soddisfazione) o estrinseco (celebrazione).
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-secondary" onclick="markFrameworkLearned()" style="margin-top: 1rem;">
                    ‚úÖ Ho compreso il framework, applico al mio obiettivo
                </button>
            </div>

            <!-- Applicazione Personalizzata -->
            <div class="system-section" id="habitApplication" style="display: none;">
                <h3>üéØ Applica il Framework al Tuo Obiettivo SMART</h3>
                <div class="system-intro">
                    Ora trasformiamo il tuo obiettivo SMART in un sistema di abitudini automatiche. 
                    Iniziamo con LA micro-abitudine pi√π importante.
                </div>
                
                <div class="exercise-group">
                    <div class="exercise-title">üéØ TRIGGER - Il Tuo Innesco Automatico</div>
                    <div class="form-group">
                        <label for="habitTrigger">Quale sar√† il segnale che scatena automaticamente l'azione?</label>
                        <textarea id="habitTrigger" placeholder="Es: Dopo aver bevuto il caff√® del mattino... / Quando accendo il computer... / Prima di andare a dormire..." onchange="updateSystemProgress(); autoSave()"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="triggerTime">A che ora e in che contesto specifico?</label>
                        <input type="text" id="triggerTime" placeholder="Es: Ogni giorno alle 7:30, in cucina..." onchange="updateSystemProgress(); autoSave()">
                    </div>
                </div>

                <div class="exercise-group">
                    <div class="exercise-title">‚ö° ROUTINE - La Tua Azione Specifica</div>
                    <div class="form-group">
                        <label for="habitRoutine">Qual √® l'azione pi√π piccola ma significativa che farai?</label>
                        <textarea id="habitRoutine" placeholder="Es: 10 push-up / Leggere 1 pagina / Chiamare 1 cliente / Meditare 5 minuti..." onchange="updateSystemProgress(); autoSave()"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="routineDuration">Quanto tempo richiede? (meno √® meglio per iniziare)</label>
                        <input type="text" id="routineDuration" placeholder="Es: 5 minuti, 2 minuti, 30 secondi..." onchange="updateSystemProgress(); autoSave()">
                    </div>
                </div>

                <div class="exercise-group">
                    <div class="exercise-title">üèÜ REWARD - La Tua Ricompensa Immediata</div>
                    <div class="form-group">
                        <label for="habitReward">Come ti premierai immediatamente dopo l'azione?</label>
                        <textarea id="habitReward" placeholder="Es: Mi godo un caff√® speciale / Segno ‚úÖ sul calendario / Mi congratulo ad alta voce / Ascolto la mia canzone preferita..." onchange="updateSystemProgress(); autoSave()"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="rewardWhy">Perch√© questa ricompensa ti motiva?</label>
                        <input type="text" id="rewardWhy" placeholder="Es: Mi fa sentire realizzato, mi d√† energia positiva..." onchange="updateSystemProgress(); autoSave()">
                    </div>
                </div>
            </div>

            <!-- Timeline di Implementazione -->
            <div class="system-section" id="implementationTimeline" style="display: none;">
                <h3>üìÖ Timeline di Implementazione - I Tuoi Primi 90 Giorni</h3>
                <div class="system-intro">
                    La scienza mostra che ci vogliono 66 giorni per rendere automatica un'abitudine. 
                    Creiamo la tua roadmap personalizzata per rendere inevitabile il successo.
                </div>
                
                <div class="timeline-builder">
                    <div class="timeline-title">üóìÔ∏è La Tua Roadmap di 12 Settimane</div>
                    <div class="timeline-weeks">
                        <div class="week-card">
                            <div class="week-header">
                                <span class="week-number">Settimane 1-2</span>
                                <span>üå± Impianto</span>
                            </div>
                            <textarea class="week-input" id="weeks1-2" placeholder="Cosa farai per stabilire l'abitudine? Focus sulla consistenza..." onchange="updateSystemProgress(); autoSave()"></textarea>
                        </div>
                        
                        <div class="week-card">
                            <div class="week-header">
                                <span class="week-number">Settimane 3-4</span>
                                <span>üí™ Rinforzo</span>
                            </div>
                            <textarea class="week-input" id="weeks3-4" placeholder="Come rinforzerai l'abitudine? Aggiungi sfide o elementi..." onchange="updateSystemProgress(); autoSave()"></textarea>
                        </div>
                        
                        <div class="week-card">
                            <div class="week-header">
                                <span class="week-number">Settimane 5-8</span>
                                <span>üöÄ Espansione</span>
                            </div>
                            <textarea class="week-input" id="weeks5-8" placeholder="Come svilupperai l'abitudine? Aumenti intensit√† o aggiungi elementi..." onchange="updateSystemProgress(); autoSave()"></textarea>
                        </div>
                        
                        <div class="week-card">
                            <div class="week-header">
                                <span class="week-number">Settimane 9-12</span>
                                <span>üèÜ Mastery</span>
                            </div>
                            <textarea class="week-input" id="weeks9-12" placeholder="L'abitudine √® automatica. Come evolvi verso l'obiettivo finale?" onchange="updateSystemProgress(); autoSave()"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gestione Ostacoli Avanzata -->
            <div class="system-section" id="obstacleManagement" style="display: none;">
                <h3>üõ°Ô∏è Sistema Anti-Ostacoli - Preparati per Vincere</h3>
                <div class="system-intro">
                    "Nei campi di battaglia, il general si prepara al peggio per ottenere il meglio." 
                    Prevediamo e neutralizziamo gli ostacoli prima che si presentino.
                </div>
                
                <div class="obstacle-matrix">
                    <div class="obstacle-section obstacles">
                        <h4 style="color: #ef4444; margin-bottom: 1rem;">‚ö†Ô∏è Ostacoli Prevedibili</h4>
                        <ul class="obstacle-list" id="obstaclesList">
                            <li class="obstacle-item">
                                <input type="text" placeholder="Es: Mancanza di tempo al mattino..." style="border: none; background: transparent; flex: 1;">
                                <button onclick="removeObstacle(this)" style="background: none; border: none; color: #ef4444; cursor: pointer;">‚ùå</button>
                            </li>
                        </ul>
                        <div class="add-obstacle-btn" onclick="addObstacle()">+ Aggiungi Ostacolo</div>
                    </div>
                    
                    <div class="obstacle-section solutions">
                        <h4 style="color: #16a34a; margin-bottom: 1rem;">üí° Soluzioni Pre-Pianificate</h4>
                        <ul class="obstacle-list" id="solutionsList">
                            <li class="obstacle-item">
                                <input type="text" placeholder="Es: Preparo tutto la sera prima..." style="border: none; background: transparent; flex: 1;">
                                <button onclick="removeSolution(this)" style="background: none; border: none; color: #ef4444; cursor: pointer;">‚ùå</button>
                            </li>
                        </ul>
                        <div class="add-obstacle-btn" onclick="addSolution()">+ Aggiungi Soluzione</div>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 2rem;">
                    <label for="emergencyPlan">Piano di Emergenza: Se tutto va storto, qual √® il minimo che farai?</label>
                    <textarea id="emergencyPlan" placeholder="Es: Se sono super stressato, far√≤ almeno 1 minuto di respirazione profonda..." onchange="updateSystemProgress(); autoSave()"></textarea>
                </div>
            </div>

            <!-- Sistema di Misurazione -->
            <div class="system-section" id="measurementSystem" style="display: none;">
                <h3>üìä Sistema di Misurazione - Come Saprai che Funziona</h3>
                <div class="system-intro">
                    "Quello che misuri, migliora." Creiamo il sistema che ti terr√† motivato e in carreggiata.
                </div>
                
                <div class="form-group">
                    <label for="dailyMetric">Metrica Giornaliera: Cosa misurerai ogni giorno?</label>
                    <input type="text" id="dailyMetric" placeholder="Es: Ho fatto la mia routine? (S√¨/No) / Minuti di attivit√† / Numero di azioni..." onchange="updateSystemProgress(); autoSave()">
                </div>
                
                <div class="form-group">
                    <label for="weeklyReview">Revisione Settimanale: Cosa valuterai ogni domenica?</label>
                    <textarea id="weeklyReview" placeholder="Es: Quanti giorni ho completato la routine? Come mi sento? Cosa devo aggiustare?" onchange="updateSystemProgress(); autoSave()"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="successCelebration">Come celebrerai i traguardi intermedi?</label>
                    <textarea id="successCelebration" placeholder="Es: Dopo 7 giorni consecutivi ‚Üí cena speciale / Dopo 30 giorni ‚Üí acquisto qualcosa di carino..." onchange="updateSystemProgress(); autoSave()"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="accountabilityPerson">Chi ti supporter√† nel percorso? Come?</label>
                    <input type="text" id="accountabilityPerson" placeholder="Es: Il mio partner - gli mando foto ogni sera / Il mio amico - ci aggiorniamo ogni venerd√¨..." onchange="updateSystemProgress(); autoSave()">
                </div>
            </div>

            <div class="form-navigation">
                <button type="button" class="btn btn-success" id="completeSystemBtn" onclick="completePhase1()" disabled>
                    ‚úÖ Sistema Completo - Inizia Coaching Strategico
                </button>
            </div>
        </section>

        <!-- Phase 2: Coaching Strategico Avanzato -->
        <section class="phase2-section" id="phase2Section">
            <div class="phase-header">
                <div class="phase-icon">üß†</div>
                <div>
                    <h2 class="phase-title">Fase 2: Coaching Strategico Avanzato</h2>
                    <p class="phase-subtitle">Ottimizza il sistema e crea il tuo piano di successo personalizzato</p>
                </div>
            </div>
            
            <div class="coaching-context">
                <h3>üéØ Il Tuo Sistema di Azione Personalizzato</h3>
                <p>
                    Incredibile! Hai appena costruito un sistema che trasforma il tuo obiettivo SMART 
                    in azioni automatiche e sostenibili. Ora voglio aiutarti a perfezionarlo e renderlo 
                    inattaccabile dalle tentazioni e dalle resistenze.
                </p>
                
                <div class="insights-summary">
                    <div class="insights-title">üîß Il Tuo Sistema Personalizzato:</div>
                    <ul class="insights-list" id="systemSummary">
                        <li>Elaborazione del tuo sistema di abitudini...</li>
                    </ul>
                </div>
            </div>
            
            <div class="action-plan-preview">
                <h3 class="plan-preview-title">üìã Anteprima del Tuo Piano Finale</h3>
                <div class="plan-elements">
                    <div class="plan-element">
                        <div class="element-icon">üéØ</div>
                        <div class="element-title">TRIGGER</div>
                        <div class="element-value" id="triggerPreview">In elaborazione...</div>
                    </div>
                    <div class="plan-element">
                        <div class="element-icon">‚ö°</div>
                        <div class="element-title">ROUTINE</div>
                        <div class="element-value" id="routinePreview">In elaborazione...</div>
                    </div>
                    <div class="plan-element">
                        <div class="element-icon">üèÜ</div>
                        <div class="element-title">REWARD</div>
                        <div class="element-value" id="rewardPreview">In elaborazione...</div>
                    </div>
                    <div class="plan-element">
                        <div class="element-icon">üìä</div>
                        <div class="element-title">MISURAZIONE</div>
                        <div class="element-value" id="measurementPreview">In elaborazione...</div>
                    </div>
                </div>
            </div>
            
            <div class="time-warning" id="timeWarning">
                <strong>‚è∞ Abbiamo raggiunto i 30 minuti!</strong> Vuoi continuare per completare l'ottimizzazione del sistema?
                <div style="margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="continueSession()">Continua - Ottimizza Sistema</button>
                    <button class="btn btn-primary" onclick="endSession()">Termina - Scarica Piano Base</button>
                </div>
            </div>
            
            <div class="chat-status">
                <div class="status-dot"></div>
                <span>Andrea √® pronto per ottimizzare il tuo sistema e renderlo inattaccabile</span>
            </div>
            
            <div class="chat-container" id="chatContainer">
                <!-- Messages will be added here -->
            </div>
            
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="Condividi le tue riflessioni con Andrea...">
                <button class="btn btn-primary" onclick="sendChatMessage()">Invia</button>
            </div>
        </section>

        <!-- Completion Section -->
        <section class="completion-section" id="completionSection">
            <h2 class="completion-title">üéØ Sistema di Azione Completato!</h2>
            <p class="completion-message">
                Straordinario! Hai completato il tuo percorso trasformativo di 4 settimane. 
                Da sogno vago a sistema concreto e automatico. Hai ora tutto quello che serve 
                per trasformare la tua vita e raggiungere i tuoi obiettivi pi√π ambiziosi.
            </p>
            
            <div class="final-plan-section">
                <h3 class="final-plan-title">üèÜ Il Tuo Sistema di Successo Completo</h3>
                
                <div class="habit-loop-visual">
                    <div class="loop-step" id="triggerStep">TRIGGER<br><span style="font-size: 0.6rem;" id="triggerText">Il tuo segnale</span></div>
                    <div class="loop-arrow">‚Üí</div>
                    <div class="loop-step" id="routineStep">ROUTINE<br><span style="font-size: 0.6rem;" id="routineText">La tua azione</span></div>
                    <div class="loop-arrow">‚Üí</div>
                    <div class="loop-step" id="rewardStep">REWARD<br><span style="font-size: 0.6rem;" id="rewardText">La tua ricompensa</span></div>
                </div>
                
                <div class="plan-summary" id="finalSystemPlan">
                    <!-- Will be populated with complete system -->
                </div>
            </div>
            
            <div class="completion-actions">
                <button class="btn btn-success" onclick="downloadCompletePlan()">üìÑ Scarica Piano Completo</button>
                <button class="btn btn-secondary" onclick="downloadQuickStart()">‚ö° Scarica Quick Start</button>
                <a href="module-hub.html" class="btn btn-secondary">‚Üê Torna ai Moduli</a>
                <button class="btn btn-primary" onclick="celebrateCompletion()">üéâ Celebra il Completamento!</button>
            </div>
        </section>
    </main>

    <script>
        // Session variables
        let sessionStartTime = Date.now();
        let sessionDuration = 40 * 60 * 1000; // 40 minutes
        let timerInterval;
        let currentPhase = 'welcome';
        let systemData = {};
        let actionPlanData = {};
        let chatHistory = [];
        let userProfile = null;
        let week1Data = null;
        let week2Data = null;
        let week3Data = null;
        let sessionExtended = false;
        let autoSaveInterval;
        let coachingInsights = [];

        // Initialize session
        document.addEventListener('DOMContentLoaded', function() {
            startSessionTimer();
            loadUserProfile();
            loadPreviousWeeks();
            loadSavedSession();
            startAutoSave();
        });

        function startSessionTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - sessionStartTime;
                const remaining = Math.max(0, sessionDuration - elapsed);
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                
                document.getElementById('sessionTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const progress = (elapsed / sessionDuration) * 100;
                document.getElementById('sessionProgress').style.width = `${Math.min(progress, 100)}%`;
                
                // Check for 30 minute warning
                if (elapsed >= 30 * 60 * 1000 && !sessionExtended && currentPhase === 'phase2') {
                    show30MinuteWarning();
                }
                
                // Auto-end at 40 minutes
                if (remaining === 0) {
                    clearInterval(timerInterval);
                    endSession();
                }
            }, 1000);
        }

        function loadUserProfile() {
            try {
                const savedData = localStorage.getItem('lifestyleQuizResults');
                if (savedData) {
                    userProfile = JSON.parse(savedData);
                    console.log('‚úÖ User profile loaded:', userProfile);
                }
            } catch (error) {
                console.error('‚ùå Error loading user profile:', error);
            }
        }

        function loadPreviousWeeks() {
            try {
                // Load Week 1 data
                const week1SessionData = localStorage.getItem('week1SessionCompleted');
                if (week1SessionData) {
                    week1Data = JSON.parse(week1SessionData);
                    console.log('‚úÖ Week 1 data loaded:', week1Data);
                }

                // Load Week 2 data
                const week2SessionData = localStorage.getItem('week2SessionCompleted');
                if (week2SessionData) {
                    week2Data = JSON.parse(week2SessionData);
                    console.log('‚úÖ Week 2 data loaded:', week2Data);
                }
                
                // Load Week 3 data
                const week3SessionData = localStorage.getItem('week3SessionCompleted');
                if (week3SessionData) {
                    week3Data = JSON.parse(week3SessionData);
                    console.log('‚úÖ Week 3 data loaded:', week3Data);
                }
                
                displayJourneyRecap();
                displaySmartGoalPreview();
            } catch (error) {
                console.error('‚ùå Error loading previous weeks data:', error);
                displayDefaultRecap();
            }
        }

        function displayJourneyRecap() {
            const recapEl = document.getElementById('journeyRecap');
            let content = '<p><strong>Il tuo incredibile percorso di trasformazione:</strong></p>';
            
            if (week1Data && week1Data.phase1Data) {
                content += `<p><strong>Settimana 1:</strong> Hai identificato "${week1Data.phase1Data.dreamGoal || 'la tua trasformazione'}" come sogno principale</p>`;
            }
            
            if (week2Data && week2Data.testResults) {
                const topValue = week2Data.testResults.topValues && week2Data.testResults.topValues.length > 0 ? 
                    (() => {
                        const valueLabels = {
                            family: 'famiglia e relazioni',
                            career: 'successo professionale',
                            health: 'salute e benessere',
                            growth: 'crescita personale',
                            freedom: 'libert√† e indipendenza'
                        };
                        return valueLabels[week2Data.testResults.topValues[0][0]];
                    })() : 'valori autentici';
                content += `<p><strong>Settimana 2:</strong> Hai scoperto che ${topValue} √® il tuo valore principale</p>`;
            }
            
            if (week3Data && week3Data.smartGoalData) {
                const areaLabels = {
                    health: 'salute fisica',
                    mental: 'benessere mentale',
                    relationship: 'relazioni',
                    career: 'carriera e crescita'
                };
                const areaLabel = areaLabels[week3Data.smartGoalData.area] || 'area prioritaria';
                content += `<p><strong>Settimana 3:</strong> Hai trasformato il sogno in obiettivo SMART per la tua ${areaLabel}</p>`;
            }
            
            content += `<p style="margin-top: 1rem; font-style: italic; color: #16a34a;">
                Oggi completi il percorso creando il sistema che render√† inevitabile il tuo successo! üéØ
            </p>`;
            
            recapEl.innerHTML = content;
        }

        function displaySmartGoalPreview() {
            const previewEl = document.getElementById('smartGoalPreview');
            
            if (week3Data && week3Data.smartGoalData) {
                const smartGoal = week3Data.smartGoalData;
                const areaLabels = {
                    health: 'üí™ Salute Fisica',
                    mental: 'üß† Benessere Mentale',
                    relationship: '‚ù§Ô∏è Relazioni',
                    career: 'üíº Carriera/Crescita'
                };
                
                const areaLabel = areaLabels[smartGoal.area] || 'üéØ Area selezionata';
                
                previewEl.innerHTML = `
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #ea580c;">
                        <h4 style="color: #ea580c; margin-bottom: 1rem;">${areaLabel}</h4>
                        <p style="color: #1e293b; font-weight: 600; margin-bottom: 0.5rem;">Obiettivo SMART:</p>
                        <p style="color: #64748b; font-size: 0.9rem; line-height: 1.5;">${smartGoal.specific?.substring(0, 200)}...</p>
                        <p style="color: #ea580c; font-size: 0.8rem; margin-top: 1rem; font-style: italic;">
                            Ora trasformiamo questo obiettivo in un sistema di azioni automatiche!
                        </p>
                    </div>
                `;
            } else {
                previewEl.innerHTML = `
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #94a3b8;">
                        <p style="color: #64748b; font-style: italic;">
                            Non ho trovato dati dalla Settimana 3. Procediamo comunque a creare il tuo sistema di azione!
                        </p>
                    </div>
                `;
            }
        }

        function displayDefaultRecap() {
            const recapEl = document.getElementById('journeyRecap');
            recapEl.innerHTML = `
                <p><strong>Settimana 1:</strong> Hai mappato la tua vita e identificato i tuoi sogni autentici</p>
                <p><strong>Settimana 2:</strong> Hai scoperto i tuoi valori profondi e cosa ti motiva veramente</p>
                <p><strong>Settimana 3:</strong> Hai trasformato un sogno in un obiettivo SMART concreto</p>
                <p style="margin-top: 1rem; font-style: italic; color: #16a34a;">
                    Oggi creiamo il sistema che render√† inevitabile il tuo successo! üéØ
                </p>
            `;
        }

        function loadSavedSession() {
            try {
                const savedSession = localStorage.getItem('week4SessionInProgress');
                if (savedSession) {
                    const sessionData = JSON.parse(savedSession);
                    
                    // Restore system data
                    if (sessionData.systemData) {
                        systemData = sessionData.systemData;
                        restoreSystemAnswers();
                    }
                    
                    // Restore action plan data
                    if (sessionData.actionPlanData) {
                        actionPlanData = sessionData.actionPlanData;
                    }
                    
                    // Restore chat history
                    if (sessionData.chatHistory) {
                        chatHistory = sessionData.chatHistory;
                    }
                    
                    // Restore current phase
                    if (sessionData.currentPhase) {
                        currentPhase = sessionData.currentPhase;
                        
                        if (currentPhase === 'phase1') {
                            startPhase1();
                        } else if (currentPhase === 'phase2') {
                            startPhase2();
                            restoreChatHistory();
                        }
                    }
                    
                    console.log('‚úÖ Session restored from:', sessionData);
                }
            } catch (error) {
                console.error('‚ùå Error loading saved session:', error);
            }
        }

        function restoreSystemAnswers() {
            Object.entries(systemData).forEach(([key, value]) => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = value;
                }
            });
            updateSystemProgress();
        }

        function startAutoSave() {
            autoSaveInterval = setInterval(() => {
                autoSave();
            }, 5000);
        }

        function autoSave() {
            try {
                const sessionData = {
                    currentPhase: currentPhase,
                    systemData: systemData,
                    actionPlanData: actionPlanData,
                    chatHistory: chatHistory,
                    coachingInsights: coachingInsights,
                    sessionStartTime: sessionStartTime,
                    lastSaved: new Date().toISOString()
                };
                
                localStorage.setItem('week4SessionInProgress', JSON.stringify(sessionData));
            } catch (error) {
                console.error('‚ùå Error auto-saving:', error);
            }
        }

        function startPhase1() {
            currentPhase = 'phase1';
            
            // Hide welcome, show phase 1
            document.getElementById('welcomeSection').style.display = 'none';
            document.getElementById('phase1Section').classList.add('active');
            
            // Update phase indicator
            document.getElementById('phaseStep1').className = 'phase-step active';
            document.getElementById('phaseStep2').className = 'phase-step inactive';
            
            updateSystemProgress();
            autoSave();
        }

        function markFrameworkLearned() {
            systemData.frameworkLearned = true;
            document.getElementById('habitFramework').style.display = 'none';
            document.getElementById('habitApplication').style.display = 'block';
            updateSystemProgress();
            autoSave();
        }

        function updateSystemProgress() {
            // Calculate progress based on completed sections
            let progress = 0;
            let totalSections = 6;
            
            // Framework learned
            if (systemData.frameworkLearned) progress++;
            
            // Habit application (3 components: trigger, routine, reward)
            const habitFields = ['habitTrigger', 'triggerTime', 'habitRoutine', 'routineDuration', 'habitReward', 'rewardWhy'];
            const filledHabit = habitFields.filter(field => {
                const element = document.getElementById(field);
                if (element && element.value.trim()) {
                    systemData[field] = element.value.trim();
                    return true;
                }
                return false;
            });
            
            if (filledHabit.length === 6) {
                progress++;
                // Show timeline section
                if (document.getElementById('implementationTimeline').style.display === 'none') {
                    document.getElementById('implementationTimeline').style.display = 'block';
                }
            }
            
            // Timeline implementation
            const timelineFields = ['weeks1-2', 'weeks3-4', 'weeks5-8', 'weeks9-12'];
            const filledTimeline = timelineFields.filter(field => {
                const element = document.getElementById(field);
                if (element && element.value.trim()) {
                    systemData[field] = element.value.trim();
                    return true;
                }
                return false;
            });
            
            if (filledTimeline.length === 4) {
                progress++;
                // Show obstacle management section
                if (document.getElementById('obstacleManagement').style.display === 'none') {
                    document.getElementById('obstacleManagement').style.display = 'block';
                }
            }
            
            // Obstacle management
            const obstacleFields = ['emergencyPlan'];
            const filledObstacles = obstacleFields.filter(field => {
                const element = document.getElementById(field);
                if (element && element.value.trim()) {
                    systemData[field] = element.value.trim();
                    return true;
                }
                return false;
            });
            
            if (filledObstacles.length === 1) {
                progress++;
                // Show measurement system section
                if (document.getElementById('measurementSystem').style.display === 'none') {
                    document.getElementById('measurementSystem').style.display = 'block';
                }
            }
            
            // Measurement system
            const measurementFields = ['dailyMetric', 'weeklyReview', 'successCelebration', 'accountabilityPerson'];
            const filledMeasurement = measurementFields.filter(field => {
                const element = document.getElementById(field);
                if (element && element.value.trim()) {
                    systemData[field] = element.value.trim();
                    return true;
                }
                return false;
            });
            
            if (filledMeasurement.length === 4) {
                progress++;
            }
            
            const progressPercentage = (progress / totalSections) * 100;
            document.getElementById('systemProgress').textContent = `${Math.round(progressPercentage)}%`;
            document.getElementById('systemProgressFill').style.width = `${progressPercentage}%`;
            
            // Enable/disable complete button
            const completeBtn = document.getElementById('completeSystemBtn');
            if (progressPercentage === 100) {
                completeBtn.disabled = false;
                completeBtn.className = 'btn btn-success';
            } else {
                completeBtn.disabled = true;
                completeBtn.className = 'btn btn-disabled';
            }
        }

        function addObstacle() {
            const obstaclesList = document.getElementById('obstaclesList');
            const newObstacle = document.createElement('li');
            newObstacle.className = 'obstacle-item';
            newObstacle.innerHTML = `
                <input type="text" placeholder="Nuovo ostacolo..." style="border: none; background: transparent; flex: 1;" onchange="autoSave()">
                <button onclick="removeObstacle(this)" style="background: none; border: none; color: #ef4444; cursor: pointer;">‚ùå</button>
            `;
            obstaclesList.appendChild(newObstacle);
        }

        function removeObstacle(button) {
            button.parentElement.remove();
            autoSave();
        }

        function addSolution() {
            const solutionsList = document.getElementById('solutionsList');
            const newSolution = document.createElement('li');
            newSolution.className = 'obstacle-item';
            newSolution.innerHTML = `
                <input type="text" placeholder="Nuova soluzione..." style="border: none; background: transparent; flex: 1;" onchange="autoSave()">
                <button onclick="removeSolution(this)" style="background: none; border: none; color: #ef4444; cursor: pointer;">‚ùå</button>
            `;
            solutionsList.appendChild(newSolution);
        }

        function removeSolution(button) {
            button.parentElement.remove();
            autoSave();
        }

        function completePhase1() {
            // Process system data
            processActionSystem();
            
            // Mark phase 1 as completed
            document.getElementById('phaseStep1').className = 'phase-step completed';
            
            // Start phase 2
            startPhase2();
        }

        function processActionSystem() {
            // Create comprehensive action plan data
            actionPlanData = {
                trigger: {
                    signal: systemData.habitTrigger,
                    context: systemData.triggerTime
                },
                routine: {
                    action: systemData.habitRoutine,
                    duration: systemData.routineDuration
                },
                reward: {
                    celebration: systemData.habitReward,
                    motivation: systemData.rewardWhy
                },
                timeline: {
                    weeks1_2: systemData['weeks1-2'],
                    weeks3_4: systemData['weeks3-4'],
                    weeks5_8: systemData['weeks5-8'],
                    weeks9_12: systemData['weeks9-12']
                },
                measurement: {
                    daily: systemData.dailyMetric,
                    weekly: systemData.weeklyReview,
                    celebration: systemData.successCelebration,
                    accountability: systemData.accountabilityPerson
                },
                emergencyPlan: systemData.emergencyPlan
            };
            
            // Generate coaching insights
            generateSystemInsights();
        }

        function generateSystemInsights() {
            coachingInsights = [];
            
            // Analyze system quality
            if (systemData.habitTrigger && systemData.habitTrigger.length > 30) {
                coachingInsights.push('Trigger specifico e dettagliato identificato');
            }
            
            if (systemData.routineDuration && (systemData.routineDuration.includes('minuti') || systemData.routineDuration.includes('minuto'))) {
                coachingInsights.push('Durata realistica per costruire l\'abitudine');
            }
            
            if (systemData.habitReward && systemData.habitReward.includes('immediata')) {
                coachingInsights.push('Sistema di ricompensa immediata ben progettato');
            }
            
            if (systemData.accountabilityPerson && systemData.accountabilityPerson.length > 20) {
                coachingInsights.push('Solido sistema di supporto sociale');
            }
        }

        function startPhase2() {
            currentPhase = 'phase2';
            
            // Hide phase 1, show phase 2
            document.getElementById('phase1Section').classList.remove('active');
            document.getElementById('phase2Section').classList.add('active');
            
            // Update phase indicator
            document.getElementById('phaseStep2').className = 'phase-step active';
            
            // Display system summary
            displaySystemSummary();
            
            // Update plan preview
            updatePlanPreview();
            
            // Generate first coaching question
            generateFirstActionCoachingQuestion();
            
            autoSave();
        }

        function displaySystemSummary() {
            const summaryEl = document.getElementById('systemSummary');
            if (actionPlanData.trigger && actionPlanData.routine) {
                summaryEl.innerHTML = `
                    <li><strong>Trigger:</strong> ${actionPlanData.trigger.signal?.substring(0, 60)}...</li>
                    <li><strong>Routine:</strong> ${actionPlanData.routine.action?.substring(0, 60)}...</li>
                    <li><strong>Reward:</strong> ${actionPlanData.reward.celebration?.substring(0, 60)}...</li>
                    <li><strong>Timeline:</strong> Piano 12 settimane strutturato per automatizzazione</li>
                `;
            } else {
                summaryEl.innerHTML = '<li>Elaborazione del tuo sistema di azione in corso...</li>';
            }
        }

        function updatePlanPreview() {
            const triggerEl = document.getElementById('triggerPreview');
            const routineEl = document.getElementById('routinePreview');
            const rewardEl = document.getElementById('rewardPreview');
            const measurementEl = document.getElementById('measurementPreview');
            
            if (actionPlanData.trigger) {
                triggerEl.textContent = actionPlanData.trigger.signal?.substring(0, 30) + '...' || 'Definito';
                routineEl.textContent = actionPlanData.routine.action?.substring(0, 30) + '...' || 'Definita';
                rewardEl.textContent = actionPlanData.reward.celebration?.substring(0, 30) + '...' || 'Definita';
                measurementEl.textContent = actionPlanData.measurement.daily?.substring(0, 30) + '...' || 'Definita';
            }
        }

        function generateFirstActionCoachingQuestion() {
            if (chatHistory.length === 0) {
                const firstQuestion = generatePowerfulActionQuestion();
                addChatMessage(firstQuestion, 'coach');
            } else {
                restoreChatHistory();
            }
        }

        function generatePowerfulActionQuestion() {
            let question = `Wow! Hai appena costruito un sistema incredibilmente potente. `;
            
            // Reference their specific system
            if (actionPlanData.trigger && actionPlanData.routine) {
                question += `Vedo che hai scelto "${actionPlanData.trigger.signal}" come trigger per "${actionPlanData.routine.action}". `;
                question += `Questa combinazione mi dice che hai capito il vero segreto del cambiamento: rendere automatico ci√≤ che √® importante. `;
            }
            
            // Connect to their SMART goal from Week 3
            if (week3Data && week3Data.smartGoalData) {
                const areaLabels = {
                    health: 'salute fisica',
                    mental: 'benessere mentale',
                    relationship: 'relazioni',
                    career: 'carriera e crescita'
                };
                const areaLabel = areaLabels[week3Data.smartGoalData.area] || 'area prioritaria';
                question += `E questo si allinea perfettamente con il tuo obiettivo SMART per la ${areaLabel}. `;
            }
            
            // Connect to their values from Week 2
            if (week2Data && week2Data.testResults && week2Data.testResults.topValues) {
                const valueLabels = {
                    family: 'famiglia e relazioni',
                    career: 'successo professionale',
                    health: 'salute e benessere',
                    growth: 'crescita personale',
                    freedom: 'libert√† e indipendenza'
                };
                const topValue = valueLabels[week2Data.testResults.topValues[0][0]];
                question += `E tutto questo √® guidato dal tuo valore principale: ${topValue}. `;
            }
            
            // Powerful coaching question
            question += `\n\nOra voglio farti la domanda che distingue chi realizza i propri obiettivi da chi continua a sognarli: 
            
**Quando questa abitudine diventer√† automatica - e diventer√† automatica se segui il sistema - come cambier√† la tua identit√†? Non solo cosa farai, ma chi diventerai come persona?**

Per esempio, non sarai pi√π "una persona che vuole essere in forma" ma "una persona che SI ALLENA naturalmente". Non sarai pi√π "qualcuno che vorrebbe essere organizzato" ma "qualcuno che HA SISTEMI che funzionano".

Dimmi: quando questa abitudine sar√† parte di chi sei, quale sar√† la tua nuova identit√†? üåü`;
            
            return question;
        }

        function restoreChatHistory() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '';
            
            chatHistory.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.sender}`;
                messageDiv.innerHTML = `
                    <div class="message-content">${message.content}</div>
                    <div class="message-time">${message.time}</div>
                `;
                chatContainer.appendChild(messageDiv);
            });
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addChatMessage(message, 'user');
            input.value = '';
            
            // Get AI coaching response
            try {
                const coachingResponse = await getActionCoachingResponse(message);
                setTimeout(() => {
                    addChatMessage(coachingResponse, 'coach');
                }, 1500);
            } catch (error) {
                console.error('‚ùå Error getting coaching response:', error);
                setTimeout(() => {
                    addChatMessage("Dammi un momento per elaborare... La profondit√† della tua riflessione merita una risposta accurata. Puoi ripetere?", 'coach');
                }, 1000);
            }
        }

        function addChatMessage(content, sender) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const now = new Date();
            const time = now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-content">${content}</div>
                <div class="message-time">${time}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Store in history
            chatHistory.push({ sender, content, time });
            
            // Extract insights if it's a user message
            if (sender === 'user') {
                extractActionInsights(content);
            }
            
            autoSave();
        }

        async function getActionCoachingResponse(userMessage) {
            // Build comprehensive context for action coaching
            const coachingContext = {
                systemData: systemData,
                actionPlanData: actionPlanData,
                chatHistory: chatHistory,
                coachingInsights: coachingInsights,
                week1Data: week1Data,
                week2Data: week2Data,
                week3Data: week3Data,
                userProfile: userProfile
            };
            
            return generateActionCoachingResponse(userMessage, coachingContext);
        }

        function generateActionCoachingResponse(userMessage, context) {
            const messageCount = context.chatHistory.filter(m => m.sender === 'user').length;
            
            // Different coaching approaches based on conversation depth
            if (messageCount <= 2) {
                return generateIdentityShiftResponse(userMessage, context);
            } else if (messageCount <= 4) {
                return generateResistanceManagementResponse(userMessage, context);
            } else {
                return generateOptimizationResponse(userMessage, context);
            }
        }

        function generateIdentityShiftResponse(userMessage, context) {
            const responses = [
                `Quello che stai descrivendo √® una trasformazione di identit√† profonda. Quando passi da "qualcuno che vuole" a "qualcuno che √à", tutto cambia. Il tuo cervello inizia a cercare prove che confermano questa nuova identit√†. Dimmi: quali piccoli segnali noterai nei primi giorni che ti confermano che la trasformazione √® iniziata?`,
                
                `Sento una chiarezza incredibile in quello che condividi. Questa nuova versione di te che descrivi, come interagir√† diversamente con le sfide quotidiane? Quando arriver√† un momento difficile, cosa far√† questa persona che tu "vecchio" non avresti fatto?`,
                
                `Le tue parole mi mostrano che hai compreso il segreto: non cambiamo comportamenti, cambiamo identit√†. E i comportamenti seguono naturalmente. Ora, pensando ai primi 21 giorni del tuo sistema: quale sar√† il momento in cui ti renderai conto "ecco, questa sono io ora"?`,
                
                `Quello che descrivi √® pura alchimia personale. Ma voglio assicurarmi che il tuo sistema sia inattaccabile. Dimmi: quando arriver√† il primo giorno "storto" - e arriver√† - quale aspetto della tua nuova identit√† ti far√† dire "lo faccio comunque"?`
            ];
            
            // Personalize based on their action system
            if (context.actionPlanData.routine && context.actionPlanData.routine.action) {
                return `Quello che stai condividendo tocca il cuore del cambiamento vero. Quando "${context.actionPlanData.routine.action}" diventer√† automatico come lavarti i denti, non sarai pi√π la stessa persona. Il tuo cervello ricalibrer√† completamente cosa √® "normale" per te. 

Ma ecco quello che mi affascina: il momento di svolta non √® quando ottieni il risultato finale, ma quando realizzi che NON fare l'azione ti sembra strano. Quando ti svegli e senti che "qualcosa manca" se non fai la tua routine.

Dimmi: come ti immagini il momento in cui realizzerai che questa abitudine √® diventata parte di chi sei? Cosa sentirai nel corpo? Che pensieri avrai?`;
            }
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function generateResistanceManagementResponse(userMessage, context) {
            const responses = [
                `Quello che condividi mi fa pensare che hai una comprensione profonda di te stesso. Ma ora voglio andare nel territorio pi√π pericoloso: la resistenza interna. Il tuo sistema √® tecnicamente perfetto, ma il sabotatore interno quando si manifester√†? Quale voce nella tua testa cercher√† di farti saltare la routine?`,
                
                `Sento una determinazione forte, e questo √® fantastico. Ma lascia che ti faccia una domanda scomoda: se dovessi progettare il modo perfetto per sabotare il tuo stesso sistema, cosa faresti? Qual √® il tuo "tallone d'Achille" motivazionale?`,
                
                `Le tue riflessioni mostrano una maturit√† incredibile nel comprendere il cambiamento. Ora, pensando ai tuoi pattern del passato: qual √® stata la cosa che ti ha fatto abbandonare abitudini positive in precedenza? Come il tuo sistema attuale neutralizza quella specifica debolezza?`,
                
                `Quello che stai costruendo √® solido, ma voglio renderlo inattaccabile. Se dovessi scommettere, quale sar√† il primo "ma" che la tua mente ti presenter√†? "Ma oggi sono stanco", "Ma oggi non ho tempo", "Ma oggi √® diverso"... Quale sar√† il TUO "ma" specifico?`
            ];
            
            // Deep questions based on their specific system
            if (context.systemData.emergencyPlan) {
                return `Le tue riflessioni mi mostrano qualcuno che ha imparato dai propri errori. Vedo che hai gi√† pensato a un piano di emergenza: "${context.systemData.emergencyPlan}". Questo mi dice che sai che i giorni perfetti non esistono.

Ma voglio spingermi oltre: qual √® la differenza tra "piano di emergenza" e "scusa camuffata"? Come farai a riconoscere quando stai usando il piano di emergenza legittimamente vs quando stai solo cercando una via di fuga?

E soprattutto: cosa farai il giorno DOPO aver usato il piano di emergenza per assicurarti di tornare sulla strada principale?`;
            }
            
            if (context.actionPlanData.reward) {
                return `Quando parli della tua ricompensa - "${context.actionPlanData.reward.celebration}" - vedo che hai capito l'importanza del rinforzo positivo. Ma qui c'√® una trappola sottile: cosa succede quando la ricompensa esterna non baster√† pi√π?

La vera sfida arriver√† quando dovrai passare dalla motivazione estrinseca a quella intrinseca. Quando fare l'azione dovr√† essere rewarding di per s√©, non per quello che ottieni dopo.

Dimmi: cosa c'√® di intrinsecamente gratificante nell'azione stessa che stai costruendo? Cosa ti far√† sentire bene DURANTE, non solo dopo?`;
            }
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function generateOptimizationResponse(userMessage, context) {
            const responses = [
                `Stiamo costruendo qualcosa di straordinario insieme. Ora voglio ottimizzare il sistema per il successo a lungo termine. Se tra 6 mesi dovessi aggiornare il tuo sistema perch√© √® diventato "troppo facile", come evolveresti? Come manterrai la sfida giusta?`,
                
                `Le nostre conversazioni mi stanno mostrando un sistema che ha potenziale per cambiare radicalmente la tua vita. Ma ora la domanda strategica: come userai il successo di questa abitudine per costruire la prossima? Qual √® l'effetto domino che vuoi creare?`,
                
                `Sento che abbiamo creato qualcosa di solido e sostenibile. Ora l'ottimizzazione finale: se dovessi insegnare questo sistema a qualcuno che ami, qual √® la parte pi√π importante che enfatizzeresti? Qual √® il "segreto nel segreto"?`,
                
                `Tutto quello che abbiamo esplorato si sta trasformando in un blueprint personale per il successo. Ultima domanda per sigillare tutto: tra un anno, quando questa abitudine sar√† cos√¨ naturale che nemmeno ci pensi pi√π, quale sar√† il regalo pi√π grande che ti avr√† fatto?`
            ];
            
            // Optimization based on their timeline
            if (context.actionPlanData.timeline) {
                return `Tutto quello che abbiamo costruito insieme sta prendendo forma in un sistema completo. Guardando la tua timeline di 12 settimane, vedo una progressione intelligente. Ma voglio aggiungere un elemento che distingue chi ha successo a lungo termine: la flessibilit√† strategica.

Il tuo piano √® il tuo GPS, ma cosa succede quando la strada √® bloccata? Come adatterai il sistema se la vita ti lancia una palla curva - un viaggio improvviso, un periodo di stress, un cambiamento di routine?

Non sto parlando di abbandonare il sistema, ma di renderlo anti-fragile. Come evolveresti ogni fase della tua timeline se le circostanze cambiassero? Quale √® il "core" non negoziabile e cosa invece pu√≤ essere adattato?`;
            }
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function extractActionInsights(userMessage) {
            // Extract key insights for system optimization
            const insights = [];
            
            if (userMessage.toLowerCase().includes('identit√†') || userMessage.toLowerCase().includes('diventare')) {
                insights.push('Focus sulla trasformazione di identit√†');
            }
            
            if (userMessage.toLowerCase().includes('resistenza') || userMessage.toLowerCase().includes('sabotare')) {
                insights.push('Consapevolezza delle resistenze interne');
            }
            
            if (userMessage.toLowerCase().includes('automatico') || userMessage.toLowerCase().includes('naturale')) {
                insights.push('Comprensione dell\'automatizzazione');
            }
            
            if (userMessage.toLowerCase().includes('flessibilit√†') || userMessage.toLowerCase().includes('adattare')) {
                insights.push('Attenzione alla flessibilit√† strategica');
            }
            
            if (userMessage.toLowerCase().includes('lungo termine') || userMessage.toLowerCase().includes('sostenibile')) {
                insights.push('Visione a lungo termine');
            }
            
            coachingInsights.push(...insights);
        }

        function show30MinuteWarning() {
            document.getElementById('timeWarning').classList.add('active');
        }

        function continueSession() {
            sessionExtended = true;
            document.getElementById('timeWarning').classList.remove('active');
            showMessage('‚úÖ Sessione estesa per ottimizzare il tuo sistema! Completiamo il capolavoro!', 'success');
        }

        function endSession() {
            clearInterval(timerInterval);
            clearInterval(autoSaveInterval);
            completeSession();
        }

        function completeSession() {
            // Save final session data
            const finalSessionData = {
                systemData: systemData,
                actionPlanData: actionPlanData,
                chatHistory: chatHistory,
                coachingInsights: coachingInsights,
                completedAt: new Date().toISOString(),
                sessionDuration: Date.now() - sessionStartTime,
                userProfile: userProfile,
                week1Data: week1Data,
                week2Data: week2Data,
                week3Data: week3Data
            };
            
            localStorage.setItem('week4SessionCompleted', JSON.stringify(finalSessionData));
            localStorage.removeItem('week4SessionInProgress');
            
            // Update progress
            updateUserProgress();
            
            // Show completion
            document.getElementById('phase2Section').classList.remove('active');
            document.getElementById('completionSection').classList.add('active');
            
            // Generate final system display
            generateFinalSystemDisplay();
            
            document.getElementById('completionSection').scrollIntoView({ behavior: 'smooth' });
        }

        function generateFinalSystemDisplay() {
            // Update habit loop visual
            updateHabitLoopVisual();
            
            // Generate complete system plan
            generateCompleteSystemPlan();
        }

        function updateHabitLoopVisual() {
            const triggerStep = document.getElementById('triggerStep');
            const routineStep = document.getElementById('routineStep');
            const rewardStep = document.getElementById('rewardStep');
            
            const triggerText = document.getElementById('triggerText');
            const routineText = document.getElementById('routineText');
            const rewardText = document.getElementById('rewardText');
            
            if (actionPlanData.trigger && actionPlanData.routine && actionPlanData.reward) {
                triggerText.textContent = actionPlanData.trigger.signal?.substring(0, 20) + '...' || 'Il tuo segnale';
                routineText.textContent = actionPlanData.routine.action?.substring(0, 20) + '...' || 'La tua azione';
                rewardText.textContent = actionPlanData.reward.celebration?.substring(0, 20) + '...' || 'La tua ricompensa';
            }
        }

        function generateCompleteSystemPlan() {
            const planEl = document.getElementById('finalSystemPlan');
            
            planEl.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                    
                    <div style="background: #fff7ed; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #ea580c;">
                        <h4 style="color: #ea580c; margin-bottom: 1rem;">üéØ IL TUO CICLO DELLE ABITUDINI</h4>
                        <p><strong>Trigger:</strong> ${actionPlanData.trigger?.signal || 'Segnale definito'}</p>
                        <p><strong>Contesto:</strong> ${actionPlanData.trigger?.context || 'Contesto specificato'}</p>
                        <p><strong>Routine:</strong> ${actionPlanData.routine?.action || 'Azione definita'}</p>
                        <p><strong>Durata:</strong> ${actionPlanData.routine?.duration || 'Tempo stabilito'}</p>
                        <p><strong>Reward:</strong> ${actionPlanData.reward?.celebration || 'Ricompensa pianificata'}</p>
                    </div>
                    
                    <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #16a34a;">
                        <h4 style="color: #16a34a; margin-bottom: 1rem;">üìÖ TIMELINE 12 SETTIMANE</h4>
                        <p><strong>Settimane 1-2:</strong> ${actionPlanData.timeline?.weeks1_2?.substring(0, 60) + '...' || 'Piano di impianto'}</p>
                        <p><strong>Settimane 3-4:</strong> ${actionPlanData.timeline?.weeks3_4?.substring(0, 60) + '...' || 'Piano di rinforzo'}</p>
                        <p><strong>Settimane 5-8:</strong> ${actionPlanData.timeline?.weeks5_8?.substring(0, 60) + '...' || 'Piano di espansione'}</p>
                        <p><strong>Settimane 9-12:</strong> ${actionPlanData.timeline?.weeks9_12?.substring(0, 60) + '...' || 'Piano di mastery'}</p>
                    </div>
                    
                    <div style="background: #eff6ff; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <h4 style="color: #3b82f6; margin-bottom: 1rem;">üìä SISTEMA DI MISURAZIONE</h4>
                        <p><strong>Giornaliero:</strong> ${actionPlanData.measurement?.daily || 'Metrica definita'}</p>
                        <p><strong>Settimanale:</strong> ${actionPlanData.measurement?.weekly?.substring(0, 40) + '...' || 'Revisione pianificata'}</p>
                        <p><strong>Celebrazione:</strong> ${actionPlanData.measurement?.celebration?.substring(0, 40) + '...' || 'Premi stabiliti'}</p>
                        <p><strong>Accountability:</strong> ${actionPlanData.measurement?.accountability || 'Supporto definito'}</p>
                    </div>
                    
                    <div style="background: #fef3c7; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <h4 style="color: #d97706; margin-bottom: 1rem;">üõ°Ô∏è PIANO DI EMERGENZA</h4>
                        <p><strong>Quando tutto va storto:</strong></p>
                        <p style="font-style: italic;">${actionPlanData.emergencyPlan || 'Piano di backup definito'}</p>
                        <p style="margin-top: 1rem; font-size: 0.9rem; color: #92400e;">
                            Ricorda: un giorno saltato non rovina il sistema. Due giorni di fila richiedono attenzione. Tre giorni richiedono ripartenza immediata.
                        </p>
                    </div>
                </div>
                
                <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 2rem; border-radius: 12px; margin-top: 2rem; text-align: center;">
                    <h4 style="color: #16a34a; margin-bottom: 1rem; font-size: 1.3rem;">üèÜ IL TUO MANTRA DEL SUCCESSO</h4>
                    <p style="color: #15803d; font-size: 1.1rem; font-style: italic; font-weight: 600;">
                        "Non sto solo cambiando quello che faccio, sto cambiando chi sono.
                        <br>Ogni azione √® un voto per la persona che sto diventando."
                    </p>
                </div>
            `;
        }

        function updateUserProgress() {
            try {
                const progress = JSON.parse(localStorage.getItem('lifestyleProgress') || '{}');
                progress.completedWeeks = progress.completedWeeks || [];
                
                if (!progress.completedWeeks.includes(4)) {
                    progress.completedWeeks.push(4);
                    progress.currentWeek = 'completed';
                    progress.lastUpdate = new Date().toISOString();
                    progress.programCompleted = true;
                    
                    localStorage.setItem('lifestyleProgress', JSON.stringify(progress));
                }
            } catch (error) {
                console.error('‚ùå Error updating progress:', error);
            }
        }

        function downloadCompletePlan() {
            const planContent = `
                PIANO DI AZIONE COMPLETO - SETTIMANA 4
                SISTEMA PER IL SUCCESSO AUTOMATICO
                
                Andrea Padoan - Lifestyle Coach
                Data: ${new Date().toLocaleDateString('it-IT')}
                
                Caro/a ${userProfile?.name || 'Amico/a'},
                
                üéâ CONGRATULAZIONI! Hai completato il percorso pi√π trasformativo che esista:
                da sogno vago a sistema concreto e automatico in 4 settimane!
                
                === IL TUO PERCORSO COMPLETO ===
                
                ${week1Data && week1Data.phase1Data ? 
                `SETTIMANA 1 - MAPPATURA E SOGNI
                Sogno principale: "${week1Data.phase1Data.dreamGoal || 'Trasformazione identificata'}"
                Area prioritaria scoperta: ${week1Data.phase1Data.priorityArea || 'Definita'}` : 
                'SETTIMANA 1 - Mappatura della situazione e identificazione sogni completata'}
                
                ${week2Data && week2Data.testResults ? 
                (() => {
                    const valueLabels = {
                        family: 'Famiglia e Relazioni',
                        career: 'Successo Professionale',
                        health: 'Salute e Benessere',
                        growth: 'Crescita Personale',
                        freedom: 'Libert√† e Indipendenza'
                    };
                    const topValue = week2Data.testResults.topValues?.[0]?.[0];
                    return `SETTIMANA 2 - VALORI E CONSAPEVOLEZZA
                Valore principale: ${valueLabels[topValue] || 'Identificato'}
                Punti di forza scoperti: ${week2Data.testResults.strengths?.join(', ') || 'Definiti'}`;
                })() : 
                'SETTIMANA 2 - Consapevolezza valori e auto-discovery completata'}
                
                ${week3Data && week3Data.smartGoalData ? 
                (() => {
                    const areaLabels = {
                        health: 'Salute Fisica',
                        mental: 'Benessere Mentale',
                        relationship: 'Relazioni',
                        career: 'Carriera e Crescita'
                    };
                    return `SETTIMANA 3 - OBIETTIVO SMART
                Area focus: ${areaLabels[week3Data.smartGoalData.area] || 'Definita'}
                Obiettivo SMART: "${week3Data.smartGoalData.specific?.substring(0, 100) + '...' || 'Obiettivo specifico definito'}"`;
                })() : 
                'SETTIMANA 3 - Obiettivo SMART creato e validato'}
                
                SETTIMANA 4 - SISTEMA DI AZIONE (OGGI!)
                Sistema completo di abitudini automatiche creato ‚úÖ
                
                === IL TUO SISTEMA DI SUCCESSO AUTOMATICO ===
                
                üîÑ CICLO DELLE ABITUDINI PERFETTO:
                
                üéØ TRIGGER (Il Segnale Automatico):
                COSA: ${actionPlanData.trigger?.signal || 'Segnale definito durante la sessione'}
                QUANDO/DOVE: ${actionPlanData.trigger?.context || 'Contesto specificato'}
                
                ‚ö° ROUTINE (L'Azione Che Cambia Tutto):
                AZIONE: ${actionPlanData.routine?.action || 'Azione definita durante la sessione'}
                DURATA: ${actionPlanData.routine?.duration || 'Tempo ottimale stabilito'}
                PERCH√â FUNZIONA: √à abbastanza piccola da essere facile, abbastanza significativa da fare la differenza
                
                üèÜ REWARD (La Ricompensa Che Rinforza):
                CELEBRAZIONE: ${actionPlanData.reward?.celebration || 'Ricompensa immediata pianificata'}
                MOTIVAZIONE: ${actionPlanData.reward?.motivation || 'Motivo personale identificato'}
                
                === LA TUA ROADMAP DI 12 SETTIMANE ===
                
                üìÖ SETTIMANE 1-2 - IMPIANTO (Costruire la Base):
                ${actionPlanData.timeline?.weeks1_2 || 'Piano di impianto personalizzato definito durante la sessione'}
                
                üí™ SETTIMANE 3-4 - RINFORZO (Consolidare l\'Abitudine):
                ${actionPlanData.timeline?.weeks3_4 || 'Piano di rinforzo personalizzato definito durante la sessione'}
                
                üöÄ SETTIMANE 5-8 - ESPANSIONE (Sviluppare la Potenza):
                ${actionPlanData.timeline?.weeks5_8 || 'Piano di espansione personalizzato definito durante la sessione'}
                
                üèÜ SETTIMANE 9-12 - MASTERY (Padronanza Automatica):
                ${actionPlanData.timeline?.weeks9_12 || 'Piano di mastery personalizzato definito durante la sessione'}
                
                === SISTEMA DI MISURAZIONE E ACCOUNTABILITY ===
                
                üìä CONTROLLO GIORNALIERO:
                Cosa misuri: ${actionPlanData.measurement?.daily || 'Metrica giornaliera definita'}
                Come: Segna ‚úÖ ogni giorno completato
                
                üîç REVISIONE SETTIMANALE (Ogni Domenica):
                ${actionPlanData.measurement?.weekly || 'Sistema di revisione settimanale definito'}
                
                üéâ SISTEMA DI CELEBRAZIONE:
                ${actionPlanData.measurement?.celebration || 'Piano di celebrazione dei progressi definito'}
                
                ü§ù ACCOUNTABILITY E SUPPORTO:
                ${actionPlanData.measurement?.accountability || 'Sistema di supporto definito'}
                
                === PIANO DI EMERGENZA (Quando Tutto Va Storto) ===
                
                üõ°Ô∏è IL TUO MINIMO NON NEGOZIABILE:
                ${actionPlanData.emergencyPlan || 'Piano di emergenza personalizzato definito'}
                
                REGOLA D'ORO:
                ‚Ä¢ 1 giorno saltato = Normale, riparti domani
                ‚Ä¢ 2 giorni di fila = Attenzione, analizza cosa √® successo
                ‚Ä¢ 3 giorni di fila = STOP. Riparti immediatamente con il piano di emergenza
                
                === INSIGHTS DAL TUO COACHING PERSONALIZZATO ===
                
                Durante le nostre conversazioni hai mostrato:
                ${coachingInsights.length > 0 ? coachingInsights.map(insight => `‚Ä¢ ${insight}`).join('\n                ') : '‚Ä¢ Profonda comprensione del processo di cambiamento\n                ‚Ä¢ Consapevolezza delle sfide e opportunit√†\n                ‚Ä¢ Commitment autentico verso la trasformazione'}
                
                === DOMANDE POTENTI PER MANTENERTI IN CARREGGIATA ===
                
                GIORNALIERE (Ogni mattina):
                ‚Ä¢ Chi sto diventando oggi attraverso le mie azioni?
                ‚Ä¢ La mia routine di oggi √® un voto per la persona che voglio essere?
                ‚Ä¢ Come posso onorare il mio impegno verso me stesso oggi?
                
                SETTIMANALI (Ogni domenica):
                ‚Ä¢ Questa settimana, come sono cresciuto verso la mia nuova identit√†?
                ‚Ä¢ Cosa ha funzionato meglio? Cosa posso ottimizzare?
                ‚Ä¢ Come posso celebrare i progressi fatti?
                
                MENSILI (Ogni primo del mese):
                ‚Ä¢ Il mio sistema sta ancora servendo i miei obiettivi pi√π grandi?
                ‚Ä¢ Come posso evolvere il sistema per la prossima fase?
                ‚Ä¢ Quali nuove abitudini positive posso aggiungere al sistema?
                
                === LA SCIENZA DIETRO IL TUO SUCCESSO ===
                
                Il tuo sistema √® basato su ricerche scientifiche comprovate:
                
                üß† NEUROPLASTICIT√Ä: Ogni ripetizione della tua routine crea nuovi percorsi neurali
                üìà COMPOUND EFFECT: Piccole azioni quotidiane = risultati straordinari nel tempo
                üîÑ HABIT LOOP: Trigger ‚Üí Routine ‚Üí Reward crea automatismo
                ‚è∞ 66 GIORNI: Il tempo medio per rendere automatica un'abitudine
                üí™ IDENTITY-BASED HABITS: Cambi chi sei, non solo quello che fai
                
                === IL TUO CERTIFICATO DI TRASFORMAZIONE ===
                
                üèÜ ${userProfile?.name || 'NOME'} HA COMPLETATO CON SUCCESSO:
                
                ‚úÖ Programma Lifestyle 4 Settimane - Da Sogno a Sistema
                ‚úÖ Mappatura completa della situazione di partenza
                ‚úÖ Identificazione valori autentici e motivazioni profonde
                ‚úÖ Creazione obiettivo SMART personalizzato
                ‚úÖ Costruzione sistema di abitudini automatiche
                ‚úÖ Piano d'azione concreto per i prossimi 90 giorni
                
                Data completamento: ${new Date().toLocaleDateString('it-IT')}
                Coach: Andrea Padoan
                
                === I TUOI PROSSIMI PASSI ===
                
                DOMANI MATTINA:
                1. Rileggi questo piano
                2. Prepara tutto il necessario per il tuo trigger
                3. Fai la prima routine seguendo il sistema
                4. Celebra immediatamente con il tuo reward
                5. Segna ‚úÖ sul calendario
                
                QUESTA SETTIMANA:
                ‚Ä¢ Segui il sistema ogni giorno
                ‚Ä¢ Non preoccuparti della perfezione, punta alla consistenza
                ‚Ä¢ Aggiusta se necessario, ma non abbandonare
                
                QUESTO MESE:
                ‚Ä¢ Lascia che l'abitudine si radichi
                ‚Ä¢ Nota i cambiamenti nell'identit√†
                ‚Ä¢ Celebra i progressi intermedi
                
                === MESSAGGI FINALI DAL TUO COACH ===
                
                ${userProfile?.name || 'Amico/a'}, quello che hai creato in queste 4 settimane non √® solo un piano, 
                √® una trasformazione completa del modo in cui approcci il cambiamento.
                
                Hai imparato il segreto che distingue chi realizza i propri sogni da chi li lascia 
                nei cassetti: SISTEMI che rendono il successo inevitabile.
                
                Il tuo sogno della Settimana 1 ora √® un sistema concreto.
                I tuoi valori della Settimana 2 ora guidano azioni quotidiane.
                Il tuo obiettivo SMART della Settimana 3 ora √® supportato da abitudini automatiche.
                Il tuo sistema della Settimana 4 ora render√† inevitabile la tua trasformazione.
                
                === RICORDA SEMPRE ===
                
                üéØ "Non stai solo cambiando quello che fai, stai cambiando chi sei"
                üîÑ "Ogni azione √® un voto per la persona che stai diventando"
                üí™ "Il successo non √® un evento, √® un sistema"
                üåü "La tua nuova identit√† √® gi√† qui, sta solo aspettando che tu la viva"
                
                Il tuo sistema √® pronto.
                Tu sei pronto.
                Il mondo ha bisogno della versione migliore di te.
                
                Vai e rendila realt√†!
                
                Con orgoglio e fiducia totale nel tuo successo,
                Andrea üöÄ
                
                P.S. Rileggi questo piano ogni luned√¨ per i primi 30 giorni. 
                Diventer√† il tuo GPS verso la trasformazione.
                
                P.P.S. Quando tra 3 mesi realizzerai che la tua abitudine √® diventata automatica, 
                ricordati di questo momento. Ricordati che tutto √® iniziato con una decisione: 
                scegliere di diventare la persona che merita i risultati che desideri.
                
                ---
                
                üéØ Per supporto continuo: www.andreapadoan.com
                üìß Per condividere il tuo successo: successo@andreapadoan.com
                
                QUESTO PIANO √à IL TUO BLUEPRINT PER IL SUCCESSO.
                CONSERVALO. SEGUILO. VIVILO.
            `;
            
            const blob = new Blob([planContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Sistema_Successo_Completo_${userProfile?.name || 'Utente'}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage('üìÑ Piano completo scaricato! Il tuo sistema di successo √® pronto!', 'success');
        }

        function downloadQuickStart() {
            const quickStartContent = `
                üöÄ QUICK START - INIZIA SUBITO!
                
                ${userProfile?.name || 'Nome'} - Sistema di Successo Automatico
                
                üéØ IL TUO CICLO DELLE ABITUDINI:
                
                TRIGGER: ${actionPlanData.trigger?.signal || 'Il tuo segnale'}
                ‚Üì
                ROUTINE: ${actionPlanData.routine?.action || 'La tua azione'}
                ‚Üì  
                REWARD: ${actionPlanData.reward?.celebration || 'La tua ricompensa'}
                
                ‚è∞ QUANDO: ${actionPlanData.trigger?.context || 'Momento specificato'}
                ‚åõ DURATA: ${actionPlanData.routine?.duration || 'Tempo definito'}
                
                üìä MISURA COS√å: ${actionPlanData.measurement?.daily || 'Metrica giornaliera'}
                
                üõ°Ô∏è SE VA TUTTO STORTO: ${actionPlanData.emergencyPlan || 'Piano di backup'}
                
                ü§ù SUPPORTO: ${actionPlanData.measurement?.accountability || 'Sistema di accountability'}
                
                === PRIMI 7 GIORNI ===
                
                ${actionPlanData.timeline?.weeks1_2?.substring(0, 200) + '...' || 'Piano per la prima settimana definito durante la sessione'}
                
                üí° RICORDA: Punta alla consistenza, non alla perfezione!
                
                üèÜ MANTRA: "Ogni azione √® un voto per chi sto diventando"
                
                INIZIA DOMANI MATTINA! üöÄ
            `;
            
            const blob = new Blob([quickStartContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Quick_Start_${userProfile?.name || 'Utente'}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage('‚ö° Quick Start scaricato! Tutto quello che serve per iniziare!', 'success');
        }

        function celebrateCompletion() {
            // Create celebration effect
            createCelebrationEffect();
            
            // Show completion message
            showMessage('üéâ CONGRATULAZIONI! Hai completato il percorso pi√π trasformativo che esista! Sei pronto per il successo automatico!', 'success');
            
            // Save celebration data
            const celebrationData = {
                completedAt: new Date().toISOString(),
                weekCompleted: 4,
                totalWeeks: 4,
                programCompleted: true
            };
            
            localStorage.setItem('programCelebration', JSON.stringify(celebrationData));
        }

        function createCelebrationEffect() {
            // Add celebration animation
            const celebration = document.createElement('div');
            celebration.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;">
                    <div style="position: absolute; top: 20%; left: 20%; font-size: 3rem; animation: bounce 2s infinite;">üéâ</div>
                    <div style="position: absolute; top: 30%; right: 20%; font-size: 2.5rem; animation: bounce 2s infinite 0.5s;">üöÄ</div>
                    <div style="position: absolute; bottom: 30%; left: 30%; font-size: 3rem; animation: bounce 2s infinite 1s;">üèÜ</div>
                    <div style="position: absolute; bottom: 20%; right: 30%; font-size: 2.5rem; animation: bounce 2s infinite 1.5s;">üåü</div>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; animation: pulse 3s infinite;">üí™</div>
                </div>
            `;
            
            document.body.appendChild(celebration);
            
            setTimeout(() => {
                celebration.remove();
            }, 8000);
        }

        function showMessage(message, type = 'info') {
            const colors = {
                success: '#16a34a',
                warning: '#f59e0b',
                info: '#3b82f6',
                error: '#ef4444'
            };
            
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: ${colors[type]}; color: white; padding: 1rem 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; max-width: 400px; animation: slideIn 0.3s ease-out;">
                    ${message}
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 8000);
        }

        // Handle Enter key in chat
        document.getElementById('chatInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            if (currentPhase !== 'completed') {
                autoSave();
            }
        });

        // Add animations CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes bounce {
                0%, 20%, 50%, 80%, 100% {
                    transform: translateY(0);
                }
                40% {
                    transform: translateY(-30px);
                }
                60% {
                    transform: translateY(-15px);
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>