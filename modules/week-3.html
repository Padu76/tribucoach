<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settimana 3 - Obiettivi SMART | Andrea Padoan Coach</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #fff7ed 50%, #f0fdf4 100%);
            min-height: 100vh;
            color: #1e293b;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .session-info {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .timer-display {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-bar {
            background: rgba(255,255,255,0.2);
            width: 200px;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            background: #22c55e;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .back-button {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            color: white;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Phase Indicator */
        .phase-indicator {
            background: white;
            border-radius: 12px;
            padding: 1rem 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .phase-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            min-width: 280px;
        }

        .phase-step.active {
            background: linear-gradient(135deg, #ea580c 0%, #fb923c 100%);
            color: white;
        }

        .phase-step.completed {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: white;
        }

        .phase-step.inactive {
            background: #f1f5f9;
            color: #94a3b8;
        }

        .phase-arrow {
            font-size: 1.5rem;
            color: #64748b;
        }

        /* Welcome Section */
        .welcome-section {
            background: white;
            border-radius: 16px;
            padding: 3rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            text-align: center;
        }

        .welcome-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 1rem;
        }

        .welcome-subtitle {
            font-size: 1.3rem;
            color: #ea580c;
            margin-bottom: 2rem;
        }

        .weeks-recap {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: left;
        }

        .recap-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #16a34a;
            margin-bottom: 1rem;
            text-align: center;
        }

        .process-explanation {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: left;
        }

        .process-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ea580c;
            margin-bottom: 1rem;
            text-align: center;
        }

        .process-steps {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .process-step {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #ea580c;
        }

        .step-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ea580c;
            margin-bottom: 0.5rem;
        }

        .step-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .step-description {
            font-size: 0.9rem;
            color: #64748b;
            line-height: 1.5;
        }

        .step-duration {
            font-size: 0.8rem;
            color: #ea580c;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        /* Phase 1 - SMART Workshop */
        .phase1-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: none;
        }

        .phase1-section.active {
            display: block;
        }

        .phase-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f1f5f9;
        }

        .phase-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .phase-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .phase-subtitle {
            font-size: 1rem;
            color: #64748b;
        }

        .workshop-progress {
            background: #f1f5f9;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .workshop-progress-text {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .workshop-progress-bar {
            background: #e2e8f0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .workshop-progress-fill {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .workshop-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 12px;
            border-left: 4px solid #ea580c;
        }

        .workshop-section h3 {
            color: #1e293b;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .workshop-intro {
            background: #fff7ed;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-style: italic;
            color: #ea580c;
        }

        .smart-method {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .smart-letter {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            text-align: center;
            transition: all 0.3s ease;
        }

        .smart-letter:hover {
            border-color: #ea580c;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(234, 88, 12, 0.2);
        }

        .smart-letter-title {
            font-size: 2rem;
            font-weight: bold;
            color: #ea580c;
            margin-bottom: 0.5rem;
        }

        .smart-letter-subtitle {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1rem;
        }

        .smart-letter-description {
            color: #64748b;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .exercise-group {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .exercise-title {
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1e293b;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #ea580c;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .priority-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .priority-area {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }

        .priority-area.selected {
            border-color: #ea580c;
            background: #fff7ed;
        }

        .priority-area h4 {
            color: #1e293b;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .priority-area p {
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .priority-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        /* Phase 2 - Coaching Approfondito */
        .phase2-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: none;
        }

        .phase2-section.active {
            display: block;
        }

        .coaching-context {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .coaching-context h3 {
            color: #16a34a;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .coaching-context p {
            color: #15803d;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .insights-summary {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #16a34a;
        }

        .insights-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .insights-list {
            list-style: none;
            padding: 0;
        }

        .insights-list li {
            padding: 0.25rem 0;
            color: #64748b;
            font-size: 0.9rem;
        }

        .chat-container {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 12px;
            max-width: 85%;
            animation: messageSlide 0.3s ease-out;
        }

        .message.coach {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            margin-right: auto;
        }

        .message.user {
            background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%);
            margin-left: auto;
            text-align: right;
        }

        .message-content {
            font-size: 1rem;
            line-height: 1.5;
            margin-bottom: 0.5rem;
        }

        .message-time {
            font-size: 0.8rem;
            color: #64748b;
        }

        .chat-input {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .chat-input input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .chat-input input:focus {
            outline: none;
            border-color: #ea580c;
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #16a34a;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .btn-secondary {
            background: white;
            color: #1e293b;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            border-color: #ea580c;
            color: #ea580c;
        }

        .btn-success {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
        }

        .btn-disabled {
            background: #94a3b8;
            color: white;
            cursor: not-allowed;
        }

        /* Navigation Buttons */
        .form-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        /* Time Warning */
        .time-warning {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }

        .time-warning.active {
            display: block;
        }

        /* Completion Section */
        .completion-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-top: 2rem;
            display: none;
        }

        .completion-section.active {
            display: block;
        }

        .completion-title {
            font-size: 2rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 1rem;
            text-align: center;
        }

        .completion-message {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #475569;
            margin-bottom: 2rem;
            text-align: center;
        }

        .smart-results {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .results-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #16a34a;
            margin-bottom: 1rem;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .result-item {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #16a34a;
        }

        .result-score {
            font-size: 2rem;
            font-weight: bold;
            color: #16a34a;
            margin-bottom: 0.5rem;
        }

        .result-label {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .result-feedback {
            font-size: 0.8rem;
            color: #15803d;
            font-style: italic;
        }

        .action-plan-section {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .action-plan-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ea580c;
            margin-bottom: 1rem;
        }

        .action-plan-list {
            list-style: none;
            padding: 0;
        }

        .action-plan-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(234, 88, 12, 0.2);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-plan-list li:last-child {
            border-bottom: none;
        }

        .completion-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* Animations */
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }
            
            .process-steps {
                grid-template-columns: 1fr;
            }
            
            .phase-indicator {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .phase-step {
                min-width: auto;
                width: 100%;
                justify-content: center;
            }
            
            .phase-arrow {
                transform: rotate(90deg);
            }
            
            .smart-method {
                grid-template-columns: 1fr;
            }
            
            .priority-grid {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">üéØ Settimana 3 - Obiettivi SMART</div>
            <div class="session-info">
                <div class="timer-display">
                    ‚è±Ô∏è <span id="sessionTimer">40:00</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="sessionProgress"></div>
                </div>
                <a href="module-hub.html" class="back-button">‚Üê Torna ai Moduli</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Phase Indicator -->
        <div class="phase-indicator">
            <div class="phase-step active" id="phaseStep1">
                <span>üéØ</span>
                <span>Fase 1: Workshop SMART + Esercizi</span>
            </div>
            <div class="phase-arrow">‚Üí</div>
            <div class="phase-step inactive" id="phaseStep2">
                <span>ü§ñ</span>
                <span>Fase 2: Coaching Obiettivi Autentici</span>
            </div>
        </div>

        <!-- Welcome Section -->
        <section class="welcome-section fade-in" id="welcomeSection">
            <h1 class="welcome-title">Benvenuto nella Settimana 3! üéØ</h1>
            <p class="welcome-subtitle">Obiettivi SMART - Trasforma i sogni in realt√† concrete</p>
            
            <div class="weeks-recap">
                <h3 class="recap-title">üß† Il Percorso Fatto Insieme</h3>
                <div id="weeksRecap">
                    <p><strong>Settimana 1:</strong> Abbiamo mappato la tua situazione e scoperto i tuoi obiettivi autentici</p>
                    <p><strong>Settimana 2:</strong> Hai sviluppato consapevolezza profonda di chi sei e dei tuoi valori</p>
                    <p style="margin-top: 1rem; font-style: italic; color: #ea580c;">
                        Oggi utilizzeremo tutta questa consapevolezza per creare obiettivi SMART che rispecchiano veramente chi sei.
                    </p>
                </div>
            </div>
            
            <div class="process-explanation">
                <h3 class="process-title">üéØ Il Tuo Workshop SMART Personalizzato</h3>
                <div class="process-steps">
                    <div class="process-step">
                        <div class="step-number">1</div>
                        <div class="step-title">Workshop SMART + Esercizi</div>
                        <div class="step-description">
                            Impari la metodologia SMART e la applichi subito ai tuoi obiettivi personali
                            per le 4 aree di benessere, con prioritizzazione strategica.
                        </div>
                        <div class="step-duration">‚è±Ô∏è 12-15 minuti</div>
                    </div>
                    <div class="process-step">
                        <div class="step-number">2</div>
                        <div class="step-title">Coaching Obiettivi Autentici</div>
                        <div class="step-description">
                            Insieme verificheremo che i tuoi obiettivi siano allineati con i tuoi valori
                            e creeremo il piano d'azione concreto per realizzarli.
                        </div>
                        <div class="step-duration">‚è±Ô∏è 25-28 minuti</div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="startPhase1()">
                üöÄ Inizia il Workshop SMART Personalizzato
            </button>
        </section>

        <!-- Phase 1: SMART Workshop -->
        <section class="phase1-section" id="phase1Section">
            <div class="phase-header">
                <div class="phase-icon">üéØ</div>
                <div>
                    <h2 class="phase-title">Fase 1: Workshop SMART + Esercizi Pratici</h2>
                    <p class="phase-subtitle">Impara e applica subito la metodologia per obiettivi concreti</p>
                </div>
            </div>
            
            <div class="workshop-progress">
                <div class="workshop-progress-text">Progresso workshop: <span id="workshopProgress">0%</span></div>
                <div class="workshop-progress-bar">
                    <div class="workshop-progress-fill" id="workshopProgressFill" style="width: 0%"></div>
                </div>
            </div>

            <!-- Metodologia SMART -->
            <div class="workshop-section" id="smartMethod">
                <h3>üìö La Metodologia SMART - La Tua Guida per Obiettivi Concreti</h3>
                <div class="workshop-intro">
                    La metodologia SMART trasforma i desideri vaghi in obiettivi raggiungibili. 
                    Ogni lettera rappresenta un criterio che render√† i tuoi obiettivi chiari e realizzabili.
                </div>
                
                <div class="smart-method">
                    <div class="smart-letter">
                        <div class="smart-letter-title">S</div>
                        <div class="smart-letter-subtitle">Specifico</div>
                        <div class="smart-letter-description">
                            L'obiettivo deve rispondere a: Cosa esattamente vuoi raggiungere? 
                            Chi √® coinvolto? Dove accadr√†? Perch√© √® importante?
                        </div>
                    </div>
                    
                    <div class="smart-letter">
                        <div class="smart-letter-title">M</div>
                        <div class="smart-letter-subtitle">Misurabile</div>
                        <div class="smart-letter-description">
                            Deve avere indicatori quantificabili. Come saprai di aver raggiunto l'obiettivo? 
                            Quanti, quanto spesso, quale percentuale?
                        </div>
                    </div>
                    
                    <div class="smart-letter">
                        <div class="smart-letter-title">A</div>
                        <div class="smart-letter-subtitle">Raggiungibile</div>
                        <div class="smart-letter-description">
                            Sfidante ma realistico. Hai le competenze, risorse e tempo necessari? 
                            √à abbastanza ambizioso da motivarti?
                        </div>
                    </div>
                    
                    <div class="smart-letter">
                        <div class="smart-letter-title">R</div>
                        <div class="smart-letter-subtitle">Rilevante</div>
                        <div class="smart-letter-description">
                            Allineato con i tuoi valori e priorit√† di vita. √à importante per te? 
                            Si collega ai tuoi obiettivi pi√π grandi?
                        </div>
                    </div>
                    
                    <div class="smart-letter">
                        <div class="smart-letter-title">T</div>
                        <div class="smart-letter-subtitle">Temporizzato</div>
                        <div class="smart-letter-description">
                            Ha una scadenza chiara. Entro quando? Con milestone intermedie? 
                            Crea urgenza costruttiva senza stress.
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-secondary" onclick="markMethodLearned()" style="margin-top: 1rem;">
                    ‚úÖ Ho compreso la metodologia, continua
                </button>
            </div>

            <!-- Identificazione Obiettivi -->
            <div class="workshop-section" id="goalsIdentification" style="display: none;">
                <h3>üéØ Identifica i Tuoi Obiettivi per le 4 Aree di Benessere</h3>
                <div class="workshop-intro">
                    Basandoti sulla consapevolezza sviluppata nelle settimane precedenti, 
                    identifica un obiettivo importante per ogni area del tuo benessere.
                </div>
                
                <div class="priority-grid">
                    <div class="priority-area">
                        <h4>üí™ Salute Fisica</h4>
                        <p>Energia, forma fisica, alimentazione, sport</p>
                        <textarea class="priority-input" id="healthGoal" placeholder="Es: Correre 5km senza fermarmi entro 3 mesi attraverso un programma di allenamento progressivo..." onchange="updateWorkshopProgress(); autoSave()"></textarea>
                    </div>
                    
                    <div class="priority-area">
                        <h4>üß† Benessere Mentale</h4>
                        <p>Stress, mindfulness, crescita personale</p>
                        <textarea class="priority-input" id="mentalGoal" placeholder="Es: Ridurre i livelli di stress del 50% nei prossimi 6 mesi praticando meditazione quotidiana..." onchange="updateWorkshopProgress(); autoSave()"></textarea>
                    </div>
                    
                    <div class="priority-area">
                        <h4>‚ù§Ô∏è Relazioni</h4>
                        <p>Famiglia, amici, partner, colleghi</p>
                        <textarea class="priority-input" id="relationshipGoal" placeholder="Es: Migliorare la comunicazione con il partner attraverso 30 minuti di dialogo qualitativo ogni sera..." onchange="updateWorkshopProgress(); autoSave()"></textarea>
                    </div>
                    
                    <div class="priority-area">
                        <h4>üíº Carriera/Crescita</h4>
                        <p>Lavoro, progetti, competenze, finanze</p>
                        <textarea class="priority-input" id="careerGoal" placeholder="Es: Ottenere una promozione entro 12 mesi sviluppando competenze di leadership attraverso un corso certificato..." onchange="updateWorkshopProgress(); autoSave()"></textarea>
                    </div>
                </div>
            </div>

            <!-- Applicazione SMART -->
            <div class="workshop-section" id="smartApplication" style="display: none;">
                <h3>üîß Trasforma UN Obiettivo in SMART</h3>
                <div class="workshop-intro">
                    Scegli l'obiettivo pi√π importante per te in questo momento e lo trasformiamo insieme in formato SMART.
                </div>
                
                <div class="form-group">
                    <label for="priorityGoal">Quale obiettivo vuoi rendere SMART?</label>
                    <select id="priorityGoal" onchange="updateWorkshopProgress(); autoSave()">
                        <option value="">Seleziona l'obiettivo prioritario...</option>
                        <option value="health">Salute Fisica</option>
                        <option value="mental">Benessere Mentale</option>
                        <option value="relationship">Relazioni</option>
                        <option value="career">Carriera/Crescita</option>
                    </select>
                </div>

                <div class="exercise-group">
                    <div class="exercise-title">üéØ SPECIFICO - Cosa esattamente vuoi raggiungere?</div>
                    <div class="form-group">
                        <label for="specificGoal">Descrivi in dettaglio l'obiettivo</label>
                        <textarea id="specificGoal" placeholder="Cosa, chi, dove, perch√© in modo molto specifico..." onchange="updateWorkshopProgress(); autoSave()"></textarea>
                    </div>
                </div>

                <div class="exercise-group">
                    <div class="exercise-title">üìä MISURABILE - Come misurerai il progresso?</div>
                    <div class="form-group">
                        <label for="measurableGoal">Indica metriche precise e indicatori</label>
                        <textarea id="measurableGoal" placeholder="Numeri, percentuali, frequenze, quantit√† specifiche..." onchange="updateWorkshopProgress(); autoSave()"></textarea>
                    </div>
                </div>

                <div class="exercise-group">
                    <div class="exercise-title">‚úÖ RAGGIUNGIBILE - √à realisticamente possibile?</div>
                    <div class="form-group">
                        <label for="achievableGoal">Analizza risorse, competenze e ostacoli</label>
                        <textarea id="achievableGoal" placeholder="Hai le competenze? Le risorse? Quanto √® sfidante ma realistico?" onchange="updateWorkshopProgress(); autoSave()"></textarea>
                    </div>
                </div>

                <div class="exercise-group">
                    <div class="exercise-title">üéØ RILEVANTE - Perch√© √® importante per te?</div>
                    <div class="form-group">
                        <label for="relevantGoal">Connessione con valori e priorit√† di vita</label>
                        <textarea id="relevantGoal" placeholder="Come si allinea con i tuoi valori scoperti in Settimana 2?" onchange="updateWorkshopProgress(); autoSave()"></textarea>
                    </div>
                </div>

                <div class="exercise-group">
                    <div class="exercise-title">‚è∞ TEMPORIZZATO - Quando e con che milestone?</div>
                    <div class="form-group">
                        <label for="timeGoal">Data finale e tappe intermedie</label>
                        <textarea id="timeGoal" placeholder="Data finale, milestone mensili, check-in settimanali..." onchange="updateWorkshopProgress(); autoSave()"></textarea>
                    </div>
                </div>
            </div>

            <!-- Prioritizzazione -->
            <div class="workshop-section" id="prioritization" style="display: none;">
                <h3>üìã Prioritizzazione Strategica</h3>
                <div class="workshop-intro">
                    Ora che hai un obiettivo SMART, definiamo le priorit√† per i prossimi 90 giorni.
                </div>
                
                <div class="form-group">
                    <label for="next90Days">Qual √® la PRIMA azione concreta che farai nei prossimi 7 giorni?</label>
                    <textarea id="next90Days" placeholder="Azione specifica, piccola ma significativa..." onchange="updateWorkshopProgress(); autoSave()"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="obstacles">Quali ostacoli prevedi e come li supererai?</label>
                    <textarea id="obstacles" placeholder="3 ostacoli principali e relative soluzioni..." onchange="updateWorkshopProgress(); autoSave()"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="accountability">Chi o cosa ti aiuter√† a rimanere sulla strada?</label>
                    <textarea id="accountability" placeholder="Sistema di accountability, persone di supporto..." onchange="updateWorkshopProgress(); autoSave()"></textarea>
                </div>
            </div>

            <div class="form-navigation">
                <button type="button" class="btn btn-success" id="completeWorkshopBtn" onclick="completePhase1()" disabled>
                    ‚úÖ Completa Workshop e Inizia Coaching Personalizzato
                </button>
            </div>
        </section>

        <!-- Phase 2: Coaching Approfondito -->
        <section class="phase2-section" id="phase2Section">
            <div class="phase-header">
                <div class="phase-icon">ü§ñ</div>
                <div>
                    <h2 class="phase-title">Fase 2: Coaching per Obiettivi Autentici</h2>
                    <p class="phase-subtitle">Verifichiamo allineamento con i valori e creiamo il piano concreto</p>
                </div>
            </div>
            
            <div class="coaching-context">
                <h3>üåü Il Tuo Obiettivo SMART Personalizzato</h3>
                <p>
                    Fantastico! Hai appena trasformato un desiderio in un obiettivo concreto e realizzabile.
                    Ora voglio assicurarmi che questo obiettivo sia perfettamente allineato con chi sei veramente
                    e aiutarti a creare un piano d'azione che funzioni nella tua vita reale.
                </p>
                
                <div class="insights-summary">
                    <div class="insights-title">üéØ Il Tuo Obiettivo SMART:</div>
                    <ul class="insights-list" id="smartSummary">
                        <li>In elaborazione del tuo obiettivo personalizzato...</li>
                    </ul>
                </div>
            </div>
            
            <div class="time-warning" id="timeWarning">
                <strong>‚è∞ Abbiamo raggiunto i 30 minuti!</strong> Vuoi continuare per altri 10 minuti o preferisci terminare ora?
                <div style="margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="continueSession()">Continua</button>
                    <button class="btn btn-primary" onclick="endSession()">Termina Ora</button>
                </div>
            </div>
            
            <div class="chat-status">
                <div class="status-dot"></div>
                <span>Andrea √® pronto per perfezionare il tuo obiettivo e creare il piano d'azione</span>
            </div>
            
            <div class="chat-container" id="chatContainer">
                <!-- Messages will be added here -->
            </div>
            
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="Condividi le tue riflessioni con Andrea...">
                <button class="btn btn-primary" onclick="sendChatMessage()">Invia</button>
            </div>
        </section>

        <!-- Completion Section -->
        <section class="completion-section" id="completionSection">
            <h2 class="completion-title">üéØ Obiettivi SMART Completati!</h2>
            <p class="completion-message">
                Incredibile! Hai trasformato un sogno vago in un obiettivo SMART concreto e realizzabile. 
                Con la consapevolezza delle settimane precedenti e questo piano d'azione, hai tutto quello che serve per avere successo.
            </p>
            
            <div class="smart-results">
                <h3 class="results-title">üèÜ Il Tuo Obiettivo SMART Personalizzato</h3>
                <div id="finalSmartGoal">
                    <!-- Will be populated with SMART goal -->
                </div>
            </div>
            
            <div class="action-plan-section">
                <h3 class="action-plan-title">üöÄ Il Tuo Piano d'Azione Settimanale</h3>
                <ul class="action-plan-list" id="personalizedActionPlan">
                    <!-- Will be generated based on SMART goal and coaching -->
                </ul>
            </div>
            
            <div class="completion-actions">
                <button class="btn btn-success" onclick="downloadSmartPlan()">üìÑ Scarica Piano SMART</button>
                <a href="module-hub.html" class="btn btn-secondary">‚Üê Torna ai Moduli</a>
                <button class="btn btn-primary" onclick="scheduleNextSession()">üìÖ Programma Settimana 4</button>
            </div>
        </section>
    </main>

    <script>
        // Session variables
        let sessionStartTime = Date.now();
        let sessionDuration = 40 * 60 * 1000; // 40 minutes
        let timerInterval;
        let currentPhase = 'welcome';
        let workshopData = {};
        let smartGoalData = {};
        let chatHistory = [];
        let userProfile = null;
        let week1Data = null;
        let week2Data = null;
        let sessionExtended = false;
        let autoSaveInterval;
        let coachingInsights = [];

        // Initialize session
        document.addEventListener('DOMContentLoaded', function() {
            startSessionTimer();
            loadUserProfile();
            loadPreviousWeeks();
            loadSavedSession();
            startAutoSave();
        });

        function startSessionTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - sessionStartTime;
                const remaining = Math.max(0, sessionDuration - elapsed);
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                
                document.getElementById('sessionTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const progress = (elapsed / sessionDuration) * 100;
                document.getElementById('sessionProgress').style.width = `${Math.min(progress, 100)}%`;
                
                // Check for 30 minute warning
                if (elapsed >= 30 * 60 * 1000 && !sessionExtended && currentPhase === 'phase2') {
                    show30MinuteWarning();
                }
                
                // Auto-end at 40 minutes
                if (remaining === 0) {
                    clearInterval(timerInterval);
                    endSession();
                }
            }, 1000);
        }

        function loadUserProfile() {
            try {
                const savedData = localStorage.getItem('lifestyleQuizResults');
                if (savedData) {
                    userProfile = JSON.parse(savedData);
                    console.log('‚úÖ User profile loaded:', userProfile);
                }
            } catch (error) {
                console.error('‚ùå Error loading user profile:', error);
            }
        }

        function loadPreviousWeeks() {
            try {
                const week1SessionData = localStorage.getItem('week1SessionCompleted');
                if (week1SessionData) {
                    week1Data = JSON.parse(week1SessionData);
                    console.log('‚úÖ Week 1 data loaded:', week1Data);
                }

                const week2SessionData = localStorage.getItem('week2SessionCompleted');
                if (week2SessionData) {
                    week2Data = JSON.parse(week2SessionData);
                    console.log('‚úÖ Week 2 data loaded:', week2Data);
                }
                
                displayWeeksRecap();
            } catch (error) {
                console.error('‚ùå Error loading previous weeks data:', error);
                displayDefaultRecap();
            }
        }

        function displayWeeksRecap() {
            const recapEl = document.getElementById('weeksRecap');
            let content = '<p><strong>Il tuo percorso finora:</strong></p>';
            
            if (week1Data && week1Data.phase1Data) {
                content += `<p><strong>Settimana 1:</strong> Hai identificato come obiettivo principale "${week1Data.phase1Data.dreamGoal || 'la tua trasformazione'}"</p>`;
            }
            
            if (week2Data && week2Data.testResults) {
                const topValue = week2Data.testResults.topValues && week2Data.testResults.topValues.length > 0 ? 
                    (() => {
                        const valueLabels = {
                            family: 'famiglia e relazioni',
                            career: 'successo professionale',
                            health: 'salute e benessere',
                            growth: 'crescita personale',
                            freedom: 'libert√† e indipendenza'
                        };
                        return valueLabels[week2Data.testResults.topValues[0][0]];
                    })() : 'valori personali';
                content += `<p><strong>Settimana 2:</strong> Hai scoperto che il tuo valore principale √® ${topValue}</p>`;
            }
            
            content += `<p style="margin-top: 1rem; font-style: italic; color: #ea580c;">
                Oggi useremo tutto questo per creare obiettivi che rispecchiano davvero chi sei e cosa vuoi raggiungere.
            </p>`;
            
            recapEl.innerHTML = content;
        }

        function displayDefaultRecap() {
            const recapEl = document.getElementById('weeksRecap');
            recapEl.innerHTML = `
                <p><strong>Settimana 1:</strong> Abbiamo mappato la tua situazione e scoperto i tuoi obiettivi autentici</p>
                <p><strong>Settimana 2:</strong> Hai sviluppato consapevolezza profonda di chi sei e dei tuoi valori</p>
                <p style="margin-top: 1rem; font-style: italic; color: #ea580c;">
                    Oggi utilizzeremo tutta questa consapevolezza per creare obiettivi SMART che rispecchiano veramente chi sei.
                </p>
            `;
        }

        function loadSavedSession() {
            try {
                const savedSession = localStorage.getItem('week3SessionInProgress');
                if (savedSession) {
                    const sessionData = JSON.parse(savedSession);
                    
                    // Restore workshop data
                    if (sessionData.workshopData) {
                        workshopData = sessionData.workshopData;
                        restoreWorkshopAnswers();
                    }
                    
                    // Restore SMART goal data
                    if (sessionData.smartGoalData) {
                        smartGoalData = sessionData.smartGoalData;
                    }
                    
                    // Restore chat history
                    if (sessionData.chatHistory) {
                        chatHistory = sessionData.chatHistory;
                    }
                    
                    // Restore current phase
                    if (sessionData.currentPhase) {
                        currentPhase = sessionData.currentPhase;
                        
                        if (currentPhase === 'phase1') {
                            startPhase1();
                        } else if (currentPhase === 'phase2') {
                            startPhase2();
                            restoreChatHistory();
                        }
                    }
                    
                    console.log('‚úÖ Session restored from:', sessionData);
                }
            } catch (error) {
                console.error('‚ùå Error loading saved session:', error);
            }
        }

        function restoreWorkshopAnswers() {
            Object.entries(workshopData).forEach(([key, value]) => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = value;
                }
            });
            updateWorkshopProgress();
        }

        function startAutoSave() {
            autoSaveInterval = setInterval(() => {
                autoSave();
            }, 5000);
        }

        function autoSave() {
            try {
                const sessionData = {
                    currentPhase: currentPhase,
                    workshopData: workshopData,
                    smartGoalData: smartGoalData,
                    chatHistory: chatHistory,
                    coachingInsights: coachingInsights,
                    sessionStartTime: sessionStartTime,
                    lastSaved: new Date().toISOString()
                };
                
                localStorage.setItem('week3SessionInProgress', JSON.stringify(sessionData));
            } catch (error) {
                console.error('‚ùå Error auto-saving:', error);
            }
        }

        function startPhase1() {
            currentPhase = 'phase1';
            
            // Hide welcome, show phase 1
            document.getElementById('welcomeSection').style.display = 'none';
            document.getElementById('phase1Section').classList.add('active');
            
            // Update phase indicator
            document.getElementById('phaseStep1').className = 'phase-step active';
            document.getElementById('phaseStep2').className = 'phase-step inactive';
            
            updateWorkshopProgress();
            autoSave();
        }

        function markMethodLearned() {
            workshopData.methodLearned = true;
            document.getElementById('smartMethod').style.display = 'none';
            document.getElementById('goalsIdentification').style.display = 'block';
            updateWorkshopProgress();
            autoSave();
        }

        function updateWorkshopProgress() {
            // Calculate progress based on completed sections
            let progress = 0;
            let totalSections = 5;
            
            // Method learned
            if (workshopData.methodLearned) progress++;
            
            // Goals identified (4 areas)
            const goalFields = ['healthGoal', 'mentalGoal', 'relationshipGoal', 'careerGoal'];
            const filledGoals = goalFields.filter(field => {
                const element = document.getElementById(field);
                if (element && element.value.trim()) {
                    workshopData[field] = element.value.trim();
                    return true;
                }
                return false;
            });
            
            if (filledGoals.length === 4) {
                progress++;
                // Show SMART application section
                if (document.getElementById('smartApplication').style.display === 'none') {
                    document.getElementById('smartApplication').style.display = 'block';
                }
            }
            
            // SMART application
            const smartFields = ['priorityGoal', 'specificGoal', 'measurableGoal', 'achievableGoal', 'relevantGoal', 'timeGoal'];
            const filledSmart = smartFields.filter(field => {
                const element = document.getElementById(field);
                if (element && element.value.trim()) {
                    workshopData[field] = element.value.trim();
                    return true;
                }
                return false;
            });
            
            if (filledSmart.length === 6) {
                progress++;
                // Show prioritization section
                if (document.getElementById('prioritization').style.display === 'none') {
                    document.getElementById('prioritization').style.display = 'block';
                }
            }
            
            // Prioritization
            const priorityFields = ['next90Days', 'obstacles', 'accountability'];
            const filledPriority = priorityFields.filter(field => {
                const element = document.getElementById(field);
                if (element && element.value.trim()) {
                    workshopData[field] = element.value.trim();
                    return true;
                }
                return false;
            });
            
            if (filledPriority.length === 3) {
                progress++;
            }
            
            const progressPercentage = (progress / totalSections) * 100;
            document.getElementById('workshopProgress').textContent = `${Math.round(progressPercentage)}%`;
            document.getElementById('workshopProgressFill').style.width = `${progressPercentage}%`;
            
            // Enable/disable complete button
            const completeBtn = document.getElementById('completeWorkshopBtn');
            if (progressPercentage === 100) {
                completeBtn.disabled = false;
                completeBtn.className = 'btn btn-success';
            } else {
                completeBtn.disabled = true;
                completeBtn.className = 'btn btn-disabled';
            }
        }

        function completePhase1() {
            // Process SMART goal data
            processSmartGoal();
            
            // Mark phase 1 as completed
            document.getElementById('phaseStep1').className = 'phase-step completed';
            
            // Start phase 2
            startPhase2();
        }

        function processSmartGoal() {
            const priorityArea = workshopData.priorityGoal;
            
            smartGoalData = {
                area: priorityArea,
                specific: workshopData.specificGoal,
                measurable: workshopData.measurableGoal,
                achievable: workshopData.achievableGoal,
                relevant: workshopData.relevantGoal,
                timebound: workshopData.timeGoal,
                nextAction: workshopData.next90Days,
                obstacles: workshopData.obstacles,
                accountability: workshopData.accountability
            };
            
            // Generate coaching insights
            generateSmartInsights();
        }

        function generateSmartInsights() {
            coachingInsights = [];
            
            // Analyze SMART goal quality
            if (smartGoalData.specific && smartGoalData.specific.length > 50) {
                coachingInsights.push('Obiettivo ben dettagliato e specifico');
            }
            
            if (smartGoalData.measurable && (smartGoalData.measurable.includes('%') || smartGoalData.measurable.includes('kg') || smartGoalData.measurable.includes('volte'))) {
                coachingInsights.push('Metriche quantificabili identificate');
            }
            
            if (smartGoalData.relevant && (smartGoalData.relevant.includes('valore') || smartGoalData.relevant.includes('importante'))) {
                coachingInsights.push('Forte allineamento con valori personali');
            }
            
            if (smartGoalData.nextAction && smartGoalData.nextAction.length > 30) {
                coachingInsights.push('Piano d\'azione concreto definito');
            }
        }

        function startPhase2() {
            currentPhase = 'phase2';
            
            // Hide phase 1, show phase 2
            document.getElementById('phase1Section').classList.remove('active');
            document.getElementById('phase2Section').classList.add('active');
            
            // Update phase indicator
            document.getElementById('phaseStep2').className = 'phase-step active';
            
            // Display SMART summary
            displaySmartSummary();
            
            // Generate first coaching question
            generateFirstCoachingQuestion();
            
            autoSave();
        }

        function displaySmartSummary() {
            const summaryEl = document.getElementById('smartSummary');
            if (smartGoalData.specific) {
                const areaLabels = {
                    health: 'Salute Fisica',
                    mental: 'Benessere Mentale',
                    relationship: 'Relazioni',
                    career: 'Carriera/Crescita'
                };
                
                const areaLabel = areaLabels[smartGoalData.area] || 'Area selezionata';
                
                summaryEl.innerHTML = `
                    <li><strong>Area:</strong> ${areaLabel}</li>
                    <li><strong>Obiettivo:</strong> ${smartGoalData.specific.substring(0, 100)}...</li>
                    <li><strong>Misurabile:</strong> ${smartGoalData.measurable.substring(0, 80)}...</li>
                    <li><strong>Scadenza:</strong> ${smartGoalData.timebound.substring(0, 60)}...</li>
                `;
            } else {
                summaryEl.innerHTML = '<li>Elaborazione del tuo obiettivo SMART in corso...</li>';
            }
        }

        function generateFirstCoachingQuestion() {
            if (chatHistory.length === 0) {
                const firstQuestion = generatePowerfulSmartQuestion();
                addChatMessage(firstQuestion, 'coach');
            } else {
                restoreChatHistory();
            }
        }

        function generatePowerfulSmartQuestion() {
            let question = `Complimenti! Hai appena creato un obiettivo SMART davvero potente. `;
            
            const areaLabels = {
                health: 'salute fisica',
                mental: 'benessere mentale',
                relationship: 'relazioni',
                career: 'carriera e crescita'
            };
            
            const areaLabel = areaLabels[smartGoalData.area] || 'area scelta';
            
            question += `Vedo che hai scelto di concentrarti sulla tua ${areaLabel}, e questo mi dice molto delle tue priorit√† attuali. `;
            
            // Reference their specific goal
            if (smartGoalData.specific) {
                question += `Il tuo obiettivo: "${smartGoalData.specific}" ha una chiarezza che mi colpisce. `;
            }
            
            // Connect to their values from Week 2
            if (week2Data && week2Data.testResults && week2Data.testResults.topValues) {
                const valueLabels = {
                    family: 'famiglia e relazioni',
                    career: 'successo professionale',
                    health: 'salute e benessere',
                    growth: 'crescita personale',
                    freedom: 'libert√† e indipendenza'
                };
                const topValue = valueLabels[week2Data.testResults.topValues[0][0]];
                question += `E questo si allinea perfettamente con il tuo valore principale che abbiamo scoperto la settimana scorsa: ${topValue}. `;
            }
            
            // Powerful coaching question
            question += `\n\nOra voglio farti una domanda che va al cuore della motivazione: 
            
**Quando avrai raggiunto questo obiettivo, chi sarai diventato? Non solo cosa avrai ottenuto, ma che tipo di persona sarai? Cosa cambier√† nel modo in cui ti vedi e ti muovi nel mondo?** üåü
            
Prenditi tutto il tempo che serve. Questa risposta √® la chiave per mantenere la motivazione nei momenti difficili.`;
            
            return question;
        }

        function restoreChatHistory() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '';
            
            chatHistory.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.sender}`;
                messageDiv.innerHTML = `
                    <div class="message-content">${message.content}</div>
                    <div class="message-time">${message.time}</div>
                `;
                chatContainer.appendChild(messageDiv);
            });
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addChatMessage(message, 'user');
            input.value = '';
            
            // Get AI coaching response
            try {
                const coachingResponse = await getSmartCoachingResponse(message);
                setTimeout(() => {
                    addChatMessage(coachingResponse, 'coach');
                }, 1500);
            } catch (error) {
                console.error('‚ùå Error getting coaching response:', error);
                setTimeout(() => {
                    addChatMessage("Dammi un momento per elaborare la tua risposta... Puoi ripetere?", 'coach');
                }, 1000);
            }
        }

        function addChatMessage(content, sender) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const now = new Date();
            const time = now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-content">${content}</div>
                <div class="message-time">${time}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Store in history
            chatHistory.push({ sender, content, time });
            
            // Extract insights if it's a user message
            if (sender === 'user') {
                extractSmartInsights(content);
            }
            
            autoSave();
        }

        async function getSmartCoachingResponse(userMessage) {
            // Build comprehensive context for SMART coaching
            const coachingContext = {
                workshopData: workshopData,
                smartGoalData: smartGoalData,
                chatHistory: chatHistory,
                coachingInsights: coachingInsights,
                week1Data: week1Data,
                week2Data: week2Data,
                userProfile: userProfile
            };
            
            // Fallback to sophisticated SMART coaching response
            return generateSmartCoachingResponse(userMessage, coachingContext);
        }

        function generateSmartCoachingResponse(userMessage, context) {
            const messageCount = context.chatHistory.filter(m => m.sender === 'user').length;
            
            // Different coaching approaches based on conversation depth
            if (messageCount <= 2) {
                return generateIdentityExplorationResponse(userMessage, context);
            } else if (messageCount <= 4) {
                return generateMotivationDeepResponse(userMessage, context);
            } else {
                return generateActionPlanResponse(userMessage, context);
            }
        }

        function generateIdentityExplorationResponse(userMessage, context) {
            const responses = [
                `Quello che condividi √® incredibilmente potente. Sento una trasformazione profonda in quello che descrivi. Quando ti immagini come questa nuova versione di te stesso, che sensazioni provi nel corpo? C'√® eccitazione, paura, o qualcos'altro?`,
                
                `Le tue parole mi mostrano una visione chiara di chi vuoi diventare. √à bellissimo. Ora dimmi: se questa versione migliore di te potesse guardarti oggi, cosa ti direbbe? Quale consiglio ti darebbe per il percorso che hai davanti?`,
                
                `Quello che descrivi non √® solo un obiettivo, √® una vera e propria evoluzione personale. Mi chiedo: quali sono le abitudini o i comportamenti che questa nuova versione di te avrebbe che oggi ancora non hai?`,
                
                `Sento una grande autenticit√† in quello che condividi. Questa trasformazione che descrivi, in che modo cambierebbe le tue relazioni con le persone che ami? Come ti vedrebbero diversamente?`
            ];
            
            // Personalize based on SMART goal area
            if (context.smartGoalData.area === 'health') {
                return `Quello che condividi tocca qualcosa di molto profondo. Vedo che questo obiettivo di salute fisica per te non riguarda solo il corpo, ma chi vuoi essere come persona. Quando ti immagini in quella forma fisica ottimale, cosa cambia nel modo in cui ti rapporti con le sfide quotidiane? Ti senti pi√π coraggioso, pi√π sicuro, pi√π energico?`;
            }
            
            if (context.smartGoalData.area === 'relationship') {
                return `Le tue parole toccano il cuore delle relazioni umane. Quello che descrivi non √® solo migliorare una relazione, ma evolvere come persona che sa amare e comunicare. Quando sarai diventato questa versione di te che sa relazionarsi cos√¨ bene, cosa cambier√† in tutte le altre aree della tua vita?`;
            }
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function generateMotivationDeepResponse(userMessage, context) {
            const responses = [
                `Quello che stai condividendo √® oro puro. Ora voglio andare pi√π in profondit√†: nei momenti difficili del tuo percorso - e ci saranno - cosa ti ricorder√† perch√© vale la pena continuare? Qual √® la tua "ancora" motivazionale?`,
                
                `Sento una determinazione forte nelle tue parole. Ma lascia che ti chieda questo: se dovessi fallire una volta, due volte, tre volte in questo percorso, cosa ti farebbe rialzare ogni volta? Qual √® quella voce dentro di te che non si arrende mai?`,
                
                `Le tue riflessioni mostrano una maturit√† incredibile. Ora, pensando al tuo obiettivo SMART: se tra 6 mesi fossi a met√† strada ma le cose non andassero come previsto, come adatteresti il piano senza perdere la visione?`,
                
                `Quello che descrivi mi fa pensare che hai una comprensione profonda di te stesso. Dimmi: qual √® l'ostacolo pi√π grande che prevedi in questo percorso? Non quello pratico, ma quello emotivo o mentale?`
            ];
            
            // Deep questions based on their specific SMART goal
            if (context.smartGoalData.obstacles) {
                return `Stiamo andando molto in profondit√†, e mi viene in mente quello che hai scritto sugli ostacoli: "${context.smartGoalData.obstacles}". Spesso gli ostacoli che prevediamo nascondono paure pi√π profonde. Se dovessi guardare oltre l'ostacolo pratico, quale paura nascosta potrebbe sabotare il tuo successo?`;
            }
            
            if (context.smartGoalData.accountability) {
                return `Quando parli del tuo sistema di supporto: "${context.smartGoalData.accountability}", vedo saggezza. Ma dimmi: se non avessi nessuno a sostenerti, se fosse solo tu contro il mondo, cosa ti farebbe andare avanti? Qual √® quella forza interiore incrollabile?`;
            }
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function generateActionPlanResponse(userMessage, context) {
            const responses = [
                `Quello che stiamo costruendo insieme √® un piano che ha anima oltre che struttura. Ora √® il momento dell'azione. Se dovessi scegliere UNA micro-abitudine da iniziare domani mattina, quale sarebbe? Qualcosa di piccolo ma potente.`,
                
                `Le nostre conversazioni mi stanno mostrando un obiettivo SMART che ha radici profonde in chi sei. Ora per renderlo reale: qual √® il primo momento di "no" che dovrai dire a qualcosa per dire "s√¨" al tuo obiettivo?`,
                
                `Sento che abbiamo creato qualcosa di solido insieme. Ora la domanda pratica: se dovessi progettare la tua settimana ideale per supportare questo obiettivo, come sarebbe? Che ritmi, che priorit√†?`,
                
                `Tutto quello che abbiamo esplorato si sta trasformando in un piano d'azione concreto. Ultimo pezzo del puzzle: come celebrerai i piccoli progressi lungo il percorso? Come ti terrai motivato giorno dopo giorno?`
            ];
            
            // Action-oriented based on next steps
            if (context.smartGoalData.nextAction) {
                return `Tutto quello che abbiamo scoperto insieme porta a questo momento. Hai scritto che la tua prima azione sar√†: "${context.smartGoalData.nextAction}". Perfetto. Ora, per rendere questa azione inevitabile: quando esattamente la farai? In che momento della giornata? In che contesto? Come ti preparerai mentalmente?`;
            }
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function extractSmartInsights(userMessage) {
            // Extract key insights for action plan personalization
            const insights = [];
            
            if (userMessage.toLowerCase().includes('motivazione') || userMessage.toLowerCase().includes('determinazione')) {
                insights.push('Forte consapevolezza motivazionale');
            }
            
            if (userMessage.toLowerCase().includes('paura') || userMessage.toLowerCase().includes('ostacolo')) {
                insights.push('Lavoro su resistenze e limitazioni');
            }
            
            if (userMessage.toLowerCase().includes('abitudine') || userMessage.toLowerCase().includes('routine')) {
                insights.push('Focus su sistemi e abitudini');
            }
            
            if (userMessage.toLowerCase().includes('famiglia') || userMessage.toLowerCase().includes('supporto')) {
                insights.push('Importanza del supporto sociale');
            }
            
            if (userMessage.toLowerCase().includes('tempo') || userMessage.toLowerCase().includes('pianificazione')) {
                insights.push('Attenzione alla gestione del tempo');
            }
            
            coachingInsights.push(...insights);
        }

        function show30MinuteWarning() {
            document.getElementById('timeWarning').classList.add('active');
        }

        function continueSession() {
            sessionExtended = true;
            document.getElementById('timeWarning').classList.remove('active');
            showMessage('‚úÖ Sessione estesa di 10 minuti. Completiamo il tuo piano SMART!', 'success');
        }

        function endSession() {
            clearInterval(timerInterval);
            clearInterval(autoSaveInterval);
            completeSession();
        }

        function completeSession() {
            // Save final session data
            const finalSessionData = {
                workshopData: workshopData,
                smartGoalData: smartGoalData,
                chatHistory: chatHistory,
                coachingInsights: coachingInsights,
                completedAt: new Date().toISOString(),
                sessionDuration: Date.now() - sessionStartTime,
                userProfile: userProfile,
                week1Data: week1Data,
                week2Data: week2Data
            };
            
            localStorage.setItem('week3SessionCompleted', JSON.stringify(finalSessionData));
            localStorage.removeItem('week3SessionInProgress');
            
            // Update progress
            updateUserProgress();
            
            // Show completion
            document.getElementById('phase2Section').classList.remove('active');
            document.getElementById('completionSection').classList.add('active');
            
            // Generate final SMART goal and action plan
            generateFinalSmartGoal();
            generateSmartActionPlan();
            
            document.getElementById('completionSection').scrollIntoView({ behavior: 'smooth' });
        }

        function generateFinalSmartGoal() {
            const goalEl = document.getElementById('finalSmartGoal');
            
            const areaLabels = {
                health: 'üí™ Salute Fisica',
                mental: 'üß† Benessere Mentale',
                relationship: '‚ù§Ô∏è Relazioni',
                career: 'üíº Carriera/Crescita'
            };
            
            const areaLabel = areaLabels[smartGoalData.area] || 'Area selezionata';
            
            goalEl.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; border-left: 4px solid #16a34a;">
                    <h4 style="color: #16a34a; margin-bottom: 1rem; font-size: 1.2rem;">${areaLabel}</h4>
                    
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: #1e293b;">üéØ SPECIFICO:</strong>
                        <p style="color: #64748b; margin: 0.5rem 0;">${smartGoalData.specific}</p>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: #1e293b;">üìä MISURABILE:</strong>
                        <p style="color: #64748b; margin: 0.5rem 0;">${smartGoalData.measurable}</p>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: #1e293b;">‚úÖ RAGGIUNGIBILE:</strong>
                        <p style="color: #64748b; margin: 0.5rem 0;">${smartGoalData.achievable}</p>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: #1e293b;">üéØ RILEVANTE:</strong>
                        <p style="color: #64748b; margin: 0.5rem 0;">${smartGoalData.relevant}</p>
                    </div>
                    
                    <div>
                        <strong style="color: #1e293b;">‚è∞ TEMPORIZZATO:</strong>
                        <p style="color: #64748b; margin: 0.5rem 0;">${smartGoalData.timebound}</p>
                    </div>
                </div>
            `;
        }

        function generateSmartActionPlan() {
            const actionPlanList = document.getElementById('personalizedActionPlan');
            let actionPlan = [];
            
            // Base SMART action plan
            actionPlan.push("‚úÖ Settimana 1: Implementa la prima azione concreta che hai definito");
            actionPlan.push("‚úÖ Ogni luned√¨: Rivedi il progresso e aggiusta il piano se necessario");
            
            // Personalized based on SMART goal
            if (smartGoalData.nextAction) {
                actionPlan.push(`‚úÖ Azione immediata: ${smartGoalData.nextAction}`);
            }
            
            if (smartGoalData.accountability) {
                actionPlan.push(`‚úÖ Sistema di supporto: ${smartGoalData.accountability}`);
            }
            
            // Based on area
            if (smartGoalData.area === 'health') {
                actionPlan.push("‚úÖ Traccia progressi fisici: foto, misurazioni, sensazioni di energia");
                actionPlan.push("‚úÖ Crea routine pre e post allenamento per mantenere la motivazione");
            }
            
            if (smartGoalData.area === 'mental') {
                actionPlan.push("‚úÖ Diario giornaliero: annota livelli di stress e momenti di benessere");
                actionPlan.push("‚úÖ Pratica di mindfulness: 10 minuti al giorno alla stessa ora");
            }
            
            if (smartGoalData.area === 'relationship') {
                actionPlan.push("‚úÖ Check-in settimanale: valuta qualit√† delle comunicazioni");
                actionPlan.push("‚úÖ Momenti di connessione: dedica tempo quotidiano alle relazioni importanti");
            }
            
            if (smartGoalData.area === 'career') {
                actionPlan.push("‚úÖ Skill development: dedica 30 minuti al giorno alle competenze chiave");
                actionPlan.push("‚úÖ Network building: una nuova connessione professionale a settimana");
            }
            
            // Based on coaching insights
            if (coachingInsights.includes('Focus su sistemi e abitudini')) {
                actionPlan.push("‚úÖ Habit stacking: collega nuove abitudini a quelle esistenti");
            }
            
            if (coachingInsights.includes('Attenzione alla gestione del tempo')) {
                actionPlan.push("‚úÖ Time blocking: blocca tempo specifico per l'obiettivo nell'agenda");
            }
            
            if (coachingInsights.includes('Importanza del supporto sociale')) {
                actionPlan.push("‚úÖ Accountability partner: condividi progressi settimanali con qualcuno di fiducia");
            }
            
            // Always add
            actionPlan.push("‚úÖ Celebrazione milestone: riconosci e premia i progressi intermedi");
            actionPlan.push("‚úÖ Revisione mensile: valuta e aggiusta l'obiettivo SMART se necessario");
            
            // Update action plan list
            actionPlanList.innerHTML = actionPlan.map(item => `<li>${item}</li>`).join('');
        }

        function updateUserProgress() {
            try {
                const progress = JSON.parse(localStorage.getItem('lifestyleProgress') || '{}');
                progress.completedWeeks = progress.completedWeeks || [];
                
                if (!progress.completedWeeks.includes(3)) {
                    progress.completedWeeks.push(3);
                    progress.currentWeek = 4;
                    progress.lastUpdate = new Date().toISOString();
                    
                    localStorage.setItem('lifestyleProgress', JSON.stringify(progress));
                }
            } catch (error) {
                console.error('‚ùå Error updating progress:', error);
            }
        }

        function downloadSmartPlan() {
            const planContent = `
                PIANO OBIETTIVI SMART - SETTIMANA 3
                
                Andrea Padoan - Lifestyle Coach
                
                Caro/a ${userProfile?.name || 'Amico/a'},
                
                Che sessione straordinaria! Hai trasformato un desiderio vago in un obiettivo
                SMART concreto e realizzabile. Questo piano √® il risultato della tua consapevolezza
                sviluppata nelle settimane precedenti e rappresenta un passo concreto verso
                la migliore versione di te stesso.
                
                === IL TUO OBIETTIVO SMART ===
                
                AREA DI FOCUS: ${(() => {
                    const areaLabels = {
                        health: 'Salute Fisica',
                        mental: 'Benessere Mentale', 
                        relationship: 'Relazioni',
                        career: 'Carriera/Crescita'
                    };
                    return areaLabels[smartGoalData.area] || 'Area selezionata';
                })()}
                
                üéØ SPECIFICO:
                ${smartGoalData.specific || 'Obiettivo specifico definito'}
                
                üìä MISURABILE:
                ${smartGoalData.measurable || 'Metriche di misurazione definite'}
                
                ‚úÖ RAGGIUNGIBILE:
                ${smartGoalData.achievable || 'Analisi di fattibilit√† completata'}
                
                üéØ RILEVANTE:
                ${smartGoalData.relevant || 'Allineamento con valori confermato'}
                
                ‚è∞ TEMPORIZZATO:
                ${smartGoalData.timebound || 'Tempistica definita'}
                
                === CONNESSIONE CON IL TUO PERCORSO ===
                
                ${week1Data && week1Data.phase1Data ? 
                `SETTIMANA 1 - Il tuo obiettivo da sogno era: "${week1Data.phase1Data.dreamGoal || 'la tua trasformazione'}"
                Ora hai un piano concreto per realizzarlo!` : 
                'Questo obiettivo SMART si basa sulla consapevolezza sviluppata nelle settimane precedenti.'}
                
                ${week2Data && week2Data.testResults && week2Data.testResults.topValues ? 
                (() => {
                    const valueLabels = {
                        family: 'famiglia e relazioni',
                        career: 'successo professionale',
                        health: 'salute e benessere',
                        growth: 'crescita personale',
                        freedom: 'libert√† e indipendenza'
                    };
                    const topValue = valueLabels[week2Data.testResults.topValues[0][0]];
                    return `SETTIMANA 2 - Il tuo valore principale √® ${topValue}
                Il tuo obiettivo SMART √® perfettamente allineato con questo valore!`;
                })() : 
                'SETTIMANA 2 - La consapevolezza dei tuoi valori guida questo obiettivo.'}
                
                === IL TUO PIANO D'AZIONE SETTIMANALE ===
                
                üöÄ AZIONE IMMEDIATA (Prossimi 7 giorni):
                ${smartGoalData.nextAction || 'Prima azione concreta definita nel coaching'}
                
                üõ°Ô∏è GESTIONE OSTACOLI:
                ${smartGoalData.obstacles || 'Strategie per superare le sfide identificate'}
                
                ü§ù SISTEMA DI SUPPORTO:
                ${smartGoalData.accountability || 'Rete di supporto definita'}
                
                === INSIGHTS DAL COACHING ===
                ${coachingInsights.length > 0 ? coachingInsights.map(insight => `‚Ä¢ ${insight}`).join('\n                ') : '‚Ä¢ Continua il dialogo con Andrea per sviluppare ulteriori insights'}
                
                === PIANO SETTIMANALE DETTAGLIATO ===
                
                SETTIMANA 1:
                - Implementa la prima azione concreta
                - Stabilisci la routine quotidiana di base
                - Comunica l'obiettivo al tuo sistema di supporto
                
                SETTIMANA 2:
                - Misura i primi progressi
                - Aggiusta il piano se necessario
                - Celebra i primi successi
                
                SETTIMANA 3:
                - Valuta cosa funziona meglio
                - Intensifica le strategie efficaci
                - Affronta i primi ostacoli
                
                SETTIMANA 4:
                - Milestone check: dove sei rispetto all'obiettivo?
                - Rivedi e ottimizza il piano
                - Prepara il mese successivo
                
                === DOMANDE POTENTI PER MANTENERTI MOTIVATO ===
                ‚Ä¢ Chi sto diventando attraverso questo obiettivo?
                ‚Ä¢ Come questo cambiamento sta migliorando la mia vita?
                ‚Ä¢ Cosa mi ricorda perch√© vale la pena continuare?
                ‚Ä¢ Come posso celebrare i progressi fatti finora?
                ‚Ä¢ Qual √® il prossimo piccolo passo che posso fare?
                
                === SISTEMA DI MISURAZIONE ===
                
                CONTROLLI GIORNALIERI:
                - Ho fatto l'azione prevista per oggi?
                - Come mi sento rispetto al mio obiettivo?
                - Cosa ho imparato oggi?
                
                CONTROLLI SETTIMANALI:
                - Sto procedendo secondo il piano?
                - Cosa devo aggiustare la prossima settimana?
                - Come posso migliorare la mia strategia?
                
                CONTROLLI MENSILI:
                - Sono sulla strada giusta per raggiungere l'obiettivo?
                - Il mio obiettivo SMART √® ancora rilevante?
                - Cosa ho imparato che posso applicare al prossimo obiettivo?
                
                === MESSAGGI CHIAVE ===
                
                ${userProfile?.name || 'Amico/a'}, quello che hai creato oggi non √® solo un obiettivo,
                √® un ponte verso la versione migliore di te stesso. La metodologia SMART ti d√†
                la struttura, ma la tua consapevolezza e determinazione sono il carburante.
                
                Ricorda: un obiettivo senza azione rimane solo un sogno, ma un sogno con
                un piano d'azione diventa realt√†.
                
                === PREPARAZIONE SETTIMANA 4 ===
                
                Nella prossima settimana "Piano di Azione" prenderemo questo obiettivo SMART
                e creeremo un sistema completo per realizzarlo, con strategie avanzate per
                superare ostacoli e mantenere la motivazione nel lungo termine.
                
                Il tuo coach di obiettivi,
                Andrea üéØ
                
                P.S. Rileggi questo piano ogni luned√¨ mattina. Ti ricorder√† chi stai diventando
                e perch√© il tuo obiettivo vale ogni sforzo!
            `;
            
            const blob = new Blob([planContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Piano_SMART_Settimana_3_${userProfile?.name || 'Utente'}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage('üìÑ Piano SMART scaricato!', 'success');
        }

        function scheduleNextSession() {
            const nextWeekDate = new Date();
            nextWeekDate.setDate(nextWeekDate.getDate() + 7);
            
            const message = `üìÖ Settimana 4 "Piano di Azione" disponibile il ${nextWeekDate.toLocaleDateString('it-IT')}!`;
            showMessage(message, 'info');
            
            localStorage.setItem('nextSessionReminder', nextWeekDate.toISOString());
        }

        function showMessage(message, type = 'info') {
            const colors = {
                success: '#16a34a',
                warning: '#f59e0b',
                info: '#3b82f6',
                error: '#ef4444'
            };
            
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: ${colors[type]}; color: white; padding: 1rem 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; max-width: 400px; animation: slideIn 0.3s ease-out;">
                    ${message}
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Handle Enter key in chat
        document.getElementById('chatInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            if (currentPhase !== 'completed') {
                autoSave();
            }
        });

        // Add slide-in animation style
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>