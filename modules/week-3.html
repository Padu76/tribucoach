<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settimana 3 - Obiettivi SMART | Andrea Padoan Coach</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #fff7ed 50%, #f0fdf4 100%);
            min-height: 100vh;
            color: #1e293b;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .session-info {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        /* AI Integration Badge */
        .ai-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .ai-pulse {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .timer-display {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-bar {
            background: rgba(255,255,255,0.2);
            width: 200px;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            background: #22c55e;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .back-button {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            color: white;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Phase Indicator */
        .phase-indicator {
            background: white;
            border-radius: 12px;
            padding: 1rem 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .phase-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            min-width: 280px;
        }

        .phase-step.active {
            background: linear-gradient(135deg, #ea580c 0%, #fb923c 100%);
            color: white;
        }

        .phase-step.completed {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: white;
        }

        .phase-step.inactive {
            background: #f1f5f9;
            color: #94a3b8;
        }

        .phase-arrow {
            font-size: 1.5rem;
            color: #64748b;
        }

        /* Welcome Section */
        .welcome-section {
            background: white;
            border-radius: 16px;
            padding: 3rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            text-align: center;
        }

        .welcome-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 1rem;
        }

        .welcome-subtitle {
            font-size: 1.3rem;
            color: #ea580c;
            margin-bottom: 2rem;
        }

        .weeks-recap {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: left;
        }

        .recap-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #16a34a;
            margin-bottom: 1rem;
            text-align: center;
        }

        .process-explanation {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: left;
        }

        .process-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ea580c;
            margin-bottom: 1rem;
            text-align: center;
        }

        .process-steps {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .process-step {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #ea580c;
        }

        .step-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ea580c;
            margin-bottom: 0.5rem;
        }

        .step-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .step-description {
            font-size: 0.9rem;
            color: #64748b;
            line-height: 1.5;
        }

        .step-duration {
            font-size: 0.8rem;
            color: #ea580c;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        /* Phase 1 - SMART Workshop */
        .phase1-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: none;
        }

        .phase1-section.active {
            display: block;
        }

        .phase-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f1f5f9;
        }

        .phase-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .phase-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .phase-subtitle {
            font-size: 1rem;
            color: #64748b;
        }

        .workshop-progress {
            background: #f1f5f9;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .workshop-progress-text {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .workshop-progress-bar {
            background: #e2e8f0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .workshop-progress-fill {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .workshop-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 12px;
            border-left: 4px solid #ea580c;
        }

        .workshop-section h3 {
            color: #1e293b;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .workshop-intro {
            background: #fff7ed;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-style: italic;
            color: #ea580c;
        }

        .smart-method {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .smart-letter {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            text-align: center;
            transition: all 0.3s ease;
        }

        .smart-letter:hover {
            border-color: #ea580c;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(234, 88, 12, 0.2);
        }

        .smart-letter-title {
            font-size: 2rem;
            font-weight: bold;
            color: #ea580c;
            margin-bottom: 0.5rem;
        }

        .smart-letter-subtitle {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1rem;
        }

        .smart-letter-description {
            color: #64748b;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .exercise-group {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .exercise-title {
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1e293b;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #ea580c;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .priority-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .priority-area {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }

        .priority-area.selected {
            border-color: #ea580c;
            background: #fff7ed;
        }

        .priority-area h4 {
            color: #1e293b;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .priority-area p {
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .priority-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        /* Phase 2 - Coaching Approfondito */
        .phase2-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: none;
        }

        .phase2-section.active {
            display: block;
        }

        .coaching-context {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .coaching-context h3 {
            color: #16a34a;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .coaching-context p {
            color: #15803d;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .insights-summary {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #16a34a;
        }

        .insights-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .insights-list {
            list-style: none;
            padding: 0;
        }

        .insights-list li {
            padding: 0.25rem 0;
            color: #64748b;
            font-size: 0.9rem;
        }

        .chat-container {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 12px;
            max-width: 85%;
            animation: messageSlide 0.3s ease-out;
        }

        .message.coach {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            margin-right: auto;
        }

        .message.user {
            background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%);
            margin-left: auto;
            text-align: right;
        }

        .message-content {
            font-size: 1rem;
            line-height: 1.5;
            margin-bottom: 0.5rem;
        }

        .message-time {
            font-size: 0.8rem;
            color: #64748b;
        }

        .chat-input {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .chat-input input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .chat-input input:focus {
            outline: none;
            border-color: #ea580c;
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #16a34a;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .btn-secondary {
            background: white;
            color: #1e293b;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            border-color: #ea580c;
            color: #ea580c;
        }

        .btn-success {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
        }

        .btn-disabled {
            background: #94a3b8;
            color: white;
            cursor: not-allowed;
        }

        /* Navigation Buttons */
        .form-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        /* Time Warning */
        .time-warning {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }

        .time-warning.active {
            display: block;
        }

        /* Completion Section */
        .completion-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-top: 2rem;
            display: none;
        }

        .completion-section.active {
            display: block;
        }

        .completion-title {
            font-size: 2rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 1rem;
            text-align: center;
        }

        .completion-message {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #475569;
            margin-bottom: 2rem;
            text-align: center;
        }

        .smart-results {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .results-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #16a34a;
            margin-bottom: 1rem;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .result-item {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #16a34a;
        }

        .result-score {
            font-size: 2rem;
            font-weight: bold;
            color: #16a34a;
            margin-bottom: 0.5rem;
        }

        .result-label {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .result-feedback {
            font-size: 0.8rem;
            color: #15803d;
            font-style: italic;
        }

        .action-plan-section {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .action-plan-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ea580c;
            margin-bottom: 1rem;
        }

        .action-plan-list {
            list-style: none;
            padding: 0;
        }

        .action-plan-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(234, 88, 12, 0.2);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-plan-list li:last-child {
            border-bottom: none;
        }

        .completion-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* Animations */
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }
            
            .process-steps {
                grid-template-columns: 1fr;
            }
            
            .phase-indicator {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .phase-step {
                min-width: auto;
                width: 100%;
                justify-content: center;
            }
            
            .phase-arrow {
                transform: rotate(90deg);
            }
            
            .smart-method {
                grid-template-columns: 1fr;
            }
            
            .priority-grid {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">🎯 Settimana 3 - Obiettivi SMART</div>
            <div class="session-info">
                <div class="ai-badge">
                    <div class="ai-pulse"></div>
                    AI Personalizzato
                </div>
                <div class="timer-display">
                    ⏱️ <span id="sessionTimer">40:00</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="sessionProgress"></div>
                </div>
                <a href="module-hub.html" class="back-button">← Torna ai Moduli</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Phase Indicator -->
        <div class="phase-indicator">
            <div class="phase-step active" id="phaseStep1">
                <span>🎯</span>
                <span>Fase 1: Workshop SMART + Esercizi</span>
            </div>
            <div class="phase-arrow">→</div>
            <div class="phase-step inactive" id="phaseStep2">
                <span>🤖</span>
                <span>Fase 2: Coaching AI Obiettivi Autentici</span>
            </div>
        </div>

        <!-- Welcome Section -->
        <section class="welcome-section fade-in" id="welcomeSection">
            <h1 class="welcome-title">Benvenuto nella Settimana 3! 🎯</h1>
            <p class="welcome-subtitle">Obiettivi SMART - Trasforma i sogni in realtà concrete</p>
            
            <div class="weeks-recap">
                <h3 class="recap-title">🧠 Il Percorso Fatto Insieme</h3>
                <div id="weeksRecap">
                    <p><strong>Settimana 1:</strong> Abbiamo mappato la tua situazione e scoperto i tuoi obiettivi autentici</p>
                    <p><strong>Settimana 2:</strong> Hai sviluppato consapevolezza profonda di chi sei e dei tuoi valori</p>
                    <p style="margin-top: 1rem; font-style: italic; color: #ea580c;">
                        Oggi utilizzeremo tutta questa consapevolezza per creare obiettivi SMART che rispecchiano veramente chi sei.
                    </p>
                </div>
            </div>
            
            <div class="process-explanation">
                <h3 class="process-title">🎯 Il Tuo Workshop SMART Personalizzato</h3>
                <div class="process-steps">
                    <div class="process-step">
                        <div class="step-number">1</div>
                        <div class="step-title">Workshop SMART + Esercizi</div>
                        <div class="step-description">
                            Impari la metodologia SMART e la applichi subito ai tuoi obiettivi personali
                            per le 4 aree di benessere, con prioritizzazione strategica.
                        </div>
                        <div class="step-duration">⏱️ 12-15 minuti</div>
                    </div>
                    <div class="process-step">
                        <div class="step-number">2</div>
                        <div class="step-title">Coaching AI Personalizzato</div>
                        <div class="step-description">
                            Andrea AI, calibrato per il tuo profilo, verificherà l'allineamento con i tuoi valori
                            e creerà il piano d'azione concreto personalizzato.
                        </div>
                        <div class="step-duration">⏱️ 25-28 minuti</div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="startPhase1()">
                🚀 Inizia il Workshop SMART Personalizzato
            </button>
        </section>

        <!-- Phase 1: SMART Workshop -->
        <section class="phase1-section" id="phase1Section">
            <div class="phase-header">
                <div class="phase-icon">🎯</div>
                <div>
                    <h2 class="phase-title">Fase 1: Workshop SMART + Esercizi Pratici</h2>
                    <p class="phase-subtitle">Impara e applica subito la metodologia per obiettivi concreti</p>
                </div>
            </div>
            
            <div class="workshop-progress">
                <div class="workshop-progress-text">Progresso workshop: <span id="workshopProgress">0%</span></div>
                <div class="workshop-progress-bar">
                    <div class="workshop-progress-fill" id="workshopProgressFill" style="width: 0%"></div>
                </div>
            </div>

            <!-- Metodologia SMART -->
            <div class="workshop-section" id="smartMethod">
                <h3>📚 La Metodologia SMART - La Tua Guida per Obiettivi Concreti</h3>
                <div class="workshop-intro">
                    La metodologia SMART trasforma i desideri vaghi in obiettivi raggiungibili. 
                    Ogni lettera rappresenta un criterio che renderà i tuoi obiettivi chiari e realizzabili.
                </div>
                
                <div class="smart-method">
                    <div class="smart-letter">
                        <div class="smart-letter-title">S</div>
                        <div class="smart-letter-subtitle">Specifico</div>
                        <div class="smart-letter-description">
                            L'obiettivo deve rispondere a: Cosa esattamente vuoi raggiungere? 
                            Chi è coinvolto? Dove accadrà? Perché è importante?
                        </div>
                    </div>
                    
                    <div class="smart-letter">
                        <div class="smart-letter-title">M</div>
                        <div class="smart-letter-subtitle">Misurabile</div>
                        <div class="smart-letter-description">
                            Deve avere indicatori quantificabili. Come saprai di aver raggiunto l'obiettivo? 
                            Quanti, quanto spesso, quale percentuale?
                        </div>
                    </div>
                    
                    <div class="smart-letter">
                        <div class="smart-letter-title">A</div>
                        <div class="smart-letter-subtitle">Raggiungibile</div>
                        <div class="smart-letter-description">
                            Sfidante ma realistico. Hai le competenze, risorse e tempo necessari? 
                            È abbastanza ambizioso da motivarti?
                        </div>
                    </div>
                    
                    <div class="smart-letter">
                        <div class="smart-letter-title">R</div>
                        <div class="smart-letter-subtitle">Rilevante</div>
                        <div class="smart-letter-description">
                            Allineato con i tuoi valori e priorità di vita. È importante per te? 
                            Si collega ai tuoi obiettivi più grandi?
                        </div>
                    </div>
                    
                    <div class="smart-letter">
                        <div class="smart-letter-title">T</div>
                        <div class="smart-letter-subtitle">Temporizzato</div>
                        <div class="smart-letter-description">
                            Ha una scadenza chiara. Entro quando? Con milestone intermedie? 
                            Crea urgenza costruttiva senza stress.
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-secondary" onclick="markMethodLearned()" style="margin-top: 1rem;">
                    ✅ Ho compreso la metodologia, continua
                </button>
            </div>

            <!-- Identificazione Obiettivi -->
            <div class="workshop-section" id="goalsIdentification" style="display: none;">
                <h3>🎯 Identifica i Tuoi Obiettivi per le 4 Aree di Benessere</h3>
                <div class="workshop-intro">
                    Basandoti sulla consapevolezza sviluppata nelle settimane precedenti, 
                    identifica un obiettivo importante per ogni area del tuo benessere.
                </div>
                
                <div class="priority-grid">
                    <div class="priority-area">
                        <h4>💪 Salute Fisica</h4>
                        <p>Energia, forma fisica, alimentazione, sport</p>
                        <textarea class="priority-input" id="healthGoal" placeholder="Es: Correre 5km senza fermarmi entro 3 mesi attraverso un programma di allenamento progressivo..." onchange="updateWorkshopProgress(); autoSave()"></textarea>
                    </div>
                    
                    <div class="priority-area">
                        <h4>🧠 Benessere Mentale</h4>
                        <p>Stress, mindfulness, crescita personale</p>
                        <textarea class="priority-input" id="mentalGoal" placeholder="Es: Ridurre i livelli di stress del 50% nei prossimi 6 mesi praticando meditazione quotidiana..." onchange="updateWorkshopProgress(); autoSave()"></textarea>
                    </div>
                    
                    <div class="priority-area">
                        <h4>❤️ Relazioni</h4>
                        <p>Famiglia, amici, partner, colleghi</p>
                        <textarea class="priority-input" id="relationshipGoal" placeholder="Es: Migliorare la comunicazione con il partner attraverso 30 minuti di dialogo qualitativo ogni sera..." onchange="updateWorkshopProgress(); autoSave()"></textarea>
                    </div>
                    
                    <div class="priority-area">
                        <h4>💼 Carriera/Crescita</h4>
                        <p>Lavoro, progetti, competenze, finanze</p>
                        <textarea class="priority-input" id="careerGoal" placeholder="Es: Ottenere una promozione entro 12 mesi sviluppando competenze di leadership attraverso un corso certificato..." onchange="updateWorkshopProgress(); autoSave()"></textarea>
                    </div>
                </div>
            </div>

            <!-- Applicazione SMART -->
            <div class="workshop-section" id="smartApplication" style="display: none;">
                <h3>🔧 Trasforma UN Obiettivo in SMART</h3>
                <div class="workshop-intro">
                    Scegli l'obiettivo più importante per te in questo momento e lo trasformiamo insieme in formato SMART.
                </div>
                
                <div class="form-group">
                    <label for="priorityGoal">Quale obiettivo vuoi rendere SMART?</label>
                    <select id="priorityGoal" onchange="updateWorkshopProgress(); autoSave()">
                        <option value="">Seleziona l'obiettivo prioritario...</option>
                        <option value="health">Salute Fisica</option>
                        <option value="mental">Benessere Mentale</option>
                        <option value="relationship">Relazioni</option>
                        <option value="career">Carriera/Crescita</option>
                    </select>
                </div>

                <div class="exercise-group">
                    <div class="exercise-title">🎯 SPECIFICO - Cosa esattamente vuoi raggiungere?</div>
                    <div class="form-group">
                        <label for="specificGoal">Descrivi in dettaglio l'obiettivo</label>
                        <textarea id="specificGoal" placeholder="Cosa, chi, dove, perché in modo molto specifico..." onchange="updateWorkshopProgress(); autoSave()"></textarea>
                    </div>
                </div>

                <div class="exercise-group">
                    <div class="exercise-title">📊 MISURABILE - Come misurerai il progresso?</div>
                    <div class="form-group">
                        <label for="measurableGoal">Indica metriche precise e indicatori</label>
                        <textarea id="measurableGoal" placeholder="Numeri, percentuali, frequenze, quantità specifiche..." onchange="updateWorkshopProgress(); autoSave()"></textarea>
                    </div>
                </div>

                <div class="exercise-group">
                    <div class="exercise-title">✅ RAGGIUNGIBILE - È realisticamente possibile?</div>
                    <div class="form-group">
                        <label for="achievableGoal">Analizza risorse, competenze e ostacoli</label>
                        <textarea id="achievableGoal" placeholder="Hai le competenze? Le risorse? Quanto è sfidante ma realistico?" onchange="updateWorkshopProgress(); autoSave()"></textarea>
                    </div>
                </div>

                <div class="exercise-group">
                    <div class="exercise-title">🎯 RILEVANTE - Perché è importante per te?</div>
                    <div class="form-group">
                        <label for="relevantGoal">Connessione con valori e priorità di vita</label>
                        <textarea id="relevantGoal" placeholder="Come si allinea con i tuoi valori scoperti in Settimana 2?" onchange="updateWorkshopProgress(); autoSave()"></textarea>
                    </div>
                </div>

                <div class="exercise-group">
                    <div class="exercise-title">⏰ TEMPORIZZATO - Quando e con che milestone?</div>
                    <div class="form-group">
                        <label for="timeGoal">Data finale e tappe intermedie</label>
                        <textarea id="timeGoal" placeholder="Data finale, milestone mensili, check-in settimanali..." onchange="updateWorkshopProgress(); autoSave()"></textarea>
                    </div>
                </div>
            </div>

            <!-- Prioritizzazione -->
            <div class="workshop-section" id="prioritization" style="display: none;">
                <h3>📋 Prioritizzazione Strategica</h3>
                <div class="workshop-intro">
                    Ora che hai un obiettivo SMART, definiamo le priorità per i prossimi 90 giorni.
                </div>
                
                <div class="form-group">
                    <label for="next90Days">Qual è la PRIMA azione concreta che farai nei prossimi 7 giorni?</label>
                    <textarea id="next90Days" placeholder="Azione specifica, piccola ma significativa..." onchange="updateWorkshopProgress(); autoSave()"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="obstacles">Quali ostacoli prevedi e come li supererai?</label>
                    <textarea id="obstacles" placeholder="3 ostacoli principali e relative soluzioni..." onchange="updateWorkshopProgress(); autoSave()"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="accountability">Chi o cosa ti aiuterà a rimanere sulla strada?</label>
                    <textarea id="accountability" placeholder="Sistema di accountability, persone di supporto..." onchange="updateWorkshopProgress(); autoSave()"></textarea>
                </div>
            </div>

            <div class="form-navigation">
                <button type="button" class="btn btn-success" id="completeWorkshopBtn" onclick="completePhase1()" disabled>
                    ✅ Completa Workshop e Inizia Coaching AI Personalizzato
                </button>
            </div>
        </section>

        <!-- Phase 2: Coaching Approfondito -->
        <section class="phase2-section" id="phase2Section">
            <div class="phase-header">
                <div class="phase-icon">🤖</div>
                <div>
                    <h2 class="phase-title">Fase 2: Coaching AI per Obiettivi Autentici</h2>
                    <p class="phase-subtitle">Andrea AI personalizzato verifica allineamento e crea il piano concreto</p>
                </div>
            </div>
            
            <div class="coaching-context">
                <h3>🌟 Il Tuo Obiettivo SMART Personalizzato</h3>
                <p>
                    Fantastico! Hai appena trasformato un desiderio in un obiettivo concreto e realizzabile.
                    Il mio sistema AI, calibrato per il tuo profilo specifico, ora verificherà che questo obiettivo 
                    sia perfettamente allineato con chi sei veramente e ti aiuterà a creare un piano d'azione 
                    che funzioni nella tua vita reale.
                </p>
                
                <div class="insights-summary">
                    <div class="insights-title">🎯 Il Tuo Obiettivo SMART:</div>
                    <ul class="insights-list" id="smartSummary">
                        <li>In elaborazione del tuo obiettivo personalizzato...</li>
                    </ul>
                </div>
            </div>
            
            <div class="time-warning" id="timeWarning">
                <strong>⏰ Abbiamo raggiunto i 30 minuti!</strong> Vuoi continuare per altri 10 minuti o preferisci terminare ora?
                <div style="margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="continueSession()">Continua</button>
                    <button class="btn btn-primary" onclick="endSession()">Termina Ora</button>
                </div>
            </div>
            
            <div class="chat-status">
                <div class="status-dot"></div>
                <span>Andrea AI personalizzato è pronto per perfezionare il tuo obiettivo e creare il piano d'azione</span>
            </div>
            
            <div class="chat-container" id="chatContainer">
                <!-- Messages will be added here -->
            </div>
            
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="Condividi le tue riflessioni con Andrea AI...">
                <button class="btn btn-primary" onclick="sendChatMessage()">Invia</button>
            </div>
        </section>

        <!-- Completion Section -->
        <section class="completion-section" id="completionSection">
            <h2 class="completion-title">🎯 Obiettivi SMART Personalizzati Completati!</h2>
            <p class="completion-message">
                Incredibile! Hai trasformato un sogno vago in un obiettivo SMART concreto e realizzabile, 
                completamente personalizzato per il tuo profilo. Con la consapevolezza delle settimane precedenti 
                e questo piano d'azione su misura, hai tutto quello che serve per avere successo.
            </p>
            
            <div class="smart-results">
                <h3 class="results-title">🏆 Il Tuo Obiettivo SMART Personalizzato</h3>
                <div id="finalSmartGoal">
                    <!-- Will be populated with SMART goal -->
                </div>
            </div>
            
            <div class="action-plan-section">
                <h3 class="action-plan-title">🚀 Il Tuo Piano d'Azione Personalizzato</h3>
                <ul class="action-plan-list" id="personalizedActionPlan">
                    <!-- Will be generated based on SMART goal and AI coaching -->
                </ul>
            </div>
            
            <div class="completion-actions">
                <button class="btn btn-success" onclick="downloadSmartPlan()">📄 Scarica Piano SMART Personalizzato</button>
                <a href="module-hub.html" class="btn btn-secondary">← Torna ai Moduli</a>
                <button class="btn btn-primary" onclick="scheduleNextSession()">📅 Programma Settimana 4</button>
            </div>
        </section>
    </main>

    <!-- Load Sistema AI Integrato v2.0 e Script Integrazione -->
    <script src="../utils/integrated-ai-system.js"></script>
    <script src="../utils/modules-integration.js"></script>
    
    <script>
        // Session variables
        let sessionStartTime = Date.now();
        let sessionDuration = 40 * 60 * 1000; // 40 minutes
        let timerInterval;
        let currentPhase = 'welcome';
        let workshopData = {};
        let smartGoalData = {};
        let chatHistory = [];
        let aiSystem = null;
        let userProfile = null;
        let week1Data = null;
        let week2Data = null;
        let sessionExtended = false;
        let autoSaveInterval;
        let coachingInsights = [];

        // Initialize session
        document.addEventListener('DOMContentLoaded', function() {
            startSessionTimer();
            loadUserProfile();
            loadPreviousWeeks();
            loadSavedSession();
            initializePersonalizedAI();
            startAutoSave();
        });

        function startSessionTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - sessionStartTime;
                const remaining = Math.max(0, sessionDuration - elapsed);
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                
                document.getElementById('sessionTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const progress = (elapsed / sessionDuration) * 100;
                document.getElementById('sessionProgress').style.width = `${Math.min(progress, 100)}%`;
                
                // Check for 30 minute warning
                if (elapsed >= 30 * 60 * 1000 && !sessionExtended && currentPhase === 'phase2') {
                    show30MinuteWarning();
                }
                
                // Auto-end at 40 minutes
                if (remaining === 0) {
                    clearInterval(timerInterval);
                    endSession();
                }
            }, 1000);
        }

        function loadUserProfile() {
            try {
                const savedData = localStorage.getItem('lifestyleQuizResults');
                if (savedData) {
                    userProfile = JSON.parse(savedData);
                    console.log('✅ User profile loaded:', userProfile);
                    updatePersonalizedWelcome();
                }
            } catch (error) {
                console.error('❌ Error loading user profile:', error);
            }
        }

        function updatePersonalizedWelcome() {
            if (!userProfile) return;
            
            // Update welcome title with name
            const welcomeTitle = document.querySelector('.welcome-title');
            if (welcomeTitle && userProfile.name) {
                welcomeTitle.textContent = `Benvenuto/a ${userProfile.name} nella Settimana 3! 🎯`;
            }
            
            // Update subtitle with profile
            const welcomeSubtitle = document.querySelector('.welcome-subtitle');
            if (welcomeSubtitle && window.LIFESTYLE_PROFILES_CONFIG && userProfile.profileType) {
                const profileConfig = window.LIFESTYLE_PROFILES_CONFIG[userProfile.profileType];
                if (profileConfig) {
                    welcomeSubtitle.textContent = `Obiettivi SMART - Personalizzato per ${profileConfig.name} ${profileConfig.emoji}`;
                }
            }
            
            // Update chat input placeholder
            const chatInput = document.getElementById('chatInput');
            if (chatInput && userProfile.profileType) {
                const placeholders = {
                    stressato_esaurito: "Condividi le tue riflessioni senza fretta, hai tutto il tempo...",
                    procrastinatore_bloccato: "Dimmi cosa pensi, anche se non è perfetto...",
                    perfezionista_insoddisfatto: "Non serve la riflessione perfetta, condividi quello che senti...",
                    dispersivo_confuso: "Concentrati su UN aspetto e condividilo con me...",
                    motivato_inconsistente: "Condividi la tua energia e le tue riflessioni...",
                    equilibrato_ottimizzatore: "Condividi la tua analisi e le tue considerazioni strategiche..."
                };
                
                chatInput.placeholder = placeholders[userProfile.profileType] || 
                                       "Condividi le tue riflessioni con Andrea AI...";
            }
        }

        function loadPreviousWeeks() {
            try {
                const week1SessionData = localStorage.getItem('week1SessionCompleted');
                if (week1SessionData) {
                    week1Data = JSON.parse(week1SessionData);
                    console.log('✅ Week 1 data loaded:', week1Data);
                }

                const week2SessionData = localStorage.getItem('week2SessionCompleted');
                if (week2SessionData) {
                    week2Data = JSON.parse(week2SessionData);
                    console.log('✅ Week 2 data loaded:', week2Data);
                }
                
                displayPersonalizedRecap();
            } catch (error) {
                console.error('❌ Error loading previous weeks data:', error);
                displayDefaultRecap();
            }
        }

        function displayPersonalizedRecap() {
            const recapEl = document.getElementById('weeksRecap');
            let content = '<p><strong>Il tuo percorso personalizzato finora:</strong></p>';
            
            if (week1Data && week1Data.phase1Data) {
                content += `<p><strong>Settimana 1:</strong> Hai identificato come obiettivo principale "${week1Data.phase1Data.dreamGoal || 'la tua trasformazione'}"</p>`;
            }
            
            if (week2Data && week2Data.testResults) {
                const topValue = week2Data.testResults.topValues && week2Data.testResults.topValues.length > 0 ? 
                    (() => {
                        const valueLabels = {
                            family: 'famiglia e relazioni',
                            career: 'successo professionale',
                            health: 'salute e benessere',
                            growth: 'crescita personale',
                            freedom: 'libertà e indipendenza'
                        };
                        return valueLabels[week2Data.testResults.topValues[0][0]];
                    })() : 'valori personali';
                content += `<p><strong>Settimana 2:</strong> Hai scoperto che il tuo valore principale è ${topValue}</p>`;
                
                // Add profile-specific insight
                if (userProfile && userProfile.profileType && window.LIFESTYLE_PROFILES_CONFIG) {
                    const profileConfig = window.LIFESTYLE_PROFILES_CONFIG[userProfile.profileType];
                    content += `<p><strong>Il tuo profilo:</strong> "${profileConfig.name}" - approccio coaching personalizzato</p>`;
                }
            }
            
            content += `<p style="margin-top: 1rem; font-style: italic; color: #ea580c;">
                Oggi useremo tutto questo per creare obiettivi SMART che rispecchiano davvero chi sei e cosa vuoi raggiungere, 
                con un coaching AI calibrato per il tuo profilo specifico.
            </p>`;
            
            recapEl.innerHTML = content;
        }

        function displayDefaultRecap() {
            const recapEl = document.getElementById('weeksRecap');
            recapEl.innerHTML = `
                <p><strong>Settimana 1:</strong> Abbiamo mappato la tua situazione e scoperto i tuoi obiettivi autentici</p>
                <p><strong>Settimana 2:</strong> Hai sviluppato consapevolezza profonda di chi sei e dei tuoi valori</p>
                <p style="margin-top: 1rem; font-style: italic; color: #ea580c;">
                    Oggi utilizzeremo tutta questa consapevolezza per creare obiettivi SMART che rispecchiano veramente chi sei.
                </p>
            `;
        }

        function loadSavedSession() {
            try {
                const savedSession = localStorage.getItem('week3SessionInProgress');
                if (savedSession) {
                    const sessionData = JSON.parse(savedSession);
                    
                    // Restore workshop data
                    if (sessionData.workshopData) {
                        workshopData = sessionData.workshopData;
                        restoreWorkshopAnswers();
                    }
                    
                    // Restore SMART goal data
                    if (sessionData.smartGoalData) {
                        smartGoalData = sessionData.smartGoalData;
                    }
                    
                    // Restore chat history
                    if (sessionData.chatHistory) {
                        chatHistory = sessionData.chatHistory;
                    }
                    
                    // Restore current phase
                    if (sessionData.currentPhase) {
                        currentPhase = sessionData.currentPhase;
                        
                        if (currentPhase === 'phase1') {
                            startPhase1();
                        } else if (currentPhase === 'phase2') {
                            startPhase2();
                            restoreChatHistory();
                        }
                    }
                    
                    console.log('✅ Session restored from:', sessionData);
                }
            } catch (error) {
                console.error('❌ Error loading saved session:', error);
            }
        }

        function restoreWorkshopAnswers() {
            Object.entries(workshopData).forEach(([key, value]) => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = value;
                }
            });
            updateWorkshopProgress();
        }

        async function initializePersonalizedAI() {
            try {
                // Aspetta che i sistemi AI siano caricati
                await waitForAISystems();
                
                const userId = localStorage.getItem('lifestyleUserId') || 'user_' + Date.now();
                localStorage.setItem('lifestyleUserId', userId);
                
                // Inizializza Sistema AI Integrato v2.0
                if (window.AISystemIntegrator && userProfile) {
                    aiSystem = await window.AISystemIntegrator.initializeFromQuizData(userId, userProfile);
                    aiSystem.setCurrentWeek(3); // Settimana 3
                    
                    console.log('🤖 Sistema AI Integrato v2.0 inizializzato per Week 3');
                    console.log('🎯 Profilo:', userProfile.profileType);
                    
                    // Update status
                    updateAIStatus();
                } else {
                    console.error('❌ AISystemIntegrator o userProfile non disponibili');
                }
                
            } catch (error) {
                console.error('❌ Error initializing personalized AI:', error);
            }
        }

        function waitForAISystems() {
            return new Promise((resolve) => {
                const checkSystems = () => {
                    if (window.IntegratedAISystem && window.AISystemIntegrator && window.LIFESTYLE_PROFILES_CONFIG) {
                        resolve(true);
                    } else {
                        setTimeout(checkSystems, 100);
                    }
                };
                checkSystems();
            });
        }

        function updateAIStatus() {
            const statusElement = document.querySelector('.chat-status span');
            if (statusElement && userProfile && window.LIFESTYLE_PROFILES_CONFIG) {
                const profileConfig = window.LIFESTYLE_PROFILES_CONFIG[userProfile.profileType];
                if (profileConfig) {
                    statusElement.textContent = `Andrea AI personalizzato per "${profileConfig.name}" è pronto per gli obiettivi autentici`;
                }
            }
        }

        function startAutoSave() {
            autoSaveInterval = setInterval(() => {
                autoSave();
            }, 5000);
        }

        function autoSave() {
            try {
                const sessionData = {
                    currentPhase: currentPhase,
                    workshopData: workshopData,
                    smartGoalData: smartGoalData,
                    chatHistory: chatHistory,
                    coachingInsights: coachingInsights,
                    sessionStartTime: sessionStartTime,
                    lastSaved: new Date().toISOString()
                };
                
                localStorage.setItem('week3SessionInProgress', JSON.stringify(sessionData));
            } catch (error) {
                console.error('❌ Error auto-saving:', error);
            }
        }

        function startPhase1() {
            currentPhase = 'phase1';
            
            // Hide welcome, show phase 1
            document.getElementById('welcomeSection').style.display = 'none';
            document.getElementById('phase1Section').classList.add('active');
            
            // Update phase indicator
            document.getElementById('phaseStep1').className = 'phase-step active';
            document.getElementById('phaseStep2').className = 'phase-step inactive';
            
            updateWorkshopProgress();
            autoSave();
        }

        function markMethodLearned() {
            workshopData.methodLearned = true;
            document.getElementById('smartMethod').style.display = 'none';
            document.getElementById('goalsIdentification').style.display = 'block';
            updateWorkshopProgress();
            autoSave();
        }

        function updateWorkshopProgress() {
            // Calculate progress based on completed sections
            let progress = 0;
            let totalSections = 5;
            
            // Method learned
            if (workshopData.methodLearned) progress++;
            
            // Goals identified (4 areas)
            const goalFields = ['healthGoal', 'mentalGoal', 'relationshipGoal', 'careerGoal'];
            const filledGoals = goalFields.filter(field => {
                const element = document.getElementById(field);
                if (element && element.value.trim()) {
                    workshopData[field] = element.value.trim();
                    return true;
                }
                return false;
            });
            
            if (filledGoals.length === 4) {
                progress++;
                // Show SMART application section
                if (document.getElementById('smartApplication').style.display === 'none') {
                    document.getElementById('smartApplication').style.display = 'block';
                }
            }
            
            // SMART application
            const smartFields = ['priorityGoal', 'specificGoal', 'measurableGoal', 'achievableGoal', 'relevantGoal', 'timeGoal'];
            const filledSmart = smartFields.filter(field => {
                const element = document.getElementById(field);
                if (element && element.value.trim()) {
                    workshopData[field] = element.value.trim();
                    return true;
                }
                return false;
            });
            
            if (filledSmart.length === 6) {
                progress++;
                // Show prioritization section
                if (document.getElementById('prioritization').style.display === 'none') {
                    document.getElementById('prioritization').style.display = 'block';
                }
            }
            
            // Prioritization
            const priorityFields = ['next90Days', 'obstacles', 'accountability'];
            const filledPriority = priorityFields.filter(field => {
                const element = document.getElementById(field);
                if (element && element.value.trim()) {
                    workshopData[field] = element.value.trim();
                    return true;
                }
                return false;
            });
            
            if (filledPriority.length === 3) {
                progress++;
            }
            
            const progressPercentage = (progress / totalSections) * 100;
            document.getElementById('workshopProgress').textContent = `${Math.round(progressPercentage)}%`;
            document.getElementById('workshopProgressFill').style.width = `${progressPercentage}%`;
            
            // Enable/disable complete button
            const completeBtn = document.getElementById('completeWorkshopBtn');
            if (progressPercentage === 100) {
                completeBtn.disabled = false;
                completeBtn.className = 'btn btn-success';
            } else {
                completeBtn.disabled = true;
                completeBtn.className = 'btn btn-disabled';
            }
        }

        function completePhase1() {
            // Process SMART goal data
            processSmartGoal();
            
            // Mark phase 1 as completed
            document.getElementById('phaseStep1').className = 'phase-step completed';
            
            // Start phase 2
            startPhase2();
        }

        function processSmartGoal() {
            const priorityArea = workshopData.priorityGoal;
            
            smartGoalData = {
                area: priorityArea,
                specific: workshopData.specificGoal,
                measurable: workshopData.measurableGoal,
                achievable: workshopData.achievableGoal,
                relevant: workshopData.relevantGoal,
                timebound: workshopData.timeGoal,
                nextAction: workshopData.next90Days,
                obstacles: workshopData.obstacles,
                accountability: workshopData.accountability
            };
            
            // Generate personalized coaching insights
            generatePersonalizedSmartInsights();
        }

        function generatePersonalizedSmartInsights() {
            coachingInsights = [];
            
            // Analyze SMART goal quality
            if (smartGoalData.specific && smartGoalData.specific.length > 50) {
                coachingInsights.push('Obiettivo ben dettagliato e specifico');
            }
            
            if (smartGoalData.measurable && (smartGoalData.measurable.includes('%') || smartGoalData.measurable.includes('kg') || smartGoalData.measurable.includes('volte'))) {
                coachingInsights.push('Metriche quantificabili identificate');
            }
            
            if (smartGoalData.relevant && (smartGoalData.relevant.includes('valore') || smartGoalData.relevant.includes('importante'))) {
                coachingInsights.push('Forte allineamento con valori personali');
            }
            
            if (smartGoalData.nextAction && smartGoalData.nextAction.length > 30) {
                coachingInsights.push('Piano d\'azione concreto definito');
            }
            
            // Profile-specific insights
            if (userProfile && userProfile.profileType) {
                switch (userProfile.profileType) {
                    case 'stressato_esaurito':
                        if (smartGoalData.area === 'health' || smartGoalData.area === 'mental') {
                            coachingInsights.push('Obiettivo allineato al profilo: focus su recupero energia');
                        }
                        break;
                    case 'procrastinatore_bloccato':
                        if (smartGoalData.nextAction && smartGoalData.nextAction.includes('piccol')) {
                            coachingInsights.push('Approccio micro-azioni perfetto per il profilo');
                        }
                        break;
                    case 'perfezionista_insoddisfatto':
                        if (smartGoalData.achievable && smartGoalData.achievable.includes('realistico')) {
                            coachingInsights.push('Ottima consapevolezza della fattibilità vs perfezione');
                        }
                        break;
                }
            }
        }

        function startPhase2() {
            currentPhase = 'phase2';
            
            // Hide phase 1, show phase 2
            document.getElementById('phase1Section').classList.remove('active');
            document.getElementById('phase2Section').classList.add('active');
            
            // Update phase indicator
            document.getElementById('phaseStep2').className = 'phase-step active';
            
            // Display personalized SMART summary
            displayPersonalizedSmartSummary();
            
            // Generate first AI coaching question
            generatePersonalizedOpeningQuestion();
            
            autoSave();
        }

        function displayPersonalizedSmartSummary() {
            const summaryEl = document.getElementById('smartSummary');
            if (smartGoalData.specific) {
                const areaLabels = {
                    health: 'Salute Fisica',
                    mental: 'Benessere Mentale',
                    relationship: 'Relazioni',
                    career: 'Carriera/Crescita'
                };
                
                const areaLabel = areaLabels[smartGoalData.area] || 'Area selezionata';
                
                // Add profile context
                let profileContext = '';
                if (userProfile && userProfile.profileType && window.LIFESTYLE_PROFILES_CONFIG) {
                    const profileConfig = window.LIFESTYLE_PROFILES_CONFIG[userProfile.profileType];
                    profileContext = ` (Personalizzato per profilo: ${profileConfig.name})`;
                }
                
                summaryEl.innerHTML = `
                    <li><strong>Area:</strong> ${areaLabel}${profileContext}</li>
                    <li><strong>Obiettivo:</strong> ${smartGoalData.specific.substring(0, 100)}...</li>
                    <li><strong>Misurabile:</strong> ${smartGoalData.measurable.substring(0, 80)}...</li>
                    <li><strong>Scadenza:</strong> ${smartGoalData.timebound.substring(0, 60)}...</li>
                `;
            } else {
                summaryEl.innerHTML = '<li>Elaborazione del tuo obiettivo SMART personalizzato in corso...</li>';
            }
        }

        function generatePersonalizedOpeningQuestion() {
            if (chatHistory.length === 0) {
                const openingQuestion = createPersonalizedSmartOpeningQuestion();
                addChatMessage(openingQuestion, 'coach');
            } else {
                restoreChatHistory();
            }
        }

        function createPersonalizedSmartOpeningQuestion() {
            let question = `Complimenti! Hai appena creato un obiettivo SMART davvero potente. `;
            
            // Profile-specific opening
            if (userProfile && userProfile.profileType && window.LIFESTYLE_PROFILES_CONFIG) {
                const profileConfig = window.LIFESTYLE_PROFILES_CONFIG[userProfile.profileType];
                question += `Il mio sistema AI, calibrato per il tuo profilo "${profileConfig.name}" ${profileConfig.emoji}, `;
                
                // Profile-specific introduction
                switch (userProfile.profileType) {
                    case 'stressato_esaurito':
                        question += `ha notato che hai scelto un obiettivo che può aiutarti a recuperare energia e benessere. Perfetto! `;
                        break;
                    case 'procrastinatore_bloccato':
                        question += `vede che hai strutturato un piano con azioni concrete. Questo è esattamente ciò di cui hai bisogno! `;
                        break;
                    case 'perfezionista_insoddisfatto':
                        question += `apprezza come hai bilanciato ambizione e realismo nel tuo obiettivo. Grande consapevolezza! `;
                        break;
                    case 'dispersivo_confuso':
                        question += `è soddisfatto di come hai focalizzato la tua energia su UN obiettivo specifico. Ottima scelta! `;
                        break;
                    case 'motivato_inconsistente':
                        question += `ha identificato un obiettivo che può beneficiare della tua energia naturale con un sistema strutturato. `;
                        break;
                    case 'equilibrato_ottimizzatore':
                        question += `riconosce l'approccio metodico e strategico del tuo obiettivo. Molto professionale! `;
                        break;
                }
            }
            
            const areaLabels = {
                health: 'salute fisica',
                mental: 'benessere mentale',
                relationship: 'relazioni',
                career: 'carriera e crescita'
            };
            
            const areaLabel = areaLabels[smartGoalData.area] || 'area scelta';
            
            question += `Vedo che hai scelto di concentrarti sulla tua ${areaLabel}, e questo mi dice molto delle tue priorità attuali. `;
            
            // Reference their specific goal
            if (smartGoalData.specific) {
                question += `Il tuo obiettivo: "${smartGoalData.specific}" ha una chiarezza che mi colpisce. `;
            }
            
            // Connect to their values from Week 2
            if (week2Data && week2Data.testResults && week2Data.testResults.topValues) {
                const valueLabels = {
                    family: 'famiglia e relazioni',
                    career: 'successo professionale',
                    health: 'salute e benessere',
                    growth: 'crescita personale',
                    freedom: 'libertà e indipendenza'
                };
                const topValue = valueLabels[week2Data.testResults.topValues[0][0]];
                question += `E questo si allinea perfettamente con il tuo valore principale che abbiamo scoperto la settimana scorsa: ${topValue}. `;
            }
            
            // Profile-specific powerful question
            question += `\n\n`;
            
            if (userProfile && userProfile.profileType) {
                const profileQuestions = {
                    stressato_esaurito: "Prima di tutto, come ti senti riguardo a questo obiettivo? Ti dà energia o ti crea ulteriore pressione? È importante che il tuo obiettivo ti nutra, non ti svuoti.",
                    procrastinatore_bloccato: "Ora la domanda chiave: quando pensi a questo obiettivo, cosa ti fa venire voglia di iniziare SUBITO? E cosa invece ti fa venire voglia di rimandare?",
                    perfezionista_insoddisfatto: "Voglio che tu sia onesto con me: qual è la versione 'imperfetta ma fatta' di questo obiettivo che saresti disposto ad accettare? Cosa significa per te 'buono abbastanza'?",
                    dispersivo_confuso: "Eccellente focus! Ora, per mantenere questa chiarezza: cosa farai quando altre opportunità o distrazioni cercheranno di portarti fuori strada da questo obiettivo?",
                    motivato_inconsistente: "La tua energia per questo obiettivo è palpabile! Ma dimmi: cosa succederà quando avrai una giornata 'no'? Come manterrai il momentum anche nei momenti di scarsa motivazione?",
                    equilibrato_ottimizzatore: "Il tuo approccio strutturato è impressionante. Ora parliamo di ottimizzazione: dove vedi le maggiori leve per massimizzare l'efficacia di questo obiettivo? Quali sono i key performance indicators che ti interessano di più?"
                };
                
                question += profileQuestions[userProfile.profileType] || 
                           "Quando avrai raggiunto questo obiettivo, chi sarai diventato? Non solo cosa avrai ottenuto, ma che tipo di persona sarai?";
            } else {
                question += "Quando avrai raggiunto questo obiettivo, chi sarai diventato? Non solo cosa avrai ottenuto, ma che tipo di persona sarai?";
            }
            
            question += `\n\n🌟 Prenditi tutto il tempo che serve. Questa risposta è la chiave per mantenere la motivazione nei momenti difficili.`;
            
            return question;
        }

        function restoreChatHistory() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '';
            
            chatHistory.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.sender}`;
                messageDiv.innerHTML = `
                    <div class="message-content">${message.content}</div>
                    <div class="message-time">${message.time}</div>
                `;
                chatContainer.appendChild(messageDiv);
            });
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addChatMessage(message, 'user');
            input.value = '';
            
            // Get personalized AI coaching response
            try {
                const coachingResponse = await getPersonalizedSmartCoachingResponse(message);
                setTimeout(() => {
                    addChatMessage(coachingResponse, 'coach');
                }, 1500);
            } catch (error) {
                console.error('❌ Error getting coaching response:', error);
                setTimeout(() => {
                    addChatMessage(getPersonalizedFallback(message), 'coach');
                }, 1000);
            }
        }

        function addChatMessage(content, sender) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const now = new Date();
            const time = now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-content">${content}</div>
                <div class="message-time">${time}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Store in history
            chatHistory.push({ sender, content, time });
            
            // Extract insights if it's a user message
            if (sender === 'user') {
                extractSmartInsights(content);
            }
            
            autoSave();
        }

        async function getPersonalizedSmartCoachingResponse(userMessage) {
            // Use Sistema AI Integrato v2.0 if available
            if (aiSystem) {
                try {
                    const response = await aiSystem.sendMessage(userMessage);
                    if (response.success) {
                        console.log('🎯 Risposta SMART personalizzata generata:', response.personalization);
                        return response.response;
                    } else {
                        throw new Error(response.error);
                    }
                } catch (error) {
                    console.error('❌ Sistema AI SMART error:', error);
                    return getPersonalizedFallback(userMessage);
                }
            } else {
                return getPersonalizedFallback(userMessage);
            }
        }

        function getPersonalizedFallback(userMessage) {
            // Fallback personalizzato basato sul profilo per SMART goals
            if (!userProfile || !userProfile.profileType || !window.LIFESTYLE_PROFILES_CONFIG) {
                return "Quello che condividi è davvero potente. Il tuo obiettivo SMART ha delle fondamenta solide. Puoi dirmi di più su come ti senti riguardo a questo traguardo?";
            }
            
            const profileConfig = window.LIFESTYLE_PROFILES_CONFIG[userProfile.profileType];
            const messageCount = chatHistory.filter(m => m.sender === 'user').length;
            
            // Fallback responses personalizzati per SMART goals per profilo
            const personalizedSmartFallbacks = {
                stressato_esaurito: [
                    "Quello che condividi tocca il cuore del benessere. Il tuo obiettivo SMART sembra progettato per nutrirti, non svuotarti. Come ti senti quando pensi a raggiungerlo?",
                    "Sento una grande saggezza nel modo in cui hai strutturato questo obiettivo. È importante che non aggiunga stress alla tua vita. Cosa ti darebbe più energia: raggiungerlo gradualmente o avere risultati rapidi?",
                    "Il tuo approccio equilibrato al goal-setting mi colpisce. Per una persona che gestisce molto stress, hai trovato un obiettivo che può essere il tuo rifugio. Cosa ti spaventa di più: non raggiungerlo o il processo per arrivarci?"
                ],
                procrastinatore_bloccato: [
                    "Eccellente! Stai già dimostrando che puoi superare la procrastinazione semplicemente creando questo obiettivo SMART. Ora la vera domanda: qual è il primo micro-passo che ti entusiasma davvero?",
                    "Quello che mi piace del tuo obiettivo è che hai pensato alle azioni concrete. Per qualcuno che tende a rimandare, questo è oro. Cosa ti farebbe alzare domani mattina pronto ad agire?",
                    "Vedo che hai costruito un piano solido. La chiave per il tuo profilo è l'azione immediata. Se dovessi fare qualcosa per questo obiettivo NEI PROSSIMI 10 MINUTI, cosa sarebbe?"
                ],
                perfezionista_insoddisfatto: [
                    "Il tuo obiettivo SMART mostra un equilibrio bellissimo tra ambizione e realismo. Per qualcuno che tende al perfezionismo, questo è un grande progresso. Cosa ti aiuterà a celebrare i progressi intermedi?",
                    "Quello che condividi rivela una maturità nel goal-setting. Hai imparato che 'fatto è meglio che perfetto'. Come gestirai quella voce interna che vorrà sempre di più?",
                    "Il tuo approccio all'obiettivo è molto evoluto. Ma dimmi onestamente: qual è la parte che il tuo perfezionista interno critica di più? E come possiamo silenziarlo?"
                ],
                dispersivo_confuso: [
                    "Fantastico! Hai preso tutta la tua energia dispersiva e l'hai canalizzata in UN obiettivo chiaro. Questo è un superpotere. Come manterrai questo focus quando altre opportunità busseranno alla porta?",
                    "Il tuo obiettivo SMART è un esempio perfetto di focus strategico. Per qualcuno con tanti interessi come te, questa chiarezza è preziosa. Cosa farai per non perdere la bussola?",
                    "Adoro come hai trasformato la complessità in semplicità con questo obiettivo. Il focus è la tua nuova arma segreta. Quando senti che ti stai disperdendo, a cosa tornerai?"
                ],
                motivato_inconsistente: [
                    "La tua energia per questo obiettivo è contagiosa! Hai creato un SMART goal che può sfruttare la tua motivazione naturale. Come lo trasformerai in un sistema che funziona anche nei giorni 'flat'?",
                    "Quello che mi piace è che hai strutturato l'obiettivo per catturare la tua energia alta e sostenerti in quella bassa. Intelligente! Qual è il tuo piano B per i momenti di down?",
                    "Il tuo approccio sistematico al goal-setting è perfetto per il tuo profilo. Ora, come creerai l'accountability che ti serve per rimanere on track?"
                ],
                equilibrato_ottimizzatore: [
                    "Il tuo obiettivo SMART è tecnicamente eccellente e strategicamente solido. Si vede l'approccio metodico. Ora parliamo di ottimizzazione: dove vedi le maggiori leve per massimizzare l'efficacia?",
                    "Apprezzo la sofisticazione del tuo goal-setting. È evidente che hai pensato ai dettagli. Dal punto di vista della performance, quali sono i KPI che ti interessano di più?",
                    "Il tuo approccio consultivo al tuo stesso obiettivo è impressionante. Se dovessi fare un business case per questo goal, quale sarebbe il ROI più importante?"
                ]
            };
            
            const responses = personalizedSmartFallbacks[userProfile.profileType] || personalizedSmartFallbacks['motivato_inconsistente'];
            const responseIndex = Math.min(messageCount - 1, responses.length - 1);
            
            return responses[responseIndex] || responses[responses.length - 1];
        }

        function extractSmartInsights(userMessage) {
            // Extract key insights for action plan personalization
            const insights = [];
            
            if (userMessage.toLowerCase().includes('motivazione') || userMessage.toLowerCase().includes('entusiasmo')) {
                insights.push('Forte energia motivazionale per l\'obiettivo');
            }
            
            if (userMessage.toLowerCase().includes('paura') || userMessage.toLowerCase().includes('preoccupazione')) {
                insights.push('Lavoro su resistenze e limitazioni SMART');
            }
            
            if (userMessage.toLowerCase().includes('sistema') || userMessage.toLowerCase().includes('routine')) {
                insights.push('Focus su sistemi per obiettivi SMART');
            }
            
            if (userMessage.toLowerCase().includes('perfetto') || userMessage.toLowerCase().includes('migliore')) {
                insights.push('Tendenza perfezionista negli obiettivi');
            }
            
            if (userMessage.toLowerCase().includes('tempo') || userMessage.toLowerCase().includes('scadenza')) {
                insights.push('Attenzione alla componente temporale');
            }
            
            if (userMessage.toLowerCase().includes('misurazione') || userMessage.toLowerCase().includes('risultati')) {
                insights.push('Focus su tracking e misurazione');
            }
            
            coachingInsights.push(...insights);
        }

        function show30MinuteWarning() {
            document.getElementById('timeWarning').classList.add('active');
        }

        function continueSession() {
            sessionExtended = true;
            document.getElementById('timeWarning').classList.remove('active');
            showMessage('✅ Sessione estesa di 10 minuti. Completiamo il tuo piano SMART personalizzato!', 'success');
        }

        function endSession() {
            clearInterval(timerInterval);
            clearInterval(autoSaveInterval);
            completeSession();
        }

        function completeSession() {
            // Save final session data with AI insights
            const finalSessionData = {
                workshopData: workshopData,
                smartGoalData: smartGoalData,
                chatHistory: chatHistory,
                coachingInsights: coachingInsights,
                aiPersonalization: aiSystem ? aiSystem.getPersonalizationInsights() : null,
                completedAt: new Date().toISOString(),
                sessionDuration: Date.now() - sessionStartTime,
                userProfile: userProfile,
                week1Data: week1Data,
                week2Data: week2Data
            };
            
            localStorage.setItem('week3SessionCompleted', JSON.stringify(finalSessionData));
            localStorage.removeItem('week3SessionInProgress');
            
            // Update progress
            updateUserProgress();
            
            // Show completion
            document.getElementById('phase2Section').classList.remove('active');
            document.getElementById('completionSection').classList.add('active');
            
            // Generate personalized final SMART goal and action plan
            generatePersonalizedFinalSmartGoal();
            generatePersonalizedSmartActionPlan();
            
            document.getElementById('completionSection').scrollIntoView({ behavior: 'smooth' });
        }

        function generatePersonalizedFinalSmartGoal() {
            const goalEl = document.getElementById('finalSmartGoal');
            
            const areaLabels = {
                health: '💪 Salute Fisica',
                mental: '🧠 Benessere Mentale',
                relationship: '❤️ Relazioni',
                career: '💼 Carriera/Crescita'
            };
            
            const areaLabel = areaLabels[smartGoalData.area] || 'Area selezionata';
            
            // Add profile context
            let profileContext = '';
            if (userProfile && userProfile.profileType && window.LIFESTYLE_PROFILES_CONFIG) {
                const profileConfig = window.LIFESTYLE_PROFILES_CONFIG[userProfile.profileType];
                profileContext = `<div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #22c55e;">
                    <strong style="color: #16a34a;">🎯 Personalizzato per ${profileConfig.name} ${profileConfig.emoji}</strong>
                    <p style="color: #15803d; margin: 0.5rem 0 0 0; font-size: 0.9rem;">${profileConfig.communication_style}</p>
                </div>`;
            }
            
            goalEl.innerHTML = `
                ${profileContext}
                <div style="background: white; padding: 2rem; border-radius: 12px; border-left: 4px solid #16a34a;">
                    <h4 style="color: #16a34a; margin-bottom: 1rem; font-size: 1.2rem;">${areaLabel}</h4>
                    
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: #1e293b;">🎯 SPECIFICO:</strong>
                        <p style="color: #64748b; margin: 0.5rem 0;">${smartGoalData.specific}</p>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: #1e293b;">📊 MISURABILE:</strong>
                        <p style="color: #64748b; margin: 0.5rem 0;">${smartGoalData.measurable}</p>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: #1e293b;">✅ RAGGIUNGIBILE:</strong>
                        <p style="color: #64748b; margin: 0.5rem 0;">${smartGoalData.achievable}</p>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: #1e293b;">🎯 RILEVANTE:</strong>
                        <p style="color: #64748b; margin: 0.5rem 0;">${smartGoalData.relevant}</p>
                    </div>
                    
                    <div>
                        <strong style="color: #1e293b;">⏰ TEMPORIZZATO:</strong>
                        <p style="color: #64748b; margin: 0.5rem 0;">${smartGoalData.timebound}</p>
                    </div>
                </div>
            `;
        }

        function generatePersonalizedSmartActionPlan() {
            const actionPlanList = document.getElementById('personalizedActionPlan');
            let actionPlan = [];
            
            // Base SMART action plan
            actionPlan.push("✅ Settimana 1: Implementa la prima azione concreta che hai definito");
            actionPlan.push("✅ Ogni lunedì: Rivedi il progresso e aggiusta il piano se necessario");
            
            // Profile-specific action plan
            if (userProfile && userProfile.profileType) {
                switch (userProfile.profileType) {
                    case 'stressato_esaurito':
                        actionPlan.push("✅ Check-in energia: valuta quotidianamente se l'obiettivo ti nutre o ti svuota");
                        actionPlan.push("✅ Pacing strategy: procedi con i tuoi ritmi, mai forzare");
                        actionPlan.push("✅ Recovery planning: pianifica pause e momenti di recupero");
                        break;
                        
                    case 'procrastinatore_bloccato':
                        actionPlan.push("✅ Regola dei 2 minuti: se qualcosa richiede meno di 2 min, fallo subito");
                        actionPlan.push("✅ Micro-azioni quotidiane: un piccolissimo passo ogni giorno");
                        actionPlan.push("✅ Celebrazione immediata: riconosci ogni azione completata");
                        break;
                        
                    case 'perfezionista_insoddisfatto':
                        actionPlan.push("✅ Standard del 'buono abbastanza': definisci cosa significa per ogni milestone");
                        actionPlan.push("✅ Progressi imperfetti: celebra anche i risultati non perfetti");
                        actionPlan.push("✅ Time-boxing: limita il tempo dedicato a perfezionare");
                        break;
                        
                    case 'dispersivo_confuso':
                        actionPlan.push("✅ Focus reminder: una frase che ti riporta all'obiettivo quando ti distrai");
                        actionPlan.push("✅ Mono-tasking: lavora solo su questo obiettivo alla volta");
                        actionPlan.push("✅ Decisioni filtro: ogni nuova opportunità passa il test dell'obiettivo");
                        break;
                        
                    case 'motivato_inconsistente':
                        actionPlan.push("✅ Sistema automatico: crea trigger che non dipendono dalla motivazione");
                        actionPlan.push("✅ Accountability esterno: qualcuno che ti chiede conto dei progressi");
                        actionPlan.push("✅ Motivazione di backup: lista di ragioni per continuare nei giorni difficili");
                        break;
                        
                    case 'equilibrato_ottimizzatore':
                        actionPlan.push("✅ KPI tracking: monitora le metriche chiave settimanalmente");
                        actionPlan.push("✅ Ottimizzazione continua: review mensile per miglioramenti");
                        actionPlan.push("✅ A/B testing: sperimenta approcci diversi per massimizzare risultati");
                        break;
                }
            }
            
            // Personalized based on SMART goal
            if (smartGoalData.nextAction) {
                actionPlan.push(`✅ Azione immediata personalizzata: ${smartGoalData.nextAction}`);
            }
            
            if (smartGoalData.accountability) {
                actionPlan.push(`✅ Sistema di supporto attivato: ${smartGoalData.accountability}`);
            }
            
            // Based on area with profile consideration
            if (smartGoalData.area === 'health') {
                actionPlan.push("✅ Traccia progressi olistici: fisici, energetici ed emotivi");
                if (userProfile?.profileType === 'stressato_esaurito') {
                    actionPlan.push("✅ Focus recupero: priorità su riposo e nutrizione prima di intensità");
                }
            }
            
            if (smartGoalData.area === 'mental') {
                actionPlan.push("✅ Mindfulness quotidiana: 10 minuti alla stessa ora ogni giorno");
                if (userProfile?.profileType === 'perfezionista_insoddisfatto') {
                    actionPlan.push("✅ Auto-compassione practice: sostituisci giudizio con gentilezza");
                }
            }
            
            if (smartGoalData.area === 'relationship') {
                actionPlan.push("✅ Qualità over quantità: focus su connessioni profonde");
                if (userProfile?.profileType === 'dispersivo_confuso') {
                    actionPlan.push("✅ One conversation focus: una conversazione importante alla volta");
                }
            }
            
            if (smartGoalData.area === 'career') {
                actionPlan.push("✅ Skill development mirato: competenze specifiche per l'obiettivo");
                if (userProfile?.profileType === 'equilibrato_ottimizzatore') {
                    actionPlan.push("✅ Network strategico: connessioni di valore per l'obiettivo");
                }
            }
            
            // Based on coaching insights
            if (coachingInsights.includes('Focus su sistemi per obiettivi SMART')) {
                actionPlan.push("✅ System design: crea processi automatici per il tuo obiettivo");
            }
            
            if (coachingInsights.includes('Attenzione alla componente temporale')) {
                actionPlan.push("✅ Time management avanzato: blocca tempo sacro per l'obiettivo");
            }
            
            if (coachingInsights.includes('Focus su tracking e misurazione')) {
                actionPlan.push("✅ Dashboard personale: visualizza progressi e metriche chiave");
            }
            
            // Always add with profile twist
            actionPlan.push("✅ Milestone celebration: riconosci ogni progresso in modo autentico per te");
            actionPlan.push("✅ Pivot permission: aggiusta l'obiettivo se necessario senza sensi di colpa");
            
            // Profile-specific closing
            if (userProfile && userProfile.profileType && window.LIFESTYLE_PROFILES_CONFIG) {
                const profileConfig = window.LIFESTYLE_PROFILES_CONFIG[userProfile.profileType];
                actionPlan.push(`✅ Approccio ${profileConfig.name}: ${profileConfig.coaching_approach}`);
            }
            
            // Update action plan list
            actionPlanList.innerHTML = actionPlan.map(item => `<li>${item}</li>`).join('');
        }

        function updateUserProgress() {
            try {
                const progress = JSON.parse(localStorage.getItem('lifestyleProgress') || '{}');
                progress.completedWeeks = progress.completedWeeks || [];
                
                if (!progress.completedWeeks.includes(3)) {
                    progress.completedWeeks.push(3);
                    progress.currentWeek = 4;
                    progress.lastUpdate = new Date().toISOString();
                    
                    localStorage.setItem('lifestyleProgress', JSON.stringify(progress));
                }
            } catch (error) {
                console.error('❌ Error updating progress:', error);
            }
        }

        function downloadSmartPlan() {
            const planContent = generatePersonalizedSmartReport();
            
            const blob = new Blob([planContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Piano_SMART_Personalizzato_${userProfile?.name || 'Utente'}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage('📄 Piano SMART personalizzato scaricato!', 'success');
        }

        function generatePersonalizedSmartReport() {
            const profileName = userProfile && userProfile.profileType && window.LIFESTYLE_PROFILES_CONFIG ? 
                window.LIFESTYLE_PROFILES_CONFIG[userProfile.profileType].name : 'Non definito';
            
            return `
                PIANO OBIETTIVI SMART PERSONALIZZATO - SETTIMANA 3
                
                Andrea Padoan - Lifestyle Coach con AI Personalizzato
                
                Caro/a ${userProfile?.name || 'Amico/a'},
                
                Che sessione straordinaria! Hai trasformato un desiderio vago in un obiettivo
                SMART concreto e realizzabile, completamente personalizzato per il tuo profilo
                "${profileName}". Il mio sistema AI ha calibrato ogni aspetto per te.
                
                === IL TUO PROFILO E APPROCCIO ===
                
                PROFILO LIFESTYLE: ${profileName}
                APPROCCIO COACHING: ${userProfile && userProfile.profileType && window.LIFESTYLE_PROFILES_CONFIG ? 
                    window.LIFESTYLE_PROFILES_CONFIG[userProfile.profileType].coaching_approach : 'Adattivo personalizzato'}
                STILE COMUNICATIVO: ${userProfile && userProfile.profileType && window.LIFESTYLE_PROFILES_CONFIG ? 
                    window.LIFESTYLE_PROFILES_CONFIG[userProfile.profileType].communication_style : 'Empatico e supportivo'}
                
                === IL TUO OBIETTIVO SMART PERSONALIZZATO ===
                
                AREA DI FOCUS: ${(() => {
                    const areaLabels = {
                        health: 'Salute Fisica',
                        mental: 'Benessere Mentale', 
                        relationship: 'Relazioni',
                        career: 'Carriera/Crescita'
                    };
                    return areaLabels[smartGoalData.area] || 'Area selezionata';
                })()}
                
                🎯 SPECIFICO (Personalizzato per te):
                ${smartGoalData.specific || 'Obiettivo specifico definito'}
                
                📊 MISURABILE (Metriche per il tuo profilo):
                ${smartGoalData.measurable || 'Metriche di misurazione definite'}
                
                ✅ RAGGIUNGIBILE (Calibrato per ${profileName}):
                ${smartGoalData.achievable || 'Analisi di fattibilità completata'}
                
                🎯 RILEVANTE (Allineato ai tuoi valori):
                ${smartGoalData.relevant || 'Allineamento con valori confermato'}
                
                ⏰ TEMPORIZZATO (Ritmi per il tuo profilo):
                ${smartGoalData.timebound || 'Tempistica definita'}
                
                === CONNESSIONE CON IL TUO PERCORSO PERSONALIZZATO ===
                
                ${week1Data && week1Data.phase1Data ? 
                `SETTIMANA 1 - Il tuo obiettivo da sogno era: "${week1Data.phase1Data.dreamGoal || 'la tua trasformazione'}"
                Ora hai un piano concreto personalizzato per realizzarlo!` : 
                'Questo obiettivo SMART si basa sulla consapevolezza sviluppata nelle settimane precedenti.'}
                
                ${week2Data && week2Data.testResults && week2Data.testResults.topValues ? 
                (() => {
                    const valueLabels = {
                        family: 'famiglia e relazioni',
                        career: 'successo professionale',
                        health: 'salute e benessere',
                        growth: 'crescita personale',
                        freedom: 'libertà e indipendenza'
                    };
                    const topValue = valueLabels[week2Data.testResults.topValues[0][0]];
                    return `SETTIMANA 2 - Il tuo valore principale è ${topValue}
                Il tuo obiettivo SMART è perfettamente allineato con questo valore e il tuo profilo!`;
                })() : 
                'SETTIMANA 2 - La consapevolezza dei tuoi valori guida questo obiettivo.'}
                
                === INSIGHTS PERSONALIZZATI AI ===
                ${coachingInsights.length > 0 ? coachingInsights.map(insight => `• ${insight}`).join('\n                ') : '• Sistema AI ha identificato pattern unici per il tuo profilo'}
                
                === IL TUO PIANO D'AZIONE PERSONALIZZATO ===
                
                🚀 AZIONE IMMEDIATA (Per il tuo profilo):
                ${smartGoalData.nextAction || 'Prima azione concreta calibrata per te'}
                
                🛡️ GESTIONE OSTACOLI (Strategia per ${profileName}):
                ${smartGoalData.obstacles || 'Strategie personalizzate per superare le sfide'}
                
                🤝 SISTEMA DI SUPPORTO (Adatto a te):
                ${smartGoalData.accountability || 'Rete di supporto definita per il tuo profilo'}
                
                === STRATEGIA SETTIMANALE PER ${profileName.toUpperCase()} ===
                
                ${userProfile && userProfile.profileType ? getProfileSpecificWeeklyPlan(userProfile.profileType) : getGenericWeeklyPlan()}
                
                === MESSAGGI PERSONALIZZATI PER TE ===
                
                ${userProfile?.name || 'Amico/a'}, quello che hai creato oggi non è solo un obiettivo,
                è un ponte verso la versione migliore di te stesso, costruito appositamente
                per il tuo profilo "${profileName}".
                
                ${getPersonalizedMotivationalMessage(userProfile?.profileType)}
                
                === SISTEMA DI MISURAZIONE PERSONALIZZATO ===
                
                ${getProfileSpecificTracking(userProfile?.profileType)}
                
                === PREPARAZIONE SETTIMANA 4 ===
                
                Nella prossima settimana "Piano di Azione" il sistema AI prenderà questo
                obiettivo SMART personalizzato e creerà un sistema completo per realizzarlo,
                con strategie avanzate calibrate per il tuo profilo "${profileName}".
                
                Il tuo coach AI personalizzato,
                Andrea 🤖🎯
                
                P.S. Questo piano è stato generato specificamente per il tuo profilo.
                Rileggi le sezioni personalizzate ogni volta che hai bisogno di motivazione!
            `;
        }

        function getProfileSpecificWeeklyPlan(profileType) {
            const plans = {
                stressato_esaurito: `
                SETTIMANA 1: GENTILE INIZIO
                - Implementa l'azione base solo se ti senti energico
                - Priorità: ascolta il tuo corpo e i tuoi ritmi
                - Check-in quotidiano: "Come mi sento oggi?"
                
                SETTIMANA 2: COSTRUZIONE GRADUALE
                - Aumenta l'intensità solo se la settimana 1 è andata bene
                - Focus su recovery e sostentamento
                - Celebra ogni piccolo progresso senza pressione
                
                SETTIMANA 3-4: RITMO SOSTENIBILE
                - Trova il tuo ritmo naturale per l'obiettivo
                - Non confrontarti con altri: vai con i tuoi tempi
                - Aggiusta il piano se serve, senza sensi di colpa`,
                
                procrastinatore_bloccato: `
                SETTIMANA 1: MICRO-AZIONI IMMEDIATE
                - Prima azione entro 24 ore (anche di 2 minuti)
                - Celebra immediatamente ogni completamento
                - Focus: "Fatto è meglio che perfetto"
                
                SETTIMANA 2: MOMENTUM BUILDING
                - Aumenta gradualmente la dimensione delle azioni
                - Crea chain di successi: una azione al giorno
                - Sistema di reward per mantenere motivazione
                
                SETTIMANA 3-4: SISTEMATIZZAZIONE
                - Trasforma azioni in routine automatiche
                - Accountability partner per sostegno
                - Track dei progressi per motivazione visiva`,
                
                perfezionista_insoddisfatto: `
                SETTIMANA 1: STANDARD "BUONO ABBASTANZA"
                - Definisci cosa significa "completato" vs "perfetto"
                - Prima azione con time-box: limite tempo per perfezionare
                - Focus: progresso over perfezione
                
                SETTIMANA 2: CELEBRAZIONE IMPERFETTA
                - Riconosci attivamente i progressi imperfetti
                - Pratica auto-compassione per "errori"
                - Lista giornaliera: "Cosa ho fatto bene oggi?"
                
                SETTIMANA 3-4: INTEGRAZIONE GENTILE
                - Accetta che "abbastanza buono" può essere eccellente
                - Bilancia ambizione con auto-accettazione
                - Review settimanale sui progressi senza giudizio`,
                
                dispersivo_confuso: `
                SETTIMANA 1: FOCUS LASER
                - Una sola priorità: questo obiettivo SMART
                - Elimina distrazioni durante il lavoro sull'obiettivo
                - Reminder costante: "È questa la mia priorità #1"
                
                SETTIMANA 2: PROTEZIONE DEL FOCUS
                - Dici NO a nuove opportunità che distraggono
                - Time-blocking per l'obiettivo principale
                - Review serale: "Sono rimasto focalizzato?"
                
                SETTIMANA 3-4: ESPANSIONE CONTROLLATA
                - Se l'obiettivo è on track, considera altre aree
                - Mantieni sempre questo come priorità principale
                - Sistema decisionale: "Questo aiuta il mio obiettivo?"`,
                
                motivato_inconsistente: `
                SETTIMANA 1: SISTEMA SETUP
                - Crea routine automatiche che non dipendono da motivazione
                - Setup environment per successo facile
                - Track visuale per mantenere accountability
                
                SETTIMANA 2: MOMENTUM E BACKUP
                - Sfrutta i giorni di alta energia per andare avanti
                - Crea piano B per giorni di bassa motivazione
                - Sistema di reward per consistenza
                
                SETTIMANA 3-4: AUTOMATIZZAZIONE
                - Habit stacking: collega obiettivo a routine esistenti
                - External accountability: qualcuno che ti chiede conto
                - Sistema di recovery rapido per quando "salti" giorni`,
                
                equilibrato_ottimizzatore: `
                SETTIMANA 1: BASELINE E METRICHE
                - Setup sistema di tracking avanzato
                - Baseline measurements per confronti futuri
                - Identifica KPI principali e secondari
                
                SETTIMANA 2: PRIMI OTTIMIZZAMENTI
                - Analizza cosa funziona meglio nella settimana 1
                - A/B test diversi approcci per massimizzare efficacia
                - Adjust strategia basata su early data
                
                SETTIMANA 3-4: SCALING E REFINEMENT
                - Scale up gli approcci più efficaci
                - Continuous improvement basato su data
                - Prepare roadmap per ottimizzazioni future`
            };
            
            return plans[profileType] || getGenericWeeklyPlan();
        }

        function getGenericWeeklyPlan() {
            return `
                SETTIMANA 1: IMPLEMENTAZIONE BASE
                - Inizia con la prima azione concreta definita
                - Stabilisci routine quotidiana di base
                - Comunica l'obiettivo al sistema di supporto
                
                SETTIMANA 2: ADATTAMENTO E FINE-TUNING
                - Misura i primi progressi con le metriche SMART
                - Aggiusta il piano basato su feedback iniziale
                - Celebra i primi successi per mantenere momentum
                
                SETTIMANA 3-4: CONSOLIDAMENTO
                - Affronta e supera i primi ostacoli incontrati
                - Ottimizza le strategie che funzionano meglio
                - Prepara il piano per il mese successivo`;
        }

        function getPersonalizedMotivationalMessage(profileType) {
            const messages = {
                stressato_esaurito: "La tua forza nel continuare questo percorso nonostante le sfide dimostra una resilienza incredibile. Il tuo obiettivo SMART è progettato per nutrirti, non svuotarti. Vai con i tuoi tempi naturali.",
                procrastinatore_bloccato: "Il fatto che tu abbia creato questo piano dettagliato dimostra che puoi superare ogni blocco. Il tuo obiettivo SMART ha la struttura perfetta per trasformare la procrastinazione in azione.",
                perfezionista_insoddisfatto: "La tua capacità di bilanciare ambizione e realismo in questo obiettivo SMART mostra una maturità straordinaria. Ricorda: il progresso imperfetto è infinitamente meglio della perfezione paralizzante.",
                dispersivo_confuso: "La tua ricchezza mentale ora ha una direzione chiara. Questo obiettivo SMART è la tua bussola per canalizzare tutta la tua energia e creatività verso risultati concreti.",
                motivato_inconsistente: "La tua energia naturale combinata con questo sistema SMART strutturato è una combinazione imbattibile. Ora hai gli strumenti per trasformare l'entusiasmo in risultati consistenti.",
                equilibrato_ottimizzatore: "Il tuo approccio metodico e la capacità di auto-analisi hanno prodotto un obiettivo SMART di qualità superiore. Sei sulla strada giusta per raggiungere livelli di performance eccellenti."
            };
            
            return messages[profileType] || "La tua autenticità e il tuo impegno in questo percorso sono straordinari. Questo obiettivo SMART riflette perfettamente chi sei e dove vuoi andare.";
        }

        function getProfileSpecificTracking(profileType) {
            const tracking = {
                stressato_esaurito: `
                CONTROLLI QUOTIDIANI GENTILI:
                - Livello energia (1-10): solo se ti va di misurare
                - L'obiettivo mi nutre o mi svuota oggi?
                - Di cosa ho bisogno per sostenermi?
                
                CONTROLLI SETTIMANALI COMPASSIONEVOLI:
                - Progresso senza pressione: dove sono arrivato?
                - Cosa ha funzionato per il mio benessere?
                - Come posso essere più gentile con me stesso?`,
                
                procrastinatore_bloccato: `
                CONTROLLI QUOTIDIANI AZIONE-ORIENTED:
                - Ho fatto la micro-azione di oggi? (Sì/No)
                - Cosa mi ha fatto procrastinare? Cosa mi ha fatto agire?
                - Come posso rendere domani ancora più facile?
                
                CONTROLLI SETTIMANALI MOMENTUM:
                - Quanti giorni ho agito vs procrastinato?
                - Quale azione mi ha dato più soddisfazione?
                - Come posso aumentare le vittorie la prossima settimana?`,
                
                perfezionista_insoddisfatto: `
                CONTROLLI QUOTIDIANI PROGRESS-FOCUSED:
                - Cosa ho completato oggi (anche se imperfetto)?
                - Ho celebrato i progressi fatti?
                - Il mio standard "buono abbastanza" è realistico?
                
                CONTROLLI SETTIMANALI BILANCIATI:
                - Sto progredendo senza paralizzarmi nella perfezione?
                - Cosa ho imparato dagli "errori" di questa settimana?
                - Come posso essere più compassionevole verso me stesso?`,
                
                dispersivo_confuso: `
                CONTROLLI QUOTIDIANI FOCUS-DRIVEN:
                - Sono rimasto focalizzato sul mio obiettivo principale?
                - Quante distrazioni ho detto NO oggi?
                - La mia energia è andata dove doveva andare?
                
                CONTROLLI SETTIMANALI CLARITY:
                - Il mio focus è rimasto costante sulla priorità #1?
                - Quali distrazioni devo eliminare meglio?
                - Come posso proteggere ancora di più il mio focus?`,
                
                motivato_inconsistente: `
                CONTROLLI QUOTIDIANI SISTEMA-BASED:
                - Il mio sistema ha funzionato anche senza motivazione alta?
                - Ho seguito la routine indipendentemente dall'umore?
                - Il mio tracking visuale è aggiornato?
                
                CONTROLLI SETTIMANALI CONSISTENCY:
                - Quanti giorni sono stato consistente vs inconsistente?
                - Il mio sistema di backup per giorni difficili funziona?
                - Come posso automatizzare ancora di più?`,
                
                equilibrato_ottimizzatore: `
                CONTROLLI QUOTIDIANI ANALYTICS:
                - KPI principali: dove sono rispetto al target?
                - Efficacia delle strategie implementate oggi?
                - Quali ottimizzazioni posso applicare domani?
                
                CONTROLLI SETTIMANALI PERFORMANCE:
                - Analisi trend: sto migliorando settimana su settimana?
                - ROI delle diverse strategie implementate?
                - Quali esperimenti lanciare la prossima settimana?`
            };
            
            return tracking[profileType] || `
                CONTROLLI QUOTIDIANI:
                - Ho fatto l'azione prevista per oggi?
                - Come mi sento rispetto al mio obiettivo?
                - Cosa ho imparato oggi?
                
                CONTROLLI SETTIMANALI:
                - Sto procedendo secondo il piano SMART?
                - Cosa devo aggiustare la prossima settimana?
                - Come posso migliorare la mia strategia?`;
        }

        function scheduleNextSession() {
            const nextWeekDate = new Date();
            nextWeekDate.setDate(nextWeekDate.getDate() + 7);
            
            const message = `📅 Settimana 4 "Piano di Azione" con AI personalizzato disponibile il ${nextWeekDate.toLocaleDateString('it-IT')}!`;
            showMessage(message, 'info');
            
            localStorage.setItem('nextSessionReminder', nextWeekDate.toISOString());
        }

        function showMessage(message, type = 'info') {
            const colors = {
                success: '#16a34a',
                warning: '#f59e0b',
                info: '#3b82f6',
                error: '#ef4444'
            };
            
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: ${colors[type]}; color: white; padding: 1rem 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; max-width: 400px; animation: slideIn 0.3s ease-out;">
                    ${message}
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Handle Enter key in chat
        document.getElementById('chatInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            if (currentPhase !== 'completed') {
                autoSave();
            }
        });

        // Add slide-in animation style
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>