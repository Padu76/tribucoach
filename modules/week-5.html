<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settimana 5 - Trasformazione Abitudini | Andrea Padoan Coach</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #fff7ed 50%, #f0fdf4 100%);
            min-height: 100vh;
            color: #1e293b;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .session-info {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .timer-display {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-bar {
            background: rgba(255,255,255,0.2);
            width: 200px;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            background: #22c55e;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .back-button {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            color: white;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Phase Indicator */
        .phase-indicator {
            background: white;
            border-radius: 12px;
            padding: 1rem 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .phase-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            min-width: 280px;
        }

        .phase-step.active {
            background: linear-gradient(135deg, #ea580c 0%, #fb923c 100%);
            color: white;
        }

        .phase-step.completed {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: white;
        }

        .phase-step.inactive {
            background: #f1f5f9;
            color: #94a3b8;
        }

        .phase-arrow {
            font-size: 1.5rem;
            color: #64748b;
        }

        /* Welcome Section */
        .welcome-section {
            background: white;
            border-radius: 16px;
            padding: 3rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            text-align: center;
        }

        .welcome-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 1rem;
        }

        .welcome-subtitle {
            font-size: 1.3rem;
            color: #ea580c;
            margin-bottom: 2rem;
        }

        .journey-recap {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: left;
        }

        .recap-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #16a34a;
            margin-bottom: 1rem;
            text-align: center;
        }

        .process-explanation {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: left;
        }

        .process-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ea580c;
            margin-bottom: 1rem;
            text-align: center;
        }

        .process-steps {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .process-step {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #ea580c;
        }

        .step-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ea580c;
            margin-bottom: 0.5rem;
        }

        .step-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .step-description {
            font-size: 0.9rem;
            color: #64748b;
            line-height: 1.5;
        }

        .step-duration {
            font-size: 0.8rem;
            color: #ea580c;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        /* Phase 1 - Habits Workshop */
        .phase1-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: none;
        }

        .phase1-section.active {
            display: block;
        }

        .phase-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f1f5f9;
        }

        .phase-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .phase-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .phase-subtitle {
            font-size: 1rem;
            color: #64748b;
        }

        .workshop-progress {
            background: #f1f5f9;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .workshop-progress-text {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .workshop-progress-bar {
            background: #e2e8f0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .workshop-progress-fill {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .workshop-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 12px;
            border-left: 4px solid #ea580c;
        }

        .workshop-section h3 {
            color: #1e293b;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .theory-box {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border-left: 4px solid #ea580c;
        }

        .theory-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ea580c;
            margin-bottom: 1rem;
        }

        .srg-model {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .srg-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-top: 4px solid;
        }

        .srg-card.signal {
            border-color: #3b82f6;
        }

        .srg-card.routine {
            border-color: #ea580c;
        }

        .srg-card.reward {
            border-color: #16a34a;
        }

        .srg-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .srg-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1e293b;
        }

        .srg-description {
            font-size: 0.9rem;
            color: #64748b;
            line-height: 1.4;
        }

        .exercise-group {
            margin-bottom: 2rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .exercise-title {
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1e293b;
            font-size: 1.1rem;
        }

        .habit-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .habit-input {
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .habit-input:focus {
            outline: none;
            border-color: #ea580c;
        }

        .habit-input.signal {
            border-left: 4px solid #3b82f6;
        }

        .habit-input.routine {
            border-left: 4px solid #ea580c;
        }

        .habit-input.reward {
            border-left: 4px solid #16a34a;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #ea580c;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .habit-examples {
            background: #f0f9ff;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #3b82f6;
        }

        .examples-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 0.5rem;
        }

        .examples-list {
            font-size: 0.9rem;
            color: #1e40af;
            line-height: 1.4;
        }

        /* Phase 2 - Coaching */
        .phase2-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: none;
        }

        .phase2-section.active {
            display: block;
        }

        .coaching-context {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .coaching-context h3 {
            color: #16a34a;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .coaching-context p {
            color: #15803d;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .habits-summary {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #16a34a;
        }

        .habits-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .habits-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .habit-card {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            border-left: 3px solid #ea580c;
        }

        .habit-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #ea580c;
            margin-bottom: 0.25rem;
        }

        .habit-value {
            font-size: 0.9rem;
            color: #1e293b;
        }

        .chat-container {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 12px;
            max-width: 85%;
            animation: messageSlide 0.3s ease-out;
        }

        .message.coach {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            margin-right: auto;
        }

        .message.user {
            background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%);
            margin-left: auto;
            text-align: right;
        }

        .message-content {
            font-size: 1rem;
            line-height: 1.5;
            margin-bottom: 0.5rem;
        }

        .message-time {
            font-size: 0.8rem;
            color: #64748b;
        }

        .chat-input {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .chat-input input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .chat-input input:focus {
            outline: none;
            border-color: #ea580c;
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #16a34a;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .btn-secondary {
            background: white;
            color: #1e293b;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            border-color: #ea580c;
            color: #ea580c;
        }

        .btn-success {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
        }

        .btn-disabled {
            background: #94a3b8;
            color: white;
            cursor: not-allowed;
        }

        /* Navigation Buttons */
        .form-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        /* Time Warning */
        .time-warning {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }

        .time-warning.active {
            display: block;
        }

        /* Completion Section */
        .completion-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-top: 2rem;
            display: none;
        }

        .completion-section.active {
            display: block;
        }

        .completion-title {
            font-size: 2rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 1rem;
            text-align: center;
        }

        .completion-message {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #475569;
            margin-bottom: 2rem;
            text-align: center;
        }

        .habits-results {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .results-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #16a34a;
            margin-bottom: 1rem;
        }

        .habits-plan {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .plan-item {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #16a34a;
        }

        .plan-type {
            font-size: 0.8rem;
            font-weight: 600;
            color: #16a34a;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .plan-habit {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .plan-details {
            font-size: 0.9rem;
            color: #64748b;
            line-height: 1.4;
        }

        .homework-section {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .homework-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ea580c;
            margin-bottom: 1rem;
        }

        .homework-list {
            list-style: none;
            padding: 0;
        }

        .homework-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(234, 88, 12, 0.2);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .homework-list li:last-child {
            border-bottom: none;
        }

        .completion-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* Animations */
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            
            // Based on previous weeks integration
            if (previousWeeksData.week2 && previousWeeksData.week2.testResults && previousWeeksData.week2.testResults.topValues) {
                const valueLabels = {
                    family: 'famiglia e relazioni',
                    career: 'successo professionale',
                    health: 'salute e benessere',
                    growth: 'crescita personale',
                    freedom: 'libertà e indipendenza'
                };
                const topValue = valueLabels[previousWeeksData.week2.testResults.topValues[0][0]];
                homework.push(`✅ Connetti le nuove abitudini al tuo valore: ${topValue}`);
            }
            
            // Based on coaching insights
            if (habitsInsights.includes('Preferenza per routine mattutine')) {
                homework.push("✅ Crea una 'routine del risveglio' che includa la nuova abitudine");
            }
            
            if (habitsInsights.includes('Gestione stress come priorità')) {
                homework.push("✅ Usa le abitudini come 'ancora' nei momenti di stress");
            }
            
            if (habitsInsights.includes('Componente sociale importante')) {
                homework.push("✅ Coinvolgi famiglia/amici nel supporto alle nuove abitudini");
            }
            
            // Always add
            homework.push("✅ Celebra ogni piccola vittoria: 1% di miglioramento ogni giorno");
            homework.push("✅ Se salti un giorno, riprendi immediatamente (regola del non-saltare-due-volte)");
            homework.push("✅ Tieni un 'habit tracker' semplice: segna X ogni giorno completato");
            
            // Update homework list
            homeworkList.innerHTML = homework.map(item => `<li>${item}</li>`).join('');
        }

        function updateUserProgress() {
            try {
                const progress = JSON.parse(localStorage.getItem('lifestyleProgress') || '{}');
                progress.completedWeeks = progress.completedWeeks || [];
                
                if (!progress.completedWeeks.includes(5)) {
                    progress.completedWeeks.push(5);
                    progress.currentWeek = 6;
                    progress.lastUpdate = new Date().toISOString();
                    
                    localStorage.setItem('lifestyleProgress', JSON.stringify(progress));
                }
            } catch (error) {
                console.error('❌ Error updating progress:', error);
            }
        }

        function downloadHabitsSystem() {
            const systemContent = `
                SISTEMA DI TRASFORMAZIONE ABITUDINI - SETTIMANA 5
                
                Andrea Padoan - Lifestyle Coach
                
                Caro/a ${userProfile?.name || 'Amico/a'},
                
                Che sistema potente abbiamo costruito insieme! 
                Attraverso il workshop scientifico e il nostro coaching approfondito,
                hai ora un sistema personalizzato per trasformare le tue abitudini.
                
                === IL TUO SISTEMA SRG (SEGNALE-ROUTINE-GRATIFICAZIONE) ===
                
                🔄 ABITUDINE DA ELIMINARE:
                Segnale: "${habitsData.badHabitSignal || 'Da identificare'}"
                Routine: "${habitsData.badHabitRoutine || 'Da eliminare'}"
                Gratificazione: "${habitsData.badHabitReward || 'Da sostituire'}"
                
                ✅ ABITUDINE DA CREARE:
                Segnale: "${habitsData.goodHabitSignal || 'Da stabilire'}"
                Routine: "${habitsData.goodHabitRoutine || 'Da implementare'}"
                Gratificazione: "${habitsData.goodHabitReward || 'Da gustare'}"
                
                === ANALISI APPROFONDITA ===
                
                SITUAZIONI TRIGGER:
                "${habitsData.habitTriggers || 'Da osservare nei prossimi giorni'}"
                
                OSTACOLI PRINCIPALI:
                "${habitsData.habitBarriers || 'Da superare con strategia'}"
                
                CONNESSIONE CON OBIETTIVI:
                "${habitsData.habitConnection || 'Da sviluppare ulteriormente'}"
                
                IDENTITÀ FUTURA:
                "${habitsData.habitIdentity || 'Versione migliore da realizzare'}"
                
                === INSIGHTS DAL COACHING ===
                ${habitsInsights.length > 0 ? habitsInsights.map(insight => `• ${insight}`).join('\n                ') : '• Continua a sviluppare consapevolezza sulle abitudini'}
                
                === INTEGRAZIONE CON IL PERCORSO ===
                
                ${previousWeeksData.week1 && previousWeeksData.week1.phase1Data ? 
                `CONNESSIONE SETTIMANA 1:
                Il tuo obiettivo "${previousWeeksData.week1.phase1Data.dreamGoal || 'di trasformazione'}" 
                ora ha un sistema concreto di abitudini per essere raggiunto.` : 
                'Le abitudini supportano i tuoi obiettivi di crescita personale.'}
                
                ${previousWeeksData.week2 && previousWeeksData.week2.testResults ? 
                `CONNESSIONE SETTIMANA 2:
                Le nuove abitudini sono allineate con la tua consapevolezza e i tuoi valori profondi.` : 
                'Le abitudini riflettono i tuoi valori autentici.'}
                
                === IL TUO PIANO DI IMPLEMENTAZIONE ===
                
                📅 SETTIMANA 1-2: STABILIRE IL SEGNALE
                • Identifica il momento esatto per la nuova abitudine
                • Crea promemoria ambientali (post-it, app, oggetti)
                • Pratica la "regola dei 2 minuti": versione mini dell'abitudine
                • Traccia quando il segnale si presenta naturalmente
                
                📅 SETTIMANA 3-4: CONSOLIDARE LA ROUTINE
                • Aumenta gradualmente la durata/intensità
                • Elimina la friction: rendi l'abitudine più facile possibile
                • Stabilisci la gratificazione immediata
                • Inizia habit stacking: collega a abitudini esistenti
                
                📅 SETTIMANA 5-8: AUTOMATIZZAZIONE
                • L'abitudine diventa naturale e automatica
                • Puoi aggiungere variazioni o aumentare la complessità
                • Pianifica la prossima abitudine da aggiungere al sistema
                • Diventa il tipo di persona che fa queste cose naturalmente
                
                === STRATEGIA ANTI-SABOTAGGIO ===
                
                🛡️ SE SALTI UN GIORNO:
                • Non giudicarti: è normale e previsto
                • Riprendi immediatamente il giorno dopo
                • Analizza cosa è andato storto: segnale poco chiaro? Routine troppo complessa?
                • Applica la regola del "non-saltare-mai-due-volte"
                
                🛡️ SE PERDI MOTIVAZIONE:
                • Ricorda la tua identità futura: "${habitsData.habitIdentity || 'la migliore versione di te'}"
                • Torna alla versione minima dell'abitudine (regola dei 2 minuti)
                • Celebra i progressi fatti finora
                • Riconnettiti con il "perché" profondo di questa trasformazione
                
                🛡️ SE GLI OSTACOLI SEMBRANO INSORMONTABILI:
                • Rivedi: "${habitsData.habitBarriers || 'i tuoi ostacoli identificati'}"
                • Modifica l'ambiente per rendere l'abitudine inevitabile
                • Chiedi supporto sociale: famiglia, amici, comunità
                • Ricorda: non serve essere perfetti, serve essere consistenti
                
                === HABIT TRACKER SEMPLICE ===
                
                Settimana: ___________
                
                🗓️ ABITUDINE: ${habitsData.goodHabitRoutine || '[La tua abitudine]'}
                
                Lun: ⭕  Mar: ⭕  Mer: ⭕  Gio: ⭕  Ven: ⭕  Sab: ⭕  Dom: ⭕
                
                Note della settimana:
                _________________________________________________
                _________________________________________________
                
                Celebrazione: _____________________________
                
                === DOMANDE POTENTI PER IL MANTENIMENTO ===
                
                🤔 RIFLESSIONE SETTIMANALE:
                • Che tipo di persona sto diventando con queste abitudini?
                • Come si sentono nel mio corpo le nuove routine?
                • Quali effetti positivi sto già notando?
                • Cosa posso modificare per rendere tutto più naturale?
                
                🤔 QUANDO È DIFFICILE:
                • Cosa farebbe la versione migliore di me stesso?
                • Come posso rendere questa abitudine più facile/divertente?
                • Chi può aiutarmi in questo momento?
                • Quale piccola azione posso fare proprio ora?
                
                === SCIENZA DELLE ABITUDINI: RICORDA ===
                
                📊 STATISTICHE MOTIVANTI:
                • Ci vogliono in media 66 giorni per automatizzare un'abitudine
                • 1% di miglioramento giornaliero = 37x meglio in un anno
                • Le abitudini sono responsabili del 40% delle nostre azioni quotidiane
                • Cambiare 1 abitudine chiave può trasformare tutto il resto
                
                🧠 NEUROPLASTICITÀ:
                Il tuo cervello si sta letteralmente ricablando per supportare questi nuovi comportamenti.
                Ogni ripetizione rafforza i circuiti neurali. Stai creando autostrade mentali
                che renderanno questi comportamenti sempre più automatici.
                
                === CONNESSIONE CON LE PROSSIME SETTIMANE ===
                
                La Settimana 6 si concentrerà su "Scoprire le Tue Potenzialità".
                Le abitudini che stai costruendo ora saranno la base per esprimere
                al massimo i tuoi talenti e capacità naturali.
                
                Ogni abitudine è un voto per il tipo di persona che vuoi diventare.
                
                === MESSAGGIO PERSONALE ===
                
                ${userProfile?.name || 'Amico/a'}, quello che hai costruito oggi non è solo un piano:
                è un sistema di trasformazione che può cambiare tutto.
                
                Le abitudini sono la compound interest della crescita personale.
                Piccole azioni quotidiane creano risultati straordinari nel tempo.
                
                Ricorda: non devi essere perfetto, devi essere consistente.
                Non devi cambiare tutto, devi cambiare la cosa giusta.
                
                Il potere è nelle tue mani. Ogni giorno, ogni scelta, ogni piccola azione
                ti avvicina alla persona che vuoi diventare.
                
                Il tuo architect delle abitudini,
                Andrea 🔄
                
                P.S. Il giorno migliore per iniziare è oggi. Il secondo giorno migliore è domani.
                Ma ricorda: l'abitudine più importante è quella di ricominciare quando sbagli.
            `;
            
            const blob = new Blob([systemContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Sistema_Trasformazione_Abitudini_Settimana_5_${userProfile?.name || 'Utente'}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage('📄 Sistema di trasformazione scaricato!', 'success');
        }

        function scheduleNextSession() {
            const nextWeekDate = new Date();
            nextWeekDate.setDate(nextWeekDate.getDate() + 7);
            
            const message = `📅 Settimana 6 "Scopri le Tue Potenzialità" disponibile il ${nextWeekDate.toLocaleDateString('it-IT')}!`;
            showMessage(message, 'info');
            
            localStorage.setItem('nextSessionReminder', nextWeekDate.toISOString());
        }

        function showMessage(message, type = 'info') {
            const colors = {
                success: '#16a34a',
                warning: '#f59e0b',
                info: '#3b82f6',
                error: '#ef4444'
            };
            
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: ${colors[type]}; color: white; padding: 1rem 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; max-width: 400px; animation: slideIn 0.3s ease-out;">
                    ${message}
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Handle Enter key in chat
        document.getElementById('chatInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            if (currentPhase !== 'completed') {
                autoSave();
            }
        });

        // Add slide-in animation style
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }
            
            .process-steps {
                grid-template-columns: 1fr;
            }
            
            .phase-indicator {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .phase-step {
                min-width: auto;
                width: 100%;
                justify-content: center;
            }
            
            .phase-arrow {
                transform: rotate(90deg);
            }
            
            .srg-model {
                grid-template-columns: 1fr;
            }
            
            .habit-input-group {
                grid-template-columns: 1fr;
            }
            
            .habits-grid {
                grid-template-columns: 1fr;
            }
            
            .habits-plan {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">🔄 Settimana 5 - Trasformazione Abitudini</div>
            <div class="session-info">
                <div class="timer-display">
                    ⏱️ <span id="sessionTimer">45:00</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="sessionProgress"></div>
                </div>
                <a href="module-hub.html" class="back-button">← Torna ai Moduli</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Phase Indicator -->
        <div class="phase-indicator">
            <div class="phase-step active" id="phaseStep1">
                <span>🔧</span>
                <span>Fase 1: Workshop Sistema Abitudini</span>
            </div>
            <div class="phase-arrow">→</div>
            <div class="phase-step inactive" id="phaseStep2">
                <span>🤖</span>
                <span>Fase 2: Coaching Trasformazione</span>
            </div>
        </div>

        <!-- Welcome Section -->
        <section class="welcome-section fade-in" id="welcomeSection">
            <h1 class="welcome-title">Benvenuto nella Settimana 5! 🚀</h1>
            <p class="welcome-subtitle">Trasformazione Abitudini - Il Sistema per il Cambiamento Duraturo</p>
            
            <div class="journey-recap">
                <h3 class="recap-title">🎯 Il Tuo Viaggio Fino a Qui</h3>
                <div id="journeySummary">
                    <p>Caricamento del tuo percorso personalizzato dalle settimane precedenti...</p>
                </div>
            </div>
            
            <div class="process-explanation">
                <h3 class="process-title">🔄 La Scienza della Trasformazione</h3>
                <div class="process-steps">
                    <div class="process-step">
                        <div class="step-number">1</div>
                        <div class="step-title">Workshop Sistema SRG</div>
                        <div class="step-description">
                            Teoria Segnale-Routine-Gratificazione + esercizi pratici per 
                            mappare e trasformare le tue abitudini attuali.
                        </div>
                        <div class="step-duration">⏱️ 15 minuti</div>
                    </div>
                    <div class="process-step">
                        <div class="step-number">2</div>
                        <div class="step-title">Coaching Trasformazione</div>
                        <div class="step-description">
                            Sistema personalizzato di abitudini sostenibili basato sui tuoi 
                            obiettivi e consapevolezza dalle settimane precedenti.
                        </div>
                        <div class="step-duration">⏱️ 25-30 minuti</div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="startPhase1()">
                🚀 Inizia la Trasformazione delle Tue Abitudini
            </button>
        </section>

        <!-- Phase 1: Habits Workshop -->
        <section class="phase1-section" id="phase1Section">
            <div class="phase-header">
                <div class="phase-icon">🔧</div>
                <div>
                    <h2 class="phase-title">Fase 1: Workshop Sistema Abitudini</h2>
                    <p class="phase-subtitle">Comprendi e trasforma il tuo sistema automatico di comportamenti</p>
                </div>
            </div>
            
            <div class="workshop-progress">
                <div class="workshop-progress-text">Progresso workshop: <span id="workshopProgress">0%</span></div>
                <div class="workshop-progress-bar">
                    <div class="workshop-progress-fill" id="workshopProgressFill" style="width: 0%"></div>
                </div>
            </div>
            
            <form id="habitsForm">
                <!-- Teoria SRG -->
                <div class="workshop-section" id="theorySection">
                    <h3>🧠 La Scienza delle Abitudini: Modello SRG</h3>
                    
                    <div class="theory-box">
                        <div class="theory-title">Il Meccanismo Neurologico delle Abitudini</div>
                        <p>
                            Gli scienziati del MIT hanno scoperto che ogni abitudine funziona secondo un 
                            semplice ciclo neurologico di 3 elementi. Comprenderlo ti permetterà di 
                            modificare qualsiasi comportamento automatico.
                        </p>
                    </div>
                    
                    <div class="srg-model">
                        <div class="srg-card signal">
                            <div class="srg-icon">⚡</div>
                            <div class="srg-title">SEGNALE</div>
                            <div class="srg-description">
                                Trigger che attiva il "pilota automatico" del cervello. 
                                Può essere un luogo, orario, emozione, persona o azione.
                            </div>
                        </div>
                        <div class="srg-card routine">
                            <div class="srg-icon">🔄</div>
                            <div class="srg-title">ROUTINE</div>
                            <div class="srg-description">
                                Il comportamento automatico che segue il segnale. 
                                Può essere fisico, mentale o emotivo.
                            </div>
                        </div>
                        <div class="srg-card reward">
                            <div class="srg-icon">🎁</div>
                            <div class="srg-title">GRATIFICAZIONE</div>
                            <div class="srg-description">
                                Beneficio che il cervello registra e che rinforza 
                                il ciclo per il futuro.
                            </div>
                        </div>
                    </div>

                    <div class="habit-examples">
                        <div class="examples-title">💡 Esempio Pratico</div>
                        <div class="examples-list">
                            <strong>Segnale:</strong> Svegliarsi al mattino → 
                            <strong>Routine:</strong> Controllare il telefono → 
                            <strong>Gratificazione:</strong> Sentirsi connessi/informati
                        </div>
                    </div>
                </div>

                <!-- Mappatura Abitudini Attuali -->
                <div class="workshop-section" id="mappingSection">
                    <h3>🗺️ Mappatura delle Tue Abitudini Attuali</h3>
                    
                    <div class="exercise-group">
                        <div class="exercise-title">Identifica una cattiva abitudine che vuoi eliminare:</div>
                        <div class="habit-input-group">
                            <input type="text" class="habit-input signal" id="badHabitSignal" 
                                   placeholder="Segnale (quando accade?)" 
                                   onchange="updateWorkshopProgress(); autoSave()">
                            <input type="text" class="habit-input routine" id="badHabitRoutine" 
                                   placeholder="Routine (cosa fai?)" 
                                   onchange="updateWorkshopProgress(); autoSave()">
                            <input type="text" class="habit-input reward" id="badHabitReward" 
                                   placeholder="Gratificazione (cosa ottieni?)" 
                                   onchange="updateWorkshopProgress(); autoSave()">
                        </div>
                        
                        <div class="habit-examples">
                            <div class="examples-title">💡 Esempi di cattive abitudini</div>
                            <div class="examples-list">
                                Procrastinare • Controllare ossessivamente il telefono • Mangiare snack per noia • 
                                Rimanere alzato troppo tardi • Criticarsi continuamente • Rimandare l'esercizio fisico
                            </div>
                        </div>
                    </div>

                    <div class="exercise-group">
                        <div class="exercise-title">Identifica una buona abitudine che vuoi creare:</div>
                        <div class="habit-input-group">
                            <input type="text" class="habit-input signal" id="goodHabitSignal" 
                                   placeholder="Segnale (quando la farai?)" 
                                   onchange="updateWorkshopProgress(); autoSave()">
                            <input type="text" class="habit-input routine" id="goodHabitRoutine" 
                                   placeholder="Routine (cosa farai esattamente?)" 
                                   onchange="updateWorkshopProgress(); autoSave()">
                            <input type="text" class="habit-input reward" id="goodHabitReward" 
                                   placeholder="Gratificazione (come ti sentirai?)" 
                                   onchange="updateWorkshopProgress(); autoSave()">
                        </div>
                        
                        <div class="habit-examples">
                            <div class="examples-title">💡 Esempi di buone abitudini</div>
                            <div class="examples-list">
                                Meditazione mattutina • Lettura giornaliera • Esercizio fisico • Gratitudine • 
                                Pianificazione della giornata • Chiamare persone care • Bere più acqua
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analisi Approfondita -->
                <div class="workshop-section" id="analysisSection">
                    <h3>🔍 Analisi Approfondita delle Abitudini</h3>
                    
                    <div class="form-group">
                        <label for="habitTriggers">In quali situazioni è più difficile resistere alle cattive abitudini?</label>
                        <textarea id="habitTriggers" 
                                  placeholder="Es: Quando sono stanco, stressato, annoiato, solo, in certi luoghi..." 
                                  onchange="updateWorkshopProgress(); autoSave()"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="habitBarriers">Cosa ti impedisce di mantenere le buone abitudini?</label>
                        <textarea id="habitBarriers" 
                                  placeholder="Es: Mancanza di tempo, energia, motivazione, supporto sociale..." 
                                  onchange="updateWorkshopProgress(); autoSave()"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="habitConnection">Come si collegano le tue abitudini ai tuoi obiettivi delle settimane precedenti?</label>
                        <textarea id="habitConnection" 
                                  placeholder="Rifletti su come le abitudini possono supportare i tuoi obiettivi autentici..." 
                                  onchange="updateWorkshopProgress(); autoSave()"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="habitIdentity">Che tipo di persona diventeresti se queste abitudini fossero completamente integrate?</label>
                        <textarea id="habitIdentity" 
                                  placeholder="Visualizza la versione migliore di te stesso con queste nuove abitudini..." 
                                  onchange="updateWorkshopProgress(); autoSave()"></textarea>
                    </div>
                </div>

                <div class="form-navigation">
                    <button type="button" class="btn btn-success" id="completeWorkshopBtn" onclick="completePhase1()" disabled>
                        ✅ Completa Workshop e Inizia Coaching
                    </button>
                </div>
            </form>
        </section>

        <!-- Phase 2: Transformation Coaching -->
        <section class="phase2-section" id="phase2Section">
            <div class="phase-header">
                <div class="phase-icon">🤖</div>
                <div>
                    <h2 class="phase-title">Fase 2: Coaching per la Trasformazione</h2>
                    <p class="phase-subtitle">Sistema personalizzato per abitudini sostenibili e durature</p>
                </div>
            </div>
            
            <div class="coaching-context">
                <h3>🎯 Il Tuo Sistema di Trasformazione</h3>
                <p>
                    Ho analizzato le abitudini che hai mappato insieme ai tuoi obiettivi e consapevolezza 
                    delle settimane precedenti. Ora creeremo insieme un sistema sostenibile per 
                    trasformare i tuoi comportamenti automatici in modo autentico e duraturo.
                </p>
                
                <div class="habits-summary">
                    <div class="habits-title">🔄 Le Tue Abitudini in Sintesi:</div>
                    <div class="habits-grid" id="habitsGrid">
                        <div class="habit-card">
                            <div class="habit-label">Da Eliminare</div>
                            <div class="habit-value" id="badHabitSummary">Caricamento...</div>
                        </div>
                        <div class="habit-card">
                            <div class="habit-label">Da Creare</div>
                            <div class="habit-value" id="goodHabitSummary">Caricamento...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="time-warning" id="timeWarning">
                <strong>⏰ Abbiamo raggiunto i 30 minuti!</strong> Vuoi continuare per altri 15 minuti o preferisci terminare ora?
                <div style="margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="continueSession()">Continua</button>
                    <button class="btn btn-primary" onclick="endSession()">Termina Ora</button>
                </div>
            </div>
            
            <div class="chat-status">
                <div class="status-dot"></div>
                <span>Andrea è pronto per creare il tuo sistema di trasformazione</span>
            </div>
            
            <div class="chat-container" id="chatContainer">
                <!-- Messages will be added here -->
            </div>
            
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="Condividi i tuoi pensieri con Andrea...">
                <button class="btn btn-primary" onclick="sendChatMessage()">Invia</button>
            </div>
        </section>

        <!-- Completion Section -->
        <section class="completion-section" id="completionSection">
            <h2 class="completion-title">🎉 Sistema di Trasformazione Completato!</h2>
            <p class="completion-message">
                Incredibile! Abbiamo creato insieme un sistema scientifico e personalizzato per trasformare 
                le tue abitudini. Ora hai tutti gli strumenti per creare cambiamenti duraturi e autentici.
            </p>
            
            <div class="habits-results">
                <h3 class="results-title">🔄 Il Tuo Piano di Trasformazione</h3>
                <div class="habits-plan" id="habitsResultsPlan">
                    <!-- Will be populated with transformation plan -->
                </div>
            </div>
            
            <div class="homework-section">
                <h3 class="homework-title">⚡ I Tuoi Compiti di Trasformazione</h3>
                <ul class="homework-list" id="personalizedHomework">
                    <!-- Will be generated based on habits session -->
                </ul>
            </div>
            
            <div class="completion-actions">
                <button class="btn btn-success" onclick="downloadHabitsSystem()">📄 Scarica Sistema Completo</button>
                <a href="module-hub.html" class="btn btn-secondary">← Torna ai Moduli</a>
                <button class="btn btn-primary" onclick="scheduleNextSession()">📅 Programma Settimana 6</button>
            </div>
        </section>
    </main>

    <!-- Load Andrea AI Coach System -->
    <script src="../andrea-ai-coach.js"></script>
    
    <script>
        // Session variables
        let sessionStartTime = Date.now();
        let sessionDuration = 45 * 60 * 1000; // 45 minutes
        let timerInterval;
        let currentPhase = 'welcome';
        let habitsData = {};
        let chatHistory = [];
        let andreaAICoach = null;
        let userProfile = null;
        let previousWeeksData = {};
        let sessionExtended = false;
        let autoSaveInterval;
        let habitsInsights = [];
        let transformationPlan = {};

        // Initialize session
        document.addEventListener('DOMContentLoaded', function() {
            startSessionTimer();
            loadUserProfile();
            loadPreviousWeeksData();
            loadSavedSession();
            initializeAndreaAI();
            startAutoSave();
        });

        function startSessionTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - sessionStartTime;
                const remaining = Math.max(0, sessionDuration - elapsed);
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                
                document.getElementById('sessionTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const progress = (elapsed / sessionDuration) * 100;
                document.getElementById('sessionProgress').style.width = `${Math.min(progress, 100)}%`;
                
                // Check for 30 minute warning
                if (elapsed >= 30 * 60 * 1000 && !sessionExtended && currentPhase === 'phase2') {
                    show30MinuteWarning();
                }
                
                // Auto-end at 45 minutes
                if (remaining === 0) {
                    clearInterval(timerInterval);
                    endSession();
                }
            }, 1000);
        }

        function loadUserProfile() {
            try {
                const savedData = localStorage.getItem('lifestyleQuizResults');
                if (savedData) {
                    userProfile = JSON.parse(savedData);
                    console.log('✅ User profile loaded:', userProfile);
                }
            } catch (error) {
                console.error('❌ Error loading user profile:', error);
            }
        }

        function loadPreviousWeeksData() {
            try {
                // Load data from previous weeks
                const week1Data = localStorage.getItem('week1SessionCompleted');
                const week2Data = localStorage.getItem('week2SessionCompleted');
                const week3Data = localStorage.getItem('week3SessionCompleted');
                const week4Data = localStorage.getItem('week4SessionCompleted');
                
                previousWeeksData = {
                    week1: week1Data ? JSON.parse(week1Data) : null,
                    week2: week2Data ? JSON.parse(week2Data) : null,
                    week3: week3Data ? JSON.parse(week3Data) : null,
                    week4: week4Data ? JSON.parse(week4Data) : null
                };
                
                console.log('✅ Previous weeks data loaded:', previousWeeksData);
                displayJourneySummary();
            } catch (error) {
                console.error('❌ Error loading previous weeks data:', error);
                displayDefaultSummary();
            }
        }

        function displayJourneySummary() {
            const summaryEl = document.getElementById('journeySummary');
            let summary = `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">`;
            
            // Week 1 summary
            if (previousWeeksData.week1 && previousWeeksData.week1.phase1Data) {
                const data = previousWeeksData.week1.phase1Data;
                summary += `
                    <div style="padding: 1rem; background: white; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <strong>Settimana 1:</strong><br>
                        Obiettivo: "${data.dreamGoal || 'In definizione'}"
                    </div>
                `;
            }
            
            // Week 2 summary
            if (previousWeeksData.week2 && previousWeeksData.week2.testResults) {
                const results = previousWeeksData.week2.testResults;
                summary += `
                    <div style="padding: 1rem; background: white; border-radius: 8px; border-left: 4px solid #16a34a;">
                        <strong>Settimana 2:</strong><br>
                        Autostima: ${results.selfEsteem}/5<br>
                        Valore principale identificato
                    </div>
                `;
            }
            
            // Week 3 summary (if exists)
            if (previousWeeksData.week3) {
                summary += `
                    <div style="padding: 1rem; background: white; border-radius: 8px; border-left: 4px solid #ea580c;">
                        <strong>Settimana 3:</strong><br>
                        Obiettivi SMART definiti
                    </div>
                `;
            }
            
            // Week 4 summary (if exists)
            if (previousWeeksData.week4) {
                summary += `
                    <div style="padding: 1rem; background: white; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                        <strong>Settimana 4:</strong><br>
                        Piano di azione creato
                    </div>
                `;
            }
            
            summary += `</div>`;
            summary += `<p style="margin-top: 1rem; font-style: italic; color: #ea580c;">
                Ora è il momento di trasformare tutta questa consapevolezza in abitudini concrete e sostenibili!
            </p>`;
            
            summaryEl.innerHTML = summary;
        }

        function displayDefaultSummary() {
            const summaryEl = document.getElementById('journeySummary');
            summaryEl.innerHTML = `
                <p>Hai iniziato un percorso straordinario di trasformazione personale.</p>
                <p style="margin-top: 1rem; font-style: italic; color: #ea580c;">
                    Oggi creeremo un sistema di abitudini che ti permetterà di vivere coerentemente con i tuoi valori e obiettivi.
                </p>
            `;
        }

        function loadSavedSession() {
            try {
                const savedSession = localStorage.getItem('week5SessionInProgress');
                if (savedSession) {
                    const sessionData = JSON.parse(savedSession);
                    
                    // Restore habits data
                    if (sessionData.habitsData) {
                        habitsData = sessionData.habitsData;
                        restoreHabitsAnswers();
                    }
                    
                    // Restore chat history
                    if (sessionData.chatHistory) {
                        chatHistory = sessionData.chatHistory;
                    }
                    
                    // Restore current phase
                    if (sessionData.currentPhase) {
                        currentPhase = sessionData.currentPhase;
                        
                        if (currentPhase === 'phase1') {
                            startPhase1();
                        } else if (currentPhase === 'phase2') {
                            startPhase2();
                            restoreChatHistory();
                        }
                    }
                    
                    console.log('✅ Session restored from:', sessionData);
                }
            } catch (error) {
                console.error('❌ Error loading saved session:', error);
            }
        }

        function restoreHabitsAnswers() {
            Object.entries(habitsData).forEach(([key, value]) => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = value;
                }
            });
            updateWorkshopProgress();
        }

        async function initializeAndreaAI() {
            try {
                if (window.AndreaAICoach) {
                    andreaAICoach = new window.AndreaAICoach();
                    
                    const userId = localStorage.getItem('lifestyleUserId') || 'user_' + Date.now();
                    localStorage.setItem('lifestyleUserId', userId);
                    
                    await andreaAICoach.initialize(userId, userProfile || {});
                    
                    console.log('🤖 Andrea AI Coach initialized successfully');
                } else {
                    console.error('❌ Andrea AI Coach not available');
                }
            } catch (error) {
                console.error('❌ Error initializing Andrea AI:', error);
            }
        }

        function startAutoSave() {
            autoSaveInterval = setInterval(() => {
                autoSave();
            }, 5000);
        }

        function autoSave() {
            try {
                const sessionData = {
                    currentPhase: currentPhase,
                    habitsData: habitsData,
                    chatHistory: chatHistory,
                    habitsInsights: habitsInsights,
                    transformationPlan: transformationPlan,
                    sessionStartTime: sessionStartTime,
                    lastSaved: new Date().toISOString()
                };
                
                localStorage.setItem('week5SessionInProgress', JSON.stringify(sessionData));
            } catch (error) {
                console.error('❌ Error auto-saving:', error);
            }
        }

        function startPhase1() {
            currentPhase = 'phase1';
            
            // Hide welcome, show phase 1
            document.getElementById('welcomeSection').style.display = 'none';
            document.getElementById('phase1Section').classList.add('active');
            
            // Update phase indicator
            document.getElementById('phaseStep1').className = 'phase-step active';
            document.getElementById('phaseStep2').className = 'phase-step inactive';
            
            updateWorkshopProgress();
            autoSave();
        }

        function updateWorkshopProgress() {
            const form = document.getElementById('habitsForm');
            const inputs = form.querySelectorAll('input, textarea');
            
            let filled = 0;
            inputs.forEach(input => {
                if (input.value.trim()) {
                    filled++;
                    habitsData[input.id] = input.value.trim();
                }
            });
            
            const progress = (filled / inputs.length) * 100;
            document.getElementById('workshopProgress').textContent = `${Math.round(progress)}%`;
            document.getElementById('workshopProgressFill').style.width = `${progress}%`;
            
            // Enable/disable complete button
            const completeBtn = document.getElementById('completeWorkshopBtn');
            const requiredFields = ['badHabitSignal', 'badHabitRoutine', 'badHabitReward', 
                                  'goodHabitSignal', 'goodHabitRoutine', 'goodHabitReward'];
            const requiredFilled = requiredFields.filter(id => document.getElementById(id).value.trim()).length;
            
            if (requiredFilled === requiredFields.length) {
                completeBtn.disabled = false;
                completeBtn.className = 'btn btn-success';
            } else {
                completeBtn.disabled = true;
                completeBtn.className = 'btn btn-disabled';
            }
        }

        function completePhase1() {
            // Generate habits insights
            generateHabitsInsights();
            
            // Mark phase 1 as completed
            document.getElementById('phaseStep1').className = 'phase-step completed';
            
            // Start phase 2
            startPhase2();
        }

        function generateHabitsInsights() {
            habitsInsights = [];
            
            // Analyze bad habit pattern
            if (habitsData.badHabitSignal) {
                habitsInsights.push(`Trigger identificato: ${habitsData.badHabitSignal}`);
            }
            
            // Analyze good habit feasibility
            if (habitsData.goodHabitSignal && habitsData.goodHabitRoutine) {
                habitsInsights.push(`Nuova abitudine progettata: ${habitsData.goodHabitRoutine}`);
            }
            
            // Connection to previous weeks
            if (previousWeeksData.week1 && previousWeeksData.week1.phase1Data) {
                habitsInsights.push('Collegamento con obiettivi Settimana 1 identificato');
            }
            
            if (previousWeeksData.week2 && previousWeeksData.week2.testResults) {
                habitsInsights.push('Allineamento con valori Settimana 2 considerato');
            }
            
            // Barriers analysis
            if (habitsData.habitBarriers) {
                habitsInsights.push('Ostacoli principali mappati per strategia personalizzata');
            }
            
            // Identity connection
            if (habitsData.habitIdentity) {
                habitsInsights.push('Connessione identità-abitudini sviluppata');
            }
        }

        function startPhase2() {
            currentPhase = 'phase2';
            
            // Hide phase 1, show phase 2
            document.getElementById('phase1Section').classList.remove('active');
            document.getElementById('phase2Section').classList.add('active');
            
            // Update phase indicator
            document.getElementById('phaseStep2').className = 'phase-step active';
            
            // Display habits summary
            displayHabitsSummary();
            
            // Generate first coaching question
            generateFirstCoachingQuestion();
            
            autoSave();
        }

        function displayHabitsSummary() {
            const badSummary = document.getElementById('badHabitSummary');
            const goodSummary = document.getElementById('goodHabitSummary');
            
            badSummary.textContent = habitsData.badHabitRoutine || 'Da definire';
            goodSummary.textContent = habitsData.goodHabitRoutine || 'Da definire';
        }

        function generateFirstCoachingQuestion() {
            if (chatHistory.length === 0) {
                const firstQuestion = generatePowerfulHabitsQuestion();
                addChatMessage(firstQuestion, 'coach');
            } else {
                restoreChatHistory();
            }
        }

        function generatePowerfulHabitsQuestion() {
            let question = `Fantastico lavoro nel workshop! Ho analizzato il sistema delle tue abitudini e vedo un quadro molto interessante. `;
            
            // Reference mapped habits
            if (habitsData.badHabitRoutine && habitsData.goodHabitRoutine) {
                question += `Vuoi eliminare "${habitsData.badHabitRoutine}" e creare "${habitsData.goodHabitRoutine}". `;
            }
            
            // Connect to previous weeks
            if (previousWeeksData.week1 && previousWeeksData.week1.phase1Data && previousWeeksData.week1.phase1Data.dreamGoal) {
                question += `Ricordo che nella Settimana 1 il tuo obiettivo da sogno era "${previousWeeksData.week1.phase1Data.dreamGoal}". `;
            }
            
            if (previousWeeksData.week2 && previousWeeksData.week2.testResults && previousWeeksData.week2.testResults.topValues) {
                const valueLabels = {
                    family: 'famiglia e relazioni',
                    career: 'successo professionale',
                    health: 'salute e benessere',
                    growth: 'crescita personale',
                    freedom: 'libertà e indipendenza'
                };
                const topValue = valueLabels[previousWeeksData.week2.testResults.topValues[0][0]];
                question += `E dalla Settimana 2 so che il tuo valore principale è ${topValue}. `;
            }
            
            // Reference identity connection
            if (habitsData.habitIdentity) {
                question += `Mi ha colpito quando hai scritto che diventeresti: "${habitsData.habitIdentity}". `;
            }
            
            // Powerful coaching question
            question += `\n\nOra voglio farti una domanda che va al cuore della trasformazione:
            
**Se dovessi scegliere UNA SOLA abitudine da cambiare che avrebbe l'impatto più profondo sulla tua vita e ti avvicinerebbe di più alla persona che vuoi diventare, quale sarebbe e perché?** 🤔
            
Non pensare a quella più facile o più difficile, ma a quella che cambierebbe tutto il resto.`;
            
            return question;
        }

        function restoreChatHistory() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '';
            
            chatHistory.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.sender}`;
                messageDiv.innerHTML = `
                    <div class="message-content">${message.content}</div>
                    <div class="message-time">${message.time}</div>
                `;
                chatContainer.appendChild(messageDiv);
            });
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addChatMessage(message, 'user');
            input.value = '';
            
            // Get AI coaching response
            try {
                const coachingResponse = await getHabitsCoachingResponse(message);
                setTimeout(() => {
                    addChatMessage(coachingResponse, 'coach');
                }, 1500);
            } catch (error) {
                console.error('❌ Error getting coaching response:', error);
                setTimeout(() => {
                    addChatMessage("Sto riflettendo sul sistema di abitudini che mi hai descritto... Puoi ripetere?", 'coach');
                }, 1000);
            }
        }

        function addChatMessage(content, sender) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const now = new Date();
            const time = now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-content">${content}</div>
                <div class="message-time">${time}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Store in history
            chatHistory.push({ sender, content, time });
            
            // Extract insights if it's a user message
            if (sender === 'user') {
                extractHabitsInsights(content);
            }
            
            autoSave();
        }

        async function getHabitsCoachingResponse(userMessage) {
            // Build comprehensive context for habits coaching
            const coachingContext = {
                habitsData: habitsData,
                habitsInsights: habitsInsights,
                chatHistory: chatHistory,
                previousWeeksData: previousWeeksData,
                userProfile: userProfile,
                transformationPlan: transformationPlan
            };
            
            // Try Andrea AI with habits context
            if (andreaAICoach) {
                try {
                    const response = await andreaAICoach.sendMessage(userMessage, 5);
                    if (response.success) {
                        return response.response;
                    }
                } catch (error) {
                    console.error('❌ Andrea AI habits coaching error:', error);
                }
            }
            
            // Fallback to sophisticated habits coaching response
            return generateHabitsCoachingResponse(userMessage, coachingContext);
        }

        function generateHabitsCoachingResponse(userMessage, context) {
            const messageCount = context.chatHistory.filter(m => m.sender === 'user').length;
            
            // Different habits coaching approaches based on conversation depth
            if (messageCount <= 2) {
                return generateHabitsExplorationResponse(userMessage, context);
            } else if (messageCount <= 4) {
                return generateHabitsDesignResponse(userMessage, context);
            } else {
                return generateHabitsImplementationResponse(userMessage, context);
            }
        }

        function generateHabitsExplorationResponse(userMessage, context) {
            const responses = [
                `Questa scelta rivela qualcosa di molto profondo su di te. Sento che hai colto l'essenza della trasformazione: non si tratta di cambiare mille cose, ma di trovare quella leva che muove tutto il resto. Dimmi, quando immagini di aver integrato completamente questa abitudine, come cambia la tua giornata tipo?`,
                
                `Wow, quello che condividi mi fa capire che hai una comprensione matura di come funziona il cambiamento. Questa abitudine che hai scelto ha un potere trasformativo enorme. Mi chiedo: qual è il momento più critico della giornata dove questa abitudine potrebbe fare la differenza?`,
                
                `La tua risposta mostra una consapevolezza profonda. Quello che mi colpisce è che stai pensando sistemicamente, non solo alle singole azioni. Quando pensi agli ostacoli che potrebbero sabotare questa abitudine, qual è il primo che ti viene in mente?`,
                
                `Perfetto! Vedo che stai connettendo questa abitudine con la tua identità più profonda. Questo è il segreto delle trasformazioni durature. Ora, se dovessi identificare il "segnale" perfetto per innescare questa abitudine, cosa sceglieresti?`
            ];
            
            // Personalize based on specific habits data
            if (context.habitsData.habitIdentity) {
                return `La tua risposta risuona perfettamente con quello che hai scritto su chi vuoi diventare: "${context.habitsData.habitIdentity}". Vedo una coerenza bellissima tra questa abitudine e la tua visione di te stesso. Mi chiedo: se questa versione migliore di te fosse già qui, qual è la prima cosa che farebbe diversamente domani mattina?`;
            }
            
            if (context.previousWeeksData.week1 && context.previousWeeksData.week1.phase1Data && context.previousWeeksData.week1.phase1Data.dreamGoal) {
                return `Quello che mi dici si collega perfettamente con il tuo obiettivo da sogno della Settimana 1: "${context.previousWeeksData.week1.phase1Data.dreamGoal}". Questa abitudine è come un ponte verso quel sogno. Se dovessi immaginare questo ponte, qual è il primo "gradino" che potresti costruire questa settimana?`;
            }
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function generateHabitsDesignResponse(userMessage, context) {
            const responses = [
                `Stiamo entrando nel cuore del design della tua trasformazione. Quello che mi descrivi ha tutti gli ingredienti per il successo. Ora, per rendere questa abitudine "a prova di fallimento", quale gratificazione immediata potresti darti ogni volta che la completi?`,
                
                `Eccellente! Sento che stai costruendo qualcosa di solido. La scienza delle abitudini ci dice che il 21% del successo dipende dalla chiarezza del segnale. Se dovessi rendere impossibile "dimenticare" di fare questa abitudine, come organizzeresti il tuo ambiente?`,
                
                `La tua strategia sta prendendo forma in modo bellissimo. Ora voglio che pensiamo al "sistema di backup": quando la motivazione sarà bassa (e succederà), quale versione "minima" di questa abitudine potresti sempre fare?`,
                
                `Perfetto! Quello che stai creando è un sistema, non solo un'abitudine. Mi chiedo: come potresti "stackare" questa abitudine con qualcosa che già fai automaticamente ogni giorno?`
            ];
            
            // Design based on specific mapped habits
            if (context.habitsData.badHabitSignal && context.habitsData.goodHabitSignal) {
                return `Sto vedendo una strategia brillante. Hai identificato che il tuo trigger problematico è "${context.habitsData.badHabitSignal}" e vuoi sostituirlo con "${context.habitsData.goodHabitSignal}". Ora, il trucco è usare lo stesso segnale ma cambiare la routine. Come potresti "dirottare" quel trigger verso la nuova abitudine?`;
            }
            
            if (context.habitsData.habitBarriers) {
                return `Ripenso a quello che hai scritto sugli ostacoli: "${context.habitsData.habitBarriers}". La tua strategia deve essere più forte di questi ostacoli. Se dovessi progettare questa abitudine per essere "resistente" a queste sfide, quali accorgimenti useresti?`;
            }
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function generateHabitsImplementationResponse(userMessage, context) {
            const responses = [
                `Quello che abbiamo costruito insieme è un sistema potente e personalizzato. Ora è il momento dell'implementazione strategica. Se dovessi scommettere sul successo di questa trasformazione, quale sarebbe la tua "regola d'oro" per i primi 30 giorni?`,
                
                `Sento che sei pronto per il lancio! Il sistema che abbiamo progettato ha tutte le caratteristiche delle trasformazioni che durano nel tempo. Ora, per il monitoraggio: come vuoi tenere traccia dei tuoi progressi senza diventare ossessivo?`,
                
                `Incredibile! Abbiamo creato qualcosa di veramente personalizzato e sostenibile. L'ultimo elemento è la resilienza: quando sbaglierai (ed è normale), quale sarà il tuo protocollo di "reset" per riprendere subito?`,
                
                `Il tuo sistema di trasformazione è pronto! Ora voglio che pensiamo al "moltiplicatore": una volta che questa abitudine sarà automatica, quale sarà la prossima che aggiungerai per creare un effetto domino positivo?`
            ];
            
            // Implementation based on complete context
            if (context.previousWeeksData.week2 && context.previousWeeksData.week2.testResults && context.previousWeeksData.week2.testResults.topValues) {
                const valueLabels = {
                    family: 'famiglia e relazioni',
                    career: 'successo professionale',
                    health: 'salute e benessere',
                    growth: 'crescita personale',
                    freedom: 'libertà e indipendenza'
                };
                const topValue = valueLabels[context.previousWeeksData.week2.testResults.topValues[0][0]];
                return `Tutto quello che abbiamo costruito si allinea perfettamente con il tuo valore principale: ${topValue}. Questo non è solo un cambiamento di comportamento, è un atto di coerenza con chi sei veramente. Quale sarà il tuo "mantra" personale per ricordarti perché questa abitudine è importante per te?`;
            }
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function extractHabitsInsights(userMessage) {
            // Extract key insights for transformation plan
            const insights = [];
            
            if (userMessage.toLowerCase().includes('mattina') || userMessage.toLowerCase().includes('mattino')) {
                insights.push('Preferenza per routine mattutine');
            }
            
            if (userMessage.toLowerCase().includes('sera') || userMessage.toLowerCase().includes('notte')) {
                insights.push('Attivazione serale identificata');
            }
            
            if (userMessage.toLowerCase().includes('stress') || userMessage.toLowerCase().includes('pressione')) {
                insights.push('Gestione stress come priorità');
            }
            
            if (userMessage.toLowerCase().includes('energia') || userMessage.toLowerCase().includes('motivazione')) {
                insights.push('Focus su energia e motivazione');
            }
            
            if (userMessage.toLowerCase().includes('famiglia') || userMessage.toLowerCase().includes('relazioni')) {
                insights.push('Componente sociale importante');
            }
            
            if (userMessage.toLowerCase().includes('lavoro') || userMessage.toLowerCase().includes('carriera')) {
                insights.push('Integrazione professionale considerata');
            }
            
            habitsInsights.push(...insights);
        }

        function show30MinuteWarning() {
            document.getElementById('timeWarning').classList.add('active');
        }

        function continueSession() {
            sessionExtended = true;
            document.getElementById('timeWarning').classList.remove('active');
            showMessage('✅ Sessione estesa di 15 minuti. Completiamo la trasformazione!', 'success');
        }

        function endSession() {
            clearInterval(timerInterval);
            clearInterval(autoSaveInterval);
            completeSession();
        }

        function completeSession() {
            // Save final session data
            const finalSessionData = {
                habitsData: habitsData,
                chatHistory: chatHistory,
                habitsInsights: habitsInsights,
                transformationPlan: transformationPlan,
                completedAt: new Date().toISOString(),
                sessionDuration: Date.now() - sessionStartTime,
                userProfile: userProfile,
                previousWeeksData: previousWeeksData
            };
            
            localStorage.setItem('week5SessionCompleted', JSON.stringify(finalSessionData));
            localStorage.removeItem('week5SessionInProgress');
            
            // Update progress
            updateUserProgress();
            
            // Show completion
            document.getElementById('phase2Section').classList.remove('active');
            document.getElementById('completionSection').classList.add('active');
            
            // Generate transformation plan and homework
            generateTransformationPlan();
            generateHabitsHomework();
            
            document.getElementById('completionSection').scrollIntoView({ behavior: 'smooth' });
        }

        function generateTransformationPlan() {
            const planContainer = document.getElementById('habitsResultsPlan');
            
            // Bad habit elimination plan
            let badHabitPlan = '';
            if (habitsData.badHabitSignal && habitsData.badHabitRoutine && habitsData.badHabitReward) {
                badHabitPlan = `
                    <div class="plan-item">
                        <div class="plan-type">Eliminare</div>
                        <div class="plan-habit">${habitsData.badHabitRoutine}</div>
                        <div class="plan-details">
                            <strong>Segnale:</strong> ${habitsData.badHabitSignal}<br>
                            <strong>Strategia:</strong> Sostituire con routine positiva<br>
                            <strong>Gratificazione alternativa:</strong> Trovare sostituto sano
                        </div>
                    </div>
                `;
            }
            
            // Good habit creation plan
            let goodHabitPlan = '';
            if (habitsData.goodHabitSignal && habitsData.goodHabitRoutine && habitsData.goodHabitReward) {
                goodHabitPlan = `
                    <div class="plan-item">
                        <div class="plan-type">Creare</div>
                        <div class="plan-habit">${habitsData.goodHabitRoutine}</div>
                        <div class="plan-details">
                            <strong>Segnale:</strong> ${habitsData.goodHabitSignal}<br>
                            <strong>Routine:</strong> Inizia con versione minima<br>
                            <strong>Gratificazione:</strong> ${habitsData.goodHabitReward}
                        </div>
                    </div>
                `;
            }
            
            // Keystone habit identification
            let keystoneHabit = '';
            if (habitsInsights.length > 0) {
                keystoneHabit = `
                    <div class="plan-item">
                        <div class="plan-type">Abitudine Chiave</div>
                        <div class="plan-habit">Sistema di Trasformazione</div>
                        <div class="plan-details">
                            <strong>Focus:</strong> Una abitudine che cambia tutto<br>
                            <strong>Impatto:</strong> Effetto domino su altre aree<br>
                            <strong>Monitoraggio:</strong> Tracciamento semplice e costante
                        </div>
                    </div>
                `;
            }
            
            // Implementation strategy
            const implementationStrategy = `
                <div class="plan-item">
                    <div class="plan-type">Strategia</div>
                    <div class="plan-habit">Piano di Implementazione</div>
                    <div class="plan-details">
                        <strong>Settimana 1-2:</strong> Stabilire il segnale<br>
                        <strong>Settimana 3-4:</strong> Consolidare la routine<br>
                        <strong>Settimana 5+:</strong> Automatizzazione completa
                    </div>
                </div>
            `;
            
            planContainer.innerHTML = badHabitPlan + goodHabitPlan + keystoneHabit + implementationStrategy;
            
            // Store transformation plan
            transformationPlan = {
                badHabit: habitsData.badHabitRoutine,
                goodHabit: habitsData.goodHabitRoutine,
                keyInsights: habitsInsights,
                implementationPhases: ['Stabilire segnale', 'Consolidare routine', 'Automatizzazione']
            };
        }

        function generateHabitsHomework() {
            const homeworkList = document.getElementById('personalizedHomework');
            let homework = [];
            
            // Base habits homework
            homework.push("✅ Traccia per 7 giorni i tuoi segnali automatici (quando scattano le abitudini)");
            homework.push("✅ Implementa la regola dei 2 minuti: versione mini della nuova abitudine");
            
            // Personalized based on mapped habits
            if (habitsData.badHabitSignal && habitsData.badHabitRoutine) {
                homework.push(`✅ Quando senti "${habitsData.badHabitSignal}", fermati 10 secondi e scegli consapevolmente`);
            }
            
            if (habitsData.goodHabitSignal && habitsData.goodHabitRoutine) {
                homework.push(`✅ Ogni volta che si verifica "${habitsData.goodHabitSignal}", pratica "${habitsData.goodHabitRoutine}"`);
            }
            
            // Based on barriers identified
            if (habitsData.habitBarriers) {
                homework.push(`✅ Prepara strategia per ostacoli: "${habitsData.habitBarriers}"`);
            }
            
            // Based on identity connection
            if (habitsData.habitIdentity) {
                homework.push(`✅ Ogni sera chiedi: "Oggi ho agito come: ${habitsData.habitIdentity}?"`);