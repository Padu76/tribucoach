<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hub Coaching AI v2.0 - 7 Settimane LifestyleFitnessCoach</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner-big {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(234, 88, 12, 0.3);
            border-top: 4px solid #ea580c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            color: #cbd5e1;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .loading-subtext {
            color: #94a3b8;
            font-size: 0.9rem;
            text-align: center;
            max-width: 400px;
        }

        /* AI Badge */
        .ai-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Auth Check Banner */
        .auth-banner {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            margin-bottom: 20px;
            border-radius: 10px;
            display: none;
        }

        .auth-banner.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        .personalization-banner {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            margin-bottom: 20px;
            border-radius: 10px;
            display: none;
        }

        .personalization-banner.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hub-container {
            max-width: 1200px;
            margin: 0 auto;
            opacity: 0;
            display: none;
            transition: opacity 0.5s ease;
        }

        .hub-container.ready {
            opacity: 1;
            display: block;
        }

        .hub-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, rgba(255,102,0,0.15), rgba(255,102,0,0.05));
            border-radius: 20px;
            border: 2px solid #ea580c;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 100%;
        }

        .header-text {
            flex: 1;
            text-align: center;
        }

        .header-actions {
            flex-shrink: 0;
            display: flex;
            gap: 10px;
        }

        .back-to-dashboard-btn {
            background: linear-gradient(135deg, #475569, #334155);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .back-to-dashboard-btn:hover {
            background: linear-gradient(135deg, #334155, #1e293b);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .hub-header h1 {
            color: #ea580c;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .hub-header p {
            color: #cbd5e1;
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .user-welcome {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .user-welcome h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .user-welcome p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .session-info-banner {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .session-info-banner.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        /* Progress Overview */
        .progress-overview {
            background: linear-gradient(135deg, #1e293b, #334155);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid #475569;
        }

        .progress-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .progress-header h2 {
            color: #ea580c;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .progress-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(234, 88, 12, 0.1);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(234, 88, 12, 0.3);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ea580c;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #cbd5e1;
            font-size: 0.9rem;
        }

        .completion-bar {
            background: #334155;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin: 20px 0;
        }

        .completion-fill {
            background: linear-gradient(90deg, #ea580c, #f97316);
            height: 100%;
            border-radius: 6px;
            transition: width 1s ease;
        }

        .quiz-results-section {
            background: linear-gradient(135deg, #2a2a2a, #333);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 40px;
            border: 2px solid #444;
        }

        .results-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .results-header h2 {
            color: #ea580c;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .results-header p {
            color: #cbd5e1;
            font-size: 1.1rem;
        }

        .profile-summary {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 30px;
            align-items: center;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(234, 88, 12, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(234, 88, 12, 0.3);
        }

        .profile-card {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .profile-icon {
            font-size: 3rem;
            background: linear-gradient(135deg, #ea580c, #f97316);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-info h3 {
            color: #ea580c;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .profile-info p {
            color: #cbd5e1;
            margin-bottom: 10px;
        }

        .profile-description {
            color: #94a3b8;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 15px;
        }

        .lead-score {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1rem;
            display: inline-block;
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }

        .coaching-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            min-width: 200px;
        }

        .action-btn.start-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-size: 1.1rem;
            padding: 15px 30px;
        }

        .action-btn.quiz-btn {
            background: linear-gradient(135deg, #666, #555);
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        /* AI Recommendations */
        .ai-recommendations {
            background: linear-gradient(135deg, #1e293b, #334155);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid #475569;
        }

        .recommendations-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .recommendations-header h3 {
            color: #ea580c;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .recommendation-card {
            background: rgba(234, 88, 12, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #ea580c;
        }

        .recommendation-card h4 {
            color: #ea580c;
            margin-bottom: 10px;
        }

        .recommendation-card p {
            color: #cbd5e1;
            line-height: 1.5;
        }

        .detailed-analysis {
            margin-top: 40px;
        }

        .analysis-card {
            background: linear-gradient(135deg, #1e293b, #334155);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid #475569;
        }

        .analysis-card h3 {
            color: #ea580c;
            font-size: 1.3rem;
            margin-bottom: 15px;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .insight-card {
            background: linear-gradient(135deg, #1e293b, #334155);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #475569;
        }

        .insight-card h4 {
            color: #ea580c;
            margin-bottom: 15px;
        }

        .insight-card ul {
            list-style: none;
            padding: 0;
        }

        .insight-card li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #cbd5e1;
        }

        .insight-card li:last-child {
            border-bottom: none;
        }

        .coaching-story {
            background: linear-gradient(135deg, #1e293b, #334155);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #475569;
        }

        .coaching-story h3 {
            color: #ea580c;
            margin-bottom: 15px;
        }

        .coaching-story p {
            color: #cbd5e1;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .highlight-box {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid;
        }

        .highlight-box.info {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .wellness-scores-section {
            margin: 40px 0;
        }

        .scores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .score-card {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid #cbd5e1;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .score-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .score-number {
            font-size: 3rem;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .score-label {
            font-size: 1rem;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 15px;
        }

        .score-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #ea580c, #f97316);
            border-radius: 4px;
            transition: width 0.8s ease;
        }

        .score-action {
            color: #ea580c;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .week-module {
            background: linear-gradient(135deg, #2a2a2a, #333);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #444;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .week-module::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ea580c, #f97316);
        }

        .week-module.completed::before {
            background: linear-gradient(90deg, #16a34a, #22c55e);
        }

        .week-module.recommended {
            border-color: #fbbf24;
            box-shadow: 0 8px 25px rgba(251, 191, 36, 0.2);
        }

        .week-module.recommended::before {
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
        }

        .week-module:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(234, 88, 12, 0.2);
            border-color: #ea580c;
        }

        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .week-number {
            font-size: 1.8rem;
            font-weight: 800;
            color: #ea580c;
        }

        .week-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .week-status.completed {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .week-status.recommended {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .week-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 10px;
        }

        .week-description {
            color: #cbd5e1;
            line-height: 1.5;
            margin-bottom: 15px;
            font-size: 0.95rem;
        }

        .week-personalization {
            background: rgba(234, 88, 12, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: #fbbf24;
            font-style: italic;
        }

        .week-button {
            background: linear-gradient(135deg, #ea580c, #f97316);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 4px 15px rgba(234, 88, 12, 0.3);
        }

        .week-button.completed {
            background: linear-gradient(135deg, #16a34a, #22c55e);
        }

        .week-button:hover {
            background: linear-gradient(135deg, #f97316, #fb923c);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(234, 88, 12, 0.4);
        }

        .info-section {
            background: linear-gradient(135deg, #1e293b, #334155);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid #475569;
            text-align: center;
        }

        .info-section h3 {
            color: #ea580c;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .info-section p {
            color: #cbd5e1;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .info-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .info-step {
            background: rgba(234, 88, 12, 0.1);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(234, 88, 12, 0.3);
        }

        .info-step h4 {
            color: #ea580c;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .info-step p {
            color: #cbd5e1;
            font-size: 0.9rem;
            margin: 0;
        }

        .final-cta-section {
            margin-top: 40px;
            text-align: center;
        }

        .main-cta-box {
            background: linear-gradient(135deg, #ea580c, #f97316);
            padding: 40px;
            border-radius: 20px;
            color: white;
            box-shadow: 0 15px 40px rgba(234, 88, 12, 0.3);
            margin-bottom: 0;
        }

        .main-cta-box h3 {
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: white;
        }

        .main-cta-box p {
            font-size: 1.1rem;
            margin-bottom: 25px;
            opacity: 0.95;
            line-height: 1.6;
        }

        .final-cta-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 18px 35px;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .final-cta-btn:hover {
            background: white;
            color: #ea580c;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.3);
        }

        /* Achievement Badges */
        .achievement-badges {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .badge {
            background: rgba(234, 88, 12, 0.2);
            color: #ea580c;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .badge.completed {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid transparent;
            border-top: 2px solid #ea580c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hub-header h1 {
                font-size: 2rem;
            }
            
            .header-content {
                flex-direction: column;
                gap: 20px;
            }
            
            .header-text {
                order: 1;
            }
            
            .header-actions {
                order: 2;
            }
            
            .modules-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .profile-summary {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .insights-grid {
                grid-template-columns: 1fr;
            }
            
            .info-steps {
                grid-template-columns: 1fr;
            }
            
            .progress-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner-big"></div>
        <div class="loading-text">Caricando Hub Coaching AI...</div>
        <div class="loading-subtext">Verificando autenticazione e caricando dati personalizzati</div>
    </div>

    <!-- AI Badge -->
    <div class="ai-badge">🤖 AI v2.0 Hub Integrato</div>
    
    <!-- Auth Banner -->
    <div class="auth-banner" id="authBanner">
        <span id="authText">🔐 Accesso autorizzato per utente autenticato</span>
    </div>

    <!-- Personalization Banner -->
    <div class="personalization-banner" id="personalizationBanner">
        <span id="personalizationText">🎯 Hub personalizzato attivo per il tuo profilo</span>
    </div>

    <!-- Session Info Banner -->
    <div class="session-info-banner" id="sessionInfoBanner">
        <strong>💾 Sessione Unificata Attiva:</strong> <span id="sessionInfoText">Dati sincronizzati automaticamente</span>
    </div>

    <div class="hub-container" id="hubContainer">
        
        <div class="hub-header">
            <div class="header-content">
                <div class="header-text">
                    <h1 id="hubTitle">🎯 Hub Coaching AI v2.0 - 7 Settimane</h1>
                    <p id="hubSubtitle">Il tuo percorso di trasformazione personalizzato con Andrea Padoan</p>
                </div>
                <div class="header-actions">
                    <a href="../pages/user-dashboard.html" class="back-to-dashboard-btn">
                        ← Torna alla Dashboard
                    </a>
                </div>
            </div>
        </div>

        <!-- Progress Overview -->
        <div class="progress-overview">
            <div class="progress-header">
                <h2>📈 Il Tuo Progresso di Trasformazione</h2>
                <p id="progressSubtitle">Panoramica del tuo percorso personalizzato</p>
            </div>
            
            <div class="progress-stats">
                <div class="stat-card">
                    <div class="stat-number" id="completedWeeks">0</div>
                    <div class="stat-label">Settimane Completate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalHours">0</div>
                    <div class="stat-label">Ore di Coaching</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="transformationScore">0</div>
                    <div class="stat-label">Punteggio Trasformazione</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="streakDays">0</div>
                    <div class="stat-label">Giorni di Crescita</div>
                </div>
            </div>
            
            <div class="completion-bar">
                <div class="completion-fill" id="completionFill" style="width: 0%"></div>
            </div>
            <div style="text-align: center; margin-top: 10px; color: #cbd5e1;">
                <span id="completionText">Inizia il tuo percorso di trasformazione</span>
            </div>
        </div>

        <!-- User Welcome -->
        <div class="user-welcome">
            <h2 id="welcomeTitle">👋 Benvenuto nel Hub Coaching AI!</h2>
            <p id="welcomeSubtitle">Coaching personalizzato con Sistema AI v2.0 • Trasformazione adattiva</p>
        </div>

        <!-- AI Recommendations -->
        <div class="ai-recommendations" id="aiRecommendations" style="display: none;">
            <div class="recommendations-header">
                <h3>🤖 Raccomandazioni AI Personalizzate</h3>
                <p>Basate sul tuo profilo e i tuoi progressi</p>
            </div>
            <div id="recommendationsList">
                <!-- Recommendations will be populated here -->
            </div>
        </div>

        <!-- RISULTATI QUIZ E ANALISI PROFILO -->
        <div class="quiz-results-section">
            <div class="results-header">
                <h2>📊 Analisi del Tuo Profilo AI</h2>
                <p id="analysisSubtitle">La tua situazione attuale e come il Sistema AI ti supporta</p>
            </div>
            
            <div class="profile-summary">
                <div class="profile-card">
                    <div class="profile-icon" id="profileIcon">👤</div>
                    <div class="profile-info">
                        <h3 id="profileName">Caricamento Profilo...</h3>
                        <p id="profileDescription">Analisi AI del tuo profilo in corso...</p>
                        <div class="profile-description" id="profileDetailedDescription"></div>
                        <div class="lead-score" id="leadScore">Caricamento...</div>
                        <div class="achievement-badges" id="achievementBadges"></div>
                    </div>
                </div>
                
                <div class="coaching-actions">
                    <button class="action-btn start-btn" id="startCoachingBtn" onclick="startCoachingJourney()">
                        🚀 Inizia/Continua il Tuo Percorso
                    </button>
                    <button class="action-btn quiz-btn" onclick="retakeQuiz()">
                        🔄 Rifai il Test Lifestyle
                    </button>
                </div>
            </div>
            
            <div class="detailed-analysis">
                <div class="analysis-card">
                    <h3 id="situationTitle">🎯 La tua situazione personalizzata</h3>
                    <div class="situation-summary" id="situationSummary">
                        <p>Caricamento analisi personalizzata...</p>
                    </div>
                </div>
                
                <div class="insights-grid">
                    <div class="insight-card">
                        <h4>🏆 Le tue aree di forza</h4>
                        <ul id="strengthsList">
                            <li>Caricamento punti di forza...</li>
                        </ul>
                    </div>
                    <div class="insight-card">
                        <h4>🎯 Le aree che richiedono attenzione</h4>
                        <ul id="improvementsList">
                            <li>Caricamento aree di miglioramento...</li>
                        </ul>
                    </div>
                </div>
                
                <div class="coaching-story">
                    <h3>💭 Approccio coaching personalizzato per te</h3>
                    <p id="coachingApproachText">Caricamento approccio personalizzato...</p>
                    <div class="highlight-box info" id="coachingHighlight">
                        <strong>Per il tuo profilo:</strong> Caricamento strategia specifica...
                    </div>
                </div>
                
                <div class="wellness-scores-section">
                    <div class="scores-grid" id="wellnessScores">
                        <!-- Scores will be populated dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- MODULI SETTIMANE -->
        <div class="modules-grid" id="modulesGrid">
            <!-- Week modules will be populated dynamically -->
        </div>

        <!-- INFO PERCORSO -->
        <div class="info-section">
            <h3>🎯 Come Funziona il Sistema AI v2.0</h3>
            <p id="systemDescription">Il Sistema AI personalizza ogni aspetto del tuo percorso basandosi sul tuo profilo lifestyle unico.</p>
            
            <div class="info-steps">
                <div class="info-step">
                    <h4>1. 🤖 AI Personalizzato</h4>
                    <p>Ogni modulo si adatta automaticamente al tuo profilo comportamentale</p>
                </div>
                <div class="info-step">
                    <h4>2. 💬 Coaching Adattivo</h4>
                    <p>Andrea risponde nel modo più efficace per il tuo tipo di personalità</p>
                </div>
                <div class="info-step">
                    <h4>3. 📊 Progress Intelligente</h4>
                    <p>Il sistema traccia e ottimizza il tuo percorso in tempo reale</p>
                </div>
                <div class="info-step">
                    <h4>4. 🎯 Raccomandazioni Smart</h4>
                    <p>Ricevi suggerimenti personalizzati basati sui tuoi progressi</p>
                </div>
            </div>
        </div>

        <!-- CALL TO ACTION FINALE -->
        <div class="final-cta-section">
            <div class="main-cta-box">
                <h3 id="finalCtaTitle">🚀 Sei Pronto per la Trasformazione AI?</h3>
                <p id="finalCtaText">Il Sistema AI v2.0 è calibrato sul tuo profilo unico. Ogni interazione è personalizzata per massimizzare la tua crescita!</p>
                <button class="final-cta-btn" id="finalCtaBtn" onclick="startCoachingJourney()">
                    ✨ Inizia la Tua Trasformazione Personalizzata
                </button>
            </div>
        </div>

    </div>

    <!-- Load Sistema Sessione Unificato -->
    <script type="module" src="../api/unified-session-manager.js"></script>
    
    <!-- Load Auth Guard -->
    <script type="module" src="../api/auth-guard.js"></script>

    <script>
        // 🤖 SISTEMA AI INTEGRATO v2.0 - MODULE HUB CON SESSION MANAGER
        // ================================================================
        
        // === CONFIGURAZIONE PROFILI LIFESTYLE ===
        const LIFESTYLE_PROFILES_CONFIG = {
            'stressato_esaurito': {
                name: 'Stressato Esaurito',
                emoji: '😰',
                description: 'Persona con alto stress che ha bisogno di recuperare energie e trovare equilibrio',
                coaching_approach: 'Approccio gentile e graduale, focus su auto-cura e gestione stress',
                strengths: ['Resilienza naturale', 'Capacità di sopportare pressione', 'Esperienza nella gestione delle sfide'],
                improvements: ['Gestione dello stress', 'Boundaries personali', 'Tecniche di rilassamento'],
                recommended_weeks: [2, 5, 7],
                cta_text: 'Ritrova il tuo equilibrio con un approccio gentile e sostenibile'
            },
            
            'procrastinatore_bloccato': {
                name: 'Procrastinatore Bloccato',
                emoji: '⏳',
                description: 'Persona che sa cosa fare ma fatica a iniziare e portare a termine le azioni',
                coaching_approach: 'Approccio energico e pratico, focus su micro-azioni e momentum',
                strengths: ['Consapevolezza dei propri obiettivi', 'Capacità di visione', 'Potenziale energetico elevato'],
                improvements: ['Iniziare le azioni', 'Mantenere la costanza', 'Superare i blocchi mentali'],
                recommended_weeks: [3, 4, 5],
                cta_text: 'Trasforma la tua energia in azione concreta e risultati tangibili'
            },
            
            'perfezionista_insoddisfatto': {
                name: 'Perfezionista Insoddisfatto',
                emoji: '🎯',
                description: 'Persona con standard elevati che spesso si blocca nella ricerca della perfezione',
                coaching_approach: 'Approccio paziente e compassionevole, focus su progresso vs perfezione',
                strengths: ['Standard elevati di qualità', 'Attenzione ai dettagli', 'Dedizione al miglioramento'],
                improvements: ['Auto-compassione', 'Accettare il "buono abbastanza"', 'Celebrare i progressi'],
                recommended_weeks: [2, 6, 7],  
                cta_text: 'Scopri come l\'eccellenza nasce dal progresso, non dalla perfezione'
            },
            
            'dispersivo_confuso': {
                name: 'Dispersivo Confuso',
                emoji: '🤯',
                description: 'Persona con molte idee e interessi che fatica a mantenere il focus su priorità chiare',
                coaching_approach: 'Approccio strutturato e chiarificatore, focus su prioritizzazione',
                strengths: ['Creatività e versatilità', 'Mente aperta a nuove possibilità', 'Potenziale multidisciplinare'],
                improvements: ['Focus e concentrazione', 'Prioritizzazione efficace', 'Completamento dei progetti'],
                recommended_weeks: [1, 3, 4],
                cta_text: 'Trasforma la tua creatività in risultati concreti con focus laser'
            },
            
            'motivato_inconsistente': {
                name: 'Motivato Inconsistente',
                emoji: '🎢',
                description: 'Persona con alta motivazione che varia nel tempo, alla ricerca di costanza',
                coaching_approach: 'Approccio sistematico e strutturato, focus su automatismi e tracking',
                strengths: ['Energia e entusiasmo elevati', 'Capacità di visioning', 'Resilienza motivazionale'],
                improvements: ['Costanza nel tempo', 'Sistemi di supporto', 'Abitudini automatiche'],
                recommended_weeks: [4, 5, 7],
                cta_text: 'Trasforma la tua motivazione in risultati costanti e duraturi'
            },
            
            'equilibrato_ottimizzatore': {
                name: 'Equilibrato Ottimizzatore',
                emoji: '⚡',
                description: 'Persona già equilibrata che cerca ottimizzazioni avanzate per la performance',
                coaching_approach: 'Approccio consulenziale e sofisticato, focus su marginal gains',
                strengths: ['Approccio bilanciato alla vita', 'Mentalità di crescita', 'Capacità di auto-analisi'],
                improvements: ['Ottimizzazione avanzata', 'Marginal gains', 'Performance di alto livello'],
                recommended_weeks: [6, 7, 3],
                cta_text: 'Porta la tua performance al livello successivo con ottimizzazioni avanzate'
            }
        };

        // === CONFIGURAZIONE SETTIMANE ===
        const WEEKS_CONFIG = {
            1: {
                title: 'Incontro Conoscitivo',
                description: 'Conosciamoci meglio! Iniziamo il percorso con un questionario approfondito e la prima sessione di coaching personalizzato.',
                ai_focus: 'Exploration e discovery iniziale',
                personalization: {
                    'stressato_esaurito': 'Focus su ascolto e comprensione della tua situazione di stress',
                    'procrastinatore_bloccato': 'Identificazione degli obiettivi che ti motivano davvero',
                    'perfezionista_insoddisfatto': 'Esplorazione dei tuoi standard e aspettative',
                    'dispersivo_confuso': 'Chiarificazione delle tue priorità principali',
                    'motivato_inconsistente': 'Mappatura dei tuoi pattern motivazionali',
                    'equilibrato_ottimizzatore': 'Analisi delle aree di ottimizzazione potenziale'
                }
            },
            2: {
                title: 'Consapevolezza di Sé',
                description: 'Esploriamo le tue motivazioni profonde e scopriamo cosa ti spinge veramente verso il cambiamento.',
                ai_focus: 'Introspezione guidata e auto-consapevolezza',
                personalization: {
                    'stressato_esaurito': 'Riconoscimento dei tuoi pattern di stress e trigger',
                    'procrastinatore_bloccato': 'Esplorazione delle radici della procrastinazione',
                    'perfezionista_insoddisfatto': 'Lavoro su auto-compassione e accettazione',
                    'dispersivo_confuso': 'Identificazione dei tuoi valori core',
                    'motivato_inconsistente': 'Comprensione dei tuoi cicli motivazionali',
                    'equilibrato_ottimizzatore': 'Analisi profonda delle tue zone di comfort'
                }
            },
            3: {
                title: 'Obiettivi SMART',
                description: 'Trasformiamo i tuoi desideri in obiettivi concreti, misurabili e raggiungibili con un piano d\'azione chiaro.',
                ai_focus: 'Goal setting strategico e pianificazione',
                personalization: {
                    'stressato_esaurito': 'Obiettivi di benessere sostenibili e anti-stress',
                    'procrastinatore_bloccato': 'Obiettivi con micro-step immediati e actionable',
                    'perfezionista_insoddisfatto': 'Obiettivi "abbastanza buoni" con margini di flessibilità',
                    'dispersivo_confuso': 'Un obiettivo principale chiaro e focalizzato',
                    'motivato_inconsistente': 'Obiettivi con sistemi di tracking integrati',
                    'equilibrato_ottimizzatore': 'Obiettivi ambiziosi con metriche avanzate'
                }
            },
            4: {
                title: 'Piano di Azione',
                description: 'Creiamo una strategia concreta per raggiungere i tuoi obiettivi, identificando risorse e superando gli ostacoli.',
                ai_focus: 'Strategic planning e execution',
                personalization: {
                    'stressato_esaurito': 'Piano graduale con pause e momenti di recupero',
                    'procrastinatore_bloccato': 'Piano con accountability e deadline serrate',
                    'perfezionista_insoddisfatto': 'Piano flessibile con iterazioni progressive',
                    'dispersivo_confuso': 'Piano lineare e sequenziale molto chiaro',
                    'motivato_inconsistente': 'Piano con backup e sistemi automatici',
                    'equilibrato_ottimizzatore': 'Piano sofisticato con multiple strategie'
                }
            },
            5: {
                title: 'Trasformazione Abitudini',
                description: 'Costruiamo abitudini sostenibili che ti porteranno verso il successo a lungo termine, passo dopo passo.',
                ai_focus: 'Habit formation e behavior change',
                personalization: {
                    'stressato_esaurito': 'Abitudini di auto-cura e gestione energia',
                    'procrastinatore_bloccato': 'Abitudini di azione immediata e momentum',
                    'perfezionista_insoddisfatto': 'Abitudini di auto-compassione e progresso',
                    'dispersivo_confuso': 'Una abitudine focus alla volta',
                    'motivato_inconsistente': 'Abitudini automatiche indipendenti da motivazione',
                    'equilibrato_ottimizzatore': 'Habit stacking avanzato per performance'
                }
            },
            6: {
                title: 'Scopri le Tue Potenzialità',
                description: 'Riconosci e sviluppa i tuoi punti di forza nascosti per massimizzare il tuo potenziale di crescita.',
                ai_focus: 'Strengths discovery e amplification',
                personalization: {
                    'stressato_esaurito': 'Potenzialità di resilienza e gestione pressione',
                    'procrastinatore_bloccato': 'Potenzialità di energia e determinazione',
                    'perfezionista_insoddisfatto': 'Potenzialità di eccellenza e qualità',
                    'dispersivo_confuso': 'Potenzialità di creatività e versatilità',
                    'motivato_inconsistente': 'Potenzialità di leadership e ispirazione',
                    'equilibrato_ottimizzatore': 'Potenzialità di mentorship e coaching'
                }
            },
            7: {
                title: 'Consolidamento e Futuro',
                description: 'Consolidiamo i risultati raggiunti e pianifichiamo il mantenimento a lungo termine della tua trasformazione.',
                ai_focus: 'Consolidation e future planning',
                personalization: {
                    'stressato_esaurito': 'Piano mantenimento anti-stress a lungo termine',
                    'procrastinatore_bloccato': 'Sistema anti-ricadute e accountability permanente',
                    'perfezionista_insoddisfatto': 'Piano crescita continua vs perfezione',
                    'dispersivo_confuso': 'Strutture semplici per focus duraturo',
                    'motivato_inconsistente': 'Sistemi automatici per costanza',
                    'equilibrato_ottimizzatore': 'Piano evoluzione e crescita avanzata'
                }
            }
        };

        // === VARIABILI GLOBALI ===
        let sessionManager = null;
        let currentUser = null;
        let isAuthenticated = false;
        let userProfile = null;
        let progressData = null;
        let completedWeeks = [];
        let hubAI = null;
        let isInitialized = false;

        // === CLASSE SISTEMA AI HUB CON SESSION MANAGER ===
        class ModuleHubAI {
            constructor() {
                this.sessionManager = null;
                this.currentUser = null;
                this.isAuthenticated = false;
                this.userProfile = null;
                this.progressData = null;
                this.isInitialized = false;
            }

            async initialize() {
                try {
                    // 1. Wait for session manager
                    await this.waitForSessionManager();
                    
                    // 2. Check authentication
                    await this.checkAuthentication();
                    
                    // 3. Load user data
                    await this.loadUserData();
                    
                    // 4. Personalizza interfaccia
                    this.personalizeInterface();
                    
                    // 5. Carica progress
                    this.loadProgressData();
                    
                    // 6. Genera raccomandazioni
                    this.generateRecommendations();
                    
                    // 7. Popola moduli
                    this.populateModules();
                    
                    // 8. Setup auto-save
                    this.setupAutoSave();
                    
                    this.isInitialized = true;
                    console.log('🤖 Hub AI Sistema inizializzato con Session Manager');
                    
                    return true;
                } catch (error) {
                    console.error('❌ Errore inizializzazione Hub AI:', error);
                    this.loadFallbackData();
                    return false;
                }
            }

            async waitForSessionManager() {
                return new Promise((resolve) => {
                    const checkSessionManager = () => {
                        if (window.sessionManager && window.isUserAuthenticated) {
                            this.sessionManager = window.sessionManager;
                            resolve();
                        } else {
                            setTimeout(checkSessionManager, 100);
                        }
                    };
                    checkSessionManager();
                });
            }

            async checkAuthentication() {
                try {
                    this.isAuthenticated = window.isUserAuthenticated();
                    this.currentUser = window.getCurrentUser();
                    
                    console.log('🔐 Auth state check:', {
                        authenticated: this.isAuthenticated,
                        user: this.currentUser?.email || 'none'
                    });
                    
                    if (!this.isAuthenticated || !this.currentUser) {
                        // Redirect to login if not authenticated
                        console.log('🚫 User not authenticated, redirecting to login');
                        window.location.href = '../pages/login.html';
                        throw new Error('Authentication required');
                    }
                    
                    // Show auth banner
                    this.showAuthBanner();
                    
                } catch (error) {
                    console.error('❌ Auth check failed:', error);
                    throw error;
                }
            }

            showAuthBanner() {
                const authBanner = document.getElementById('authBanner');
                const authText = document.getElementById('authText');
                
                if (authBanner && authText && this.currentUser) {
                    const userName = this.currentUser.displayName || this.currentUser.email.split('@')[0];
                    authText.textContent = `🔐 Accesso autorizzato per ${userName}`;
                    authBanner.classList.add('active');
                }
            }

            async loadUserData() {
                try {
                    // Carica dati dal session manager
                    const userData = window.getUserData();
                    
                    console.log('📊 User data from session manager:', userData);
                    
                    // Carica profilo lifestyle dal session manager o localStorage
                    if (userData && userData.lifestyleProfile) {
                        this.userProfile = userData.lifestyleProfile;
                    } else {
                        // Fallback a localStorage
                        const quizData = localStorage.getItem('lifestyleQuizResults');
                        if (quizData) {
                            this.userProfile = JSON.parse(quizData);
                            // Salva nel session manager per future volte
                            this.sessionManager.updateUserData({ lifestyleProfile: this.userProfile });
                        }
                    }
                    
                    // Se ancora non c'è profilo, usa default
                    if (!this.userProfile) {
                        this.userProfile = {
                            profileType: 'motivato_inconsistente',
                            name: this.currentUser.displayName || this.currentUser.email.split('@')[0],
                            challenges: [],
                            scores: { wellbeing: 3, health: 3, professional: 4, social: 2 }
                        };
                        
                        // Salva nel session manager
                        this.sessionManager.updateUserData({ lifestyleProfile: this.userProfile });
                    }
                    
                    // Ensure name is from current user
                    this.userProfile.name = this.currentUser.displayName || this.currentUser.email.split('@')[0];
                    
                    // Carica progress dal session manager
                    if (userData && userData.moduleHubProgress) {
                        this.progressData = userData.moduleHubProgress;
                    } else {
                        // Fallback a localStorage
                        const progressData = localStorage.getItem('lifestyleProgress');
                        if (progressData) {
                            this.progressData = JSON.parse(progressData);
                        }
                    }
                    
                    // Default progress se non esiste
                    if (!this.progressData) {
                        this.progressData = {
                            completedWeeks: [],
                            currentWeek: 1,
                            totalSessions: 0,
                            totalHours: 0,
                            transformationScore: 0,
                            streakDays: 0,
                            lastAccess: new Date().toISOString()
                        };
                    }
                    
                    // Update last access
                    this.progressData.lastAccess = new Date().toISOString();
                    
                    // Save updated data back to session manager
                    this.sessionManager.updateUserData({ 
                        lifestyleProfile: this.userProfile,
                        moduleHubProgress: this.progressData
                    });
                    
                    console.log('✅ User data loaded and synced with session manager');
                    
                } catch (error) {
                    console.error('❌ Error loading user data:', error);
                    throw error;
                }
            }

            personalizeInterface() {
                const config = LIFESTYLE_PROFILES_CONFIG[this.userProfile.profileType];
                if (!config) {
                    console.warn('⚠️ Profilo non trovato, uso fallback');
                    return;
                }

                // Session info banner
                this.showSessionInfoBanner();
                
                // Banner personalizzazione
                const banner = document.getElementById('personalizationBanner');
                const bannerText = document.getElementById('personalizationText');
                if (banner && bannerText) {
                    banner.classList.add('active');
                    bannerText.textContent = `🎯 Hub personalizzato per: ${config.name} ${config.emoji}`;
                }

                // Titoli personalizzati
                const hubTitle = document.getElementById('hubTitle');
                const hubSubtitle = document.getElementById('hubSubtitle');
                const welcomeTitle = document.getElementById('welcomeTitle');
                const welcomeSubtitle = document.getElementById('welcomeSubtitle');

                if (hubTitle && this.userProfile.name) {
                    hubTitle.textContent = `🎯 Hub Coaching ${this.userProfile.name} - AI v2.0`;
                }

                if (hubSubtitle) {
                    hubSubtitle.textContent = `Percorso personalizzato per ${config.name}`;
                }

                if (welcomeTitle) {
                    welcomeTitle.textContent = `👋 Benvenuto ${this.userProfile.name}!`;
                }

                if (welcomeSubtitle) {
                    welcomeSubtitle.textContent = `Coaching AI personalizzato per ${config.name} • Trasformazione adattiva • Session Manager Integrato`;
                }

                // Profilo display
                this.updateProfileDisplay(config);

                // CTA personalizzate
                this.personalizeCTAs(config);

                // Progress subtitle
                const progressSubtitle = document.getElementById('progressSubtitle');
                if (progressSubtitle) {
                    progressSubtitle.textContent = `Il tuo progresso come ${config.name} - Dati sincronizzati automaticamente`;
                }
            }

            showSessionInfoBanner() {
                const sessionBanner = document.getElementById('sessionInfoBanner');
                const sessionText = document.getElementById('sessionInfoText');
                
                if (sessionBanner && sessionText && this.sessionManager) {
                    const sessionInfo = this.sessionManager.sessionInfo;
                    const sessionAge = Math.round((Date.now() - sessionInfo.loginTime) / (1000 * 60));
                    
                    sessionText.textContent = `Sessione attiva da ${sessionAge} minuti • Dati sincronizzati automaticamente`;
                    sessionBanner.classList.add('show');
                }
            }

            updateProfileDisplay(config) {
                const profileIcon = document.getElementById('profileIcon');
                const profileName = document.getElementById('profileName');
                const profileDescription = document.getElementById('profileDescription');
                const profileDetailedDescription = document.getElementById('profileDetailedDescription');
                const leadScore = document.getElementById('leadScore');

                if (profileIcon) {
                    profileIcon.textContent = config.emoji;
                }

                if (profileName) {
                    profileName.textContent = `${this.userProfile.name} - ${config.name}`;
                }

                if (profileDescription) {
                    profileDescription.textContent = config.description;
                }

                if (profileDetailedDescription) {
                    profileDetailedDescription.textContent = `${config.coaching_approach} • Dati sincronizzati con Session Manager`;
                }

                if (leadScore) {
                    const score = this.calculateOverallScore();
                    leadScore.textContent = `${score}% Potenziale`;
                    leadScore.className = score >= 75 ? 'lead-score' : 'lead-score medium';
                }

                // Update detailed analysis
                this.updateDetailedAnalysis(config);
            }

            updateDetailedAnalysis(config) {
                // Situation summary
                const situationSummary = document.getElementById('situationSummary');
                if (situationSummary) {
                    situationSummary.innerHTML = `
                        <p><strong>Ciao ${this.userProfile.name}!</strong> Ho analizzato il tuo profilo con il Sistema AI v2.0 integrato con Session Manager e voglio condividere alcune riflessioni personalizzate.</p>
                        <p><strong>Il tuo profilo:</strong> ${config.name} ${config.emoji}</p>
                        <p>${config.description}</p>
                        <div class="highlight-box info">Il Sistema AI ha calibrato tutto il percorso sui tuoi dati reali sincronizzati automaticamente!</div>
                    `;
                }

                // Update strengths and improvements
                const strengthsList = document.getElementById('strengthsList');
                const improvementsList = document.getElementById('improvementsList');

                if (strengthsList && config.strengths) {
                    strengthsList.innerHTML = config.strengths.map(strength => `<li>💪 ${strength}</li>`).join('');
                }

                if (improvementsList && config.improvements) {
                    improvementsList.innerHTML = config.improvements.map(improvement => `<li>🎯 ${improvement}</li>`).join('');
                }

                // Update coaching approach
                const coachingApproachText = document.getElementById('coachingApproachText');
                const coachingHighlight = document.getElementById('coachingHighlight');

                if (coachingApproachText) {
                    coachingApproachText.textContent = `Con il Sistema AI v2.0 integrato con Session Manager, il mio approccio con te sarà: ${config.coaching_approach}. Ogni interazione è calibrata sui tuoi dati reali e sincronizzata automaticamente.`;
                }

                if (coachingHighlight) {
                    coachingHighlight.innerHTML = `<strong>Per il tuo profilo "${config.name}":</strong> ${config.cta_text} • I tuoi progressi sono tracciati e salvati automaticamente nel sistema unificato.`;
                }

                // Update wellness scores
                this.updateWellnessScores();
            }

            updateWellnessScores() {
                const wellnessScores = document.getElementById('wellnessScores');
                if (!wellnessScores || !this.userProfile.scores) return;

                const scoreLabels = {
                    wellbeing: 'Benessere Emotivo',
                    health: 'Salute Fisica',
                    social: 'Relazioni Sociali',
                    professional: 'Vita Professionale'
                };

                wellnessScores.innerHTML = '';
                Object.entries(this.userProfile.scores).forEach(([key, value]) => {
                    const scoreCard = document.createElement('div');
                    scoreCard.className = 'score-card';
                    
                    const percentage = (value / 5) * 100;
                    const action = value >= 4 ? 'Molto bene!' : value >= 3 ? 'Buon livello!' : 'Puoi migliorare!';
                    
                    scoreCard.innerHTML = `
                        <div class="score-number">${value}</div>
                        <div class="score-label">${scoreLabels[key] || key}</div>
                        <div class="score-bar">
                            <div class="score-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="score-action">${action}</div>
                    `;
                    
                    wellnessScores.appendChild(scoreCard);
                });
            }

            loadProgressData() {
                // Carica dati completamento settimane dal session manager e localStorage
                completedWeeks = this.progressData.completedWeeks || [];
                let totalHours = this.progressData.totalHours || 0;
                let transformationScore = this.progressData.transformationScore || 0;

                // Sincronizza con localStorage per backward compatibility
                for (let i = 1; i <= 7; i++) {
                    const weekData = localStorage.getItem(`week${i}SessionCompleted`);
                    if (weekData && !completedWeeks.includes(i)) {
                        completedWeeks.push(i);
                        totalHours += 0.75; // 45 min per sessione
                    }
                }

                // Carica score finale se completato
                const finalData = localStorage.getItem('lifestyleCoachingCompleted');
                if (finalData && !transformationScore) {
                    const final = JSON.parse(finalData);
                    transformationScore = Math.round(final.finalScore * 20) || 0; // Convert to percentage
                }

                // Update progress data
                this.progressData.completedWeeks = completedWeeks;
                this.progressData.totalHours = totalHours;
                this.progressData.transformationScore = transformationScore;

                // Save back to session manager
                this.sessionManager.updateUserData({ moduleHubProgress: this.progressData });

                // Update progress display
                this.updateProgressDisplay(completedWeeks.length, totalHours, transformationScore);
                
                // Update progress bar
                const completionPercentage = (completedWeeks.length / 7) * 100;
                this.updateCompletionBar(completionPercentage);
            }

            updateProgressDisplay(completed, hours, score) {
                document.getElementById('completedWeeks').textContent = completed;
                document.getElementById('totalHours').textContent = hours.toFixed(1);
                document.getElementById('transformationScore').textContent = score;
                
                // Calculate streak (placeholder)
                const streakDays = completed * 7; // Estimated
                document.getElementById('streakDays').textContent = streakDays;

                // Update completion text
                const completionText = document.getElementById('completionText');
                if (completed === 0) {
                    completionText.textContent = `Inizia il tuo percorso personalizzato, ${this.userProfile.name}`;
                } else if (completed === 7) {
                    completionText.textContent = `🎉 Percorso completato! ${this.userProfile.name}, trasformazione straordinaria raggiunta!`;
                } else {
                    completionText.textContent = `${completed}/7 settimane completate - Ottimi progressi, ${this.userProfile.name}!`;
                }
            }

            updateCompletionBar(percentage) {
                const fill = document.getElementById('completionFill');
                if (fill) {
                    setTimeout(() => {
                        fill.style.width = `${percentage}%`;
                    }, 500);
                }
            }

            generateRecommendations() {
                const config = LIFESTYLE_PROFILES_CONFIG[this.userProfile.profileType];
                if (!config || !config.recommended_weeks) return;

                const recommendationsSection = document.getElementById('aiRecommendations');
                const recommendationsList = document.getElementById('recommendationsList');

                if (!recommendationsSection || !recommendationsList) return;

                // Show recommendations section
                recommendationsSection.style.display = 'block';

                // Generate recommendations based on profile and progress
                const recommendations = this.generateSmartRecommendations(config);
                
                recommendationsList.innerHTML = recommendations.map(rec => `
                    <div class="recommendation-card">
                        <h4>${rec.title}</h4>
                        <p>${rec.description}</p>
                    </div>
                `).join('');
            }

            generateSmartRecommendations(config) {
                const recommendations = [];
                
                // Next week recommendation
                const nextWeek = this.getNextRecommendedWeek();
                if (nextWeek) {
                    const weekConfig = WEEKS_CONFIG[nextWeek];
                    const personalization = weekConfig.personalization[this.userProfile.profileType];
                    
                    recommendations.push({
                        title: `🎯 Prossimo Step: Settimana ${nextWeek}`,
                        description: `${weekConfig.title} - ${personalization} • Dati salvati automaticamente nel Session Manager`
                    });
                }

                // Profile-specific recommendation
                if (completedWeeks.length > 0) {
                    recommendations.push({
                        title: '🤖 Raccomandazione AI Personalizzata',
                        description: this.getPersonalizedAdvice(config)
                    });
                }

                // Session manager integration recommendation
                recommendations.push({
                    title: '💾 Sistema Unificato Attivo',
                    description: `Tutti i tuoi progressi sono sincronizzati automaticamente. Session manager mantiene i dati aggiornati tra tutte le pagine del sistema.`
                });

                // Progress-based recommendation
                if (completedWeeks.length >= 3) {
                    recommendations.push({
                        title: '📈 Ottimizzazione Progresso',
                        description: 'Hai fatto ottimi progressi! I tuoi dati sono al sicuro nel sistema unificato. Considera di rivedere le settimane precedenti per consolidare i risultati.'
                    });
                }

                return recommendations;
            }

            getNextRecommendedWeek() {
                // Logic to determine next recommended week based on profile and progress
                const config = LIFESTYLE_PROFILES_CONFIG[this.userProfile.profileType];
                
                if (completedWeeks.length === 0) {
                    return 1; // Always start with week 1
                }

                // Find first incomplete recommended week
                for (const weekNum of config.recommended_weeks) {
                    if (!completedWeeks.includes(weekNum)) {
                        return weekNum;
                    }
                }

                // If all recommended weeks are done, suggest next sequential week
                for (let i = 1; i <= 7; i++) {
                    if (!completedWeeks.includes(i)) {
                        return i;
                    }
                }

                return null; // All weeks completed
            }

            getPersonalizedAdvice(config) {
                const adviceMap = {
                    'stressato_esaurito': 'Focus sulle settimane che lavorano su gestione stress e auto-cura. Il tuo ritmo è perfetto, i progressi sono salvati automaticamente.',
                    'procrastinatore_bloccato': 'Concentrati su azione immediata! Le settimane 3 e 4 ti daranno strumenti concreti. Il sistema traccia ogni tuo progresso.',
                    'perfezionista_insoddisfatto': 'Ricorda: progresso over perfezione. Ogni settimana completata è automaticamente salvata e celebrata dal sistema.',
                    'dispersivo_confuso': 'Una settimana alla volta, un focus chiaro. Il Sistema AI con Session Manager ti aiuta a mantenere la direzione giusta.',
                    'motivato_inconsistente': 'Costruisci sistemi automatici con le settimane 4 e 5. Il Session Manager mantiene la costanza dei tuoi dati.',
                    'equilibrato_ottimizzatore': 'Ottimizza il tuo percorso con le settimane avanzate. I tuoi dati di performance sono tracciati accuratamente.'
                };

                return adviceMap[this.userProfile.profileType] || 'Continua il tuo percorso personalizzato, stai facendo progressi straordinari tracciati dal sistema unificato!';
            }

            populateModules() {
                const modulesGrid = document.getElementById('modulesGrid');
                if (!modulesGrid) return;

                modulesGrid.innerHTML = '';

                for (let weekNum = 1; weekNum <= 7; weekNum++) {
                    const weekConfig = WEEKS_CONFIG[weekNum];
                    const isCompleted = completedWeeks.includes(weekNum);
                    const isRecommended = this.isWeekRecommended(weekNum);
                    
                    const moduleCard = this.createModuleCard(weekNum, weekConfig, isCompleted, isRecommended);
                    modulesGrid.appendChild(moduleCard);
                }
            }

            isWeekRecommended(weekNum) {
                const config = LIFESTYLE_PROFILES_CONFIG[this.userProfile.profileType];
                return config && config.recommended_weeks && config.recommended_weeks.includes(weekNum);
            }

            createModuleCard(weekNum, weekConfig, isCompleted, isRecommended) {
                const card = document.createElement('div');
                card.className = `week-module ${isCompleted ? 'completed' : ''} ${isRecommended ? 'recommended' : ''}`;
                card.setAttribute('data-week', weekNum);

                const personalization = weekConfig.personalization[this.userProfile.profileType] || weekConfig.description;
                
                let statusText = '▶️ Disponibile';
                let statusClass = '';
                let buttonText = '🚀 Inizia Settimana';
                let buttonClass = '';
                
                if (isCompleted) {
                    statusText = '✅ Completata';
                    statusClass = 'completed';
                    buttonText = '📖 Rivedi Settimana';
                    buttonClass = 'completed';
                } else if (isRecommended) {
                    statusText = '⭐ Consigliata AI';
                    statusClass = 'recommended';
                    buttonText = '🎯 Inizia Ora';
                }
                
                card.innerHTML = `
                    <div class="week-header">
                        <div class="week-number">Settimana ${weekNum}</div>
                        <div class="week-status ${statusClass}">${statusText}</div>
                    </div>
                    <h3 class="week-title">${weekConfig.title}</h3>
                    <p class="week-description">${weekConfig.description}</p>
                    <div class="week-personalization">💡 ${personalization} • Auto-save attivo</div>
                    <button class="week-button ${buttonClass}" onclick="navigateToWeek(${weekNum})">
                        ${buttonText}
                    </button>
                `;
                
                return card;
            }

            personalizeCTAs(config) {
                const startBtn = document.getElementById('startCoachingBtn');
                const finalCtaBtn = document.getElementById('finalCtaBtn');
                
                if (startBtn) {
                    if (completedWeeks.length > 0) {
                        startBtn.textContent = `🚀 Continua il Tuo Percorso, ${this.userProfile.name}`;
                    } else {
                        startBtn.textContent = `🚀 Inizia il Tuo Percorso, ${this.userProfile.name}`;
                    }
                }
                
                if (finalCtaBtn) {
                    finalCtaBtn.textContent = `✨ ${config.cta_text}`;
                }
            }

            calculateOverallScore() {
                if (!this.userProfile.scores) return 50;
                
                const scores = Object.values(this.userProfile.scores);
                const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
                return Math.round(avg * 20); // Convert 1-5 to percentage
            }

            setupAutoSave() {
                // Auto-save ogni 2 minuti
                setInterval(() => {
                    if (this.sessionManager && this.isAuthenticated) {
                        this.saveToSessionManager();
                        console.log('💾 Auto-save completato nel Session Manager');
                    }
                }, 120000); // 2 minuti

                // Save on page visibility change
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden' && this.sessionManager) {
                        this.saveToSessionManager();
                    }
                });

                // Save before page unload
                window.addEventListener('beforeunload', () => {
                    if (this.sessionManager) {
                        this.saveToSessionManager();
                    }
                });
            }

            saveToSessionManager() {
                if (!this.sessionManager || !this.isAuthenticated) return;

                try {
                    // Update progress data with current state
                    this.progressData.lastAccess = new Date().toISOString();
                    this.progressData.completedWeeks = completedWeeks;
                    
                    // Save to session manager
                    this.sessionManager.updateUserData({
                        lifestyleProfile: this.userProfile,
                        moduleHubProgress: this.progressData,
                        moduleHubLastAccess: new Date().toISOString()
                    });
                    
                    // Extend session
                    this.sessionManager.extendSession();
                    
                    console.log('💾 Dati salvati nel Session Manager');
                } catch (error) {
                    console.error('❌ Errore salvataggio Session Manager:', error);
                }
            }

            loadFallbackData() {
                console.log('⚠️ Caricamento dati fallback...');
                this.userProfile = {
                    profileType: 'motivato_inconsistente',
                    name: this.currentUser?.displayName || 'Utente',
                    challenges: ['consistency', 'focus'],
                    scores: { wellbeing: 3, health: 3, professional: 3, social: 3 }
                };
                this.progressData = {
                    completedWeeks: [],
                    currentWeek: 1,
                    totalSessions: 0,
                    totalHours: 0,
                    transformationScore: 0,
                    streakDays: 0
                };
            }
        }

        // === FUNZIONI GLOBALI ===
        
        /**
         * Funzione per iniziare/continuare il percorso di coaching
         */
        function startCoachingJourney() {
            console.log('🚀 Avvio percorso di coaching...');
            
            // Determina la prossima settimana da fare
            let nextWeek = 1;
            
            if (hubAI && hubAI.userProfile) {
                const config = LIFESTYLE_PROFILES_CONFIG[hubAI.userProfile.profileType];
                
                // Se ci sono settimane completate, trova la prossima
                if (completedWeeks.length > 0) {
                    // Prima controlla le settimane consigliate per il profilo
                    for (const recommendedWeek of config.recommended_weeks) {
                        if (!completedWeeks.includes(recommendedWeek)) {
                            nextWeek = recommendedWeek;
                            break;
                        }
                    }
                    
                    // Se tutte le consigliate sono fatte, prendi la prossima sequenziale
                    if (nextWeek === 1) {
                        for (let i = 1; i <= 7; i++) {
                            if (!completedWeeks.includes(i)) {
                                nextWeek = i;
                                break;
                            }
                        }
                    }
                }
            }
            
            // Salva stato attuale nel session manager
            saveProgressState();
            
            // Naviga alla settimana appropriata
            navigateToWeek(nextWeek);
        }
        
        /**
         * Funzione per rifare il test lifestyle
         */
        function retakeQuiz() {
            console.log('🔄 Ritorno al quiz lifestyle...');
            
            // Mostra conferma
            const confirmRetake = confirm(
                '⚠️ Rifare il test resetterà il tuo profilo attuale.\n\n' +
                'I tuoi progressi nelle settimane saranno mantenuti nel Session Manager, ma il profilo sarà aggiornato.\n\n' +
                'Vuoi continuare?'
            );
            
            if (confirmRetake) {
                // Salva progressi attuali nel session manager
                saveProgressState();
                
                // Naviga al quiz
                window.location.href = '../pages/lifestyle-quiz.html';
            }
        }
        
        /**
         * Funzione per navigare a una settimana specifica
         */
        function navigateToWeek(weekNumber) {
            console.log(`📚 Navigazione a settimana ${weekNumber}...`);
            
            // Salva la settimana corrente nel session manager
            if (hubAI && hubAI.sessionManager) {
                hubAI.sessionManager.updateUserData({
                    currentWeek: weekNumber,
                    weekNavigationTime: new Date().toISOString()
                });
            }
            
            // Fallback localStorage
            localStorage.setItem('currentWeek', weekNumber);
            
            // Salva dati profilo per la settimana
            if (hubAI && hubAI.userProfile) {
                localStorage.setItem('weekUserProfile', JSON.stringify(hubAI.userProfile));
            }
            
            // URL della settimana
            const weekUrl = `week-${weekNumber}.html`;
            
            // Naviga alla pagina della settimana
            window.location.href = weekUrl;
        }
        
        /**
         * Salva lo stato del progresso nel session manager
         */
        function saveProgressState() {
            const progressState = {
                completedWeeks: completedWeeks,
                currentWeek: hubAI?.progressData?.currentWeek || 1,
                totalSessions: hubAI?.progressData?.totalSessions || 0,
                totalHours: hubAI?.progressData?.totalHours || 0,
                transformationScore: hubAI?.progressData?.transformationScore || 0,
                streakDays: hubAI?.progressData?.streakDays || 0,
                lastAccess: new Date().toISOString()
            };
            
            // Save to session manager if available
            if (hubAI && hubAI.sessionManager) {
                hubAI.sessionManager.updateUserData({ 
                    moduleHubProgress: progressState,
                    moduleHubLastSave: new Date().toISOString()
                });
                console.log('💾 Stato progresso salvato nel Session Manager:', progressState);
            }
            
            // Fallback localStorage
            localStorage.setItem('lifestyleProgress', JSON.stringify(progressState));
        }
        
        /**
         * Mostra notifica toast
         */
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 10px;
                font-weight: 600;
                z-index: 10000;
                animation: slideIn 0.3s ease;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                max-width: 350px;
            `;
            
            switch(type) {
                case 'success':
                    notification.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    notification.style.color = 'white';
                    break;
                case 'error':
                    notification.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    notification.style.color = 'white';
                    break;
                case 'warning':
                    notification.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
                    notification.style.color = 'white';
                    break;
                default:
                    notification.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
                    notification.style.color = 'white';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loadingScreen');
            const hubContainer = document.getElementById('hubContainer');
            
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 500);
            }
            
            if (hubContainer) {
                hubContainer.classList.add('ready');
            }
        }
        
        // === INIZIALIZZAZIONE AL CARICAMENTO PAGINA ===
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🏠 Inizializzazione Module Hub AI v2.0 con Session Manager...');
            
            try {
                // Crea istanza del sistema AI
                hubAI = new ModuleHubAI();
                
                // Inizializza (include controllo auth)
                const success = await hubAI.initialize();
                
                if (success) {
                    console.log('✅ Hub AI inizializzato con successo con Session Manager!');
                    showNotification('🤖 Sistema AI personalizzato attivato con dati sincronizzati!', 'success');
                } else {
                    console.warn('⚠️ Hub AI inizializzato con dati fallback');
                    showNotification('⚠️ Alcuni dati non disponibili, uso configurazione base', 'warning');
                }
                
                // Hide loading screen
                hideLoadingScreen();
                
            } catch (error) {
                console.error('❌ Errore critico inizializzazione:', error);
                
                // Check if it's an auth error
                if (error.message === 'Authentication required') {
                    // Auth error, redirect will happen automatically
                    return;
                }
                
                hideLoadingScreen();
                showNotification('❌ Errore caricamento sistema AI', 'error');
                
                // Load basic interface without personalization
                const hubContainer = document.getElementById('hubContainer');
                if (hubContainer) {
                    hubContainer.classList.add('ready');
                }
                
                document.getElementById('profileName').textContent = 'Profilo Standard';
                document.getElementById('profileDescription').textContent = 'Sistema AI in modalità base';
            }
        });
        
        // === ANIMAZIONI CSS PERSONALIZZATE ===
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            
            .week-module {
                cursor: pointer;
                user-select: none;
            }
            
            .week-module:active {
                transform: scale(0.98);
            }
            
            .achievement-badges {
                animation: fadeIn 0.5s ease;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;
        document.head.appendChild(style);
        
        console.log('✅ Module Hub AI v2.0 con Session Manager - Sistema completamente caricato e funzionante!');
    </script>
</body>
</html>