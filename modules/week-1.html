<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settimana 1 - Incontro Conoscitivo | Andrea Padoan Coach</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #fff7ed 50%, #f0fdf4 100%);
            min-height: 100vh;
            color: #1e293b;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .session-info {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .timer-display {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-bar {
            background: rgba(255,255,255,0.2);
            width: 200px;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            background: #22c55e;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .back-button {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            color: white;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Phase Indicator */
        .phase-indicator {
            background: white;
            border-radius: 12px;
            padding: 1rem 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .phase-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            min-width: 200px;
        }

        .phase-step.active {
            background: linear-gradient(135deg, #ea580c 0%, #fb923c 100%);
            color: white;
        }

        .phase-step.completed {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: white;
        }

        .phase-step.inactive {
            background: #f1f5f9;
            color: #94a3b8;
        }

        .phase-arrow {
            font-size: 1.5rem;
            color: #64748b;
        }

        /* Welcome Section */
        .welcome-section {
            background: white;
            border-radius: 16px;
            padding: 3rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            text-align: center;
        }

        .welcome-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 1rem;
        }

        .welcome-subtitle {
            font-size: 1.3rem;
            color: #ea580c;
            margin-bottom: 2rem;
        }

        .process-explanation {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: left;
        }

        .process-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #16a34a;
            margin-bottom: 1rem;
            text-align: center;
        }

        .process-steps {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .process-step {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid #16a34a;
        }

        .step-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #16a34a;
            margin-bottom: 0.5rem;
        }

        .step-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .step-description {
            font-size: 0.9rem;
            color: #64748b;
            line-height: 1.5;
        }

        .step-duration {
            font-size: 0.8rem;
            color: #ea580c;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        /* Phase 1 - Quick Test */
        .phase1-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: none;
        }

        .phase1-section.active {
            display: block;
        }

        .phase-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f1f5f9;
        }

        .phase-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .phase-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .phase-subtitle {
            font-size: 1rem;
            color: #64748b;
        }

        .form-progress {
            background: #f1f5f9;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .form-progress-text {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .form-progress-bar {
            background: #e2e8f0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .form-progress-fill {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #ea580c;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Phase 2 - AI Deep Dive */
        .phase2-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: none;
        }

        .phase2-section.active {
            display: block;
        }

        .chat-container {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 12px;
            max-width: 85%;
            animation: messageSlide 0.3s ease-out;
        }

        .message.coach {
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            margin-right: auto;
        }

        .message.user {
            background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%);
            margin-left: auto;
            text-align: right;
        }

        .message-content {
            font-size: 1rem;
            line-height: 1.5;
            margin-bottom: 0.5rem;
        }

        .message-time {
            font-size: 0.8rem;
            color: #64748b;
        }

        .chat-input {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .chat-input input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .chat-input input:focus {
            outline: none;
            border-color: #ea580c;
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #16a34a;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e293b 0%, #ea580c 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .btn-secondary {
            background: white;
            color: #1e293b;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            border-color: #ea580c;
            color: #ea580c;
        }

        .btn-success {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
        }

        .btn-disabled {
            background: #94a3b8;
            color: white;
            cursor: not-allowed;
        }

        /* Time Warning */
        .time-warning {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }

        .time-warning.active {
            display: block;
        }

        /* Completion Section */
        .completion-section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-top: 2rem;
            display: none;
        }

        .completion-section.active {
            display: block;
        }

        .completion-title {
            font-size: 2rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 1rem;
            text-align: center;
        }

        .completion-message {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #475569;
            margin-bottom: 2rem;
            text-align: center;
        }

        .homework-section {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .homework-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #16a34a;
            margin-bottom: 1rem;
        }

        .homework-list {
            list-style: none;
            padding: 0;
        }

        .homework-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(34, 197, 94, 0.2);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .homework-list li:last-child {
            border-bottom: none;
        }

        .completion-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* Animations */
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }
            
            .process-steps {
                grid-template-columns: 1fr;
            }
            
            .phase-indicator {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .phase-step {
                min-width: auto;
                width: 100%;
                justify-content: center;
            }
            
            .phase-arrow {
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">🤝 Settimana 1 - Incontro Conoscitivo</div>
            <div class="session-info">
                <div class="timer-display">
                    ⏱️ <span id="sessionTimer">40:00</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="sessionProgress"></div>
                </div>
                <a href="module-hub.html" class="back-button">← Torna ai Moduli</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Phase Indicator -->
        <div class="phase-indicator">
            <div class="phase-step active" id="phaseStep1">
                <span>📋</span>
                <span>Fase 1: Test Conoscitivo</span>
            </div>
            <div class="phase-arrow">→</div>
            <div class="phase-step inactive" id="phaseStep2">
                <span>🤖</span>
                <span>Fase 2: Approfondimento AI</span>
            </div>
        </div>

        <!-- Welcome Section -->
        <section class="welcome-section fade-in" id="welcomeSection">
            <h1 class="welcome-title">Benvenuto nella Tua Prima Sessione! 🎉</h1>
            <p class="welcome-subtitle">Incontro Conoscitivo - Settimana 1</p>
            
            <div class="process-explanation">
                <h3 class="process-title">🎯 Come Funziona la Tua Sessione</h3>
                <div class="process-steps">
                    <div class="process-step">
                        <div class="step-number">1</div>
                        <div class="step-title">Test Conoscitivo</div>
                        <div class="step-description">
                            Rispondi a poche domande essenziali per darmi una panoramica della tua situazione attuale.
                        </div>
                        <div class="step-duration">⏱️ 3 minuti</div>
                    </div>
                    <div class="process-step">
                        <div class="step-number">2</div>
                        <div class="step-title">Approfondimento AI</div>
                        <div class="step-description">
                            Chatto con te per approfondire i tuoi obiettivi, il tuo passato e il tuo futuro con domande personalizzate.
                        </div>
                        <div class="step-duration">⏱️ 25-35 minuti</div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="startPhase1()">
                🚀 Inizia la Sessione
            </button>
        </section>

        <!-- Phase 1: Quick Test -->
        <section class="phase1-section" id="phase1Section">
            <div class="phase-header">
                <div class="phase-icon">📋</div>
                <div>
                    <h2 class="phase-title">Fase 1: Test Conoscitivo</h2>
                    <p class="phase-subtitle">Poche domande per iniziare a conoscerti</p>
                </div>
            </div>
            
            <div class="form-progress">
                <div class="form-progress-text">Progresso: <span id="phase1Progress">0%</span></div>
                <div class="form-progress-bar">
                    <div class="form-progress-fill" id="phase1ProgressFill" style="width: 0%"></div>
                </div>
            </div>
            
            <form id="phase1Form">
                <div class="form-group">
                    <label for="currentSituation">Descrivi la tua situazione attuale in poche parole:</label>
                    <textarea id="currentSituation" placeholder="Es: Manager stressato, mamma sempre di corsa, studente demotivato..." onchange="updatePhase1Progress(); autoSave()"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="mainChallenge">Qual è la tua sfida principale in questo momento?</label>
                    <textarea id="mainChallenge" placeholder="Cosa ti sta ostacolando di più?" onchange="updatePhase1Progress(); autoSave()"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="mainGoal">Qual è il tuo obiettivo principale?</label>
                    <textarea id="mainGoal" placeholder="Cosa vuoi raggiungere con questo percorso?" onchange="updatePhase1Progress(); autoSave()"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="lifestyle">Come descriveresti il tuo stile di vita?</label>
                    <select id="lifestyle" onchange="updatePhase1Progress(); autoSave()">
                        <option value="">Seleziona...</option>
                        <option value="molto_dinamico">Molto dinamico - sempre in movimento</option>
                        <option value="equilibrato">Equilibrato - momenti attivi e di riposo</option>
                        <option value="sedentario">Sedentario - principalmente statico</option>
                        <option value="caotico">Caotico - senza routine fisse</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="motivationLevel">Come ti senti motivato in questo momento?</label>
                    <select id="motivationLevel" onchange="updatePhase1Progress(); autoSave()">
                        <option value="">Seleziona...</option>
                        <option value="molto_motivato">Molto motivato - pronto a tutto</option>
                        <option value="motivato">Motivato - voglio cambiare</option>
                        <option value="incerto">Incerto - non so da dove iniziare</option>
                        <option value="demotivato">Demotivato - fatico a reagire</option>
                    </select>
                </div>
                
                <button type="button" class="btn btn-success" id="completePhase1Btn" onclick="completePhase1()" disabled>
                    ✅ Completa Test e Passa alla Fase 2
                </button>
            </form>
        </section>

        <!-- Phase 2: AI Deep Dive -->
        <section class="phase2-section" id="phase2Section">
            <div class="phase-header">
                <div class="phase-icon">🤖</div>
                <div>
                    <h2 class="phase-title">Fase 2: Approfondimento con Andrea AI</h2>
                    <p class="phase-subtitle">Ora approfondiamo insieme la tua storia e i tuoi obiettivi</p>
                </div>
            </div>
            
            <div class="time-warning" id="timeWarning">
                <strong>⏰ Abbiamo raggiunto i 30 minuti!</strong> Vuoi continuare per altri 10 minuti o preferisci terminare ora?
                <div style="margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="continueSession()">Continua</button>
                    <button class="btn btn-primary" onclick="endSession()">Termina Ora</button>
                </div>
            </div>
            
            <div class="chat-status">
                <div class="status-dot"></div>
                <span>Andrea è online e pronto ad approfondire con te</span>
            </div>
            
            <div class="chat-container" id="chatContainer">
                <div class="message coach">
                    <div class="message-content">
                        Perfetto! Ho letto le tue risposte e sono molto interessanti. Ora voglio approfondire alcuni aspetti per conoscerti meglio e aiutarti al meglio. Iniziamo dalla tua situazione attuale: quando hai capito che era il momento di cambiare qualcosa? 🤔
                    </div>
                    <div class="message-time">Proprio ora</div>
                </div>
            </div>
            
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="Scrivi la tua risposta ad Andrea...">
                <button class="btn btn-primary" onclick="sendChatMessage()">Invia</button>
            </div>
        </section>

        <!-- Completion Section -->
        <section class="completion-section" id="completionSection">
            <h2 class="completion-title">🎉 Sessione Completata!</h2>
            <p class="completion-message">
                Fantastico! Abbiamo raccolto tutte le informazioni necessarie per personalizzare il tuo percorso. 
                Ecco i tuoi compiti personalizzati per questa settimana.
            </p>
            
            <div class="homework-section">
                <h3 class="homework-title">📚 I Tuoi Compiti Personalizzati</h3>
                <ul class="homework-list" id="personalizedHomework">
                    <li>✅ Rifletti sulla tua storia e sui momenti chiave che abbiamo discusso</li>
                    <li>✅ Dedica 10 minuti al giorno alla riflessione sui tuoi obiettivi</li>
                    <li>✅ Osserva i tuoi pattern quotidiani</li>
                    <li>✅ Pratica una piccola azione verso il tuo obiettivo principale</li>
                </ul>
            </div>
            
            <div class="completion-actions">
                <button class="btn btn-success" onclick="downloadPersonalizedHomework()">📄 Scarica Compiti Personalizzati</button>
                <a href="module-hub.html" class="btn btn-secondary">← Torna ai Moduli</a>
                <button class="btn btn-primary" onclick="scheduleNextSession()">📅 Programma Settimana 2</button>
            </div>
        </section>
    </main>

    <!-- Load Andrea AI Coach System -->
    <script src="../andrea-ai-coach.js"></script>
    
    <script>
        // Session variables
        let sessionStartTime = Date.now();
        let sessionDuration = 40 * 60 * 1000; // 40 minutes
        let timerInterval;
        let currentPhase = 'welcome';
        let phase1Data = {};
        let chatHistory = [];
        let andreaAICoach = null;
        let userProfile = null;
        let sessionExtended = false;
        let autoSaveInterval;

        // Initialize session
        document.addEventListener('DOMContentLoaded', function() {
            startSessionTimer();
            loadUserProfile();
            loadSavedSession();
            initializeAndreaAI();
            startAutoSave();
        });

        function startSessionTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - sessionStartTime;
                const remaining = Math.max(0, sessionDuration - elapsed);
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                
                document.getElementById('sessionTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const progress = (elapsed / sessionDuration) * 100;
                document.getElementById('sessionProgress').style.width = `${Math.min(progress, 100)}%`;
                
                // Check for 30 minute warning
                if (elapsed >= 30 * 60 * 1000 && !sessionExtended && currentPhase === 'phase2') {
                    show30MinuteWarning();
                }
                
                // Auto-end at 40 minutes
                if (remaining === 0) {
                    clearInterval(timerInterval);
                    endSession();
                }
            }, 1000);
        }

        function loadUserProfile() {
            try {
                const savedData = localStorage.getItem('lifestyleQuizResults');
                if (savedData) {
                    userProfile = JSON.parse(savedData);
                    console.log('✅ User profile loaded:', userProfile);
                }
            } catch (error) {
                console.error('❌ Error loading user profile:', error);
            }
        }

        function loadSavedSession() {
            try {
                const savedSession = localStorage.getItem('week1SessionInProgress');
                if (savedSession) {
                    const sessionData = JSON.parse(savedSession);
                    
                    // Restore phase 1 data
                    if (sessionData.phase1Data) {
                        phase1Data = sessionData.phase1Data;
                        Object.entries(phase1Data).forEach(([key, value]) => {
                            const element = document.getElementById(key);
                            if (element) {
                                element.value = value;
                            }
                        });
                    }
                    
                    // Restore chat history
                    if (sessionData.chatHistory) {
                        chatHistory = sessionData.chatHistory;
                    }
                    
                    // Restore current phase
                    if (sessionData.currentPhase) {
                        currentPhase = sessionData.currentPhase;
                        
                        // Show the correct phase
                        if (currentPhase === 'phase1') {
                            startPhase1();
                        } else if (currentPhase === 'phase2') {
                            startPhase2();
                            restoreChatHistory();
                        }
                    }
                    
                    console.log('✅ Session restored from:', sessionData);
                }
            } catch (error) {
                console.error('❌ Error loading saved session:', error);
            }
        }

        async function initializeAndreaAI() {
            try {
                if (window.AndreaAICoach) {
                    andreaAICoach = new window.AndreaAICoach();
                    
                    const userId = localStorage.getItem('lifestyleUserId') || 'user_' + Date.now();
                    localStorage.setItem('lifestyleUserId', userId);
                    
                    await andreaAICoach.initialize(userId, userProfile || {});
                    
                    console.log('🤖 Andrea AI Coach initialized successfully');
                } else {
                    console.error('❌ Andrea AI Coach not available');
                }
            } catch (error) {
                console.error('❌ Error initializing Andrea AI:', error);
            }
        }

        function startAutoSave() {
            autoSaveInterval = setInterval(() => {
                autoSave();
            }, 5000); // Auto-save every 5 seconds
        }

        function autoSave() {
            try {
                const sessionData = {
                    currentPhase: currentPhase,
                    phase1Data: phase1Data,
                    chatHistory: chatHistory,
                    sessionStartTime: sessionStartTime,
                    lastSaved: new Date().toISOString()
                };
                
                localStorage.setItem('week1SessionInProgress', JSON.stringify(sessionData));
                
                // Visual feedback
                const saveIndicator = document.getElementById('saveIndicator');
                if (saveIndicator) {
                    saveIndicator.style.opacity = '1';
                    setTimeout(() => {
                        saveIndicator.style.opacity = '0';
                    }, 1000);
                }
            } catch (error) {
                console.error('❌ Error auto-saving:', error);
            }
        }

        function startPhase1() {
            currentPhase = 'phase1';
            
            // Hide welcome, show phase 1
            document.getElementById('welcomeSection').style.display = 'none';
            document.getElementById('phase1Section').classList.add('active');
            
            // Update phase indicator
            document.getElementById('phaseStep1').className = 'phase-step active';
            document.getElementById('phaseStep2').className = 'phase-step inactive';
            
            updatePhase1Progress();
            autoSave();
        }

        function updatePhase1Progress() {
            const form = document.getElementById('phase1Form');
            const inputs = form.querySelectorAll('input, textarea, select');
            
            let filled = 0;
            inputs.forEach(input => {
                if (input.value.trim()) {
                    filled++;
                    phase1Data[input.id] = input.value.trim();
                }
            });
            
            const progress = (filled / inputs.length) * 100;
            document.getElementById('phase1Progress').textContent = `${Math.round(progress)}%`;
            document.getElementById('phase1ProgressFill').style.width = `${progress}%`;
            
            // Enable/disable complete button
            const completeBtn = document.getElementById('completePhase1Btn');
            if (progress === 100) {
                completeBtn.disabled = false;
                completeBtn.className = 'btn btn-success';
            } else {
                completeBtn.disabled = true;
                completeBtn.className = 'btn btn-disabled';
            }
        }

        function completePhase1() {
            // Mark phase 1 as completed
            document.getElementById('phaseStep1').className = 'phase-step completed';
            
            // Start phase 2
            startPhase2();
        }

        function startPhase2() {
            currentPhase = 'phase2';
            
            // Hide phase 1, show phase 2
            document.getElementById('phase1Section').classList.remove('active');
            document.getElementById('phase2Section').classList.add('active');
            
            // Update phase indicator
            document.getElementById('phaseStep2').className = 'phase-step active';
            
            // Generate first AI question based on phase 1 data
            generateFirstAIQuestion();
            
            autoSave();
        }

        function generateFirstAIQuestion() {
            if (chatHistory.length === 0) {
                // Generate personalized first question based on phase 1 data
                let firstQuestion = `Perfetto! Ho letto le tue risposte e sono molto interessanti. `;
                
                if (phase1Data.currentSituation) {
                    firstQuestion += `Vedo che ti descrivi come "${phase1Data.currentSituation}". `;
                }
                
                if (phase1Data.mainChallenge) {
                    firstQuestion += `La tua sfida principale è "${phase1Data.mainChallenge}". `;
                }
                
                firstQuestion += `Dimmi, quando hai capito per la prima volta che era il momento di cambiare qualcosa nella tua vita? C'è stato un momento specifico o è stata una realizzazione graduale? 🤔`;
                
                // Add first AI message
                addChatMessage(firstQuestion, 'coach');
            } else {
                // Restore existing chat if resuming
                restoreChatHistory();
            }
        }

        function restoreChatHistory() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '';
            
            chatHistory.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.sender}`;
                messageDiv.innerHTML = `
                    <div class="message-content">${message.content}</div>
                    <div class="message-time">${message.time}</div>
                `;
                chatContainer.appendChild(messageDiv);
            });
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addChatMessage(message, 'user');
            input.value = '';
            
            // Get AI response
            try {
                const aiResponse = await getAIResponse(message);
                setTimeout(() => {
                    addChatMessage(aiResponse, 'coach');
                }, 1000);
            } catch (error) {
                console.error('❌ Error getting AI response:', error);
                setTimeout(() => {
                    addChatMessage("Scusa, ho avuto un problema tecnico. Puoi ripetere?", 'coach');
                }, 1000);
            }
        }

        function addChatMessage(content, sender) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const now = new Date();
            const time = now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-content">${content}</div>
                <div class="message-time">${time}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Store in history
            chatHistory.push({ sender, content, time });
            autoSave();
        }

        async function getAIResponse(userMessage) {
            // Build context with phase 1 data and chat history
            const context = {
                phase1Data: phase1Data,
                chatHistory: chatHistory,
                userProfile: userProfile
            };
            
            // Try Andrea AI first
            if (andreaAICoach) {
                try {
                    const response = await andreaAICoach.sendMessage(userMessage, 1);
                    if (response.success) {
                        return response.response;
                    }
                } catch (error) {
                    console.error('❌ Andrea AI error:', error);
                }
            }
            
            // Fallback to contextual response
            return generateContextualResponse(userMessage, context);
        }

        function generateContextualResponse(userMessage, context) {
            // Intelligent responses based on context
            const responses = [
                "Interessante! Capisco perfettamente. Quando ho iniziato il mio percorso di cambiamento, anch'io mi sono sentito così. Dimmi, cosa pensi che ti abbia trattenuto finora dal fare questo passo?",
                "Ti capisco benissimo. La tua situazione mi ricorda molto la mia esperienza passata. Secondo te, qual è stata la goccia che ha fatto traboccare il vaso?",
                "Perfetto, stiamo andando nella direzione giusta. Quello che mi dici è molto importante. Come ti immagini la tua vita tra un anno se riuscissimo a superare insieme questa sfida?",
                "Molto bene! Vedo che stai riflettendo profondamente. Questo è esattamente quello che serve. Parlami del tuo supporto: hai persone intorno a te che credono in questo cambiamento?",
                "Ottimo insight! La consapevolezza è il primo passo. Ora dimmi, se dovessi scegliere una sola cosa da cambiare per prima, quale sarebbe e perché?"
            ];
            
            // Simple keyword-based personalization
            const lowerMessage = userMessage.toLowerCase();
            
            if (lowerMessage.includes('stress') || lowerMessage.includes('pressione')) {
                return `Ti capisco perfettamente! Lo stress è stato il mio compagno per 12 anni. Ho scoperto che spesso nasce dal tentativo di controllare tutto. Quando senti di più questa pressione durante la giornata?`;
            }
            
            if (lowerMessage.includes('lavoro') || lowerMessage.includes('ufficio')) {
                return `Ah, il lavoro... quanto ti capisco! Anch'io ho vissuto anni di stress lavorativo. La buona notizia è che si può trovare un equilibrio. Cosa ti piacerebbe che fosse diverso nel tuo rapporto con il lavoro?`;
            }
            
            if (lowerMessage.includes('famiglia') || lowerMessage.includes('figli')) {
                return `La famiglia è fondamentale, ma può anche essere fonte di stress. Ho imparato che prendersi cura di sé è il miglior regalo per i nostri cari. Come vorresti gestire meglio questo equilibrio?`;
            }
            
            if (lowerMessage.includes('tempo') || lowerMessage.includes('mai tempo')) {
                return `La gestione del tempo è una sfida comune! Anch'io mi sentivo sempre in corsa. Dimmi, se potessi recuperare 2 ore al giorno, cosa faresti con quel tempo?`;
            }
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function show30MinuteWarning() {
            document.getElementById('timeWarning').classList.add('active');
        }

        function continueSession() {
            sessionExtended = true;
            document.getElementById('timeWarning').classList.remove('active');
            showMessage('✅ Sessione estesa di 10 minuti. Continuiamo!', 'success');
        }

        function endSession() {
            clearInterval(timerInterval);
            clearInterval(autoSaveInterval);
            completeSession();
        }

        function completeSession() {
            // Save final session data
            const finalSessionData = {
                phase1Data: phase1Data,
                chatHistory: chatHistory,
                completedAt: new Date().toISOString(),
                sessionDuration: Date.now() - sessionStartTime,
                userProfile: userProfile
            };
            
            localStorage.setItem('week1SessionCompleted', JSON.stringify(finalSessionData));
            localStorage.removeItem('week1SessionInProgress');
            
            // Update progress
            updateUserProgress();
            
            // Show completion
            document.getElementById('phase2Section').classList.remove('active');
            document.getElementById('completionSection').classList.add('active');
            
            // Generate personalized homework
            generatePersonalizedHomework();
            
            document.getElementById('completionSection').scrollIntoView({ behavior: 'smooth' });
        }

        function generatePersonalizedHomework() {
            const homeworkList = document.getElementById('personalizedHomework');
            let homework = [];
            
            // Base homework
            homework.push("✅ Rifletti sulla tua storia e sui momenti chiave che abbiamo discusso");
            homework.push("✅ Dedica 10 minuti al giorno alla riflessione sui tuoi obiettivi");
            
            // Personalized based on phase 1 data
            if (phase1Data.mainChallenge) {
                homework.push(`✅ Osserva quando si manifesta di più "${phase1Data.mainChallenge}" durante la giornata`);
            }
            
            if (phase1Data.mainGoal) {
                homework.push(`✅ Fai una piccola azione quotidiana verso "${phase1Data.mainGoal}"`);
            }
            
            if (phase1Data.motivationLevel === 'demotivato') {
                homework.push("✅ Identifica 3 cose che ti danno energia e praticane una ogni giorno");
            }
            
            // Update homework list
            homeworkList.innerHTML = homework.map(item => `<li>${item}</li>`).join('');
        }

        function updateUserProgress() {
            try {
                const progress = JSON.parse(localStorage.getItem('lifestyleProgress') || '{}');
                progress.completedWeeks = progress.completedWeeks || [];
                
                if (!progress.completedWeeks.includes(1)) {
                    progress.completedWeeks.push(1);
                    progress.currentWeek = 2;
                    progress.lastUpdate = new Date().toISOString();
                    
                    localStorage.setItem('lifestyleProgress', JSON.stringify(progress));
                }
            } catch (error) {
                console.error('❌ Error updating progress:', error);
            }
        }

        function downloadPersonalizedHomework() {
            const homeworkContent = `
                COMPITI PERSONALIZZATI SETTIMANA 1
                
                Andrea Padoan - Lifestyle Coach
                
                Ciao ${userProfile?.name || 'Amico/a'}!
                
                Ecco i tuoi compiti personalizzati basati sulla nostra sessione:
                
                1. RIFLESSIONE QUOTIDIANA (10 minuti)
                   - Rifletti sui momenti chiave della nostra conversazione
                   - Cosa hai scoperto di nuovo su te stesso?
                   
                2. OBIETTIVO PRINCIPALE
                   - Fai una piccola azione quotidiana verso: "${phase1Data.mainGoal || 'il tuo obiettivo'}"
                   - Anche 5 minuti al giorno fanno la differenza
                   
                3. SFIDA PRINCIPALE
                   - Osserva quando si manifesta: "${phase1Data.mainChallenge || 'la tua sfida'}"
                   - Nota i pattern e i trigger
                   
                4. SITUAZIONE ATTUALE
                   - Rifletti su come descriveresti oggi la tua situazione
                   - Confronta con: "${phase1Data.currentSituation || 'la tua situazione attuale'}"
                   
                5. ENERGIA E MOTIVAZIONE
                   - Identifica 3 momenti/attività che ti danno energia
                   - Praticane almeno una ogni giorno
                
                La settimana 2 si sbloccherà tra 7 giorni.
                Usa questo tempo per mettere in pratica quello che abbiamo scoperto!
                
                Un abbraccio,
                Andrea 🚀
            `;
            
            const blob = new Blob([homeworkContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Compiti_Personalizzati_Settimana_1_${userProfile?.name || 'Utente'}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            showMessage('📄 Compiti personalizzati scaricati!', 'success');
        }

        function scheduleNextSession() {
            const nextWeekDate = new Date();
            nextWeekDate.setDate(nextWeekDate.getDate() + 7);
            
            const message = `📅 Settimana 2 disponibile il ${nextWeekDate.toLocaleDateString('it-IT')}!`;
            showMessage(message, 'info');
            
            localStorage.setItem('nextSessionReminder', nextWeekDate.toISOString());
        }

        function showMessage(message, type = 'info') {
            const colors = {
                success: '#16a34a',
                warning: '#f59e0b',
                info: '#3b82f6',
                error: '#ef4444'
            };
            
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: ${colors[type]}; color: white; padding: 1rem 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; max-width: 400px; animation: slideIn 0.3s ease-out;">
                    ${message}
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Handle Enter key in chat
        document.getElementById('chatInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            if (currentPhase !== 'completed') {
                autoSave();
            }
        });
    </script>
</body>
</html>