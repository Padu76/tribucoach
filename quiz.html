<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz TribuCoach - Analisi Completa del Profilo Fitness</title>
    <meta name="description" content="Quiz avanzato per analizzare il tuo profilo fitness completo e ricevere un piano personalizzato da TribuCoach">
    
    <style>
        /* Stili CSS esistenti */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
            color: #fff;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.8rem;
            background: linear-gradient(135deg, #ff6600, #ff9933);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
        }

        .header p {
            font-size: 1.1rem;
            color: #ccc;
        }

        .progress-bar-container {
            width: 100%;
            background-color: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 30px;
            height: 15px;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ff6600, #ff9933);
            border-radius: 10px;
            transition: width 0.4s ease-in-out;
        }

        .quiz-card {
            background-color: #1c1c1c;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden; /* Nasconde le domande fuori schermo */
            min-height: 500px; /* Altezza minima per contenere le domande */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .question-container {
            display: none; /* Inizialmente nascosto */
            animation: fadeIn 0.5s ease-out forwards;
            padding-bottom: 20px; /* Spazio per i bottoni */
        }

        .question-container.active {
            display: block; /* Mostra la domanda attiva */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-intro {
            background-color: #2a2a2a;
            padding: 15px 20px;
            border-left: 5px solid #ff6600;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .section-intro h3 {
            color: #ff6600;
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .section-intro p {
            font-size: 0.95rem;
            color: #ccc;
        }


        .question-title {
            color: #ff6600;
            font-size: 1.8rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .question-subtitle {
            font-size: 1rem;
            color: #bbb;
            margin-bottom: 25px;
            text-align: center;
        }

        /* Stili per input */
        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
            font-weight: bold;
        }

        .input-group input[type="text"],
        .input-group input[type="email"],
        .input-group input[type="number"],
        .input-group input[type="tel"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #444;
            border-radius: 8px;
            background-color: #333;
            color: #fff;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group input[type="text"]:focus,
        .input-group input[type="email"]:focus,
        .input-group input[type="number"]:focus,
        .input-group input[type="tel"]:focus {
            outline: none;
            border-color: #ff6600;
        }

        .input-group input::placeholder {
            color: #888;
        }

        /* Stili per radio buttons (selezione singola) */
        .option-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .option-item {
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 10px;
            padding: 15px 20px;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            display: flex;
            align-items: center;
        }

        .option-item:hover {
            background-color: #3a3a3a;
            border-color: #ff6600;
        }

        .option-item.selected {
            background-color: #ff6600;
            border-color: #ff6600;
            color: #fff;
        }

        .option-item input[type="radio"] {
            display: none; /* Nasconde l'input radio nativo */
        }

        .option-item label {
            cursor: pointer;
            font-size: 1.05rem;
            font-weight: normal; /* Override default label bold */
            margin-bottom: 0; /* Override input-group label margin */
            flex-grow: 1;
            display: flex;
            align-items: center;
        }

        .option-item label::before {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #ccc;
            margin-right: 12px;
            background-color: #333;
            transition: all 0.3s ease;
        }

        .option-item.selected label::before {
            background-color: #fff;
            border-color: #fff;
            box-shadow: 0 0 0 4px #ff6600;
        }

        /* Stili per checkboxes (selezione multipla) */
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .checkbox-item {
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 10px;
            padding: 15px 20px;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            display: flex;
            align-items: center;
        }

        .checkbox-item:hover {
            background-color: #3a3a3a;
            border-color: #ff6600;
        }

        .checkbox-item input[type="checkbox"] {
            display: none;
        }

        .checkbox-item label {
            cursor: pointer;
            font-size: 1.05rem;
            font-weight: normal;
            margin-bottom: 0;
            flex-grow: 1;
            display: flex;
            align-items: center;
        }

        .checkbox-item label::before {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid #ccc;
            margin-right: 12px;
            background-color: #333;
            transition: all 0.3s ease;
        }

        .checkbox-item input[type="checkbox"]:checked + label::before {
            background-color: #ff6600;
            border-color: #ff6600;
            content: '‚úì'; /* Segno di spunta */
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 14px;
            font-weight: bold;
        }

        .checkbox-item input[type="checkbox"]:checked + label {
            color: #ff6600;
        }


        /* Navigazione */
        .quiz-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
        }

        .nav-btn {
            background-color: #ff6600;
            color: #fff;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
            flex-grow: 1;
            text-align: center;
            text-decoration: none;
        }

        .nav-btn:hover {
            background-color: #e65c00;
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
            transform: none;
        }

        .nav-btn.secondary {
            background-color: #3a3a3a;
        }

        .nav-btn.secondary:hover:not(:disabled) {
            background-color: #4a4a4a;
        }

        /* Result container */
        .result-container {
            text-align: center;
            padding: 30px;
            background-color: #1c1c1c;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        }

        .result-container h2 {
            color: #ff6600;
            font-size: 2.5rem;
            margin-bottom: 20px;
        }

        .result-profile {
            font-size: 1.8rem;
            color: #fff;
            margin-bottom: 15px;
        }

        .result-description {
            font-size: 1.1rem;
            color: #ccc;
            margin-bottom: 30px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .result-recommendations {
            text-align: left;
            margin-top: 30px;
            margin-bottom: 40px;
            background-color: #2a2a2a;
            padding: 25px;
            border-radius: 10px;
        }

        .result-recommendations h3 {
            color: #ff9933;
            font-size: 1.5rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .result-recommendations ul {
            list-style: none;
            padding: 0;
        }

        .result-recommendations ul li {
            background-color: #3a3a3a;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            font-size: 1rem;
            color: #eee;
        }

        .result-recommendations ul li::before {
            content: '‚úÖ'; /* Icona a sinistra */
            margin-right: 10px;
            color: #ff6600;
            font-size: 1.2em;
        }

        .cta-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .cta-primary, .cta-secondary {
            display: block;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            text-decoration: none;
            transition: transform 0.2s ease;
        }

        .cta-primary {
            background-color: #ff6600;
            color: #fff;
        }

        .cta-primary:hover {
            transform: translateY(-3px);
            background-color: #e65c00;
        }

        .cta-secondary {
            background-color: #333;
            color: #ff6600;
            border: 2px solid #ff6600;
        }

        .cta-secondary:hover {
            transform: translateY(-3px);
            background-color: #ff6600;
            color: #fff;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            color: #ff6600;
            font-size: 1.5rem;
            display: none; /* Inizialmente nascosto */
        }

        .loading-screen.active {
            display: flex;
        }

        .spinner {
            border: 6px solid rgba(255, 255, 255, 0.3);
            border-top: 6px solid #ff6600;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: red;
            background-color: rgba(255, 0, 0, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .error-message.active {
            display: block;
        }


        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .quiz-card {
                padding: 20px;
            }

            .nav-btn {
                padding: 10px 15px;
                font-size: 1rem;
            }

            .cta-primary, .cta-secondary {
                font-size: 1rem;
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loading-screen">
        <div class="spinner"></div>
        <p>Analizzando il tuo profilo...</p>
        <div class="error-message" id="error-message"></div>
    </div>

    <div class="container">
        <header class="header">
            <h1>üî• TribuCoach Quiz</h1>
            <p>Scopri il tuo profilo fitness unico e ricevi un piano personalizzato!</p>
        </header>

        <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>

        <div class="quiz-card" id="quiz-card">
            <div class="question-container active" id="question-1">
                <div class="section-intro">
                    <h3>üëã Sezione 1: Chi Sei?</h3>
                    <p>Iniziamo a conoscerti meglio per personalizzare al massimo il tuo percorso.</p>
                </div>
                <h2 class="question-title">Le tue informazioni di base</h2>
                <p class="question-subtitle">Questi dati ci aiuteranno a creare un profilo su misura.</p>
                <div class="input-group">
                    <label for="name">Nome completo:</label>
                    <input type="text" id="name" placeholder="Come ti chiami?" required>
                </div>
                <div class="input-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" placeholder="La tua email per ricevere il piano personalizzato" required>
                </div>
                <div class="input-group">
                    <label for="phone">Numero di Telefono (WhatsApp):</label>
                    <input type="tel" id="phone" placeholder="Il tuo numero WhatsApp per un contatto veloce (opzionale)">
                </div>
                <div class="input-group">
                    <label for="age">Et√†:</label>
                    <input type="number" id="age" min="16" max="80" placeholder="Quanti anni hai?" required>
                </div>
                <div class="input-group">
                    <label for="city">Citt√†:</label>
                    <input type="text" id="city" placeholder="Dove vivi? (es. Verona, Milano...)">
                </div>
            </div>

            <div class="question-container" id="question-2">
                <div class="section-intro">
                    <h3>üöÄ Sezione 2: La Tua Esperienza</h3>
                    <p>Raccontaci il tuo percorso nel mondo del fitness per capire da dove partire.</p>
                </div>
                <h2 class="question-title">Qual √® la tua esperienza attuale nel fitness?</h2>
                <p class="question-subtitle">Seleziona l'opzione che meglio ti descrive.</p>
                <div class="option-group">
                    <div class="option-item">
                        <input type="radio" id="exp-beginner" name="experience" value="principiante">
                        <label for="exp-beginner">Sono un principiante (meno di 6 mesi di attivit√†)</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" id="exp-intermediate" name="experience" value="intermedio">
                        <label for="exp-intermediate">Ho esperienza intermedia (6 mesi - 2 anni)</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" id="exp-advanced" name="experience" value="avanzato">
                        <label for="exp-advanced">Sono avanzato (pi√π di 2 anni di allenamento costante)</label>
                    </div>
                </div>
            </div>

            <div class="question-container" id="question-3">
                <div class="section-intro">
                    <h3>üéØ Sezione 3: I Tuoi Obiettivi</h3>
                    <p>Quali risultati vuoi raggiungere? Sii specifico per un piano mirato!</p>
                </div>
                <h2 class="question-title">Quali sono i tuoi 3 obiettivi principali?</h2>
                <p class="question-subtitle">Seleziona massimo 3 opzioni.</p>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="goal-massa" value="aumento_massa_muscolare">
                        <label for="goal-massa">üí™ Aumento massa muscolare</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="goal-peso" value="perdita_peso_grasso">
                        <label for="goal-peso">‚öñÔ∏è Perdita di peso e massa grassa</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="goal-forza" value="aumento_forza">
                        <label for="goal-forza">üèãÔ∏è‚Äç‚ôÄÔ∏è Aumento della forza</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="goal-tonificazione" value="tonificazione_generale">
                        <label for="goal-tonificazione">üßò‚Äç‚ôÄÔ∏è Tonificazione generale</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="goal-resistenza" value="miglioramento_resistenza">
                        <label for="goal-resistenza">üèÉ‚Äç‚ôÇÔ∏è Miglioramento resistenza</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="goal-salute" value="benessere_salute">
                        <label for="goal-salute">üçè Benessere e salute generale</label>
                    </div>
                </div>
            </div>

            <div class="question-container" id="question-4">
                <div class="section-intro">
                    <h3>üóìÔ∏è Sezione 4: Il Tuo Impegno</h3>
                    <p>Quante volte alla settimana sei disposto ad allenarti?</p>
                </div>
                <h2 class="question-title">Quanti giorni a settimana ti alleni o vorresti allenarti?</h2>
                <p class="question-subtitle">Sii realistico per un piano sostenibile.</p>
                <div class="option-group">
                    <div class="option-item">
                        <input type="radio" id="freq-1-2" name="frequency" value="1-2">
                        <label for="freq-1-2">1-2 giorni</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" id="freq-3-4" name="frequency" value="3-4">
                        <label for="freq-3-4">3-4 giorni</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" id="freq-5-6" name="frequency" value="5-6">
                        <label for="freq-5-6">5-6 giorni</label>
                    </div>
                </div>
            </div>

            <div class="question-container" id="question-5">
                <div class="section-intro">
                    <h3>üèãÔ∏è‚Äç‚ôÄÔ∏è Sezione 5: Le Tue Preferenze</h3>
                    <p>Qual √® il tuo ambiente di allenamento ideale?</p>
                </div>
                <h2 class="question-title">Dove preferisci allenarti principalmente?</h2>
                <p class="question-subtitle">Questo ci aiuter√† a creare un piano adatto alle tue risorse.</p>
                <div class="option-group">
                    <div class="option-item">
                        <input type="radio" id="place-gym" name="place" value="palestra">
                        <label for="place-gym">In palestra con attrezzi</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" id="place-home" name="place" value="casa">
                        <label for="place-home">A casa con poca attrezzatura</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" id="place-outdoor" name="place" value="all_aperto">
                        <label for="place-outdoor">All'aperto (corsa, corpo libero, ecc.)</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" id="place-mixed" name="place" value="misto">
                        <label for="place-mixed">Misto (palestra + casa/all'aperto)</label>
                    </div>
                </div>
            </div>

            <div class="question-container" id="result-container">
                <div class="section-intro">
                    <h3>üéâ Quiz Completato!</h3>
                    <p>Grazie per aver dedicato il tuo tempo. Ecco il tuo profilo personalizzato.</p>
                </div>
                <h2 class="question-title">Il Tuo Profilo TribuCoach</h2>
                <p class="result-profile" id="result-profile"></p>
                <p class="result-description" id="result-description"></p>
                
                <div class="result-recommendations">
                    <h3>Consigli Personalizzati per Te:</h3>
                    <ul>
                        </ul>
                </div>

                <div class="cta-buttons">
                    <a href="#" id="cta-personal-plan" class="cta-primary">Ricevi il tuo piano personalizzato!</a>
                    </div>
            </div>

            <div class="quiz-navigation">
                <button id="prevBtn" class="nav-btn secondary">Indietro</button>
                <button id="nextBtn" class="nav-btn">Avanti</button>
                <button id="submitBtn" class="nav-btn" style="display: none;">Vedi il tuo profilo</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { saveQuizResult, calculateLeadScore, getProfileIcon, logEvent } from './firebase-functions.js';
        import { analytics } from './firebase.js'; // Importa analytics

        let currentQuestion = 1;
        const totalQuestions = 5; // Ho rimosso il risultato dal conteggio delle domande per la barra di progresso
        const questionsContainer = document.getElementById('quiz-card');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        const progressBar = document.getElementById('progress-bar');
        const loadingScreen = document.getElementById('loading-screen');
        const errorMessage = document.getElementById('error-message');

        const questionMap = {
            1: 'question-1',
            2: 'question-2',
            3: 'question-3',
            4: 'question-4',
            5: 'question-5',
            6: 'result-container' // L'ultima "domanda" √® il risultato
        };

        function showQuestion(questionNumber) {
            document.querySelectorAll('.question-container').forEach(q => {
                q.classList.remove('active');
            });
            document.getElementById(questionMap[questionNumber]).classList.add('active');
            currentQuestion = questionNumber;
            updateProgress();
            updateNavigation();
            validateCurrentQuestion();
        }

        function updateProgress() {
            // La barra di progresso si basa sul numero di domande reali, non sul risultato finale.
            const progress = (currentQuestion - 1) / totalQuestions * 100;
            progressBar.style.width = `${progress}%`;
        }

        function updateNavigation() {
            prevBtn.style.display = currentQuestion === 1 ? 'none' : 'block';
            nextBtn.style.display = currentQuestion >= totalQuestions ? 'none' : 'block';
            submitBtn.style.display = currentQuestion === totalQuestions ? 'block' : 'none';
        }

        function validateCurrentQuestion() {
            let isValid = false;
            const currentQuestionElement = document.getElementById(questionMap[currentQuestion]);

            if (!currentQuestionElement) return false;

            if (currentQuestion === 1) { // Dati personali
                const name = document.getElementById('name').value;
                const email = document.getElementById('email').value;
                const ageInput = document.getElementById('age').value; // Ottieni come stringa
                const age = parseInt(ageInput); // Parsa a intero

                isValid = name.length > 0 && 
                          email.length > 0 && 
                          email.includes('@') && // Verifica formato email
                          ageInput.length > 0 && // Verifica che l'input non sia vuoto
                          !isNaN(age) && // Verifica che l'et√† sia un numero valido
                          age >= 16 && age <= 80; // Verifica il range dell'et√†
            } else if (currentQuestion === 2) { // Esperienza Fitness
                isValid = document.querySelector('input[name="experience"]:checked') !== null;
            } else if (currentQuestion === 3) { // Obiettivi Principali
                const checkedGoals = document.querySelectorAll('#question-3 input[type="checkbox"]:checked').length;
                isValid = checkedGoals > 0;
            } else if (currentQuestion === 4) { // Frequenza Allenamento
                isValid = document.querySelector('input[name="frequency"]:checked') !== null;
            } else if (currentQuestion === 5) { // Tipo di Allenamento Preferito
                isValid = document.querySelector('input[name="place"]:checked') !== null;
            } else if (currentQuestion === 6) { // Risultato (non ha validazione diretta)
                isValid = true;
            }

            nextBtn.disabled = !isValid;
            submitBtn.disabled = !isValid;
            return isValid;
        }


        function collectQuizData() {
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value; // Nuovo campo telefono
            const age = document.getElementById('age').value;
            const city = document.getElementById('city').value;
            
            const experience = document.querySelector('input[name="experience"]:checked')?.value;
            
            const goals = Array.from(document.querySelectorAll('#question-3 input[type="checkbox"]:checked'))
                               .map(cb => cb.value);
            
            const frequency = document.querySelector('input[name="frequency"]:checked')?.value;
            const place = document.querySelector('input[name="place"]:checked')?.value;

            return {
                name,
                email,
                phone, // Aggiunto il telefono qui
                age: parseInt(age),
                city,
                experience,
                goals,
                frequency,
                place
            };
        }

        async function submitQuiz() {
            if (!validateCurrentQuestion()) {
                alert('Per favore, completa tutti i campi richiesti prima di procedere.');
                return;
            }

            loadingScreen.classList.add('active');
            errorMessage.classList.remove('active');
            errorMessage.textContent = '';

            const quizData = collectQuizData();
            const lead_score = calculateLeadScore(quizData);
            quizData.lead_score = lead_score;

            // Determina il profilo in base al punteggio e all'esperienza
            let profileType = '';
            if (quizData.experience === 'avanzato' && lead_score >= 80) {
                profileType = 'Atleta';
            } else if (quizData.experience === 'intermedio' && lead_score >= 60) {
                profileType = 'Guerriero';
            } else {
                profileType = 'Nuovo Esploratore';
            }
            quizData.profile = profileType;

            try {
                await saveQuizResult(quizData);
                console.log('Quiz saved successfully!');
                displayResult(quizData, lead_score, profileType);
                showQuestion(totalQuestions + 1); // Mostra la schermata dei risultati
                loadingScreen.classList.remove('active');
            } catch (error) {
                console.error('Error submitting quiz:', error);
                errorMessage.textContent = 'Si √® verificato un errore durante il salvataggio dei tuoi dati. Riprova pi√π tardi.';
                errorMessage.classList.add('active');
                loadingScreen.classList.remove('active');
            }
        }

        function displayResult(quizData, lead_score, profileType) {
            document.getElementById('result-profile').innerHTML = `${getProfileIcon(profileType)} Sei un ${profileType}!`;
            
            let profileDescription = '';
            let recommendationsList = [];

            switch (profileType) {
                case 'Atleta':
                    profileDescription = 'Sei un vero Atleta! La tua dedizione e conoscenza ti hanno portato a un livello superiore. Ti offro strategie avanzate per superare i tuoi limiti e perfezionare le tue performance.';
                    recommendationsList = [
                        'Piani di allenamento specifici per massimizzare la performance.',
                        'Strategie nutrizionali avanzate per recupero e crescita muscolare.',
                        'Tecniche di mental coaching per la gestione della pressione competitiva.',
                    ];
                    break;
                case 'Guerriero':
                    profileDescription = 'Sei un Guerriero! Hai la forza e la determinazione per raggiungere grandi risultati. Ti aiuter√≤ a superare i plateau e a consolidare i tuoi progressi con piani mirati.';
                    recommendationsList = [
                        'Piani di allenamento per superare i tuoi limiti attuali.',
                        'Consigli nutrizionali per sostenere l\'aumento di massa o la definizione.',
                        'Strategie per mantenere alta la motivazione e la costanza.',
                    ];
                    break;
                case 'Nuovo Esploratore':
                    profileDescription = 'Sei un Nuovo Esploratore! Stai iniziando il tuo viaggio nel fitness con entusiasmo. Ti guider√≤ passo dopo passo, fornendoti le basi solide per costruire abitudini durature.';
                    recommendationsList = [
                        'Programmi di allenamento fondamentali per costruire forza e resistenza.',
                        'Guida passo-passo alla nutrizione per principianti.',
                        'Strategie per l\'integrazione dell\'attivit√† fisica nella vita quotidiana.',
                    ];
                    break;
            }

            document.getElementById('result-description').textContent = profileDescription;
            const recommendationsUl = document.querySelector('.result-recommendations ul');
            recommendationsUl.innerHTML = ''; // Pulisci raccomandazioni precedenti
            recommendationsList.forEach(rec => {
                const li = document.createElement('li');
                li.textContent = rec;
                recommendationsUl.appendChild(li);
            });
        }


        // Event Listeners
        nextBtn.addEventListener('click', () => {
            if (validateCurrentQuestion()) {
                showQuestion(currentQuestion + 1);
            } else {
                alert('Per favore, completa tutti i campi richiesti prima di procedere.');
            }
        });

        prevBtn.addEventListener('click', () => {
            if (currentQuestion > 1) {
                showQuestion(currentQuestion - 1);
            }
        });

        submitBtn.addEventListener('click', submitQuiz);


        // Setup listeners for input changes to enable/disable buttons
        document.querySelectorAll('.option-item').forEach(item => {
            item.addEventListener('click', function() {
                const radio = this.querySelector('input[type="radio"]');
                if (radio) {
                    radio.checked = true;
                    // Rimuovi 'selected' da tutti gli altri item dello stesso gruppo
                    this.closest('.option-group').querySelectorAll('.option-item').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    validateCurrentQuestion();
                }
            });
        });

        // Setup per input fields (name, email, age, city, phone)
        document.querySelectorAll('input[type="text"], input[type="email"], input[type="number"], input[type="tel"]').forEach(input => {
            input.addEventListener('input', validateCurrentQuestion);
        });
        
        // Setup per checkbox con limite (Obiettivi Principali)
        document.querySelectorAll('#question-3 input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const checked = document.querySelectorAll('#question-3 input[type="checkbox"]:checked');
                if (checked.length > 3) {
                    this.checked = false;
                    alert('Puoi selezionare massimo 3 obiettivi principali!');
                }
                // Toggle 'selected' class based on checked state
                this.parentNode.classList.toggle('selected', this.checked);
                validateCurrentQuestion();
            });
        });

        // Setup per altri checkbox (se ce ne saranno, ora non ce ne sono oltre agli obiettivi)
        document.querySelectorAll('input[type="checkbox"]:not(#question-3 input[type="checkbox"])').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                this.parentNode.classList.toggle('selected', this.checked);
                validateCurrentQuestion();
            });
        });

        // Inizializza al caricamento
        document.addEventListener('DOMContentLoaded', () => {
            updateProgress();
            updateNavigation();
            validateCurrentQuestion(); // Validare la prima domanda al caricamento
            logEvent(analytics, 'advanced_quiz_started');
        });

    </script>
</body>
</html>