<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz di Analisi Fitness - Scopri il Tuo Potenziale</title>
    <meta name="description" content="Quiz avanzato per analizzare il tuo profilo fitness completo e ricevere consigli personalizzati">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
            color: #fff;
            min-height: 100vh;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.8rem;
            background: linear-gradient(135deg, #ff6600, #ff9933);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
        }

        .header p {
            font-size: 1.1rem;
            color: #ccc;
        }

        .progress-bar-container {
            width: 100%;
            background-color: #333;
            border-radius: 10px;
            height: 10px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff6600, #ff9933);
            border-radius: 10px;
            transition: width 0.3s ease-in-out;
        }

        .question-box {
            background-color: #1a1a1a;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }

        .question-box h2 {
            font-size: 1.8rem;
            color: #ff6600;
            margin-bottom: 25px;
            text-align: center;
        }

        .answer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .answer-btn {
            background-color: #333;
            color: #fff;
            border: none;
            padding: 20px;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .answer-btn:hover {
            background-color: #ff6600;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 102, 0, 0.3);
        }

        .text-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #333;
            border-radius: 10px;
            background-color: #222;
            color: #fff;
            font-size: 1.1rem;
            margin: 10px 0;
        }

        .text-input:focus {
            outline: none;
            border-color: #ff6600;
            box-shadow: 0 0 0 3px rgba(255, 102, 0, 0.3);
        }

        .continue-btn {
            background-color: #ff6600;
            color: #fff;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .continue-btn:hover {
            background-color: #ff7711;
            transform: translateY(-2px);
        }

        .continue-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .result-container {
            text-align: center;
        }

        .result-container h2 {
            font-size: 2.5rem;
            color: #ff6600;
            margin-bottom: 20px;
        }

        .profile-card {
            background-color: #333;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        }

        .profile-card h3 {
            font-size: 1.8rem;
            color: #ff9933;
            margin-bottom: 15px;
        }

        .profile-card p {
            font-size: 1rem;
            color: #ccc;
            line-height: 1.8;
            text-align: left;
        }

        .recommendations {
            text-align: left;
            margin: 20px 0;
        }

        .recommendations ul {
            list-style: none;
            padding: 0;
        }

        .recommendations li {
            background-color: #3a3a3a;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            align-items: flex-start;
        }

        .recommendations li::before {
            content: '‚úÖ';
            margin-right: 10px;
            color: #ff6600;
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .cta-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .cta-btn {
            display: block;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            text-decoration: none;
            transition: transform 0.2s ease;
            text-align: center;
        }

        .cta-primary {
            background-color: #ff6600;
            color: #fff;
        }

        .cta-primary:hover {
            background-color: #ff7711;
            transform: translateY(-3px);
        }

        .cta-secondary {
            background-color: #555;
            color: #fff;
        }

        .cta-secondary:hover {
            background-color: #666;
            transform: translateY(-3px);
        }

        .checkbox-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .checkbox-option {
            background-color: #333;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            border: 2px solid transparent;
        }

        .checkbox-option:hover {
            background-color: #444;
            transform: translateY(-2px);
        }

        .checkbox-option.selected {
            background-color: #ff6600;
            border-color: #ff9933;
            transform: translateY(-2px);
        }

        .checkbox-option input {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Quiz di Analisi Fitness</h1>
            <p>Scopri il tuo potenziale e ricevi consigli personalizzati</p>
        </header>

        <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>

        <div id="quizContainer"></div>
    </div>

    <script type="module">
        // Importa le funzioni necessarie da firebase-functions.js
        import { saveQuizResult, calculateLeadScore as calculateLeadScoreFromFunctions, getProfileIcon } from './firebase-functions.js';

        // Non √® pi√π necessario importare Firebase qui, poich√© viene gestito da firebase.js e firebase-functions.js

        // Funzione per calcolare lead score - ora usa quella importata
        // function calculateLeadScore(data) {
        //     return data.score; // Il punteggio √® gi√† calcolato
        // } // RIMOSSO, usa calculateLeadScoreFromFunctions

        // Funzione per ottenere l'icona del profilo - ora usa quella importata
        // function getProfileIcon(profile) {
        //     switch(profile) {
        //         case 'Nuovo Esploratore': return 'üå±';
        //         case 'Guerriero': return '‚öîÔ∏è';
        //         case 'Atleta': return 'üèÜ';
        //         default: return 'üåü';
        //     }
        // } // RIMOSSO, usa getProfileIcon

        // Funzione per determinare il profilo basato sui campi del quiz
        function determineProfile(responses, totalScore) {
            // Logica migliorata che considera sia il punteggio che le risposte specifiche
            let profileScore = totalScore;

            // Aggiusta il punteggio basato su risposte specifiche
            if (responses.goals && responses.goals.includes('Preparazione atletica specifica')) {
                profileScore += 10;
            }

            if (responses.training_style === 'Con personal trainer') {
                profileScore += 5;
            }

            if (responses.activity_level === 'Molto attivo (5+ allenamenti intensi)') {
                profileScore += 10;
            }

            // Determina il profilo finale
            if (profileScore >= 80) return 'Atleta';
            else if (profileScore >= 40) return 'Guerriero';
            else return 'Nuovo Esploratore';
        }

        const questions = [
            {
                q: "Qual √® il tuo nome?",
                type: "text",
                field: "name"
            },
            {
                q: "Qual √® la tua email?",
                type: "email",
                field: "email"
            },
            {
                q: "Quali sono i tuoi 3 obiettivi principali? (Max 3)",
                type: "checkbox",
                field: "goals",
                maxSelections: 3,
                a: [
                    "Perdere peso e dimagrire",
                    "Aumentare massa muscolare",
                    "Migliorare la forza",
                    "Migliorare la resistenza",
                    "Migliorare la postura",
                    "Avere pi√π energia e benessere",
                    "Definire il corpo",
                    "Preparazione atletica specifica",
                    "Gestire lo stress",
                    "Migliorare la flessibilit√†"
                ]
            },
            {
                q: "Quanto sei attivo fisicamente ogni settimana?",
                a: ["Sedentario (quasi nessuno esercizio)", "Leggermente attivo (1-2 allenamenti leggeri)", "Moderatamente attivo (3-4 allenamenti)", "Molto attivo (5+ allenamenti intensi)"],
                s: [0, 5, 10, 15],
                field: "activity_level"
            },
            {
                q: "Come descriveresti la tua alimentazione tipica?",
                a: ["Scarsa (molti cibi processati, poca frutta/verdura)", "Discreta (cerco di mangiare sano, ma con sgarri)", "Buona (generalmente equilibrata e consapevole)", "Eccellente (molto attento, pianifico i pasti, pochi sgarri)"],
                s: [0, 3, 7, 10],
                field: "diet"
            },
            {
                q: "Quante ore dormi in media a notte?",
                a: ["Meno di 5 ore", "5-6 ore", "7-8 ore", "Pi√π di 8 ore"],
                s: [0, 3, 5, 3],
                field: "sleep"
            },
            {
                q: "Quali sono i tuoi maggiori ostacoli? (Seleziona tutto ci√≤ che si applica)",
                type: "checkbox",
                field: "obstacles",
                a: [
                    "Mancanza di tempo",
                    "Mancanza di motivazione",
                    "Non so da dove iniziare",
                    "Costi elevati (palestra, personal trainer)",
                    "Difficolt√† a mantenere la costanza",
                    "Mancanza di supporto/guida",
                    "Problemi di salute/infortuni",
                    "Poca conoscenza di allenamento/nutrizione",
                    "Stress o ansia",
                    "Non ho ostacoli particolari"
                ]
            },
            {
                q: "Quanti anni hai?",
                type: "number",
                field: "age"
            },
            {
                q: "Qual √® il tuo genere?",
                a: ["Uomo", "Donna", "Preferisco non dirlo"],
                s: [0, 0, 0],
                field: "gender"
            },
            {
                q: "Hai qualche nota o commento aggiuntivo?",
                type: "textarea",
                field: "notes",
                optional: true
            },
            {
                q: "Quali attivit√† preferisci? (Seleziona tutto ci√≤ che ti piace)",
                type: "checkbox",
                field: "preferred_activities",
                a: ["Palestra", "Corsa", "Yoga/Pilates", "Sport di squadra", "Camminate", "Altro"]
            },
            {
                q: "Usi un personal trainer o ti alleni da solo?",
                a: ["Con personal trainer", "Mi alleno da solo", "Entrambi"],
                s: [8, 5, 12],
                field: "training_style"
            },
            {
                q: "Quanto tempo dura in media il tuo allenamento?",
                a: ["Meno di 30 minuti", "30-45 minuti", "45-60 minuti", "Pi√π di un'ora"],
                s: [2, 5, 8, 10],
                field: "workout_duration"
            },
            {
                q: "Fai colazione regolarmente?",
                a: ["S√¨, ogni giorno", "Qualche volta", "Mai"],
                s: [5, 2, 0],
                field: "breakfast_habit"
            },
            {
                q: "Consumi integratori o vitamine?",
                a: ["S√¨, regolarmente", "A volte", "No"],
                s: [5, 2, 0],
                field: "supplements"
            },
            {
                q: "Quante volte mangi fuori casa ogni settimana?",
                a: ["Mai", "1-2 volte", "3-4 volte", "5+ volte"],
                s: [5, 5, 2, 0],
                field: "eating_out"
            },
            {
                q: "Pratichi tecniche di gestione dello stress?",
                a: ["S√¨, ogni giorno", "S√¨, qualche volta", "No"],
                s: [8, 4, 0],
                field: "stress_management"
            },
            {
                q: "Ti senti soddisfatto del tuo equilibrio vita-lavoro?",
                a: ["S√¨, molto soddisfatto", "Abbastanza", "Poco", "Per niente"],
                s: [5, 3, 1, 0],
                field: "work_life_balance"
            },
            {
                q: "Quanto spesso prendi pause attive durante il lavoro?",
                a: ["Mai", "Una volta al giorno", "Pi√π volte al giorno", "Ogni ora"],
                s: [0, 2, 5, 5],
                field: "active_breaks"
            },
            {
                q: "Ti svegli durante la notte?",
                a: ["Mai", "Raramente", "Spesso", "Sempre"],
                s: [5, 5, 2, 0],
                field: "sleep_interruptions"
            },
            {
                q: "Qual √® la tua principale fonte di motivazione?",
                a: ["Obiettivi personali", "Salute e benessere", "Estetica", "Altro"],
                s: [5, 5, 3, 2],
                field: "motivation_source"
            },
            {
                q: "Ti capita di saltare allenamenti per mancanza di voglia?",
                a: ["Mai", "Raramente", "A volte", "Spesso"],
                s: [8, 5, 2, 0],
                field: "skip_workouts"
            },
            {
                q: "Ti confronti con altre persone per migliorarti?",
                a: ["S√¨, spesso", "A volte", "Raramente", "Mai"],
                s: [3, 3, 2, 1],
                field: "comparison"
            },
            {
                q: "Usi dispositivi elettronici prima di dormire?",
                a: ["Sempre", "Qualche volta", "Raramente", "Mai"],
                s: [0, 2, 4, 5],
                field: "devices_before_sleep"
            },
            {
                q: "Ti senti riposato al mattino?",
                a: ["Sempre", "Spesso", "Raramente", "Mai"],
                s: [5, 5, 2, 0],
                field: "morning_energy"
            }
        ];

        let currentQ = 0;
        let score = 0;
        let responses = {};
        let selectedCheckboxes = [];

        const quizContainer = document.getElementById('quizContainer');
        const progressBar = document.getElementById('progress-bar');

        function updateProgress() {
            const progress = ((currentQ + 1) / questions.length) * 100;
            progressBar.style.width = `${progress}%`;
        }

        function showQuestion() {
            if (currentQ >= questions.length) {
                showResult();
                return;
            }

            updateProgress();
            const q = questions[currentQ];

            let html = `<div class='question-box'><h2>${currentQ + 1}. ${q.q}</h2>`;

            if (q.type === 'text' || q.type === 'email') {
                html += `<input type='${q.type}' class='text-input' id='textInput' placeholder='Inserisci ${q.type === 'email' ? 'la tua email' : 'il tuo nome'}' ${q.type === 'email' ? 'required' : ''}>`;
                html += `<button class='continue-btn' onclick='handleTextInput()' disabled id='continueBtn'>Continua</button>`;
            } else if (q.type === 'number') {
                html += `<input type='number' class='text-input' id='textInput' placeholder='Inserisci la tua et√†' min='12' max='99'>`;
                html += `<button class='continue-btn' onclick='handleTextInput()' disabled id='continueBtn'>Continua</button>`;
            } else if (q.type === 'textarea') {
                html += `<textarea class='text-input' id='textInput' placeholder='Scrivi qui i tuoi commenti...' rows='4'></textarea>`;
                html += `<button class='continue-btn' onclick='handleTextInput()' id='continueBtn'>Continua${q.optional ? ' (Opzionale)' : ''}</button>`;
            } else if (q.type === 'checkbox') {
                html += `<div class='checkbox-container'>`;
                q.a.forEach((ans, i) => {
                    html += `<div class='checkbox-option' onclick='toggleCheckbox(${i}, "${ans}")'>
                        <input type='checkbox' id='check${i}'>
                        ${ans}
                    </div>`;
                });
                html += `</div>`;
                html += `<button class='continue-btn' onclick='handleCheckboxes()' disabled id='continueBtn'>Continua</button>`;
                selectedCheckboxes = [];
            } else {
                html += `<div class='answer-grid'>`;
                q.a.forEach((ans, i) => {
                    const points = q.s ? q.s[i] : 0;
                    html += `<button class='answer-btn' onclick='answer(${points}, "${ans.replace(/'/g, "\\\'")}")'>${ans}</button>`;
                });
                html += `</div>`;
            }

            html += `</div>`;
            quizContainer.innerHTML = html;

            // Aggiungi event listener per input di testo
            if (q.type === 'text' || q.type === 'email' || q.type === 'number' || q.type === 'textarea') {
                const input = document.getElementById('textInput');
                const btn = document.getElementById('continueBtn');

                input.addEventListener('input', function() {
                    if (q.type === 'email') {
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        btn.disabled = !emailRegex.test(this.value);
                    } else if (q.type === 'number') {
                        const age = parseInt(this.value);
                        btn.disabled = !age || age < 12 || age > 99;
                    } else if (q.type === 'textarea' && q.optional) {
                        btn.disabled = false;
                    } else {
                        btn.disabled = this.value.trim().length < 2;
                    }
                });
            }
        }

        function toggleCheckbox(index, answer) {
            const checkbox = document.getElementById(`check${index}`);
            const option = checkbox.parentElement;
            const q = questions[currentQ];

            if (checkbox.checked) {
                checkbox.checked = false;
                option.classList.remove('selected');
                selectedCheckboxes = selectedCheckboxes.filter(item => item !== answer);
            } else {
                if (q.maxSelections && selectedCheckboxes.length >= q.maxSelections) {
                    alert(`Puoi selezionare massimo ${q.maxSelections} opzioni!`);
                    return;
                }
                checkbox.checked = true;
                option.classList.add('selected');
                selectedCheckboxes.push(answer);
            }

            const btn = document.getElementById('continueBtn');
            btn.disabled = selectedCheckboxes.length === 0;
        }

        function handleTextInput() {
            const input = document.getElementById('textInput');
            const value = input.value.trim();
            const q = questions[currentQ];

            responses[q.field] = value;

            // Aggiungi punti per alcune risposte specifiche
            if (q.field === 'age') {
                const age = parseInt(value);
                if (age >= 18 && age <= 35) score += 5;
            }

            currentQ++;
            showQuestion();
        }

        function handleCheckboxes() {
            const q = questions[currentQ];
            responses[q.field] = [...selectedCheckboxes];

            // Aggiungi punti per checkboxes specifiche
            if (q.field === 'goals') {
                if (selectedCheckboxes.includes('Aumentare massa muscolare')) score += 10;
                if (selectedCheckboxes.includes('Migliorare la forza')) score += 10;
                if (selectedCheckboxes.includes('Preparazione atletica specifica')) score += 15;
                if (selectedCheckboxes.includes('Perdere peso e dimagrire')) score += 5;
                if (selectedCheckboxes.includes('Definire il corpo')) score += 7;
            }

            if (q.field === 'obstacles' && selectedCheckboxes.includes('Non ho ostacoli particolari')) {
                score += 10;
            }

            if (q.field === 'preferred_activities') {
                if (selectedCheckboxes.length >= 3) score += 5;
                if (selectedCheckboxes.includes('Palestra')) score += 3;
                if (selectedCheckboxes.includes('Sport di squadra')) score += 3;
            }

            currentQ++;
            showQuestion();
        }

        function answer(points, answerText) {
            score += points;
            const q = questions[currentQ];
            responses[q.field] = answerText;
            currentQ++;
            showQuestion();
        }

        async function showResult() { // Reso asincrono per l'attesa di saveQuizResult
            // Usa la nuova funzione che considera sia score che risposte
            const profile = determineProfile(responses, score);
            const icon = getProfileIcon(profile); // Usa la funzione importata

            const profiles = {
                'Nuovo Esploratore': {
                    description: 'Sei all\'inizio del tuo viaggio nel mondo del fitness e questo √® il momento pi√π emozionante! Hai l\'energia e la motivazione per iniziare, ma potresti sentirti sopraffatto dalla quantit√† di informazioni disponibili. √à normale sentirsi confusi su dove iniziare e quali strategie adottare. Il tuo profilo indica che hai un grande potenziale non ancora espresso e una mente aperta pronta ad assorbire nuove conoscenze. Questo √® il momento perfetto per costruire solide fondamenta che ti accompagneranno per tutta la vita. La chiave del successo sar√† la costanza piuttosto che l\'intensit√†: piccoli passi quotidiani ti porteranno molto pi√π lontano di sforzi sporadici ed eccessivi. Non sottovalutare la tua posizione - molti esperti rimpiangono di non aver avuto la guida giusta fin dall\'inizio come puoi averla tu ora.',
                    recommendations: [
                        'FITNESS: Inizia con 3 allenamenti settimanali di 30-45 minuti, alternando cardio leggero a esercizi di forza base con peso corporeo.',
                        'ALIMENTAZIONE: Stabilisci orari fissi per i pasti e introduci almeno 3 porzioni di verdura al giorno. Elimina gradualmente le bevande zuccherate.',
                        'MOTIVAZIONE: Tieni un diario dei progressi e celebra ogni piccolo traguardo. La costanza batte sempre l\'intensit√† sporadica.',
                        'ABITUDINI: Crea una routine mattutina con 10 minuti di stretching. Vai a letto sempre alla stessa ora.',
                        'PROSSIMI PASSI: Trova un compagno di allenamento o unisciti a una community per mantenere alta la motivazione.',
                        'SOLUZIONI: Investi in un programma di coaching personalizzato per i primi 3-6 mesi. Utilizza app fitness per principianti.'
                    ]
                },
                'Guerriero': {
                    description: 'Sei un vero combattente del fitness! Hai gi√† costruito una base solida di conoscenze ed esperienze, ma senti che c\'√® ancora tanto da esplorare e migliorare. Il tuo profilo rivela una persona determinata che ha superato la fase iniziale e ora si trova ad affrontare nuove sfide. Hai sviluppato una buona disciplina e comprendi l\'importanza dell\'allenamento regolare, ma ora √® il momento di affinare la tua strategia per raggiungere obiettivi pi√π ambiziosi. Potresti aver raggiunto un plateau o semplicemente sentire il bisogno di evoluzione nel tuo approccio. La tua esperienza ti permette di riconoscere cosa funziona e cosa no, ma ora hai bisogno di strategie pi√π sofisticate per ottimizzare ogni aspetto del tuo stile di vita. Sei pronto per il livello successivo che richiede maggiore precisione nella programmazione e attenzione ai dettagli.',
                    recommendations: [
                        'FITNESS: Introduci la periodizzazione negli allenamenti alternando fasi di forza, ipertrofia e resistenza ogni 4-6 settimane.',
                        'ALIMENTAZIONE: Calcola i tuoi macronutrienti specifici e adatta l\'intake calorico ai tuoi obiettivi. Considera il meal prep settimanale.',
                        'MOTIVAZIONE: Stabilisci obiettivi SMART a breve, medio e lungo termine. Trova nuove sfide come gare o competizioni.',
                        'ABITUDINI: Ottimizza il recupero con 7-9 ore di sonno qualitativo e introduci pratiche di mindfulness per gestire stress.',
                        'PROSSIMI PASSI: Considera l\'analisi della composizione corporea per monitoraggi precisi. Sperimenta nuove discipline sportive.',
                        'SOLUZIONI: Collabora con un trainer specializzato per programmi avanzati. Partecipa a workshop per approfondire le conoscenze.'
                    ]
                },
                'Atleta': {
                    description: 'Complimenti, sei arrivato al livello elite! Il tuo profilo rappresenta l\'eccellenza nel mondo del fitness e del benessere. Hai costruito un approccio sistematico e scientifico al tuo stile di vita, dove ogni dettaglio conta e ogni decisione √® orientata all\'ottimizzazione delle performance. Il fitness non √® pi√π un hobby per te, ma una filosofia di vita che permea ogni aspetto della tua quotidianit√†. Hai sviluppato una disciplina ferrea, una conoscenza approfondita dei principi di allenamento e nutrizione, e una capacit√† di autoregolazione impressionante. La tua sfida ora non √® pi√π imparare le basi, ma perfezionare ogni singolo elemento per raggiungere il massimo potenziale umano. Cerchi costantemente quel famoso 1% di miglioramento in ogni area, dalla precisione nutrizionale all\'ottimizzazione del recupero. Il tuo corpo e la tua mente sono strumenti affinati che richiedono strategie di livello professionale e sei probabilmente un esempio e fonte di ispirazione per molti altri.',
                    recommendations: [
                        'FITNESS AVANZATO: Implementa periodizzazione complessa con microcicli specializzati. Utilizza tecnologie avanzate per il monitoraggio.',
                        'NUTRIZIONE PRECISION: Adotta strategie nutrizionali periodizzate coordinate con i cicli di allenamento. Monitora biomarkers regolarmente.',
                        'RECUPERO ELITE: Implementa protocolli avanzati: crioterapia, saune, massaggi sportivi, tecniche di rilascio miofasciale.',
                        'PERFORMANCE MENTALE: Sviluppa strategie di mental training: visualizzazione, goal setting avanzato, gestione della pressione.',
                        'MONITORAGGIO: Utilizza wearable devices avanzati per tracciare HRV, VO2 max, potenza. Effettua test di performance regolari.',
                        'STRATEGIE ELITE: Lavora con team multidisciplinare. Partecipa a competizioni di alto livello. Investi in tecnologie cutting-edge.'
                    ]
                }
            };

            // Calcola il lead_score usando la funzione importata
            const calculatedLeadScore = calculateLeadScoreFromFunctions(responses);

            // Prepara i dati finali per il salvataggio
            const finalData = {
                ...responses,
                score: score, // Il punteggio totale calcolato dal quiz
                profile: profile, // Profilo determinato
                lead_score: calculatedLeadScore, // Il lead score calcolato dalla funzione esterna
                // Il timestamp verr√† aggiunto automaticamente dalla funzione saveQuizResult
                source: 'advanced_quiz_v2' // Puoi mantenere la sorgente o modificarla
            };

            // Salva su Firebase usando la funzione importata (che include serverTimestamp)
            try {
                await saveQuizResult(finalData); // Ora √® una Promise, quindi await
                console.log('‚úÖ Dati salvati con successo su Firebase!');
            } catch (error) {
                console.error('‚ùå Errore nel salvataggio:', error);
            }


            let resultHTML = `
                <div class='result-container'>
                    <h2>üéâ Complimenti! Quiz Completato!</h2>
                    <p>Abbiamo analizzato le tue risposte e preparato il tuo profilo personalizzato.</p>

                    <div class='profile-card'>
                        <h3>${icon} Il tuo Profilo: ${profile}</h3>
                        <p>${profiles[profile].description}</p>
                    </div>

                    <div class='recommendations'>
                        <h3 style='color: #ff6600; text-align: center; margin-bottom: 20px;'>Consigli per te:</h3>
                        <ul>
            `;

            profiles[profile].recommendations.forEach(rec => {
                resultHTML += `<li>${rec}</li>`;
            });

            resultHTML += `
                        </ul>
                    </div>

                    <div class='cta-buttons'>
                        <a href='https://www.chatbase.co/chatbot-iframe/EjoHCEogMfkkrVzIK6V07' target='_blank' class='cta-btn cta-primary'>Chatta con il tuo Assistant TribuCoach</a>
                        <a href='https://wa.me/3478881515?text=${encodeURIComponent(`Ciao! Ho completato il Quiz TribuCoach. Il mio profilo √® "${profile}" e vorrei richiedere una consulenza gratuita.`)}' target='_blank' class='cta-btn cta-secondary'>Richiedi Consulenza Gratuita</a>
                    </div>
                </div>
            `;

            quizContainer.innerHTML = resultHTML;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Inizializza il quiz
        showQuestion();
    </script>
</body>
</html>